const mySQLDate = ""
const defaultLocationDisplayFormat = "medium" //long medium short
const populateDefaultValues = false
const defaultDateFormat = "YYYY-MM-DD"
const sideNavOptions = {
    edge: "left", // Choose the horizontal origin
    closeOnClick: false, // Closes side-nav on &lt;a&gt; clicks, useful for Angular/Meteor
    breakpoint: 1199, // Breakpoint for button collapse
    menuWidth: 240, // Width for sidenav
    timeDurationOpen: 500, // Time duration open menu
    timeDurationClose: 500, // Time duration open menu
    timeDurationOverlayOpen: 200, // Time duration open overlay
    timeDurationOverlayClose: 200, // Time duration close overlay
    easingOpen: "easeInOutQuad", // Open animation
    easingClose: "easeInOutQuad", // Close animation
    showOverlay: true, // Display overflay
    showCloseButton: false, // Append close button into siednav
    slim: false, // turn on slime mode
    onOpen: null, // callback function
    onClose: null, // callback function
    mode: "over", // change sidenav mode
}
const toastrOptions = {
    "closeButton": true,
    "debug": false,
    "newestOnTop": true,
    "progressBar": true,
    "positionClass": "md-toast-bottom-right",
    "preventDuplicates": true,
    "onclick": null,
    "showDuration": 300000000, //300,
    "hideDuration": 1000000000, //1000
    "timeOut": 5000000, //5000
    "extendedTimeOut": 1000000, //1000
    "showEasing": "swing",
    "hideEasing": "linear",
    "showMethod": "fadeIn",
    "hideMethod": "fadeOut",
}
const dow_short = [
    "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
]
const days = [
    {
        name: "Sunday",
        short: "Sun",
    }, {
        name: "Monday",
        short: "Mon",
    }, {
        name: "Tuesday",
        short: "Tue",
    },
    {
        name: "Wednesday",
        short: "Wed",
    },
    {
        name: "Thursday",
        short: "Thu",
    },
    {
        name: "Friday",
        short: "Fri",
    },
    {
        name: "Saturday",
        short: "Sat",
    },
]
const dowStart = 1
const short_dexcription_max = 250
const colorScheme = new Map()
const toggleAJAXResponse = false
const debugMode = true

colorScheme.set(1, {
    name: "Color - 1",
    backGround: "#bdbdbd",
    borderColor: "#686868",
    textColor: "#000",
})
colorScheme.set(2, {
    name: "Color - 2",
    backGround: "#54cbe3",
    borderColor: "#357f8e",
    textColor: "#000",
})
colorScheme.set(3, {
    name: "Color - 3",
    backGround: "#49de94",
    borderColor: "#2d895b",
    textColor: "#000",
})
colorScheme.set(4, {
    name: "Color - 4",
    backGround: "#ab8c82",
    borderColor: "#564641",
    textColor: "#000",
})
colorScheme.set(5, {
    name: "Color - 5",
    backGround: "#ffcd17",
    borderColor: "#aa890f",
    textColor: "#000",
})
colorScheme.set(6, {
    name: "Color - 6",
    backGround: "#96a3fa",
    borderColor: "#636ca5",
    textColor: "#000",
})
colorScheme.set(7, {
    name: "Color - 7",
    backGround: "#fa983c",
    borderColor: "#a56428",
    textColor: "#000",
})
colorScheme.set(8, {
    name: "Color - 8",
    backGround: "#17b3a3",
    borderColor: "#0c5e56",
    textColor: "#000",
})
colorScheme.set(9, {
    name: "Color - 9",
    backGround: "#76838f",
    borderColor: "#30353a",
    textColor: "#fff",
})
colorScheme.set(10, {
    name: "Color - 10",
    backGround: "#910112",
    borderColor: "#3c0007",
    textColor: "#fff",
})
colorScheme.set(11, {
    name: "Color - 11",
    backGround: "#ff666b",
    borderColor: "#aa4447",
    textColor: "#000",
})
colorScheme.set(12, {
    name: "Color - 12",
    backGround: "#3e8ef7",
    borderColor: "#295da2",
    textColor: "#000",
})
colorScheme.set(13, {
    name: "Color - 13",
    backGround: "#f74584",
    borderColor: "#a22d57",
    textColor: "#000",
})
colorScheme.set(14, {
    name: "Color - 14",
    backGround: "#5a9101",
    borderColor: "#253c00",
    textColor: "#fff",
})
colorScheme.set(15, {
    name: "Color - 15",
    backGround: "#9463f7",
    borderColor: "#6141a2",
    textColor: "#fff",
})
const tableCellMaxChars = 10
const defaultAddressView = "medium"//short, medium, long
const DEBUGMODE = true
const inactivityTimeout = 60000 * 60
const initialCalenderViewCount = 12
const FILE_TYPES = {
    "aac": "audio/aac",
    "abw": "application/x-abiword",
    "arc": "application/x-freearc",
    "avi": "video/x-msvideo",
    "azw": "application/vnd.amazon.ebook",
    "bin": "application/octet-stream",
    "bmp": "image/bmp",
    "bz": "application/x-bzip",
    "bz2": "application/x-bzip2",
    "csh": "application/x-csh",
    "css": "text/css",
    "csv": "text/csv",
    "doc": "application/msword",
    "docx": "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    "eot": "application/vnd.ms-fontobject",
    "epub": "application/epub+zip",
    "gz": "application/gzip",
    "gif": "image/gif",
    "htm": "text/html",
    "html": "text/html",
    "ico": "image/vnd.microsoft.icon",
    "ics": "text/calendar",
    "jar": "application/java-archive",
    "jpeg": "image/jpeg",
    "jpg": "image/jpeg",
    "js": "text/javascript",
    "json": "application/json",
    "jsonld": "application/ld+json",
    "mid": "audio/midi audio/x-midi",
    "midi": "audio/midi audio/x-midi",
    "mjs": "text/javascript",
    "mp3": "audio/mpeg",
    "mpeg": "video/mpeg",
    "mpkg": "application/vnd.apple.installer+xml",
    "odp": "application/vnd.oasis.opendocument.presentation",
    "ods": "application/vnd.oasis.opendocument.spreadsheet",
    "odt": "application/vnd.oasis.opendocument.text",
    "oga": "audio/ogg",
    "ogv": "video/ogg",
    "ogx": "application/ogg",
    "opus": "audio/opus",
    "otf": "font/otf",
    "png": "image/png",
    "pdf": "application/pdf",
    "php": "application/x-httpd-php",
    "ppt": "application/vnd.ms-powerpoint",
    "pptx": "application/vnd.openxmlformats-officedocument.presentationml.presentation",
    "rar": "application/vnd.rar",
    "rtf": "application/rtf",
    "sh": "application/x-sh",
    "svg": "image/svg+xml",
    "swf": "application/x-shockwave-flash",
    "tar": "application/x-tar",
    "tif": "image/tiff",
    "tiff": "image/tiff",
    "ts": "video/mp2t",
    "ttf": "font/ttf",
    "txt": "text/plain",
    "vsd": "application/vnd.visio",
    "wav": "audio/wav",
    "weba": "audio/webm",
    "webm": "video/webm",
    "webp": "image/webp",
    "woff": "font/woff",
    "woff2": "font/woff2",
    "xhtml": "application/xhtml+xml",
    "xls": "application/vnd.ms-excel",
    "xlsx": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    "xml": "text/xml",
    "xul": "application/vnd.mozilla.xul+xml",
    "zip": "application/zip",
    "7z": "application/x-7z-compressed",
}
const STANDARD_ASPECT_RATIOS = [
    [1, "1:1"],
    [4 / 3, "4:3"],
    [5 / 4, "5:4"],
    [3 / 2, "3:2"],
    [16 / 10, "16:10"],
    [16 / 9, "16:9"],
    [21 / 9, "21:9"],
    [32 / 9, "32:9"],
]
let ERROR_ALLOWED = 0.05
let RATIOS = STANDARD_ASPECT_RATIOS.map(function (tpl) {return tpl[0]}).sort()
let LOOKUP = Object()
for (let i = 0; i < STANDARD_ASPECT_RATIOS.length; i++) {
    LOOKUP[STANDARD_ASPECT_RATIOS[i][0]] = STANDARD_ASPECT_RATIOS[i][1]
}

let mdbPreloader = document.getElementById("mdb-preloader")
/*
let showElements
let isShiftTime
let separator = "-"
let separatorTime = ":"

const IsNumericTime = function (input, keyCode) {
    if (!isNaN(parseInt(keyCode))) {
        keyCode = parseInt(keyCode)
    }
    
    if (keyCode === 16) {
        isShiftTime = true
    }
    
    if ((keyCode >= 48 && keyCode <= 57) || (keyCode >= 96 && keyCode <= 105) || (keyCode === 8) || (keyCode === 46)) {
        if (keyCode !== 16) {
            if ((input.value.length === 2) && keyCode !== 8) {
                input.value += separatorTime
            }
            
            return true
        }
    }
    
    return false
}

const validateTimeFormat = function (input, keyCode) {
    let timeString = input.value
    let regex = /^\d{2,}:(?:[0-5]\d):(?:[0-5]\d)$/i
    
    if (keyCode === 16) {
        isShift = false
    }
    
    if (regex.test(timeString) || timeString.length === 0) {
        $(input).unSetError()
    } else {
        $(input).setError("Invalid Time. Only HH-MM format allowed.")
    }
}

$.fn.unSetError = function () {
    let errorElm = this.parents("div.form-element").find("div.error")
    
    if (this.hasClass("time-format")) {
    
    }
    
    if (this.hasClass("date-format")) {
    
    }
    
    errorElm.html("&nbsp;").hide()
    return this
}

$.fn.setError = function (msg) {
    let errorElm = this.parents("div.form-element").find("div.error")
    
    if (this.hasClass("time-format")) {
        errorElm = this.parent("div.input-group").parent().find("div.error")
    }
    
    if (this.hasClass("date-format")) {
        errorElm = this.parents("div.form-element").find("div.error")
    }
    
    errorElm.html(msg).show()
    return this
}
//*/
$.fn.BuildDropDown = function (settings) {
    if (!settings || !settings.text_field || !settings.id_field) {
        return
    }
    let _this = document.getElementById($(this).attr("id"))
    let data = (settings.data) ? settings.data : []
    let class_list = (settings.class_list) ? settings.class_list : ["form-control"]
    let id_field = (settings.id_field) ? settings.id_field : ""
    let text_field = (settings.text_field) ? settings.text_field : ""
    let title = (settings.title) ? settings.title : "Select Option"
    let first_selectable = (settings.first_selectable) ? settings.firstSelectable : false
    let select2 = (settings.select2) ? settings.select2 : false
    let multiple = (settings.type) ? settings.type : ""
    let val = ""
    //
    $(_this).empty()
    //
    if (multiple === "multiple") {
        _this.setAttribute("multiple", "multiple")
    }
    
    if (first_selectable === false) {
        let option = $(document.createElement("option")).prop({
            value: "",
            text: "-- " + title.charAt(0).toUpperCase() + title.slice(1) + " --",
            //readonly: true,
            disabled: true,
        }).attr("readonly", "readonly")
        
        $(_this).append(option)
    }
    
    $.each(data, function (i, v) {
        let id = v[id_field]
        let text = v[text_field]
        
        $(_this).append($(document.createElement("option")).prop({
            value: id,
            text: text.charAt(0).toUpperCase() + text.slice(1),
        }))
        
    })
    
    $(_this).val(val)
    
    if (select2) {
        $(_this).select2()
    }
    
    //if ($(_this).hasClass("select2-hidden-accessible")) {
    //    $(_this).select2("destroy");
    //}
    
}

const fetchFormErrors = (form, rules) => {
    console.log("fetchFormErrors()")
    // ----
    
    let _modal_product_category_id = document.getElementById("modal_product_category_id")
    let errors = []
    
    if (!form || !rules || !_modal_product_category_id) {
        errors.push({
            form: (form) ? form : null,
            rules: (rules) ? rules : null,
            message: "Missing Data",
        })
        
        return {
            valid: false,
            errors: errors,
        }
    }
    
    let validator = jQuery(form).validate(rules)
    
    console.log("|__ validator", validator)
    
    return {
        valid: true,
        errors: errors,
    }
}

const calculateWidth = (ratioWidth, ratioHeight, height) => {
    let aspectRatio = ratioWidth.value / ratioHeight.value
    return parseFloat((height * aspectRatio).toFixed(2))
}

const calculateHeight = (ratioWidth, ratioHeight, width) => {
    let aspectRatio = ratioWidth / ratioHeight
    return parseFloat((width / aspectRatio).toFixed(2))
}

const gcd = function (a, b) {
    return (b === 0) ? a : gcd(b, a % b)
}

const shadeColor = function (color, percent) {
    
    var R = parseInt(color.substring(1, 3), 16)
    var G = parseInt(color.substring(3, 5), 16)
    var B = parseInt(color.substring(5, 7), 16)
    
    R = parseInt(R * (100 + percent) / 100)
    G = parseInt(G * (100 + percent) / 100)
    B = parseInt(B * (100 + percent) / 100)
    
    R = (R < 255) ? R : 255
    G = (G < 255) ? G : 255
    B = (B < 255) ? B : 255
    
    var RR = ((R.toString(16).length === 1) ? "0" + R.toString(16) : R.toString(16))
    var GG = ((G.toString(16).length === 1) ? "0" + G.toString(16) : G.toString(16))
    var BB = ((B.toString(16).length === 1) ? "0" + B.toString(16) : B.toString(16))
    
    return "#" + RR + GG + BB
}

const clearAllValidation = function () {
    //console.log("clearAllValidation")
    $("div.error").html(`&nbsp;`).hide()
    $(".is-invalid").removeClass("is-invalid")
}

$.fn.showError = function (msg) {
    let $element = this
    let $errorElement = $element.parents("div.form-element").find("div.error")
    
    $element.addClass("is-invalid")
    $errorElement.html(msg).show()
    return this
}

$.fn.hideError = function () {
    let $element = this
    let $errorElement = $element.parents("div.form-element").find("div.error")
    
    $element.removeClass("is-invalid")
    $errorElement.html(`&nbsp;`).hide()
    return this
}

const hexToRgb = hex =>
    hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i
            , (m, r, g, b) => "#" + r + r + g + g + b + b)
        .substring(1).match(/.{2}/g)
        .map(x => parseInt(x, 16))

jQuery.fn.dataTable.Api.register("page.jumpToData()", function (data, column) {
    var pos = this.column(column, {
        order: "current",
    }).data().indexOf(data)
    
    if (pos >= 0) {
        var page = Math.floor(pos / this.page.info().length)
        this.page(page).draw(false)
    }
    
    return this
})

const isOdd = function (num) {
    return num % 2
}

const clearValidation = function (formElement) {
    //console.log("clearValidation(formElement)", formElement)
    $(".autocomplete-suggestions").hide()
    let validator = $(formElement).validate()
    
    $("[name]", formElement).each(function () {
        if (validator) {
            if (validator.successList) {
                validator.successList.push(this)
            }
            validator.showErrors()
        }
    })
    
    $(".is-invalid").each(function () {
        if (validator) {
            if (validator.successList) {
                validator.successList.push(this)
            }
            validator.showErrors()
        }
    })
    
    if (validator) {
        validator.resetForm()
        validator.reset()
    }
}

const get_errors = function (validator) {
    //console.log("get_errors(validator)", validator)
    var submitErrorsList = {}
    //console.dir(validator)
    //for (var i = 0; i < validator.errorList.length; i++) {
    //    submitErrorsList[validator.errorList[i].element.name] = validator.errorList[i].message
    //}
    //console.log("Submit Errors", submitErrorsList)
}

const validator_init = function (settings) {
    //console.log("validator_init(settings)", settings)
    let rules = {}
    let messages = {}
    let groups = {}
    if (settings) {
        
        if (settings.rules) {
            rules = settings.rules
        }
        
        if (settings.messages) {
            messages = settings.messages
        }
        
        if (settings.groups) {
            groups = settings.groups
        }
    }
    
    jQuery.validator.setDefaults({
        rules: rules,
        messages: messages,
        groups: groups,
        ignore: "",
        success: "valid",
        invalidHandler: function (event, validator) {
            var errors = validator.numberOfInvalids()
            let errorEl = validator.findLastActive() || validator.errorList.length && validator.errorList[0].element
            if (errorEl) {
                $(errorEl).closest(".accordion-body").collapse("show")
            }
        },
        errorElement: "span",
        highlight: function (element) {
            let id = $(element).attr("id")
            let el = $("#" + id + "")
            let error_el = $("#" + id + "-error")
            
            if (error_el.attr("data-ref")) {
                $("#" + error_el.attr("data-ref")).addClass("is-invalid")
            } else {
                el.parent().find("span.select2").addClass("is-invalid")
                el.addClass("is-invalid")
            }
            
            if (error_el) {
                error_el.css({ "display": "block" })
            }
        },
        unhighlight: function (element) {
            let id = $(element).attr("id")
            let el = $("#" + id + "")
            let error_el = $("#" + id + "-error")
            el.parents("div.form-element").find("span.select2").removeClass("is-invalid")
            el.removeClass("is-invalid")
            if (error_el) {
                error_el.css({ "display": "none" })
            }
        },
        errorPlacement: function (error, element) {
            let id = element.attr("id")
            let el = $("#" + id + "-error")
            el.html(error)
        },
        submitHandler: function (form) {
            return true
        },
        
    })
    
    jQuery.validator.addMethod("postalCode", function (value) {
        return /^((\d{5}-\d{4})|(\d{5})|([A-Z]\d[A-Z]\s\d[A-Z]\d))$/.test(value)
    }, "Please enter a valid postal code.")
    
    jQuery.validator.addMethod("phoneUS", function (phone_number, element) {
        phone_number = phone_number.replace(/\s+/g, "")
        return this.optional(element) || phone_number.length > 9 &&
            phone_number.match(/^(\+?1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)
    }, "Please specify a valid phone number")
    
    jQuery.validator.addMethod("phoneIT", function (phone_number, element) {
        phone_number = phone_number.replace(/\s+/g, "")
        return this.optional(element) || phone_number.length > 9 &&
            phone_number.match(/^(\+?1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)
    }, "Please specify a valid phone number")
    
    return jQuery.validator
}

const initializeValidator = function (settings) {
    console.log("initializeValidator(settings)", settings)
    // ----
    
    let rules = {}
    let messages = {}
    let groups = {}
    
    if (settings) {
        
        if (settings.rules) {
            rules = settings.rules
        }
        
        if (settings.messages) {
            messages = settings.messages
        }
        
        if (settings.groups) {
            groups = settings.groups
        }
    }
    
    jQuery.validator.setDefaults({
        rules: rules,
        messages: messages,
        groups: groups,
        ignore: "",
        success: "valid",
        invalidHandler: function (event, validator) {
            var errors = validator.numberOfInvalids()
            let errorEl = validator.findLastActive() || validator.errorList.length && validator.errorList[0].element
            if (errorEl) {
                $(errorEl).closest(".accordion-body").collapse("show")
            }
        },
        errorElement: "span",
        highlight: function (element) {
            let id = $(element).attr("id")
            let el = $("#" + id + "")
            let error_el = $("#" + id + "-error")
            
            if (error_el.attr("data-ref")) {
                $("#" + error_el.attr("data-ref")).addClass("is-invalid")
            } else {
                el.parent().find("span.select2").addClass("is-invalid")
                el.addClass("is-invalid")
            }
            
            if (error_el) {
                error_el.css({ "display": "block" })
            }
        },
        unhighlight: function (element) {
            let id = $(element).attr("id")
            let el = $("#" + id + "")
            let error_el = $("#" + id + "-error")
            el.parents("div.form-element").find("span.select2").removeClass("is-invalid")
            el.removeClass("is-invalid")
            if (error_el) {
                error_el.css({ "display": "none" })
            }
        },
        errorPlacement: function (error, element) {
            let id = element.attr("id")
            let el = $("#" + id + "-error")
            el.html(error)
        },
        submitHandler: function (form) {
            return true
        },
    })
    
    jQuery.validator.addMethod("postalCode", function (value) {
        return /^((\d{5}-\d{4})|(\d{5})|([A-Z]\d[A-Z]\s\d[A-Z]\d))$/.test(value)
    }, "Please enter a valid postal code.")
    
    jQuery.validator.addMethod("phoneUS", function (phone_number, element) {
        phone_number = phone_number.replace(/\s+/g, "")
        return this.optional(element) || phone_number.length > 9 &&
            phone_number.match(/^(\+?1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)
    }, "Please specify a valid phone number")
    
    jQuery.validator.addMethod("phoneIT", function (phone_number, element) {
        phone_number = phone_number.replace(/\s+/g, "")
        return this.optional(element) || phone_number.length > 9 &&
            phone_number.match(/^(\+?1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/)
    }, "Please specify a valid phone number")
    
    return jQuery.validator
}

const jsonPrettify = (json) => {
    if (typeof json === "object" && json !== null) {
        return JSON.stringify(json, undefined, '\t')
    }
    
    try {
        const obj = JSON.parse(json)
        return jsonPrettify(obj)
    } catch (e) {
        return json
    }
}

const setError = function (element, msg) {
    //console.log("setError")
    let id = $(element).attr("id")
    let el = $("#" + id + "")
    let error_el = $("#" + id + "-error")
    
    if (error_el.attr("data-ref")) {
        $("#" + error_el.attr("data-ref")).addClass("is-invalid")
    } else {
        el.parent().find("span.select2").addClass("is-invalid")
        el.addClass("is-invalid")
    }
    
    if (error_el) {
        error_el.css({ "display": "block" })
    }
    
    $(error_el).append(`<span id="#${id}-error" class="invalid">${msg}</span>`)
}

const clearError = function (element) {
    //console.log("clearError(element)", element)
    let id = $(element).attr("id")
    let el = $("#" + id + "")
    let error_el = $("#" + id + "-error")
    
    if (error_el.attr("data-ref")) {
        $("#" + error_el.attr("data-ref")).removeClass("is-invalid")
    } else {
        el.parent().find("span.select2").removeClass("is-invalid")
        el.removeClass("is-invalid")
    }
    
    if (error_el) {
        $(error_el).empty()
        error_el.css({ "display": "none" })
        
    }
    
}

const toNumbers = arr => arr.map(Number)

const remove_nulls = function (obj) {
    let cleanedObject = {}
    $.each(obj, function (i, v) {
        if (v === null) {
        
        } else {
            cleanedObject[i] = v
        }
    })
    
    return cleanedObject
}

const removeNulls = function (obj) {
    //console.log("removeNulls()")
    let cleanedObject = {}
    $.each(obj, function (i, v) {
        if (v === null) {
        
        } else {
            cleanedObject[i] = v
        }
    })
    
    return cleanedObject
}

const buildMap = function (arr, key) {
    let temp = new Map()
    $.each(arr, function (index, value) {
        temp.set(value[key], value)
    })
    return temp
}

const getListOfIds = function (list) {
    if (list) {
        
        if (typeof list === "string") {
            let str = list.replace(/\s/g, "")
            return Array.from(str.split(","), Number)
        } else if (typeof list === "object") {
            return list
        }
        
    }
    
    return []
}

const formatListOfIds = function (list) {
    let vals = ""
    if (list && typeof list === "object") {
        vals = list.join(',')
    }
    return vals
}

const sendGetRequest = function (url, data_to_send, callback) {
    let result = []
    
    if (url && data_to_send) {
        $.getJSONRequest(url, data_to_send, function (data, status, xhr) {
            if (status === "success" && typeof data.result !== "undefined") {
                result = data.result
                return callback(result)
            } else if (status === "failed" && typeof data.error === "undefined") {
                return handleError(data)
            } else if (status === "success" && typeof data.error !== "undefined") {
                return handleError(data.error)
            } else {
                //console.log("getError:4")
            }
        })
    } else {
        let msg = []
        if (!url) {
            msg.push("url")
        }
        if (!data_to_send) {
            msg.push("data_to_send")
        }
        
        return handleError("Missing Data: " + msg.join(", "))
    }
}

const sendPostRequest = function (url, data_to_send, callback) {
    let msg, result = []
    if (url && data_to_send) {
        $.postJSON(url, data_to_send, function (data, status, xhr) {
            /*
            //console.log("data", data)
            //console.log("status", status)
            //console.log("xhr", xhr)
            //console.log("typeof data.result", typeof data.result)
            //*/
            if (status === "success" && typeof data.result !== "undefined") {
                
                if (data.result) {
                    result = data.result
                    return callback(result)
                } else {
                    return handleError("Error Posting Data 1")
                }
            } else if (status === "failed" && typeof data.result === "undefined") {
                if (data.error) {
                    return handleError(data.error)
                }
                
                return handleError("Error Posting Data")
            } else {
                
                return handleError("Error Posting Data 2")
            }
        })
    } else {
        if (!url) {
            msg.push("url")
        }
        if (!data_to_send) {
            msg.push("data_to_send")
        }
        
        return handleError("Missing Data: " + msg.join(", "))
    }
}

const getAjaxError = function (jqXHR, exception, uri) {
    let msg = ""
    let error = {
        message: "",
        status: "",
        uri: uri,
    }
    
    if (jqXHR.status === 404) {
        msg = "Requested page( " + uri + " ) not found. [404]"
    }
    
    error.message = msg
    error.status = jqXHR.status
    error.uri = uri
    error.jqXHR = jqXHR
    return error
}

const _display_ajax_error = function (jqXHR, exception, uri) {
    let msg = ""
    let error = {
        message: "",
        status: "",
        uri: uri,
    }
    
    if (jqXHR.status === 0) {
        msg = "Not connected, verify Network."
    } else if (jqXHR.status === 404) {
        msg = "Requested page( " + uri + " ) not found. [404]"
    } else if (jqXHR.status === 500) {
        if (jqXHR.responseJSON) {
            msg = jqXHR.responseJSON
        } else {
            msg = "Internal Server Error [500]."
        }
        
    } else if (exception === "parsererror") {
        msg = "Requested JSON parse failed."
    } else if (exception === "timeout") {
        msg = "Time out error."
    } else if (exception === "abort") {
        msg = "Ajax request aborted."
    } else {
        msg = "Uncaught Error." + jqXHR.responseText
    }
    
    error.message = msg
    error.status = jqXHR.status
    error.uri = uri
    error.jqXHR = jqXHR
    return error
}

const handleError = function (msg) {
    if (!msg) {
        msg = "3Error processing request"
    }
    
    toastr.error(" -- " + msg)
}

const validInt = function (val) {
    if (val) {
        if (!isNaN(parseInt(val))) {
            return parseInt(val)
        }
    }
    
    return null
}

const formatDateMySQL = function (date) {
    if (!date) {
        let date = new Date()
    }
    
    return moment(date).format("YYYY-MM-DD HH:mm:ss")
}

const resize_elements = function () {
    const _page = document.getElementById("page")
    const _main = document.getElementById("main")
    const _nav = document.getElementsByClassName("double-nav")
    const _screen_width = document.getElementById("screen_width")
    const _screen_height = document.getElementById("screen_height")
    const _footer = document.getElementsByClassName("page-footer")
    const _slide_out = document.getElementById("slide-out")
    const _page_header = document.getElementById("page_header")
    ////
    let window_height = 0
    let window_width = 0
    let page_height = 0
    let page_width = 0
    let nav_height = 0
    let side_nav_width = 0
    let side_nav_height = 0
    let footer_height = 0
    ///////////////////////////////////////////////
    window_height = window.innerHeight
    window_width = window.innerWidth
    ///////////////////////////////////////////////
    $.each(_nav, function (i, elem) {
        let temp_height = (!isNaN(parseInt($(elem).outerHeight()))) ? parseInt($(elem).outerHeight()) : 0
        nav_height = nav_height + temp_height
    })
    
    $.each(_footer, function (i, elem) {
        let temp_height = (!isNaN(parseInt($(elem).outerHeight()))) ? parseInt($(elem).outerHeight()) : 0
        footer_height = footer_height + temp_height
    })
    ///////////////////////////////////////////////
    let page_ht = (window_height - footer_height - nav_height - 1) + "px"
    ///////////////////////////////////////////////
    if (_slide_out) {
        side_nav_height = (!isNaN(parseInt($(_slide_out).outerHeight()))) ? parseInt($(_slide_out).outerHeight()) : 0
        side_nav_width = (!isNaN(parseInt($(_slide_out).width()))) ? parseInt($(_slide_out).width()) : 0
    }
    
    if (_page && _screen_height && _screen_width) {
        if (_main) {
            $(_main).css({
                "padding-left": side_nav_width + "px",
                "min-height": window_height - footer_height - nav_height + "px!important",
            })
        }
        
        if (_page) {
            _page.setAttribute("style", "min-height:" + page_ht + "!important")
            //_page.setAttribute("style", "min-height:" + page_ht + "!important")
        }
        
        if (_page_header) {
            _page_header.setAttribute("style", "margin-top:" + nav_height + "px;")
        }
        
        //For debugging
        _screen_height.innerText = window_height + ""
        _screen_width.innerText = window_width + ""
    }
    
}

const debounce = function (func) {
    var timer
    return function (event) {
        if (timer) {
            clearTimeout(timer)
        }
        timer = setTimeout(func, 100, event)
    }
}

const populateMultiSelect = function (arr, elem) {
    for (var i = 0, l = elem.options.length, o; i < l; i++) {
        o = elem.options[i]
        
        if (arr.indexOf(o.value) !== -1) {
            //console.log("ggg")
            o.selected = true
        }
        
    }
}

const findObjectByKey = function (array, key, value) {
    let results = []
    for (var i = 0; i < array.length; i++) {
        if (array[i][key] === value) {
            results.push(array[i])
        }
    }
    
    return results
}

const addTinyMCE = function (el) {
    tinymce.init({
        selector: "#" + el,
        menubar: false,
        height: "400",
        plugins: "print visualblocks visualchars charmap hr pagebreak advlist lists",
        content_css: [
            "https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap",
            "/assets/css/bootstrap.min.css",
            "/assets/css/style.css",
        ],
        body_class: "p-2",
        font_formats: "Andale Mono=andale mono,times; Arial=arial,helvetica,sans-serif; Arial Black=arial black,avant garde; Book Antiqua=book antiqua,palatino; Comic Sans MS=comic sans ms,sans-serif; Courier New=courier new,courier; Georgia=georgia,palatino; Helvetica=helvetica; Impact=impact,chicago; Open Sans=Open Sans; Roboto=Roboto;Symbol=symbol; Tahoma=tahoma,arial,helvetica,sans-serif; Terminal=terminal,monaco; Times New Roman=times new roman,times; Trebuchet MS=trebuchet ms,geneva; Verdana=verdana,geneva; Webdings=webdings; Wingdings=wingdings,zapf dingbats",
        toolbar1: "undo redo | styleselect | fontselect fontsizeselect | removeformat | numlist bullist checklist | outdent indent ",
        toolbar2: "cut copy | bold italic underline strikethrough | forecolor | alignleft aligncenter alignright alignjustify | backcolor",
        content_style: "body { font-family:\"Roboto\",sans-serif\", sans-serif; font-size:14px; font-weight: 400 }",
        style_formats: [
            {
                title: "Headers",
                items: [
                    {
                        title: "h1",
                        block: "h1",
                    },
                    {
                        title: "h2",
                        block: "h2",
                    },
                    {
                        title: "h3",
                        block: "h3",
                    },
                    {
                        title: "h4",
                        block: "h4",
                    },
                    {
                        title: "h5",
                        block: "h5",
                    },
                    {
                        title: "h6",
                        block: "h6",
                    },
                ],
            }, {
                title: "Blocks",
                items: [
                    {
                        title: "p",
                        block: "p",
                    },
                    {
                        title: "div",
                        block: "div",
                    },
                    {
                        title: "pre",
                        block: "pre",
                    },
                ],
            }, {
                title: "Containers",
                items: [
                    {
                        title: "section",
                        block: "section",
                        wrapper: true,
                        merge_siblings: false,
                    },
                    {
                        title: "article",
                        block: "article",
                        wrapper: true,
                        merge_siblings: false,
                    },
                    {
                        title: "blockquote",
                        block: "blockquote",
                        wrapper: true,
                    },
                    {
                        title: "hgroup",
                        block: "hgroup",
                        wrapper: true,
                    },
                    {
                        title: "aside",
                        block: "aside",
                        wrapper: true,
                    },
                    {
                        title: "figure",
                        block: "figure",
                        wrapper: true,
                    },
                ],
            },
        ],
        branding: false,
        resize: false,
        setup: function (editor) {
            editor.on("change", function () {
                editor.save()
            })
        },
    })
}

/**
 * converts HTML entities in the string to their corresponding characters.
 *
 * @param value
 * @returns {*|jQuery}
 */
const htmlDecode = function (value) {
    return $("<textarea/>").html(value).text()
}

const is_null = function (val) {
    return val === null || val === undefined
}

/**
 * converts HTML entities in the string to their corresponding characters.
 *
 * @param str
 * @returns {*}
 */
function decodeHtml (str) {
    if (!str) {
        str = ""
    }
    var map =
        {
            "&amp;": "&",
            "&lt;": "<",
            "&gt;": ">",
            "&quot;": "\"",
            "&#039;": "'",
        }
    return str.replace(/&amp;|&lt;|&gt;|&quot;|&#039;/g, function (m) {return map[m]})
}

/**
 * escape html chars
 *
 * @param text
 * @returns {string}
 */
function escapeHtml (text) {
    if (!text) {
        text = ""
    }
    var map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        "\"": "&quot;",
        "'": "&#039;",
    }
    
    return text.replace(/[&<>"']/g, function (m) { return map[m] })
}

const setInt = function (val) {
    let returnVal = null
    if (val) {
        if (!isNaN(parseInt(val))) {
            returnVal = val
        }
    }
    return returnVal
}

const inactivityTime = function () {
    let time
    window.onload = resetTimer
    
    // DOM Events
    document.onmousemove = resetTimer
    document.onkeydown = resetTimer
    
    function logout () {
        location.href = "/logout"
    }
    
    function resetTimer () {
        clearTimeout(time)
        time = setTimeout(logout, inactivityTimeout)
    }
}

const htmlEncode = function (value) {
    return $("<textarea/>").text(value).html()
}

const paddy = function (num, padlen, padchar) {
    var pad_char = typeof padchar !== "undefined" ? padchar : "0"
    var pad = new Array(1 + padlen).join(pad_char)
    return (pad + num).slice(-pad.length)
}

const generateCodeDirectId = function (provider) {
    if (!provider) {
        return ""
    }
    
    return "D" + paddy(14, 11)
}

const getDate = function (element) {
    if (element.pickadate("picker")) {
        return element.pickadate("picker").get()
    }
}

jQuery.extend({
    postJSON: function (url, data, callback) {
        let request = $.ajax({
            url: url,
            type: "POST",
            data: data,
            dataType: "json",
        })
        request.done(function (msg) {
            if ($.isFunction(callback)) {
                callback(msg, "success")
                return true
            }
        })
        request.fail(function (jqXHR, textStatus, msg) {
            /*
            if (toggleAJAXResponse) {
                const link = document.createElement("a")
                link.id = 'someLink' //give it an ID!
                link.href = "javascript:void(0);"
                link.addEventListener("click", function () {
                    var file = new Blob([jqXHR.responseText], { type: "text/html" })
                    var fileURL = URL.createObjectURL(file)
                    var win = window.open()
                    win.document.write('<iframe src="' + fileURL + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>')
                })
                let pageFrame = document.getElementById("page")
                pageFrame.appendChild(link)
                document.getElementById("someLink").click()
                link.removeEventListener("click")
                pageFrame.parentNode.removeChild(link)
            }
            //*/
            /*
            //console.log("jqXHR", jqXHR)
            //console.log("jqXHR", jqXHR.responseText)
            //console.log("_display_ajax_error", _display_ajax_error(jqXHR, textStatus, url))
            //console.log("textStatus", textStatus)
            //console.log("msg", msg)
            //console.log('http://dev.travelsoft.com/error')
            //*/
            if (typeof textStatus !== "undefined") {
                //console.error("Request failed", _display_ajax_error(jqXHR, textStatus, url))
            } else {
                //console.error("Request failed", _display_ajax_error(jqXHR, textStatus, url))
            }
            
            if ($.isFunction(callback)) {
                if (jqXHR.responseJSON) {
                    callback(jqXHR, "failed")
                } else {
                    callback(jqXHR, "failed")
                }
            }
            return false
        })
        return request
    },
    getJSONRequest: function (url, data, callback) {
        let getRequest = $.ajax({
            url: url,
            type: "GET",
            data: data,
            dataType: "json",
            async: true,
        })
        getRequest.done(function (msg) {
            if ($.isFunction(callback)) {
                callback(msg, "success")
            }
        })
        
        getRequest.fail(function (jqXHR, textStatus, msg) {
            let errors = getAjaxError(jqXHR, textStatus, url)
            
            if (typeof textStatus !== "undefined") {
                let err = _display_ajax_error(jqXHR, textStatus, url)
                //console.log("err", getAjaxError(jqXHR, textStatus, url))
                //handleError(err.message)
            } else {
                let err = _display_ajax_error(jqXHR, textStatus, url)
                //handleError(err.message)
            }
            
            if ($.isFunction(callback)) {
                msg = errors.message
                //console.log("msg -- ", msg)
                //console.log("msg -- ", errors.message)
                
                callback(msg, "failed")
            }
        })
        
    },
    getJSON: function (url, data, callback) {
        let getRequest = $.ajax({
            url: url,
            type: "GET",
            data: data,
            dataType: "json",
            async: false,
        })
        getRequest.done(function (msg) {
            if ($.isFunction(callback)) {
                callback(msg, "success")
            }
        })
        getRequest.fail(function (jqXHR, textStatus, msg) {
            if (typeof textStatus !== "undefined") {
                //console.log("Request failed")
                //console.log(_display_ajax_error(jqXHR, textStatus, url))
            } else {
                //console.log("Request failed")
                //console.log(_display_ajax_error(jqXHR, textStatus, url))
            }
            if ($.isFunction(callback)) {
                callback(msg, "failed")
            }
        })
    },
})

const infoDialog = function (message, handler) {
    $(`
        <!--Modal: modalConfirm-->
        <div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog" aria-labelledby="modalConfirmationLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm modal-notify modal-info" role="document">
		<!--Content-->
		<div class="modal-content text-center">
			<!--Header-->
			<div class="modal-header d-flex justify-content-center">
				<p class="heading">${message}</p>
			</div>

			<!--Body-->
			<div class="modal-body">
				<i class="fas fa-info fa-4x animated rotateIn"></i>
			</div>

			<!--Footer-->
			<div class="modal-footer flex-center">
				<a class="btn btn-outline-info btn-yes">yes</a>
				<a type="button" class="btn btn-info waves-effect btn-no">no</a>
			</div>
		</div>
		<!--/.Content-->
	</div>
</div>
        <!--Modal: modalConfirm-->
    `).appendTo("body")
    
    const modal = document.getElementById("modalConfirm")
    
    if (modal) {
        const $modal = $(modal)
        //Trigger the modal
        $modal
            .modal({
                backdrop: "static",
                keyboard: false,
            })
        
        //Pass true to a callback function
        $(".btn-yes")
            .click(function () {
                handler(true)
                $modal
                    .modal("hide")
            })
        
        //Pass false to callback function
        $(".btn-no")
            .click(function () {
                handler(false)
                $modal
                    .modal("hide")
            })
        
        //Remove the modal once it is closed.
        $modal
            .on("hidden.bs.modal", function () {
                $modal
                    .remove()
            })
    }
    
}

const confirmDialog = function (message, handler) {
    $(`
        <!--Modal: modalConfirm-->
        <div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog" aria-labelledby="modalConfirmationLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm modal-notify modal-info" role="document">
                <!--Content-->
                <div class="modal-content text-center">
                    <!--Header-->
                    <div class="modal-header d-flex justify-content-center">
                        <p class="heading">${message}</p>
                    </div>
                    <!--/.Header-->
                    
                    <!--Body-->
                    <div class="modal-body">
                        <i class="fas fa-check fa-4x mb-3 animated rotateIn"></i>
                    </div>
                    <!--/.Body-->
                   
        
                    <!--Footer-->
                    <div class="modal-footer flex-center">
                        <a type="button" class="btn btn-outline-info btn-sm waves-effect btn-no">no</a>
                        <a class="btn btn-info btn-sm btn-yes">yes</a>
                    </div>
                    <!--/.Footer-->
                    
                </div>
                
                <!--/.Content-->
	        </div>
        </div>
        <!--Modal: modalConfirm-->
    `)
        .appendTo("body")
    
    const modal = document.getElementById("modalConfirm")
    
    if (modal) {
        
        const $modal = $(modal)
        
        $modal
            .modal({
                backdrop: "static",
                keyboard: false,
            })
        
        //Pass true to a callback function
        $(".btn-yes")
            .on("click", function () {
                handler(true)
                $modal
                    .modal("hide")
            })
        
        //Pass false to callback function
        $(".btn-no")
            .click(function () {
                handler(false)
                $("#modalConfirm")
                    .modal("hide")
            })
            .on("click", function () {
                handler(false)
                $modal
                    .modal("hide")
            })
        
        //Remove the modal once it is closed.
        $modal
            .on("hidden.bs.modal", function () {
                $("#modalConfirm")
                    .remove()
            })
    }
    
}

const deleteDialog = function (message, handler) {
    
    $(`
        <!--Modal: modalConfirm-->
        <div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog" aria-labelledby="modalConfirmationLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm modal-notify modal-danger" role="document">
		<!--Content-->
		<div class="modal-content text-center">
			<!--Header-->
			<div class="modal-header d-flex justify-content-center">
				<p class="heading">${message}</p>
			</div>

			<!--Body-->
			<div class="modal-body">
				<i class="fas fa-times fa-4x animated rotateIn"></i>
			</div>

			<!--Footer-->
			<div class="modal-footer flex-center">
				<a class="btn btn-outline-danger btn-yes">yes</a>
				<a type="button" class="btn btn-danger waves-effect btn-no">no</a>
			</div>
		</div>
		<!--/.Content-->
	</div>
</div>
        <!--Modal: modalConfirm-->
    `)
        .appendTo("body")
    //Trigger the modal
    $("#modalConfirm")
        .modal({
            backdrop: "static",
            keyboard: false,
        })
    
    //Pass true to a callback function
    $(".btn-yes")
        .click(function () {
            handler(true)
            $("#modalConfirm")
                .modal("hide")
        })
    
    //Pass false to callback function
    $(".btn-no")
        .click(function () {
            handler(false)
            $("#modalConfirm")
                .modal("hide")
        })
    
    //Remove the modal once it is closed.
    $("#modalConfirm")
        .on("hidden.bs.modal", function () {
            $("#modalConfirm")
                .remove()
        })
    
}

const formatURL = function (param) {
    //console.log("formatURL()", param)
    return encodeURIComponent(param.trim())
}

const buildMapsURL = function (location) {
    //console.log("buildMapsURL(location)", location)
    let name, street_1, street_2, zipcode, city_name, province_name, country_name
    
    name = (location.name) ? location.name : null
    street_1 = (location.street_1) ? location.street_1 : null
    street_2 = (location.street_2) ? location.street_2 : null
    zipcode = (location.zipcode) ? location.zipcode : null
    city_name = (location.city.name) ? location.city.name : null
    province_name = (location.province.iso2) ? location.province.iso2 : (location.province.iso3) ? location.province.iso3 : (location.province.name) ? location.province.name : null
    country_name = (location.province.name) ? location.country.name : (location.country.iso2) ? location.country.iso2 : (location.country.iso3) ? location.country.iso3 : null
    name = (name !== null) ? name : null
    street_1 = (street_1 !== null) ? street_1 : null
    street_2 = (street_2 !== null) ? street_2 : null
    zipcode = (zipcode !== null) ? zipcode : null
    city_name = (city_name !== null) ? city_name : null
    province_name = (province_name !== null) ? province_name : null
    country_name = (country_name !== null) ? country_name : null
    
    let tempURL = []
    
    if (!is_null(name)) {
        tempURL.push(name)
    }
    
    if (!is_null(street_1)) {
        tempURL.push(street_1)
    }
    
    if (!is_null(street_2)) {
        tempURL.push(street_2)
    }
    
    if (!is_null(city_name)) {
        //tempURL.push(city_name)
    }
    
    let provinceLine = ""
    
    if (!is_null(city_name) && !is_null(province_name) && !is_null(zipcode)) {
        provinceLine = zipcode + " " + city_name + " " + province_name
    } else if (is_null(city_name) && !is_null(province_name) && !is_null(zipcode)) {
        provinceLine = zipcode + " " + province_name
    } else if (is_null(city_name) && is_null(province_name) && !is_null(zipcode)) {
        provinceLine = zipcode
    } else if (!is_null(city_name) && is_null(province_name) && !is_null(zipcode)) {
        provinceLine = zipcode + " " + city_name
    } else if (!is_null(city_name) && !is_null(province_name) && is_null(zipcode)) {
        provinceLine = city_name + " " + province_name
    } else {
    
    }
    if (provinceLine !== "") {
        tempURL.push(provinceLine)
    }
    
    if (!is_null(country_name)) {
        tempURL.push(country_name)
    }
    
    let location_formatted = tempURL.join(", ")
    location_formatted = formatURL(location_formatted)
    return `https://maps.google.com/maps?q=${location_formatted}&t=&z=7&ie=UTF8&iwloc=&output=embed`
}

const weatherUpdate = function (city) {
    const xhr = new XMLHttpRequest()
    const apiKey = "2ad550b2d7e352b38c3ca9da8396aade"
    let cityName = city
    xhr.open(
        "GET",
        `https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${apiKey}`)
    
    xhr.send()
    xhr.onload = () => {
        if (xhr.status === 404) {
            //console.log(`${cityName} not found`)
        } else {
            let data = JSON.parse(xhr.response)
            let mainWeatherCityName = data.name
            let mainWeatherTemperature = `${Math.round(data.main.temp - 273.15)}C`
            let mainWeather = data.weather[0].main
            let mainWeatherDescription = data.weather[0].description
            let mainWeatherImage = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`
            //console.log("mainWeatherCityName", mainWeatherCityName)
            //console.log("mainWeatherTemperature", mainWeatherTemperature)
            //console.log("mainWeather", mainWeather)
            //console.log("mainWeatherDescription", mainWeatherDescription)
            //console.log("mainWeatherImage", mainWeatherImage)//100x100
            //console.log("data", data)
        }
    }
}

const ucwords = function (str) {
    str = str.toLowerCase()
    return str.replace(/(^([a-zA-Z\p{M}]))|([ -][a-zA-Z\p{M}])/g,
        function (s) {
            return s.toUpperCase()
        })
}

String.prototype.ucwords = function () {
    str = this.toLowerCase()
    return str.replace(/(^([a-zA-Z\p{M}]))|([ -][a-zA-Z\p{M}])/g,
        function (s) {
            return s.toUpperCase()
        })
}

const trimTrailingChars = function (s, charToTrim) {
    return s.replace(new RegExp(charToTrim + "+$"), "")
}

const formatSize = function (bytes, decimals = 2) {
    const k = 1024
    const dm = decimals < 0 ? 0 : decimals
    const units = ["BYTES", "KB", "MB"]
    let size, unit
    
    unit = bytes.toUpperCase()
    unit = trimTrailingChars(unit, "S")
    unit = unit.replace(/BYTE/g, "BYTES")
    unit = unit.replace(/MEGABYTE/g, "MB")
    unit = unit.replace(/KILOBYTE/g, "KB")
    
    if (unit.includes("BYTES")) {
        let unitType = "BYTES"
        
        return (!isNaN(parseInt(unit.replace(`/${unitType}/g`, "")))) ? parseInt(unit.replace(`/${unitType}/g`, "")) : null
    } else if (unit.includes("KB")) {
        let unitType = "KB"
        
        size = (!isNaN(parseInt((parseFloat(unit.replace(`/${unitType}/g`, "")).toFixed(dm)) * 1024))) ? parseInt((parseFloat(unit.replace(`/${unitType}/g`, "")).toFixed(dm)) * 1024) : null
        
        if (size !== null) {
            return size
        }
    } else if (unit.includes("MB")) {
        let unitType = "MB"
        
        size = (!isNaN(parseInt((parseFloat(unit.replace(`/${unitType}/g`, "")).toFixed(dm)) * 2097152))) ? parseInt((parseFloat(unit.replace(`/${unitType}/g`, "")).toFixed(dm)) * 2097152) : null
        
        if (size !== null) {
            return size
        }
    }
}

//

/**
 * DEBUG
 */
$(function () {
    $(".debug")
        .on("click", function () {
            showElements = true
            if (!$(this).attr("data-shown")) {
                $(this).attr("data-shown", "true")
                showElements = true
            }
            
            if ($(this).attr("data-shown") === "false") {
                $(this).attr("data-shown", "true")
                showElements = true
            } else {
                showElements = false
                $(this).attr("data-shown", "false")
            }
            
            let els = document.getElementsByClassName("dev-element")
            
            for (let i = 0; i < els.length; i++) {
                
                let element = els[i]
                let tagName = element.tagName
                
                if (tagName.toLowerCase() === "input") {
                    
                    if (showElements === false) {
                        element.hidden = false
                        element.type = "text"
                    } else {
                        element.hidden = true
                        element.type = "hidden"
                    }
                } else if (tagName.toLowerCase() === "label") {
                    if (showElements === false) {
                        $(element).removeClass("d-none")
                    } else {
                        $(element).addClass("d-none")
                    }
                }
            }
        })
    
    $(".debug_demo")
        .on("click", function () {
            showElements = true
            if (!$(this).attr("data-shown")) {
                $(this).attr("data-shown", "true")
                showElements = true
            }
            
            if ($(this).attr("data-shown") === "false") {
                $(this).attr("data-shown", "true")
                showElements = true
            } else {
                showElements = false
                $(this).attr("data-shown", "false")
            }
            
            let els = document.getElementsByClassName("dev-element")
            
            for (let i = 0; i < els.length; i++) {
                
                let element = els[i]
                let tagName = element.tagName
                
                if (tagName.toLowerCase() === "input") {
                    
                    if (showElements === false) {
                        element.hidden = false
                        element.type = "text"
                    } else {
                        element.hidden = true
                        element.type = "hidden"
                    }
                } else if (tagName.toLowerCase() === "label") {
                    if (showElements === false) {
                        $(element).removeClass("d-none")
                    } else {
                        $(element).addClass("d-none")
                    }
                }
            }
        })
})

const Console = (function () {
    
    return {
        error: function () {
        
        },
        log: function () {
            let title, type, vals
            
            if (DEBUGMODE) {
                if (arguments.length > 0) {
                    if (arguments.length === 1) {
                        title = "Log Object"
                        vals = arguments[0]
                    }
                    
                    if (arguments.length === 2) {
                        
                        if (typeof arguments[0] === "string") {
                            title = arguments[0]
                        } else {
                            title = "Log Object"
                            vals = arguments[0]
                        }
                        
                        if (typeof arguments[1] === "object") {
                            type = " [object] "
                            vals = arguments[1]
                        } else if (typeof arguments[1] === "boolean") {
                            type = " [boolean] "
                            vals = arguments[1]
                        } else if (typeof arguments[1] === "number") {
                            type = " [number] "
                            vals = arguments[1]
                        } else if (typeof arguments[1] === "bigint") {
                            type = " [bigint] "
                            vals = arguments[1]
                        } else if (typeof arguments[1] === "string") {
                            type = " [string] "
                            vals = arguments[1]
                        } else if (typeof arguments[1] === "symbol") {
                            type = " [symbol] "
                            vals = arguments[1]
                        } else if (typeof arguments[1] === "function") {
                            type = " [function] "
                            vals = arguments[1]
                        } else {
                            type = " [other] "
                            vals = arguments[1]
                        }
                        
                        //console.log(title + type, vals)
                    }
                }
            }
        },
    }
})()

const Icon = (function () {
    
    const loadAll = function (icons) {
        Icon.all = new Map()
        
    }
    
    const init = function (settings) {
        if (settings) {
            if (settings.icons) {
                loadAll(settings.icons)
            }
        }
    }
    
    return {
        all: new Map(),
        init: function (settings) {
            return init(settings)
        },
    }
})()

const ProductLocation = (function () {
    "use strict"
    
    const _product_location_transport_city_search = document.getElementById("product_location_transport_city_search")
    const _product_edit_location_id = document.getElementById("product_edit_location_id")
    const _product_location_search = document.getElementById("product_location_search")
    const _product_edit_location_city_id = document.getElementById("product_edit_location_city_id")
    const _product_edit_location_city = document.getElementById("product_edit_location_city")
    const _product_edit_location_street_1 = document.getElementById("product_edit_location_street_1")
    const _product_edit_location_street_2 = document.getElementById("product_edit_location_street_2")
    const _product_edit_location_zipcode = document.getElementById("product_edit_location_zipcode")
    const _product_edit_location_location_types_id = document.getElementById("product_edit_location_location_types_id")
    const _product_edit_location_name = document.getElementById("product_edit_location_name")
    const _button_submit_form_product_edit_location = document.getElementById("button_submit_form_product_edit_location")
    const _button_clear_form_product_edit_location = document.getElementById("button_clear_form_product_edit_location")
    const _product_edit_location_city_edit = document.getElementById("product_edit_location_city_edit")
    const _location_country_id = document.getElementById("location_country_id")
    const _location_province_id = document.getElementById("location_province_id")
    const _location_city_id = document.getElementById("location_city_id")
    const _product_edit_location_form = document.getElementById("product_edit_location_form")
    const _product_location = document.getElementById("product_location")
    
    const _product_id = document.getElementById("product_id")
    const _category_id = document.getElementById("category_id")
    
    let form_rules = {
        group: {
            product_edit_location_city: "edit_location_country_id location_province_id location_city_id",
        },
        rules: {
            product_edit_location_city: {
                required: true,
            },
            product_edit_location_name: {
                required: true,
            },
            product_edit_location_location_types_id: {
                required: true,
            },
        },
        messages: {
            product_edit_location_city: {
                required: "Field Required",
            },
            product_edit_location_name: {
                required: "Field Required",
            },
            product_edit_location_location_types_id: {
                required: "Field Required",
            },
        },
    }
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    $(_button_submit_form_product_edit_location)
        .on("click", function () {
            save()
        })
    
    $(_button_clear_form_product_edit_location)
        .on("click", function () {
            resetForm()
        })
    
    $(_product_edit_location_zipcode)
        .on("change", function () {
            ProductLocation.detail.zipcode = (_product_edit_location_zipcode.value !== "") ? _product_edit_location_zipcode.value : null
            renderMap()
        })
    
    $(_product_edit_location_name)
        .on("click", function () {
            ProductLocation.detail.name = (_product_edit_location_name.value !== "") ? _product_edit_location_name.value : null
            renderMap()
        })
    
    $(_location_country_id)
        .on("change", function () {
            let country_id = (!isNaN(parseInt(_location_country_id.value))) ? parseInt(_location_country_id.value) : null
            
            if (country_id !== null) {
                let country = Country.all.get(country_id)
                ProductLocation.detail.country_id = country_id
                ProductLocation.detail.country = country
            }
        })
    
    $(_location_province_id)
        .on("change", function () {
            let province_id = (!isNaN(parseInt(_location_province_id.value))) ? parseInt(_location_province_id.value) : null
            
            if (province_id !== null) {
                let province = Province.all.get(province_id)
                ProductLocation.detail.province_id = province_id
                ProductLocation.detail.province = province
            }
        })
    
    $(_location_city_id)
        .on("change", function () {
            let city_id = (!isNaN(parseInt(_location_city_id.value))) ? parseInt(_location_city_id.value) : null
            
            if (city_id !== null) {
                let city = City.all.get(city_id)
                ProductLocation.detail.city_id = city_id
                ProductLocation.detail.city = city
                renderMap()
            }
        })
    
    $(_product_edit_location_name)
        .on("change", function () {
            ProductLocation.detail.name = (_product_edit_location_name.value !== "") ? _product_edit_location_name.value : null
            renderMap()
        })
    
    $(_product_edit_location_street_1)
        .on("change", function () {
            ProductLocation.detail.street_1 = (_product_edit_location_street_1.value !== "") ? _product_edit_location_street_1.value : null
            renderMap()
        })
    
    $(_product_edit_location_street_2)
        .on("change", function () {
            ProductLocation.detail.street_2 = (_product_edit_location_street_2.value !== "") ? _product_edit_location_street_2.value : null
            renderMap()
        })
    
    $(_location_city_id)
        .on("change", function () {
            let cityLine = ""
            let country_id = (!isNaN(parseInt(_location_country_id.value))) ? parseInt(_location_country_id.value) : null
            let province_id = (!isNaN(parseInt(_location_province_id.value))) ? parseInt(_location_province_id.value) : null
            let city_id = (!isNaN(parseInt(_location_city_id.value))) ? parseInt(_location_city_id.value) : null
            let country = Country.all.get(country_id)
            let province = Province.all.get(province_id)
            let city = City.all.get(city_id)
            
            ProductLocation.detail.country = country
            ProductLocation.detail.country_id = country_id
            
            ProductLocation.detail.province = province
            ProductLocation.detail.province_id = province_id
            
            ProductLocation.detail.city = city
            ProductLocation.detail.city_id = city_id
            
            if (country && province && city) {
                let cityName = city.name
                let provinceName = province.name
                let countryName = country.name
                _product_edit_location_city_id.value = city.id
                cityLine = `${cityName} (${provinceName}, ${countryName})`
            } else {
                cityLine = ``
                _product_edit_location_city_id.value = ``
            }
            
            _product_edit_location_city.value = cityLine
        })
    
    const initAutoComplete = function () {
        
        $(_product_edit_location_city)
            .on("change", function () {
                setTimeout(function () {
                    let cityName = _product_edit_location_city.value
                    if (cityName === "") {
                        resetCityForm()
                    }
                }, 200)
            })
            .on("search", function () {
                resetCityForm()
            })
            .on("click", function (e) {
                if ($(this).attr("readonly") === "readonly") {
                    e.preventDefault()
                } else {
                    $(this).select()
                }
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/cities",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                onSelect: function (suggestion) {
                    if (!suggestion.data) {
                        return
                    }
                    let country, province, city, city_name, country_name, province_name = null
                    
                    let product_location = suggestion.data
                    
                    let detail = set(product_location)
                    
                    if (product_location.country) {
                        country = product_location.country
                        Country.set_detail(country)
                        Country.id = (country.id) ? country.id.toString() : null
                    }
                    
                    if (product_location.province) {
                        province = product_location.province
                        Province.set_detail(province)
                        province_name = province.name
                        Province.id = (province.id) ? province.id.toString() : null
                    }
                    
                    if (product_location.city) {
                        city = product_location.city
                        city_name = city.name
                        City.set_detail(city)
                        City.id = (city.id) ? city.id.toString() : null
                    }
                    
                    $(_location_country_id).val((product_location.city.country_id) ? product_location.city.country_id : "").trigger("change")
                    
                    _product_location_search.value = `City Center (${city_name}, ${province_name})`
                    
                    let name = (_product_edit_location_name && _product_edit_location_name.value !== "") ? _product_edit_location_name.value : null
                    let zipcode = (_product_edit_location_zipcode && _product_edit_location_zipcode.value !== "") ? _product_edit_location_zipcode.value : null
                    let street_1 = (_product_edit_location_street_1 && _product_edit_location_street_1.value !== "") ? _product_edit_location_street_1.value : null
                    let street_2 = (_product_edit_location_street_2 && _product_edit_location_street_2.value !== "") ? _product_edit_location_street_2.value : null
                    
                    product_location.name = name
                    product_location.street_1 = street_1
                    product_location.street_2 = street_2
                    product_location.zipcode = zipcode
                    
                    //renderMap()
                },
            })
    }
    
    const showCityForm = function () {
        if (_product_edit_location_city_edit) {
            $(_product_edit_location_city_edit).show()
        }
    }
    
    const hideCityForm = function () {
        if (_product_edit_location_city_edit) {
            //$(_product_edit_location_city_edit).hide()
        }
    }
    
    const resetCityForm = function () {
        _product_edit_location_zipcode.value = ""
        _product_edit_location_city_id.value = ""
        
        $(_location_country_id)
            .val("")
            .trigger("change")
        
        hideCityForm()
    }
    
    const resetForm = function () {
        _product_edit_location_street_1.value = ""
        _product_edit_location_street_2.value = ""
        _product_edit_location_zipcode.value = ""
        _product_edit_location_city.value = ""
        _product_edit_location_name.value = ""
        _product_edit_location_location_types_id.value = ""
        
        resetCityForm()
    }
    
    const renderMap = function () {
        //console.log("ProductLocation.detail", ProductLocation.detail)
        
        let url = buildMapsURL(ProductLocation.detail)
        let elementWidth, elementHeight = null
        let _locationMap = document.getElementById("locationMap")
        
        if (_locationMap) {
            $(_locationMap)
                .empty()
                .append(
                    $("<iframe/>", {
                        id: "locationMapContainer",
                        allowfullscreen: "allowfullscreen",
                        frameborder: "0",
                        src: url,
                    }),
                )
            
            elementWidth = (!isNaN(parseInt($(_locationMap).actual("width")))) ? parseInt($(_locationMap).actual("width")) : null
            
            if (elementWidth) {
                elementHeight = elementWidth / 2
                
                $("#locationMapContainer")
                    .css({
                        "height": elementHeight + "px",
                        "width": elementWidth + "px",
                    })
            }
        }
        
    }
    
    const defaultDetail = function () {
        return {
            id: null,
            city_id: null,
            location_types_id: null,
            name: null,
            street_1: null,
            street_2: null,
            zipcode: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            display_long: null,
            display_medium: null,
            display_short: null,
            country: {},
            province: {},
            city: {},
            type: [],
        }
    }
    
    const set = function (productLocation) {
        /*
        //console.log("ProductLocation.set(productLocation) - productLocation ", productLocation)
        let detail = defaultDetail()
        
        if (productLocation) {
            let locationTypesId = (!isNaN(parseInt(productLocation.location_types_id))) ? parseInt(productLocation.location_types_id) : null
            
            detail["zipcode"] = (productLocation.zipcode) ? productLocation.zipcode : null
            detail["street_1"] = (productLocation.street_1) ? productLocation.street_1 : null
            detail["street_2"] = (productLocation.street_2) ? productLocation.street_2 : null
            detail["country"] = (productLocation.country) ? productLocation.country : null
            detail["province"] = (productLocation.province) ? productLocation.province : null
            detail["city"] = (productLocation.city) ? productLocation.city : null
            detail["display_long"] = (productLocation.display_long) ? productLocation.display_long : null
            detail["display_medium"] = (productLocation.display_medium) ? productLocation.display_medium : null
            detail["display_short"] = (productLocation.display_short) ? productLocation.display_short : null
            detail["postal_code"] = (productLocation.postal_code) ? productLocation.postal_code : null
            
            detail["enabled"] = (productLocation.enabled) ? productLocation.enabled : 1
            detail["id"] = (productLocation.id) ? productLocation.id : null
            detail["name"] = (productLocation.name) ? productLocation.name : null
            
            detail["type"] = (productLocation.type) ? productLocation.type : []
            
            detail["location_types_id"] = locationTypesId
            detail["type"] = (productLocation.type) ? productLocation.type : {}
            detail["city_id"] = (productLocation.city.id) ? productLocation.city.id : null
            detail["province"].id = (productLocation.province.id) ? productLocation.province.id : null
            detail["country"].id = (productLocation.country.id) ? productLocation.country.id : null
        }
        
        ProductLocation.detail = detail
        
        return detail
        //*/
    }
    
    const populateForm = function (product_location) {
        if (!_product_edit_location_form) {
            return
        }
        
        resetForm()
        
        if (product_location) {
            let detail = product_location
            let country, province, city = {}
            
            ProductLocation.detail = product_location
            ProductLocation.display_long = product_location.display_long //"City Center (Houston TX - Texas, US - United States)"
            ProductLocation.display_medium = product_location.display_medium // "City Center (Houston, Texas)"
            ProductLocation.display_short = product_location.display_short //"City Center (Houston TX, US)"
            
            let citySearchDisplay = ""
            let location_name = (product_location.name) ? product_location.name : null
            let location_id = (!isNaN(parseInt(product_location.id))) ? parseInt(product_location.id) : null
            let postal_code = (product_location.postal_code) ? product_location.postal_code : ""
            let street_1 = (product_location.street_1) ? product_location.street_1 : ""
            let street_2 = (product_location.street_2) ? product_location.street_2 : ""
            
            _product_edit_location_id.value = location_id
            _product_edit_location_street_1.value = street_1
            _product_edit_location_street_2.value = street_2
            _product_edit_location_zipcode.value = postal_code
            _product_edit_location_city.value = ""
            _product_edit_location_name.value = location_name
            
            $(_product_edit_location_location_types_id).val(product_location.type.id.toString())
            
            if (product_location.country) {
                country = product_location.country
                Country.set_detail(country)
                Country.id = (country.id) ? country.id.toString() : null
            }
            
            if (product_location.province) {
                province = product_location.province
                Province.set_detail(province)
                Province.id = (province.id) ? province.id.toString() : null
            }
            
            if (product_location.city) {
                city = product_location.city
                City.set_detail(city)
                City.id = (city.id) ? city.id.toString() : null
            }
            
            ProductLocation.detail.name = (product_location.name) ? product_location.name : null
            
            citySearchDisplay = city.name + " (" + province.name + ", " + country.name + ")"
            _product_edit_location_city.value = citySearchDisplay
            
            $(_location_country_id)
                .val((country.id) ? country.id : "")
                .trigger("change")
            
            renderMap()
        }
        
    }
    
    const valid = function () {
        return $(_product_edit_location_form).valid()
    }
    
    const buildLocationObject = function () {
        //console.log("ProductLocation.buildLocationObject()")
        if (valid()) {
            let id, city_id, location_types_id, name, street_1, street_2,
                zipcode, enabled, note
            
            name = (_product_edit_location_name.value !== "") ? _product_edit_location_name.value : null
            street_1 = (_product_edit_location_street_1.value !== "") ? _product_edit_location_street_1.value : null
            street_2 = (_product_edit_location_street_2.value !== "") ? _product_edit_location_street_2.value : null
            city_id = (!isNaN(parseInt(_location_city_id.value))) ? parseInt(_location_city_id.value) : null
            zipcode = (_product_edit_location_zipcode.value !== "") ? _product_edit_location_zipcode.value : null
            id = (!isNaN(parseInt(_product_edit_location_id.value))) ? parseInt(_product_edit_location_id.value) : null
            location_types_id = (!isNaN(parseInt(_product_edit_location_location_types_id.value))) ? parseInt(_product_edit_location_location_types_id.value) : null
            
            let productLocation = {
                product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
                category_id: (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null,
                id: id,
                city_id: city_id,
                location_types_id: location_types_id,
                name: name,
                street_1: street_1,
                street_2: street_2,
                zipcode: zipcode,
                enabled: 1,
                note: null,
            }
            
            return removeNulls(productLocation)
        }
    }
    
    const sendUpdateRequest = function (dataToSend, callback) {
        let url = "/api/v1.0/locations/update"
        
        try {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                }
            })
        } catch (e) {
            //console.log("error", e)
            handleProductLocationError("Error Updating Location")
        }
    }
    
    const handleProductLocationError = function (msg) {
    
    }
    
    const save = function () {
        let productLocation = buildLocationObject()
        
        if (productLocation) {
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    sendUpdateRequest(productLocation, function (data) {
                        let location
                        if (data) {
                            location = data
                            if (data[0]) {
                                location = data[0]
                            }
                        }
                        
                        if (location) {
                            Product.detail.location = location
                            
                            //console.log("location", location)
                            //console.log("Product.detail.location", Product.detail.location)
                            Product.updateDisplay()
                            toastr["success"](`Location ${location.id} has been updated`, "Location Updated")
                        }
                    })
                }
            })
        }
    }
    
    const init = function (settings) {
        //console.log("init(settings)", settings)
        
        $(document).ready(function () {
            let categoryId = (_category_id && (!isNaN(parseInt(_category_id.value)))) ? parseInt(_category_id.value) : null
            let location
            
            if (settings) {
                
                _product_edit_location_city_id.value = (settings.product.city_id) ? settings.product.city_id : null
                
                if (categoryId === 1) {
                    if (_product_edit_location_form) {
                        _product_edit_location_city_id.value = (settings.product.city_id) ? settings.product.city_id : null
                        location = (settings.product_location) ? settings.product_location : null
                        if (location) {
                            validator_init(form_rules)
                            ProductLocation.validator = $(_product_edit_location_form).validate()
                            
                            $(_location_country_id).BuildDropDown({
                                data: Array.from(Country.all.values()),
                                title: "Country",
                                id_field: "id",
                                text_field: "name",
                                first_selectable: false,
                            })
                            
                            $(_location_province_id).BuildDropDown({
                                data: Array.from(Province.all.values()),
                                title: "Province",
                                id_field: "id",
                                text_field: "name",
                                first_selectable: false,
                            })
                            
                            $(_location_city_id).BuildDropDown({
                                data: Array.from(City.all.values()),
                                title: "City",
                                id_field: "id",
                                text_field: "name",
                                first_selectable: false,
                            })
                            
                            Country.init({
                                dropdowns: [
                                    "location_country_id",
                                ],
                            })
                            
                            Province.init({
                                dropdowns: [
                                    "location_province_id",
                                ],
                            })
                            
                            City.init({
                                dropdowns: [
                                    "location_city_id",
                                ],
                            })
                            
                            initAutoComplete()
                            
                            populateForm(location)
                        }
                    }
                }
                
                if (categoryId === 2) {
                    //console.log("settings - 2", settings)
                    let cityId = (settings.product.city_id) ? settings.product.city_id : null
                    //console.log("cityId - 3", cityId)
                    _product_edit_location_city_id.value = cityId
                    if (settings.arriving_location && settings.departing_location) {
                        Airport.init(settings)
                    }
                }
                
                if (categoryId === 3) {
                    //console.log("settings - 3", settings)
                    let cityId = (settings.product.city_id) ? settings.product.city_id : null
                    //console.log("cityId - 3", cityId)
                    _product_edit_location_city_id.value = (settings.product.city_id) ? settings.product.city_id : null
                    Car.init(settings)
                }
                
                if (categoryId === 4) {
                
                }
                
                if (categoryId === 5) {
                
                }
                
                if (categoryId === 6) {
                    if (_product_edit_location_form) {
                        _product_edit_location_city_id.value = (settings.product.city_id) ? settings.product.city_id : null
                        location = (settings.product_location) ? settings.product_location : null
                        if (location) {
                            validator_init(form_rules)
                            ProductLocation.validator = $(_product_edit_location_form).validate()
                            
                            $(_location_country_id).BuildDropDown({
                                data: Array.from(Country.all.values()),
                                title: "Country",
                                id_field: "id",
                                text_field: "name",
                                first_selectable: false,
                            })
                            
                            $(_location_province_id).BuildDropDown({
                                data: Array.from(Province.all.values()),
                                title: "Province",
                                id_field: "id",
                                text_field: "name",
                                first_selectable: false,
                            })
                            
                            $(_location_city_id).BuildDropDown({
                                data: Array.from(City.all.values()),
                                title: "City",
                                id_field: "id",
                                text_field: "name",
                                first_selectable: false,
                            })
                            
                            Country.init({
                                dropdowns: [
                                    "location_country_id",
                                ],
                            })
                            
                            Province.init({
                                dropdowns: [
                                    "location_province_id",
                                ],
                            })
                            
                            City.init({
                                dropdowns: [
                                    "location_city_id",
                                ],
                            })
                            
                            initAutoComplete()
                            
                            populateForm(location)
                        }
                    }
                }
                
                if (categoryId === 7) {
                
                }
                
                if (categoryId === 8) {
                
                }
                
                if (categoryId === 9) {
                
                }
                
            }
        })
    }
    
    return {
        validator: null,
        detail: {
            id: null,
            city_id: null,
            location_types_id: null,
            name: null,
            street_1: null,
            street_2: null,
            zipcode: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            display_long: null,
            display_medium: null,
            display_short: null,
            country: [],
            province: [],
            city: [],
            type: [],
        },
        display_long: null,
        display_medium: null,
        display_short: null,
        init: function (settings) {
            $(document).ready(function () {
                init(settings)
            })
        },
    }
})()

let today = new Date()
let today_year = today.getFullYear()
let today_month = today.getMonth()
let today_date = today.getDate()
$.fn.productSearch = function (settings) {
    "use strict"
    
}

const ProductSearch = function (settings) {
    "use strict"
    
    const _form_product_search = document.getElementById("form_product_search")
    const _formProductSearchCitySubmit = document.getElementById('formProductSearchCitySubmit')
    const _formProductSearchNameSubmit = document.getElementById('formProductSearchNameSubmit')
    const _formProductSearchGuestSubmit = document.getElementById('formProductSearchGuestSubmit')
    const _formProductSearchName = document.getElementById('formProductSearchName')
    const _product_search_name_display = document.getElementById('product_search_name_display')
    const _form_product_search_hotel_product_name = document.getElementById('form_product_search_hotel_product_name')
    const _buttonProductSearchName = document.getElementById("buttonProductSearchName")
    const roomNumber = document.getElementById('product_search_room_quantity')
    const adultNumber = document.getElementById('product_search_adult_quantity')
    const childNumber = document.getElementById('product_search_clild_quantity')
    const _form_product_search_hotel_product_number_of_rooms = document.getElementById('form_product_search_hotel_product_number_of_rooms')
    const _form_product_search_hotel_product_number_of_adults = document.getElementById('form_product_search_hotel_product_number_of_adults')
    const _form_product_search_hotel_product_number_of_children = document.getElementById('form_product_search_hotel_product_number_of_children')
    const _buttonProductSearchGuest = document.getElementById('buttonProductSearchGuest')
    const roomDisplay = document.getElementById('product_search_room_quantity_display')
    const adultDisplay = document.getElementById('product_search_adult_quantity_display')
    const childDisplay = document.getElementById('product_search_children_quantity_display')
    const _buttonProductSearchCity = document.getElementById('buttonProductSearchCity')
    const _formProductSearchCity = document.getElementById("formProductSearchCity")
    const _product_search_city_display = document.getElementById('product_search_city_display')
    const _form_product_search_hotel_product_city_id = document.getElementById('form_product_search_hotel_product_city_id')
    const _formProductSearchCityId = document.getElementById("formProductSearchCityId")
    const _buttonProductSearchCheckOut = document.getElementById("buttonProductSearchCheckOut")
    const _buttonProductSearchCheckIn = document.getElementById("buttonProductSearchCheckIn")
    const _form_product_search_hotel_product_arrive_date = document.getElementById("form_product_search_hotel_product_arrive_date")
    const _form_product_search_hotel_product_depart_date = document.getElementById("form_product_search_hotel_product_depart_date")
    const _product_search_category_display = document.getElementById("product_search_category_display")
    const _product_search_name_icon_display = document.getElementById("product_search_name_icon_display")
    const _formProductSearchIcon = document.getElementById("formProductSearchIcon")
    const _formProductSearchGuestClose = document.getElementById("formProductSearchGuestClose")
    const _formProductSearchCityClose = document.getElementById("formProductSearchCityClose")
    const _formProductSearchNameClose = document.getElementById("formProductSearchNameClose")
    const _form_product_search_hotel_product_category_id = document.getElementById("form_product_search_hotel_product_category_id")
    const _buttonProductSearchCategory = document.getElementById("buttonProductSearchCategory")
    const _formProductSearchNameId = document.getElementById("formProductSearchNameId")
    const _product_search_subtitle = document.getElementById("product_search_subtitle")
    const _button_product_search_panel_hotels_clear = document.getElementById("button_product_search_panel_hotels_clear")
    const _product_search_check_in_display = document.getElementById("product_search_check_in_display")
    const _product_search_check_out_display = document.getElementById("product_search_check_out_display")
    const _form_product_search_hotel_product_product_id = document.getElementById("form_product_search_hotel_product_product_id")
    const _button_product_search_panel_hotels_submit = document.getElementById("button_product_search_panel_hotels_submit")
    const _product_search_results = document.getElementById("product_search_results")
    
    let popupGuestTitle, popupGuestContent, popupNameTitle, popupNameContent, popupCityTitle, popupCityContent, category_id, categoryItem
    let startDate = []
    
    $(_form_product_search)
        .on("change", function () {
        
        })
    
    $(_button_product_search_panel_hotels_submit)
        .on("click", function () {
            buildSearchParameters()
        })
    
    $(_button_product_search_panel_hotels_clear)
        .on("click", function () {
            resetForm()
        })
    
    $(_form_product_search_hotel_product_category_id)
        .on("change", function () {
            if (_form_product_search_hotel_product_category_id.dataset.categoryid) {
                categoryChanged()
                let categoryId = parseInt(_form_product_search_hotel_product_category_id.dataset.categoryid)
                let categoryName = _form_product_search_hotel_product_category_id.dataset.categoryname
                let categoryIcon = _form_product_search_hotel_product_category_id.dataset.categoryicon
                _form_product_search_hotel_product_category_id.value = categoryId
                _product_search_name_icon_display.classList = categoryIcon + " btn-guest-picker-icon"
                _product_search_category_display.innerText = categoryName
                switch (categoryId) {
                    case 1:
                        enableHotelFormFields()
                        //console.log("Hotels")
                        break
                    case 2:
                        enableFlightFormFields()
                        //console.log("Flights")
                        break
                    case 3:
                        //console.log("Cars")
                        break
                    case 4:
                        //console.log("Rail")
                        break
                    case 5:
                        //console.log("Transport")
                        break
                    case 6:
                        //console.log("Tours")
                        break
                    case 7:
                        //console.log("Cruises")
                        break
                    case 8:
                        //console.log("Packages")
                        break
                    case 9:
                        //console.log("Other")
                        break
                    default:
                        //console.log("Default")
                        break
                }
            }
        })
    
    $(_buttonProductSearchCategory)
        .on("click", function () {
            closeProductGuestSearch()
            closeProductNameSearch()
            closeProductCitySearch()
        })
    
    $(_buttonProductSearchCheckIn)
        .on("click", function () {
            closeProductGuestSearch()
            closeProductNameSearch()
            closeProductCitySearch()
        })
        .datepicker({
            startDate: '-1d',
            autoclose: true,
            //numberOfMonths: 2,
            title: function () {
                return "<div class='popover-header'><span class='cPZwQ'>Select a date to continue</span></div>"
            },
            //clearBtn: true,
            todayHighlight: false,
            //todayBtn: true,
            format: "yyyy-mm-dd",
            orientation: "bottom auto",
            showOnFocus: "false",
            beforeShowDay: function (date) {
                /*
                var highlight = eventDates[date]
                if (highlight) {
                    //console.log("y")
                    return {
                        content: "This",
                        classList: [true, "test1"],
                    }
                } else {
                    return [true, 'tttt', 'Tooltip']
                }
                //*/
            },
        })
        .on("changeDate", function (selected) {
            const _buttonProductSearchCheckIn = document.getElementById("buttonProductSearchCheckIn")
            const roomDisplay = document.getElementById('buttonProductSearchCheckIn')
            
            let formattedDate = $(_buttonProductSearchCheckIn).datepicker("getFormattedDate")
            
            startDate = [getTimeStamp($(_buttonProductSearchCheckIn).datepicker("getFormattedDate"))]
            _form_product_search_hotel_product_arrive_date.value = formattedDate
            
            if (roomDisplay) {
                $(roomDisplay).find("span#product_search_check_in_display").text((formattedDate === "") ? "  /  /  " : formattedDate)
            }
            
            $(_buttonProductSearchCheckOut)
                .val("")
                .datepicker("setStartDate", (formattedDate !== "") ? formattedDate : null)
                .datepicker("update")
                .trigger("changeDate")
                .datepicker("update")
        })
    
    $(_buttonProductSearchCheckOut)
        .on("click", function () {
            closeProductGuestSearch()
            closeProductNameSearch()
            closeProductCitySearch()
        })
        .datepicker({
            startDate: '-1d',
            autoclose: true,
            todayBtn: "linked",
            numberOfMonths: 2,
            title: function () {
                return "<div class='popover-header'><span class='cPZwQ'>Select a date to continue</span></div>"
            },
            clearBtn: true,
            todayHighlight: false,
            maxViewMode: 2,
            format: "yyyy-mm-dd",
            orientation: "bottom auto",
            showOnFocus: "false",
            toggleActive: true,
            autoSize: true,
            defaultViewDate: {
                year: today_year,
                month: today_month,
                day: today_date,
            },
            beforeShowDay: function (date) {
                
                //let y = date.getFullYear().toString() // get full year
                //let m = (date.getMonth() + 1).toString() // get month.
                //let d = date.getDate().toString() // get Day
                
                //if (m.length === 1) { m = '0' + m } // append zero(0) if single digit
                //if (d.length === 1) { d = '0' + d } // append zero(0) if single digit
                
                //let currDate = getTimeStamp(y + '-' + m + '-' + d)
                
                //if ($.inArray(currDate, startDate) > -1) {
                //console.log(this)
                //console.log("dates", startDate)
                //console.log("currDate", currDate)
                //console.dir(this)
                //return {
                //	content: date.getUTCDate(),
                //	dateClass: 'blue-highlight',
                //}
                //return [true, "blue-highlight"]
                //} else {
                //return [true, "red-highlight"]
                //}
            },
            beforeShowMonth: function (date) {
                //console.log(date)
            },
        })
        .on("changeDate", function (e) {
            const roomDisplay = document.getElementById('buttonProductSearchCheckOut')
            let formattedDate = $(_buttonProductSearchCheckOut).datepicker("getFormattedDate")
            
            _form_product_search_hotel_product_depart_date.value = formattedDate
            
            if (roomDisplay) {
                $(roomDisplay).find("span#product_search_check_out_display").text((formattedDate === "") ? "  /  /  " : formattedDate)
            }
            
        })
    
    $(_formProductSearchNameClose)
        .on("click", function () {
            closeProductNameSearch()
        })
    
    $(_formProductSearchCityClose)
        .on("click", function () {
            closeProductCitySearch()
        })
    
    $(_formProductSearchGuestClose)
        .on("click", function () {
            closeProductGuestSearch()
        })
    
    $(_formProductSearchCitySubmit)
        .on("click", function () {
            updateProductCitySearch()
            closeProductGuestSearch()
        })
    
    $(_formProductSearchNameSubmit)
        .on("click", function () {
            updateProductNameSearch()
            closeProductNameSearch()
        })
    
    $(_formProductSearchGuestSubmit)
        .on("click", function () {
            updateProductGuestSearch()
            closeProductGuestSearch()
        })
    
    $(_buttonProductSearchCity)
        .on("show.bs.popover", function () {
            initProductCitySearch()
            
        })
        .on("shown.bs.popover", function () {
            //_formProductSearchCity.focus()
        })
        .on("hidden.bs.popover", function () {
            window.removeEventListener("click", clickOutsideProductNameSearch)
        })
    
    $(_buttonProductSearchGuest)
        .on("show.bs.popover", function () {
            initProductGuestSearch()
            
        })
        .on("shown.bs.popover", function () {
            //_formProductSearchName.focus()
        })
        .on("hidden.bs.popover", function () {
            window.removeEventListener("click", clickOutsideProductGuestSearch)
        })
    
    $(_buttonProductSearchName)
        .on("show.bs.popover", function () {
            initProductNameSearch()
        })
        .on("shown.bs.popover", function () {
            //_formProductSearchName.focus()
        })
        .on("hidden.bs.popover", function () {
            window.removeEventListener("click", clickOutsideProductNameSearch)
        })
    
    const getTimeStamp = function (selectedDate) {
        if (!isNaN(Date.parse(selectedDate))) {
            let date = new Date(selectedDate + " 00:00")
            let y = date.getFullYear().toString() // get full year
            let m = (date.getMonth() + 1).toString() // get month.
            let d = date.getDate().toString() // get Day
            
            if (m.length === 1) { m = '0' + m } // append zero(0) if single digit
            if (d.length === 1) { d = '0' + d } // append zero(0) if single digit
            
            return moment(y + '-' + m + '-' + d + ' 00:00', "YYYY-MM-DD H:mm").valueOf()
        }
        
    }
    
    const clearSearchResults = function () {
    
    }
    
    const submitHotel = function (params, callback) {
        let url = "/api/v1.0/search/hotels"
        
        if (params) {
            try {
                sendGetRequest(url, params, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const hotelSearch = function (data) {
        clearSearchResults()
        submitHotel(data, function (results) {
            if (results) {
                //console.log("results", results)
            }
        })
    }
    
    const buildSearchParameters = function () {
        let categoryId = (!isNaN(parseInt(_form_product_search_hotel_product_category_id.value))) ? parseInt(_form_product_search_hotel_product_category_id.value) : null
        
        if (!categoryId) {
            return
        }
        let data = {}
        
        switch (categoryId) {
            case 1:
                let adults = (!isNaN(parseInt(_form_product_search_hotel_product_number_of_adults.value))) ? parseInt(_form_product_search_hotel_product_number_of_adults.value) : 1
                let children = (!isNaN(parseInt(_form_product_search_hotel_product_number_of_children.value))) ? parseInt(_form_product_search_hotel_product_number_of_children.value) : 0
                let cityId = (!isNaN(parseInt(_form_product_search_hotel_product_city_id.value))) ? parseInt(_form_product_search_hotel_product_city_id.value) : null
                let guestCount = (adults + children)
                let fromDate = (_form_product_search_hotel_product_arrive_date.value !== "") ? _form_product_search_hotel_product_arrive_date.value : null
                let toDate = (_form_product_search_hotel_product_depart_date.value !== "") ? _form_product_search_hotel_product_depart_date.value : null
                
                if (cityId && fromDate && toDate) {
                    data.category_id = categoryId
                    data.city_id = cityId
                    data.from_date = fromDate
                    data.to_date = toDate
                    data.pax = guestCount
                    
                    hotelSearch(data)
                }
                
                break
            default:
                return
        }
    }
    
    const resetForm = function () {
        $("div[data-hotel='true'").hide()
        $("div[data-flight='true'").hide()
        
        closeProductGuestSearch()
        closeProductNameSearch()
        closeProductCitySearch()
        
        updateProductGuestSearch()
        updateProductNameSearch()
        updateProductCitySearch()
        
        _product_search_category_display.innerText = "** Select **"
        _product_search_name_display.innerText = "any"
        _product_search_city_display.innerText = "city name"
        _product_search_check_in_display.innerText = " /  / "
        _product_search_check_out_display.innerText = " /  / "
        
        roomNumber.value = 1
        adultNumber.value = 1
        childNumber.value = 0
        
        let roomCount = (!isNaN(parseInt(roomNumber.value))) ? parseInt(roomNumber.value) : 1
        let adultCount = (!isNaN(parseInt(adultNumber.value))) ? parseInt(adultNumber.value) : 1
        let childCount = (!isNaN(parseInt(childNumber.value))) ? parseInt(childNumber.value) : 0
        
        roomDisplay.innerText = (roomCount > 1) ? roomCount + ' rooms, ' : roomCount + ' room, '
        adultDisplay.innerText = (adultCount > 1) ? adultCount + ' adults, ' : adultCount + ' adult, '
        childDisplay.innerText = (childCount > 1) ? childCount + ' children' : childCount + ' child'
        
        _product_search_name_icon_display.classList = "fas fa-pencil-alt btn-guest-picker-icon"
        
        _form_product_search_hotel_product_city_id.value = ""
        _form_product_search_hotel_product_category_id.value = ""
        _form_product_search_hotel_product_product_id.value = ""
        _form_product_search_hotel_product_name.value = ""
        _form_product_search_hotel_product_arrive_date.value = ""
        _form_product_search_hotel_product_number_of_children.value = "0"
        _form_product_search_hotel_product_number_of_adults.value = "1"
        _form_product_search_hotel_product_number_of_rooms.value = "1"
        _form_product_search_hotel_product_depart_date.value = ""
        
        disableFormFields()
    }
    
    const enableHotelFormFields = function () {
        _buttonProductSearchName.disabled = false
        _buttonProductSearchCity.disabled = false
        _buttonProductSearchCheckIn.disabled = false
        _buttonProductSearchCheckOut.disabled = false
        _buttonProductSearchGuest.disabled = false
        $("div[data-hotel='true'").show()
    }
    
    const enableFlightFormFields = function () {
        _buttonProductSearchName.disabled = false
        _buttonProductSearchCity.disabled = false
        _buttonProductSearchCheckIn.disabled = false
        _buttonProductSearchCheckOut.disabled = false
        _buttonProductSearchGuest.disabled = false
        $("div[data-flight='true'").show()
    }
    
    const disableFormFields = function () {
        _buttonProductSearchName.disabled = true
        _buttonProductSearchCity.disabled = true
        _buttonProductSearchCheckIn.disabled = true
        _buttonProductSearchCheckOut.disabled = true
        _buttonProductSearchGuest.disabled = true
    }
    
    const initAutocomplete = function (category_id) {
        
        $(_formProductSearchCity)
            .on("search", function () {
                _formProductSearchCity.value = ""
                _formProductSearchCityId.value = ""
                updateProductCitySearch()
            })
            .on("click", function (e) {
                $(this).select()
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/cities",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                onSelect: function (suggestion) {
                    if (!suggestion.data) {
                        return
                    }
                    let city = suggestion.data
                    
                    _formProductSearchCityId.value = city.id
                },
            })
        
        $(_formProductSearchName)
            .on("search", function () {
                _formProductSearchName.value = ""
                _formProductSearchNameId.value = ""
                updateProductCitySearch()
            })
            .on("click", function (e) {
                $(this).select()
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/products",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                params: { "category_id": category_id },
                paramName: "st",
                onSelect: function (suggestion) {
                    if (!suggestion.data) {
                        return
                    }
                    let product = suggestion.data
                    _form_product_search_hotel_product_product_id.value = product.id
                    _formProductSearchNameId.value = product.id
                },
            })
    }
    
    const categoryChanged = function () {
        resetForm()
    }
    
    const updateProductNameSearch = function () {
        
        if (_formProductSearchName) {
            let name = (_formProductSearchName.value !== '') ? _formProductSearchName.value : 'any'
            
            _product_search_name_display.innerText = name
            _form_product_search_hotel_product_name.value = name
            
            if (_buttonProductSearchName) {
                $(_buttonProductSearchName).popover("hide")
            }
        }
    }
    
    const updateProductGuestSearch = function () {
        
        if (
            roomNumber && adultNumber && childNumber
            && _form_product_search_hotel_product_number_of_rooms && _form_product_search_hotel_product_number_of_adults && _form_product_search_hotel_product_number_of_children
            && roomDisplay && adultDisplay && childDisplay
        ) {
            let roomCount = (!isNaN(parseInt(roomNumber.value))) ? parseInt(roomNumber.value) : 1
            let adultCount = (!isNaN(parseInt(adultNumber.value))) ? parseInt(adultNumber.value) : 1
            let childCount = (!isNaN(parseInt(childNumber.value))) ? parseInt(childNumber.value) : 0
            
            roomDisplay.innerText = (roomCount > 1) ? roomCount + ' rooms, ' : roomCount + ' room, '
            adultDisplay.innerText = (adultCount > 1) ? adultCount + ' adults, ' : adultCount + ' adult, '
            childDisplay.innerText = (childCount > 1) ? childCount + ' children' : childCount + ' child'
            
            _form_product_search_hotel_product_number_of_rooms.value = (roomCount > 1) ? roomCount : 1
            _form_product_search_hotel_product_number_of_adults.value = (adultCount > 1) ? adultCount : 1
            _form_product_search_hotel_product_number_of_children.value = (childCount > 0) ? childCount : 0
            
            if (_buttonProductSearchGuest) {
                $(_buttonProductSearchGuest).popover("hide")
            }
        }
    }
    
    const updateProductCitySearch = function () {
        if (_formProductSearchCity) {
            _product_search_city_display.innerText = (_formProductSearchCity.value !== '') ? _formProductSearchCity.value : 'city name'
            _form_product_search_hotel_product_city_id.value = _formProductSearchCityId.value
            $(_form_product_search_hotel_product_city_id).trigger("change")
        }
    }
    
    const closeProductNameSearch = function () {
        if (_buttonProductSearchName) {
            $(_buttonProductSearchName).popover("hide")
        }
        
        window.removeEventListener("click", clickOutsideProductNameSearch)
    }
    
    const closeProductCitySearch = function () {
        if (_buttonProductSearchCity) {
            $(_buttonProductSearchCity).popover("hide")
        }
        window.removeEventListener("click", clickOutsideProductCitySearch)
    }
    
    const closeProductGuestSearch = function () {
        if (_buttonProductSearchGuest) {
            $(_buttonProductSearchGuest).popover("hide")
        }
        
        window.removeEventListener("click", clickOutsideProductGuestSearch)
    }
    
    const clickOutsideProductNameSearch = (e) => {
        let class_name = "name-search"
        let tar = $(e.target).parents("div.popover")
        
        if (!tar[0] && !e.target.className.includes(class_name)) {
            updateProductNameSearch()
            closeProductNameSearch()
        }
    }
    
    const clickOutsideProductGuestSearch = (e) => {
        let class_name = "btn-guest-picker"
        let tar = $(e.target).parents("div.popover")
        
        if ((!tar[0] && !e.target.className.includes(class_name))) {
            updateProductGuestSearch()
            closeProductGuestSearch()
        }
    }
    
    const clickOutsideProductCitySearch = (e) => {
        let class_name = "btn-city-picker"
        let tar = $(e.target).parents("div.popover")
        
        if (!tar[0] && !e.target.className.includes(class_name)) {
            updateProductCitySearch()
            closeProductCitySearch()
        }
    }
    
    const initProductNameSearch = function () {
        window.addEventListener("click", clickOutsideProductNameSearch)
    }
    
    const initProductGuestSearch = function () {
        window.addEventListener("click", clickOutsideProductGuestSearch)
    }
    
    const initProductCitySearch = function () {
        window.addEventListener("click", clickOutsideProductCitySearch)
    }
    
    const init = function (settings) {
        $(function () {
            
            if (_form_product_search) {
                categoryItem = document.querySelectorAll(".category-dropdown-item")
                categoryItem.forEach(el => el.addEventListener("click", event => {
                    _formProductSearchIcon.classList = " " + el.dataset.categoryicon + " mr-3 "
                    _product_search_name_icon_display.classList = " " + el.dataset.categoryicon + " btn-guest-picker-icon"
                    _product_search_category_display.innerText = el.dataset.categoryname
                    category_id = parseInt(el.dataset.categoryid)
                    initAutocomplete(category_id)
                    _form_product_search_hotel_product_category_id.value = category_id
                    _form_product_search_hotel_product_category_id.dataset.categoryid = category_id
                    _form_product_search_hotel_product_category_id.dataset.categoryname = el.dataset.categoryname
                    _form_product_search_hotel_product_category_id.dataset.categoryicon = el.dataset.categoryicon
                    _product_search_subtitle.innerText = el.dataset.categoryname
                    $(_form_product_search_hotel_product_category_id).trigger("change")
                    $(_buttonProductSearchCategory).trigger("change")
                }))
                
                if (_buttonProductSearchName) {
                    popupNameTitle = $("#popoverNameForm .popover-head h5")
                    popupNameContent = $("#popoverNameForm .popover-body form")
                    
                    $(_buttonProductSearchName).popover({
                        placement: "bottom",
                        title: () => popupNameTitle,
                        html: true,
                        container: "body",
                        content: () => popupNameContent,
                        
                    })
                }
                
                if (_buttonProductSearchCity) {
                    popupCityTitle = $("#popoverCityForm .popover-head h5")
                    popupCityContent = $("#popoverCityForm .popover-body form")
                    
                    $(_buttonProductSearchCity).popover({
                        placement: "bottom",
                        title: () => popupCityTitle,
                        html: true,
                        container: "body",
                        content: () => popupCityContent,
                        
                    })
                }
                
                if (_buttonProductSearchGuest) {
                    popupGuestTitle = $("#popoverGuestForm .popover-head h5")
                    popupGuestContent = $("#popoverGuestForm .popover-body form")
                    
                    $(_buttonProductSearchGuest).popover({
                        placement: "bottom",
                        title: () => popupGuestTitle,
                        html: true,
                        container: "body",
                        content: () => popupGuestContent,
                        
                    })
                }
                
                if (_product_search_results) {
                    //$(_product_search_results).hide()
                    
                }
                
                resetForm()
            }
            
        })
    }
    
    init(settings)
    
    return {
        init: function (settings) {
            init(settings)
        },
        updateProductCitySearch: function () {
            updateProductCitySearch()
        },
        updateProductNameSearch: function () {
            updateProductNameSearch()
        },
        closeProductGuestSearch: function () {
            closeProductGuestSearch()
        },
    }
}

$(function () {
    //let productSearch = ProductSearch()
})

$.fn.formFields = function (settings) {
    "use strict"
    let id = $(this).attr("id")
    let form = document.getElementById(id)
    let elements = form.elements
    let pre = document.createElement("pre")
    let code = document.createElement("code")
    let data = ""
    let vals = ""
    
    code.id = "constantFields"
    code.classList = [`language-javascript`]
    
    pre.appendChild(code)
    form.appendChild(pre)
    
    for (var n = 0; n < elements.length; n++) {
        let el = elements[n]
        if (el.id) {
            let id = el.id
            let constantField = `const _${id} = document.getElementById('${id}')\n`
            let constantValue = `_${id}.value = ""\n`
            data += constantField
            vals += constantValue
        }
        
    }
    
    $(code).attr("data-prismjs-copy", 'Copy the JavaScript snipp')
    code.innerHTML = data + "\n" + vals
    Prism.highlightElement(code)
}

jQuery(($) => {
    $.fn.dateSelect = function (opt) {
        const regex = /(((19|20)\d\d)\-(0[1-9]|1[0-2])\-((0|1)[0-9]|2[0-9]|3[0-1]))$/
        
        let element = $(this)
        let elementId = element.attr("id")
        let separatorDate = "-"
        let currentYear = new Date().getFullYear() - 1
        let endYear = currentYear + 5
        let startDate = moment(currentYear + "-01-01").format("YYYY-MM-DD")
        let endDate = moment(endYear + "-12-31").format("YYYY-MM-DD")
        let $element, $elementWrapper, $elementGroupWrapper, $elementGroupAppend, $buttonGroupAppend,
            $input, $inputLabel, $errorElement, $buttonGroupAppendClear, input, picker
        
        let isShift = false
        
        /*
        console.log("|__ currentYear", currentYear)
        console.log("|__ endYear", endYear)
        console.log("|__ startDate", startDate)
        console.log("|__ endDate", endDate)
        //*/
        
        element.attr("id", "date-selector-" + elementId)
        
        let defaults = {
            
            // Strings and translations
            monthsFull: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
            monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
            weekdaysFull: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
            weekdaysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
            showMonthsShort: false,
            showWeekdaysFull: false,
            
            // Buttons
            today: "Today",
            clear: "Clear",
            close: "Close",
            
            // Accessibility labels
            labelMonthNext: "Next month",
            labelMonthPrev: "Previous month",
            labelMonthSelect: "Select a month",
            labelYearSelect: "Select a year",
            
            // Formats
            format: "yyyy-mm-dd",
            formatSubmit: "yyyy-mm-dd",
            //hiddenPrefix: "date-selector-" + elementId,
            hiddenSuffix: "_submit",
            hiddenName: undefined,
            
            // Editable input
            editable: undefined,
            
            // Dropdown selectors
            selectYears: 5,
            selectMonths: true,
            
            // First day of the week
            firstDay: 1,
            
            // Date limits
            min: undefined,
            max: undefined,
            
            // Disable dates
            disable: undefined,
            
            // Root picker container
            container: undefined,
            
            // Hidden input container
            containerHidden: undefined,
            
            // Close on a user action
            closeOnSelect: true,
            closeOnClear: true,
            
            // Events
            onStart: undefined,
            onRender: undefined,
            onOpen: undefined,
            onClose: undefined,
            onSet: function (context) {
                $input.val(moment(context.select).format("YYYY-MM-DD"))
                toggleClearButton()
            },
            onStop: undefined,
        }
        
        let settings = {
            label: "Date",
            placeholder: "Select Date",
        }
        
        const isNumeric = function (input, keyCode) {
            if (!isNaN(parseInt(keyCode))) {
                keyCode = parseInt(keyCode)
            }
            
            if (keyCode === 16) {
                isShift = true
            }
            
            if ((keyCode >= 48 && keyCode <= 57) || (keyCode >= 96 && keyCode <= 105) || (keyCode === 8) || (keyCode === 46)) {
                
                if (keyCode !== 16) {
                    if ((input.value.length === 4 || input.value.length === 7) && keyCode !== 8) {
                        input.value += separatorDate
                    }
                    
                    return true
                }
                
            }
            
            return false
        }
        
        const loadError = function (input) {
            let $errorElement = $(input).parents("div.form-element").find("div.error")
            
            $errorElement.html("Invalid Date. Only YYYY-MM-DD format allowed.").show()
        }
        
        const unSetDateError = function (input) {
            let $errorElement = $(input).parents("div.form-element").find("div.error")
            
            $errorElement.html("").hide()
        }
        
        const validateDateFormat = function (input, keyCode) {
            let dateString = input.value
            
            if (keyCode === 16) {
                isShift = true
            }
            
            if (regex.test(dateString) || dateString.length === 0) {
                unSetDateError(input)
                DateSelect.picker.set("select", dateString, { format: "yyyy-mm-dd" })
                DateSelect.picker.render()
            } else {
                loadError(input)
            }
            
        }
        
        const buildElements = function (element, opt) {
            $element = element
            $elementWrapper = $("<div>")
                .addClass(`form-element`)
            
            $elementGroupWrapper = $("<div>")
                .addClass(`input-group`)
            
            $elementGroupAppend = $("<div>")
                .addClass(`input-group-append`)
            
            $buttonGroupAppend = $("<button type='button'>")
                .attr("id", "button-" + elementId)
                .attr("type", "button")
                .addClass(`btn btn-md btn-secondary m-0 px-3 py-2 z-depth-0 waves-effect waves-light`)
                .html('<i class="fas fa-calendar-alt"></i>')
                .on("click", function (e) {
                    e.preventDefault()
                })
            
            $buttonGroupAppendClear = $("<button type='button'>")
                .attr("id", "button-clear-" + elementId)
                .addClass(`btn btn-md btn-outline-danger m-0 px-3 py-2 z-depth-0 waves-effect waves-light`)
                .html('<i class="fas fa-ban"></i>')
                .on("click", function () {
                    DateSelect.clear()
                    $input.val("").trigger("change")
                    unSetDateError($input[0])
                })
            
            $input = $("<input>")
                .addClass("form-control date-format")
                .attr("id", elementId)
                .attr("type", "text")
                .attr("placeholder", settings.placeholder)
                .attr("maxlength", "10")
                .on("keydown", function (event) {
                    return isNumeric(this, event.keyCode)
                })
                .on("keyup", function (event) {
                    console.log("event", event.keyCode)
                    
                    if ($(this).val() === "") {
                        DateSelect.clear()
                        unSetDateError($input[0])
                    } else {
                        validateDateFormat(this, event.keyCode)
                    }
                    
                    toggleClearButton()
                })
                .on("change", function (e) {
                    console.log("DateSelect.input:change(e)")
                    //e.preventDefault()
                    
                    if ($(this).val() === "") {
                        //unSetDateError($input[0])
                    }
                    
                    toggleClearButton()
                })
                .on("focus", function (e) {
                    /*
                    console.log("DateSelect.input:focus(e)")
                    console.log("|__ input.val()", $input.val())
                    console.log("|__ buttonGroupAppend.val()", $buttonGroupAppend.val())
                    console.log("|__ input.val()", $input.val())
                    //*/
                })
            
            $inputLabel = $("<label>")
                .attr("for", elementId)
                .html(settings.label)
            
            $errorElement = $("<div>")
                .addClass("error w-100 text-center")
        }
        
        const toggleClearButton = function () {
            
            if ($input.val() !== "") {
                $buttonGroupAppendClear.show()
                let id = $input.attr("id")
                clearError(document.getElementById(id))
            } else {
                $buttonGroupAppendClear.hide()
            }
            
        }
        
        const setWrapper = function (element, opt) {
            
            // ----
            buildElements(element, opt)
            
            $elementGroupAppend.append($buttonGroupAppendClear, $buttonGroupAppend)
            $elementGroupWrapper.append($input, $elementGroupAppend)
            $elementWrapper.append($inputLabel, $elementGroupWrapper, $errorElement)
            $element.append($elementWrapper)
            picker = $buttonGroupAppend.pickadate("picker")
        }
        
        const assignOptions = function (newOptions) {
            if (newOptions) {
                $.each(newOptions, function (k, v) {
                    defaults[k] = v
                })
            }
        }
        
        const clear = function () {
            
            if (DateSelect.picker.clear()) {
                DateSelect.picker.clear()
                unSetDateError($input[0])
            }
            
            $input.val("")
            $buttonGroupAppend.val("")
        }
        
        const set = function (opts) {
            if (!opts) {
                opts = {}
            }
            
            DateSelect.picker.set(opts, { muted: true })
            
        }
        
        const value = function (date) {
            
            if (date) {
                DateSelect.picker.set("select", date, { format: "yyyy-mm-dd" })
                DateSelect.picker.render()
                return null
            } else {
                return ($input.val() === "") ? null : $input.val()
            }
            
        }
        
        const DateSelect = {
            picker: null,
            val: null,
            fooListener: function (val) {
            
            },
            registerNewListener: function (externalListenerFunction) {
                this.fooListener = externalListenerFunction
            },
            set: function () {
                set()
            },
            value: function (dataValue) {
                if (!dataValue) {
                    dataValue = null
                }
                return value(dataValue)
            },
            clear: function () {
                clear()
            },
            init: function (element, opt) {
                init(element, opt)
            },
        }
        
        const init = function (element, opt) {
            assignOptions(opt)
            
            settings.label = ($(element).attr("data-label")) ? $(element).attr("data-label") : "Date"
            settings.placeholder = ($(element).attr("data-placeholder")) ? $(element).attr("data-placeholder") : "Select Date"
            
            setWrapper(element, opt)
            
            $buttonGroupAppend
                .pickadate(defaults)
                .on("change", function () {
                    if ($buttonGroupAppend.val() === "") {
                        $input.val("")
                    } else {
                        $input.val($(this).val())
                    }
                })
            
            picker = $buttonGroupAppend.pickadate("picker")
            DateSelect.picker = $buttonGroupAppend.pickadate("picker")
            
            toggleClearButton()
        }
        
        init(element, opt)
        return DateSelect
    }
})

jQuery(($) => {
    $.fn.timeSelect = function (opt) {
        let element = $(this)
        let filterMax = ""
        let elementId = element.attr("id")
        let separatorTime = ":"
        
        element.attr("id", "time-selector-" + elementId)
        
        let $element, $elementWrapper, $elementGroupWrapper, $elementGroupAppend, $buttonGroupAppend,
            $input, $inputLabel, $errorElement, $buttonGroupAppendClear, input, picker
        
        let defaults = {
            // Translations and clear button
            clear: 'Clear',
            
            // Formats
            format: 'h:i A',
            formatLabel: undefined,
            formatSubmit: undefined,
            hiddenPrefix: undefined,
            hiddenSuffix: '_submit',
            
            // Editable input
            editable: undefined,
            
            // Time intervals
            interval: 30,
            
            // Time limits
            min: undefined,
            max: undefined,
            
            // Root picker container
            container: undefined,
            
            // Hidden input container
            containerHidden: undefined,
            
            // Close on a user action
            closeOnSelect: true,
            closeOnClear: true,
            
            // Events
            onStart: undefined,
            onRender: undefined,
            onOpen: undefined,
            onClose: undefined,
            onSet: undefined,
            onStop: undefined,
        }
        
        let settings = {
            label: "Time",
            placeholder: "Select Time",
        }
        
        const isNumeric = function (input, keyCode) {
            if (!isNaN(parseInt(keyCode))) {
                keyCode = parseInt(keyCode)
            }
            
            if (keyCode === 16) {
                isShift = true
            }
            
            if ((keyCode >= 48 && keyCode <= 57) || (keyCode >= 96 && keyCode <= 105) || (keyCode === 8) || (keyCode === 46)) {
                
                if (keyCode !== 16) {
                    if ((input.value.length === 2) && keyCode !== 8) {
                        input.value += separatorTime
                    }
                    
                    return true
                }
                
            }
            
            return false
        }
        
        const loadError = function (input) {
            let $errorElement = $(input).parents("div.form-element").find("div.error")
            
            $errorElement.html("Invalid Time. Only HH-MM format allowed.").show()
        }
        
        const unSetTimeError = function (input) {
            let $errorElement = $(input).parents("div.form-element").find("div.error")
            
            $errorElement.html("").hide()
        }
        
        function validate_time (time) {
            var a = true
            var time_arr = time.split(":")
            
            if (time_arr.length !== 2) {
                a = false
            } else {
                if (isNaN(time_arr[0]) || isNaN(time_arr[1])) {
                    a = false
                }
                if (time_arr[0] < 24 && time_arr[1] < 60) {
                    if (time_arr[0] && time_arr[1] && !isNaN(parseInt(time_arr[0])) && !isNaN(parseInt(time_arr[1]))) {
                        if (parseInt(time_arr[0]) <= 9) {
                            time_arr[0] = "0" + time_arr[0]
                        }
                        if (parseInt(time_arr[1]) <= 9) {
                            time_arr[0] = "0" + time_arr[0]
                        }
                        $(input).val(time_arr[0] + ":" + time_arr[1])
                    } else {
                        return false
                    }
                } else {
                    a = false
                }
            }
            return a
        }
        
        const validateTimeFormat = function (input, keyCode) {
            let timeString = input.value
            //let regex = /^\d{2,}:(?:[0-5]\d):(?:[0-5]\d)$/
            
            if (validate_time(timeString)) {
                //if (regex.test(timeString) || timeString.length === 0) {
                unSetTimeError(input)
            } else {
                loadError(input)
            }
        }
        
        const buildElements = function (element, opt) {
            $element = element
            $elementWrapper = $("<div>")
                .addClass(`form-element`)
            
            $elementGroupWrapper = $("<div>")
                .addClass(`input-group`)
            
            $elementGroupAppend = $("<div>")
                .addClass(`input-group-append`)
            
            $buttonGroupAppend = $("<button type='button'>")
                .attr("id", "button-" + elementId)
                .attr("type", "button")
                .addClass(`btn btn-md btn-secondary m-0 px-3 py-2 z-depth-0 waves-effect waves-light`)
                .html('<i class="fas fa-calendar-alt"></i>')
                .on("click", function (e) {
                    e.preventDefault()
                })
            
            $buttonGroupAppendClear = $("<button type='button'>")
                .attr("id", "button-clear-" + elementId)
                .addClass(`btn btn-md btn-outline-danger m-0 px-3 py-2 z-depth-0 waves-effect waves-light`)
                .html('<i class="fas fa-ban"></i>')
                .on("click", function () {
                    TimeSelect.clear()
                    $input.val("").trigger("change")
                    unSetTimeError($input[0])
                })
            
            $input = $("<input>")
                .addClass("form-control time-format")
                .attr("id", elementId)
                .attr("type", "text")
                .attr("placeholder", settings.placeholder)
                .attr("maxlength", "5")
                .on("keydown", function (event) {
                    return isNumeric(this, event.keyCode)
                })
                .on("keyup", function (event) {
                    validateTimeFormat(this, event.keyCode)
                    toggleClearButton()
                })
                .on("change", function () {
                    toggleClearButton()
                })
            
            $inputLabel = $("<label>")
                .attr("for", elementId)
                .html(settings.label)
            
            $errorElement = $("<div>")
                .addClass("error w-100 text-center")
        }
        
        const toggleClearButton = function () {
            if ($input.val() !== "") {
                $buttonGroupAppendClear.show()
                let id = $input.attr("id")
                clearError(document.getElementById(id))
            } else {
                $buttonGroupAppendClear.hide()
            }
        }
        
        const setWrapper = function (element, opt) {
            buildElements(element, opt)
            $elementGroupAppend.append($buttonGroupAppendClear, $buttonGroupAppend)
            $elementGroupWrapper.append($input, $elementGroupAppend)
            $elementWrapper.append($inputLabel, $elementGroupWrapper, $errorElement)
            $element.append($elementWrapper)
            picker = $buttonGroupAppend.pickatime("picker")
        }
        
        const assignOptions = function (newOptions) {
            if (newOptions) {
                $.each(newOptions, function (k, v) {
                    defaults[k] = v
                })
            }
            
        }
        
        const clear = function () {
            
            if (TimeSelect.picker.clear()) {
                TimeSelect.picker.clear()
                TimeSelect.picker.set("select", moment().format("YYYY-MM-DD"), { format: "HH-i" })
                TimeSelect.picker.render()
                unSetTimeError($input[0])
            }
        }
        
        const set = function (opts) {
            if (!opts) {
                opts = {}
            }
            
            TimeSelect.picker.set(opts, { muted: true })
            
        }
        
        const value = function (date) {
            
            if (date) {
                TimeSelect.picker.set("select", date, { format: "HH-i" })
                TimeSelect.picker.render()
                return null
            } else {
                return ($input.val() === "") ? null : $input.val()
            }
            
        }
        
        const TimeSelect = {
            picker: null,
            val: null,
            fooListener: function (val) {},
            registerNewListener: function (externalListenerFunction) {
                this.fooListener = externalListenerFunction
            },
            set: function () {
                set()
            },
            value: function (dataValue) {
                if (!dataValue) {
                    dataValue = null
                }
                return value(dataValue)
            },
            clear: function () {
                clear()
            },
            init: function (element, opt) {
                init(element, opt)
            },
        }
        
        const init = function (element, opt) {
            assignOptions(opt)
            
            settings.label = ($(element).attr("data-label")) ? $(element).attr("data-label") : "Date"
            settings.placeholder = ($(element).attr("data-placeholder")) ? $(element).attr("data-placeholder") : "Select Date"
            
            setWrapper(element, opt)
            
            $buttonGroupAppend
                .pickatime(defaults)
                .on("change", function () {
                    if ($(this).val() === "") {
                        $input.val(filterMax)
                    } else {
                        $input.val($(this).val())
                    }
                    
                    $input.trigger("change")
                })
            
            picker = $buttonGroupAppend.pickatime("picker")
            toggleClearButton()
            TimeSelect.picker = $buttonGroupAppend.pickatime("picker")
        }
        
        init(element, opt)
        return TimeSelect
    }
})

const tinyEditor = (function () {
    "use strict"
    let but_toggle
    
    const init = function (settings) {
        but_toggle = document.querySelectorAll(".but_toggle")
        but_toggle.forEach(el => el.addEventListener("click", event => {
            if (el.dataset.texted) {
                let editorId = el.dataset.texted
                let editor = $("#" + editorId)
                let cardBlock = editor.parents("div.card")
                if (tinyMCE.get(editorId)) {
                    editor.val(htmlEncode(editor.val()))
                    tinymce.remove("#" + editorId)
                    cardBlock.removeClass("is-fullscreen")
                } else {
                    editor.val(decodeHtml(editor.val()))
                    cardBlock.addClass("is-fullscreen")
                    addTinyMCE(editorId)
                }
            }
        }))
    }
    
    const addTinyMCE = function (el) {
        tinymce.init({
            selector: "#" + el,
            menubar: false,
            height: "400",
            plugins: "print visualblocks visualchars charmap hr pagebreak advlist lists",
            content_css: [
                "https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&family=Roboto+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap",
                "/public/css/bootstrap.min.css",
                "/public/css/style.css",
                "/public/css/variant.min.css",
            ],
            body_class: "p-2",
            font_formats: "Andale Mono=andale mono,times; Arial=arial,helvetica,sans-serif; Arial Black=arial black,avant garde; Book Antiqua=book antiqua,palatino; Comic Sans MS=comic sans ms,sans-serif; Courier New=courier new,courier; Georgia=georgia,palatino; Helvetica=helvetica; Impact=impact,chicago; Open Sans=Open Sans;Symbol=symbol; Tahoma=tahoma,arial,helvetica,sans-serif; Terminal=terminal,monaco; Times New Roman=times new roman,times; Trebuchet MS=trebuchet ms,geneva; Verdana=verdana,geneva; Webdings=webdings; Wingdings=wingdings,zapf dingbats",
            toolbar1: "undo redo | styleselect | fontselect fontsizeselect | removeformat | numlist bullist checklist | outdent indent ",
            toolbar2: "cut copy | bold italic underline strikethrough | forecolor | alignleft aligncenter alignright alignjustify | backcolor",
            content_style: "body { font-family:\"Open Sans\", sans-serif; font-size:14px; font-weight: 400 }",
            style_formats: [
                {
                    title: "Headers",
                    items: [
                        {
                            title: "h1",
                            block: "h1",
                        },
                        {
                            title: "h2",
                            block: "h2",
                        },
                        {
                            title: "h3",
                            block: "h3",
                        },
                        {
                            title: "h4",
                            block: "h4",
                        },
                        {
                            title: "h5",
                            block: "h5",
                        },
                        {
                            title: "h6",
                            block: "h6",
                        },
                    ],
                }, {
                    title: "Blocks",
                    items: [
                        {
                            title: "p",
                            block: "p",
                        },
                        {
                            title: "div",
                            block: "div",
                        },
                        {
                            title: "pre",
                            block: "pre",
                        },
                    ],
                },
                
                {
                    title: "Containers",
                    items: [
                        {
                            title: "section",
                            block: "section",
                            wrapper: true,
                            merge_siblings: false,
                        },
                        {
                            title: "article",
                            block: "article",
                            wrapper: true,
                            merge_siblings: false,
                        },
                        {
                            title: "blockquote",
                            block: "blockquote",
                            wrapper: true,
                        },
                        {
                            title: "hgroup",
                            block: "hgroup",
                            wrapper: true,
                        },
                        {
                            title: "aside",
                            block: "aside",
                            wrapper: true,
                        },
                        {
                            title: "figure",
                            block: "figure",
                            wrapper: true,
                        },
                    ],
                },
            ],
            branding: false,
            resize: false,
            setup: function (editor) {
                editor.on("change", function () {
                    editor.save()
                })
            },
        })
    }
    
    return {
        addTinyMCE: function (el) {
            addTinyMCE(el)
        },
        init: function () {
            init()
        },
    }
})()

$(document).ready(function () {
    $(function () {
        tinyEditor.init()
    })
})



const ContextMenu = (function () {
    "use strict"
    
    let $contextMenu
    
    const assignSeasonToDays = function () {
        //console.log("ContextMenu:assignSeasonToDays()", ContextMenu)
    }
    
    const init = function (settings) {
        
        $contextMenu = $.contextMenu({
            selector: ".selected-day",
            callback: function (key, options) {
                switch (key.toLowerCase()) {
                    case "edit":
                        assignSeasonToDays()
                        break
                    default:
                        break
                }
            },
            items: {
                "edit": {
                    name: "Assign Season To Days",
                    icon: "edit",
                },
                "cut": {
                    name: "Cut",
                    icon: "cut",
                },
                "copy": {
                    name: "Copy",
                    icon: "copy",
                },
                "paste": {
                    name: "Paste",
                    icon: "paste",
                },
                "delete": {
                    name: "Delete",
                    icon: "delete",
                },
                "sep1": "---------",
                "quit": {
                    name: "Quit",
                    icon: function () {
                        return 'context-menu-icon context-menu-icon-quit'
                    },
                },
            },
        })
        
        $(".selected-day").on("click", function (e) {
            //console.log("clicked", this)
        })
    }
    
    return {
        init: function (settings) {
            init(settings)
        },
    }
})()

const Season = (function () {
    "use strict"
    
    const _product_edit_season_display = document.getElementById("product_edit_season_display")
    const _edit_product_season = document.getElementById("edit_product_season")
    const _product_edit_season_form_edit_season_link = document.getElementById("product_edit_season_form_edit_season_link")
    const _product_season = document.getElementById("product_season")
    const _product_edit_season_form_season_name_filter = document.getElementById("product_edit_season_form_season_name_filter")
    const _category_id = document.getElementById("category_id")
    const _product_edit_season_form_season_color_scheme_id = document.getElementById("product_edit_season_form_season_color_scheme_id")
    const _product_edit_season_form_season_id = document.getElementById("product_edit_season_form_season_id")
    const _product_edit_season_form_season_name = document.getElementById("product_edit_season_form_season_name")
    const _product_edit_season_id_name_display = document.getElementById("product_edit_season_id_name_display")
    const _product_edit_season_form_season_enabled = document.getElementById("product_edit_season_form_season_enabled")
    const _edit_season_button = document.getElementById("edit_season_button")
    const _table_season_product_edit = document.getElementById("table_season_product_edit")
    const _button_clear_form_edit_season = document.getElementById("button_clear_form_edit_season")
    const _display_product_season_name = document.getElementById("display_product_season_name")
    const _button_submit_form_edit_season = document.getElementById("button_submit_form_edit_season")
    const _product_id = document.getElementById("product_id")
    const _panel_tab_season = document.getElementById("panel_tab_season")
    const _button_remove_season_from_product = document.getElementById("button_remove_season_from_product")
    const _calendar_loader = document.getElementById("calendar_loader")
    const _table_season_product_edit_add_new_button = document.getElementById("table_season_product_edit_add_new_button")
    const _product_edit_season_section = document.getElementById("product_edit_season_section")
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let categories = new Map()
    let $table_season_product_edit, disabledDays
    let globalSelectedSeason = false
    
    $(_table_season_product_edit_add_new_button)
        .on("click", function () {
            loadProductSeasonForm()
            _product_edit_season_form_season_name.disabled = false
            _product_edit_season_form_season_name.readonly = false
            
            ColorScheme.enable()
        })
    
    $(_button_remove_season_from_product)
        .on("click", function () {
            
            let dataToSend = {
                product_id: parseInt(_product_id.value),
                season_id: parseInt(_product_edit_season_form_season_id.value),
            }
            
            confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    removeProductSeason(dataToSend)
                }
            })
        })
    
    $(_product_edit_season_form_edit_season_link)
        .on("click", function () {
            loadEditSeasonForm()
        })
    
    $(_edit_season_button)
        .on("click", function () {
            ColorScheme.enable()
        })
    
    $(_button_clear_form_edit_season)
        .on("click", function () {
            _product_edit_season_form_season_name_filter.value = ""
            
            resetForm()
            clearProductSeasonForm()
            $table_season_product_edit.clearSelectedRows()
        })
    
    $(_button_submit_form_edit_season)
        .on("click", function () {
            let dataToSend = buildUpdateRecord()
            
            confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    saveProductSeason(dataToSend)
                }
            })
        })
    
    $(_panel_tab_season)
        .on("hide.bs.tab", function () {
            _product_edit_season_form_season_name_filter.value = ""
            resetForm()
            clearProductSeasonForm()
            if ($table_season_product_edit) {
                
                $table_season_product_edit.clearSelectedRows()
            }
        })
    
    const updateProgress = function () {
        let seasons = Array.from(Season.all.values())
        if (seasons.length === 0) {
            $(_panel_tab_season).html(`<span id="tab_span_season">Season</span> <span id="seasonNeedsAttention" class="badge rounded-pill badge-notification bg-danger">!</span>`)
        } else {
            $(_panel_tab_season).html(`<span id="tab_span_season">Season</span>`)
        }
        Product.updateProgress()
    }
    
    const saveProductSeason = function (dataToSend) {
        if (dataToSend) {
            $(_calendar_loader).fadeIn("fast", function () {
                updateProductSeason(dataToSend, function (data) {
                    if (data) {
                        let season = (data[0]) ? data[0] : data
                        //console.log("|__ season", season)
                        addProductSeasonTableRow(season)
                        buildProductOverview(season)
                    } else {
                        YearCalendar.endLoading()
                    }
                })
            })
        }
    }
    
    const updateProductSeason = function (dataToSend, callback) {
        let url = "/api/v1.0/seasons/update"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleSeasonError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const deleteProductSeason = function (dataToSend, callback) {
        let url = "/api/v1.0/seasons/remove"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleSeasonError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleSeasonError(e)
            }
        }
    }
    
    const removeProductSeason = function (dataToSend) {
        if (dataToSend) {
            $(_calendar_loader).fadeIn("fast", function () {
                deleteProductSeason(dataToSend, function (data) {
                    if (data) {
                        deleteProductSeasonTableRow(dataToSend.season_id)
                        
                    } else {
                        YearCalendar.endLoading()
                    }
                })
            })
        }
    }
    
    const handleSeasonError = function (msg) {
        toastr["error"](`${msg}`, "Season")
    }
    
    const buildUpdateRecord = function () {
        return remove_nulls({
            product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
            season_id: (!isNaN(parseInt(_product_edit_season_form_season_id.value))) ? parseInt(_product_edit_season_form_season_id.value) : null,
            disabled_dow: formatListOfIds(disabledDays.disabled_dows),
        })
    }
    
    const defaultDetail = function () {
        return {
            id: null,
            color_scheme_id: null,
            name: null,
            view_product_index: 1,
            view_product_index_filter: 1,
            view_product_index_search: 1,
            view_product_edit: 1,
            view_product_package_edit: 1,
            view_product_package_index: 1,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            category_id: null,
            color_scheme: {
                id: null,
                name: null,
                background_color: null,
                border_color: null,
                text_color: null,
                sort_order: 999,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: user_id,
                date_modified: formatDateMySQL(),
                modified_by: user_id,
                note: null,
            },
            product_season_detail: {
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                disabled_dow: null,
                enabled: 1,
                id: null,
                modified_by: user_id,
                note: null,
                product_id: null,
                season_id: null,
                seasons_background: null,
                seasons_border: null,
                seasons_text: null,
            },
        }
    }
    
    const formatSeasonType = function (season) {
        
        let detail = defaultDetail()
        
        // -----
        
        let category_id = (!isNaN(parseInt(season.category_id))) ? parseInt(season.category_id) : null
        
        //
        detail.id = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
        detail.color_scheme_id = (!isNaN(parseInt(season.color_scheme_id))) ? parseInt(season.color_scheme_id) : null
        detail.name = (season.name) ? season.name : null
        detail.view_product_index = (season.view_product_index) ? season.view_product_index : 1
        detail.view_product_index_filter = (season.view_product_index_filter) ? season.view_product_index_filter : 1
        detail.view_product_index_search = (season.view_product_index_search) ? season.view_product_index_search : 1
        detail.view_product_edit = (season.view_product_edit) ? season.view_product_edit : 1
        detail.view_product_package_edit = (season.view_product_package_edit) ? season.view_product_package_edit : 1
        detail.view_product_package_index = (season.view_product_package_index) ? season.view_product_package_index : 1
        detail.enabled = (season.enabled) ? season.enabled : 1
        detail.date_created = (season.date_created) ? season.date_created : formatDateMySQL()
        detail.created_by = (!isNaN(parseInt(season.created_by))) ? parseInt(season.created_by) : user_id
        detail.date_modified = (season.date_modified) ? season.date_modified : formatDateMySQL()
        detail.modified_by = (!isNaN(parseInt(season.modified_by))) ? parseInt(season.modified_by) : user_id
        detail.note = (season.note) ? season.note : null
        detail.category_id = (!isNaN(parseInt(season.category_id))) ? parseInt(season.category_id) : null
        detail.color_scheme.id = (!isNaN(parseInt(season.color_scheme.id))) ? parseInt(season.color_scheme.id) : null
        detail.color_scheme.name = season.color_scheme.name
        detail.color_scheme.background_color = season.color_scheme.background_color
        detail.color_scheme.border_color = season.color_scheme.border_color
        detail.color_scheme.text_color = season.color_scheme.text_color
        detail.color_scheme.sort_order = (!isNaN(parseInt(season.color_scheme.sort_order))) ? parseInt(season.color_scheme.sort_order) : 999
        detail.color_scheme.enabled = season.color_scheme.enabled
        detail.color_scheme.date_created = (season.color_scheme.date_created) ? season.color_scheme.date_created : formatDateMySQL()
        detail.color_scheme.created_by = (!isNaN(parseInt(season.color_scheme.created_by))) ? parseInt(season.color_scheme.created_by) : user_id
        detail.color_scheme.date_modified = (season.color_scheme.date_modified) ? season.color_scheme.date_modified : formatDateMySQL()
        detail.color_scheme.modified_by = (!isNaN(parseInt(season.color_scheme.modified_by))) ? parseInt(season.color_scheme.modified_by) : user_id
        detail.color_scheme.note = season.color_scheme.note
        
        if (!categories.get(category_id)) {
            categories.set(category_id, {
                seasons: [],
            })
        }
        
        let category = categories.get(category_id)
        let category_seasons = (category.seasons) ? category.seasons : []
        //console.log(categories.get(category_id).seasons)
        //console.log("category", category)
        //console.log(detail)
        return detail
    }
    
    const loadTypes = function (seasons) {
        categories = new Map()
        if (seasons) {
            
            $.each(seasons, function (i, season) {
                Season.types.set(season.id, formatSeasonType(season))
            })
        }
    }
    
    const clearProductOverview = function (season) {
        //console.log("Season.buildProductOverview(season)", season)
        let color_scheme, product_season_detail
        
        if (!season || !season.color_scheme || !season.product_season_detail) {
            //console.log("|__ season", season)
            //console.log("|__ color_scheme", season.color_scheme)
            //console.log("|__ product_season_detail", season.product_season_detail)
            return
        }
        
        color_scheme = season.color_scheme
        product_season_detail = season.product_season_detail
        
        //console.log("|__ season", season)
        //console.log("|__ color_scheme", color_scheme)
        //console.log("|__ product_season_detail", product_season_detail)
        
        let backgroundColor = (season.color_scheme && season.color_scheme.background_color) ? season.color_scheme.background_color : "#fff"
        let textColor = (season.color_scheme && season.color_scheme.text_color) ? season.color_scheme.text_color : "#0a070d"
        let borderColor = (season.color_scheme && season.color_scheme.border_color) ? season.color_scheme.border_color : "#0a070d"
        let disabledDOW = (season.product_season_detail) ? getListOfIds(season.product_season_detail.disabled_dow) : []
        let disabledDOWFormatted = []
        let disabledDOWDisplay = ""
        let name = (season.name) ? season.name : null
        let seasonId = (season.id && !isNaN(parseInt(season.id))) ? parseInt(season.id) : null
        
        if (seasonId) {
            $(`#disabledDOWDisplay${seasonId}`).remove()
        }
        
    }
    
    const buildProductOverview = function (season) {
        //console.log("Season.buildProductOverview(season)", season)
        let color_scheme, product_season_detail
        
        if (!season || !season.color_scheme || !season.product_season_detail) {
            //console.log("|__ season", season)
            //console.log("|__ color_scheme", season.color_scheme)
            //console.log("|__ product_season_detail", season.product_season_detail)
            return
        }
        
        color_scheme = season.color_scheme
        product_season_detail = season.product_season_detail
        
        //console.log("|__ season", season)
        //console.log("|__ color_scheme", color_scheme)
        //console.log("|__ product_season_detail", product_season_detail)
        
        let backgroundColor = (season.color_scheme && season.color_scheme.background_color) ? season.color_scheme.background_color : "#fff"
        let textColor = (season.color_scheme && season.color_scheme.text_color) ? season.color_scheme.text_color : "#0a070d"
        let borderColor = (season.color_scheme && season.color_scheme.border_color) ? season.color_scheme.border_color : "#0a070d"
        let disabledDOW = (season.product_season_detail) ? getListOfIds(season.product_season_detail.disabled_dow) : []
        let disabledDOWFormatted = []
        let disabledDOWDisplay = ""
        let name = (season.name) ? season.name : null
        let seasonId = (season.id && !isNaN(parseInt(season.id))) ? parseInt(season.id) : null
        
        for (let n = 0; n < disabledDOW.length; n++) {
            let day = days[n]
            if (day.short) {
                disabledDOWFormatted.push(day.short.toUpperCase())
            }
        }
        
        disabledDOWDisplay = disabledDOWFormatted.join(", ")
        backgroundColor = shadeColor(backgroundColor, 30)
        borderColor = shadeColor(borderColor, -30)
        
        if (Season.all.get(seasonId)) {
            clearProductOverview(Season.all.get(seasonId))
        }
        
        $(_product_edit_season_display).append(`
            <div class="col-12 col-sm-12 col-md-4 px-1" id="disabledDOWDisplay${seasonId}">
        
                <div class="card card-body mb-2" style="background:${backgroundColor};color:${textColor};border-color:${borderColor};">
                
                    <h5 class="card-title" style="color:${textColor};">${name}</h5>
                    <h6 class="card-subtitle">
                        <p class="m-0 mb-1" style="font-size:.85rem;font-weight:400;color:#0a070d;">Disabled Days:</p>
                        <p class="m-0 mb-1" style="font-size:.75rem;color:${borderColor};">${disabledDOWDisplay}</p>
                    </h6>
                
                </div>
            </div>
        `)
    }
    
    const loadAll = function (seasons) {
        Season.all = new Map()
        if (_table_season_product_edit) {
            buildProductEditTable()
        }
        
        if (!seasons) {
            seasons = []
        }
        
        $.each(seasons, function (k, season) {
            let detail = set(season)
            
            if (!isNaN(parseInt(detail.id))) {
                $table_season_product_edit.insertRow(detail)
                Season.all.set(parseInt(detail.id), detail)
                buildProductOverview(detail)
            }
        })
        
        updateProgress()
    }
    
    const set = function (season) {
        let detail = defaultDetail()
        if (season) {
            detail = season
        }
        return detail
    }
    
    const edit = function (season) {
        if (season) {
            if (season.id) {
                let seasonId = season.id
                //console.log("seasonId", seasonId)
                let loadedSeasonId = (!_product_edit_season_form_season_id) ? null : (!isNaN(parseInt(_product_edit_season_form_season_id.value))) ? parseInt(_product_edit_season_form_season_id.value) : null
                //console.log("loadedSeasonId", loadedSeasonId)
            }
        }
        
        clearProductSeasonForm()
        loadProductSeasonForm(season)
    }
    
    const buildProductEditTable = function () {
        $table_season_product_edit = $(_table_season_product_edit).table({
            table_type: "display_list",
            data: Season.all,
            columnDefs: [
                {
                    title: "Id",
                    targets: 0,
                    data: "id",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                }, {
                    title: "Name",
                    targets: 1,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                }, {
                    title: "Color Scheme",
                    targets: 2,
                    data: "color_scheme",
                    render: function (data, type, row, meta) {
                        let background_color = data.background_color
                        let text_color = data.text_color
                        let border_color = data.border_color
                        let name = data.name
                        return `
                            <div style="font-size:14px; line-height:1.25;padding-left:.5rem;background:${background_color};color:${text_color}; border:solid 1px ${border_color}">${name}</div>
                        `
                    },
                }, {
                    title: "Disabled DOW",
                    targets: 3,
                    data: "product_season_detail",
                    render: function (data, type, row, meta) {
                        //console.log("product_season_detail", data)
                        let disabled_days = (data.disabled_dow) ? getListOfIds(data.disabled_dow) : []
                        let d = []
                        for (let n = 0; n < disabled_days.length; n++) {
                            d.push(dow_short[disabled_days[n]])
                        }
                        
                        data = d.join(', ')
                        return `
                            <span>${data}</span>
                        `
                    },
                },
            ],
            rowClick: Season.edit,
        })
    }
    
    const deleteProductSeasonTableRow = function (season_id) {
        if (season_id) {
            let hasSeason = Season.all.get(season_id)
            
            if (hasSeason) {
                Season.all.delete(season_id)
                
                $table_season_product_edit.deleteRow(hasSeason)
                $table_season_product_edit.clearSelectedRows()
                
                _product_edit_season_form_season_name_filter.value = ""
                
                PricingWorksheet.pricingWorksheet()
                Pricing.resetForm()
                YearCalendar.refresh()
                
                updateProgress()
                resetForm()
                clearProductSeasonForm()
                clearProductOverview(hasSeason)
                
                toastr["warning"](`Season: ${hasSeason.name} - has been deleted`, "Season")
                YearCalendar.endLoading()
            }
        }
    }
    
    const addProductSeasonTableRow = function (season) {
        if (season) {
            let detail = set(season)
            let hasSeason = Season.all.get(detail.id)
            
            if (hasSeason) {
                $table_season_product_edit.updateRow(detail)
            } else {
                $table_season_product_edit.insertRow(detail)
            }
            
            Season.all.set(detail.id, detail)
            
            $table_season_product_edit.loadRow(detail)
            $table_season_product_edit.jumpToRow(detail)
            $table_season_product_edit.clearSelectedRows()
            
            _product_edit_season_form_season_name_filter.value = ""
            
            PricingWorksheet.pricingWorksheet()
            Pricing.resetForm()
            YearCalendar.refresh()
            
            updateProgress()
            resetForm()
            clearProductSeasonForm()
            
            toastr.success(`Season: ${detail.name} - has been updated`)
            YearCalendar.endLoading()
        }
    }
    
    const resetForm = function () {
        console.log("Season.resetForm()")
        // ----
        
        _product_edit_season_form_season_id.value = ""
        _product_edit_season_form_season_name.value = ""
        _product_edit_season_id_name_display.value = ""
        _product_edit_season_form_season_enabled.checked = true
        
        updateProgress()
        
        ColorScheme.load()
    }
    
    const loadEditSeasonForm = function () {
        //$(_edit_season).show()
    }
    
    const unLoadEditSeasonForm = function () {
        //$(_edit_season).hide()
    }
    
    const clearProductSeasonForm = function () {
        disabledDays.init([])
        unloadProductSeasonForm()
    }
    
    const loadProductSeasonForm = function (season) {
        let disabled_dow = []
        let name = "Details"
        if (season) {
            let color_scheme = (season.color_scheme) ? season.color_scheme : {}
            name = (season.name) ? season.name : "Detail"
            if (season.product_season_detail && season.product_season_detail.disabled_dow) {
                disabled_dow = getListOfIds(season.product_season_detail.disabled_dow)
            }
            
            ColorScheme.load(color_scheme)
            ColorScheme.disable()
            
            _product_edit_season_form_season_id.value = season.id
            _product_edit_season_form_season_name.value = season.name
            _product_edit_season_form_season_color_scheme_id.value = season.color_scheme_id
            _product_edit_season_form_season_enabled.checked = (season.enabled === 1)
            _product_edit_season_form_season_enabled.disabled = true
            _product_edit_season_form_season_name_filter.disabled = true
        }
        _product_edit_season_form_season_name_filter.disabled = true
        _display_product_season_name.innerText = name
        disabledDays.init(disabled_dow)
        $(_edit_product_season).show()
    }
    
    const unloadProductSeasonForm = function () {
        //console.log("unloadProductSeasonForm()")
        _product_edit_season_form_season_name_filter.disabled = false
        _product_edit_season_form_season_name.disabled = true
        $(_edit_product_season).hide()
    }
    
    const addSeason = function (dataToSend, callback) {
        let url = "/api/v1.0/seasons/add"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleSeasonError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleSeasonError("Error Validating Airport")
            }
        } else {
            return handleSeasonError("Error Loading Airport - Missing Data")
        }
    }
    
    const fetchByName = function (dataToSend, callback) {
        let url = "/api/v1.0/seasons/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleSeasonError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleSeasonError("Error Validating Airport")
            }
        } else {
            handleSeasonError("Error Loading Airport - Missing Data")
        }
    }
    
    const seasonExists = function (name) {
        let category_id = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        if (name && name !== "" && category_id) {
            let dataToSend = {
                name: name,
                category_id: category_id,
            }
            
            fetchByName(dataToSend, function (data) {
                let season = null
                
                if (data) {
                    season = data
                    if (data[0]) {
                        season = data[0]
                    }
                }
                
                if (season && season.id) {
                    globalSelectedSeason = true
                    let color_scheme = (season.color_scheme) ? season.color_scheme : {}
                    let product_season = Season.all.get(season.id)
                    
                    $table_season_product_edit.clearSelectedRows()
                    
                    _product_edit_season_form_season_id.value = season.id
                    _product_edit_season_form_season_name.value = season.name
                    _product_edit_season_form_season_color_scheme_id.value = season.color_scheme_id
                    _product_edit_season_form_season_enabled.checked = (season.enabled === 1)
                    
                    _product_edit_season_form_season_enabled.disabled = true
                    
                    ColorScheme.load(color_scheme)
                    ColorScheme.disable()
                    
                    if (product_season) {
                        loadProductSeasonForm(product_season)
                        $table_season_product_edit.loadRow(product_season)
                    } else {
                        loadProductSeasonForm(season)
                    }
                } else {
                    confirmDialog(`The season: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                        if (ans) {
                            addSeason(dataToSend, function (data) {
                                let season = null
                                
                                if (data) {
                                    season = data
                                    if (data[0]) {
                                        season = data[0]
                                    }
                                }
                                
                                if (season && season.id) {
                                    let color_scheme = (season.color_scheme) ? season.color_scheme : {}
                                    let product_season = Season.all.get(season.id)
                                    
                                    $table_season_product_edit.clearSelectedRows()
                                    
                                    _product_edit_season_form_season_id.value = season.id
                                    _product_edit_season_form_season_name.value = season.name
                                    _product_edit_season_form_season_color_scheme_id.value = season.color_scheme_id
                                    _product_edit_season_form_season_enabled.checked = (season.enabled === 1)
                                    
                                    _product_edit_season_form_season_enabled.disabled = true
                                    
                                    ColorScheme.load(color_scheme)
                                    ColorScheme.disable()
                                    
                                    if (product_season) {
                                        loadProductSeasonForm(product_season)
                                        $table_season_product_edit.loadRow(product_season)
                                    } else {
                                        loadProductSeasonForm(season)
                                    }
                                }
                            })
                        } else {
                            $table_season_product_edit.clearSelectedRows()
                            resetForm()
                            _product_edit_season_form_season_name_filter.value = ""
                        }
                    })
                }
            })
        }
    }
    
    const initAutoComplete = function () {
        let category_id = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        
        $(_product_edit_season_form_season_name_filter)
            .on("click", function (e) {
                if ($(this).attr("readonly") === "readonly") {
                    e.preventDefault()
                } else {
                    $(this).select()
                }
            })
            .on("search", function () {
                $table_season_product_edit.clearSelectedRows()
                resetForm()
            })
            .on("change", function () {
                setTimeout(function () {
                    if (_product_edit_season_form_season_name_filter.value === "") {
                        $table_season_product_edit.clearSelectedRows()
                        resetForm()
                    } else {
                        seasonExists(_product_edit_season_form_season_name_filter.value)
                    }
                }, 200)
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/seasons",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                params: { "category_id": category_id },
                onSelect: function (suggestion) {
                    if (!suggestion.data) {
                        return
                    }
                    let season = suggestion.data
                    let color_scheme = (season.color_scheme) ? season.color_scheme : {}
                    let product_season = Season.all.get(season.id)
                    
                    $table_season_product_edit.clearSelectedRows()
                    
                    _product_edit_season_form_season_id.value = season.id
                    _product_edit_season_form_season_name.value = season.name
                    _product_edit_season_form_season_color_scheme_id.value = season.color_scheme_id
                    _product_edit_season_form_season_enabled.checked = (season.enabled === 1)
                    
                    _product_edit_season_form_season_enabled.disabled = true
                    
                    ColorScheme.load(color_scheme)
                    ColorScheme.disable()
                    
                    if (product_season) {
                        loadProductSeasonForm(product_season)
                        $table_season_product_edit.loadRow(product_season)
                    } else {
                        loadProductSeasonForm(season)
                    }
                },
            })
    }
    
    const init = function (settings) {
        let seasons = []
        if (settings) {
            seasons = settings
            if (settings.seasons) {
                seasons = settings.seasons
            }
        }
        
        loadTypes(seasons)
        
        if (_product_edit_season_form_season_name_filter) {
            $(_product_edit_season_display).empty()
            initAutoComplete()
            resetForm()
        }
        
        if (document.getElementById("season_disabled_dow")) {
            disabledDays = $("#season_disabled_dow").DisabledDOW({
                name: "season_disabled_dow",
                label: "Disabled DOW",
            })
            
        }
        
        if (_edit_product_season) {
            unloadProductSeasonForm()
        }
        
    }
    
    return {
        types: new Map(),
        all: new Map(),
        edit: function (seasons) {
            edit(seasons)
        },
        loadTypes: function (seasons) {
            loadTypes(seasons)
        },
        init: function (settings) {
            init(settings)
        },
        loadAll: function (seasons) {
            loadAll(seasons)
        },
    }
})()

const Page = (function () {
    "use strict"
    
    const _modal_new_page = document.getElementById("modal_new_page")
    const _button_add_page_heading = document.getElementById("button_add_page_heading")
    const _table_pages_index = document.getElementById("table_pages_index")
    const _page_index_section = document.getElementById("page_index_section")
    const _modal_new_page_id = document.getElementById("modal_new_page_id")
    const _modal_new_page_menu_id = document.getElementById("modal_new_page_menu_id")
    const _modal_new_page_path = document.getElementById("modal_new_page_path")
    const _modal_new_page_title = document.getElementById("modal_new_page_title")
    const _modal_new_page_sub_title = document.getElementById("modal_new_page_sub_title")
    const _modal_new_page_heading = document.getElementById("modal_new_page_heading")
    const _modal_new_page_sub_heading = document.getElementById("modal_new_page_sub_heading")
    const _modal_new_page_description = document.getElementById("modal_new_page_description")
    const _modal_new_page_keywords = document.getElementById("modal_new_page_keywords")
    const _modal_new_page_enabled = document.getElementById("modal_new_page_enabled")
    const _modal_new_page_form = document.getElementById("modal_new_page_form")
    const _modal_new_page_save_button = document.getElementById("modal_new_page_save_button")
    const _modal_new_page_cancel_button = document.getElementById("modal_new_page_cancel_button")
    const _modal_new_page_clear_button = document.getElementById("modal_new_page_clear_button")
    
    const formRules = {
        rules: {
            modal_new_page_path: {
                required: true,
            },
        },
        messages: {
            modal_new_page_path: {
                required: "Fields Required",
            },
        },
    }
    
    let $table_pages_index, $page_keywords
    let user_id = (document.getElementById('user_id')) ? (!isNaN(parseInt(document.getElementById('user_id').value))) ? parseInt(document.getElementById('user_id').value) : 4 : 4
    let tempDetail = null
    
    $(_button_add_page_heading)
        .on("click", function () {
            //console.log("Page.button_add_page_heading.click()")
            clearNewProductForm()
            renderPageForm()
        })
    
    $(_modal_new_page_save_button)
        .on("click", function () {
            //console.log("Page.modal_new_page_save_button.click()")
            save()
        })
    
    $(_modal_new_page_cancel_button)
        .on("click", function () {
            //console.log("Page.modal_new_page_cancel_button.click()")
            clearNewProductForm()
            hidePageForm()
        })
    
    $(_modal_new_page_clear_button)
        .on("click", function () {
            //console.log("Page.modal_new_page_clear_button.click()")
            clearNewProductForm()
        })
    
    const addRow = function (page) {
        //console.log("Page.addRow(page)", page)
        $table_pages_index.insertRow(page)
    }
    
    const updateRow = function (page) {
        //console.log("Page.updateRow(page)", page)
        
        //$table_pages_index.insertRow(page)
    }
    
    const buildIndexTable = function () {
        //console.log("Page.buildIndexTable()")
        if (_table_pages_index) {
            $table_pages_index = $(_table_pages_index).table({
                table_type: "display_list",
                data: Array.from(Page.all.values()),
                columnDefs: [
                    {
                        title: "Id",
                        targets: 0,
                        data: "id",
                        render: function (data, type, row, meta) {
                            return "<span style='white-space: nowrap;'>" + data + "</span>"
                        },
                    }, {
                        title: "Title",
                        targets: 1,
                        data: "title",
                        render: function (data, type, row, meta) {
                            return "<span style='white-space: nowrap;'>" + data + "</span>"
                        },
                    }, {
                        title: "Path",
                        targets: 2,
                        data: "path",
                        render: function (data, type, row, meta) {
                            return "<span style='white-space: nowrap;'>" + data + "</span>"
                        },
                    },
                ],
                rowClick: Page.edit,
            })
        }
    }
    
    const handlePageError = function (msg, title) {
        //console.log("Page.handlePageError(msg, title) - msg", msg)
        //console.log("Page.handlePageError(msg, title) - title", title)
        if (!title) {
            title = "Error"
        }
        
        toastr["error"](msg, title)
    }
    
    const sendSaveRequest = function (dataToSend, callback) {
        //console.log("Page.sendSaveRequest(dataToSend, callback) - dataToSend -", dataToSend)
        //console.log("Page.sendSaveRequest(dataToSend, callback) - callback -", callback)
        let url = "/api/v1.0/pages/save"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handlePageError("Oops: 1", "Save Error")
                    }
                })
            } catch (e) {
                return handlePageError("Error Validating Page", "Save Error")
            }
        } else {
            return handlePageError("Error Loading Page - Missing Data", "Save Error")
        }
    }
    
    const set = function (page) {
        //console.log("Page.set(page)", page)
        let detail = defaultDetail()
        
        if (page) {
            Page.detail.id = (!isNaN(parseInt(page.id))) ? parseInt(page.id) : null
            Page.detail.menu_id = (!isNaN(parseInt(page.menu_id))) ? parseInt(page.menu_id) : null
            Page.detail.path = (page.path) ? page.path : null
            Page.detail.title = (page.title) ? page.title : null
            Page.detail.sub_title = (page.sub_title) ? page.sub_title : null
            Page.detail.heading = (page.heading) ? page.heading : null
            Page.detail.sub_heading = (page.sub_heading) ? page.sub_heading : null
            Page.detail.description = (page.description) ? page.description : null
            Page.detail.keywords = (page.keywords && page.keywords !== "") ? page.keywords.toString().replace(/,\s/g, ",").trim().split(",") : []
            Page.detail.enabled = (page.enabled && page.enabled === 1) ? 1 : 0
            Page.detail.date_created = (page.date_created) ? page.date_created : formatDateMySQL()
            Page.detail.created_by = (page.created_by) ? page.created_by : user_id
            Page.detail.date_modified = (page.date_modified) ? page.date_modified : formatDateMySQL()
            Page.detail.modified_by = (page.modified_by) ? page.modified_by : user_id
            Page.detail.note = (page.note) ? page.note : null
            
            detail.id = Page.detail.id
            detail.menu_id = Page.detail.menu_id
            detail.path = Page.detail.path
            detail.title = Page.detail.title
            detail.sub_title = Page.detail.sub_title
            detail.heading = Page.detail.heading
            detail.sub_heading = Page.detail.sub_heading
            detail.description = Page.detail.description
            detail.keywords = Page.detail.keywords
            detail.enabled = Page.detail.enabled
            detail.date_created = Page.detail.date_created
            detail.created_by = Page.detail.created_by
            detail.date_modified = Page.detail.date_modified
            detail.modified_by = Page.detail.modified_by
            detail.note = Page.detail.note
        }
        
        return detail
    }
    
    const defaultDetail = function () {
        //console.log("Page.defaultDetail(menus)")
        Page.detail.id = null
        Page.detail.menu_id = null
        Page.detail.path = null
        Page.detail.title = null
        Page.detail.sub_title = null
        Page.detail.heading = null
        Page.detail.sub_heading = null
        Page.detail.description = null
        Page.detail.keywords = []
        Page.detail.enabled = 1
        Page.detail.date_created = formatDateMySQL()
        Page.detail.created_by = user_id
        Page.detail.date_modified = formatDateMySQL()
        Page.detail.modified_by = user_id
        Page.detail.note = null
        
        return {
            id: null,
            menu_id: null,
            path: null,
            title: null,
            sub_title: null,
            heading: null,
            sub_heading: null,
            description: null,
            keywords: [],
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const buildMenuDropDown = function (menus) {
        //console.log("Page.buildMenuDropDown(menus)", menus)
        if (_modal_new_page_menu_id) {
            let selectOptions = `<option value="" disabled selected>-- Menu --</option>`
            
            $(_modal_new_page_menu_id).empty()
            
            $.each(menus, function (k, menu) {
                let id = (!isNaN(parseInt(menu.id))) ? parseInt(menu.id) : null
                let label = (menu.label) ? menu.label : null
                let subMenus = menu.sub_menus
                
                selectOptions += `<option  value="${id}">${label}</option>`
                $.each(subMenus, function (k, subMenu) {
                    let idSubMenus = (!isNaN(parseInt(subMenu.id))) ? parseInt(subMenu.id) : null
                    let labelSubMenus = (subMenu.label) ? subMenu.label : null
                    selectOptions += `<option value="${idSubMenus}">${labelSubMenus}</option>`
                })
            })
            
            $(_modal_new_page_menu_id).html(selectOptions)
        }
    }
    
    const buildPageRecord = function () {
        //console.log("Page.buildPageRecord()")
        return removeNulls({
            id: (!isNaN(parseInt(_modal_new_page_id.value))) ? parseInt(_modal_new_page_id.value) : null,
            menu_id: (!isNaN(parseInt(_modal_new_page_menu_id.value))) ? parseInt(_modal_new_page_menu_id.value) : null,
            path: (_modal_new_page_path && _modal_new_page_path.value !== "") ? _modal_new_page_path.value : null,
            title: (_modal_new_page_title && _modal_new_page_title.value !== "") ? _modal_new_page_title.value : null,
            sub_title: (_modal_new_page_sub_title && _modal_new_page_sub_title.value !== "") ? _modal_new_page_sub_title.value : null,
            heading: (_modal_new_page_heading && _modal_new_page_heading.value !== "") ? _modal_new_page_heading.value : null,
            sub_heading: (_modal_new_page_sub_heading && _modal_new_page_sub_heading.value !== "") ? _modal_new_page_sub_heading.value : null,
            description: (_modal_new_page_description && _modal_new_page_description.value !== "") ? _modal_new_page_description.value : null,
            keywords: $page_keywords.build(),
            enabled: (_modal_new_page_enabled && _modal_new_page_enabled.checked === true) ? 1 : 0,
        })
    }
    
    const validatePageForm = function () {
        //console.log("Page.validatePageForm()")
        return $(_modal_new_page_form).valid()
    }
    
    const renderPageForm = function () {
        //console.log("Page.renderPageForm()")
        if (_modal_new_page) {
            $(_modal_new_page).modal("show")
        }
    }
    
    const hidePageForm = function () {
        //console.log("Page.hidePageForm()")
        if (_modal_new_page) {
            $(_modal_new_page).modal("hide")
        }
    }
    
    const populatePageForm = function (page) {
        //console.log("Page.populatePageForm(page)", page)
        if (page) {
            let parent_menu_id, sub_menu_id
            let menu = (Page.menus.get(Page.detail.menu_id)) ? Page.menus.get(Page.detail.menu_id) : ""
            
            _modal_new_page_menu_id.value = Page.detail.menu_id
            _modal_new_page_id.value = Page.detail.id
            _modal_new_page_path.value = Page.detail.path
            _modal_new_page_title.value = Page.detail.title
            _modal_new_page_sub_title.value = Page.detail.sub_title
            _modal_new_page_heading.value = Page.detail.heading
            _modal_new_page_sub_heading.value = Page.detail.sub_heading
            _modal_new_page_description.value = Page.detail.description
            $page_keywords.set(Page.detail.keywords)
            _modal_new_page_enabled.checked = (Page.detail.enabled && Page.detail.enabled === 1)
        }
    }
    
    const clearNewProductForm = function () {
        //console.log("Page.clearNewProductForm()")
        
        _modal_new_page_id.value = ""
        _modal_new_page_menu_id.value = ""
        _modal_new_page_path.value = ""
        _modal_new_page_title.value = ""
        _modal_new_page_sub_title.value = ""
        _modal_new_page_heading.value = ""
        _modal_new_page_sub_heading.value = ""
        _modal_new_page_description.value = ""
        $page_keywords.clear()
        _modal_new_page_enabled.checked = true
    }
    
    const loadPageForm = function (page) {
        //console.log("Page.loadPageForm(page)", page)
        if (page) {
            let detail = set(page)
            
            clearNewProductForm()
            populatePageForm(detail)
            renderPageForm()
            
        }
    }
    
    const loadAll = function (pages) {
        //console.log("Page.loadAll(pages)", pages)
        Page.all = new Map()
        
        if (pages && pages.length) {
            let counter = 0
            tempDetail = null
            $.each(pages, function (k, page) {
                let detail = set(page)
                
                if (counter === 0) {tempDetail = detail}
                
                if (detail.id) {
                    Page.all.set(detail.id, detail)
                    addRow(detail)
                }
                counter++
            })
        } else {
            tempDetail = null
        }
        
        if (tempDetail !== null) {
            $table_pages_index.clearSelectedRows()
            $table_pages_index.jumpToRow(tempDetail)
        }
    }
    
    const loadAllMenus = function (menus) {
        //console.log("Page.loadAllMenus(menus)", menus)
        Page.menus = new Map()
        Page.sub_menus = new Map()
        
        if (menus && menus.length) {
            $.each(menus, function (k, menu) {
                let sub_menus = (menu.sub_menus) ? menu.sub_menus : []
                $.each(sub_menus, function (k, sub_menu) {
                    Page.menus.set(sub_menu.id, sub_menu)
                })
                Page.menus.set(menu.id, menu)
            })
        }
    }
    
    const edit = function (page) {
        //console.log("Page.edit(page)", page)
        if (page) {
            loadPageForm(page)
        }
    }
    
    const save = function () {
        //console.log("Page.save()")
        if (validatePageForm()) {
            let dataToSend = buildPageRecord()
            
            if (dataToSend) {
                confirmDialog(`Page: ${dataToSend.title} does not exist. Would you like to create it?`, (ans) => {
                    if (ans) {
                        sendSaveRequest(dataToSend, function (data) {
                            let pageDetails
                            if (data) {
                                pageDetails = data
                                if (data[0]) {
                                    pageDetails = data[0]
                                }
                                let detail = set(pageDetails)
                                
                                //console.log("    detail", detail)
                            }
                            
                        })
                    }
                })
            }
        }
    }
    
    const init = function (settings) {
        //console.log("Page.init(settings)", settings)
        if (_page_index_section) {
            buildIndexTable()
            
            if (settings) {
                if (settings.pages) {
                    loadAll(settings.pages)
                }
                
                if (settings.menus) {
                    loadAllMenus(settings.menus)
                    buildMenuDropDown(settings.menus)
                }
                
                $page_keywords = $(_modal_new_page_keywords).BuildKeyword([])
                
                initializeValidator(formRules)
                Page.validator = $(_modal_new_page_form).validate()
            }
        }
    }
    
    return {
        menus: new Map(),
        sub_menus: new Map(),
        detail: {
            id: null,
            menu_id: null,
            path: null,
            title: null,
            sub_title: null,
            heading: null,
            sub_heading: null,
            description: null,
            keywords: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        },
        all: new Map(),
        buildMenuDropDown: function () {
            buildMenuDropDown()
        },
        edit: function (page) {
            edit(page)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const PricingStrategy = (function () {
    "use strict"
    
    /**
     * Static Variable Decloration
     */
    const daysOfTheWeek = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"]
    const _product_id = document.getElementById("product_id")
    const _pricing_strategy_types_id = document.getElementById("pricing_strategy_types_id")
    const _pricing_strategy_unit_id = document.getElementById("pricing_strategy_unit_id")
    const _pricing_strategy_season_id = document.getElementById("pricing_strategy_season_id")
    const _pricing_container = document.getElementById("pricing_container")
    const panel_tab_pricing = document.getElementById("panel_tab_pricing")
    
    /**
     * Dynamic Variable Decloration
     */
    let variantCombinations = []
    let variant_id, variant_count, variant_name
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    /**
     * Element Event Handlers
     */
    $(_pricing_strategy_types_id)
        .on("change", function () {
            //variantCombinations = []
            //let pricingWorksheet = PricingWorksheet.init()
            //console.log(pricingWorksheet)
        })
    
    $(_pricing_strategy_season_id)
        .on("change", function () {
            //season_id = (!isNaN(parseInt(_pricing_strategy_season_id.value))) ? parseInt(_pricing_strategy_season_id.value) : null
            //emptyPricingMatrix()
            //buildPricingMatrix()
        })
    
    $(_pricing_strategy_unit_id)
        .on("change", function () {
            //unit_id = (!isNaN(parseInt(_pricing_strategy_unit_id.value))) ? parseInt(_pricing_strategy_unit_id.value) : null
            
        })
    
    /**
     * buildPricingMatrix
     */
    const buildPricingMatrix = function () {
        let pricingStrategyForm
        let pricingStrategyTypesId = (!isNaN(parseInt(_pricing_strategy_types_id.value))) ? parseInt(_pricing_strategy_types_id.value) : null
        let CONTAINER = $("<div/>")
        
        const tableDOW = function () {
            let tableHeadRow = $("<tr/>")
            let tableHeadRowColumn0 = $("<th/>", {
                class: "p-1",
            })
            let tableHeadRowColumn0Span = $("<span/>", {
                class: "p-1",
                html: '&nbsp;',
            })
            tableHeadRowColumn0.append(tableHeadRowColumn0Span)
            tableHeadRow.append(tableHeadRowColumn0)
            for (let n = 0; n < daysOfTheWeek.length; n++) {
                let tableHeadRowColumn = $("<th/>", {
                    class: "p-1",
                    text: `${ucwords(daysOfTheWeek[n])}`,
                })
                
                tableHeadRow.append(tableHeadRowColumn)
            }
            
            let tableHeadRowColumnSave = $("<th/>", {
                class: "p-1",
                html: '&nbsp;',
            })
            
            tableHeadRow.append(tableHeadRowColumnSave)
            return tableHeadRow
        }
        
        const closeAllToggles = function () {
            let els = document.getElementsByClassName("collapse-toggle")
            
            $.each(els, function (k, element) {
                collapseWindow(element)
            })
        }
        
        const openAllToggles = function () {
            let els = document.getElementsByClassName("collapse-toggle")
            
            $.each(els, function (k, element) {
                expandWindow(element)
            })
        }
        
        const seasonForm = function (unit, season) {
            
            const getMatrix = function (unit, season) {
                let pricingMatrix = [], seasonId, unitId, productId, matrixId
                
                const getVariantCombinations = function (depth, baseString, arrLetters) {
                    for (let i = 0; i < arrLetters.length; i++) {
                        if (depth === 1) {
                            let variantComboId = baseString + arrLetters[i]
                            
                            let combos = variantComboId.split('-').map(function (item) {
                                return parseInt(item, 10)
                            })
                            
                            combos = combos.sort().join("-")
                            
                            let hasVariantComboIndex = variantCombinations.indexOf(variantComboId)
                            if (hasVariantComboIndex < 0) {
                                variantCombinations.push(combos)
                            }
                            
                        } else {
                            let id = arrLetters[i]
                            getVariantCombinations(depth - 1, baseString + arrLetters[i] + "-", arrLetters)
                        }
                    }
                }
                
                const buildVariantListCombinations = function (unit, season) {
                    let variants = getVariantsUsed()
                    let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                    variantCombinations = []
                    
                    if (unitId) {
                        let unit = Unit.all.get(unitId)
                        if (unit) {
                            let min = (!isNaN(parseInt(unit.min_pax))) ? parseInt(unit.min_pax) : 1
                            let max = (!isNaN(parseInt(unit.max_pax))) ? parseInt(unit.max_pax) : 1
                            if (min > max) {
                                let temp = max
                                max = min
                                min = temp
                            }
                            
                            for (let n = min; n <= max; n++) {
                                getVariantCombinations(n, "", variants)
                            }
                        }
                    }
                    
                    return variantCombinations
                }
                
                const formatCombos = function (variantList) {
                    let worksheet = Array.from(variantList.values())
                    let pricingWorksheet = new Map()
                    
                    let sectionName = []
                    let myPricings = []
                    let hasWorksheet, code
                    $.each(worksheet, function (index, variantComboList) {
                        let name = variantComboList.name
                        let count = variantComboList.count
                        code = variantComboList.code
                        let pricings = variantComboList.pricings
                        hasWorksheet = pricingWorksheet.get(code)
                        
                        if (!hasWorksheet) {
                            hasWorksheet = {
                                name: null,
                                pricings: [],
                            }
                        }
                        
                        sectionName.push(count + " " + pluralize(name, count))
                        myPricings.push(pricings)
                        
                    })
                    
                    let wPricing = []
                    let pricingGroupName = sectionName.join(", ")
                    for (let m = 0; m < myPricings.length; m++) {
                        for (let n = 0; n < myPricings[m].length; n++) {
                            let priceLine = myPricings[m][n]
                            
                            let priceLineCode = priceLine.code
                            let pricing = Pricing.all.get(priceLineCode)
                            if (pricing) {
                                //console.log("pricing", pricing)
                            } else {
                                pricing = Pricing.set()
                            }
                            
                            pricing.code = priceLine.code
                            pricing.count = priceLine.count
                            pricing.name = priceLine.name
                            pricing.product_id = productId
                            pricing.season_id = seasonId
                            pricing.unit_id = unitId
                            pricing.variant_id = priceLine.variant_id
                            wPricing.push(pricing)
                        }
                    }
                    
                    let matrix = Matrix.all.get(code)
                    if (!matrix) {
                        matrix = Matrix.set()
                        matrix.code = code
                        matrix.product_id = productId
                        matrix.season_id = seasonId
                        matrix.unit_id = unitId
                    }
                    
                    pricingWorksheet.set(code, {
                        been_saved: matrix.been_saved,
                        code: matrix.code,
                        cost: matrix.cost,
                        created_by: matrix.created_by,
                        date_created: matrix.date_created,
                        date_modified: matrix.date_modified,
                        enabled: matrix.enabled,
                        has_pricing: matrix.has_pricing,
                        id: matrix.id,
                        margin: matrix.margin,
                        modified_by: matrix.modified_by,
                        note: matrix.note,
                        price: matrix.price,
                        product_id: matrix.product_id,
                        season_id: matrix.season_id,
                        unit_id: matrix.unit_id,
                        name: pricingGroupName,
                        pricings: wPricing,
                    })
                    
                    return pricingWorksheet
                }
                
                const buildPricingMatrixCombinations = function (combos, unit, season) {
                    
                    let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
                    let seasonId = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
                    let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                    let matrixCode = productId + "-" + unitId + "-" + seasonId
                    
                    $.each(combos, function (k, variantComboId) {
                        let variants = variantComboId.split("-").map(Number)
                        let variantList = new Map()
                        
                        $.each(variants, function (k, variantId) {
                            let variant = Variant.all.get(variantId)
                            let hasVariant = variantList.get(variantId)
                            
                            if (hasVariant) {
                                let variantCount = parseInt(hasVariant.count) + 1
                                let count = variantCount
                                hasVariant.count = variantCount
                                hasVariant.pricings.push({
                                    code: matrixId + "-" + variantId + "-" + count,
                                    count: count,
                                    name: variant.name + " " + count,
                                    product_id: productId,
                                    season_id: seasonId,
                                    unit_id: unitId,
                                    variant_id: parseInt(variantId),
                                    mon: null,
                                    tue: null,
                                    wed: null,
                                    thu: null,
                                    fri: null,
                                    sat: null,
                                    sun: null,
                                    monMargin: null,
                                    tueMargin: null,
                                    wedMargin: null,
                                    thuMargin: null,
                                    friMargin: null,
                                    satMargin: null,
                                    sunMargin: null,
                                    enabled: 1,
                                    date_created: formatDateMySQL(),
                                    created_by: user_id,
                                    date_modified: formatDateMySQL(),
                                    modified_by: user_id,
                                    note: null,
                                })
                                variantList.set(variantId, hasVariant)
                            } else {
                                let variantCount = 0
                                let count = variantCount + 1
                                
                                variantList.set(variantId, {
                                    count: count,
                                    name: variant.name,
                                    code: matrixCode,
                                    product_id: productId,
                                    season_id: seasonId,
                                    unit_id: unitId,
                                    cost: 0,
                                    enabled: 1,
                                    has_pricing: 0,
                                    id: null,
                                    margin: 0,
                                    price: 0,
                                    modified_by: user_id,
                                    note: null,
                                    created_by: user_id,
                                    date_created: formatDateMySQL(),
                                    date_modified: formatDateMySQL(),
                                    pricings: [
                                        {
                                            code: matrixCode + "-" + variantId + "-" + count,
                                            count: count,
                                            name: variant.name + " " + count,
                                            product_id: productId,
                                            season_id: seasonId,
                                            unit_id: unitId,
                                            matrix_id: null,
                                            variant_id: parseInt(variantId),
                                            mon: 0,
                                            tue: 0,
                                            wed: 0,
                                            thu: 0,
                                            fri: 0,
                                            sat: 0,
                                            sun: 0,
                                            monMargin: 0,
                                            tueMargin: 0,
                                            wedMargin: 0,
                                            thuMargin: 0,
                                            friMargin: 0,
                                            satMargin: 0,
                                            sunMargin: 0,
                                            enabled: 1,
                                            date_created: formatDateMySQL(),
                                            created_by: user_id,
                                            date_modified: formatDateMySQL(),
                                            modified_by: user_id,
                                            note: null,
                                        },
                                    ],
                                })
                            }
                            
                        })
                        
                        let matrixLine = formatCombos(variantList)
                        
                        pricingMatrix.push(Array.from(matrixLine.values()))
                        
                    })
                    
                    return pricingMatrix
                }
                
                let comboMatrix
                
                if (unit && season) {
                    productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
                    if (productId) {
                        unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                        seasonId = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
                        
                        if (unitId && seasonId) {
                            matrixId = productId + "-" + unitId + "-" + seasonId
                            let matrix = Matrix.all.get(matrixId)
                            comboMatrix = buildPricingMatrixCombinations(buildVariantListCombinations(unit, season), unit, season)
                            
                            let variantCombinations = buildVariantListCombinations(unit, season)
                            
                            if (!matrix) {
                                matrix = Matrix.set()
                            } else {
                                if (matrix.pricings) {
                                
                                }
                            }
                        }
                    }
                }
                
                return comboMatrix
            }
            
            const seasonWrapper = function (unit, season) {
                let seasonWrapperId
                if (season) {
                    let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                    let seasonId = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
                    if (unitId && seasonId) {
                        seasonWrapperId = "seasonForm_container_" + unitId + "_" + seasonId
                    }
                    
                    return $("<div/>", {
                        id: seasonWrapperId,
                    })
                }
                
                return null
                
            }
            
            const seasonCollapse = function (unit, season) {
                let seasonId = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
                let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                
                return $("<section/>", {
                    id: "seasonFormContainer_" + unitId + "_" + seasonId,
                })
            }
            
            const seasonHeader = function (unit, season) {
                let TR, HEADING, SPAN, A, HEADINGWRAPPER, TD, colorScheme, backgroundColor, borderColor, textColor,
                    seasonId, seasonName
                
                if (season) {
                    colorScheme = season.color_scheme
                    backgroundColor = (colorScheme.background_color) ? colorScheme.background_color : "#fff"
                    borderColor = (colorScheme.border_color) ? colorScheme.border_color : "#fff"
                    textColor = (colorScheme.text_color) ? colorScheme.text_color : "#fff"
                    seasonName = season.name
                    seasonId = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
                    
                    SPAN = $("<span/>", {
                        class: "",
                        text: seasonName,
                    })
                    
                    A = $("<a/>", {
                        href: "javascript:void(0)",
                        class: "panel_link",
                        css: {
                            "color": textColor,
                        },
                        html: "<i class='fas fa-angle-down'></i>",
                    })
                    
                    HEADING = $("<h6/>", {
                        class: "h6-responsive m-0 py-1 px-2",
                        css: {
                            "color": textColor,
                        },
                    })
                        .attr("aria-expanded", "true")
                        .attr("aria-target", "#seasonForm_container_" + unit.id + "_" + seasonId)
                        .on("click", function () {
                            let isExpanded = ($(this).attr("aria-expanded") === "true")
                            if (isExpanded) {
                                collapseWindow(this)
                            } else {
                                expandWindow(this)
                            }
                        })
                        .append(SPAN, A)
                    
                    HEADINGWRAPPER = $("<div/>", {
                        id: "seasonForm_" + unit.id + "_" + seasonId,
                        class: "p-0 collapse-toggle",
                        css: {
                            "background": backgroundColor,
                            "color": textColor,
                            "border": "solid 1px " + borderColor,
                            "cursor": "pointer",
                        },
                    })
                        .append(HEADING)
                }
                
                return HEADINGWRAPPER
            }
            
            const buildMatrixForm = function (unit, season) {
                let matrix = getMatrix(unit, season)
                let pricings = (matrix.pricings) ? Array.from(matrix.pricings.values()) : []
                
                let WRAPPER = []
                
                $.each(pricings, function (index, pricing) {
                    let matrixId = parseInt(pricing.matrix_id)
                    let TBODY = $("<tbody/>")
                        .attr("matrixid", matrixId)
                    
                    let TROW = matrixRow(pricing)
                    
                    TBODY.append(TROW)
                    WRAPPER.push(TBODY)
                })
                
                return WRAPPER
            }
            
            const matrixRow = function (pricing) {
                return $("<tr/>")
            }
            
            let TABLE = $("<table class='table table-bordered'/>")
            let TABLEHEAD = $("<thead/>")
            let SEASONHEADER = seasonHeader(unit, season)
            let SEASONBLOCK = seasonWrapper(unit, season)
            let DOWROW = tableDOW()
            
            let SEASONROW = buildMatrixForm(unit, season)
            let SEASONCOLLAPSE = seasonCollapse(unit, season)
            
            TABLEHEAD.append(DOWROW)
            TABLE.append(TABLEHEAD)
            
            $.each(SEASONROW, function (index, row) {
                TABLE.append(row)
            })
            
            SEASONBLOCK.append(TABLE)
            SEASONCOLLAPSE.append(SEASONHEADER, SEASONBLOCK)
            
            return SEASONCOLLAPSE
            
        }
        
        const unitForm = function (units) {
            let UNITFORM, MATRIXFORM, TABLEBODY
            
            const unitFormHiddenFields = function (unit) {
                
                if (unit) {
                    if (unit.id) {
                        let unitId = (unit && unit.id && !isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                        
                        return $("<div/>", {
                            class: "row",
                        })
                            .append(
                                /**
                                 * columnWrapperMatrixId
                                 */
                                $("<div/>", {
                                    class: "col-3",
                                })
                                    .append(
                                        /**
                                         * inputWrapperMatrixId
                                         */
                                        $("<div/>", {
                                            class: "form-element",
                                        })
                                            .append(
                                                $("<label>", {
                                                    class: "d-none",
                                                    for: "product_edit_matrix_id_" + unitId,
                                                    text: "product_edit_matrix_id_" + unitId,
                                                }),
                                                $("<input/>", {
                                                    type: "text",
                                                    placeholder: "product_edit_matrix_id_" + unitId,
                                                    disabled: "disabled",
                                                    name: "product_edit_matrix_id_" + unitId,
                                                    class: "form-control dev-element",
                                                    id: "product_edit_matrix_id_" + unitId,
                                                }),
                                            ),
                                    ),
                            )
                    }
                }
                
                return null
            }
            
            const unitFormBaseFields = function (unit) {
                let unitId = unit.id
                
                let columnWrapperMatrixEnabled = $("<div/>",
                    {
                        class: "col-3 d-flex align-self-end justify-content-end pb-2 mb-2",
                    })
                    .append(
                        $("<div/>", { class: "custom-control custom-switch" })
                            .append(
                                $("<div/>", { class: "form-element" })
                                    .append(
                                        $("<input/>",
                                            {
                                                type: "checkbox",
                                                name: "matrix_enabled_" + unitId,
                                                class: "custom-control-input",
                                                id: "matrix_enabled_" + unitId,
                                            },
                                        ),
                                        
                                        $("<label/>",
                                            {
                                                class: "custom-control-label p-0",
                                                for: "matrix_enabled_" + unitId,
                                                text: "Enabled:",
                                            },
                                        ),
                                    ),
                            ),
                    )
                
                let columnWrapperMatrixBaseCost = $("<div/>",
                    {
                        class: "col-3",
                    })
                    .append(
                        $("<div/>", { class: "form-element" })
                            .append(
                                $("<label>",
                                    {
                                        class: "",
                                        for: "matrix_cost_" + unitId,
                                        text: "Base Cost:",
                                    },
                                ),
                                
                                $("<input/>",
                                    {
                                        type: "text",
                                        placeholder: "Base Cost",
                                        name: "matrix_cost_" + unitId,
                                        class: "form-control",
                                        id: "matrix_cost_" + unitId,
                                    },
                                )
                                    .attr("data-type", "cost")
                                    .attr("data-form", `product_edit_matrix_form_${unitId}`)
                                    .on("keyup", function (e) {
                                        let val = $(this).val()
                                        let form = document.getElementById($(this).attr("data-form"))
                                        // ----
                                        
                                        if (form) {
                                            let inputs = document.getElementById($(this).attr("data-form")).querySelectorAll("[name='cost']")
                                            for (let i = 0; i < inputs.length; i++) {
                                                if (!inputs[i].disabled) {
                                                    inputs[i].value = val
                                                    $(inputs[i]).parent("div").find("label").addClass("active")
                                                } else {
                                                    inputs[i].value = ""
                                                    $(inputs[i]).parent("div").find("label").removeClass("active")
                                                }
                                            }
                                        }
                                    }),
                            ),
                    )
                
                let columnWrapperMatrixBaseMargin = $("<div/>",
                    {
                        class: "col-3",
                    })
                    .append(
                        $("<div/>",
                            {
                                class: "form-element",
                            })
                            .append(
                                $("<label>",
                                    {
                                        class: "",
                                        for: "matrix_margin_" + unitId,
                                        text: "Base Margin:",
                                    },
                                ),
                                
                                $("<input/>",
                                    {
                                        type: "text",
                                        placeholder: "Base Margin",
                                        name: "matrix_margin_" + unitId,
                                        class: "form-control",
                                        id: "matrix_margin_" + unitId,
                                    },
                                )
                                    .attr("data-type", "margin")
                                    .attr("data-form", `product_edit_matrix_form_${unitId}`)
                                    .on("keyup", function (e) {
                                        let val = $(this).val()
                                        let form = document.getElementById($(this).attr("data-form"))
                                        // ----
                                        
                                        if (form) {
                                            let inputs = document.getElementById($(this).attr("data-form")).querySelectorAll("[name='margin']")
                                            for (let i = 0; i < inputs.length; i++) {
                                                if (!inputs[i].disabled) {
                                                    inputs[i].value = val
                                                    $(inputs[i]).parent("div").find("label").addClass("active")
                                                } else {
                                                    inputs[i].value = ""
                                                    $(inputs[i]).parent("div").find("label").removeClass("active")
                                                }
                                            }
                                        }
                                    }),
                            ),
                    )
                
                return $("<div/>", { class: "row" })
                    .append(columnWrapperMatrixBaseCost, columnWrapperMatrixBaseMargin, columnWrapperMatrixEnabled)
            }
            
            const unitFormContainer = function (unit) {
                let TABLE = $("<div class=''/>")
                const tableBody = function (unit) {
                    let TABLEBODY = $("<div/>")
                    // ----
                    
                    $.each(Array.from(Season.all.values()), function (x, season) {
                        if (unit && season) {
                            TABLEBODY.append(seasonForm(unit, season))
                        }
                    })
                    
                    return TABLEBODY
                }
                
                TABLE.append(tableBody(unit))
                
                return TABLE
            }
            
            const unitFormButtons = function (unit) {
                
                let BUTTONROW = $("<div/>", {
                    class: "w-100 text-right w-100",
                })
                let BUTTONROWCLEAR = $("<a/>", {
                    href: "javascript:void(0);",
                    class: "btn btn-flat primary-text text-center p-1 mx-0 mb-0 waves-effect waves-light",
                    text: "Reset",
                })
                let BUTTONROWSUBMIT = $("<a/>", {
                    href: "javascript:void(0);",
                    class: "btn btn-primary btn-sm waves-effect waves-light",
                    text: "Update",
                })
                
                return BUTTONROW.append(BUTTONROWCLEAR, BUTTONROWSUBMIT)
            }
            
            const unitFormHeading = function (unit) {
                let SPAN, I, A, HEADING, HEADINGWRAPPER
                
                let headingText = "Test Heading Text"
                let unitId = null
                if (unit) {
                    unitId = unit.id
                    headingText = unit.name
                }
                
                let elementId = "unitForm_" + unitId
                
                let wrapper = $("<div/>", {
                    class: "card-header mb-2 collapse-toggle",
                    css: {
                        "cursor": "pointer",
                        "background": "initial",
                    },
                    id: elementId,
                })
                    .on("click", function () {
                        let isExpanded = ($(this).attr("aria-expanded") === "true")
                        if (isExpanded) {
                            collapseWindow(this)
                        } else {
                            expandWindow(this)
                        }
                    })
                wrapper.attr("aria-expanded", "true")
                wrapper.attr("aria-target", "#unitForm_container_" + unitId)
                
                let heading = $("<h5/>", {
                    class: "mb-0 w-100 d-flex align-items-center justify-content-between p-1",
                })
                
                SPAN = $("<span/>", {
                    text: headingText,
                })
                
                I = $("<i/>", {
                    class: "fas fa-angle-down",
                })
                
                A = $("<a />", {
                    href: "javascript:void(0);",
                    class: "panel_link",
                })
                A.attr("aria-hidden", "true")
                A.append(I)
                
                wrapper.append(heading.append(SPAN, A))
                return wrapper
            }
            
            const buildUnitFormCollapse = function (unit) {
                if (unit) {
                    let HIDDENFIELDS, BUTTONS, BASEFIELDS, UNITCONTAINER
                    let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                    HIDDENFIELDS = unitFormHiddenFields(unit)
                    BUTTONS = unitFormButtons(unit)
                    BASEFIELDS = unitFormBaseFields(unit)
                    UNITCONTAINER = unitFormContainer(unit)
                    
                    return $("<div/>",
                        {
                            id: "unitForm_container_" + unitId,
                            class: "",
                        })
                        .attr("id", "unitForm_container_" + unitId)
                        .append(HIDDENFIELDS, BASEFIELDS, UNITCONTAINER, BUTTONS)
                }
                
                return null
            }
            
            const buildUnitForm = function (unit) {
                
                let UNITFORM = $("<div/>", {
                    class: "",
                })
                
                if (unit) {
                    if (unit.id) {
                        let unitId = (unit && unit.id && !isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                        UNITFORM.attr("id", unitId)
                    }
                }
                
                if (unit) {
                    let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                    
                    let UNITHEADING = unitFormHeading(unit)
                    let UNITCOLLAPSE = buildUnitFormCollapse(unit)
                    // ----
                    if (unitId) {
                        
                        UNITFORM
                            .attr("id", "unitForm_" + unitId)
                            .append(UNITHEADING, UNITCOLLAPSE)
                    }
                    
                    return UNITFORM
                }
                
                return null
            }
            
            $.each(units, function (k, unit) {
                if (unit.id) {
                    let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
                    
                    MATRIXFORM = $("<div/>", {
                        id: "product_edit_matrix_form_" + unitId,
                        class: "",
                    })
                    
                    UNITFORM = buildUnitForm(unit)
                    MATRIXFORM.append(UNITFORM)
                    CONTAINER.append(MATRIXFORM)
                }
            })
            
            return CONTAINER
        }
        
        const matrixForm = function (units) {
            unitForm(units)
            $(_pricing_container).append(unitForm(units))
        }
        
        const buildPricingMatrix = function (units) {
            matrixForm(units)
        }
        
        if (pricingStrategyTypesId !== null) {
            switch (pricingStrategyTypesId) {
                case 1:
                    //Per Unit
                    variant_id = 0
                    variant_count = 0
                    variant_name = "Other"
                    //buildPricingMatrix(Array.from(PricingStrategy.unitSeasons.values()))
                    closeAllToggles()
                    break
                case 2:
                    //Per Person
                    //console.log("Per Person")
                    
                    //buildPricingMatrix(Array.from(PricingStrategy.unitSeasons.values()))
                    break
                case 3:
                    //Per Days
                    variant_id = 0
                    variant_count = 0
                    variant_name = "Other"
                    
                    //buildPricingMatrix(Array.from(PricingStrategy.unitSeasons.values()))
                    openAllToggles()
                    break
                default:
                    return
            }
        }
    }
    
    const updatePricingStrategyTypesId = function (pricing_strategy_types_id) {
        if (pricing_strategy_types_id) {
            pricing_strategy_types_id = (!isNaN(parseInt(_pricing_strategy_types_id.value))) ? parseInt(_pricing_strategy_types_id.value) : null
            //emptyPricingMatrix()
            //buildPricingMatrix()
        }
    }
    
    const getVariantsUsed = function () {
        let results = []
        
        let variantsUsed = findObjectByKey(Array.from(Variant.all.values()), 'used_in_pricing', 1)
        $.each(variantsUsed, function (k, variant) {
            let id = (!isNaN(parseInt(variant.id))) ? parseInt(variant.id) : null
            if (!is_null(id)) {
                results.push(id)
            }
        })
        
        return results.sort()
        
    }
    
    const collapseWindow = function (_this) {
        let targetElement = $(_this).attr("aria-target")
        let icon = $(_this).find("i")
        icon.removeClass("fa-angle-down").addClass("fa-angle-up")
        $(_this).attr("aria-expanded", "false")
        $(targetElement).slideUp()
    }
    
    const expandWindow = function (_this) {
        let icon = $(_this).find("i")
        let targetElement = $(_this).attr("aria-target")
        icon.removeClass("fa-angle-up").addClass("fa-angle-down")
        $(_this).attr("aria-expanded", "true")
        $(targetElement).slideDown()
    }
    
    const buildUnitSeasonValues = function () {
        PricingStrategy.unitSeasons = new Map()
        
        $.each(Array.from(Unit.all.values()), function (k, unit) {
            PricingStrategy.unitSeasons.set(unit.id, {
                id: unit.id,
                name: unit.name,
                seasons: Season.all,
            })
        })
    }
    
    const clearUnitSelection = function () {
        $(_pricing_strategy_unit_id).val([]).trigger("change")
    }
    
    const clearSeasonSelection = function () {
        $(_pricing_strategy_season_id).val([]).trigger("change")
    }
    
    const updatePrice = function (el) {
        let costEl = document.getElementById(el)
        let marginEl = document.getElementById(el.replace('cost', 'margin'))
        let priceEl = document.getElementById(el.replace('cost', 'price'))
        // ----
        //let cost = (!isNaN(parseInt(costEl.value))) ? parseInt(costEl.value) : 0
        //let margin = ((!isNaN(parseInt(marginEl.value))) ? parseInt(marginEl.value) : 0) / 100
        
        priceEl.value = parseInt(((!isNaN(parseInt(costEl.value))) ? parseInt(costEl.value) : 0 / 100) + (!isNaN(parseInt(costEl.value))) ? parseInt(costEl.value) : 0)
        
    }
    
    const updateStatus = function () {
        let test = 4
        if (test === 0) {
            $(panel_tab_pricing).append($("<span>", {
                class: "badge rounded-pill badge-notification bg-danger tab-badge",
                alt: "Notification",
                css: { "color": "rgb(255, 255, 255) !important" },
                text: '!',
            }))
        } else {
            $(panel_tab_pricing).find("span").remove()
        }
    }
    
    const init = function (pricing_strategies) {
    
    }
    
    return {
        all: new Map(),
        unitSeasons: new Map(),
        updateStatus: function () {
            updateStatus()
        },
        init: function (pricing_strategies) {
            init(pricing_strategies)
        },
        updatePrice: function (el) {
            updatePrice(el)
        },
        clearUnitSelection: function () {
            clearUnitSelection()
        },
        clearSeasonSelection: function () {
            clearSeasonSelection()
        },
        buildUnitSeasonValues: function () {
            buildUnitSeasonValues()
        },
    }
    
})()

document.addEventListener("DOMContentLoaded", function () {
    let panelData = document.querySelectorAll("div.panel")
    
    panelData.forEach(el => {
        const $el = $(el)
        const $panelHeading = $el.find("div.panel-heading")
        const $panelActions = $panelHeading.find("div.panel-actions.panel-actions-keep")
        const $panelLinks = $panelActions.find("a.panel-action")
        
        $.each($panelLinks, function (k, elem) {
            let dataToggle = $(elem).attr("data-toggle")
            if (dataToggle) {
                
                switch (dataToggle) {
                    case "panel-refresh":
                        //console.log("refresh")
                        break
                    case "panel-hide":
                        elem.addEventListener("click", function () {
                            let dataToOpen = $(elem).attr("data-loadonhide")
                            $(dataToOpen).show()
                            $(elem).parents("div.pre_display").find("div.pre_display_el").hide()
                        })
                        break
                    case "panel-collapse":
                        //console.log("collapse")
                        break
                    case"panel-fullscreen":
                        elem.addEventListener("click", function () {
                            if ($(elem).hasClass("fa-expand")) {
                                $(elem).removeClass("fa-expand")
                                $(elem).addClass("fa-compress")
                                $el.addClass("is-fullscreen")
                            } else if ($(elem).hasClass("fa-compress")) {
                                $(elem).removeClass("fa-compress")
                                $(elem).addClass("fa-expand")
                                $el.removeClass("is-fullscreen")
                            }
                        })
                        //console.log("fullscreen")
                        break
                    case "panel-close":
                        //console.log("close")
                        break
                    default:
                        break
                }
            }
            
        })
    })
})

$.fn.table = function (settings) {
    "use strict"
    ///////////////////////////////////////////////
    let columnDefs, data = []
    let $dTable
    let table_type = "display_list"
    let table_id = $(this).attr("id")
    ///////////////////////////////////////////////
    const _table = document.getElementById(table_id)
    if ($.fn.DataTable.isDataTable("#" + table_id)) {
        return
    }
    ///////////////////////////////////////////////
    if (settings) {
        if (settings.columnDefs) {
            columnDefs = settings.columnDefs
        }
        if (settings.table_type) {
            table_type = settings.table_type
        }
        if (settings.data) {
            data = settings.data
        }
    }
    
    ///////////////////////////////////////////////
    
    const formatTable = function () {
        let _filter = $("#" + table_id + "_wrapper .dataTables_filter")
        let _length = $("#" + table_id + "_wrapper .dataTables_length")
        let _info = $("#" + table_id + "_wrapper .dataTables_info")
        let _paginate = $("#" + table_id + "_wrapper .dataTables_paginate")
        let _wrapper = $("#" + table_id + "_wrapper")
        let _wrapper_select = $("#" + table_id + "_wrapper select")
        let _wrapper_table = $("#" + table_id).parent("div")
        // ----
        _wrapper_table
            .removeClass("col-sm-12")
            .addClass("p-0 m-0 w-100 h-100")
        _wrapper
            .find("label").each(function () {
            $(this).parent().append($(this).children())
        })
        
        _wrapper
            .find("div.row")
            .removeClass("row")
            .addClass("d-flex justify-content-between")
        
        _filter
            .find("input").each(function () {
            const $this = $(this)
            $this.attr("placeholder", "Search")
            $this.removeClass("form-control-sm")
        })
        
        _filter
            .find("label").remove()
        
        _filter
            .parent("div")
            .removeClass("col-sm-12 col-md-6")
            .addClass("w-50")
        
        _info
            .parent("div")
            .removeClass("col-sm-12 col-md-5")
            .addClass("w-50 d-flex align-content-center flex-wrap px-0")
        
        _info
            .addClass("py-0")
        
        _paginate
            .parent("div")
            .removeClass("col-sm-12 col-md-7")
            .addClass("w-50 px-0")
        
        _paginate
            .addClass("py-0")
        
        _paginate
            .find("ul.pagination")
            .addClass("mb-0")
        
        _length
            .parent("div")
            .removeClass("col-sm-12 col-md-6")
            .addClass("w-50")
        
        _length
            .find("label").each(function () {
            const $this = $(this)
            $this.addClass("mb-0 pb-0 mr-3 d-inline-block")
        })
        
        _wrapper_select
            .removeClass("custom-select custom-select-sm form-control form-control-sm")
        
        _wrapper_select
            .addClass("form-control d-inline-block")
        
        if (table_type === "display_list") {
            $("#" + table_id + ">tbody>tr").css({
                "cursor": "pointer",
            })
        }
        
    }
    
    const insertRow = function (row_data) {
        if (row_data) {
            try {
                $dTable.row.add(row_data).node().id = table_id + "_tr_" + row_data.id
                $dTable.draw(false)
                $dTable.page.jumpToData(row_data.id, 0)
                formatTable()
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const updateRow = function (row_data) {
        if (row_data) {
            try {
                let rowId = "#" + table_id + "_tr_" + row_data.id
                $dTable.row(rowId).data(row_data).draw()
                loadRow(row_data.id)
            } catch (e) {
                //console.log("error", e)
            }
        }
        
        formatTable()
    }
    
    const loadRow = function (row_data) {
        if (row_data) {
            try {
                $("#" + table_id + "_tr_" + row_data.id).addClass("selected")
                $dTable.page.jumpToData(row_data.id, 0)
            } catch (e) {
                //console.log("error", e)
            }
            
        }
    }
    
    const jumpToRow = function (row_data) {
        console.log("table:jumpToRow(row_data)", row_data)
        // ----
        
        if (row_data) {
            try {
                $dTable.page.jumpToData(row_data.id, 0)
            } catch (e) {
                console.log("error", e)
            }
            
        }
    }
    
    const deleteRow = function (row_data) {
        if (row_data) {
            try {
                let rowId = "#" + table_id + "_tr_" + row_data.id
                let rowData = row_data
                $dTable
                    .row(rowId)
                    .remove()
                    .draw()
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const clearSelectedRows = function () {
        try {
            let table = $("#" + table_id + "> tbody  > tr")
            $.each(table, function (i, row) {
                $(row).removeClass("selected")
            })
        } catch (e) {
            //console.log("clear_selected_rows", e)
        }
    }
    
    if (_table) {
        
        try {
            
            $dTable = $(this).DataTable({
                pageLength: 5,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                data: data,
                columnDefs: columnDefs,
            })
            
            if (settings.rowClick) {
                $dTable.on("click", "tr", function (event) {
                    if ($(this).find("td").hasClass("dataTables_empty")) {
                    
                    } else {
                        clearSelectedRows()
                        if (event.target.nodeName === "TH") {
                        
                        } else {
                            $(this).addClass("selected")
                            let rowData = $dTable.row(this).data()
                            settings.rowClick(rowData)
                        }
                    }
                    
                })
            }
            
            formatTable()
            
        } catch (e) {
            //console.log("error", e)
        }
        
    }
    
    return {
        insertRow: function (row_data) {
            insertRow(row_data)
        },
        clearSelectedRows: function () {
            clearSelectedRows()
        },
        deleteRow: function (row_data) {
            deleteRow(row_data)
        },
        loadRow: function (id) {
            loadRow(id)
        },
        updateRow (row_data) {
            updateRow(row_data)
        },
        jumpToRow: function (detail) {
            jumpToRow(detail)
        },
    }
    
}

$.fn.BuildKeyword = function (keywords) {
    //console.log("BuildKeyword()", $(this))
    // ----
    
    let chip_input_id, chip_container_id, chip_id, chip_disable_id,
        _chips, _input, _container, $input, $container
    let counter = 0
    let editMode = null
    let tags = new Map()
    
    if (!$(this).hasClass("keyword") || !$(this).attr("id")) {
        /*
        console.log("|__ MISSING FIELDS: class - ", $(this).hasClass("keyword"))
        console.log("|__ MISSING FIELDS: id - ", $(this).attr("id"))
        //*/
        return
    }
    
    chip_id = $(this).attr("id")
    chip_input_id = chip_id + "_search"
    chip_container_id = chip_id + "_container"
    
    /*
    console.log("|__ chip_id", chip_id)
    console.log("|__ chip_input_id", chip_input_id)
    console.log("|__ chip_container_id", chip_container_id)
    //*/
    
    _chips = document.getElementById(chip_id)
    _input = document.getElementById(chip_input_id)
    _container = document.getElementById(chip_container_id)
    
    if (!_container || !_input || !_chips) {
        //*
        console.log("|__ MISSING FIELDS: _container - ", _container)
        console.log("|__ MISSING FIELDS: _input - ", _input)
        console.log("|__ MISSING FIELDS: _chips - ", _chips)
        //*/
        return
    }
    
    $input = $(_input)
    $container = $(_container)
    
    if (!keywords) {
        keywords = []
    }
    
    if (typeof keywords === "string") {
        keywords = keywords.split(",").map(function (value) {
            return value.trim()
        })
    }
    
    (function ($) {
        $.event.special.destroyed = {
            remove: function (o) {
                if (o.handler) {
                    o.handler()
                }
            },
        }
    })(jQuery)
    
    $input
        .on("keydown", function (e) {
            console.log("|__ e.keyCode", e.keyCode)
            console.log("|__ e.which", e.which)
            
            if (e.keyCode === 13) {
                e.preventDefault()
                e.stopPropagation()
                add()
                editMode = null
            }
            
            if (e.which === 9) {
                add()
                editMode = null
            }
        })
    
    const formatTag = function (data) {
        counter += 1
        if (data) {
            let $chip = $("<div>")
            let $closeIcon = $("<i>")
            
            $closeIcon
                .addClass("close fas fa-times")
                .on("click", function (e) {
                    e.stopPropagation()
                    let $chip = $(this).parents("div.chip")
                    deleteDialog(`Would you like to delete?`, (ans) => {
                        if (ans) {
                            $id = $chip.attr("id")
                            chipDelete($chip)
                        }
                    })
                })
            
            $chip
                .addClass("chip blue lighten-4 waves-effect")
                .text(data)
                .append($closeIcon)
                .attr("id", chip_id + "_" + counter)
                .on("click", function (e) {
                    let $chip = $(this)
                    editMode = tags.get($chip.text())
                    let id = $chip.attr("id")
                    chipSelect(id)
                })
            
            return $chip
        }
    }
    
    const chipDelete = function (chip) {
        if (chip) {
            let $chip = chip
            let data = $chip.text()
            
            if (tags.get(data)) {
                $chip.remove()
                tags.delete(data)
            }
        }
    }
    
    const chipSelect = function (id) {
        /*
        if (id) {
            let $chip = $("#" + id)
            let data = $chip.text()
            let tag = tags.get(data)
            if (tag) {
                if (tag) {
                    //console.log("tag", tag)
                    $input.val(data)
                }
                
            }
        }
        //*/
    }
    
    const chipAdd = function (data) {
        let tag = tags.get(data)
        if (tag) {
            toastr.error(`A tag for ${data} already exists`)
            tags.set(data, tag)
        } else {
            if (editMode) {
            
            } else {
            
            }
            let tag = formatTag(data)
            if (tag) {
                tags.set(data, tag)
                if ($container) {
                    $container.append(tag)
                }
            }
        }
    }
    
    const init = function (keywords) {
        $.each(keywords, function (k, data) {
            if (data) {
                add(data)
            }
        })
    }
    
    const clear = function () {
        tags = new Map()
        $input.val("")
        $container.empty()
    }
    
    const add = function (data) {
        if (!data) {
            data = $input.val()
        }
        
        if (data !== "") {
            chipAdd(data)
            $input.val("")
        }
    }
    
    const set = function (values) {
        let data
        if (typeof values === "string") {
            data = (values !== "") ? values.toString().replace(/,\s/g, ",").trim().split(",") : []
        } else if (typeof values === "object") {
            data = values
        } else {
            data = []
        }
        
        if ($container) {
            $container.empty()
        }
        
        $.each(data, function (k, chip) {
            add(chip)
        })
    }
    
    const readOnly = function (val) {
        
        if (val === true) {
            _input.disabled = true
            
            $(_input).addClass("disabled")
            $(_container).addClass("disabled")
        } else {
            _input.disabled = false
            
            $(_input).removeClass("disabled")
            $(_container).removeClass("disabled")
        }
    }
    
    init(keywords)
    
    return {
        readOnly: function (val) {
            readOnly(val)
        },
        clear: function () {
            clear()
        },
        add: function (data) {
            chipAdd(data)
        },
        delete: function (data) {
            chipDelete(data)
        },
        build: function () {
            let results = []
            let t = Array.from(tags.values())
            for (let n = 0; n < t.length; n++) {
                let tag_element = t[n]
                let data = tag_element.text()
                results.push(data)
            }
            return results.join(",")
        },
        set: function (vals) {
            set(vals)
        },
        init: function () {
            init()
        },
    }
}

const InventoryProfile = (function () {
    "use strict"
    
    const _panel_tab_inventory = document.getElementById("panel_tab_inventory")
    const _table_profile_product_edit_add_new_button = document.getElementById("table_profile_product_edit_add_new_button")
    const _product_edit_profile_form_profile_transfer_sales_types_id_block = document.getElementById("product_edit_profile_form_profile_transfer_sales_types_id_block")
    const _product_edit_profile_form_profile_allot_by_id_block = document.getElementById("product_edit_profile_form_profile_allot_by_id_block")
    //const _product_edit_profile_form_profile_name_filter = document.getElementById("product_edit_profile_form_profile_name_filter")
    const _table_profile_product_edit = document.getElementById("table_profile_product_edit")
    const _product_edit_profile_form_profile_days_out_block = document.getElementById("product_edit_profile_form_profile_days_out_block")
    const _product_edit_profile_form_profile_expires_block = document.getElementById("product_edit_profile_form_profile_expires_block")
    const _product_edit_profile_form_profile_quantity_block = document.getElementById("product_edit_profile_form_profile_quantity_block")
    const _product_edit_profile_form_profile_release_amt_block = document.getElementById("product_edit_profile_form_profile_release_amt_block")
    const _product_edit_profile_form = document.getElementById("product_edit_profile_form")
    const _product_edit_profile_form_profile_id = document.getElementById('product_edit_profile_form_profile_id')
    const _product_edit_profile_form_profile_name = document.getElementById('product_edit_profile_form_profile_name')
    const _product_edit_profile_form_profile_enabled = document.getElementById('product_edit_profile_form_profile_enabled')
    const _product_edit_profile_form_profile_sales_types_id = document.getElementById('product_edit_profile_form_profile_sales_types_id')
    const _product_edit_profile_form_profile_allot_by_id = document.getElementById('product_edit_profile_form_profile_allot_by_id')
    const _product_edit_profile_form_profile_transfer_sales_types_id = document.getElementById('product_edit_profile_form_profile_transfer_sales_types_id')
    const _product_edit_profile_form_profile_days_out = document.getElementById('product_edit_profile_form_profile_days_out')
    const _product_edit_profile_form_profile_quantity = document.getElementById('product_edit_profile_form_profile_quantity')
    const _product_edit_profile_form_profile_release_amt = document.getElementById('product_edit_profile_form_profile_release_amt')
    const _product_edit_profile_form_profile_min_length_days = document.getElementById('product_edit_profile_form_profile_min_length_days')
    const _product_edit_profile_form_profile_min_duration = document.getElementById('product_edit_profile_form_profile_min_duration')
    const _product_edit_profile_form_profile_max_duration = document.getElementById('product_edit_profile_form_profile_max_duration')
    const _product_edit_profile_form_profile_equal_duration = document.getElementById('product_edit_profile_form_profile_equal_duration')
    const _product_edit_profile_form_profile_advanced_booking_min = document.getElementById('product_edit_profile_form_profile_advanced_booking_min')
    const _product_edit_profile_form_profile_advanced_booking_max = document.getElementById('product_edit_profile_form_profile_advanced_booking_max')
    const _product_edit_profile_form_profile_checkin_dow = document.getElementById('product_edit_profile_form_profile_checkin_dow')
    const _product_edit_profile_form_profile_checkout_dow = document.getElementById('product_edit_profile_form_profile_checkout_dow')
    const _product_edit_profile_form_profile_departure_dow = document.getElementById('product_edit_profile_form_profile_departure_dow')
    const _product_edit_profile_form_profile_return_dow = document.getElementById('product_edit_profile_form_profile_return_dow')
    const _product_edit_profile_form_profile_inc_days_dow = document.getElementById('product_edit_profile_form_profile_inc_days_dow')
    const _product_edit_profile_form_profile_weekday_dow = document.getElementById('product_edit_profile_form_profile_weekday_dow')
    const _product_edit_profile_form_close_button = document.getElementById('product_edit_profile_form_close_button')
    const _button_add_product_profile = document.getElementById("button_add_product_profile")
    const _product_edit_profile_form_clear_button = document.getElementById('product_edit_profile_form_clear_button')
    const _product_edit_profile_form_submit_button = document.getElementById('product_edit_profile_form_submit_button')
    const _product_id = document.getElementById("product_id")
    const _button_remove_profile_from_product = document.getElementById("button_remove_profile_from_product")
    
    let $table_profile_product_edit = $(_table_profile_product_edit)
    let user_id = (document.getElementById('user_id')) ? (!isNaN(parseInt(document.getElementById('user_id').value))) ? parseInt(document.getElementById('user_id').value) : 4 : 4
    let form_rules = {
        rules: {
            product_edit_profile_form_profile_sales_types_id: {
                required: true,
            },
            product_edit_profile_form_profile_allot_by_id: {
                required: function (element) {
                    return ($(_product_edit_profile_form_profile_sales_types_id).val() !== "" && $(_product_edit_profile_form_profile_sales_types_id).val() === 1 || $(_product_edit_profile_form_profile_sales_types_id).val() === "1")
                },
            },
            profile_expires: {
                required: function (element) {
                    return ($(_product_edit_profile_form_profile_allot_by_id).val() !== "" && $(_product_edit_profile_form_profile_allot_by_id).val() === 1 || $(_product_edit_profile_form_profile_allot_by_id).val() === "1")
                },
            },
            product_edit_profile_form_profile_days_out: {
                required: function (element) {
                    return ($(_product_edit_profile_form_profile_allot_by_id).val() !== "" && $(_product_edit_profile_form_profile_allot_by_id).val() === 2 || $(_product_edit_profile_form_profile_allot_by_id).val() === "2")
                },
                number: true,
                min: 1,
            },
            product_edit_profile_form_profile_name: {
                required: true,
            },
        },
        messages: {
            product_edit_profile_form_profile_sales_types_id: {
                required: 'Field Required',
            },
            product_edit_profile_form_profile_allot_by_id: {
                required: 'Field Required',
            },
            profile_expires: {
                required: 'Field Required',
            },
            product_edit_profile_form_profile_days_out: {
                required: 'Field Required',
            },
            product_edit_profile_form_profile_name: {
                required: 'Field Required',
            },
        },
    }
    let globalSelectedProfile = false
    let checkin_dow, checkout_dow, departure_dow, return_dow, weekday_dow, inc_days_dow
    
    $(_button_add_product_profile)
        .on("click", function () {
            //console.log("InventoryProfile.button_add_product_profile: click()", {})
            populateInventoryProfileForm()
        })
    
    $(_table_profile_product_edit_add_new_button)
        .on("click", function () {
            //console.log("InventoryProfile.table_profile_product_edit_add_new_button: click()", {})
            //_product_edit_profile_form_profile_name_filter.value = ""
            $table_profile_product_edit.clearSelectedRows()
            populateInventoryProfileForm()
        })
    
    $(_product_edit_profile_form_clear_button)
        .on("click", function () {
            $table_profile_product_edit.clearSelectedRows()
            clearInventoryProfileForm()
            //_product_edit_profile_form_profile_name_filter.value = ""
            hideForm()
        })
    
    $(_product_edit_profile_form_submit_button)
        .on("click", function () {
            //console.log("InventoryProfile.product_edit_profile_form_submit_button: click()", {})
            save()
        })
    
    $(_product_edit_profile_form_close_button)
        .on("click", function () {
            $table_profile_product_edit.clearSelectedRows()
            clearInventoryProfileForm()
            setFormElementDisplay()
            hideForm()
            //_product_edit_profile_form_profile_name_filter.value = ""
        })
    
    $(_product_edit_profile_form_profile_sales_types_id)
        .on("change", function () {
            //console.log("InventoryProfile.product_edit_profile_form_profile_sales_types_id: change()", {})
            setFormElementDisplay()
            InventoryProfile.expiration_date.value("")
            _product_edit_profile_form_profile_days_out.value = ""
            _product_edit_profile_form_profile_allot_by_id.value = ""
        })
    
    $(_product_edit_profile_form_profile_allot_by_id)
        .on("change", function () {
            setFormElementDisplay()
            InventoryProfile.expiration_date.value("")
            _product_edit_profile_form_profile_days_out.value = ""
        })
    
    $(_product_edit_profile_form_profile_transfer_sales_types_id)
        .on("change", function () {
            //console.log("InventoryProfile.product_edit_profile_form_profile_transfer_sales_types_id: change()", {})
        })
    
    $(_button_remove_profile_from_product)
        .on("click", function () {
            remove()
        })
    
    $(_panel_tab_inventory)
        .on("hide.bs.tab", function () {
            $table_profile_product_edit.clearSelectedRows()
            clearInventoryProfileForm()
            setFormElementDisplay()
            hideForm()
            //_product_edit_profile_form_profile_name_filter.value = ""
        })
    
    const updateProgress = function () {
        let profiles = Array.from(InventoryProfile.all.values())
        
        if (profiles.length === 0) {
            $(_panel_tab_inventory).html(`Inventory <span id="profileNeedsAttention" class="badge rounded-pill badge-notification bg-danger">!</span>`)
        } else {
            $(_panel_tab_inventory).html(`Inventory`)
        }
        
        Product.updateProgress()
    }
    
    const removeProductProfile = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/profiles/remove"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleProfileError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const remove = function () {
        let dataToSend = {
            product_id: parseInt(_product_id.value),
            profile_id: parseInt(_product_edit_profile_form_profile_id.value),
        }
        if (dataToSend) {
            confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    removeProductProfile(dataToSend, function (data) {
                        if (data) {
                            let detail = set(InventoryProfile.all.get(dataToSend.profile_id))
                            
                            InventoryProfile.all.delete(detail.id)
                            
                            $table_profile_product_edit.deleteRow(detail)
                            $table_profile_product_edit.clearSelectedRows()
                            
                            //_product_edit_profile_form_profile_name_filter.value = ""
                            
                            PricingWorksheet.pricingWorksheet()
                            Pricing.resetForm()
                            YearCalendar.resetForm()
                            PricingWorksheet.status()
                            //YearCalendar.refresh()
                            
                            updateProgress()
                            populateInventoryProfileForm()
                            hideForm()
                            
                            toastr.success(`InventoryProfile: ${detail.name} - has been removed`)
                            YearCalendar.endLoading()
                        }
                    })
                }
            })
        }
    }
    
    const defaultDetail = function () {
        return {
            id: null,
            allot_by_id: null,
            sales_types_id: null,
            name: null,
            quantity: null,
            expires: null,
            transfer_sales_types_id: null,
            release_amt: null,
            min_length_days: null,
            checkin_dow: [0, 1, 2, 3, 4, 5, 6],
            checkout_dow: [0, 1, 2, 3, 4, 5, 6],
            departure_dow: [0, 1, 2, 3, 4, 5, 6],
            return_dow: [0, 1, 2, 3, 4, 5, 6],
            inc_days_dow: [0, 1, 2, 3, 4, 5, 6],
            weekday_dow: [0, 1, 2, 3, 4, 5, 6],
            min_duration: null,
            max_duration: null,
            equal_duration: null,
            advanced_booking_min: null,
            advanced_booking_max: null,
            advanced_booking_date: null,
            
            days_out: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            sales_types_details: {},
            allot_by_details: {},
            tranfer_sales_type_details: {},
        }
    }
    
    const initAutoComplete = function () {
        //console.log('InventoryProfile.initAutoComplete()', InventoryProfile)
        let product_id = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
    }
    
    const nameExists = function (name) {
        //console.log("InventoryProfile.nameExists(profile_name)", name)
        if (name && name !== "") {
            /**
             * data to send to the server
             *
             * @type {{name}}
             */
            let dataToSend = {
                name: name,
                product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
            }
            
            fetchByName(dataToSend, function (data) {
                let profile = null
                
                if (data && data[0]) {
                    profile = data
                    if (data[0]) {
                        profile = data[0]
                    }
                }
                
                if (profile) {
                    let hasProfile = InventoryProfile.all.get(parseInt(profile.id))
                    let detail
                    
                    if (hasProfile) {
                        detail = set(hasProfile)
                        $table_profile_product_edit.loadRow(detail)
                        populateInventoryProfileForm(detail)
                        return
                    }
                    
                    populateInventoryProfileForm()
                    _product_edit_profile_form_profile_name.value = name
                }
            })
        }
    }
    
    const fetchByName = function (dataToSend, callback) {
        let url = "/api/v1.0/profiles/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleProfileError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleProfileError("Error Validating InventoryProfile")
            }
        } else {
            return handleProfileError("Error Loading InventoryProfile - Missing Data")
        }
    }
    
    const buildInventoryProfileTable = function () {
        //console.log("InventoryProfile.buildInventoryProfileTable()", InventoryProfile)
        $table_profile_product_edit = $(_table_profile_product_edit).table({
            table_type: "display_list",
            data: [],
            columnDefs: [
                {
                    title: "Name",
                    targets: 0,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Sales Types",
                    targets: 1,
                    data: "sales_types_details",
                    render: function (data, type, row, meta) {
                        //console.log("sales_types_details", data)
                        let name = (data.name) ? data.name : "N/A"
                        
                        return "<span style='white-space: nowrap;'>" + name + "</span>"
                    },
                },
                {
                    title: "Allot By",
                    targets: 2,
                    data: "allot_by_id",
                    render: function (data, type, row, meta) {
                        let nights = "N/A"
                        if (data === null) {
                            nights = "N/A"
                        } else {
                            nights = Types.allot_by.get(data)
                            if (nights) {
                                nights = nights.name
                            } else {
                                nights = "N/A"
                            }
                        }
                        return "<span style='white-space: nowrap;'>" + nights + "</span>"
                    },
                },
                {
                    title: "Expires",
                    targets: 3,
                    data: "expires",
                    render: function (data, type, row, meta) {
                        let expires
                        if (data === null) {
                            expires = "N/A"
                        } else {
                            let new_string = data.replace(/-|\s/g, "")
                            expires = moment(new_string).format('YYYY-MM-DD')
                        }
                        return "<span style='white-space: nowrap;'>" + expires + "</span>"
                    },
                },
                {
                    title: "Release",
                    targets: 4,
                    data: "release_amt",
                    render: function (data, type, row, meta) {
                        let expires = "N/A"
                        if (data) {
                            expires = data
                        }
                        return "<span style='white-space: nowrap;'>" + expires + "</span>"
                    },
                },
            ],
            rowClick: InventoryProfile.edit,
        })
    }
    
    const buildInventoryProfileRecord = function () {
        let isValid = validateInventoryProfileForm()
        if (isValid) {
            return remove_nulls({
                id: (!isNaN(parseInt(_product_edit_profile_form_profile_id.value))) ? parseInt(_product_edit_profile_form_profile_id.value) : null,
                name: (_product_edit_profile_form_profile_name.value !== "") ? _product_edit_profile_form_profile_name.value : null,
                product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
                sales_types_id: (!isNaN(parseInt(_product_edit_profile_form_profile_sales_types_id.value))) ? parseInt(_product_edit_profile_form_profile_sales_types_id.value) : null,
                transfer_sales_types_id: (!isNaN(parseInt(_product_edit_profile_form_profile_transfer_sales_types_id.value))) ? parseInt(_product_edit_profile_form_profile_transfer_sales_types_id.value) : null,
                allot_by_id: (!isNaN(parseInt(_product_edit_profile_form_profile_allot_by_id.value))) ? parseInt(_product_edit_profile_form_profile_allot_by_id.value) : 3,
                enabled: (_product_edit_profile_form_profile_enabled.checked === true) ? 1 : 0,
                expires: InventoryProfile.expiration_date.value(),
                advanced_booking_date: InventoryProfile.advanced_booking_date.value(),
                checkin_dow: (formatListOfIds(InventoryProfile.checkin_dow.disabled_dows) === null) ? "" : formatListOfIds(InventoryProfile.checkin_dow.disabled_dows),
                checkout_dow: (formatListOfIds(InventoryProfile.checkout_dow.disabled_dows) === "") ? "" : formatListOfIds(InventoryProfile.checkout_dow.disabled_dows),
                departure_dow: (formatListOfIds(InventoryProfile.departure_dow.disabled_dows) === "") ? "" : formatListOfIds(InventoryProfile.departure_dow.disabled_dows),
                return_dow: (formatListOfIds(InventoryProfile.return_dow.disabled_dows) === "") ? "" : formatListOfIds(InventoryProfile.return_dow.disabled_dows),
                weekday_dow: (formatListOfIds(InventoryProfile.weekday_dow.disabled_dows) === "") ? "" : formatListOfIds(InventoryProfile.weekday_dow.disabled_dows),
                inc_days_dow: (formatListOfIds(InventoryProfile.inc_days_dow.disabled_dows) === "") ? "" : formatListOfIds(InventoryProfile.inc_days_dow.disabled_dows),
                days_out: (!isNaN(parseInt(_product_edit_profile_form_profile_days_out.value))) ? parseInt(_product_edit_profile_form_profile_days_out.value) : null,
                release_amt: (!isNaN(parseInt(_product_edit_profile_form_profile_release_amt.value))) ? parseInt(_product_edit_profile_form_profile_release_amt.value) : null,
                min_length_days: (!isNaN(parseInt(_product_edit_profile_form_profile_min_length_days.value))) ? parseInt(_product_edit_profile_form_profile_min_length_days.value) : "",
                min_duration: (!isNaN(parseInt(_product_edit_profile_form_profile_min_duration.value))) ? parseInt(_product_edit_profile_form_profile_min_duration.value) : null,
                max_duration: (!isNaN(parseInt(_product_edit_profile_form_profile_max_duration.value))) ? parseInt(_product_edit_profile_form_profile_max_duration.value) : null,
                equal_duration: (!isNaN(parseInt(_product_edit_profile_form_profile_equal_duration.value))) ? parseInt(_product_edit_profile_form_profile_equal_duration.value) : null,
                advanced_booking_min: (!isNaN(parseInt(_product_edit_profile_form_profile_advanced_booking_min.value))) ? parseInt(_product_edit_profile_form_profile_advanced_booking_min.value) : null,
                advanced_booking_max: (!isNaN(parseInt(_product_edit_profile_form_profile_advanced_booking_max.value))) ? parseInt(_product_edit_profile_form_profile_advanced_booking_max.value) : null,
            })
            
        }
        
        return false
    }
    
    const loadAll = function (inventory_profiles) {
        InventoryProfile.all = new Map()
        if (!inventory_profiles) { inventory_profiles = [] }
        
        $.each(inventory_profiles, function (k, inventory_profile) {
            //console.log("InventoryProfile.loadAll - inventory_profile", inventory_profile)
            //console.log("InventoryProfile.loadAll - inventory_profile", inventory_profile, checkin_dow)
            let detail = set(inventory_profile)
            //console.log('detail', detail)
            if (!isNaN(parseInt(detail.id))) {
                if (_table_profile_product_edit) {
                    $table_profile_product_edit.insertRow(detail)
                }
                InventoryProfile.all.set(parseInt(detail.id), detail)
            }
        })
        
        Pricing.loadProfileDropdown()
        updateProgress()
    }
    
    const setFormElementDisplay = function () {
        let sales_types_id = (!isNaN(parseInt(_product_edit_profile_form_profile_sales_types_id.value))) ? parseInt(_product_edit_profile_form_profile_sales_types_id.value) : null
        
        hideAllotmentFields()
        if (sales_types_id) {
            switch (sales_types_id) {
                case 1:
                    showAllotmentFields()
                    break
                case 2:
                    break
                case 3:
                    break
                case 4:
                    break
                case 5:
                    break
                default:
                    break
            }
        }
    }
    
    const showAllotmentFields = function () {
        let allot_by_id = (!isNaN(parseInt(_product_edit_profile_form_profile_allot_by_id.value))) ? parseInt(_product_edit_profile_form_profile_allot_by_id.value) : null
        if (allot_by_id) {
            switch (allot_by_id) {
                case 1:
                    $(_product_edit_profile_form_profile_days_out_block).hide()
                    $(_product_edit_profile_form_profile_expires_block).show()
                    break
                case 2:
                    
                    $(_product_edit_profile_form_profile_days_out_block).show()
                    $(_product_edit_profile_form_profile_expires_block).hide()
                    break
                case 3:
                    
                    $(_product_edit_profile_form_profile_days_out_block).hide()
                    $(_product_edit_profile_form_profile_expires_block).hide()
                    break
                default:
                    $(_product_edit_profile_form_profile_days_out_block).hide()
                    $(_product_edit_profile_form_profile_expires_block).hide()
                    break
            }
        }
        
        $(_product_edit_profile_form_profile_transfer_sales_types_id_block).show()
        $(_product_edit_profile_form_profile_quantity_block).show()
        $(_product_edit_profile_form_profile_release_amt_block).show()
        $(_product_edit_profile_form_profile_allot_by_id_block).show()
    }
    
    const hideAllotmentFields = function () {
        $(_product_edit_profile_form_profile_days_out_block).hide()
        $(_product_edit_profile_form_profile_expires_block).hide()
        $(_product_edit_profile_form_profile_allot_by_id_block).hide()
        $(_product_edit_profile_form_profile_transfer_sales_types_id_block).hide()
        $(_product_edit_profile_form_profile_quantity_block).hide()
        $(_product_edit_profile_form_profile_release_amt_block).hide()
        $("#accordionEx").collapse("hide")
    }
    
    const hideForm = function () {
        if (_product_edit_profile_form) {
            hideAllotmentFields()
            $(_product_edit_profile_form).hide()
            //_product_edit_profile_form_profile_name_filter.disabled = false
            
            $("#accordionEx").collapse("hide")
            
            updateProgress()
        }
    }
    
    const showForm = function () {
        if (_product_edit_profile_form) {
            //_product_edit_profile_form_profile_name_filter.disabled = true
            $(_product_edit_profile_form).show()
        }
    }
    
    const resetInventoryProfileForm = function () {
        //console.log("InventoryProfile.resetInventoryProfileForm()", {})
        clearInventoryProfileForm()
        disableInventoryProfileFormFields()
    }
    
    const clearInventoryProfileForm = function () {
        disableInventoryProfileFormFields()
        _product_edit_profile_form_profile_id.value = ""
        _product_edit_profile_form_profile_name.value = ""
        _product_edit_profile_form_profile_enabled.checked = true
        _product_edit_profile_form_profile_sales_types_id.value = ""
        _product_edit_profile_form_profile_allot_by_id.value = ""
        _product_edit_profile_form_profile_transfer_sales_types_id.value = ""
        _product_edit_profile_form_profile_days_out.value = ""
        _product_edit_profile_form_profile_quantity.value = ""
        _product_edit_profile_form_profile_release_amt.value = ""
        _product_edit_profile_form_profile_min_length_days.value = ""
        _product_edit_profile_form_profile_min_duration.value = ""
        _product_edit_profile_form_profile_max_duration.value = ""
        _product_edit_profile_form_profile_equal_duration.value = ""
        _product_edit_profile_form_profile_advanced_booking_min.value = ""
        _product_edit_profile_form_profile_advanced_booking_max.value = ""
        
        InventoryProfile.checkin_dow.init([0, 1, 2, 3, 4, 5, 6])
        InventoryProfile.checkout_dow.init([0, 1, 2, 3, 4, 5, 6])
        InventoryProfile.departure_dow.init([0, 1, 2, 3, 4, 5, 6])
        InventoryProfile.return_dow.init([0, 1, 2, 3, 4, 5, 6])
        InventoryProfile.weekday_dow.init([0, 1, 2, 3, 4, 5, 6])
        InventoryProfile.inc_days_dow.init([0, 1, 2, 3, 4, 5, 6])
        
        InventoryProfile.expiration_date.value("")
        InventoryProfile.advanced_booking_date.value("")
        
        setFormElementDisplay()
    }
    
    const validateInventoryProfileForm = function () {
        let isValid = $(_product_edit_profile_form).valid()
        if (isValid) {
            let allotById = (!isNaN(parseInt(_product_edit_profile_form_profile_allot_by_id.value))) ? parseInt(_product_edit_profile_form_profile_allot_by_id.value) : 3
            if (allotById === 1) {
                let expiration_date = InventoryProfile.expiration_date.value()
                
                if (expiration_date === null || expiration_date === "") {
                    setError(document.getElementById("profile_expires"), "Field Required")
                    isValid = false
                } else {
                    clearError(document.getElementById("profile_expires"))
                }
            }
        }
        
        return isValid
    }
    
    const disableInventoryProfileFormFields = function () {
        //console.log('InventoryProfile.disableInventoryProfileFormFields()', this)
        _product_edit_profile_form_profile_name.disabled = false
    }
    
    const populateInventoryProfileForm = function (inventory_profile) {
        //console.log("InventoryProfile.populateInventoryProfileForm(inventory_profile)", inventory_profile)
        clearInventoryProfileForm()
        if (inventory_profile) {
            _product_edit_profile_form_profile_id.value = (inventory_profile.id) ? inventory_profile.id : ""
            _product_edit_profile_form_profile_name.value = (inventory_profile.name) ? inventory_profile.name : ""
            _product_edit_profile_form_profile_enabled.checked = (inventory_profile.enabled !== 0)
            _product_edit_profile_form_profile_sales_types_id.value = (inventory_profile.sales_types_id) ? inventory_profile.sales_types_id : ""
            _product_edit_profile_form_profile_allot_by_id.value = (inventory_profile.allot_by_id) ? inventory_profile.allot_by_id : ""
            _product_edit_profile_form_profile_transfer_sales_types_id.value = (inventory_profile.transfer_sales_types_id) ? inventory_profile.transfer_sales_types_id : ""
            _product_edit_profile_form_profile_days_out.value = (inventory_profile.days_out) ? inventory_profile.days_out : ""
            _product_edit_profile_form_profile_quantity.value = (inventory_profile.quantity) ? inventory_profile.quantity : ""
            _product_edit_profile_form_profile_release_amt.value = (inventory_profile.release_amt) ? inventory_profile.release_amt : ""
            _product_edit_profile_form_profile_min_length_days.value = (inventory_profile.min_length_days) ? inventory_profile.min_length_days : ""
            _product_edit_profile_form_profile_min_duration.value = (inventory_profile.min_duration) ? inventory_profile.min_duration : ""
            _product_edit_profile_form_profile_max_duration.value = (inventory_profile.max_duration) ? inventory_profile.max_duration : ""
            _product_edit_profile_form_profile_equal_duration.value = (inventory_profile.equal_duration) ? inventory_profile.equal_duration : ""
            _product_edit_profile_form_profile_advanced_booking_min.value = (inventory_profile.advanced_booking_min) ? inventory_profile.advanced_booking_min : ""
            _product_edit_profile_form_profile_advanced_booking_max.value = (inventory_profile.advanced_booking_max) ? inventory_profile.advanced_booking_max : ""
            
            InventoryProfile.checkin_dow.init((inventory_profile.checkin_dow) ? inventory_profile.checkin_dow : [0, 1, 2, 3, 4, 5, 6])
            InventoryProfile.checkout_dow.init((inventory_profile.checkout_dow) ? inventory_profile.checkout_dow : [0, 1, 2, 3, 4, 5, 6])
            InventoryProfile.departure_dow.init((inventory_profile.departure_dow) ? inventory_profile.departure_dow : [0, 1, 2, 3, 4, 5, 6])
            InventoryProfile.return_dow.init((inventory_profile.return_dow) ? inventory_profile.return_dow : [0, 1, 2, 3, 4, 5, 6])
            InventoryProfile.weekday_dow.init((inventory_profile.weekday_dow) ? inventory_profile.weekday_dow : [0, 1, 2, 3, 4, 5, 6])
            InventoryProfile.inc_days_dow.init((inventory_profile.inc_days_dow) ? inventory_profile.inc_days_dow : [0, 1, 2, 3, 4, 5, 6])
            
            InventoryProfile.expiration_date.value((inventory_profile.expires) ? inventory_profile.expires : "")
            InventoryProfile.advanced_booking_date.value((inventory_profile.advanced_booking_date) ? inventory_profile.advanced_booking_date : "")
            
        }
        
        setFormElementDisplay()
        showForm()
    }
    
    const set = function (inventory_profile) {
        //console.log("InventoryProfile.set(inventory_profile)", inventory_profile)
        
        let detail = defaultDetail()
        let sales_types_details, allot_by_details, tranfer_sales_type_details
        if (inventory_profile) {
            let checkinDOW = getListOfIds(inventory_profile.checkin_dow)
            let checkoutDOW = getListOfIds(inventory_profile.checkout_dow)
            let departureDOW = getListOfIds(inventory_profile.departure_dow)
            let returnDOW = getListOfIds(inventory_profile.return_dow)
            let inc_daysDOW = getListOfIds(inventory_profile.inc_days_dow)
            let weekdayDOW = getListOfIds(inventory_profile.weekday_dow)
            
            sales_types_details = Types.sales_types.get((!isNaN(parseInt(inventory_profile.sales_types_id))) ? parseInt(inventory_profile.sales_types_id) : null)
            allot_by_details = Types.allot_by.get((!isNaN(parseInt(inventory_profile.allot_by_id))) ? parseInt(inventory_profile.allot_by_id) : null)
            tranfer_sales_type_details = Types.sales_types.get((!isNaN(parseInt(inventory_profile.transfer_sales_types_id))) ? parseInt(inventory_profile.transfer_sales_types_id) : null)
            detail.id = (!isNaN(parseInt(inventory_profile.id))) ? parseInt(inventory_profile.id) : null
            detail.allot_by_id = (!isNaN(parseInt(inventory_profile.allot_by_id))) ? parseInt(inventory_profile.allot_by_id) : null
            detail.sales_types_id = (!isNaN(parseInt(inventory_profile.sales_types_id))) ? parseInt(inventory_profile.sales_types_id) : null
            detail.name = (inventory_profile.name) ? inventory_profile.name : null
            detail.quantity = (!isNaN(parseInt(inventory_profile.quantity))) ? parseInt(inventory_profile.quantity) : null
            detail.expires = (inventory_profile.expires) ? inventory_profile.expires : null
            detail.transfer_sales_types_id = (!isNaN(parseInt(inventory_profile.transfer_sales_types_id))) ? parseInt(inventory_profile.transfer_sales_types_id) : null
            detail.release_amt = (inventory_profile.release_amt) ? inventory_profile.release_amt : null
            detail.min_length_days = (inventory_profile.min_length_days) ? inventory_profile.min_length_days : null
            detail.min_duration = (inventory_profile.min_duration) ? inventory_profile.min_duration : null
            detail.max_duration = (inventory_profile.max_duration) ? inventory_profile.max_duration : null
            detail.equal_duration = (inventory_profile.equal_duration) ? inventory_profile.equal_duration : null
            detail.advanced_booking_min = (inventory_profile.advanced_booking_min) ? inventory_profile.advanced_booking_min : null
            detail.advanced_booking_max = (inventory_profile.advanced_booking_max) ? inventory_profile.advanced_booking_max : null
            detail.advanced_booking_date = (inventory_profile.advanced_booking_date) ? inventory_profile.advanced_booking_date : null
            
            detail.checkin_dow = checkinDOW
            detail.checkout_dow = checkoutDOW
            detail.departure_dow = departureDOW
            detail.return_dow = returnDOW
            detail.inc_days_dow = inc_daysDOW
            detail.weekday_dow = weekdayDOW
            
            detail.days_out = (inventory_profile.days_out) ? inventory_profile.days_out : null
            detail.enabled = (inventory_profile.enabled) ? inventory_profile.enabled : 1
            detail.date_created = (inventory_profile.date_created) ? inventory_profile.date_created : formatDateMySQL()
            detail.created_by = (!isNaN(parseInt(inventory_profile.created_by))) ? parseInt(inventory_profile.created_by) : user_id
            detail.date_modified = (inventory_profile.date_modified) ? inventory_profile.date_modified : formatDateMySQL()
            detail.modified_by = (!isNaN(parseInt(inventory_profile.modified_by))) ? parseInt(inventory_profile.modified_by) : user_id
            detail.note = (inventory_profile.note) ? inventory_profile.note : null
            detail.sales_types_details = sales_types_details
            detail.allot_by_details = allot_by_details
            detail.tranfer_sales_type_details = tranfer_sales_type_details
        }
        
        InventoryProfile.detail = detail
        return detail
    }
    
    const edit = function (inventory_profile) {
        if (inventory_profile) {
            $table_profile_product_edit.clearSelectedRows()
            let detail = set(inventory_profile)
            
            showForm()
            //_product_edit_profile_form_profile_name_filter.value = detail.name
            //_product_edit_profile_form_profile_name_filter.disabled = true
            $table_profile_product_edit.loadRow(detail)
            populateInventoryProfileForm(detail)
        }
    }
    
    const save = function () {
        let dataToSend = buildInventoryProfileRecord()
        if (dataToSend) {
            confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    saveProductProfile(dataToSend, function (data) {
                        if (data) {
                            
                            let detail = set((data[0]) ? data[0] : data)
                            let hasProfile = InventoryProfile.all.get(detail.id)
                            
                            if (hasProfile) {
                                $table_profile_product_edit.updateRow(detail)
                            } else {
                                $table_profile_product_edit.insertRow(detail)
                            }
                            
                            InventoryProfile.all.set(detail.id, detail)
                            
                            $table_profile_product_edit.loadRow(detail)
                            $table_profile_product_edit.jumpToRow(detail)
                            $table_profile_product_edit.clearSelectedRows()
                            
                            //_product_edit_profile_form_profile_name_filter.value = ""
                            
                            PricingWorksheet.pricingWorksheet()
                            Pricing.resetForm()
                            YearCalendar.refresh()
                            
                            updateProgress()
                            populateInventoryProfileForm()
                            hideForm()
                            
                            toastr.success(`InventoryProfile: ${detail.name} - has been updated`)
                            YearCalendar.endLoading()
                        }
                    })
                }
            })
        }
    }
    
    const handleProfileError = function (msg) {
        toastr.error(msg)
    }
    
    const saveProductProfile = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/profiles/update"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleProfileError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const initProductEdit = function (settings) {
        let inventory_profiles = []
        
        if (settings) {
            if (settings.profiles) {
                inventory_profiles = settings.profiles
            }
        }
        
        checkin_dow = $(_product_edit_profile_form_profile_checkin_dow).DisabledDOW({
            name: "checkin_dow",
            label: "Checkin DOW",
        })
        
        checkout_dow = $(_product_edit_profile_form_profile_checkout_dow).DisabledDOW({
            name: "checkout_dow",
            label: "Checkout DOW",
        })
        
        departure_dow = $(_product_edit_profile_form_profile_departure_dow).DisabledDOW({
            name: "departure_dow",
            label: "Departure DOW",
        })
        
        return_dow = $(_product_edit_profile_form_profile_return_dow).DisabledDOW({
            name: "return_dow",
            label: "Return DOW",
        })
        
        inc_days_dow = $(_product_edit_profile_form_profile_inc_days_dow).DisabledDOW({
            name: "inc_days_dow",
            label: "Included Days",
        })
        
        weekday_dow = $(_product_edit_profile_form_profile_weekday_dow).DisabledDOW({
            name: "weekday_dow",
            label: "Weekdays",
        })
        
        InventoryProfile.checkin_dow = checkin_dow
        InventoryProfile.checkout_dow = checkout_dow
        InventoryProfile.departure_dow = departure_dow
        InventoryProfile.return_dow = return_dow
        InventoryProfile.weekday_dow = weekday_dow
        InventoryProfile.inc_days_dow = inc_days_dow
        
        InventoryProfile.advanced_booking_date = $("#profile_advanced_booking_date").dateSelect({
            onStart: function () {},
        })
        
        InventoryProfile.expiration_date = $("#profile_expires").dateSelect({
            onStart: function () {},
        })
        
        //$(document).ready(function () {
        if (_table_profile_product_edit) {
            buildInventoryProfileTable()
        }
        
        if (_product_edit_profile_form) {
            validator_init(form_rules)
            
            InventoryProfile.validator = $(_product_edit_profile_form).validate()
            
            resetInventoryProfileForm()
            hideForm()
        }
        
        loadAll(inventory_profiles)
        //})
    }
    
    const init = function (settings) {
        let inventory_profiles = []
        
        if (settings) {
            if (settings.profiles) {
                inventory_profiles = settings.profiles
            }
        }
        
        checkin_dow = $(_product_edit_profile_form_profile_checkin_dow).DisabledDOW({
            name: "checkin_dow",
            label: "Checkin DOW",
        })
        
        checkout_dow = $(_product_edit_profile_form_profile_checkout_dow).DisabledDOW({
            name: "checkout_dow",
            label: "Checkout DOW",
        })
        
        departure_dow = $(_product_edit_profile_form_profile_departure_dow).DisabledDOW({
            name: "departure_dow",
            label: "Departure DOW",
        })
        
        return_dow = $(_product_edit_profile_form_profile_return_dow).DisabledDOW({
            name: "return_dow",
            label: "Return DOW",
        })
        
        inc_days_dow = $(_product_edit_profile_form_profile_inc_days_dow).DisabledDOW({
            name: "inc_days_dow",
            label: "Included Days",
        })
        
        weekday_dow = $(_product_edit_profile_form_profile_weekday_dow).DisabledDOW({
            name: "weekday_dow",
            label: "Weekdays",
        })
        
        InventoryProfile.checkin_dow = checkin_dow
        InventoryProfile.checkout_dow = checkout_dow
        InventoryProfile.departure_dow = departure_dow
        InventoryProfile.return_dow = return_dow
        InventoryProfile.weekday_dow = weekday_dow
        InventoryProfile.inc_days_dow = inc_days_dow
        
        InventoryProfile.advanced_booking_date = $("#profile_advanced_booking_date").dateSelect({
            onStart: function () {},
        })
        
        InventoryProfile.expiration_date = $("#profile_expires").dateSelect({
            onStart: function () {},
        })
        
        $(document).ready(function () {
            if (_table_profile_product_edit) {
                buildInventoryProfileTable()
            }
            
            if (_product_edit_profile_form) {
                validator_init(form_rules)
                
                InventoryProfile.validator = $(_product_edit_profile_form).validate()
                
                resetInventoryProfileForm()
                hideForm()
            }
            
            loadAll(inventory_profiles)
        })
    }
    
    return {
        validator: null,
        all: new Map(),
        detail: {},
        expiration_date: null,
        advanced_booking_date: null,
        checkin_dow: null,
        checkout_dow: null,
        departure_dow: null,
        return_dow: null,
        weekday_dow: null,
        inc_days_dow: null,
        initProductEdit: function (settings) {
            initProductEdit(settings)
        },
        init: function (settings) { init(settings) },
        initAutoComplete: function () { initAutoComplete() },
        edit: function (inventory_profile) {
            edit(inventory_profile)
        },
    }
})()

const PricingWorksheet = (function () {
    "use strict"
    
    const _product_edit_matrix_form = document.getElementById("product_edit_matrix_form")
    const daysOfTheWeek = ["sun", "mon", "tue", "wed", "thu", "fri", "sat"]
    const _product_edit_pricing_section_reset_filters = document.getElementById("product_edit_pricing_section_reset_filters")
    const _pricing_strategy_types_id = document.getElementById("pricing_strategy_types_id")
    const _product_id = document.getElementById("product_id")
    const _pricing_strategy_unit_id = document.getElementById("pricing_strategy_unit_id")
    const _pricing_strategy_season_id = document.getElementById("pricing_strategy_season_id")
    const _button_collapse_seasons = document.getElementById("button_collapse_seasons")
    const _button_collapse_units = document.getElementById("button_collapse_units")
    const _button_toggle_completed_pricings = document.getElementById("button_toggle_completed_pricings")
    const _button_toggle_completed_matrices = document.getElementById("button_toggle_completed_matrices")
    const _product_edit_pricing_section_reload_worksheet = document.getElementById("product_edit_pricing_section_reload_worksheet")
    
    let pricingsHidden, matricesHidden, unitsCollapsed, seasonsCollapsed = false
    let completed = '<span class="badge badge-pill badge-success">Completed</span>'
    let incomplete = '<span class="badge badge-pill badge-danger">Incomplete</span>'
    let seasonList, unitList, variantList = []
    let variantCombinations = []
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    $(_product_edit_pricing_section_reload_worksheet)
        .on("click", function () {
            $(_pricing_strategy_types_id).val(PricingWorksheet.pricingStrategyId).trigger("change")
        })
    
    $(_product_edit_pricing_section_reset_filters)
        .on("click", function () {
            resetFilters()
        })
    
    $(_pricing_strategy_types_id)
        .on("change", function () {
            //pricingWorksheet()
        })
    
    $(_pricing_strategy_unit_id)
        .on("change", function () {
            filterUnits()
        })
    
    $(_pricing_strategy_season_id)
        .on("change", function () {
            filterSeasons()
        })
    
    $(_product_edit_pricing_section_reset_filters)
        .on("click", function () {
            resetFilters()
        })
    
    $(_button_toggle_completed_pricings)
        .on("click", function () {
            toggleCompletedPricings()
        })
    
    $(_button_toggle_completed_matrices)
        .on("click", function () {
            toggleCompletedMatrices()
        })
    
    $(_button_collapse_seasons)
        .on("click", function () {
            toggleSeasonFilter()
        })
    
    $(_button_collapse_units)
        .on("click", function () {
            toggleUnitFilter()
        })
    
    const status = function () {
        let hasIssues = false
        let status = "complete"
        let incompletePricings = Array.from(PricingWorksheet.incompletePricings.values())
        let incompleteMatrices = Array.from(PricingWorksheet.incompleteMatrices.values())
        
        if (incompletePricings.length > 0 || incompleteMatrices.length > 0) {
            hasIssues = true
        }
        
        $("<span>", {
            class: "badge rounded-pill badge-notification bg-danger tab-badge",
            alt: "Notification",
            css: { "color": "rgb(255, 255, 255) !important" },
            text: '!',
        })
        if (hasIssues === true) {
            status = "incomplete"
            $("#panel_tab_pricing")
                .html("Pricing<span class='badge rounded-pill badge-notification bg-danger tab-badge' style='color:#fff!important'>!</span>")
        } else {
            status = "complete"
            $("#panel_tab_pricing")
                .html("Pricing")
        }
        
        return status
    }
    
    const isDisabled = function (day, season_id) {
        let season, dow
        let dowIndex = -1
        let disabled_dow = []
        let product_season_detail = {}
        
        if (season_id && day) {
            season = Season.all.get(season_id)
            if (season) {
                product_season_detail = (season.product_season_detail) ? season.product_season_detail : {}
                disabled_dow = getListOfIds(product_season_detail.disabled_dow.trim())
                dow = daysOfTheWeek.indexOf(day)
                dowIndex = disabled_dow.indexOf(dow)
            }
        }
        
        return dowIndex >= 0
    }
    
    const tableDOW = function (pricing) {
        let DOWHEADINGROW = $("<tr/>")
        let DOWHEADINGACTIONCOLUMN = $("<th/>", {
            html: "&nbsp;",
        })
        
        let DOWHEADINGTITLECOLUMN = $("<th/>", {
            css: { "width": "120px" },
        })
        DOWHEADINGROW.attr("data-dowrow", "true")
        DOWHEADINGROW.append(DOWHEADINGTITLECOLUMN)
        
        if (pricing) {
            let beenSaved = false
            let matrix = Matrix.all.get(pricing.pricing_code)
            if (matrix) {
                beenSaved = !!(matrix.been_saved && matrix.been_saved === 1)
            }
            
            for (let n = 0; n < daysOfTheWeek.length; n++) {
                let disabled = ""
                let headingText = ucwords(daysOfTheWeek[n])
                let disabledDay = isDisabled(n, pricing.season_id)
                if (disabledDay) {
                    disabled = "disabled"
                    headingText = ucwords(daysOfTheWeek[n]) + " (disabled)"
                }
                
                let tableHeadRowColumn = $("<th/>", {
                    class: "" + disabled,
                    text: headingText,
                })
                
                DOWHEADINGROW.append(tableHeadRowColumn)
            }
            DOWHEADINGROW.append(DOWHEADINGACTIONCOLUMN)
        }
        
        return DOWHEADINGROW
    }
    
    const buildSeasonWrapper = function (season, matrixId, count) {
        return $("<div/>", {
            class: "accordion md-accordion",
            id: "accordionEx" + matrixId + "-" + count,
            role: "tablist",
            "aria-multiselectable": "true",
        })
            .attr("data-sectiontype", "season-" + season.season_id)
    }
    
    const buildUnitWrapper = function (unit, count) {
        let id = unit.id + "-" + count
        return $("<div/>", {
            class: "accordion md-accordion card card-body p-1 mb-2",
            id: "accordionUnit-" + id,
            role: "tablist",
            "aria-multiselectable": "true",
            
        })
            .attr("data-sectiontype", "unit-" + unit.id)
    }
    
    const buildPricingButtonRow = function (pricing) {
        let matrixCode = pricing.matrix_code
        
        let ROW = $("<div/>", {
            class: "row",
            //css: { "border-top": "solid 1px #dee2e6" },
        })
        
        let COL_6_1 = $("<div/>", {
            class: "col-12 col-md-6 mb-2 text-left",
        })
        
        let COL_6_2 = $("<div/>", {
            class: "col-12 col-md-6 mb-2 text-right",
        })
        
        let UPDATEBUTTON = $("<button/>", {
            class: "btn btn-primary btn-sm submit-pricing-matrix-form waves-effect waves-light",
            text: "Update",
            type: "button",
            id: "submitPricingMatrixForm-" + matrixCode,
            attr: { "data-targetform": "pricingMatrixForm-" + matrixCode },
        })
            .on("click", function () {
                updateMatrix(this)
            })
        
        COL_6_2.append(UPDATEBUTTON)
        
        return ROW.append(COL_6_1, COL_6_2)
    }
    
    const toggleCompletedMatrices = function (toggle) {
        let showElements = true
        if (toggle) {
            showElements = toggle
        }
        
        if (!$(_button_toggle_completed_matrices).attr("data-shown")) {
            $(_button_toggle_completed_matrices).attr("data-shown", (showElements === true) ? "true" : "false")
        }
        
        if ($(_button_toggle_completed_matrices).attr("data-shown") === "false") {
            $(_button_toggle_completed_matrices).attr("data-shown", "true")
            $(_button_toggle_completed_matrices).text("Hide Completed Matrices")
            showElements = true
        } else {
            $(_button_toggle_completed_matrices).attr("data-shown", "false")
            $(_button_toggle_completed_matrices).text("Show Completed Matrices")
            showElements = false
        }
        
        if (showElements) {
            $("[data-matrixcomplete='true']").show()
            matricesHidden = false
        } else {
            matricesHidden = true
            $("[data-matrixcomplete='true']").hide()
        }
        
    }
    
    const toggleCompletedPricings = function () {
        let showElements = true
        
        if (!$(_button_toggle_completed_pricings).attr("data-shown")) {
            $(_button_toggle_completed_pricings).attr("data-shown", (showElements === true) ? "true" : "false")
        }
        
        if ($(_button_toggle_completed_pricings).attr("data-shown") === "false") {
            $(_button_toggle_completed_pricings).attr("data-shown", "true")
            $(_button_toggle_completed_pricings).text("Hide Completed Pricings")
            showElements = true
        } else {
            $(_button_toggle_completed_pricings).attr("data-shown", "false")
            $(_button_toggle_completed_pricings).text("Show Completed Pricings")
            showElements = false
        }
        
        if (showElements) {
            $("[data-pricingcomplete='true']").show()
            pricingsHidden = false
        } else {
            $("[data-pricingcomplete='true']").hide()
            pricingsHidden = true
        }
        
    }
    
    const toggleUnitFilter = function () {
        let elements = document.querySelectorAll(`[data-type='unit']`)
        let showElements
        
        if (!$(_button_collapse_units).attr("data-shown")) {
            $(_button_collapse_units).attr("data-shown", "true")
            showElements = true
        }
        
        if ($(_button_collapse_units).attr("data-shown") === "false") {
            $(_button_collapse_units).attr("data-shown", "true")
            $(_button_collapse_units).text("Collapse Units")
            showElements = true
        } else {
            $(_button_collapse_units).attr("data-shown", "false")
            $(_button_collapse_units).text("Expand Units")
            showElements = false
        }
        
        for (let i = 0; i < elements.length; i++) {
            let element = elements[i]
            let id = $(element).attr("id")
            $("#" + id).collapse((showElements === true) ? "show" : "hide")
            unitsCollapsed = (showElements === true)
            //pricingsHidden, matricesHidden, unitsCollapsed, seasonsCollapsed = false
        }
    }
    
    const toggleSeasonFilter = function () {
        let elements = document.querySelectorAll(`[data-type='season']`)
        let showElements = true
        
        if (!$(_button_collapse_seasons).attr("data-shown")) {
            $(_button_collapse_seasons).attr("data-shown", "true")
        }
        
        if ($(_button_collapse_seasons).attr("data-shown") === "false") {
            $(_button_collapse_seasons).attr("data-shown", "true")
            $(_button_collapse_seasons).text("Collapse Seasons")
            showElements = true
        } else {
            $(_button_collapse_seasons).attr("data-shown", "false")
            $(_button_collapse_seasons).text("Expand Seasons")
            showElements = false
        }
        
        for (let i = 0; i < elements.length; i++) {
            let element = elements[i]
            let id = $(element).attr("id")
            $("#" + id).collapse((showElements === true) ? "show" : "hide")
            seasonsCollapsed = (showElements === true)
        }
    }
    
    const filtersReset = function (callback) {
        $("[data-matrixcomplete='true']").show()
        $(_button_toggle_completed_matrices).attr("data-shown", "true")
        $(_button_toggle_completed_matrices).text("Hide Completed Matrices")
        
        $("[data-pricingcomplete='true']").show()
        $(_button_toggle_completed_pricings).attr("data-shown", "true")
        $(_button_toggle_completed_pricings).text("Hide Completed Pricings")
        
        $(_pricing_strategy_season_id).val([]).trigger("change")
        $(_pricing_strategy_unit_id).val([]).trigger("change")
        
        $(_button_collapse_units).attr("data-shown", "false")
        $(_button_collapse_units).text("Expand Units")
        toggleUnitFilter()
        
        $(_button_collapse_seasons).attr("data-shown", "false")
        $(_button_collapse_seasons).text("Expand Seasons")
        toggleSeasonFilter()
        
        return callback(1)
    }
    
    const resetFilters = function () {
        $(_product_edit_pricing_section_reset_filters)
            .html("<span class='spinner-border spinner-border-sm' role='status' aria-hidden='true'></span> Loading...")
        filtersReset(function (data) {
            if (data) {
                $(_product_edit_pricing_section_reset_filters).html("Reset Filters")
            }
        })
    }
    
    const showAllFilterUnits = function () {
        let units = Array.from(Unit.all.values())
        $.each(units, function (i, unit) {
            let unitId = unit.id
            let dataVal = "unit-" + unitId
            let elements = document.querySelectorAll(`[data-sectiontype='${dataVal}']`)
            $.each(elements, function (i, el) {
                $(el).show()
            })
        })
    }
    
    const hideAllFilterUnits = function () {
        let units = Array.from(Unit.all.values())
        $.each(units, function (i, unit) {
            let unitId = unit.id
            let dataVal = "unit-" + unitId
            let elements = document.querySelectorAll(`[data-sectiontype='${dataVal}']`)
            $.each(elements, function (i, el) {
                $(el).hide()
            })
        })
    }
    
    const showAllFilterSeasons = function () {
        let seasons = Array.from(Season.all.values())
        $.each(seasons, function (i, season) {
            let seasonId = season.id
            let dataVal = "season-" + seasonId
            let elements = document.querySelectorAll(`[data-sectiontype='${dataVal}']`)
            $.each(elements, function (i, el) {
                $(el).show()
            })
        })
    }
    
    const hideAllFilterSeasons = function () {
        let seasons = Array.from(Season.all.values())
        $.each(seasons, function (i, season) {
            let seasonId = season.id
            let dataVal = "season-" + seasonId
            let elements = document.querySelectorAll(`[data-sectiontype='${dataVal}']`)
            $.each(elements, function (i, el) {
                $(el).hide()
            })
        })
    }
    
    const filterUnits = function () {
        hideAllFilterUnits()
        let unitIds = getListOfIds($(_pricing_strategy_unit_id).val())
        if (unitIds.length) {
            $.each(unitIds, function (i, unitId) {
                let dataVal = "unit-" + unitId
                let units = document.querySelectorAll(`[data-sectiontype='${dataVal}']`)
                $.each(units, function (i, el) {
                    $(el).show()
                })
            })
        } else {
            showAllFilterUnits()
        }
        
    }
    
    const filterSeasons = function () {
        hideAllFilterSeasons()
        let seasonIds = getListOfIds($(_pricing_strategy_season_id).val())
        if (seasonIds.length) {
            $.each(seasonIds, function (i, seasonId) {
                let dataVal = "season-" + seasonId
                let units = document.querySelectorAll(`[data-sectiontype='${dataVal}']`)
                $.each(units, function (i, el) {
                    $(el).show()
                })
            })
        } else {
            showAllFilterSeasons()
        }
        
    }
    
    const emptyPricingMatrix = function () {
        PricingWorksheet.incompletePricings = new Map()
        PricingWorksheet.incompleteMatrices = new Map()
        $(_product_edit_matrix_form).empty()
        $(_product_edit_matrix_form).html(`
                <div style="top:0;left:0;width:100%;height:500px;background:rgba(0,0,0,.25);" class="flex-center">
                    <div class="preloader-wrapper active">
                        <div class="spinner-layer spinner-blue-only">
                            <div class="circle-clipper left">
                                <div class="circle"></div>
                            </div>
                            <div class="gap-patch">
                                <div class="circle"></div>
                            </div>
                            <div class="circle-clipper right">
                                <div class="circle"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `)
    }
    
    const buildTableVariantHeadingBaseInputs = function (pricing) {
        let CONTAINER = $("<div/>", {
            class: "p-2",
        })
        let ROW = $("<div/>", {
            class: "row",
        })
        
        if (pricing) {
            let matrixCode = pricing.matrix_code
            let matrix = Matrix.all.get(matrixCode)
            let matrixId = ""
            let matrixName = (pricing.name) ? pricing.name : ""
            let beenSaved = false
            let cost, margin = null
            
            if (matrix) {
                matrixId = (matrix.id) ? matrix.id : null
                margin = (matrix.margin) ? matrix.margin : null
                cost = (matrix.cost) ? matrix.cost : null
                beenSaved = (pricing.been_saved === 1)
            }
            
            let COL_3_1 = $("<div/>", {
                class: "col-12 col-md-3 mb-2 px-4",
            })
            
            let COL_3_2 = $("<div/>", {
                class: "col-12 col-md-3 mb-2 px-4",
            })
            
            let COL_3_3 = $("<div/>", {
                class: "col-12 col-md-3 mb-2 px-4",
            })
            
            let COL_3_4 = $("<div/>", {
                class: "col-12 col-md-3 mb-2 px-4",
            })
            
            let LABELCOST = $("<label/>", {
                class: "",
                for: "base_cost_" + matrixCode,
                text: "Cost",
            })
            
            let LABELMARGIN = $("<label/>", {
                class: "",
                for: "base_margin_" + matrixCode,
                text: "Margin",
            })
            
            let LABELMATRIXID = $("<label/>", {
                class: "dev-element d-none",
                for: "base_matrix_id_" + matrixCode,
                text: "Matrix Id:",
            })
            
            let WRAPPERMATRIXNAME = $("<div/>", {
                class: "form-element",
            })
            
            let LABELMATRIXNAME = $("<label/>", {
                class: "dev-element d-none",
                for: "base_matrix_name_" + matrixCode,
                text: "Matrix Name:",
            })
            
            let INPUTMATRIXNAME = $("<input/>", {
                class: "form-control dev-element",
                type: "hidden",
                name: "baseMatrixName",
                readonly: "readonly",
                disabled: "disabled",
                id: "base_matrix_name_" + matrixCode,
            })
                .val(matrixName)
            
            let INPUTMATRIXID = $("<input/>", {
                class: "form-control dev-element",
                type: "hidden",
                name: "baseMatrixId",
                readonly: "readonly",
                disabled: "disabled",
                id: "base_matrix_id_" + matrixCode,
            })
                .val(matrixId)
            
            let INPUTCOST = $("<input/>", {
                class: "form-control",
                id: "base_cost_" + matrixCode,
                name: "baseCost",
                attr: {
                    "data-targetform": "pricingMatrixForm-" + matrixCode,
                },
            })
                .on("keyup", function () {
                    let form = document.getElementById($(this).attr("data-targetform"))
                    let val = this.value
                    let costInputs = form.querySelectorAll(".cost")
                    costInputs.forEach(el => {
                        if (!el.disabled) {
                            $(el).val(this.value)
                            if (this.value !== "") {
                                $(el).parent("div").find("label").addClass("active")
                            } else {
                                $(el).parent("div").find("label").removeClass("active")
                            }
                        }
                    })
                })
                .on("click", function () {
                    $(this).select()
                })
                .val(cost)
            
            let INPUTMARGIN = $("<input/>", {
                class: "form-control",
                id: "base_margin_" + matrixCode,
                name: "baseMargin",
                attr: {
                    "data-targetform": "pricingMatrixForm-" + matrixCode,
                },
            })
                .on("keyup", function () {
                    let form = document.getElementById($(this).attr("data-targetform"))
                    let costInputs = form.querySelectorAll(".margin")
                    costInputs.forEach(el => {
                        if (!el.disabled) {
                            $(el).val(this.value)
                            if (this.value !== "") {
                                $(el).parent("div").find("label").addClass("active")
                            } else {
                                $(el).parent("div").find("label").removeClass("active")
                            }
                        }
                    })
                })
                .on("click", function () {
                    $(this).select()
                })
                .val(margin)
            
            let WRAPPERCOST = $("<div/>", {
                class: "form-element",
            })
            
            let WRAPPERMATRIXID = $("<div/>", {
                class: "form-element",
            })
            
            let WRAPPERMATRIXCODE = $("<div/>", {
                class: "form-element",
            })
            
            let LABELMATRIXCODE = $("<label/>", {
                class: "dev-element d-none",
                for: "base_matrix_code_" + matrixCode,
                text: "Matrix Code:",
            })
            
            let INPUTMATRIXCODE = $("<input/>", {
                class: "form-control dev-element",
                type: "hidden",
                name: "baseMatrixCode",
                readonly: "readonly",
                disabled: "disabled",
                id: "base_matrix_code_" + matrixCode,
            })
                .val(matrixCode)
            
            let WRAPPERMARGIN = $("<div/>", {
                class: "form-element",
            })
            
            let ERRORCOST = $("<div/>", {
                class: "error w-100 text-center",
            })
            
            let ERRORMARGIN = $("<div/>", {
                class: "error w-100 text-center",
            })
            
            WRAPPERMATRIXID.append(LABELMATRIXID, INPUTMATRIXID)
            WRAPPERCOST.append(LABELCOST, INPUTCOST, ERRORCOST)
            WRAPPERMARGIN.append(LABELMARGIN, INPUTMARGIN, ERRORMARGIN)
            WRAPPERMATRIXCODE.append(LABELMATRIXCODE, INPUTMATRIXCODE)
            WRAPPERMATRIXNAME.append(LABELMATRIXNAME, INPUTMATRIXNAME)
            
            COL_3_1.append(WRAPPERCOST)
            COL_3_2.append(WRAPPERMARGIN)
            COL_3_3.append(WRAPPERMATRIXID)
            COL_3_4.append(WRAPPERMATRIXCODE, WRAPPERMATRIXNAME)
            ROW.append(COL_3_1, COL_3_2, COL_3_3, COL_3_4)
            CONTAINER.append(ROW)
        }
        
        return CONTAINER
    }
    
    const getRowValues = function (row) {
        let pricingId, variantId, pricingCode, matrixId, pricingCount = null, inputs = [],
            vals = {
                monCost: null,
                tueCost: null,
                wedCost: null,
                thuCost: null,
                friCost: null,
                satCost: null,
                sunCost: null,
                monMargin: null,
                tueMargin: null,
                wedMargin: null,
                thuMargin: null,
                friMargin: null,
                satMargin: null,
                sunMargin: null,
            }
        
        if ($(row).attr("data-dowrow") !== "true") {
            matrixId = ($(row).attr("data-matrixid")) ? (!isNaN(parseInt($(row).attr("data-matrixid")))) ? parseInt($(row).attr("data-matrixid")) : null : null
            pricingId = ($(row).attr("data-pricingid")) ? (!isNaN(parseInt($(row).attr("data-pricingid")))) ? parseInt($(row).attr("data-pricingid")) : null : null
            variantId = ($(row).attr("data-variantid")) ? (!isNaN(parseInt($(row).attr("data-variantid")))) ? parseInt($(row).attr("data-variantid")) : null : null
            pricingCode = ($(row).attr("data-pricingcode")) ? $(row).attr("data-pricingcode") : null
            pricingCount = ($(row).attr("data-pricingcount")) ? (!isNaN(parseInt($(row).attr("data-pricingcount")))) ? parseInt($(row).attr("data-pricingcount")) : null : null
            inputs = row.getElementsByTagName("input")
            
            $.each(inputs, function (k, el) {
                let name = (el.name) ? el.name : null
                let disabled = (el.disabled) ? el.disabled : false
                let value = (el.value) ? el.value : null
                if (!is_null(name) && !is_null(disabled) && !disabled) {
                    vals[name] = (!isNaN(parseInt(value))) ? parseInt(value) : null
                }
            })
            
            return remove_nulls(
                {
                    id: pricingId,
                    matrix_id: matrixId,
                    variant_id: variantId,
                    code: pricingCode,
                    count: pricingCount,
                    mon: vals.monCost,
                    tue: vals.tueCost,
                    wed: vals.wedCost,
                    thu: vals.thuCost,
                    fri: vals.friCost,
                    sat: vals.satCost,
                    sun: vals.sunCost,
                    monMargin: vals.monMargin,
                    tueMargin: vals.tueMargin,
                    wedMargin: vals.wedMargin,
                    thuMargin: vals.thuMargin,
                    friMargin: vals.friMargin,
                    satMargin: vals.satMargin,
                    sunMargin: vals.sunMargin,
                    enabled: 1,
                    note: null,
                },
            )
        }
    }
    
    const buildPricingData = function (table, matrix) {
        let pricings = []
        let productId = $(table).attr("data-productid")
        let seasonId = $(table).attr("data-seasonid")
        let unitId = $(table).attr("data-unitid")
        let matrixCode = ($(table).attr("data-matrixid"))
        
        for (let row of table.rows) {
            let rowVals = getRowValues(row)
            let pricingId, variantId, pricingCode, pricingCount = null, inputs = [],
                vals = {
                    monCost: null,
                    tueCost: null,
                    wedCost: null,
                    thuCost: null,
                    friCost: null,
                    satCost: null,
                    sunCost: null,
                    monMargin: null,
                    tueMargin: null,
                    wedMargin: null,
                    thuMargin: null,
                    friMargin: null,
                    satMargin: null,
                    sunMargin: null,
                }
            if ($(row).attr("data-dowrow") !== "true") {
                pricingId = ($(row).attr("data-pricingid")) ? (!isNaN(parseInt($(row).attr("data-pricingid")))) ? parseInt($(row).attr("data-pricingid")) : null : null
                variantId = ($(row).attr("data-variantid")) ? (!isNaN(parseInt($(row).attr("data-variantid")))) ? parseInt($(row).attr("data-variantid")) : null : null
                pricingCode = ($(row).attr("data-pricingcode")) ? $(row).attr("data-pricingcode") : null
                pricingCount = ($(row).attr("data-pricingcount")) ? (!isNaN(parseInt($(row).attr("data-pricingcount")))) ? parseInt($(row).attr("data-pricingcount")) : null : null
                inputs = row.getElementsByTagName("input")
                
                $.each(inputs, function (k, el) {
                    let name = (el.name) ? el.name : null
                    let disabled = (el.disabled) ? el.disabled : false
                    let value = (el.value) ? el.value : null
                    if (!is_null(name) && !is_null(disabled) && !disabled) {
                        vals[name] = (!isNaN(parseInt(value))) ? parseInt(value) : null
                    }
                })
                
                pricings.push(remove_nulls(
                    {
                        id: pricingId,
                        matrix_id: matrix.id,
                        variant_id: variantId,
                        code: pricingCode,
                        count: pricingCount,
                        mon: vals.monCost,
                        tue: vals.tueCost,
                        wed: vals.wedCost,
                        thu: vals.thuCost,
                        fri: vals.friCost,
                        sat: vals.satCost,
                        sun: vals.sunCost,
                        monMargin: vals.monMargin,
                        tueMargin: vals.tueMargin,
                        wedMargin: vals.wedMargin,
                        thuMargin: vals.thuMargin,
                        friMargin: vals.friMargin,
                        satMargin: vals.satMargin,
                        sunMargin: vals.sunMargin,
                        enabled: 1,
                        note: null,
                    },
                ))
            }
        }
        
        return pricings
    }
    
    const getFormValues = function (form) {
        if (!form) {
            return
        }
        let id = form.id
        let table = document.getElementById(id + "-table")
        let productId = $(table).attr("data-productid")
        let seasonId = $(table).attr("data-seasonid")
        let unitId = $(table).attr("data-unitid")
        let matrixCode = ($(table).attr("data-matrixid"))
        
        let matrix = {
            id: null,
            code: (form.elements["baseMatrixCode"].value !== "") ? form.elements["baseMatrixCode"].value : "",
            product_id: (!isNaN(parseInt(productId))) ? parseInt(productId) : null,
            season_id: (!isNaN(parseInt(seasonId))) ? parseInt(seasonId) : null,
            unit_id: (!isNaN(parseInt(unitId))) ? parseInt(unitId) : null,
            name: (form.elements["baseMatrixName"].value !== "") ? form.elements["baseMatrixName"].value : "",
            cost: (form.elements["baseCost"].value !== "") ? parseInt(form.elements["baseCost"].value) : null,
            margin: (form.elements["baseMargin"].value !== "") ? parseInt(form.elements["baseMargin"].value) : null,
            has_pricing: 1,
            been_saved: 1,
            enabled: 1,
            pricings: [],
        }
        matrix.price = null
        matrix.id = ($(table).attr("data-matrixid")) ? parseInt(($(table).attr("data-matrixid"))) : null
        matrix.pricings = buildPricingData(table, matrix)
        
        return remove_nulls(matrix)
    }
    
    const handlePricingWorksheetError = function (msg) {
        toastr.error(msg)
    }
    
    const update = function (dataToSend) {
        if (dataToSend) {
            sendUpdateRequest(dataToSend, function (data) {
                let matrix
                if (data) {
                    matrix = data
                    if (data[0]) {
                        matrix = data[0]
                    }
                    let pricings = (matrix.pricings) ? matrix.pricings : []
                    let pricingHold = new Map()
                    //console.log("matrix", matrix)
                    //console.log("pricings", pricings)
                    
                    Matrix.all.set(matrix.code, matrix)
                    
                    $.each(pricings, function (k, pricing) {
                        Pricing.all.set(pricing.code, pricing)
                    })
                    
                    PricingWorksheet.pricingWorksheet()
                    
                    Product.updateProgress()
                    toastr["success"](`Matrix: ${matrix.name} - has been updated`, "Pricing Worksheet")
                }
            })
        }
    }
    
    const pricingUpdate = function (dataToSend) {
        if (dataToSend) {
            sendUpdateRequestPricing(dataToSend, function (data) {
                let pricing
                if (data) {
                    pricing = data
                    if (data[0]) {
                        pricing = data[0]
                    }
                    Pricing.all.set(pricing.code, pricing)
                    
                    PricingWorksheet.pricingWorksheet()
                    
                    //console.log("pricingsHidden", pricingsHidden)
                    //console.log("matricesHidden", matricesHidden)
                    //console.log("unitsCollapsed", unitsCollapsed)
                    //console.log("seasonsCollapsed", seasonsCollapsed)
                    
                    if (seasonsCollapsed) {
                        $(_button_collapse_seasons).attr("data-shown", "false")
                        $(_button_collapse_seasons).text("Expand Seasons")
                        toggleSeasonFilter()
                    }
                    
                    if (unitsCollapsed) {
                        $(_button_collapse_units).attr("data-shown", "false")
                        $(_button_collapse_units).text("Expand Units")
                        toggleUnitFilter()
                    }
                    
                    if (matricesHidden) {
                        $("[data-matrixcomplete='true']").show()
                        $(_button_toggle_completed_matrices).attr("data-shown", "true")
                        $(_button_toggle_completed_matrices).text("Hide Completed Matrices")
                    }
                    
                    if (pricingsHidden) {
                        $("[data-pricingcomplete='true']").show()
                        $(_button_toggle_completed_pricings).attr("data-shown", "true")
                        $(_button_toggle_completed_pricings).text("Hide Completed Pricings")
                    }
                    
                    toastr.success(`Pricing: ${pricing.name} - has been updated`)
                }
            })
        }
    }
    
    const sendUpdateRequest = function (dataToSend, callback) {
        let url = "/api/v1.0/matrices/update"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handlePricingWorksheetError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const sendUpdateRequestPricing = function (dataToSend, callback) {
        let url = "/api/v1.0/pricings/update"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handlePricingWorksheetError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const updateMatrix = function (_this) {
        let dataToSend = getFormValues(document.getElementById($(_this).attr("data-targetform")))
        
        confirmDialog(`Would you like to update?`, (ans) => {
            if (ans) {
                update(dataToSend)
            }
        })
    }
    
    const updatePricing = function (_this, row) {
        let dataToSend = getRowValues(row)
        
        confirmDialog(`Would you like to update?`, (ans) => {
            if (ans) {
                pricingUpdate(dataToSend)
            }
        })
    }
    
    const buildMatrixWrapper = function () {
        return $("<div/>", {})
    }
    
    const tableVariantHeading = function (pricing) {
        let matrix
        let H5 = $("<h5/>", {
            class: "card-title d-flex justify-content-between m-2",
        })
        
        if (pricing) {
            matrix = Matrix.all.get(pricing.pricing_code)
            if (!matrix) {
                matrix = Matrix.set()
            }
        }
        
        let name = (pricing.name) ? pricing.name : "Pricing"
        
        if (parseInt(_pricing_strategy_types_id.value) === 1) {
            name = "Unit Pricing"
        } else if (parseInt(_pricing_strategy_types_id.value) === 3) {
            name = "Daily Pricing"
        }
        
        let SPAN = $("<span/>", {
            class: "",
            text: (name) ? name : "Pricing Variant",
        })
        
        if (pricing && pricing.been_saved && pricing.been_saved === 1) {
            H5.append(SPAN, completed)
        } else {
            H5.append(SPAN, incomplete)
        }
        
        return H5
    }
    
    const buildPricingRow = function (pricing) {
        let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        let matrixCode = pricing.matrix_code
        
        let FORM = $("<form/>", {
            id: "pricingMatrixForm-" + matrixCode,
            class: "card card-body border border-dark rounded-lg mb-2 mt-2 p-0 ",
            attr: { "novalidate": "novalidate" },
        })
        
        if (pricing && pricing.been_saved && pricing.been_saved === 1) {
            FORM.attr("data-matrixcomplete", "true")
            
            if (PricingWorksheet.incompleteMatrices.get(matrixCode)) {
                PricingWorksheet.incompleteMatrices.delete(matrixCode)
            }
            
        } else {
            PricingWorksheet.incompleteMatrices.set(matrixCode, pricing)
            FORM.attr("data-matrixcomplete", "false")
        }
        
        let TABLECONTAINER = $("<div/>", {
            class: "pl-1 pr-1",
        })
        
        let TABLECONTAINERROW = $("<div/>", {
            class: "row",
        })
        
        let TABLECONTAINERCELL = $("<div/>", {
            class: "col-12",
        })
        
        let BASEELEMENTS = buildTableVariantHeadingBaseInputs(pricing)
        
        let BUTTONROW = buildPricingButtonRow(pricing)
        
        let TABLE = $("<table/>", {
            class: "table table-bordered table-sm",
            id: "pricingMatrixForm-" + matrixCode + "-table",
            attr: {
                "data-matrixcode": matrixCode,
                "data-productid": productId,
                "data-unitid": pricing.unit_id,
                "data-seasonid": pricing.season_id,
                "data-name": pricing.name,
            },
        })
        
        if (pricing.id) {
            TABLE.attr("data-matrixid", pricing.id)
        }
        
        let TBODY = $("<tbody/>", {})
        let THEAD = $("<thead/>", {})
            .append(tableDOW(pricing))
        
        for (let n = 0; n < pricing.variants.length; n++) {
            let variantPricing = pricing.variants[n]
            let BADGE = incomplete
            
            variantPricing.matrix_code = matrixCode
            
            let TR = $("<tr/>")
            let I = $("<i/>", {
                class: "far fa-edit",
            })
            
            TR.attr({
                "id": "tr-" + variantPricing.code,
                "data-variantid": (variantPricing.variant_id) ? variantPricing.variant_id : null,
                "data-pricingid": (variantPricing.id) ? variantPricing.id : null,
                "data-pricingcode": (variantPricing.code) ? variantPricing.code : null,
                "data-matrixcode": (variantPricing.matrix_code) ? variantPricing.matrix_code : null,
                "data-pricingcount": (variantPricing.count) ? variantPricing.count : null,
                "data-productid": productId,
                "data-targetform": "pricingMatrixForm-" + variantPricing.matrix_code,
                "data-seasonid": (variantPricing.season_id) ? variantPricing.season_id : null,
                "data-name": (variantPricing.name) ? variantPricing.name : null,
            })
            if (variantPricing.been_saved === 1) {
                TR.attr("data-pricingcomplete", "true")
                BADGE = completed
            } else {
                TR.attr("data-pricingcomplete", "false")
                PricingWorksheet.incompletePricings.set(variantPricing.pricing_code, variantPricing)
            }
            
            let HEADINGSPANCOLUMN = $(`
                        <td style="padding:0;">
                            <div class="d-flex flex-column">
                                <div class="p-1">
                                    ${BADGE}
                                </div>
                                <div class="p-1">
                                    <span class="table-variant-title">${pricing.name}</span>
                                </div>
                               
                            </div>
                        </td>
                    `)
            
            TR.append(HEADINGSPANCOLUMN)
            
            let UPDATEBUTTON = $("<button/>", {
                class: "btn btn-sm editRow btn-sm btn-teal waves-effect waves-light",
                type: "button",
                attr: {
                    "data-variantid": (variantPricing.variant_id) ? variantPricing.variant_id : null,
                    "data-pricingid": (variantPricing.id) ? variantPricing.id : null,
                    "data-pricingcode": (variantPricing.code) ? variantPricing.code : null,
                    "data-matrixcode": (variantPricing.matrix_code) ? variantPricing.matrix_code : null,
                    "data-pricingcount": (variantPricing.count) ? variantPricing.count : null,
                    "data-productid": productId,
                    "data-targetform": "pricingMatrixForm-" + variantPricing.matrix_code,
                    "data-seasonid": (variantPricing.season_id) ? variantPricing.season_id : null,
                    "data-name": (variantPricing.name) ? variantPricing.name : null,
                },
            })
                .append(I)
            
            if (variantPricing.matrix_id) {
                UPDATEBUTTON.attr("data-matrixid", variantPricing.matrix_id)
            }
            
            UPDATEBUTTON.on("click", function () {
                let row = document.getElementById("tr-" + variantPricing.code)
                
                if (row) {
                    updatePricing(this, row)
                }
            })
            
            for (let n = 0; n < daysOfTheWeek.length; n++) {
                let TD = $("<td/>")
                TD.append(buildCostElement(variantPricing, daysOfTheWeek[n]), buildMarginElement(variantPricing, daysOfTheWeek[n]))
                TR.append(TD)
            }
            
            let BUTTONCOLUMN = $("<td/>", {
                class: "text-center td-editor",
            })
                .append(UPDATEBUTTON)
            
            TR.append(BUTTONCOLUMN)
            
            TBODY.append(TR)
            
        }
        
        TABLE.append(THEAD, TBODY)
        TABLECONTAINER.append(TABLE)
        TABLECONTAINERCELL.append(TABLECONTAINER)
        TABLECONTAINERROW.append(TABLECONTAINERCELL)
        
        let HEADING = tableVariantHeading(pricing)
        let HR = $("<hr/>", {
            class: "ml-3 mr-3 mt-1 mb-3 color-dark",
        })
        return FORM.append(HEADING, HR, BASEELEMENTS, TABLECONTAINERROW, BUTTONROW)
    }
    
    const buildMarginElement = function (variantPricing, day) {
        let matrixCode = variantPricing.matrix_code
        let pricingCode = matrixCode + "-" + variantPricing.variant_id + "-" + variantPricing.count
        let pricing = Pricing.all.get(pricingCode)
        
        if (!pricing) {
            pricing = Pricing.set()
            pricing.note = "generated form"
        }
        
        pricing.product_id = variantPricing.product_id
        pricing.season_id = variantPricing.product_id
        pricing.unit_id = variantPricing.product_id
        pricing.variant_id = variantPricing.variant_id
        pricing.matrix_code = matrixCode
        pricing.pricing_code = pricingCode
        pricing.name = variantPricing.name
        pricing.code = pricingCode
        
        if (day) {
            let dayDisabled = isDisabled(day, variantPricing.season_id)
            let marginDay = day + "Margin"
            let margin = (pricing[marginDay]) ? pricing[marginDay] : null
            
            let INPUT = $("<input/>", {
                type: "text",
                id: "cm-" + pricingCode + "-" + day,
                name: marginDay,
                class: "form-control margin m-0",
            })
                .attr("data-element", "margin")
            
            let FORMELEMENT = $("<div/>", {
                class: "md-form md-outline form-sm input-with-post-icon mb-2 mt-3",
            })
            
            let LABEL = $("<label/>", {
                text: "Margin",
                for: "cm-" + pricingCode + "-" + day,
            })
            
            let I = $("<i/>", {
                class: "fas fa-percentage input-prefix",
            })
            
            if (isDisabled(day, variantPricing.season_id)) {
                INPUT.attr("disabled", "disabled")
                INPUT.val("")
                LABEL.removeClass("active")
                FORMELEMENT.addClass("disabled")
            } else {
                FORMELEMENT.removeClass("disabled")
                if (margin > 0) {
                    INPUT.val(margin)
                    LABEL.addClass("active")
                }
            }
            
            FORMELEMENT.append(I, INPUT, LABEL)
            
            return FORMELEMENT
        }
    }
    
    const buildCostElement = function (variantPricing, day) {
        let matrixCode = variantPricing.matrix_code
        let pricingCode = matrixCode + "-" + variantPricing.variant_id + "-" + variantPricing.count
        let pricing = Pricing.all.get(pricingCode)
        
        if (!pricing) {
            pricing = Pricing.set()
            pricing.note = "generated form"
        }
        
        pricing.product_id = variantPricing.product_id
        pricing.season_id = variantPricing.product_id
        pricing.unit_id = variantPricing.product_id
        pricing.variant_id = variantPricing.variant_id
        pricing.matrix_code = matrixCode
        pricing.pricing_code = pricingCode
        pricing.name = variantPricing.name
        pricing.code = pricingCode
        
        if (day) {
            let costDayName = day + "Cost"
            let cost = (pricing[day]) ? pricing[day] : 0
            let INPUT = $("<input/>", {
                type: "text",
                name: costDayName,
                id: "ce-" + pricingCode + "-" + day,
                class: "form-control cost m-0",
            })
                .attr("data-element", "cost")
            
            let FORMELEMENT = $("<div/>", {
                class: "md-form md-outline form-sm input-with-pre-icon mt-2 mb-3",
            })
            
            let LABEL = $("<label/>", {
                text: "Cost",
                for: "ce-" + pricingCode + "-" + day,
            })
            
            let I = $("<i/>", {
                class: "fas fa-dollar-sign input-prefix",
            })
            
            if (isDisabled(day, variantPricing.season_id)) {
                INPUT.attr("disabled", "disabled")
                INPUT.val("")
                LABEL.removeClass("active")
                FORMELEMENT.addClass("disabled")
            } else {
                FORMELEMENT.removeClass("disabled")
                if (cost > 0) {
                    INPUT.val(cost)
                    LABEL.addClass("active")
                }
            }
            
            FORMELEMENT.append(I, INPUT, LABEL)
            
            return FORMELEMENT
        }
    }
    
    const buildSeasonHeading = function (season, matrixId, count) {
        let seasonBackgroundColor, seasonTextColor, seasonBorderColor
        if (season) {
            let seasonName = (season.season_name) ? season.season_name : null
            let seasonId = (season.season_id) ? season.season_id : null
            let hasSeason = Season.all.get(seasonId)
            
            if (hasSeason) {
                seasonBackgroundColor = (hasSeason.color_scheme.background_color) ? hasSeason.color_scheme.background_color : null
                seasonTextColor = (hasSeason.color_scheme.text_color) ? hasSeason.color_scheme.text_color : null
                seasonBorderColor = (hasSeason.color_scheme.border_color) ? hasSeason.color_scheme.border_color : null
            }
            
            let SEASONHEADINGWRAPPER = $("<div/>", {
                class: "card-header p-0",
                role: "tab",
                id: "seasonHeading" + matrixId + "-" + count,
            })
            
            let I = $("<i/>", {
                class: "fas fa-angle-down rotate-icon",
            })
            
            let A = $("<a/>", {
                href: "#collapse" + matrixId + "-" + count,
                "aria-controls": "collapse" + matrixId + "-" + count,
                "data-toggle": "collapse",
                "aria-expanded": "true",
            })
            
            let SPAN = $("<span/>", {
                text: seasonName,
            })
            
            let HEADING = $("<h5/>", {
                class: "mb-0 w-100 d-flex align-items-center justify-content-between p-1",
                css: {
                    "background-color": `${seasonBackgroundColor}`,
                    "border": `solid 1px ${seasonBorderColor}`,
                    "color": `${seasonTextColor}`,
                },
            })
            
            SEASONHEADINGWRAPPER.append(A.append(HEADING.append(SPAN, I)))
            
            return SEASONHEADINGWRAPPER
        }
    }
    
    const buildUnitHeading = function (unit, count) {
        let id = unit.id + "-" + count
        let unitName = (unit.name) ? unit.name : null
        let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
        let hasUnit = Unit.all.get(unitId)
        if (hasUnit) {
            let UNITHEADINGWRAPPER = $("<div/>", {
                class: "card-header p-0",
                role: "tab",
                id: "unitHeading-" + id,
            })
            
            let I = $("<i/>", {
                class: "fas fa-angle-down rotate-icon",
            })
            
            let A = $("<a/>", {
                href: "#unitCollapse-" + id,
                "aria-controls": "unitCollapse-" + id,
                "data-toggle": "collapse",
                "aria-expanded": "true",
            })
            
            let SPAN = $("<span/>", {
                text: unitName,
            })
            
            let HEADING = $("<h5/>", {
                class: "mb-0 w-100 d-flex align-items-center justify-content-between p-1",
            })
            
            UNITHEADINGWRAPPER.append(A.append(HEADING.append(SPAN, I)))
            
            return UNITHEADINGWRAPPER
        }
    }
    
    const buildPricingTables = function (matrices) {
        
        let $ACCORDIONWRAPPER = buildMatrixWrapper()
        
        if (matrices) {
            if (matrices.units) {
                let unitCount = 0
                $.each(matrices.units, function (index, unit) {
                    let seasons = unit.seasons
                    let UNITWRAPPER = buildUnitWrapper(unit, unitCount)
                    let UNITHEADING = buildUnitHeading(unit, unitCount)
                    let UNITCONTAINER = $("<div/>", {
                        class: "card border border-0",
                    })
                    let UNITCOLLAPSE = $("<div/>", {
                        class: "collapse show",
                        role: "tabpanel",
                        "data-parent": "#accordionUnit-" + unit.id + "-" + unitCount,
                        id: "unitCollapse-" + unit.id + "-" + unitCount,
                        "aria-labelledby": "unitHeading-" + unit.id + "-" + unitCount,
                    })
                        .attr("data-type", "unit")
                    
                    let UNITCARDBODY = $("<div/>", {
                        class: "card-body px-1",
                    })
                    
                    let count = 0
                    $.each(seasons, function (i, season) {
                        let seasonBackgroundColor, seasonTextColor, seasonBorderColor
                        let matrixId = _product_id.value + "-" + unit.id + "-" + season.season_id
                        let pricings = season.pricings
                        let seasonId = (season.season_id) ? season.season_id : null
                        let hasSeason = Season.all.get(seasonId)
                        
                        let SEASONWRAPPER = buildSeasonWrapper(season, matrixId, count)
                        let SEASONHEADING = buildSeasonHeading(season, matrixId, count)
                        let SEASONCONTAINER = $("<div/>", {
                            class: "card",
                        })
                        let SEASONCOLLAPSE = $("<div/>", {
                            class: "collapse show",
                            role: "tabpanel",
                            "data-parent": "#accordionEx" + matrixId + "-" + count,
                            id: "collapse" + matrixId + "-" + count,
                            "aria-labelledby": "seasonHeading" + matrixId + "-" + count,
                        })
                            .attr("data-type", "season")
                        
                        if (hasSeason) {
                            seasonBackgroundColor = hexToRgb(hasSeason.color_scheme.background_color)
                            seasonTextColor = hasSeason.color_scheme.text_color
                            seasonBorderColor = hasSeason.color_scheme.border_color
                        }
                        
                        let SEASONCARDBODY = $("<div/>", {
                            class: "card-body p-1",
                            css: {
                                "background": `rgba(${seasonBackgroundColor.join(",")}, .15)`,
                                "color": seasonTextColor,
                            },
                        })
                        
                        $.each(pricings, function (ind, pricing) {
                            
                            SEASONCARDBODY.append(buildPricingRow(pricing))
                            SEASONCOLLAPSE.append(SEASONCARDBODY)
                        })
                        
                        SEASONCONTAINER.append(SEASONHEADING, SEASONCOLLAPSE)
                        SEASONWRAPPER.append(SEASONCONTAINER)
                        UNITCARDBODY.append(SEASONWRAPPER)
                        UNITCOLLAPSE.append(UNITCARDBODY)
                        count = count + 1
                    })
                    
                    UNITCONTAINER.append(UNITHEADING, UNITCOLLAPSE)
                    UNITWRAPPER.append(UNITCONTAINER)
                    $ACCORDIONWRAPPER.append(UNITWRAPPER)
                    unitCount += 1
                })
            }
        }
        
        return $ACCORDIONWRAPPER
    }
    
    const getVariants = function () {
        let variantsUsed = []
        let pricingStrategyType = (!isNaN(parseInt(_pricing_strategy_types_id.value))) ? parseInt(_pricing_strategy_types_id.value) : null
        switch (pricingStrategyType) {
            case 1:
                variantsUsed = [36]
                break
            case 2:
                let variantList = Array.from(Variant.all.values())
                for (let n = 0; n < variantList.length; n++) {
                    if (variantList[n].used_in_pricing) {
                        variantsUsed.push(variantList[n].id)
                    }
                }
                break
            default:
                variantsUsed = [36]
                break
        }
        
        return variantsUsed
    }
    
    const getSeasons = function () {
        var seasonsUsed = []
        var seasonList = Array.from(Season.all.values())
        for (let n = 0; n < seasonList.length; n++) {
            seasonsUsed.push(seasonList[n])
        }
        
        return seasonsUsed
    }
    
    const getUnits = function () {
        var unitsUsed = []
        var unitList = Array.from(Unit.all.values())
        for (let n = 0; n < unitList.length; n++) {
            unitsUsed.push(unitList[n])
        }
        
        return unitsUsed
    }
    
    const getVariantDetails = function (variantId) {
        let name = ""
        if (parseInt(_pricing_strategy_types_id.value) === 1) {
            name = "Unit Pricing"
        } else if (parseInt(_pricing_strategy_types_id.value) === 3) {
            name = "Daily Pricing"
        }
        
        let details = {
            category_id: 1,
            code: "VA-00000000036-OTHR",
            created_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            enabled: 1,
            id: 36,
            max_age: null,
            min_age: null,
            modified_by: user_id,
            name: name,
            note: null,
            used_in_pricing: 1,
        }
        let variant = Variant.all.get(variantId)
        if (variant) {
            details = Variant.set(variant)
        }
        
        return details
    }
    
    const addVariantList = function (unit, season, matrixCode, variantComboId) {
        let variants = variantComboId.trim().split("-").map(Number)
        let seasonId = parseInt(season.id)
        let unitId = parseInt(unit.id)
        let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        
        let tempHold = new Map()
        
        $.each(variants, function (key, variantId) {
            //let variant = Variant.all.get(variantId)
            let variant = getVariantDetails(variantId)
            
            if (variant) {
                
                let hasTempHold = tempHold.get(variantId)
                
                if (hasTempHold) {
                    let count = hasTempHold.count
                    count = count + 1
                    hasTempHold.count = count
                    hasTempHold.name = count + " " + pluralize(variant.name)
                    let pricingCode = matrixCode.toString() + "-" + variantId + "-" + count
                    let pricing = Pricing.all.get(pricingCode)
                    
                    if (!pricing) {
                        pricing = {
                            aaa: "ok here 2",
                            been_saved: 0,
                            has_pricing: 0,
                            code: matrixCode.toString() + "-" + variantId.toString() + "-" + count.toString(),
                            count: count,
                            created_by: user_id,
                            date_created: formatDateMySQL(),
                            date_modified: formatDateMySQL(),
                            enabled: 1,
                            fri: null,
                            friMargin: null,
                            id: null,
                            matrix_code: matrixCode.toString(),
                            matrix_id: null,
                            modified_by: user_id,
                            mon: null,
                            monMargin: null,
                            name: variant.name + " " + count,
                            note: "generated form",
                            pricing_code: pricingCode,
                            product_id: productId,
                            sat: null,
                            satMargin: null,
                            season_id: seasonId,
                            sun: null,
                            sunMargin: null,
                            thu: null,
                            thuMargin: null,
                            tue: null,
                            tueMargin: null,
                            unit_id: unitId,
                            variant_id: variantId,
                            wed: null,
                            wedMargin: null,
                        }
                    } else {
                        pricing.aaa = 1
                        pricing.has_pricing = 1
                        pricing.been_saved = 1
                    }
                    
                    hasTempHold.variants.push({
                        aaa: "ok here",
                        matrix_code: matrixCode.toString(),
                        been_saved: 5,
                        has_pricing: (pricing.has_pricing) ? pricing.has_pricing : 0,
                        code: matrixCode.toString() + "-" + variantId.toString() + "-" + count.toString(),
                        count: count,
                        created_by: (pricing.created_by) ? pricing.created_by : user_id,
                        date_created: formatDateMySQL(),
                        date_modified: formatDateMySQL(),
                        enabled: (pricing.enabled) ? pricing.enabled : 1,
                        fri: (pricing.fri) ? pricing.fri : null,
                        friMargin: (pricing.friMargin) ? pricing.friMargin : null,
                        id: (pricing.id) ? pricing.id : null,
                        matrix_id: (pricing.matrix_id) ? pricing.matrix_id : null,
                        modified_by: (pricing.modified_by) ? pricing.matrix_id : user_id,
                        mon: (pricing.mon) ? pricing.mon : null,
                        monMargin: (pricing.monMargin) ? pricing.monMargin : null,
                        name: variant.name + " " + count,
                        note: "generated form",
                        pricing_code: matrixCode.toString() + "-" + variantId.toString() + "-" + count.toString(),
                        product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
                        sat: (pricing.sat) ? pricing.sat : null,
                        satMargin: (pricing.satMargin) ? pricing.satMargin : null,
                        season_id: parseInt(season.id),
                        sun: (pricing.sun) ? pricing.sun : null,
                        sunMargin: (pricing.sunMargin) ? pricing.sunMargin : null,
                        thu: (pricing.thu) ? pricing.thu : null,
                        thuMargin: (pricing.thuMargin) ? pricing.thuMargin : null,
                        tue: (pricing.tue) ? pricing.tue : null,
                        tueMargin: (pricing.tueMargin) ? pricing.tueMargin : null,
                        unit_id: unit.id,
                        variant_id: variantId,
                        wed: (pricing.wed) ? pricing.wed : null,
                        wedMargin: (pricing.wedMargin) ? pricing.wedMargin : null,
                    })
                    
                } else {
                    let count = 1
                    let pricingCode = matrixCode.toString() + "-" + variantId + "-" + count
                    let pricing = Pricing.all.get(pricingCode)
                    
                    if (!pricing) {
                        
                        pricing = {
                            aaa: "ok here 1",
                            has_pricing: 0,
                            been_saved: 0,
                            code: pricingCode,
                            count: count,
                            created_by: user_id,
                            date_created: formatDateMySQL(),
                            date_modified: formatDateMySQL(),
                            enabled: 1,
                            fri: null,
                            friMargin: null,
                            id: null,
                            matrix_code: matrixCode,
                            pricing_code: pricingCode,
                            matrix_id: null,
                            modified_by: user_id,
                            mon: null,
                            monMargin: null,
                            name: variant.name + " " + count,
                            note: "generated form",
                            product_id: productId,
                            sat: null,
                            satMargin: null,
                            season_id: seasonId,
                            sun: null,
                            sunMargin: null,
                            thu: null,
                            thuMargin: null,
                            tue: null,
                            tueMargin: null,
                            unit_id: unitId,
                            variant_id: variant.id,
                            wed: null,
                            wedMargin: null,
                        }
                    } else {
                        pricing.aaa = "hasPricing"
                        pricing.been_saved = 1
                        pricing.has_pricing = 1
                    }
                    
                    hasTempHold = {
                        name: count + " " + variant.name,
                        variant_combo_id: variantComboId.trim(),
                        count: count,
                        variants: [
                            {
                                aaa: (pricing.aaa) ? pricing.aaa : "ghg",
                                code: pricingCode,
                                has_pricing: (pricing.has_pricing) ? pricing.has_pricing : 0,
                                variant_id: variantId,
                                name: variant.name + " " + count,
                                count: count,
                                created_by: pricing.created_by,
                                date_created: (pricing.date_created) ? pricing.date_created : formatDateMySQL(),
                                date_modified: (pricing.date_modified) ? pricing.date_modified : formatDateMySQL(),
                                enabled: (pricing.enabled) ? pricing.enabled : 1,
                                fri: null,
                                friMargin: null,
                                id: (pricing.id) ? pricing.id : null,
                                matrix_code: matrixCode,
                                matrix_id: (pricing.matrix_id) ? parseInt((pricing.matrix_id)) : null,
                                modified_by: (pricing.modified_by) ? parseInt((pricing.modified_by)) : user_id,
                                mon: (pricing.mon) ? parseInt((pricing.mon)) : null,
                                monMargin: null,
                                note: "fff",
                                pricing_code: matrixCode + "-" + variantId + "-" + count,
                                product_id: null,
                                sat: null,
                                satMargin: null,
                                season_id: null,
                                sun: null,
                                sunMargin: null,
                                thu: null,
                                thuMargin: null,
                                tue: null,
                                tueMargin: null,
                                unit_id: unit.id,
                                wed: null,
                                wedMargin: null,
                            },
                        ],
                    }
                }
                
                tempHold.set(variantId, hasTempHold)
                
            } else {
                if (parseInt(variantId) === 36) {
                    variant = {
                        category_id: 1,
                        code: "VA-00000000036-OTHR",
                        created_by: 4,
                        date_created: "2022-01-18 08:08:22",
                        date_modified: "2022-01-18 12:02:26",
                        enabled: 1,
                        id: 36,
                        max_age: null,
                        min_age: null,
                        modified_by: 4,
                        name: "Other",
                        note: null,
                        used_in_pricing: 1,
                    }
                }
            }
            
        })
        
        let beenSaved, pricingBeenSaved = 0
        let myVariants = []
        let name = []
        let pricingCode, mCode
        let matrixId, pricingId = null
        
        $.each(Array.from(tempHold.values()), function (key, variantValues) {
            name.push(variantValues.name)
            
            if (variantValues.variants) {
                $.each(variantValues.variants, function (k, v) {
                    pricingCode = matrixCode + "-" + v.variant_id + "-" + v.count
                    mCode = matrixCode
                    //let variant = Variant.all.get(v.variant_id)
                    let variant = getVariantDetails(v.variant_id)
                    let matrix = Matrix.all.get(mCode)
                    let pricing = Pricing.all.get(pricingCode)
                    let season = Season.all.get(seasonId)
                    let matrix_code = mCode
                    let sun = null
                    let mon = null
                    let tue = null
                    let wed = null
                    let thu = null
                    let fri = null
                    let sat = null
                    let sunMargin = null
                    let monMargin = null
                    let tueMargin = null
                    let wedMargin = null
                    let thuMargin = null
                    let friMargin = null
                    let satMargin = null
                    let enabled = 1
                    let note = null
                    let date_created = formatDateMySQL()
                    let date_modified = formatDateMySQL()
                    let created_by = user_id
                    let modified_by = user_id
                    
                    if (matrix) {
                        matrixId = matrix.id
                        beenSaved = 1
                    }
                    
                    if (pricing) {
                        pricingId = pricing.id
                        pricingBeenSaved = 1
                        sun = pricing.sun
                        mon = pricing.mon
                        tue = pricing.tue
                        wed = pricing.wed
                        thu = pricing.thu
                        fri = pricing.fri
                        sat = pricing.sat
                        sunMargin = pricing.sunMargin
                        monMargin = pricing.monMargin
                        tueMargin = pricing.tueMargin
                        wedMargin = pricing.wedMargin
                        thuMargin = pricing.thuMargin
                        friMargin = pricing.friMargin
                        satMargin = pricing.satMargin
                        enabled = pricing.enabled
                        note = pricing.note
                        date_created = pricing.date_created
                        date_modified = pricing.date_modified
                        created_by = pricing.created_by
                        modified_by = pricing.modified_by
                    }
                    
                    let tempV = {
                        count: v.count,
                        been_saved: pricingBeenSaved,
                        code: pricingCode,
                        pricing_code: pricingCode,
                        product_id: productId,
                        unit_id: unitId,
                        season_id: seasonId,
                        variant_id: v.variant_id,
                        matrix_id: matrixId,
                        name: variant.name + " " + v.count,
                        id: pricingId,
                        sun: sun,
                        mon: mon,
                        tue: tue,
                        wed: wed,
                        thu: thu,
                        fri: fri,
                        sat: sat,
                        sunMargin: sunMargin,
                        monMargin: monMargin,
                        tueMargin: tueMargin,
                        wedMargin: wedMargin,
                        thuMargin: thuMargin,
                        friMargin: friMargin,
                        satMargin: satMargin,
                        enable: enabled,
                        note: note,
                        date_created: date_created,
                        date_modified: date_modified,
                        created_by: created_by,
                        modified_by: modified_by,
                    }
                    
                    tempV["matrix_code"] = "H"
                    myVariants.push(tempV)
                })
            }
            
        })
        
        name = name.join(" - ")
        let been_saved = 0
        let cost = null
        let margin = null
        let m = Matrix.all.get(matrixCode)
        
        if (m) {
            been_saved = 1
            cost = m.cost
            margin = m.margin
        }
        
        return {
            name: name,
            cost: cost,
            margin: margin,
            season_id: seasonId,
            unit_id: unitId,
            product_id: productId,
            been_saved: been_saved,
            matrix_code: matrixCode,
            id: (matrixId) ? matrixId : null,
            variants: myVariants,
        }
    }
    
    const getVariantCombinations = function (depth, baseString, arrLetters) {
        for (let i = 0; i < arrLetters.length; i++) {
            if (depth === 1) {
                let variantComboId = baseString + arrLetters[i]
                
                let combos = variantComboId.split('-').map(function (item) {
                    return parseInt(item, 10)
                })
                
                combos = combos.sort().join("-")
                
                let hasVariantComboIndex = variantCombinations.indexOf(variantComboId)
                if (hasVariantComboIndex < 0) {
                    variantCombinations.push(combos)
                }
                
            } else {
                let id = arrLetters[i]
                getVariantCombinations(depth - 1, baseString + arrLetters[i] + "-", arrLetters)
            }
        }
    }
    
    const buildPricingWorksheet = function () {
        let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        let worksheet = {
            id: null,
            units: [],
        }
        
        variantList = getVariants()
        seasonList = getSeasons()
        unitList = getUnits()
        
        //loop through units
        for (let m = 0; m < unitList.length; m++) {
            variantCombinations = []
            let unit = unitList[m]
            let unitId = parseInt(unit.id)
            let max_pax = (unit.max_pax) ? parseInt(unit.max_pax) : 5
            let min_pax = (unit.min_pax) ? parseInt(unit.min_pax) : 1
            
            let pricingStrategyType = (!isNaN(parseInt(_pricing_strategy_types_id.value))) ? parseInt(_pricing_strategy_types_id.value) : null
            switch (pricingStrategyType) {
                case 1:
                    min_pax = 1
                    max_pax = 1
                    break
                case 2:
                    if (min_pax > max_pax) {
                        let temp = max_pax
                        max_pax = min_pax
                        min_pax = temp
                    }
                    break
                default:
                    min_pax = 1
                    max_pax = 1
                    break
            }
            
            for (let n = min_pax; n <= max_pax; n++) {
                getVariantCombinations(n, "", getVariants())
            }
            
            let variantCombinationList = variantCombinations
            
            let unitSection = {
                id: unit.id,
                name: unit.name,
                seasons: [],
            }
            
            //loop through seasons
            for (let n = 0; n < seasonList.length; n++) {
                let season = seasonList[n]
                let seasonId = (!isNaN(parseInt(season.id))) ? parseInt(season.id) : null
                let matrixCode = productId + "-" + unitId + "-" + seasonId
                let matrix = Matrix.all.get(matrixCode)
                
                if (matrix) {
                    matrix.pricings = []
                } else {
                    matrix = {
                        been_saved: 0,
                        code: matrixCode,
                        cost: 0,
                        created_by: 4,
                        date_created: "2022-01-14 09:00:39",
                        date_modified: "2022-01-14 09:00:39",
                        enabled: 1,
                        has_pricing: 1,
                        id: null,
                        margin: 0,
                        modified_by: 4,
                        note: null,
                        price: 201,
                        pricings: [],
                    }
                }
                
                let seasonSection = {
                    been_saved: matrix.been_saved,
                    code: matrix.code,
                    cost: matrix.cost,
                    created_by: matrix.created_by,
                    date_created: matrix.date_created,
                    date_modified: matrix.date_modified,
                    enabled: matrix.enabled,
                    has_pricing: matrix.has_pricing,
                    id: matrix.id,
                    margin: matrix.margin,
                    modified_by: matrix.modified_by,
                    note: matrix.note,
                    price: matrix.price,
                    season_id: season.id,
                    season_name: season.name,
                    matrix_code: matrixCode,
                    pricings: [],
                }
                
                //loop through variants
                $.each(variantCombinationList, function (key, variantComboId) {
                    seasonSection.matrix_code = matrixCode + "-" + variantComboId
                    seasonSection.pricings.push(addVariantList(unit, season, matrixCode + "-" + variantComboId, variantComboId))
                })
                
                unitSection.seasons.push(seasonSection)
            }
            
            worksheet.units.push(unitSection)
        }
        
        return worksheet
    }
    
    const pricingWorksheet = function () {
        resetFilters()
        emptyPricingMatrix()
        variantCombinations = []
        $(_product_edit_matrix_form).empty().append(buildPricingTables(PricingWorksheet.buildPricingWorksheet()))
        status()
    }
    
    const init = function (settings) {
        let pricingStrategyTypesId = null
        if (settings) {
            if (settings.pricing_strategy) {
                if (settings.pricing_strategy.pricing_strategy_types_id) {
                    pricingStrategyTypesId = (!isNaN(parseInt(settings.pricing_strategy.pricing_strategy_types_id))) ? parseInt(settings.pricing_strategy.pricing_strategy_types_id) : null
                }
            }
            
        }
        
        $(document).ready(function () {
            PricingWorksheet.pricingStrategyId = pricingStrategyTypesId
            if (_pricing_strategy_types_id) {
                $(_pricing_strategy_types_id)
                    .val(PricingWorksheet.pricingStrategyId)
                    .trigger("change")
            }
        })
    }
    
    return {
        pricingStrategyId: null,
        incompleteMatrices: new Map(),
        incompletePricings: new Map(),
        init: function (settings) {
            init(settings)
        },
        pricingWorksheet: function () {
            pricingWorksheet()
        },
        buildPricingWorksheet: function () {
            return buildPricingWorksheet()
        },
        status: function () {
            return status()
        },
    }
})()

const Upload = function (file) {
    this.file = file
}

const _image_manager_is_cover = document.getElementById("image_manager_is_cover")
const _image_manager_title = document.getElementById("image_manager_title")
const _image_manager_caption = document.getElementById("image_manager_caption")
const _image_manager_upload = document.getElementById("image_manager_upload")
const _image_manager_alt_text = document.getElementById("image_manager_alt_text")
const _image_manager_form_data = document.getElementById("image_manager_form_data")
const _image_manager_image_id = document.getElementById("image_manager_id")
const _provider_edit = document.getElementById("provider_edit")
const _vendor_edit = document.getElementById("vendor_edit")
const _provider_company_id = document.getElementById("provider_company_id")
const _vendor_company_id = document.getElementById("vendor_company_id")
Upload.prototype.getType = function () {
    return this.file.type
}

Upload.prototype.getSize = function () {
    return this.file.size
}

Upload.prototype.getName = function () {
    return this.file.name
}

Upload.prototype.doUpload = function () {
    let that = this
    let formData = new FormData()
    
    /**
     * add assoc key values, this will be posts values
     */
    formData.append("file", this.file, this.getName())
    formData.append("upload_file", true)
    formData.append("title", (_image_manager_title.value !== "") ? _image_manager_title.value : null)
    formData.append("caption", (_image_manager_caption.value !== "") ? _image_manager_caption.value : null)
    formData.append("is_cover", (_image_manager_is_cover.checked !== true) ? parseInt(0) : parseInt(1))
    formData.append("alt", (_image_manager_alt_text.value !== "") ? _image_manager_alt_text.value : null)
    
    /**
     * check if provider, user, unit, or product
     */
    if (_provider_edit) {
        formData.append("directory_id", parseInt(_provider_company_id.value))
        formData.append("directory", "company")
    }
    
    if (_vendor_edit) {
        formData.append("directory_id", parseInt(_vendor_company_id.value))
        formData.append("directory", "company")
    }
    
    $.ajax({
        type: "POST",
        url: "/api/v1.0/images/update",
        xhr: function () {
            var myXhr = $.ajaxSettings.xhr()
            if (myXhr.upload) {
                myXhr.upload.addEventListener("progress", that.progressHandling, false)
            }
            return myXhr
        },
        success: function (data) {
            //console.log("data", data)
            let image, result = null
            if (data) {
                if (data.result) {
                    result = data.result
                    if (result[0]) {
                        image = result[0]
                    }
                }
            }
            
            if (image) {
                let imageManager
                if (_provider_edit) {
                    imageManager = $("#companyImages").imageManager()
                }
                
                if (_vendor_edit) {
                    imageManager = $("#companyImages").imageManager()
                }
                
                imageManager.addImage(image)
                toastr.success("Image Uploaded")
                Upload.prototype.resetForm()
                $("button.dropify-clear").click()
            }
            
        },
        error: function (error) {
            toastr.error("Error")
            //console.log("error", error)
        },
        async: true,
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        timeout: 60000,
    })
}

Upload.prototype.progressHandling = function (event) {
    var percent = 0
    var position = event.loaded || event.position
    var total = event.total
    var progress_bar_id = "#progress-wrp"
    if (event.lengthComputable) {
        percent = Math.ceil(position / total * 100)
    }
    // update progressbars classes so it fits your code
    $(progress_bar_id + " .progress-bar").css("width", +percent + "%")
    $(progress_bar_id + " .status").text(percent + "%")
}

Upload.prototype.progressReset = function () {
    let percent = 0
    let progress_bar_id = "#progress-wrp"
    $(progress_bar_id + " .progress-bar").css("width", +percent + "%")
    $(progress_bar_id + " .status").text(percent + "%")
}

Upload.prototype.resetForm = function () {
    Upload.prototype.progressReset()
    _image_manager_is_cover.checked = false
    _image_manager_image_id.value = ""
    _image_manager_title.value = ""
    _image_manager_upload.value = ""
    _image_manager_caption.value = ""
    _image_manager_alt_text.value = ""
    _image_manager_upload.disabled = false
    $(_image_manager_form_data).hide()
}

Upload.prototype.populateForm = function (image) {
    Upload.prototype.progressReset()
    let img = image.path + "/" + image.name + "." + image.extension
    _image_manager_is_cover.checked = (image.is_cover === 1)
    _image_manager_image_id.value = image.id
    _image_manager_title.value = image.title
    _image_manager_caption.value = image.caption
    _image_manager_alt_text.value = image.alt
    $("button.dropify-clear").click()
    _image_manager_upload.disabled = true
    $(_image_manager_form_data).show()
    
}

$("#image_manager_upload")
    .on("change", function () {
        _image_manager_is_cover.checked = false
        _image_manager_image_id.value = ""
        _image_manager_title.value = ""
        _image_manager_caption.value = ""
        _image_manager_alt_text.value = ""
        $(_image_manager_form_data).show()
    })

$("#image_manager_clear_button")
    .on("click", function () {
        Upload.prototype.resetForm()
    })

$.fn.YearCalendar = function (settings) {
    "use strict"
    
    const _calendar_filter_ranges = document.getElementById("calendar_filter_ranges")
    const _product_id = document.getElementById("product_id")
    const _calendar_display_select_all_days = document.getElementById("calendar_display_select_all_days")
    const _calendar_display_clear_selected_days = document.getElementById("calendar_display_clear_selected_days")
    
    let calendarType = "season"
    let selectedStart, selectedEnd = null
    let calendar_id = $(this).attr("id")
    let calContainer = document.getElementById(calendar_id)
    let calendars = []
    let seasonEvents = new Map()
    let product_id = parseInt(_product_id.value)
    
    $(_calendar_display_select_all_days)
        .on("click", function () {
            selectAllDays()
        })
    
    $(_calendar_display_clear_selected_days)
        .on("click", function () {
            clearSelectedDates()
        })
    
    const selectAllDays = function () {
        clearSelectedDates()
        const start = new Date(new Date().getFullYear(), 0, 1)
        const end = new Date(new Date().getFullYear(), 11, 31)
        
        let startDate = moment(start).format("YYYY-MM-DD")
        let endDate = moment(end).format("YYYY-MM-DD")
        
        selectDates(this, startDate, endDate)
        
    }
    
    const pad = function (d) {
        return (d < 10) ? '0' + d.toString() : d.toString()
    }
    
    const buildCalendarRow = function (calendar_id) {
        let calendarRow = document.createElement("div")
        calendarRow.classList = "row gx-1"
        return calendarRow
    }
    
    const buildCalendarColumn = function (calendar_id) {
        let calendarRow = document.createElement("div")
        calendarRow.classList = "flex-fill col-6 p-1"
        return calendarRow
    }
    
    const buildCalendarElementPanel = function (calendar_id) {
        let calendarBlock = document.createElement("div")
        calendarBlock.classList = ["card card-block p-1 z-depth-0"]
        
        return calendarBlock
    }
    
    const buildCalendarElement = function (calendar_id) {
        let calendarPanel = buildCalendarElementPanel(calendar_id)
        let calendarColumn = buildCalendarColumn(calendar_id)
        let calendarBlock = document.createElement("div")
        let calendarBlockId = "calendar_block_" + calendar_id
        
        calendarBlock.classList = "my_calendar"
        calendarBlock.id = calendarBlockId
        
        calendarColumn.appendChild(calendarPanel)
        calendarPanel.appendChild(calendarBlock)
        
        calendars.push(calendarBlock)
        return calendarColumn
    }
    
    const buildCalendarContainer = function () {
        let calendarBlockContainer = document.createElement("div")
        let calendarBlockContainerId = "calendar_block_container"
        let row = buildCalendarRow()
        
        calendarBlockContainer.classList = ["calendarContainer container-fluid"]
        calendarBlockContainer.id = calendarBlockContainerId
        
        for (let n = 0; n < initialCalenderViewCount; n++) {
            let id = (n + 1)
            if (n % 2 === 0 && n > 0) {
                calendarBlockContainer.appendChild(row)
                row = buildCalendarRow(id)
            }
            
            row.appendChild(buildCalendarElement(id))
        }
        
        calendarBlockContainer.appendChild(row)
        
        return calendarBlockContainer
    }
    
    const clearSelectedDates = function () {
        let days = $("td[season='true']")
        days.each(function (index, element) {
            $(this).removeClass("selected-day")
            $(this).attr("data-selected", "false")
        })
        YearCalendar.selectedDates = new Map()
    }
    
    const fetchCalendarEvents = function (dataToSend, callback) {
        if (dataToSend) {
            try {
                sendGetRequest("/api/v1.0/calendars", dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return callback([])
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return callback([])
            }
        } else {
            return callback([])
        }
    }
    
    const getDate = function (startYear, monthsOut) {
        let startMonth = (0 + monthsOut) + 1
        let startDay = 1
        return moment(startYear + "-" + pad(startMonth) + "-" + pad(startDay)).format("YYYY-MM-DD")
    }
    
    const selectDay = function (_this, dateClicked) {
        if ($(_this).hasClass("selected-day")) {
            $(_this).removeClass("selected-day")
            $("td.fc-day-top[data-date='" + moment(dateClicked).format("YYYY-MM-DD") + "']")
                .removeClass("selected-day")
            YearCalendar.selectedDates.delete(dateClicked)
        } else {
            $(_this).addClass("selected-day")
            $("td.fc-day-top[data-date='" + moment(dateClicked).format("YYYY-MM-DD") + "']").addClass("selected-day")
            YearCalendar.selectedDates.set(dateClicked, dateClicked)
            selectedStart = dateClicked
            selectedEnd = null
        }
    }
    
    const selectDates = function (_this, startDate, endDate) {
        let start = new Date(moment(startDate).format("MM/DD/YYYY"))
        let end = new Date(moment(endDate).format("MM/DD/YYYY"))
        let loop = new Date(start)
        
        $("td.fc-day[data-date='" + moment(endDate).format("YYYY-MM-DD") + "']").removeClass("selected-day")
        $("td.fc-day[data-date='" + moment(startDate).format("YYYY-MM-DD") + "']").removeClass("selected-day")
        $("td.fc-day-top[data-date='" + moment(endDate).format("YYYY-MM-DD") + "']").removeClass("selected-day")
        
        while (loop <= end) {
            selectDay($("td.fc-day[data-date='" + moment(loop).format("YYYY-MM-DD") + "']"), moment(loop).format("YYYY-MM-DD"))
            let newDate = loop.setDate(loop.getDate() + 1)
            loop = new Date(newDate)
        }
    }
    
    const buildCalendar = function (settings) {
        YearCalendar.season_events = new Map()
        let dateToday = new Date()
        calContainer.appendChild(buildCalendarContainer())
        
        YearCalendar.start = (settings && settings.start) ? settings.start : dateToday.getFullYear()
        YearCalendar.events = (settings && settings.events) ? settings.events : []
        YearCalendar.getTitle()
        
        $.each(calendars, function (index, cal) {
            let displayMonth = getDate(YearCalendar.start, index)
            
            let activeCal = $(cal).fullCalendar({
                selectable: false,
                showNonCurrentDates: false,
                defaultDate: displayMonth,
                initialView: "dayGridMonth",
                displayEventTime: false,
                eventLimit: 3,
                header: {
                    left: "",
                    center: "title",
                    right: "",
                },
                views: {
                    month: {
                        titleFormat: "MMMM",
                    },
                },
                dayRender: function (date, el) {
                    let day = moment(date).format("YYYYMMDD")
                    let selectedDay = moment(date).format("YYYY-MM-DD")
                    let id = "s" + day
                    let month = moment(date).month()
                    let year = moment(date).year()
                    let dow = moment(date).day()
                    let top = $(`td.fc-day-top[data-date='${selectedDay}']`)
                    
                    let topSpan = $(`td.fc-day-top[data-date='${selectedDay}'] > span.fc-day-number`)
                    
                    /*
                    if (topSpan.length) {
                        $(top).empty()
                        let day = topSpan.text()
                        if (!isNaN(day)) {
                            let e = "<div class='w-100 d-flex align-items-center justify-content-between' style=''>"
                              + "<span>&nbsp;</span>"
                              + "<span class='fc-day-number'>" + day + "</span>"
                              + "</div>"
                            
                            let titleContainer = document.createElement("div")
                            top.append(e)
                        }
                    }
                    //*/
                    
                    if (!$(el).hasClass("fc-disabled-day")) {
                        $(top).attr("season", "true")
                        $(top).attr("data-date", selectedDay)
                        $(top).attr("id", id)
                        $(top).attr("day", day)
                        $(top).attr("month", month)
                        $(top).attr("year", year)
                        $(top).attr("dow", dow)
                        
                        $(el).attr("season", "true")
                        $(el).attr("data-date", selectedDay)
                        $(el).attr("id", id)
                        $(el).attr("day", day)
                        $(el).attr("month", month)
                        $(el).attr("year", year)
                        $(el).attr("dow", dow)
                        $(el).attr("data-selected", "false")
                    }
                },
                dayClick: function (event, jsEvent, view) {
                    let dateClicked = moment(event).format("YYYY-MM-DD")
                    
                    if (jsEvent.originalEvent.shiftKey) {
                        if (selectedStart !== null) {
                            selectedEnd = dateClicked
                            
                            if (moment(selectedEnd) < moment(selectedStart)) {
                                let tempEnd = moment(selectedStart).format("YYYY-MM-DD")
                                let tempStart = moment(selectedEnd).format("YYYY-MM-DD")
                                let startElement = $("td.fc-day[data-date='" + tempStart + "'][season='true']")
                                let endElement = $("td.fc-day[data-date='" + tempEnd + "'][season='true']")
                                $(startElement).removeClass("is-selected")
                                endElement.removeClass("is-selected")
                                
                                selectDates(this, tempStart, tempEnd)
                                selectedStart = tempEnd
                                selectedEnd = tempStart
                            } else {
                                selectDates(this, selectedStart, selectedEnd)
                            }
                            
                            selectedStart = null
                            selectedEnd = null
                        }
                    } else if (jsEvent.originalEvent.ctrlKey) {
                        if (this.hasClass("selected-day")) {
                            this.removeClass("selected-day")
                            YearCalendar.selectedDates.delete(dateClicked)
                            selectedStart = null
                            selectedEnd = null
                        } else {
                            YearCalendar.selectedDates.set(dateClicked, dateClicked)
                            selectedStart = dateClicked
                            selectedEnd = null
                            this.addClass("selected-day")
                        }
                    } else {
                        let datesSelected = Array.from(YearCalendar.selectedDates.values())
                        
                        clearSelectedDates()
                        selectDay(this, dateClicked)
                        selectedStart = dateClicked
                        selectedEnd = dateClicked
                        this.addClass("selected-day")
                        
                    }
                },
                eventRender: function (event, element, view) {
                    $(element).attr("season", "true")
                    let day = moment(event.start).format("YYYY-MM-DD")
                    let top = $("td.fc-day-top[data-date='" + day + "']")
                    
                    let el = $("td.fc-day[data-date='" + day + "'][season='true']")
                    let myEvent = seasonEvents.get(day)
                    let textColor = event.textColor
                    let backgroundColor = event.backgroundColor
                    let borderColor = event.borderColor
                    let bgRGBA = hexToRgb(event.backgroundColor)
                    bgRGBA.push(.6)
                    let bgColor = "rgba(" + bgRGBA.join(', ') + ")"
                    
                    if (event.rendering === "background") {
                        if ($(element).hasClass("fc-disabled-day")) {
                            return
                        }
                        
                        YearCalendar.season_events.set(day, "true")
                        
                        top
                            .addClass("background_event")
                            .attr("data", event)
                        
                        let e = ""
                        let dayCell = document.querySelectorAll(`td.fc-day[season='true'][data-date='${day}']`)
                        
                        if (myEvent) {
                            $(el).addClass("has-event")
                            $(el).attr("seasons_types_id", event.id)
                            $(el).data("season", "true")
                            $(el).attr("data-seasonid", event.id)
                        }
                        
                        $(dayCell)
                            .addClass("background_event")
                            .attr("data", event)
                            .css({
                                "background": bgColor,
                                "color": textColor,
                            })
                        
                        $(element).attr("data-sid", event.id)
                        $(element).attr("data-date", day)
                        $(element).attr("season", "true")
                        $(element).attr("seasonid", event.id)
                        $(element).addClass("background_event")
                        $(element).attr("data", event)
                        $(element).css({
                            "background": bgColor,
                            "color": textColor,
                        })
                    }
                },
                eventClick: function (calEvent, jsEvent, view) {
                    //console.log('Event: ', calEvent)
                    //alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY)
                    //alert('View: ' + view.name)
                    
                    // change the border color just for fun
                    //$(this).css('border-color', 'red')
                },
                events: YearCalendar.events,
            })
            
            YearCalendar.activeCalendars.push(activeCal)
            
            let calendarWidth = (!isNaN(parseInt($(document.getElementById("calendar_block_1")).actual("width")))) ? parseInt($(document.getElementById("calendar_block_1")).actual("width")) : 600
            
            $.each(YearCalendar.activeCalendars, function (index, cal) {
                $(cal).fullCalendar("option", "contentHeight", calendarWidth)
            })
            
        })
        
    }
    
    const init = function (settings) {
        calendars = []
        
        if (settings) {
            if (settings.calendarType) {
                calendarType = settings.calendarType
            }
        }
        
        let dataToSend = {
            product_id: product_id,
        }
        
        fetchCalendarEvents(dataToSend, function (events) {
            if (!events) {
                events = []
            }
            
            YearCalendar.start = new Date().getFullYear()
            YearCalendar.loadSeasonDropdown()
            YearCalendar.loadProfileDropdown()
            YearCalendar.loadUnitDropdown()
            
            buildCalendar({
                events: events,
                start: YearCalendar.start,
            })
            
            YearCalendar.endLoading()
        })
        
        $(function () {
            YearCalendar.init(settings)
        })
        
    }
    
    init(settings)
    
    return {
        calendars: [],
    }
}

const YearCalendar = (function () {
    "use strict"
    const _calendar_display_remove = document.getElementById("calendar_display_remove")
    const _calendar_loader = document.getElementById("calendar_loader")
    const _seasonCalendarModal = document.getElementById("seasonCalendarModal")
    const _calendar_display_year = document.getElementById("calendar_display_year")
    const _calendar_display_next_year = document.getElementById("calendar_display_next_year")
    const _calendar_display_prev_year = document.getElementById("calendar_display_prev_year")
    const _calendar_filter_season_id = document.getElementById("calendar_filter_season_id")
    const _product_id = document.getElementById("product_id")
    const _calendar_filter_profile_id = document.getElementById("calendar_filter_profile_id")
    const _calendar_filter_unit_id = document.getElementById("calendar_filter_unit_id")
    const _calendar_filter_profile_id_assign = document.getElementById("calendar_filter_profile_id_assign")
    const _calendar_filter_profile_id_clear = document.getElementById("calendar_filter_profile_id_clear")
    const _calendar_filter_unit_id_assign = document.getElementById("calendar_filter_unit_id_assign")
    const _calendar_filter_unit_id_clear = document.getElementById("calendar_filter_unit_id_clear")
    const _calendar_filter_season_id_assign = document.getElementById("calendar_filter_season_id_assign")
    const _calendar_filter_season_id_clear = document.getElementById("calendar_filter_season_id_clear")
    const _calendar_display_refresh = document.getElementById("calendar_display_refresh")
    
    $(_calendar_display_remove)
        .on("click", function () {
            $(_calendar_loader).fadeIn("slow", function () {
                YearCalendar.remove()
                setCalendarFilters()
            })
        })
    
    $(_calendar_display_refresh)
        .on("click", function () {
            $(_calendar_loader).fadeIn("slow", function () {
                YearCalendar.refresh()
                setCalendarFilters()
            })
        })
    
    $(_calendar_display_next_year)
        .on("click", function () {
            $(_calendar_loader).fadeIn("slow", function () {
                YearCalendar.start = (parseInt(YearCalendar.start) + 1).toString()
                $.each(YearCalendar.activeCalendars, function (index, cal) {
                    $(cal).fullCalendar("nextYear")
                })
                getTitle()
                YearCalendar.endLoading()
            })
        })
    
    $(_calendar_display_prev_year)
        .on("click", function () {
            $(_calendar_loader).fadeIn("slow", function () {
                YearCalendar.start = (parseInt(YearCalendar.start) - 1).toString()
                $.each(YearCalendar.activeCalendars, function (index, cal) {
                    $(cal).fullCalendar("prevYear")
                })
                YearCalendar.getTitle()
                YearCalendar.endLoading()
            })
        })
    
    $(_calendar_filter_season_id)
        .on("change", function () {
            let season_id = (!isNaN(parseInt(_calendar_filter_season_id.value))) ? parseInt(_calendar_filter_season_id.value) : null
            if (!is_null(season_id)) {
            
            }
            let product_season_detail, season, disabled_dow
            if (!is_null(season_id)) {
                season = Season.all.get(season_id)
                if (season) {
                    if (season.product_season_detail) {
                        product_season_detail = season.product_season_detail
                    }
                }
                
                if (product_season_detail.disabled_dow) {
                    disabled_dow = getListOfIds(product_season_detail.disabled_dow)
                }
                _calendar_filter_profile_id.value = ""
                _calendar_filter_profile_id.disabled = true
                _calendar_filter_unit_id_assign.disabled = true
                _calendar_filter_season_id_assign.disabled = false
                _calendar_filter_profile_id.value = ""
                $(_calendar_filter_unit_id).val([])
            } else {
                _calendar_filter_season_id_assign.disabled = true
                _calendar_filter_profile_id.disabled = false
                _calendar_filter_unit_id_assign.disabled = true
            }
            setDisabledDOW(disabled_dow)
        })
    
    $(_calendar_filter_unit_id)
        .on("change", function () {
            let units = $(_calendar_filter_unit_id).val()
            _calendar_filter_unit_id_assign.disabled = units.length <= 0
        })
        .on("click", function () {
            let units = $(_calendar_filter_unit_id).val()
            _calendar_filter_unit_id_assign.disabled = units.length <= 0
        })
    
    $(_calendar_filter_profile_id)
        .on("change", function () {
            let profile_id = (!isNaN(parseInt(_calendar_filter_profile_id.value))) ? parseInt(_calendar_filter_profile_id.value) : null
            if (profile_id !== null) {
                _calendar_filter_unit_id.disabled = false
                _calendar_filter_season_id.disabled = true
            } else {
                $(_calendar_filter_unit_id).val([])
                _calendar_filter_unit_id.disabled = true
                _calendar_filter_season_id.disabled = false
            }
            
        })
    
    $(_calendar_filter_season_id_assign)
        .on("click", function () {
            buildAssignDatesRecord()
        })
    
    $(_calendar_filter_unit_id_assign)
        .on("click", function () {
            assignProfileToProduct()
        })
    
    $(_calendar_filter_season_id_clear)
        .on("click", function () {
            $(_calendar_filter_season_id).val("").trigger("change")
            setCalendarFilters()
        })
    
    $(_calendar_filter_unit_id_clear)
        .on("click", function () {
            $(_calendar_filter_unit_id).val([]).trigger("change")
            setCalendarFilters()
        })
    
    $(_calendar_filter_profile_id_clear)
        .on("click", function () {
            $(_calendar_filter_profile_id).val("").trigger("change")
            setCalendarFilters()
        })
    
    $(_seasonCalendarModal)
        .on("shown.bs.modal", function () {
            setCalendarFilters()
            $("html").css({ overflow: "hidden" })
        })
        .on("hidden.bs.modal", function () {
            resetForm()
            $("html").css({ overflow: "auto" })
        })
        .on("click", function () {
            YearCalendar.checkProgress()
        })
    
    const loadSeasonDropdown = function () {
        let seasons = (Season && Season.all) ? Array.from(Season.all.values()) : []
        let options = "<option value='' disabled readonly selected>-- Seasons --</option>"
        let options2 = ""
        
        $.each(seasons, function (k, season) {
            let name = season.name
            let id = season.id
            options += `<option value="${id}">${name}</option>`
            options2 += `<option value="${id}">${name}</option>`
        })
        
        $(_calendar_filter_season_id).empty()
        $(_calendar_filter_season_id).html(options)
        $(_calendar_filter_season_id).val("").trigger("change")
    }
    
    const loadProfileDropdown = function () {
        let profiles = (InventoryProfile && InventoryProfile.all) ? Array.from(InventoryProfile.all.values()) : []
        let options = "<option value='' disabled readonly selected>-- Profiles --</option>"
        
        $.each(profiles, function (k, profile) {
            let name = profile.name
            let id = profile.id
            options += `<option value="${id}">${name}</option>`
        })
        
        $(_calendar_filter_profile_id).empty()
        $(_calendar_filter_profile_id).html(options)
        $(_calendar_filter_profile_id).val("").trigger("change")
    }
    
    const loadUnitDropdown = function () {
        let units = (Unit && Unit.all) ? Array.from(Unit.all.values()) : []
        let options = ""
        
        $.each(units, function (k, unit) {
            let name = unit.name
            let id = unit.id
            options += `<option value="${id}">${name}</option>`
        })
        
        $(_calendar_filter_unit_id).empty()
        $(_calendar_filter_unit_id).html(options)
        $(_calendar_filter_unit_id).val([]).trigger("change")
        
    }
    
    const setCalendarFilters = function () {
        clearSelectedDOW()
    }
    
    const buildAssignDatesRecord = function () {
        let product_id = parseInt(_product_id.value)
        let season_id = parseInt(_calendar_filter_season_id.value)
        let season = Season.all.get(season_id)
        let disabledDOW = []
        let dataToSend = {
            season_id: season_id,
            product_id: product_id,
            days: [],
        }
        let days = Array.from(YearCalendar.selectedDates.values())
        
        if (season) {
            if (season.product_season_detail) {
                disabledDOW = getListOfIds(season.product_season_detail.disabled_dow)
            }
        }
        
        $.each(days, function (i, day) {
            const date = moment(day)
            const dow = date.day()
            
            let index = disabledDOW.indexOf(dow)
            
            if (index < 0) {
                dataToSend.days.push(day)
            }
        })
        
        confirmDialog(`Would you like to assign? This change may affect your Pricing Worksheets.`, (ans) => {
            if (ans) {
                $(_calendar_loader).fadeIn("slow", function () {
                    assignSeasonToProduct(dataToSend, function (data) {
                        if (data) {
                            clearSelected()
                            clearSelectedDOW()
                            refresh()
                            toastr.success(`Dates Assigned.`)
                        }
                        
                        endLoading()
                    })
                })
            }
        })
        
    }
    
    const handleCalendarError = function (msg) {
        toastr.error(msg)
    }
    
    const buildAssignProfilesRecord = function () {
        let profile_id = (_calendar_filter_profile_id && !is_null(parseInt(_calendar_filter_profile_id.value))) ? parseInt(_calendar_filter_profile_id.value) : null
        let product_id = (_product_id && !isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        let units = (_calendar_filter_unit_id) ? $(_calendar_filter_unit_id).val().map(Number) : []
        let profile
        let dataToSend = []
        let days = Array.from(YearCalendar.selectedDates.values())
        
        if (product_id && profile_id) {
            profile = InventoryProfile.all.get(profile_id)
            
            if (profile) {
                $.each(units, function (index, unit) {
                    
                    let unitData = {
                        product_id: product_id,
                        profile_id: profile_id,
                        unit_id: unit,
                        quantity_released: 0,
                        quantity_used: 0,
                        days: [],
                    }
                    
                    $.each(days, function (i, day) {
                        let hasSeason = YearCalendar.season_events.get(day)
                        if (hasSeason) {
                            unitData.days.push(day)
                        }
                    })
                    
                    if (unitData.days.length > 0) {
                        dataToSend.push(unitData)
                    }
                    
                })
            }
        }
        
        if (dataToSend.length > 0) {
            return dataToSend
        }
        
    }
    
    const assignProfileToProduct = function () {
        let dataToSend = buildAssignProfilesRecord()
        
        if (dataToSend) {
            
            confirmDialog(`Would you like to assign? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    $(_calendar_loader).fadeIn("slow", function () {
                        updateProductProfileCalendar(dataToSend, function (data) {
                            if (data) {
                                clearSelected()
                                clearSelectedDOW()
                                refresh()
                                toastr["success"](`Dates Assigned.`, `Inventory Profile`)
                            }
                            
                            endLoading()
                        })
                    })
                }
            })
            
        } else {
            toastr["warning"](`No Profiles to update.`, `Inventory Profile`)
            endLoading()
        }
        
    }
    
    const updateProductProfileCalendar = function (dataToSend, callback) {
        let url = "/api/v1.0/products/assign_profiles"
        if (dataToSend) {
            try {
                sendPostRequest(url, { params: dataToSend }, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleCalendarError("Oops: 1")
                        endLoading()
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleCalendarError("Oops: 2")
                endLoading()
            }
        }
    }
    
    const assignSeasonToProduct = function (dataToSend, callback) {
        let url = "/api/v1.0/products/assign_seasons"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleCalendarError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleCalendarError("Oops: 1")
            }
        }
    }
    
    const resetForm = function () {
        clearSelected()
        clearSelectedDOW()
        loadSeasonDropdown()
        loadUnitDropdown()
        loadProfileDropdown()
    }
    
    const setDisabledDOW = function (disabled_dow) {
        if (!disabled_dow) {
            disabled_dow = []
        }
        
        clearSelectedDOW()
        
        $.each(disabled_dow, function (k, dow) {
            let dataDOW = dow.toString()
            let days = $(`td[season='true'][dow='${dataDOW}']`)
            
            days.each(function (index, element) {
                let day = $(element).attr("data-date")
                $("td[data-date='" + day + "']").addClass("disabled-dow")
                $(element).addClass("disabled-dow")
            })
            
        })
        
    }
    
    const clearSelectedDOW = function () {
        let days = $("td[season='true']")
        
        days.each(function (index, element) {
            $(this).removeClass("disabled-dow")
        })
    }
    
    const clearSelected = function () {
        let days = $("td[season='true']")
        
        days.each(function (index, element) {
            $(this).removeClass("selected-day")
            $(this).attr("selected", "false")
        })
        
        YearCalendar.selectedDates = new Map()
    }
    
    const endLoading = function () {
        setCalendarFilters()
        $(_calendar_loader).hide()
    }
    
    const getTitle = function () {
        _calendar_display_year.innerText = YearCalendar.start
    }
    
    const init = function (settings) {
        _calendar_filter_unit_id.disabled = true
        _calendar_filter_season_id_assign.disabled = true
        _calendar_filter_unit_id_assign.disabled = true
        loadUnitDropdown()
        loadProfileDropdown()
        loadSeasonDropdown()
        
        //ContextMenu.init(settings)
    }
    
    const checkProgress = function () {
        //ContextMenu.init(settings)
    }
    
    const reFetchCalendarEvents = function (dataToSend, callback) {
        if (dataToSend) {
            try {
                sendGetRequest("/api/v1.0/calendars", dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return callback([])
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const removeAllEvents = function () {
        YearCalendar.events = []
        
        let bgEvents = document.querySelectorAll("td[season='true']")
        
        bgEvents.forEach(el => {
            $(el)
                .css({
                    "background": "initial",
                    "background-color": "initial",
                    "color": "initial",
                    "border-color": "#ddd",
                })
        })
        
        $.each(YearCalendar.activeCalendars, function (index, cal) {
            
            $(cal).fullCalendar("removeEvents")
        })
        
        YearCalendar.endLoading()
    }
    
    const refreshCalendar = function () {
        $(_calendar_loader).fadeIn("slow", function () {
            let product_id = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
            clearSelected()
            clearSelectedDOW()
            removeAllEvents()
            reFetchCalendarEvents({ product_id: product_id }, function (data) {
                YearCalendar.events = data
                
                $.each(YearCalendar.activeCalendars, function (index, cal) {
                    $(cal).fullCalendar("removeEvents")
                    $(cal).fullCalendar("addEventSource", YearCalendar.events)
                    $(cal).fullCalendar("rerenderEvents")
                })
                
                YearCalendar.endLoading()
            })
        })
        
    }
    
    const refresh = function () {
        resetForm()
        refreshCalendar()
    }
    
    return {
        calendarContextMenu: null,
        calendars: new Map(),
        events: [],
        start: new Date().getFullYear(),
        selectedDates: new Map(),
        activeCalendars: [],
        season_events: [],
        refresh: function () {
            refresh()
        },
        remove: function () {
            clearSelected()
            clearSelectedDOW()
            removeAllEvents()
        },
        checkProgress: function () {
            checkProgress()
        },
        endLoading: function () {
            endLoading()
        },
        loadSeasonDropdown: function () {
            loadSeasonDropdown()
        },
        loadProfileDropdown: function () {
            loadProfileDropdown()
        },
        loadUnitDropdown: function () {
            loadUnitDropdown()
        },
        getTitle: function () {
            getTitle()
        },
        clearSelected: function () {
            clearSelected()
        },
        init: function (settings) {
            init(settings)
        },
        resetForm: function () {
            resetForm()
        },
    }
})()


const ImageManager = (function () {
    "use strict"
    
    const _button_product_images_toggle = document.getElementById("button_product_images_toggle")
    const _imageManagerCancel = document.getElementById("imageManagerCancel")
    const _imageManagerFormRemoveButton = document.getElementById("imageManagerFormRemoveButton")
    const _fileDimensions = document.getElementById("fileDimensions")
    const _fileWidth = document.getElementById("fileWidth")
    const _fileHeight = document.getElementById("fileHeight")
    const _fileRatio = document.getElementById("fileRatio")
    const _imageManagerForm = document.getElementById("imageManagerForm")
    const _imageManagerFormImagesBlock = document.getElementById("imageManagerFormImagesBlock")
    const _imageManagerFormSubmitButton = document.getElementById("imageManagerFormSubmitButton")
    const _imageManagerFormCancelButton = document.getElementById("imageManagerFormCancelButton")
    const _imageManagerFormClearButton = document.getElementById("imageManagerFormClearButton")
    const _imageManagerFormDetails = document.getElementById("imageManagerFormDetails")
    const _fileName = document.getElementById("fileName")
    const _fileType = document.getElementById("fileType")
    const _fileExtension = document.getElementById("fileExtension")
    const _fileSize = document.getElementById("fileSize")
    const _image_id = document.getElementById("image_id")
    const _image_name = document.getElementById("image_name")
    const _image_title = document.getElementById("image_title")
    const _image_alt = document.getElementById("image_alt")
    const _image_caption = document.getElementById("image_caption")
    const _fileToUpload = document.getElementById("fileToUpload")
    const _image_enabled = document.getElementById("image_enabled")
    const _image_is_cover = document.getElementById("image_is_cover")
    const _image_is_shown = document.getElementById("image_is_shown")
    const _imageManagerPreview = document.getElementById("imageManagerPreview")
    
    let userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let source, sourceId, img_toggle
    let imageType = new Map()
    let imageFormRules = {
        rules: {
            image_name: {
                required: true,
            },
            image_title: {
                required: true,
            },
            image_alt: {
                required: true,
            },
            image_caption: {
                required: true,
            },
        },
        messages: {
            image_name: {
                required: "Field Required",
            },
            image_title: {
                required: "Field Required",
            },
            image_alt: {
                required: "Field Required",
            },
            image_caption: {
                required: "Field Required",
            },
        },
    }
    let currentImage = null
    let currentImageCover = null
    let currentImageShown = null
    
    imageType.set("png", "image/png")
    imageType.set("jpg", "image/jpeg")
    imageType.set("gif", "image/gif")
    imageType.set("webp", "image/webp")
    
    $(_fileToUpload)
        .on("change", function (event) {
            if ($(this).val() !== "") {
                fileSelected(event)
            } else {
                resetFileInput(event)
            }
        })
    
    $(_imageManagerFormSubmitButton)
        .on("click", function (event) {
            submit(event)
        })
    
    $(_imageManagerFormClearButton)
        .on("click", function () {
            clear()
        })
    
    $(_imageManagerFormCancelButton)
        .on("click", function () {
            clear()
            hideImageForm()
        })
    
    $(_imageManagerCancel)
        .on("click", function () {
            clear()
            hideImageForm()
        })
    
    $(_imageManagerFormRemoveButton)
        .on("click", function () {
            let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
            
            if (imageId !== null) {
                confirmDialog(`Would you like to delete this image?`, (ans) => {
                    if (ans) {
                        remove(imageId)
                    }
                })
            }
        })
    
    $(_image_is_shown)
        .on("change", function () {
            console.log("ImageManager.image_is_shown:change()", _image_is_shown.checked)
            let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
            let el = document.getElementById("image_" + imageId + "")
            currentImage = imageId
            if (!_image_is_shown.checked) {
                if (_image_is_cover.checked) {
                    currentImageCover = imageId
                    _image_is_cover.checked = false
                    $(el).removeClass("is-cover-image")
                }
                $(el).removeClass("is-shown")
                currentImageShown = true
            } else {
                currentImageShown = false
                $(el).addClass("is-shown")
            }
        })
    
    $(_image_is_cover)
        .on("change", function () {
            console.log("ImageManager.is_cover:change()", _image_is_cover.checked)
            let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
            let el = document.getElementById("image_" + imageId + "")
            
            currentImageCover = (!isNaN(parseInt($(".img-thumbnail.is-cover-image").data("id")))) ? parseInt($(".img-thumbnail.is-cover-image").data("id")) : null
            currentImageShown = (_image_is_shown) ? _image_is_shown.checked : null
            
            if (_image_is_cover.checked) {
                if (!_image_is_shown.checked) {
                    _image_is_shown.checked = true
                }
                
                $(".img-thumbnail.is-cover-image").removeClass("is-cover-image")
                $(el).addClass("is-cover-image is-shown")
            }
        })
    
    $("#button_product_images_toggle")
        .on("click", function () {
            $(_fileToUpload).trigger("click")
        })
    
    const handleImageManagerError = function (msg, title, level) {
        if (!title) {
            title = "Image"
        }
        
        if (!level) {
            level = "success"
        }
        
        toastr[level](`${msg}`, title)
    }
    
    const remove = function (image_id) {
        console.log("ImageManager.remove(image_id)", image_id)
        if (!image_id || !ImageManager.source || !ImageManager.sourceId) {
            return
        }
        
        let dataToSend = {
            image_id: image_id,
            source: ImageManager.source,
            source_id: ImageManager.sourceId,
        }
        
        console.log("|__ dataToSend", dataToSend)
        
        sendRemoveRequest({
            image_id: image_id,
            source: ImageManager.source,
            source_id: ImageManager.sourceId,
        }, function (data) {
            if (data) {
                console.log("data", data)
            }
        })
    }
    
    const sendRemoveRequest = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/images/remove"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                console.log("error", e)
                return handleImageManagerError("Error Removing Image.", "Image Manager", "error")
            }
        }
    }
    
    const submit = function (event) {
        console.log("ImageManager.submit(event)", event)
        let isValid = validate()
        if (isValid) {
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    uploadFile(event)
                }
            })
        }
    }
    
    const validate = function () {
        return $(_imageManagerForm).valid()
    }
    
    const sendUpdateRequest = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/images/update"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                console.log("error", e)
                return handleImageManagerError("Error", "Image Manager", "error")
            }
        }
    }
    
    const uploadFile = function (event) {
        console.log("ImageManager.uploadFile(event)", event)
        const _fileToUpload = document.getElementById("fileToUpload")
        let filePath, fileHeight, fileWidth, fileSize, fileExtension, fileName,
            fileType, fileRatio, ratioHeight, ratioWidth, fileDimensions, source, sourceId,
            fileTitle, fileAlt, fileCaption, fileIsShown, fileIsCover, fileEnabled, fileId,
            fileThumbsPath = null
        let formData = new FormData()
        let xhr = new XMLHttpRequest()
        
        fileId = (_image_id && !isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
        fileCaption = (_image_caption && _image_caption.value !== "") ? _image_caption.value : null
        fileTitle = (_image_title && _image_title.value !== "") ? _image_title.value : null
        fileAlt = (_image_alt && _image_alt.value !== "") ? _image_alt.value : null
        fileIsShown = (_image_is_shown && _image_is_shown.checked === true) ? 1 : 0
        fileEnabled = (_image_enabled && _image_enabled.checked === true) ? 1 : 0
        fileIsCover = (_image_is_cover && _image_is_cover.checked === true) ? 1 : 0
        
        if (fileId !== null) {
            fileName = document.getElementById("fileName").innerText
            fileExtension = (document.getElementById("fileExtension")) ? document.getElementById("fileExtension").innerText : null
            fileSize = (document.getElementById("fileSize")) ? document.getElementById("fileSize").innerText : null
            fileDimensions = (document.getElementById("fileDimensions")) ? document.getElementById("fileDimensions").innerText : null
            fileWidth = (document.getElementById("fileWidth")) ? (!isNaN(parseInt(document.getElementById("fileWidth").innerText))) ? parseInt(document.getElementById("fileWidth").innerText) : null : null
            fileHeight = (document.getElementById("fileHeight")) ? (!isNaN(parseInt(document.getElementById("fileHeight").innerText))) ? parseInt(document.getElementById("fileHeight").innerText) : null : null
            
            let dataToSend = removeNulls({
                id: fileId,
                name: fileName,
                alt: fileAlt,
                title: fileTitle,
                caption: fileCaption,
                is_cover: fileIsCover,
                path: `/public/img/${ImageManager.source}/${ImageManager.sourceId}`,
                thumbs_path: `/public/thumbs/${ImageManager.source}/${ImageManager.sourceId}`,
                extension: fileExtension,
                dimensions: fileDimensions,
                size: fileSize,
                height: fileHeight,
                width: fileWidth,
                enabled: fileEnabled,
                directory: ImageManager.source,
                directory_id: ImageManager.sourceId,
                is_shown: fileIsShown,
            })
            
            console.log("dataToSend", dataToSend)
            
            sendUpdateRequest(dataToSend, function (data) {
                if (data) {
                    let detail = set((data[0]) ? data[0] : data)
                    console.log("|__ detail", detail)
                    let image = ImageManager.all.get(detail.id)
                    console.log("|__ image", image)
                    if (image) {
                    
                    }
                    
                    ImageManager.all.set(detail.id, detail)
                    
                    toastr["success"](`Image Manager: ${detail.name} - has been updated`, "Image Manager")
                }
            })
            
        } else {
            buildImageObject(event, function (data) {
                console.log("|__ data", data)
                source = data.source
                sourceId = data.source_id
                filePath = (data.path) ? data.path : null
                fileHeight = (!isNaN(parseInt(data.height))) ? parseInt(data.height) : null
                fileWidth = (!isNaN(parseInt(data.width))) ? parseInt(data.width) : null
                fileName = (data.name) ? data.name : null
                fileExtension = (data.extension) ? data.extension : null
                fileSize = (data.size) ? data.size : null
                fileRatio = (data.ratio) ? data.ratio : null
                fileType = (data.type) ? data.type : null
                fileThumbsPath = data.thumbs_path
                fileDimensions = (data.dimensions) ? data.dimensions : null
                
                formData.append("dimensions", fileDimensions)
                formData.append("extension", fileExtension)
                formData.append("file", _fileToUpload.files[0], `${fileName}.${fileExtension}`)
                formData.append("height", fileHeight)
                formData.append("name", fileName)
                formData.append("path", filePath)
                formData.append("thumbs_path", fileThumbsPath)
                formData.append("ratio", fileRatio)
                formData.append("size", fileSize)
                formData.append("type", fileType)
                formData.append("width", fileWidth)
                formData.append("directory", source)
                formData.append("directory_id", sourceId)
                formData.append("title", fileTitle)
                formData.append("enabled", fileEnabled)
                formData.append("is_shown", fileIsShown)
                formData.append("is_cover", fileIsCover)
                formData.append("alt", fileAlt)
                formData.append("caption", fileCaption)
                
                xhr.upload.addEventListener("progress", uploadProgress, false)
                xhr.addEventListener("load", uploadComplete, false)
                xhr.addEventListener("error", uploadFailed, false)
                xhr.addEventListener("abort", uploadCanceled, false)
                
                switch (source.toLowerCase()) {
                    case "product":
                        xhr.open("POST", "/api/v1.0/upload/product")
                        xhr.send(formData)
                        break
                    case "unit":
                        console.log("|__ |__ unit")
                        break
                    case "company":
                        console.log("|__ |__ company")
                        break
                    case "user":
                        console.log("|__ |__ user")
                        break
                    default:
                        return
                }
            })
        }
        
    }
    
    const uploadProgress = function (event) {
        console.log("ImageManager.uploadProgress(event)", event)
        if (event.lengthComputable) {
            let percentComplete = Math.round(event.loaded * 100 / event.total)
            document.getElementById("progressNumber").innerHTML = percentComplete.toString() + "%"
        } else {
            document.getElementById("progressNumber").innerHTML = "unable to compute"
        }
    }
    
    const uploadComplete = function (event) {
        console.log("ImageManager.uploadComplete(event)", event)
        let results = null
        
        if (event) {
            if (event.target) {
                if (event.target.responseText) {
                    const image = JSON.parse(event.target.responseText)
                    
                    if (image) {
                        if (image.status) {
                            if (image.status === "success" && image.result) {
                                results = image.result
                                if (image.result.length === 1) {
                                    results = image.result[0]
                                }
                                let detail = set(results)
                                let allImages = Array.from(ImageManager.all.values())
                                let counter = allImages.length
                                
                                console.log("|__ image", detail)
                                
                                $(_imageManagerFormImagesBlock).append(buildImageThumbnail(detail))
                                
                                ImageManager.all.set(detail.id, detail)
                                
                                console.log("|__ ImageManager.all", ImageManager.all)
                                console.log("|__ detail", detail)
                                
                                clear()
                                hideImageForm()
                                
                                toastr["success"](`Image was added.`, "Image Manager")
                            }
                        }
                    }
                }
            }
        }
    }
    
    const uploadFailed = function (event) {
        console.log("ImageManager.uploadFailed(event)", event)
        console.log("There was an error attempting to upload this file.")
    }
    
    const uploadCanceled = function (event) {
        console.log("ImageManager.uploadCanceled(event)", event)
        console.log("This upload has been canceled by the user or the browser dropped the connection.")
    }
    
    const defaultDetail = function () {
        return {
            alt: null,
            caption: null,
            created_by: userId,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            dimensions: null,
            enabled: 1,
            extension: null,
            height: null,
            id: null,
            is_cover: 0,
            is_shown: 1,
            modified_by: userId,
            name: null,
            note: null,
            path: null,
            size: null,
            thumbs_path: null,
            title: null,
            width: null,
        }
    }
    
    const set = function (image) {
        console.log("ImageManager.set(image)", image)
        let detail = defaultDetail()
        if (image) {
            detail.alt = (image.alt) ? image.alt : null
            detail.caption = (image.caption) ? image.caption : null
            detail.created_by = (image.created_by) ? image.created_by : userId
            detail.date_created = (image.date_created) ? image.date_created : formatDateMySQL()
            detail.date_modified = (image.date_modified) ? image.date_modified : formatDateMySQL()
            detail.dimensions = (image.dimensions) ? image.dimensions : null
            detail.enabled = (!isNaN(parseInt(image.enabled))) ? parseInt(image.enabled) : 1
            detail.extension = (image.extension) ? image.extension : null
            detail.height = (image.height) ? image.height : null
            detail.id = (!isNaN(parseInt(image.id))) ? parseInt(image.id) : null
            detail.is_cover = (image.is_cover) ? image.is_cover : 0
            detail.is_shown = (image.is_shown && image.is_shown === 1) ? 1 : 0
            detail.modified_by = (image.modified_by) ? image.modified_by : userId
            detail.name = (image.name) ? image.name : null
            detail.note = (image.note) ? image.note : null
            detail.path = (image.path) ? image.path : null
            detail.size = (image.size) ? image.size : null
            detail.thumbs_path = (image.thumbs_path) ? image.thumbs_path : null
            detail.title = (image.title) ? image.title : null
            detail.width = (image.width) ? image.width : null
        }
        
        ImageManager.detail = detail
        return detail
    }
    
    const resetFileInput = function (event) {
        console.log("ImageManager.resetFileInput(event)", event)
        let _fileToUpload = document.getElementById("fileToUpload")
        let _fileName = document.getElementById("fileName")
        let _fileSize = document.getElementById("fileSize")
        let _fileType = document.getElementById("fileType")
        let _fileExtension = document.getElementById("fileExtension")
        let _imageManagerPreview = document.getElementById("imageManagerPreview")
        let _fileToUploadDisplay = document.getElementById("fileToUploadDisplay")
        
        $(_fileName).html("&nbsp;")
        $(_fileSize).html("&nbsp;")
        $(_fileType).html("&nbsp;")
        $(_fileExtension).html("&nbsp;")
        $(_fileToUploadDisplay).html("CHOOSE FILE")
        $(_imageManagerPreview).attr("src", "/public/img/placeholder.jpg")
        _image_is_shown.checked = true
    }
    
    const clear = function () {
        resetFileInput()
        resetImageForm()
        $("img.img-thumbnail").removeClass("selected")
    }
    
    const getFileSize = function (file) {
        let fileSize = null
        
        if (file.size > 1024 * 1024) {
            fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB'
        } else {
            fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB'
        }
        
        return fileSize
    }
    
    const getFileName = function (file) {
        let fileName, fileExtension = null
        let fileNameTemp = []
        
        if (file) {
            if (file.name) {
                let fileNameParts = file.name.split(".")
                
                if (fileNameParts.length) {
                    fileExtension = fileNameParts[fileNameParts.length - 1]
                    for (let n = 0; n < fileNameParts.length - 1; n++) {
                        fileNameTemp.push(fileNameParts[n])
                    }
                    fileName = fileNameTemp.join(".")
                }
                
            }
        }
        
        return removeNulls({
            "name": fileName,
            "extension": fileExtension,
        })
    }
    
    const getFileType = function (file) {
        let fileType = null
        
        if (file) {
            if (file.type) {
                fileType = file.type
            }
        }
        
        return fileType
    }
    
    const buildImageObject = function (event, callback) {
        console.log("ImageManager.buildImageObject(event)", event)
        const _fileToUpload = document.getElementById("fileToUpload")
        const _imageManagerPreview = document.getElementById("imageManagerPreview")
        const _imageManagerForm = document.getElementById("imageManagerForm")
        const reader = new FileReader()
        const img = new Image()
        
        let filePath, fileHeight, fileWidth, fileSize, fileExtension, fileName,
            fileType, fileRatio, ratioHeight, ratioWidth, fileDimensions, source, sourceId,
            fileThumbsPath, filePathFull, fileThumbsPathFull = null
        
        if (event) {
            if (_imageManagerForm) {
                if (_imageManagerForm.dataset.source) {
                    source = (_imageManagerForm.dataset.source) ? _imageManagerForm.dataset.source : null
                    sourceId = (_imageManagerForm.dataset.sourceId && !isNaN(parseInt(_imageManagerForm.dataset.sourceId))) ? parseInt(_imageManagerForm.dataset.sourceId) : null
                    filePath = `/public/img/${source}/${sourceId}`
                    fileThumbsPath = `/public/thumbs/${source}/${sourceId}`
                    
                    if (_fileToUpload) {
                        let file = _fileToUpload.files[0]
                        console.log("|__ file", file)
                        $(_imageManagerPreview).attr("src", event.result)
                        
                        if (file) {
                            let fileNameParts = getFileName(file)
                            console.log("|__ |__ fileNameParts", fileNameParts)
                            fileExtension = (fileNameParts.extension) ? fileNameParts.extension : null
                            fileName = (fileNameParts.name) ? fileNameParts.name : null
                            fileSize = getFileSize(file)
                            fileType = getFileType(file)
                            filePathFull = filePath + "/" + fileName + "." + fileExtension
                            fileThumbsPathFull = fileThumbsPath + "/" + fileName + "." + fileExtension
                            
                            reader.onload = function (e) {
                                img.onload = function () {
                                    fileHeight = (this.height) ? this.height : null
                                    fileWidth = (this.width) ? this.width : null
                                    if (!is_null(fileWidth) && !is_null(fileHeight)) {
                                        let ratio = gcd(fileWidth, fileHeight)
                                        fileDimensions = `${fileWidth} x ${fileHeight}`
                                        ratioHeight = fileHeight / ratio
                                        ratioWidth = fileWidth / ratio
                                        fileRatio = `${ratioWidth}:${ratioHeight}`
                                    } else {
                                        console.error("Missing Height or Width")
                                    }
                                    
                                    return callback({
                                        "file": file,
                                        "source": source,
                                        "source_id": (!isNaN(parseInt(sourceId))) ? parseInt(sourceId) : null,
                                        "name": (!is_null(fileName)) ? fileName : null,
                                        "height": (!isNaN(parseInt(fileHeight))) ? parseInt(fileHeight) : null,
                                        "width": (!isNaN(parseInt(fileWidth))) ? parseInt(fileWidth) : null,
                                        "path": (!is_null(filePath)) ? filePath : null,
                                        "full_path": (!is_null(filePathFull)) ? filePathFull : null,
                                        "full_thumbs_path": (!is_null(fileThumbsPathFull)) ? fileThumbsPathFull : null,
                                        "thumbs_path": (!is_null(fileThumbsPath)) ? fileThumbsPath : null,
                                        "size": (!is_null(fileSize)) ? fileSize : null,
                                        "extension": (!is_null(fileExtension)) ? fileExtension : null,
                                        "type": (!is_null(fileType)) ? fileType : null,
                                        "ratio": (!is_null(fileRatio)) ? fileRatio : null,
                                        "dimensions": (!is_null(fileDimensions)) ? fileDimensions : null,
                                    })
                                }
                                
                                img.src = e.target.result
                            }
                            reader.readAsDataURL(_fileToUpload.files[0])
                        }
                    }
                }
            }
        }
    }
    
    const fileSelected = function (event) {
        console.log("ImageManager.fileSelected(event)", event)
        clear()
        
        let _fileToUpload = document.getElementById("fileToUpload")
        let _fileName = document.getElementById("fileName")
        let _fileSize = document.getElementById("fileSize")
        let _fileType = document.getElementById("fileType")
        let _fileExtension = document.getElementById("fileExtension")
        let _imageManagerPreview = document.getElementById("imageManagerPreview")
        let _fileToUploadDisplay = document.getElementById("fileToUploadDisplay")
        
        buildImageObject(event, function (data) {
            if (data) {
                console.log("|__ data", data)
                let fileName = (data.name) ? data.name : null
                let fileSize = (data.size) ? data.size : null
                let fileType = (data.type) ? data.type : null
                let fileExtension = (data.extension) ? data.extension : null
                let fileRatio = (data.ratio) ? data.ratio : null
                let fileDimensions = (data.dimensions) ? data.dimensions : null
                let fileWidth = (data.width) ? data.width : null
                let fileHeight = (data.height) ? data.height : null
                let reader = new FileReader()
                
                $(_fileName).html(fileName)
                $(_fileSize).html(fileSize)
                $(_fileType).html(fileType)
                $(_fileExtension).html(fileExtension)
                $(_fileToUploadDisplay).html(fileName)
                $(_fileRatio).html(fileRatio)
                $(_fileWidth).html(fileWidth)
                $(_fileHeight).html(fileHeight)
                $(_fileDimensions).html(fileDimensions)
                
                $(_imageManagerPreview).attr("src")
                $(_image_id).val("")
                $(_image_name).val(fileName)
                
                reader.onload = function (e) {
                    $(_imageManagerPreview).attr("src", e.target.result)
                }
                reader.readAsDataURL(_fileToUpload.files[0])
                renderImageForm()
            }
        })
    }
    
    const hideImageForm = function () {
        console.log("ImageManager.hideImageForm()")
        $(_fileToUpload).removeClass("disabled")
        $(_button_product_images_toggle).removeClass("disabled")
        
        _fileToUpload.disabled = false
        _button_product_images_toggle.disabled = false
        
        _imageManagerFormSubmitButton.innerText = "choose file"
        
        $(_imageManagerFormDetails).hide()
    }
    
    const renderImageForm = function () {
        console.log("ImageManager.renderImageForm()")
        $(_fileToUpload).addClass("disabled")
        $(_button_product_images_toggle).addClass("disabled")
        
        _fileToUpload.disabled = true
        _button_product_images_toggle.disabled = true
        $("#imageManagerFormDetails").show()
    }
    
    const populateImageForm = function (image) {
        console.log("ImageManager.populateImageForm(image)", image)
        
        if (image) {
            console.log(image)
            let fileType = (image.extension) ? imageType.get(image.extension) : null
            let fileAlt = (image.alt) ? image.alt : null
            let fileCaption = (image.caption) ? image.caption : null
            let fileCreatedBy = (!isNaN(parseInt(image.created_by))) ? parseInt(image.created_by) : userId
            let fileDateCreated = (image.date_created) ? image.date_created : formatDateMySQL()
            let fileDateModified = (image.date_modified) ? image.date_modified : formatDateMySQL()
            let fileDimensions = (image.dimensions) ? image.dimensions : null
            let fileEnabled = (image.enabled && image.enabled === 1)
            let fileExtension = (image.extension) ? image.extension : null
            let fileHeight = (!isNaN(parseInt(image.height))) ? parseInt(image.height) : null
            let fileId = (!isNaN(parseInt(image.id))) ? parseInt(image.id) : null
            let fileIsCoverImage = !!(image.is_cover && image.is_cover === 1)
            let fileIsShown = !!(image.is_shown && image.is_shown === 1)
            let fileModifiedBy = (!isNaN(parseInt(image.modified_by))) ? parseInt(image.modified_by) : userId
            let fileName = (image.name) ? image.name : null
            let fileNote = (image.note) ? image.note : null
            let filePath = (image.path) ? image.path : null
            let fileSize = (image.size) ? image.size : null
            let fileTitle = (image.title) ? image.title : null
            let fileWidth = (!isNaN(parseInt(image.width))) ? parseInt(image.width) : null
            let ratio = gcd(fileWidth, fileHeight)
            let ratioHeight = fileHeight / ratio
            let ratioWidth = fileWidth / ratio
            let fileRatio = `${ratioWidth}:${ratioHeight}`
            let filePreview = `${filePath}/${fileName}.${fileExtension}`
            
            _fileName.innerHTML = fileName
            _fileType.innerHTML = fileType
            _fileExtension.innerHTML = fileExtension
            _fileSize.innerHTML = fileSize
            _fileRatio.innerHTML = fileRatio
            _fileDimensions.innerHTML = fileDimensions
            _fileWidth.innerHTML = fileWidth
            _fileHeight.innerHTML = fileHeight
            _image_id.value = fileId
            _image_name.value = fileName
            _image_title.value = fileTitle
            _image_alt.value = fileAlt
            _image_caption.value = fileCaption
            
            _image_enabled.checked = fileEnabled
            _image_is_cover.checked = fileIsCoverImage
            _image_is_shown.checked = fileIsShown
            
            $(_imageManagerPreview)
                .attr("src", filePreview)
            
            renderImageForm()
        }
        
    }
    
    const resetImageForm = function () {
        console.log("ImageManager.resetImageForm()")
        let filePreview = `/public/img/placeholder.jpg`
        
        _fileName.innerHTML = "&nbsp;"
        _fileType.innerHTML = "&nbsp;"
        _fileExtension.innerHTML = "&nbsp;"
        _fileSize.innerHTML = "&nbsp;"
        _fileRatio.innerHTML = "&nbsp;"
        _fileWidth.innerHTML = "&nbsp;"
        _fileHeight.innerHTML = "&nbsp;"
        _fileDimensions.innerHTML = "&nbsp;"
        
        _image_id.value = ""
        _image_name.value = ""
        _image_title.value = ""
        _image_alt.value = ""
        _image_caption.value = ""
        
        _image_enabled.checked = true
        _image_is_cover.checked = false
        _image_is_shown.checked = true
        
        $(_imageManagerPreview)
            .attr("src", filePreview)
        
        if (currentImage !== null) {
            let isCover = (currentImageCover !== null && currentImageCover === true) ? "is-cover-image" : ""
            let isShown = (currentImageCover !== null && currentImageCover === true) ? "is-shown" : ""
            $(".img-thumbnail.is-cover-image").removeClass("is-cover-image")
            $("#image_" + currentImage).addClass(`${isCover} ${isShown}`)
            currentImage = null
            currentImageCover = null
            currentImageShown = null
        }
        
        $("img.img-thumbnail").removeClass("selected")
    }
    
    const edit = function (image) {
        console.log("ImageManager.edit(image)", image)
        if (image) {
            clear()
            let imageId = (!isNaN(parseInt(image.id))) ? image.id : null
            let elementId = (imageId) ? "image_" + imageId.toString() : null
            let imageElement = document.getElementById(elementId)
            if (imageElement) {
                $(imageElement).addClass("selected")
                populateImageForm(image)
                _imageManagerFormSubmitButton.innerText = "Save"
            }
        }
    }
    
    const buildImageThumbnail = function (image) {
        console.log("ImageManager.buildImageThumbnail(image)", image)
        let isCoverClass = ""
        let isShownClass = ""
        
        if (image) {
            let src = (image.path) ? image.path : null
            let alt = (image.alt) ? image.alt : null
            let imageId = (image.id && !isNaN(parseInt(image.id))) ? parseInt(image.id) : null
            let isCover = !!(image.is_cover && image.is_cover === 1)
            let isShown = !!(image.is_shown && image.is_shown === 1)
            let thumbsPath = (image.thumbs_path) ? image.thumbs_path : null
            let path = (image.path) ? image.path : null
            let name = (image.name) ? image.name : null
            let extension = (image.extension) ? image.extension : null
            
            if (isCover) {
                isCoverClass = "is-cover-image"
            }
            
            if (isShown) {
                isShownClass = "is-shown"
            }
            
            if (thumbsPath !== null && path !== null && name !== null && extension !== null) {
                let $IMG = $("<img/>", {
                    id: "image_" + imageId,
                    attr: {
                        "data-id": imageId,
                    },
                    class: `img-thumbnail ${isCoverClass} ${isShownClass}`,
                    alt: alt,
                    src: `${thumbsPath}/${name}.${extension}`,
                })
                    .on("click", function () {
                        let el = this
                        let image_id = (el.dataset.id && !isNaN(parseInt(el.dataset.id))) ? parseInt(el.dataset.id) : null
                        
                        if (image_id) {
                            let image = ImageManager.all.get(image_id)
                            
                            if (image) {
                                edit(image)
                            } else {
                                console.log("|__ |__ ImageManager.all", ImageManager.all)
                            }
                            
                        } else {
                            console.log("nope")
                        }
                    })
                
                return $("<div/>", {
                    class: "col-12 col-md-4 mb-2",
                })
                    .append($IMG)
            }
            
        }
    }
    
    const loadAll = function (images) {
        console.log("ImageManager.loadAll(images)", images)
        ImageManager.all = new Map()
        
        if (images) {
            let counter = 0
            $.each(images, function (k, image) {
                let detail = set(image)
                ImageManager.all.set(detail.id, detail)
                $(_imageManagerFormImagesBlock).append(buildImageThumbnail(detail))
            })
        }
        
    }
    
    const get = function (dataToSend, callback) {
        console.log("ImageManager.get()")
        
        if (dataToSend) {
            let url = `/api/v1.0/images/${ImageManager.source}/${ImageManager.sourceId}`
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                console.log("error", e)
                return handleImageManagerError("Error Retrieving Images.", "Image Manager", "error")
            }
        }
    }
    
    const init = function (options) {
        console.log("ImageManager.init(settings)", options)
        
        if (options && options.source) {
            source = (options.source) ? options.source : null
            sourceId = (options.id && !isNaN(parseInt(options.id))) ? parseInt(options.id) : null
            //let images = (options.images) ? options.images : []
            
            $(_imageManagerFormImagesBlock).empty()
            //loadAll(images)
            hideImageForm()
            
            initializeValidator(imageFormRules)
            
            ImageManager.source = source
            ImageManager.sourceId = sourceId
            ImageManager.validator = $(_imageManagerForm).validate()
            
            get({}, function (images) {
                loadAll(images)
            })
            
        }
    }
    
    return {
        source: null,
        sourceId: null,
        detail: {},
        all: new Map(),
        init: function (options) {
            return init(options)
        },
    }
    
})()


const LocationTypes = (function () {
    "use strict"
    
    const base_url = "/location_types"
    const _input_location_types_id = document.getElementById("input_location_types_id")
    const _input_location_types_name = document.getElementById("input_location_types_name")
    const _input_location_types_icon = document.getElementById("input_location_types_icon")
    const _input_location_types_sort_order = document.getElementById("input_location_types_sort_order")
    const _input_location_types_enabled = document.getElementById("input_location_types_enabled")
    const _input_location_types_date_created = document.getElementById("input_location_types_date_created")
    const _input_location_types_created_by = document.getElementById("input_location_types_created_by")
    const _input_location_types_date_modified = document.getElementById("input_location_types_date_modified")
    const _input_location_types_modified_by = document.getElementById("input_location_types_modified_by")
    const _input_location_types_note = document.getElementById("input_location_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_location_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            icon: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(" -- LocationTypes -- ", {})
    }
    
    const set = function (location_types) {
        let detail = _default_detail()
        if (location_types) {
            detail.id = (location_types.id) ? location_types.id : null
            detail.name = (location_types.name) ? location_types.name : null
            detail.icon = (location_types.icon) ? location_types.icon : null
            detail.sort_order = (location_types.sort_order) ? location_types.sort_order : null
            detail.enabled = (location_types.enabled) ? location_types.enabled : 1
            detail.date_created = (location_types.date_created) ? location_types.date_created : formatDateMySQL()
            detail.created_by = (location_types.created_by) ? location_types.created_by : created_by
            detail.date_modified = (location_types.date_modified) ? location_types.date_modified : formatDateMySQL()
            detail.modified_by = (location_types.modified_by) ? location_types.modified_by : modified_by
            detail.note = (location_types.note) ? location_types.note : null
        }
        
        LocationTypes.detail = detail
        return detail
    }
    
    const load_all = function (location_types) {
        LocationTypes.all = new Map()
        
        if (!location_types) {
            return
        }
        $.each(location_types, function (i, location_types) {
            let detail = set(location_types)
            LocationTypes.all.set("id", detail)
        })
        
        //console.log(" LocationTypes.all", LocationTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

//LocationTypes.init()
//end object



/**
 *
 * @type {{all: Map<any, any>, init: AddressTypes.init, get: AddressTypes.get, validator: null, save: AddressTypes.save, detail: {}, load_all: AddressTypes.load_all}}
 */
const AddressTypes = (function () {
    "use strict"
    const base_url = "/address_types"
    const _input_address_types_id = document.getElementById("input_address_types_id")
    const _input_address_types_name = document.getElementById("input_address_types_name")
    const _input_address_types_sort_order = document.getElementById("input_address_types_sort_order")
    const _input_address_types_enabled = document.getElementById("input_address_types_enabled")
    const _input_address_types_date_created = document.getElementById("input_address_types_date_created")
    const _input_address_types_created_by = document.getElementById("input_address_types_created_by")
    const _input_address_types_date_modified = document.getElementById("input_address_types_date_modified")
    const _input_address_types_modified_by = document.getElementById("input_address_types_modified_by")
    const _input_address_types_note = document.getElementById("input_address_types_note")
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_address_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
    
    }
    
    const set = function (address_types) {
        let detail = _default_detail()
        if (address_types) {
            detail.id = (address_types.id) ? address_types.id : null
            detail.name = (address_types.name) ? address_types.name : null
            detail.sort_order = (address_types.sort_order) ? address_types.sort_order : null
            detail.enabled = (address_types.enabled) ? address_types.enabled : 1
            detail.date_created = (address_types.date_created) ? address_types.date_created : formatDateMySQL()
            detail.created_by = (address_types.created_by) ? address_types.created_by : created_by
            detail.date_modified = (address_types.date_modified) ? address_types.date_modified : formatDateMySQL()
            detail.modified_by = (address_types.modified_by) ? address_types.modified_by : modified_by
            detail.note = (address_types.note) ? address_types.note : null
        }
        
        AddressTypes.detail = detail
        return detail
    }
    
    const load_all = function (address_types) {
        AddressTypes.all = new Map()
        
        if (!address_types) {
            return
        }
        $.each(address_types, function (i, address_types) {
            let detail = set(address_types)
            AddressTypes.all.set("id", detail)
        })
        
        //console.log(" AddressTypes.all", AddressTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

const City = (function () {
    "use strict"
    
    const class_name = "form-new-city"
    const form_id = "form_new_city"
    
    const _product_location_departing_airport_city_search = document.getElementById("product_location_departing_airport_city_search")
    const _product_location_departing_airport_city_id = document.getElementById("product_location_departing_airport_city_id")
    const _product_location_arriving_airport_city_id = document.getElementById("product_location_arriving_airport_city_id")
    const _product_edit_location_city_id = document.getElementById("product_edit_location_city_id")
    const _product_location_arriving_airport_city_search = document.getElementById("product_location_arriving_airport_city_search")
    const _modal_product_city_id = document.getElementById("modal_product_city_id")
    const _modal_product_provider_name = document.getElementById("modal_product_provider_name")
    const _modal_product_vendor_name = document.getElementById("modal_product_vendor_name")
    const _modal_product_province_id = document.getElementById("modal_product_province_id")
    const _modal_product_country_id = document.getElementById("modal_product_country_id")
    
    const _modal_product_arrive_to_airport_city = document.getElementById("modal_product_arrive_to_airport_city")
    const _modal_product_arrive_to_airport_country_id = document.getElementById("modal_product_arrive_to_airport_country_id")
    const _modal_product_arrive_to_airport_province_id = document.getElementById("modal_product_arrive_to_airport_province_id")
    const _modal_product_arrive_to_airport_city_id = document.getElementById("modal_product_arrive_to_airport_city_id")
    
    const _modal_product_depart_from_airport_city = document.getElementById("modal_product_depart_from_airport_city")
    const _modal_product_depart_from_airport_country_id = document.getElementById("modal_product_depart_from_airport_country_id")
    const _modal_product_depart_from_airport_province_id = document.getElementById("modal_product_depart_from_airport_province_id")
    const _modal_product_depart_from_airport_city_id = document.getElementById("modal_product_depart_from_airport_city_id")
    
    const _modal_product_arrive_to_station_city = document.getElementById("modal_product_arrive_to_station_city")
    const _modal_product_arrive_to_station_country_id = document.getElementById("modal_product_arrive_to_station_country_id")
    const _modal_product_arrive_to_station_province_id = document.getElementById("modal_product_arrive_to_station_province_id")
    const _modal_product_arrive_to_station_city_id = document.getElementById("modal_product_arrive_to_station_city_id")
    
    const _modal_product_depart_from_station_city = document.getElementById("modal_product_depart_from_station_city")
    const _modal_product_depart_from_station_country_id = document.getElementById("modal_product_depart_from_station_country_id")
    const _modal_product_depart_from_station_province_id = document.getElementById("modal_product_depart_from_station_province_id")
    const _modal_product_depart_from_station_city_id = document.getElementById("modal_product_depart_from_station_city_id")
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    $("#product_location_transport_city_search")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            _product_edit_location_city_id.value = ""
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                //console.log("city", city)
                _product_edit_location_city_id.value = city.id
                
            },
        })
    
    $("#product_location_cars_city_search")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            _product_edit_location_city_id.value = ""
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
            
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                
                _product_edit_location_city_id.value = city.id
                
            },
        })
    
    $("#product_location_arriving_airport_city_search")
        .on("change", function () {
            setTimeout(function () {
                let city = $("#product_location_arriving_airport_city_search").val()
                if (city === "") {
                    _product_location_arriving_airport_city_id.value = ""
                }
            }, 200)
        })
        .on("search", function () {
            _product_location_arriving_airport_city_id.value = ""
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
            
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                
                _product_location_arriving_airport_city_search.value = suggestion.value
                _product_location_arriving_airport_city_id.value = city.id
                
            },
        })
    
    $("#product_location_departing_airport_city_search")
        
        .on("change", function () {
            setTimeout(function () {
                let city = $("#product_location_departing_airport_city_search").val()
                if (city === "") {
                    _product_edit_location_city_id.value = ""
                    _product_location_departing_airport_city_id.value = ""
                }
            }, 200)
        })
        .on("search", function () {
            _product_edit_location_city_id.value = ""
            _product_location_departing_airport_city_id.value = ""
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                
                //console.log("city", city)
                
                _product_location_departing_airport_city_search.value = suggestion.value
                _product_location_departing_airport_city_id.value = city.id
                _product_edit_location_city_id.value = city.id
                
                /*
                `${city.name} (${city.province.name}, ${city.country.name})`
                
                    "value": "Abano Terme (Padova, Italy)",
                    "data": {
                        "id": 1,
                        "country_id": 102,
                        "province_id": 250,
                        "sort_order": 999,
                        "name": "Abano Terme",
                        "enabled": 1,
                        "date_created": "2021-08-03 14:40:07",
                        "created_by": 4,
                        "date_modified": "2021-08-03 14:40:07",
                        "modified_by": 4,
                        "note": "",
                        "province": {
                            "id": 250,
                            "country_id": 102,
                            "name": "Padova",
                            "iso2": "PD",
                            "iso3": "",
                            "sort_order": 999,
                            "enabled": 1,
                            "date_created": "2021-12-15 10:58:47",
                            "created_by": 4,
                            "date_modified": "2021-12-15 10:58:47",
                            "modified_by": 4,
                            "note": null
                        },
                        "country": {
                            "id": 102,
                            "currency_id": 2,
                            "sort_order": 0,
                            "name": "Italy",
                            "iso2": "IT",
                            "iso3": "ITA",
                            "enabled": 1,
                            "date_created": "2021-08-03 13:04:10",
                            "created_by": 4,
                            "date_modified": "2021-08-03 15:13:45",
                            "modified_by": 4,
                            "note": ""
                        }
                    }
                //*/
                
            },
        })
    
    $("#form_product_search_hotel_product_location")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
        
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
            
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                //console.log("city", suggestion)
                if (!suggestion.data) {
                    return
                }
                
                //console.log("city", suggestion)
                /*
                    "value": "Abano Terme (Padova, Italy)",
                    "data": {
                        "id": 1,
                        "country_id": 102,
                        "province_id": 250,
                        "sort_order": 999,
                        "name": "Abano Terme",
                        "enabled": 1,
                        "date_created": "2021-08-03 14:40:07",
                        "created_by": 4,
                        "date_modified": "2021-08-03 14:40:07",
                        "modified_by": 4,
                        "note": "",
                        "province": {
                            "id": 250,
                            "country_id": 102,
                            "name": "Padova",
                            "iso2": "PD",
                            "iso3": "",
                            "sort_order": 999,
                            "enabled": 1,
                            "date_created": "2021-12-15 10:58:47",
                            "created_by": 4,
                            "date_modified": "2021-12-15 10:58:47",
                            "modified_by": 4,
                            "note": null
                        },
                        "country": {
                            "id": 102,
                            "currency_id": 2,
                            "sort_order": 0,
                            "name": "Italy",
                            "iso2": "IT",
                            "iso3": "ITA",
                            "enabled": 1,
                            "date_created": "2021-08-03 13:04:10",
                            "created_by": 4,
                            "date_modified": "2021-08-03 15:13:45",
                            "modified_by": 4,
                            "note": ""
                        }
                    }
                //*/
                
            },
        })
    
    $(_modal_product_city_id)
        .on("change", function () {
            if (_modal_product_city_id.value === "") {
                //_modal_product_provider_name.disabled = true
                //_modal_product_vendor_name.disabled = true
            } else {
                //_modal_product_provider_name.disabled = false
                //_modal_product_vendor_name.disabled = false
            }
        })
    
    $("#modal_product_depart_from_airport_city")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_depart_from_airport_city).val("").trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                _modal_product_city_id.value = city.id
                $(_modal_product_city_id).val((city.id) ? city.id : "").trigger("change")
                
                _modal_product_depart_from_airport_country_id.value = (!isNaN(parseInt(city.country.id))) ? parseInt(city.country.id) : null
                _modal_product_depart_from_airport_province_id.value = (!isNaN(parseInt(city.province.id))) ? parseInt(city.province.id) : null
                _modal_product_depart_from_airport_city_id.value = (!isNaN(parseInt(city.id))) ? parseInt(city.id) : null
            },
        })
    
    $("#modal_product_arrive_to_airport_city")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_arrive_to_airport_city).val("").trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                //_modal_product_city_id.value = city.id
                //$(_modal_product_city_id).val((city.id) ? city.id : "").trigger("change")
                _modal_product_arrive_to_airport_country_id.value = (city.country.id) ? city.country.id : null
                _modal_product_arrive_to_airport_province_id.value = (city.province.id) ? city.province.id : null
                _modal_product_arrive_to_airport_city_id.value = (city.id) ? city.id : null
                /*
                    "value": "Abano Terme (Padova, Italy)",
                    "data": {
                        "id": 1,
                        "country_id": 102,
                        "province_id": 250,
                        "sort_order": 999,
                        "name": "Abano Terme",
                        "enabled": 1,
                        "date_created": "2021-08-03 14:40:07",
                        "created_by": 4,
                        "date_modified": "2021-08-03 14:40:07",
                        "modified_by": 4,
                        "note": "",
                        "province": {
                            "id": 250,
                            "country_id": 102,
                            "name": "Padova",
                            "iso2": "PD",
                            "iso3": "",
                            "sort_order": 999,
                            "enabled": 1,
                            "date_created": "2021-12-15 10:58:47",
                            "created_by": 4,
                            "date_modified": "2021-12-15 10:58:47",
                            "modified_by": 4,
                            "note": null
                        },
                        "country": {
                            "id": 102,
                            "currency_id": 2,
                            "sort_order": 0,
                            "name": "Italy",
                            "iso2": "IT",
                            "iso3": "ITA",
                            "enabled": 1,
                            "date_created": "2021-08-03 13:04:10",
                            "created_by": 4,
                            "date_modified": "2021-08-03 15:13:45",
                            "modified_by": 4,
                            "note": ""
                        }
                    }
                //*/
            },
        })
    
    $("#modal_product_depart_from_station_city")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_country_id)
                .val("")
            $(_modal_product_province_id)
                .val("")
            $(_modal_product_city_id)
                .val("")
                .trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                _modal_product_country_id.value = city.id
                _modal_product_province_id.value = city.province.id
                _modal_product_city_id.value = city.country.id
                _modal_product_depart_from_station_country_id.value = (!isNaN(parseInt(city.country.id))) ? parseInt(city.country.id) : null
                _modal_product_depart_from_station_province_id.value = (!isNaN(parseInt(city.province.id))) ? parseInt(city.province.id) : null
                _modal_product_depart_from_station_city_id.value = (!isNaN(parseInt(city.id))) ? parseInt(city.id) : null
                
                $(_modal_product_city_id).val((city.id) ? city.id : "").trigger("change")
                
            },
        })
    
    $("#modal_product_arrive_to_station_city")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_city_id).val("").trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                
                _modal_product_arrive_to_station_country_id.value = (!isNaN(parseInt(city.country.id))) ? parseInt(city.country.id) : null
                _modal_product_arrive_to_station_province_id.value = (!isNaN(parseInt(city.province.id))) ? parseInt(city.province.id) : null
                _modal_product_arrive_to_station_city_id.value = (!isNaN(parseInt(city.id))) ? parseInt(city.id) : null
            },
        })
    
    $("#modal_product_city")
        .on("change", function () {
            setTimeout(function () {
                let name = $("#modal_product_city").val()
                if (name === "") {
                    $(_modal_product_city_id)
                        .val("")
                        .trigger("change")
                }
            }, 200)
        })
        .on("search", function () {
            
            if (_modal_product_city_id) {
                $(_modal_product_city_id)
                    .val("")
                    .trigger("change")
            }
            
            if (_modal_product_province_id) {
                _modal_product_province_id.value = ""
            }
            
            if (_modal_product_country_id) {
                _modal_product_country_id.value = ""
            }
            
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                
                let city = suggestion.data
                let cityId = (!isNaN(parseInt(city.id))) ? parseInt(city.id) : null
                let provinceId = (!isNaN(parseInt(city.province.id))) ? parseInt(city.province.id) : null
                let countryId = (!isNaN(parseInt(city.country.id))) ? parseInt(city.country.id) : null
                
                if (_modal_product_city_id && cityId) {
                    _modal_product_city_id.value = cityId
                }
                
                if (_modal_product_province_id && provinceId) {
                    _modal_product_province_id.value = provinceId
                }
                
                if (_modal_product_country_id && countryId) {
                    _modal_product_country_id.value = countryId
                }
                
            },
        })
    
    $("#modal_product_city_cars")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_city_id).val("").trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
            
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                _modal_product_city_id.value = city.id
                $(_modal_product_city_id).val((city.id) ? city.id : "").trigger("change")
                
            },
        })
    
    $("#modal_product_city_transports")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_city_id).val("").trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let city = suggestion.data
                let province = (city.province) ? city.province : {}
                let country = (city.country) ? city.country : {}
                let countryId = (country.id && !isNaN(parseInt(country.id))) ? parseInt(country.id) : null
                let provinceId = (province.id && !isNaN(parseInt(province.id))) ? parseInt(province.id) : null
                let cityId = (city.id && !isNaN(parseInt(city.id))) ? parseInt(city.id) : null
                
                //*
                console.log("|__ country", country)
                console.log("|__ province", province)
                console.log("|__ city", city)
                //*/
                
                //*
                console.log("|__ countryId", countryId)
                console.log("|__ provinceId", provinceId)
                console.log("|__ cityId", cityId)
                //*/
                
                _modal_product_country_id.value = countryId
                _modal_product_province_id.value = provinceId
                $(_modal_product_city_id).val(cityId).trigger("change")
                
            },
        })
    
    $("#modal_product_city_tours")
        .on("change", function () {
            setTimeout(function () {
            
            }, 200)
        })
        .on("search", function () {
            $(_modal_product_city_id).val("").trigger("change")
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/cities",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                
                let city = suggestion.data
                let country = (city.country) ? city.country : {}
                let province = (city.province) ? city.province : {}
                
                _modal_product_country_id.value = (country && !isNaN(parseInt(country.id))) ? parseInt(country.id) : null
                _modal_product_province_id.value = (province && !isNaN(parseInt(province.id))) ? parseInt(province.id) : null
                _modal_product_city_id.value = city.id
                
                $(_modal_product_city_id).val((city.id) ? city.id : "").trigger("change")
                
            },
        })
    
    const form_rules = {
        rules: {
            city_name: "required",
        },
        messages: {
            address_types_list: "City Name is Required",
        },
    }
    
    const handle_city_error = function (msg) {
        toastr.error(msg)
        //console.log("msg", msg)
    }
    
    const on_click_outside = (e) => {
        let tar = $(e.target).parents("div." + class_name)
        
        if (!tar[0] && !e.target.className.includes("select-add-option")) {
            City.close()
        }
    }
    
    const build_drop_downs = function (settings) {
        if (settings) {
            if (settings.dropdowns) {
                $.each(settings.dropdowns, function (i, dropdown_id) {
                    let element = document.getElementById(dropdown_id)
                    
                    if (element) {
                        $(element)
                            .select2({
                                
                                "language": {
                                    "searching": function () {
                                    },
                                },
                                "escapeMarkup": function (markup) {
                                    return markup
                                },
                                
                            })
                            .on("select2:open", function (e) {
                                let x = document.querySelectorAll("[aria-controls='select2-" + dropdown_id + "-results']")
                                if (x[0]) {
                                    let _filterCitySearch = x[0]
                                    $(_filterCitySearch).attr("id", "" + dropdown_id + "_search")
                                    if (!document.getElementById("filter_city_add_icon")) {
                                        let i = document.createElement("i")
                                        i.classList = "select-add-option fas fa-plus filter_city_add"
                                        i.id = "filter_city_add_icon"
                                        i.addEventListener("click", event => {
                                            let val = _filterCitySearch.value
                                            $(element).select2("close")
                                            City.add(this, val, dropdown_id)
                                        })
                                        _filterCitySearch.after(i)
                                    }
                                    $(".filter_city_add").hide()
                                    if (_filterCitySearch) {
                                        _filterCitySearch.addEventListener("keyup", event => {
                                            if (_filterCitySearch.value !== "") {
                                                $(".filter_city_add").show()
                                            } else {
                                                $(".filter_city_add").hide()
                                            }
                                        })
                                    }
                                }
                                
                            })
                            .on("change", function () {
                                let id = $(this)
                                    .attr("id")
                                    .replace("city", "city")
                            })
                    }
                })
            }
        }
    }
    
    const fetch_city_list = function (dataToSend, callback) {
        if (dataToSend) {
            try {
                sendGetRequest("/api/v1.0/cities", dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_city_error("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handle_city_error("Error Validating City")
            }
        } else {
            return handle_city_error("Error Loading Province- Missing Data")
        }
    }
    
    const update_city_record = function ($this, dataToSend) {
        if (dataToSend) {
            try {
                sendPostRequest("/api/v1.0/cities/update", dataToSend, function (data, status, xhr) {
                    if (data && data[0]) {
                        let new_city = data[0]
                        City.all.set(new_city.id, new_city)
                        let city_elements = $("select[data-type='city']")
                        
                        City.id = new_city.id
                        city_elements.each(function (index, element) {
                            var newOption = new Option(new_city.name, new_city.id, false, false)
                            $(element).append(newOption).trigger("change")
                            
                        })
                        $($this).val(new_city.id).trigger("change")
                        City.close()
                        toastr.success("City: " + new_city.id + " updated")
                        
                    } else {
                        return handle_city_error("Error: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handle_city_error("Error: Validating City")
            }
        } else {
            //console.log("Error: Missing Data")
            handle_city_error("Error: Missing Data")
        }
    }
    
    const destroy_form = function () {
        let elem = document.getElementById(form_id)
        if (elem) {
            elem.parentNode.removeChild(elem)
            window.removeEventListener("click", on_click_outside)
        }
    }
    
    const build_form = function (elem, val, dropdown_id) {
        let id = $(elem).attr("id")
        let parent = $(elem).parents("div.row")
        let value = ""
        
        if (val) {
            value = val
        }
        
        if (!id || !parent[0]) {
            return
        }
        
        if (document.getElementById(form_id)) {
            return
        }
        
        let new_city_form = document.createElement("div")
        
        let heading1 = document.createElement("h5")
        
        let row1 = document.createElement("div")
        let row2 = document.createElement("div")
        
        let col1 = document.createElement("div")
        let col2 = document.createElement("div")
        let col3 = document.createElement("div")
        let col4 = document.createElement("div")
        
        let col5 = document.createElement("div")
        
        let form_element1 = document.createElement("div")
        let form_element2 = document.createElement("div")
        let form_element3 = document.createElement("div")
        let form_element4 = document.createElement("div")
        
        let error_element1 = document.createElement("div")
        
        let name_text_element = document.createElement("input")
        let name_label_element = document.createElement("label")
        
        let save_button = document.createElement("button")
        let cancel_button = document.createElement("button")
        
        heading1.classList = "card-title"
        heading1.innerText = "City Details"
        
        new_city_form.id = form_id
        new_city_form.classList = ["card card-body m-3 " + class_name]
        
        name_text_element.id = "city_name"
        name_text_element.name = "city_name"
        name_text_element.type = "text"
        name_text_element.classList = ["form-control "]
        name_label_element.htmlFor = "city_name"
        name_label_element.innerHTML = "Name:"
        error_element1.id = "city_name-error"
        
        save_button.classList = ["btn btn-primary btn-sm waves-effect waves-light"]
        save_button.innerText = "save"
        save_button.type = "button"
        
        save_button.addEventListener("click", event => {
            City.save(elem, dropdown_id)
        })
        
        cancel_button.classList = ["btn btn-outline-danger btn-sm waves-effect waves-light"]
        cancel_button.innerText = "cancel"
        cancel_button.type = "button"
        
        cancel_button.addEventListener("click", event => {
            City.close()
        })
        
        row1.classList = ["row"]
        row2.classList = ["row"]
        
        col1.classList = ["col-lg-3 mb-1"]
        col2.classList = ["col-lg-3 mb-1"]
        col3.classList = ["col-lg-3 mb-1"]
        col4.classList = ["col-lg-3 mb-1"]
        
        col5.classList = ["col-12 mb-1 text-right"]
        
        form_element1.classList = ["form-element"]
        form_element2.classList = ["form-element"]
        form_element3.classList = ["form-element"]
        form_element4.classList = ["form-element"]
        
        error_element1.classList = ["error w-100 text-center"]
        
        form_element1.appendChild(name_label_element)
        form_element1.appendChild(name_text_element)
        form_element1.appendChild(error_element1)
        
        col1.appendChild(form_element1)
        
        row1.appendChild(col1)
        row1.appendChild(col2)
        row1.appendChild(col3)
        row1.appendChild(col4)
        
        col5.append(cancel_button)
        col5.appendChild(save_button)
        
        row2.appendChild(col5)
        
        new_city_form.appendChild(heading1)
        new_city_form.appendChild(row1)
        new_city_form.appendChild(row2)
        
        parent[0].appendChild(new_city_form)
        
        name_text_element.value = value
        name_text_element.focus({ preventScroll: false })
        
        window.addEventListener("click", on_click_outside)
    }
    
    const clear_detail = function () {
        
        return {
            id: null,
            province_id: null,
            country_id: null,
            created_by: null,
            modified_by: null,
            sort_order: null,
            name: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            note: null,
        }
        
    }
    
    const set_detail = function (city) {
        let detail = clear_detail()
        let id = null
        if (city) {
            id = validInt(city.id)
            detail = {
                id: validInt(city.id),
                province_id: validInt(city.province_id),
                created_by: (city.created_by) ? city.created_by : user_id,
                modified_by: (city.created_by) ? city.created_by : user_id,
                sort_order: (city.sort_order) ? city.sort_order : null,
                name: (city.name) ? city.name : null,
                enabled: (city.enabled) ? city.enabled : 1,
                date_created: (city.date_created) ? city.date_created : formatDateMySQL(),
                date_modified: (city.date_modified) ? city.date_modified : formatDateMySQL(),
                note: (city.note) ? city.note : null,
            }
            
        }
        
        //City.id = id
        City.detail = detail
        return detail
    }
    
    const get = function (country_id, province_id, el) {
        City.all = new Map()
        let city_id = null
        if (City.id !== null) {
            city_id = City.id
        }
        if (!el) {
            return
        }
        
        if (!country_id || !province_id || !el) {
            
            $(el).BuildDropDown({
                data: Array.from(City.all.values()),
                title: "City",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            $(el).val("").trigger("change")
            return
        }
        
        let dataToSend = {
            country_id: parseInt(country_id),
            province_id: parseInt(province_id),
        }
        
        fetch_city_list(dataToSend, function (cities) {
            if (cities) {
                load_all(cities)
                
                $(el).BuildDropDown({
                    data: Array.from(City.all.values()),
                    title: "City",
                    id_field: "id",
                    text_field: "name",
                    first_selectable: false,
                })
                
                if (city_id !== "" && city_id !== null) {
                    //console.log($(el).attr("id"))
                    //console.log("city_id", city_id)
                    $(el).val(city_id).trigger("change")
                }
            }
        })
        
    }
    
    const add = function (elem, val, dropdown_id) {
        if (!elem) {
            return
        }
        
        build_form(elem, val, dropdown_id)
    }
    
    const save = function ($this, dropdown_id) {
        let city_detail = {}
        let _name = document.getElementById("city_name")
        let _province_id = document.getElementById(dropdown_id.replace(/city_id/g, "") + "province_id")
        let _country_id = document.getElementById(dropdown_id.replace(/city_id/g, "") + "country_id")
        if (!isNaN(parseInt(_country_id.value)) && !isNaN(parseInt(_province_id.value))) {
            if (_name, _province_id, _country_id) {
                city_detail.name = _name.value
                city_detail.country_id = parseInt(_country_id.value)
                city_detail.province_id = parseInt(_province_id.value)
                
                let r = confirm("Are you sure you want to edit this record?")
                if (r === true) {
                    update_city_record($this, remove_nulls(city_detail))
                }
            }
        }
    }
    
    const load_all = function (cities) {
        City.all = new Map()
        
        if (cities) {
            $.each(cities, function (k, city) {
                let detail = set_detail(city)
                City.all.set(detail.id, detail)
            })
        }
    }
    
    const init = function (settings) {
        build_drop_downs(settings)
    }
    
    return {
        id: null,
        detail: {
            id: null,
            province_id: null,
            country_id: null,
            created_by: null,
            modified_by: null,
            sort_order: null,
            name: null,
            enabled: null,
            date_created: null,
            date_modified: null,
            note: null,
        },
        all: [],
        close: function () {
            destroy_form()
        },
        save: function ($this, dropdown_id) {
            save($this, dropdown_id)
        },
        get: function (country_id, province_id, el) {
            get(country_id, province_id, el)
        },
        add: function (elem, val, dropdown_id) {
            add(elem, val, dropdown_id)
        },
        set_detail: function (city) {
            set_detail(city)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const Station = (function () {
    "use strict"
    
    const _modal_product_depart_from_station_cancel_button = document.getElementById("modal_product_depart_from_station_cancel_button")
    const _modal_product_depart_from_station_submit_button = document.getElementById("modal_product_depart_from_station_submit_button")
    const _modal_product_depart_from_station_iata_code = document.getElementById("modal_product_depart_from_station_iata_code")
    const _modal_product_depart_from_station_country_id = document.getElementById("modal_product_depart_from_station_country_id")
    const _modal_product_depart_from_station_province_id = document.getElementById("modal_product_depart_from_station_province_id")
    const _modal_product_depart_from_station_city_id = document.getElementById("modal_product_depart_from_station_city_id")
    const _modal_product_depart_from_station_city = document.getElementById("modal_product_depart_from_station_city")
    const _modal_product_depart_from_station = document.getElementById("modal_product_depart_from_station")
    const _modal_product_depart_from_station_id = document.getElementById("modal_product_depart_from_station_id")
    const _modal_product_depart_from_station_add_block = document.getElementById("modal_product_depart_from_station_add_block")
    const _modal_product_depart_from_station_postal_code = document.getElementById("modal_product_depart_from_station_postal_code")
    const _modal_product_depart_from_station_street_1 = document.getElementById("modal_product_depart_from_station_street_1")
    const _modal_product_depart_from_station_street_2 = document.getElementById("modal_product_depart_from_station_street_2")
    const _modal_product_depart_from_station_edit_link = document.getElementById("modal_product_depart_from_station_edit_link")
    const _modal_product_depart_from_new_station_id = document.getElementById("modal_product_depart_from_new_station_id")
    const _modal_product_depart_from_station_gps_code = document.getElementById("modal_product_depart_from_station_gps_code")
    const _modal_product_depart_from_station_local_code = document.getElementById("modal_product_depart_from_station_local_code")
    const _modal_product_depart_from_station_home_link = document.getElementById("modal_product_depart_from_station_home_link")
    const _modal_product_depart_from_station_wikipedia_link = document.getElementById("modal_product_depart_from_station_wikipedia_link")
    const _modal_product_arrive_to_station_add_block = document.getElementById("modal_product_arrive_to_station_add_block")
    const _modal_product_arrive_to_station_cancel_button = document.getElementById("modal_product_arrive_to_station_cancel_button")
    const _modal_product_arrive_to_station_submit_button = document.getElementById("modal_product_arrive_to_station_submit_button")
    const _modal_product_arrive_to_station_edit_link = document.getElementById("modal_product_arrive_to_station_edit_link")
    const _modal_product_arrive_to_station = document.getElementById("modal_product_arrive_to_station")
    const _modal_product_arrive_to_station_city = document.getElementById("modal_product_arrive_to_station_city")
    const _modal_product_arrive_to_station_id = document.getElementById("modal_product_arrive_to_station_id")
    const _modal_product_arrive_to_new_station_id = document.getElementById("modal_product_arrive_to_new_station_id")
    const _modal_product_arrive_to_station_street_1 = document.getElementById("modal_product_arrive_to_station_street_1")
    const _modal_product_arrive_to_station_street_2 = document.getElementById("modal_product_arrive_to_station_street_2")
    const _modal_product_arrive_to_station_postal_code = document.getElementById("modal_product_arrive_to_station_postal_code")
    const _modal_product_arrive_to_station_iata_code = document.getElementById("modal_product_arrive_to_station_iata_code")
    const _modal_product_arrive_to_station_country_id = document.getElementById("modal_product_arrive_to_station_country_id")
    const _modal_product_arrive_to_station_province_id = document.getElementById("modal_product_arrive_to_station_province_id")
    const _modal_product_arrive_to_station_city_id = document.getElementById("modal_product_arrive_to_station_city_id")
    const _modal_product_arrive_to_station_gps_code = document.getElementById("modal_product_arrive_to_station_gps_code")
    const _modal_product_arrive_to_station_local_code = document.getElementById("modal_product_arrive_to_station_local_code")
    const _modal_product_arrive_to_station_home_link = document.getElementById("modal_product_arrive_to_station_home_link")
    const _modal_product_arrive_to_station_wikipedia_link = document.getElementById("modal_product_arrive_to_station_wikipedia_link")
    const _modal_product_depart_from_station_add_block_close_button = document.getElementById("modal_product_depart_from_station_add_block_close_button")
    const _modal_product_arrive_to_station_add_block_close_button = document.getElementById("modal_product_arrive_to_station_add_block_close_button")
    const _modal_product_day_span = document.getElementById("modal_product_day_span")
    const _modal_product_station_day_span = document.getElementById("modal_product_station_day_span")
    const _modal_product_country_id = document.getElementById("modal_product_country_id")
    const _modal_product_province_id = document.getElementById("modal_product_province_id")
    const _modal_product_city_id = document.getElementById("modal_product_city_id")
    
    let userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let globalSelectedStationDepartFrom = false
    let globalSelectedStationArriveTo = false
    let editText = "Edit"
    let cancelText = "Cancel"
    
    $(_modal_product_depart_from_station_add_block_close_button)
        .on("click", function () {
            //console.log("Station.modal_product_depart_from_station_add_block_close_button:click()")
            // ----
            
            cancelAddStationRecord("depart_from")
            hideStationForm("arrive_to")
            hideStationForm("depart_from")
            
            _modal_product_depart_from_station_edit_link.innerText = editText
            _modal_product_arrive_to_station_edit_link.innerText = editText
            
            _modal_product_arrive_to_station.disabled = false
            _modal_product_depart_from_station.disabled = false
            
        })
    
    $(_modal_product_arrive_to_station_add_block_close_button)
        .on("click", function () {
            //console.log("Station.modal_product_arrive_to_station_add_block_close_button:click()")
            // ----
            
            cancelAddStationRecord("arrive_to")
            hideStationForm("arrive_to")
            hideStationForm("depart_from")
            
            _modal_product_depart_from_station_edit_link.innerText = editText
            _modal_product_arrive_to_station_edit_link.innerText = editText
            
            _modal_product_arrive_to_station.disabled = false
            _modal_product_depart_from_station.disabled = false
            
        })
    
    $(_modal_product_station_day_span)
        .on("change", function (e) {
            //console.log("Station.modal_product_station_day_span:change()")
            // ----
            
            let daySpan = $(this).val()
            
            if (daySpan === "" || isNaN(parseInt(daySpan))) {
                daySpan = 1
            } else if (daySpan < 1) {
                daySpan = 1
            }
            _modal_product_station_day_span.value = daySpan
            _modal_product_day_span.value = daySpan
        })
    
    $(_modal_product_depart_from_station_edit_link)
        .on("click", function () {
            //console.log("Station.modal_product_depart_from_station_edit_link:click()")
            // ----
            
            let toggleData = _modal_product_depart_from_station_edit_link.innerText
            
            if (toggleData === editText) {
                
                showStationForm("depart_from")
                hideStationForm("arrive_to")
                
                _modal_product_depart_from_station_edit_link.innerText = cancelText
                _modal_product_arrive_to_station_edit_link.innerText = editText
                
                _modal_product_depart_from_station.disabled = true
                _modal_product_arrive_to_station.disabled = false
                
            } else {
                
                cancelAddStationRecord("depart_from")
                hideStationForm("arrive_to")
                hideStationForm("depart_from")
                
                _modal_product_depart_from_station_edit_link.innerText = editText
                _modal_product_arrive_to_station_edit_link.innerText = editText
                
                _modal_product_arrive_to_station.disabled = false
                _modal_product_depart_from_station.disabled = false
                
            }
            
        })
    
    $(_modal_product_arrive_to_station_edit_link)
        .on("click", function () {
            //console.log("Station.modal_product_arrive_to_station_edit_link:click()")
            // ----
            
            let toggleData = _modal_product_arrive_to_station_edit_link.innerText
            
            if (toggleData === editText) {
                
                showStationForm("arrive_to")
                hideStationForm("depart_from")
                
                _modal_product_depart_from_station_edit_link.innerText = editText
                _modal_product_arrive_to_station_edit_link.innerText = cancelText
                
                _modal_product_arrive_to_station.disabled = true
                _modal_product_depart_from_station.disabled = false
                
            } else {
                cancelAddStationRecord("arrive_to")
                hideStationForm("arrive_to")
                hideStationForm("depart_from")
                
                _modal_product_depart_from_station_edit_link.innerText = editText
                _modal_product_arrive_to_station_edit_link.innerText = editText
                
                _modal_product_arrive_to_station.disabled = false
                _modal_product_depart_from_station.disabled = false
                
            }
            
        })
    
    $(_modal_product_depart_from_station_add_block)
        .on("change", function () {
            //console.log("Station.modal_product_depart_from_station_add_block:change()")
            // ----
            
            validDepartFromRecord()
        })
        .on("keyup", function () {
            //console.log("Station.modal_product_depart_from_station_add_block:keyup()")
            // ----
            
            validDepartFromRecord()
        })
    
    $(_modal_product_depart_from_station_cancel_button)
        .on("click", function () {
            //console.log("Station.modal_product_depart_from_station_cancel_button:click()")
            // ----
            
            cancelAddStationRecord("depart_from")
            _modal_product_depart_from_station_edit_link.innerText = "Edit"
        })
    
    $(_modal_product_arrive_to_station_cancel_button)
        .on("click", function () {
            //console.log("Station.modal_product_arrive_to_station_cancel_button:click()")
            // ----
            
            cancelAddStationRecord("arrive_to")
            _modal_product_arrive_to_station_edit_link.innerText = "Edit"
        })
    
    $(_modal_product_depart_from_station_submit_button)
        .on("click", function () {
            //console.log("Station.modal_product_depart_from_station_submit_button:click()")
            // ----
            
            save("depart_from")
        })
    
    $(_modal_product_arrive_to_station_submit_button)
        .on("click", function () {
            //console.log("Station.modal_product_arrive_to_station_submit_button:click()")
            // ----
            
            save("arrive_to")
        })
    
    const clearDepartFromFields = function () {
        console.log("Station.clearDepartFromFields()")
        // ----
        
        if (_modal_product_depart_from_station_add_block) {
            
            if (Station.departFromKeywords) {
                Station.departFromKeywords.clear()
            }
            
            _modal_product_depart_from_station_gps_code.value = ""
            _modal_product_depart_from_station_local_code.value = ""
            _modal_product_depart_from_station_home_link.value = ""
            _modal_product_depart_from_station_wikipedia_link.value = ""
            _modal_product_depart_from_station_id.value = ""
            _modal_product_depart_from_station_country_id.value = ""
            _modal_product_depart_from_station_province_id.value = ""
            _modal_product_depart_from_station_city_id.value = ""
            _modal_product_depart_from_station.value = ""
            _modal_product_country_id.value = ""
            _modal_product_province_id.value = ""
            _modal_product_city_id.value = ""
            _modal_product_depart_from_station_edit_link.dataset.stationId = ""
            
            hideStationForm("depart_from")
            toggleEditFormLink("depart_from")
            $(_modal_product_depart_from_station).trigger("change")
        }
        
    }
    const clearArriveToFields = function () {
        console.log("Station.clearArriveToFields()")
        // ----
        
        let type = "arrive_to"
        
        if (Station.arriveToKeywords) {
            Station.arriveToKeywords.clear()
        }
        
        _modal_product_arrive_to_station_gps_code.value = ""
        _modal_product_arrive_to_station_local_code.value = ""
        _modal_product_arrive_to_station_home_link.value = ""
        _modal_product_arrive_to_station_wikipedia_link.value = ""
        _modal_product_arrive_to_new_station_id.value = ""
        _modal_product_arrive_to_station_iata_code.value = ""
        _modal_product_arrive_to_station_city.value = ""
        _modal_product_arrive_to_station_city_id.value = ""
        _modal_product_arrive_to_station_country_id.value = ""
        _modal_product_arrive_to_station_province_id.value = ""
        _modal_product_arrive_to_station_postal_code.value = ""
        _modal_product_arrive_to_station_street_1.value = ""
        _modal_product_arrive_to_station_street_2.value = ""
        _modal_product_arrive_to_station_id.value = ""
        
        _modal_product_arrive_to_station.disabled = false
        
        _modal_product_arrive_to_station_edit_link.dataset.stationId = ""
        
        clearAllValidation()
        hideStationForm(type)
        toggleEditFormLink(type)
        $(_modal_product_arrive_to_station).trigger("change")
        
    }
    const save = function (type) {
        //console.log("Station.save()")
        // ----
        
        if (type) {
            let dataToSend = buildAddStationRecord(type)
            
            if (!dataToSend) {
                return
            }
            
            confirmDialog(`Would you like to update?`, (ans) => {
                
                if (ans) {
                    
                    console.log("|__ dataToSend", dataToSend)
                    
                    sendSaveRequest(dataToSend, function (data) {
                        console.log("data", data)
                        let station
                        if (data) {
                            station = data
                            if (data[0]) {
                                station = data[0]
                            }
                        }
                        
                        if (station) {
                            //console.log("|__ station", station)
                            
                            let stationId = (!isNaN(parseInt(station.id))) ? parseInt(station.id) : null
                            
                            if (stationId !== null) {
                                Station.all.set(stationId, station)
                                
                                if (type) {
                                    if (type === "depart_from") {
                                        Station.departingStation = station
                                    } else {
                                        Station.arrivingStation = station
                                    }
                                    cancelAddStationRecord(type)
                                    hideStationForm(type)
                                    initAutocomplete()
                                    handleStationError(`Station ${stationId} has been updated.`, "Station", "success")
                                    
                                    _modal_product_depart_from_station_edit_link.innerText = editText
                                    _modal_product_arrive_to_station_edit_link.innerText = editText
                                    _modal_product_arrive_to_station.disabled = false
                                    _modal_product_depart_from_station.disabled = false
                                    
                                } else {
                                    handleStationError(`Station ${stationId} missing type.`, "Station", "warning")
                                }
                                
                            } else {
                                
                                handleStationError("Missing Fields", "Station", "error")
                                
                            }
                            
                            /*
                            if (type === "depart_from") {
                                //console.log("|__ stationId", stationId)
                                
                                populateStationForm(station, type)
                                
                            } else if (type === "arrive_to") {
                                if (_modal_product_arrive_to_station) {
                                    _modal_product_arrive_to_station.value = stationName
                                }
                                
                                if (_modal_product_arrive_to_new_station_id) {
                                    _modal_product_arrive_to_new_station_id.value = stationId
                                }
                                
                                if (_modal_product_arrive_to_station_id) {
                                    _modal_product_arrive_to_station_id.value = stationId
                                }
                                
                                if (_modal_product_country_id) {
                                    _modal_product_country_id.value = countryId
                                }
                                
                                if (_modal_product_province_id) {
                                    _modal_product_province_id.value = provinceId
                                }
                                
                                if (_modal_product_city_id) {
                                    _modal_product_city_id.value = cityId
                                }
                                
                                _modal_product_arrive_to_station_edit_link.dataset.stationId = stationId
                                
                                $(_modal_product_arrive_to_station_edit_link).show()
                            }
                            //*/
                            
                        }
                        
                    })
                    
                }
                
            })
            
        }
        
    }
    const sendSaveRequest = function (dataToSend, callback) {
        //console.log("Station.sendSaveRequest()")
        // ----
        
        if (dataToSend) {
            let url = "/api/v1.0/stations/update"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleStationError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
        
    }
    const validDepartFromRecord = function () {
        //console.log("Station.validDepartFromRecord()")
        // ----
        
        let isValid = true
        
        if (_modal_product_depart_from_station_iata_code.value === "") {
            $(_modal_product_depart_from_station_iata_code).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_depart_from_station_iata_code).hideError()
        }
        
        if (isNaN(parseInt(_modal_product_depart_from_station_city_id.value))) {
            $(_modal_product_depart_from_station_city).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_depart_from_station_city).hideError()
        }
        
        return isValid
    }
    const validArriveToRecord = function () {
        //console.log("Station.validArriveToRecord()")
        // ----
        
        let isValid = true
        
        if (_modal_product_arrive_to_station_iata_code.value === "") {
            $(_modal_product_arrive_to_station_iata_code).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_arrive_to_station_iata_code).hideError()
        }
        
        if (isNaN(parseInt(_modal_product_arrive_to_station_city_id.value))) {
            $(_modal_product_arrive_to_station_city).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_arrive_to_station_city).hideError()
        }
        
        return isValid
    }
    const buildAddStationRecord = function (type) {
        //console.log("Station.buildAddStationRecord()")
        // ----
        
        if (_modal_product_depart_from_station_add_block && _modal_product_arrive_to_station_add_block) {
            
            if (type) {
                //console.log("|__ type", type)
                
                if (type === "depart_from") {
                    
                    if (validDepartFromRecord()) {
                        let dataToSend = {
                            gps_code: (_modal_product_depart_from_station_gps_code.value !== "") ? _modal_product_depart_from_station_gps_code.value : null,
                            local_code: (_modal_product_depart_from_station_local_code.value !== "") ? _modal_product_depart_from_station_local_code.value : null,
                            home_link: (_modal_product_depart_from_station_home_link.value !== "") ? _modal_product_depart_from_station_home_link.value : null,
                            wikipedia_link: (_modal_product_depart_from_station_wikipedia_link.value !== "") ? _modal_product_depart_from_station_wikipedia_link.value : null,
                            scheduled_service: 1,
                            keywords: Station.departFromKeywords.build(),
                            id: (_modal_product_depart_from_new_station_id && !isNaN(parseInt(_modal_product_depart_from_new_station_id.value))) ? parseInt(_modal_product_depart_from_new_station_id.value) : null,
                            postal_code: (_modal_product_depart_from_station_postal_code.value !== "") ? _modal_product_depart_from_station_postal_code.value : null,
                            street_1: (_modal_product_depart_from_station_street_1.value !== "") ? _modal_product_depart_from_station_street_1.value : null,
                            street_2: (_modal_product_depart_from_station_street_2.value !== "") ? _modal_product_depart_from_station_street_2.value : null,
                            city_id: (!isNaN(parseInt(_modal_product_depart_from_station_city_id.value))) ? parseInt(_modal_product_depart_from_station_city_id.value) : null,
                            name: (_modal_product_depart_from_station.value !== "") ? _modal_product_depart_from_station.value : null,
                            iata_code: (_modal_product_depart_from_station_iata_code.value !== "") ? _modal_product_depart_from_station_iata_code.value : null,
                            enabled: 1,
                        }
                        
                        return removeNulls(dataToSend)
                    }
                } else if (type === "arrive_to") {
                    
                    if (validArriveToRecord()) {
                        let dataToSend = {
                            gps_code: (_modal_product_arrive_to_station_gps_code.value !== "") ? _modal_product_arrive_to_station_gps_code.value : null,
                            local_code: (_modal_product_arrive_to_station_local_code.value !== "") ? _modal_product_arrive_to_station_local_code.value : null,
                            home_link: (_modal_product_arrive_to_station_home_link.value !== "") ? _modal_product_arrive_to_station_home_link.value : null,
                            wikipedia_link: (_modal_product_arrive_to_station_wikipedia_link.value !== "") ? _modal_product_arrive_to_station_wikipedia_link.value : null,
                            scheduled_service: 1,
                            keywords: Station.arriveToKeywords.build(),
                            id: (_modal_product_arrive_to_new_station_id && !isNaN(parseInt(_modal_product_arrive_to_new_station_id.value))) ? parseInt(_modal_product_arrive_to_new_station_id.value) : null,
                            postal_code: (_modal_product_arrive_to_station_postal_code.value !== "") ? _modal_product_arrive_to_station_postal_code.value : null,
                            street_1: (_modal_product_arrive_to_station_street_1.value !== "") ? _modal_product_arrive_to_station_street_1.value : null,
                            street_2: (_modal_product_arrive_to_station_street_2.value !== "") ? _modal_product_arrive_to_station_street_2.value : null,
                            city_id: (!isNaN(parseInt(_modal_product_arrive_to_station_city_id.value))) ? parseInt(_modal_product_arrive_to_station_city_id.value) : null,
                            name: (_modal_product_arrive_to_station.value !== "") ? _modal_product_arrive_to_station.value : null,
                            iata_code: (_modal_product_arrive_to_station_iata_code.value !== "") ? _modal_product_arrive_to_station_iata_code.value : null,
                            enabled: 1,
                        }
                        
                        return removeNulls(dataToSend)
                    }
                }
                
            }
            
        }
        
    }
    const cancelAddStationRecord = function (type) {
        console.log("Station.cancelAddStationRecord()", Station.arrivingStation)
        // ----
        
        if (!type) {
            return
        }
        
        switch (type) {
            case "depart_from":
                clearStationForm(type)
                populateStationForm(Station.departingStation, type)
                break
            case "arrive_to":
                clearStationForm(type)
                populateStationForm(Station.arrivingStation, type)
                break
        }
        
        hideStationForm(type)
        
    }
    const showStationForm = function (type) {
        //console.log("Station.showStationForm()")
        // ----
        
        if (!type || !_modal_product_depart_from_station_add_block || !_modal_product_arrive_to_station_add_block) {
            
            //console.log("|__ _modal_product_depart_from_station_add_block", _modal_product_depart_from_station_add_block)
            //console.log("|__ _modal_product_arrive_to_station_add_block", _modal_product_arrive_to_station_add_block)
            //console.log("|__ type", type)
            
            return
        }
        
        _modal_product_depart_from_station.disabled = false
        _modal_product_arrive_to_station.disabled = false
        
        if (type === "depart_from") {
            _modal_product_depart_from_station.disabled = true
            
            $(_modal_product_depart_from_station_add_block).show()
            $(_modal_product_arrive_to_station_add_block).hide()
            
            toggleEditFormLink(type)
            
        } else if (type === "arrive_to") {
            _modal_product_arrive_to_station.disabled = true
            
            $(_modal_product_arrive_to_station_add_block).show()
            $(_modal_product_depart_from_station_add_block).hide()
            
            toggleEditFormLink(type)
        } else {
            //console.log("|__ type", type)
        }
        
    }
    const stationExists = function (name, type) {
        //console.log("Station.stationExists()")
        // ----
        
        if (name && name !== "") {
            /**
             * data to send to the server
             *
             * @type {{name}}
             */
            let dataToSend = {
                name: name,
            }
            
            fetchByName(dataToSend, function (data) {
                let station = null
                
                if (data) {
                    station = data
                    if (data[0]) {
                        station = data[0]
                    }
                }
                
                if (station && station.id) {
                    
                    let country = (station.country) ? station.country : {}
                    let province = (station.province) ? station.province : {}
                    let city = (station.city) ? station.city : {}
                    let stationId = (station && !isNaN(parseInt(station.id))) ? parseInt(station.id) : null
                    let countryId = (country && !isNaN(parseInt(country.id))) ? parseInt(country.id) : null
                    let provinceId = (province && !isNaN(parseInt(province.id))) ? parseInt(province.id) : null
                    let cityId = (city && !isNaN(parseInt(city.id))) ? parseInt(city.id) : null
                    
                    clearStationForm(type)
                    populateStationForm(station, type)
                    hideStationForm(type)
                    toggleEditFormLink(type)
                    
                    if (type === "depart_from") {
                        globalSelectedStationDepartFrom = true
                        
                        _modal_product_country_id.value = countryId
                        _modal_product_province_id.value = provinceId
                        _modal_product_city_id.value = cityId
                        
                        _modal_product_depart_from_station_edit_link.dataset.stationId = stationId
                        
                    } else if (type === "arrive_to") {
                        globalSelectedStationArriveTo = true
                        
                        _modal_product_arrive_to_station.value = station.name
                        _modal_product_arrive_to_station_id.value = station.id
                        
                        _modal_product_arrive_to_station_edit_link.dataset.stationId = station.id
                    }
                    
                } else {
                    // Station Does Not Exist
                    confirmDialog(`The station: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                        if (ans) {
                            if (type === "depart_from") {
                                globalSelectedStationDepartFrom = false
                            } else {
                                globalSelectedStationArriveTo = false
                            }
                            
                            clearStationForm(type)
                            populateStationForm({
                                name: name,
                            }, type)
                            
                            showStationForm(type)
                            
                        } else {
                            if (type === "depart_from") {
                                if (_modal_product_city_id) {
                                    _modal_product_city_id.value = ""
                                }
                                
                                if (_modal_product_depart_from_station_id) {
                                    _modal_product_depart_from_station_id.value = ""
                                }
                                if (_modal_product_depart_from_station) {
                                    _modal_product_depart_from_station.value = ""
                                }
                            } else {
                                if (_modal_product_arrive_to_station_id) {
                                    _modal_product_arrive_to_station_id.value = ""
                                }
                                if (_modal_product_arrive_to_station) {
                                    _modal_product_arrive_to_station.value = ""
                                }
                            }
                            
                        }
                    })
                }
                
            })
            
        }
        
    }
    const fetchByName = function (dataToSend, callback) {
        //console.log("Station.fetchByName()")
        // ----
        
        let url = "/api/v1.0/stations/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleStationError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleStationError("Error Validating Station")
            }
        } else {
            handleStationError("Error Loading Station - Missing Data")
        }
    }
    const handleStationError = function (msg, title, type) {
        //console.log("Station.handleStationError()")
        // ----
        
        if (!msg) {
            msg = "There was an error."
        }
        
        if (!title) {
            title = "Station"
        }
        
        if (!type) {
            type = "error"
        }
        
        toastr[type](msg, title)
        
    }
    const defaultDetail = function () {
        //console.log("Station.defaultDetail()")
        // ----
        
        return {
            city: {
                id: null,
                country_id: null,
                province_id: null,
                name: null,
                sort_order: null,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: userId,
                date_modified: formatDateMySQL(),
                modified_by: userId,
                note: null,
            },
            country: {
                id: null,
                name: null,
                sort_order: null,
                iso2: null,
                iso3: null,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: userId,
                date_modified: formatDateMySQL(),
                modified_by: userId,
                note: null,
            },
            created_by: userId,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            display_long: null,
            display_medium: null,
            display_short: null,
            enabled: 1,
            iata_code: null,
            id: null,
            keywords: null,
            gps_code: null,
            wikipedia_link: null,
            home_link: null,
            local_code: null,
            modified_by: userId,
            name: null,
            note: null,
            postal_code: null,
            province: {
                id: null,
                name: null,
                sort_order: null,
                country_id: null,
                iso2: null,
                iso3: null,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: userId,
                date_modified: formatDateMySQL(),
                modified_by: userId,
                note: null,
            },
            street_1: null,
            street_2: null,
        }
        
    }
    const setDetail = function (station) {
        //console.log("Station.setDetail()")
        // ----
        
        let detail = defaultDetail()
        
        if (station) {
            detail.city = (station.city) ? station.city : {
                id: null,
                country_id: null,
                province_id: null,
                name: null,
                sort_order: null,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: userId,
                date_modified: formatDateMySQL(),
                modified_by: userId,
                note: null,
            }
            detail.country = (station.country) ? station.country : {
                id: null,
                name: null,
                sort_order: null,
                iso2: null,
                iso3: null,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: userId,
                date_modified: formatDateMySQL(),
                modified_by: userId,
                note: null,
            }
            detail.province = (station.province) ? station.province : {
                id: null,
                name: null,
                sort_order: null,
                country_id: null,
                iso2: null,
                iso3: null,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: userId,
                date_modified: formatDateMySQL(),
                modified_by: userId,
                note: null,
            }
            detail.created_by = (station.created_by) ? station.created_by : userId
            detail.date_created = (station.date_created) ? station.date_created : formatDateMySQL()
            detail.date_modified = (station.date_modified) ? station.date_modified : formatDateMySQL()
            detail.display_long = (station.display_long) ? station.display_long : null
            detail.display_medium = (station.display_medium) ? station.display_medium : null
            detail.display_short = (station.display_short) ? station.display_short : null
            detail.enabled = (station.enabled) ? station.enabled : 1
            detail.iata_code = (station.iata_code) ? station.iata_code : null
            detail.id = (station.id && !isNaN(parseInt(station.id))) ? parseInt(station.id) : null
            detail.keywords = (station.keywords) ? station.keywords : []
            detail.modified_by = (station.modified_by) ? station.modified_by : userId
            detail.name = (station.name) ? station.name : null
            detail.note = (station.note) ? station.note : null
            detail.postal_code = (station.postal_code) ? station.postal_code : null
            detail.street_1 = (station.street_1) ? station.street_1 : null
            detail.street_2 = (station.street_2) ? station.street_2 : null
            detail.local_code = (station.local_code) ? station.local_code : null
            detail.gps_code = (station.gps_code) ? station.gps_code : null
            detail.home_link = (station.home_link) ? station.home_link : null
            detail.wikipedia_link = (station.wikipedia_link) ? station.wikipedia_link : null
        }
        
        return detail
    }
    const init = function (settings) {
        //console.log("Station.init()")
        // ----
        
        let stations = (settings && settings.stations) ? settings.stations : []
        
        if (_modal_product_depart_from_station || _modal_product_arrive_to_station) {
            
            resetStationForm("depart_from")
            resetStationForm("arrive_to")
            
            hideStationForm("depart_from")
            hideStationForm("arrive_to")
            
            loadAll(stations)
            initAutocomplete()
        }
        
    }
    const resetStationForm = function (type) {
        //console.log("Station.resetStationForm()")
        // ----
        
        if (_modal_product_depart_from_station_add_block && _modal_product_arrive_to_station_add_block) {
            if (type) {
                _modal_product_arrive_to_station.disabled = false
                _modal_product_depart_from_station.disabled = false
                
                clearStationForm(type)
                
                hideStationForm("depart_from")
                hideStationForm("arrive_to")
            }
        }
        
    }
    const hideStationForm = function (type) {
        //console.log("Station.hideStationForm()")
        // ----
        
        if (!type || !_modal_product_depart_from_station_add_block || !_modal_product_arrive_to_station_add_block) {
            return
        }
        
        if (type === "depart_from") {
            
            $(_modal_product_depart_from_station_add_block).hide()
            
            _modal_product_depart_from_station.disabled = false
            
            toggleEditFormLink(type)
            
        } else if (type === "arrive_to") {
            $(_modal_product_arrive_to_station_add_block).hide()
            
            _modal_product_arrive_to_station.disabled = false
            
            toggleEditFormLink(type)
        } else {
            //console.log("|__ type", type)
        }
        
        _modal_product_depart_from_station.disabled = false
        _modal_product_arrive_to_station.disabled = false
    }
    const loadAll = function (stations) {
        //console.log("Station.loadAll()")
        // ----
        
        Station.all = new Map()
        
        $.each(stations, function (k, station) {
            let detail = setDetail(station)
            let stationId = (detail && !isNaN(parseInt(detail.id))) ? parseInt(detail.id) : null
            
            Station.all.set(stationId, detail)
        })
        
    }
    const initAutocomplete = function () {
        //console.log("Station.initAutocomplete()")
        // ----
        
        if (_modal_product_depart_from_station) {
            
            $(_modal_product_depart_from_station)
                .on("click", function (e) {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("search", function () {
                    clearDepartFromFields()
                })
                .on("keyup", function () {
                    globalSelectedStationDepartFrom = false
                })
                .on("change", function () {
                    setTimeout(function () {
                        
                        let station_name = _modal_product_depart_from_station.value
                        
                        if (globalSelectedStationDepartFrom === false) {
                            
                            if (station_name === "") {
                                
                                globalSelectedStationDepartFrom = false
                                
                                clearDepartFromFields()
                                
                            } else {
                                stationExists(station_name, "depart_from")
                            }
                        }
                        
                    }, 200)
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/stations",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        
                        let station = suggestion.data
                        let type = "depart_from"
                        
                        if (station[0]) {
                            station = station[0]
                        }
                        
                        globalSelectedStationDepartFrom = true
                        
                        if (station) {
                            console.log("|__ station", station)
                            
                            populateStationForm(station, type)
                            toggleEditFormLink(type)
                            
                        } else {
                            
                            resetStationForm(type)
                            showStationForm(type)
                            toggleEditFormLink(type)
                            
                        }
                    },
                })
        }
        
        if (_modal_product_arrive_to_station) {
            
            $(_modal_product_arrive_to_station)
                .on("click", function () {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("keyup", function () {
                    globalSelectedStationArriveTo = false
                })
                .on("search", function () {
                    
                    clearArriveToFields()
                    
                    /*
                    if (_modal_product_arrive_to_station_id) {
                        _modal_product_arrive_to_station_id.value = ""
                    }
                    if (_modal_product_arrive_to_station) {
                        _modal_product_arrive_to_station.value = ""
                    }
                    //*/
                })
                .on("change", function () {
                    setTimeout(function () {
                        
                        let station_name = _modal_product_arrive_to_station.value
                        
                        if (globalSelectedStationArriveTo === false) {
                            if (station_name === "") {
                                clearArriveToFields()
                                globalSelectedStationArriveTo = false
                            } else {
                                stationExists(station_name, "arrive_to")
                            }
                        }
                        
                    }, 200)
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/stations",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        
                        let station = suggestion.data
                        let type = "arrive_to"
                        
                        if (station[0]) {
                            station = station[0]
                        }
                        
                        globalSelectedStationDepartFrom = true
                        
                        if (station) {
                            console.log("|__ station", station)
                            
                            populateStationForm(station, type)
                            toggleEditFormLink(type)
                            
                        } else {
                            
                            resetStationForm(type)
                            showStationForm(type)
                            toggleEditFormLink(type)
                            
                        }
                    },
                })
        }
        
    }
    const populateStationForm = function (station, type) {
        //console.log("Station.populateStationForm()", station, type)
        // ----
        
        if (!type || !_modal_product_depart_from_station_add_block || !_modal_product_arrive_to_station_add_block) {
            return
        }
        
        let displayType = "display_" + defaultLocationDisplayFormat
        let countryId = (station && station.country && station.country.id && !isNaN(parseInt(station.country.id))) ? parseInt(station.country.id) : null
        let provinceId = (station && station.province && station.province.id && !isNaN(parseInt(station.province.id))) ? parseInt(station.province.id) : null
        let provinceName = (station && station.province) ? station.province.name : null
        let countryName = (station && station.country) ? station.country.name : null
        let cityId = (station && station.city && station.city.id && !isNaN(parseInt(station.city.id))) ? parseInt(station.city.id) : null
        let cityName = (station && station.city && station.city.name) ? station.city.name : null
        let stationId = (station && station.id && !isNaN(parseInt(station.id))) ? parseInt(station.id) : null
        let stationName = (station && station.name) ? station.name : null
        let stationIATACode = (station && station.iata_code) ? station.iata_code : null
        let stationStreet1 = (station && station.street_1) ? station.street_1 : null
        let stationStreet2 = (station && station.street_2) ? station.street_2 : null
        let stationPostalCode = (station && station.postal_code) ? station.postal_code : null
        let gpsCode = (station && station.gps_code) ? station.gps_code : null
        let homeLink = (station && station.home_link) ? station.home_link : null
        let wikipediaLink = (station && station.wikipedia_link) ? station.wikipedia_link : null
        let stationKeywords = (station && station.keywords) ? station.keywords : []
        let cityDisplay = ""
        let localCode = (station && station.local_code) ? station.local_code : null
        if (cityName !== null && provinceName !== null && countryName !== null) {
            cityDisplay = `${cityName} (${provinceName}, ${countryName})`
        }
        
        if (type === "depart_from") {
            Station.departingStation = station
            
            _modal_product_country_id.value = countryId
            _modal_product_province_id.value = provinceId
            _modal_product_city_id.value = cityId
            
            _modal_product_depart_from_station.value = stationName
            _modal_product_depart_from_station_iata_code.value = stationIATACode
            _modal_product_depart_from_station_postal_code.value = stationPostalCode
            _modal_product_depart_from_station_street_1.value = stationStreet1
            _modal_product_depart_from_station_street_2.value = stationStreet2
            _modal_product_depart_from_station_gps_code.value = gpsCode
            _modal_product_depart_from_station_home_link.value = homeLink
            _modal_product_depart_from_station_wikipedia_link.value = wikipediaLink
            _modal_product_depart_from_station_city.value = cityDisplay
            _modal_product_depart_from_station_id.value = stationId
            _modal_product_depart_from_station_city_id.value = cityId
            _modal_product_depart_from_new_station_id.value = stationId
            _modal_product_depart_from_station_edit_link.dataset.stationId = stationId
            _modal_product_depart_from_station_local_code.value = localCode
            
            Station.departFromKeywords.set(stationKeywords)
            
        } else if (type === "arrive_to") {
            Station.arrivingStation = station
            
            _modal_product_arrive_to_station.value = stationName
            _modal_product_arrive_to_station_iata_code.value = stationIATACode
            _modal_product_arrive_to_station_postal_code.value = stationPostalCode
            _modal_product_arrive_to_station_street_1.value = stationStreet1
            _modal_product_arrive_to_station_street_2.value = stationStreet2
            _modal_product_arrive_to_station_gps_code.value = gpsCode
            _modal_product_arrive_to_station_home_link.value = homeLink
            _modal_product_arrive_to_station_wikipedia_link.value = wikipediaLink
            _modal_product_arrive_to_station_city.value = cityDisplay
            _modal_product_arrive_to_station_id.value = stationId
            _modal_product_arrive_to_station_city_id.value = cityId
            _modal_product_arrive_to_new_station_id.value = stationId
            _modal_product_arrive_to_station_edit_link.dataset.stationId = stationId
            _modal_product_arrive_to_station_local_code.value = localCode
            
            Station.arriveToKeywords.set(stationKeywords)
            
        }
        
    }
    const clearStationForm = function (type) {
        //console.log("Station.clearStationForm()")
        // ----
        
        if (!type) {
            return
        }
        
        $(_modal_product_station_day_span).val("1").trigger("change")
        
        if (type === "depart_from") {
            
            if (!_modal_product_depart_from_station_add_block) {return}
            
            if (Station.departFromKeywords) {
                Station.departFromKeywords.clear()
            }
            
            _modal_product_depart_from_new_station_id.value = ""
            _modal_product_depart_from_station_iata_code.value = ""
            _modal_product_depart_from_station_city.value = ""
            _modal_product_depart_from_station_city_id.value = ""
            _modal_product_depart_from_station_country_id.value = ""
            _modal_product_depart_from_station_province_id.value = ""
            _modal_product_depart_from_station_postal_code.value = ""
            _modal_product_depart_from_station_street_1.value = ""
            _modal_product_depart_from_station_street_2.value = ""
            _modal_product_depart_from_station_id.value = ""
            _modal_product_country_id.value = ""
            _modal_product_province_id.value = ""
            _modal_product_city_id.value = ""
            
            _modal_product_depart_from_station.disabled = false
            
            _modal_product_depart_from_station_edit_link.dataset.stationId = ""
            
            clearAllValidation()
        } else if (type === "arrive_to") {
            
            if (!_modal_product_arrive_to_station_add_block) {return}
            
            if (Station.arriveToKeywords) {
                Station.arriveToKeywords.clear()
            }
            
            _modal_product_arrive_to_new_station_id.value = ""
            _modal_product_arrive_to_station_iata_code.value = ""
            _modal_product_arrive_to_station_city.value = ""
            _modal_product_arrive_to_station_city_id.value = ""
            _modal_product_arrive_to_station_country_id.value = ""
            _modal_product_arrive_to_station_province_id.value = ""
            _modal_product_arrive_to_station_postal_code.value = ""
            _modal_product_arrive_to_station_street_1.value = ""
            _modal_product_arrive_to_station_street_2.value = ""
            _modal_product_arrive_to_station_id.value = ""
            
            _modal_product_arrive_to_station.disabled = false
            
            _modal_product_arrive_to_station_edit_link.dataset.stationId = ""
            
            clearAllValidation()
            
        } else {
            
            _modal_product_depart_from_station_edit_link.dataset.toggle = "hidden"
            _modal_product_arrive_to_station_edit_link.dataset.toggle = "hidden"
            
            $(_modal_product_depart_from_station_edit_link).hide()
            $(_modal_product_arrive_to_station_edit_link).hide()
            
        }
    }
    const toggleEditFormLink = function (type) {
        //console.log("Station.toggleEditFormLink(type)", type)
        // ----
        
        if (type) {
            /*
            console.log("|__ _modal_product_depart_from_station_edit_link", _modal_product_depart_from_station_edit_link)
            console.log("|__ _modal_product_arrive_to_station_edit_link", _modal_product_arrive_to_station_edit_link)
            //*/
            
            if (type === "depart_from" && _modal_product_depart_from_station_edit_link) {
                let toggleStatus = (_modal_product_depart_from_station_edit_link.dataset.toggle) ? _modal_product_depart_from_station_edit_link.dataset.toggle : "hidden"
                
                /*
                console.log("|__ toggleStatus", toggleStatus)
                console.log("|__ _modal_product_depart_from_new_station_id", _modal_product_depart_from_new_station_id)
                console.log("|__ _modal_product_depart_from_station", _modal_product_depart_from_station)
                console.log("|__ _modal_product_depart_from_station_city_id", _modal_product_depart_from_station_city_id)
                console.log("|__ _modal_product_depart_from_new_station_id.value", _modal_product_depart_from_new_station_id.value)
                console.log("|__ _modal_product_depart_from_new_station_id.value", _modal_product_depart_from_new_station_id.value)
                console.log("|__ _modal_product_depart_from_station_city_id.value", _modal_product_depart_from_station_city_id.value)
                //*/
                
                if (_modal_product_depart_from_new_station_id && _modal_product_depart_from_station && _modal_product_depart_from_station_city_id
                    && _modal_product_depart_from_new_station_id.value !== "" && _modal_product_depart_from_station.value !== ""
                    && _modal_product_depart_from_station_city_id.value !== "") {
                    // ----------------------------------------------------------------------------------------------------
                    
                    _modal_product_depart_from_station_edit_link.dataset.toggle = "shown"
                    
                    $(_modal_product_depart_from_station_edit_link).show()
                } else {
                    _modal_product_depart_from_station_edit_link.dataset.toggle = "hidden"
                    
                    $(_modal_product_depart_from_station_edit_link).hide()
                }
            } else if (type === "arrive_to" && _modal_product_arrive_to_station_edit_link) {
                let toggleStatus = (_modal_product_arrive_to_station_edit_link.dataset.toggle) ? _modal_product_arrive_to_station_edit_link.dataset.toggle : "hidden"
                
                //*
                console.log("|__ toggleStatus", toggleStatus)
                console.log("|__ _modal_product_arrive_to_new_station_id", _modal_product_arrive_to_new_station_id)
                console.log("|__ _modal_product_arrive_to_station", _modal_product_arrive_to_station)
                console.log("|__ _modal_product_arrive_to_station_city_id", _modal_product_arrive_to_station_city_id)
                console.log("|__ _modal_product_arrive_to_new_station_id.value", _modal_product_arrive_to_new_station_id.value)
                console.log("|__ _modal_product_arrive_to_new_station_id.value", _modal_product_arrive_to_new_station_id.value)
                console.log("|__ _modal_product_arrive_to_station_city_id.value", _modal_product_arrive_to_station_city_id.value)
                //*/
                
                if (
                    _modal_product_arrive_to_new_station_id &&
                    _modal_product_arrive_to_station &&
                    _modal_product_arrive_to_station_city_id &&
                    _modal_product_arrive_to_new_station_id.value !== "" &&
                    _modal_product_arrive_to_station.value !== "" &&
                    _modal_product_arrive_to_station_city_id.value !== ""
                ) {
                    console.log("|__ |__ shown")
                    _modal_product_arrive_to_station_edit_link.dataset.toggle = "shown"
                    
                    $(_modal_product_arrive_to_station_edit_link).show()
                    
                } else {
                    console.log("|__ |__ hidden")
                    
                    _modal_product_arrive_to_station_edit_link.dataset.toggle = "hidden"
                    
                    $(_modal_product_arrive_to_station_edit_link).hide()
                }
                
            } else {
                
                _modal_product_depart_from_station_edit_link.dataset.toggle = "hidden"
                _modal_product_arrive_to_station_edit_link.dataset.toggle = "hidden"
                
                $(_modal_product_depart_from_station_edit_link).hide()
                $(_modal_product_arrive_to_station_edit_link).hide()
                
            }
            
        }
    }
    
    return {
        departingStation: null,
        departFromKeywords: null,
        arriveToKeywords: null,
        resetStationForm: function (type) {
            resetStationForm(type)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const Province = (function () {
    "use strict"
    
    const class_name = "form-new-province"
    const form_id = "form_new_province"
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const form_rules = {
        rules: {
            province_name: {
                required: true,
                //minlength: 3,
            },
            province_iso2: {
                //required: true,
                minlength: 2,
                maxlength: 2,
            },
            province_iso3: {
                //required: true,
                minlength: 1,
                maxlength: 2,
            },
        },
        messages: {
            province_name: {
                required: "required",
                //minlength: "too short",
            },
            province_iso2: {
                //required: "required",
                minlength: "too short",
                maxlength: "too long",
            },
            province_iso3: {
                //required: "required",
                minlength: "too short",
                maxlength: "too long",
            },
        },
    }
    
    const validate_form = function () {
        let _name = document.getElementById("province_name")
        let _province_iso2 = document.getElementById("province_iso2")
        let _province_iso3 = document.getElementById("province_iso3")
        let valid = true
        // ----
        if (!_name || !_province_iso2 || !_province_iso3) {
            handle_country_error("Error Processing Data")
            return false
        }
        
        if (_name.value === "") {
            $(_name).addClass("is-invalid")
            $("#province_name-error")
                .text("Required: Field is required")
                .show()
            valid = false
        } else {
            $(_name).removeClass("is-invalid")
            $("#province_name-error")
                .text("")
                .hide()
        }
        
        if (_province_iso2.value === "") {
            $(_province_iso2).addClass("is-invalid")
            $("#province_iso2-error")
                .text("Required: Field is required")
                .show()
            valid = false
        } else {
            $(_province_iso2).removeClass("is-invalid")
            $("#province_iso2-error")
                .text("")
                .hide()
        }
        
        if (_province_iso3.value === "") {
            $(_province_iso3).addClass("is-invalid")
            $("#province_iso3-error")
                .text("Required: Field is required")
                .show()
            valid = false
        } else {
            $(_province_iso3).removeClass("is-invalid")
            $("#province_iso3-error")
                .text("")
                .hide()
        }
        
        return valid
    }
    
    const handle_province_error = function (msg) {
        toastr.error(msg)
        //console.log(msg)
    }
    
    const on_click_outside = (e) => {
        let tar = $(e.target).parents("div." + class_name)
        
        if (!tar[0] && !e.target.className.includes("select-add-option")) {
            Province.close()
        }
    }
    
    const build_drop_downs = function (settings) {
        if (settings) {
            if (settings.dropdowns) {
                $.each(settings.dropdowns, function (i, dropdown_id) {
                    let country_id = Country.id
                    let province_id = Province.id
                    let element = document.getElementById(dropdown_id)
                    if (element) {
                        
                        $(element)
                            .select2({
                                "language": {
                                    "searching": function () {
                                    },
                                },
                                "escapeMarkup": function (markup) {
                                    return markup
                                },
                            })
                            .on("select2:open", function (e) {
                                let x = document.querySelectorAll("[aria-controls='select2-" + dropdown_id + "-results']")
                                if (x[0]) {
                                    let _filterProvinceSearch = x[0]
                                    $(_filterProvinceSearch).attr("id", "" + dropdown_id + "_search")
                                    if (!document.getElementById("filter_province_add_icon")) {
                                        let i = document.createElement("i")
                                        i.classList = "select-add-option fas fa-plus filter_province_add"
                                        i.id = "filter_province_add_icon"
                                        i.addEventListener("click", event => {
                                            let val = _filterProvinceSearch.value
                                            $(element).select2("close")
                                            Province.add(this, val, dropdown_id)
                                        })
                                        _filterProvinceSearch.after(i)
                                    }
                                    $(".filter_province_add").hide()
                                    if (_filterProvinceSearch) {
                                        _filterProvinceSearch.addEventListener("keyup", event => {
                                            if (_filterProvinceSearch.value !== "") {
                                                $(".filter_province_add").show()
                                            } else {
                                                $(".filter_province_add").hide()
                                            }
                                        })
                                    }
                                }
                                
                            })
                            .on("change", function () {
                                let city_el_id = $(this)
                                    .attr("id")
                                    .replace("province", "city")
                                
                                let country_el_id = $(this)
                                    .attr("id")
                                    .replace("province", "country")
                                
                                let city_element = document.getElementById(city_el_id)
                                let country_element = document.getElementById(country_el_id)
                                
                                if (city_element) {
                                    if (country_element) {
                                        country_id = parseInt(country_element.value)
                                        if (!isNaN(parseInt(country_element.value))) {
                                            
                                            //
                                            
                                            if (!isNaN(parseInt($(this).val()))) {
                                                City.get(country_id, parseInt($(this).val()), city_element)
                                            } else {
                                                City.id = null
                                                City.get(country_id, null, city_element)
                                                if (City.id) {
                                                
                                                }
                                            }
                                            //
                                            
                                        } else {
                                            City.id = null
                                            City.get(null, null, city_element)
                                        }
                                    }
                                }
                                City.id = null
                                Province.id = null
                            })
                        
                    }
                })
            }
        }
    }
    
    const fetch_province_list = function (dataToSend, callback) {
        if (dataToSend) {
            try {
                
                //*
                sendGetRequest("/api/v1.0/provinces", dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_province_error("Oops: 1")
                    }
                })
                //*/
            } catch (e) {
                //console.log("error", e)
                return handle_province_error("Error Validating Province")
            }
        } else {
            return handle_province_error("Error Loading Province- Missing Data")
        }
    }
    
    const set_detail = function (province) {
        let detail = clear_detail()
        let id = null
        if (province) {
            id = validInt(province.id)
            
            detail = {
                id: validInt(province.id),
                name: (province.name) ? province.name : null,
                sort_order: (province.sort_order) ? province.sort_order : 9999999,
                country_id: validInt(province.country_id),
                iso2: (province.iso2) ? province.iso2 : null,
                iso3: (province.iso3) ? province.iso3 : null,
                enabled: (province.enabled) ? province.enabled : 1,
                date_created: (province.date_created) ? province.date_created : formatDateMySQL(),
                created_by: (province.created_by) ? province.created_by : user_id,
                date_modified: (province.date_modified) ? province.date_modified : formatDateMySQL(),
                modified_by: (province.modified_by) ? province.modified_by : user_id,
                note: (province.note) ? province.note : null,
            }
        }
        Province.id = id
        Province.detail = detail
        return detail
    }
    
    const clear_detail = function () {
        return {
            id: null,
            name: null,
            sort_order: 9999999,
            iso2: null,
            iso3: null,
            enabled: 1,
            note: null,
            created_by: user_id,
            modified_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
        }
    }
    
    const build_form = function (elem, val, dropdown_id) {
        let id = $(elem).attr("id")
        let parent = $(elem).parents("div.row")
        let value = ""
        
        if (val) {
            value = val
        }
        
        if (!id || !parent[0]) {
            return
        }
        
        if (document.getElementById(form_id)) {
            return
        }
        
        let newProvinceForm = document.createElement("div")
        
        let heading1 = document.createElement("h5")
        
        let row1 = document.createElement("div")
        let row2 = document.createElement("div")
        let col1 = document.createElement("div")
        let col2 = document.createElement("div")
        let col3 = document.createElement("div")
        let col4 = document.createElement("div")
        let col5 = document.createElement("div")
        
        let form_element1 = document.createElement("div")
        let form_element2 = document.createElement("div")
        let form_element3 = document.createElement("div")
        let form_element4 = document.createElement("div")
        
        let error_element1 = document.createElement("div")
        let error_element2 = document.createElement("div")
        let error_element3 = document.createElement("div")
        
        let name_text_element = document.createElement("input")
        let name_label_element = document.createElement("label")
        let iso2_text_element = document.createElement("input")
        let iso2_label_element = document.createElement("label")
        let iso3_text_element = document.createElement("input")
        let iso3_label_element = document.createElement("label")
        
        let save_button = document.createElement("button")
        let cancel_button = document.createElement("button")
        
        newProvinceForm.id = form_id
        newProvinceForm.classList = ["card card-body m-3 " + class_name]
        
        heading1.classList = "card-title"
        heading1.innerText = "Province Details"
        
        name_text_element.id = "province_name"
        name_text_element.name = "province_name"
        name_text_element.type = "text"
        name_text_element.classList = ["form-control " + class_name]
        name_label_element.htmlFor = "province_name"
        name_label_element.innerHTML = "Name:"
        error_element1.id = "province_name-error"
        
        iso2_text_element.id = "province_iso2"
        iso2_text_element.name = "province_iso2"
        iso2_text_element.type = "text"
        iso2_text_element.maxLength = 2
        iso2_text_element.classList = ["form-control " + class_name]
        iso2_label_element.htmlFor = "province_iso2"
        iso2_label_element.innerHTML = "ISO2:"
        error_element2.id = "province_iso2-error"
        
        iso3_text_element.id = "province_iso3"
        iso3_text_element.name = "province_iso3"
        iso3_text_element.type = "text"
        iso3_text_element.maxLength = 3
        iso3_text_element.classList = ["form-control " + class_name]
        iso3_label_element.htmlFor = "province_iso3"
        iso3_label_element.innerHTML = "ISO3:"
        error_element3.id = "province_iso3-error"
        
        save_button.classList = ["btn btn-primary btn-sm waves-effect waves-light"]
        save_button.innerText = "save"
        save_button.type = "button"
        
        save_button.addEventListener("click", event => {
            Province.save(elem, dropdown_id)
        })
        
        cancel_button.classList = ["btn btn-outline-danger btn-sm waves-effect waves-light"]
        cancel_button.innerText = "cancel"
        cancel_button.type = "button"
        
        cancel_button.addEventListener("click", event => {
            destroy_form()
        })
        
        row1.classList = ["row"]
        row2.classList = ["row"]
        
        col1.classList = ["col-lg-3 mb-1"]
        col2.classList = ["col-lg-3 mb-1"]
        col3.classList = ["col-lg-3 mb-1"]
        col4.classList = ["col-lg-3 mb-1"]
        
        col5.classList = ["col-12 mb-1 text-right"]
        
        form_element1.classList = ["form-element"]
        form_element2.classList = ["form-element"]
        form_element3.classList = ["form-element"]
        form_element4.classList = ["form-element"]
        
        error_element1.classList = ["error w-100 text-center"]
        error_element2.classList = ["error w-100 text-center"]
        error_element3.classList = ["error w-100 text-center"]
        
        form_element1.appendChild(name_label_element)
        form_element1.appendChild(name_text_element)
        form_element1.appendChild(error_element1)
        
        col1.appendChild(form_element1)
        
        form_element2.appendChild(iso2_label_element)
        form_element2.appendChild(iso2_text_element)
        form_element2.appendChild(error_element2)
        
        col2.appendChild(form_element2)
        
        form_element3.appendChild(iso3_label_element)
        form_element3.appendChild(iso3_text_element)
        form_element3.appendChild(error_element3)
        
        col3.appendChild(form_element3)
        
        row1.appendChild(col1)
        row1.appendChild(col2)
        row1.appendChild(col3)
        row1.appendChild(col4)
        
        col5.append(cancel_button)
        col5.appendChild(save_button)
        
        row2.appendChild(col5)
        
        newProvinceForm.appendChild(heading1)
        newProvinceForm.appendChild(row1)
        newProvinceForm.appendChild(row2)
        
        parent[0].appendChild(newProvinceForm)
        
        name_text_element.value = value
        name_text_element.focus({ preventScroll: false })
        
        window.addEventListener("click", on_click_outside)
    }
    
    const destroy_form = function () {
        let elem = document.getElementById(form_id)
        if (elem) {
            elem.parentNode.removeChild(elem)
            window.removeEventListener("click", on_click_outside)
        }
    }
    
    const set = function (settings) {
    
    }
    
    const get = function (country_id, el) {
        Province.all = new Map()
        if (!el) {
            return
        }
        let province_id = ""
        if (Province.id !== null) {
            province_id = Province.id
        }
        
        if (!country_id) {
            $(el).BuildDropDown({
                data: Array.from(Province.all.values()),
                title: "Province",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            $(el).val("").trigger("change")
            return
        }
        
        let dataToSend = {
            country_id: country_id,
        }
        
        fetch_province_list(dataToSend, function (provinces) {
            if (provinces) {
                load_all(provinces)
                $(el).BuildDropDown({
                    data: Array.from(Province.all.values()),
                    title: "Province",
                    id_field: "id",
                    text_field: "name",
                    first_selectable: false,
                })
                $(el).val(province_id).trigger("change")
                
            }
        })
        
    }
    
    /**
     * load provinces into object
     *
     * @param provinces
     */
    const load_all = function (provinces) {
        Province.all = new Map()
        
        if (provinces) {
            $.each(provinces, function (k, province) {
                let detail = set_detail(province)
                Province.all.set(detail.id, detail)
            })
        }
    }
    
    const add = function (elem, val, dropdown_id) {
        if (!elem) {
            return
        }
        
        build_form(elem, val, dropdown_id)
    }
    
    const save = function ($this, dropdown_id) {
        let province_detail = {}
        let _name = document.getElementById("province_name")
        let _province_iso2 = document.getElementById("province_iso2")
        let _province_iso3 = document.getElementById("province_iso3")
        let _country_id = document.getElementById(dropdown_id.replace(/province_id/g, "") + "country_id")
        if (!isNaN(parseInt(_country_id.value))) {
            
            if (_name, _province_iso2, _province_iso3, _country_id) {
                if (validate_form()) {
                    province_detail.name = _name.value
                    province_detail.iso2 = _province_iso2.value
                    province_detail.iso3 = _province_iso3.value
                    province_detail.country_id = parseInt(_country_id.value)
                    
                    confirmDialog(`Would you like to update?`, (ans) => {
                        if (ans) {
                            update_province_record($this, remove_nulls(province_detail))
                        }
                    })
                }
            }
            
        }
        
    }
    
    const update_province_record = function ($this, dataToSend) {
        if (dataToSend) {
            try {
                sendPostRequest("/api/v1.0/provinces/update", dataToSend, function (data, status, xhr) {
                    if (data && data[0]) {
                        let new_province = data[0]
                        //console.log("new_province", new_province)
                        Province.all.set(new_province.id, new_province)
                        let province_elements = $("select[data-type='province']")
                        Province.id = new_province.id
                        City.id = null
                        province_elements.each(function (index, element) {
                            var newOption = new Option(new_province.name, new_province.id, false, false)
                            $(element).append(newOption).trigger("change")
                        })
                        
                        $($this).val(new_province.id).trigger("change")
                        
                        Province.close()
                        toastr.success("Province: " + new_province.id + " updated")
                        
                    } else {
                        return handle_province_error("Error: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handle_province_error("Error: Validating Province")
            }
        } else {
            //console.log("Error: Missing Data")
            handle_province_error("Error: Missing Data")
        }
    }
    
    const update_select = function (country_id, elem) {
    
    }
    
    const init = function (settings) {
        build_drop_downs(settings)
    }
    
    return {
        detail: {},
        all: new Map(),
        id: null,
        set_detail: function (province) {
            set_detail(province)
        },
        update_select: function (country_id, elem) {
            update_select(country_id, elem)
        },
        close: function () {
            destroy_form()
        },
        save: function (country_id, dropdown_id) {
            save(country_id, dropdown_id)
        },
        get: function (country_id, el) {
            get(country_id, el)
        },
        add: function (elem, val, dropdown_id) {
            add(elem, val, dropdown_id)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const Country = (function () {
    "use strict"
    
    const class_name = "form-new-country"
    const form_id = "form_new_country"
    const _country_iso3 = document.getElementById("country_iso3")
    const _country_iso2 = document.getElementById("country_iso2")
    const _country_name = document.getElementById("country_name")
    const _form_new_country = document.getElementById("form_new_country")
    const _new_country_submit_button = document.getElementById("new_country_submit_button")
    const _new_country_cancel_button = document.getElementById("new_country_cancel_button")
    const _modal_product_country_cars = document.getElementById("modal_product_country_cars")
    const _modal_product_country_id = document.getElementById("modal_product_country_id")
    const _modal_product_province_id = document.getElementById("modal_product_province_id")
    const _modal_product_city_id = document.getElementById("modal_product_city_id")
    const _modal_product_location_id = document.getElementById("modal_product_location_id")
    const _modal_new_product = document.getElementById("modal_new_product")
    const formRules = {
        rules: {
            country_name: {
                required: true,
                minlength: 3,
            },
            country_iso2: {
                required: true,
                minlength: 2,
            },
            country_iso3: {
                required: true,
                minlength: 3,
            },
        },
        messages: {
            country_name: {
                required: "Field Required",
                minlength: "too short",
            },
            country_iso2: {
                required: "Field Required",
                minlength: "too short",
            },
            country_iso3: {
                required: "Field Required",
                minlength: "too short",
            },
        },
    }
    
    let userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let globalSelectedCountry = false
    
    $(_new_country_submit_button)
        .on("click", function () {
            //console.log("Country.new_country_submit_button:click()")
            // ----
            
            save(this)
            
        })
    
    $(_new_country_cancel_button)
        .on("click", function () {
            //console.log("Country.new_country_cancel_button:click()")
            // ----
            
            clearNewCountryForm()
        })
    
    // ----
    
    const initAutocomplete = function () {
        //console.log("Country.initAutocomplete()")
        // ----
        
        if (_form_new_country) {
            if (_modal_product_country_cars) {
                _modal_product_country_cars.value = ""
            }
            clearNewCountryForm()
            hideNewCountryForm()
            $(_form_new_country)
                .on("change", function () {
                    console.log("Country.form_new_country:change()")
                    // ----
                    validateNewCountryForm()
                })
        }
        
        if (_modal_product_country_cars) {
            $(_modal_product_country_cars)
                .on("search", function () {
                    //console.log("Country.modal_product_country_cars:search()")
                    // ----
                    
                    clearNewCountryForm()
                    populateNewCountryForm()
                    //hideNewCountryForm()
                    if (_modal_product_country_cars) {
                        _modal_product_country_cars.value = ""
                    }
                })
                .on("click", function (e) {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("keyup", function () {
                    //console.log("Country.modal_product_country_cars:keyup()")
                    // ----
                    
                    let countryName = _modal_product_country_cars.value
                    //console.log("|__ countryName", countryName)
                    
                    globalSelectedCountry = false
                    
                    if (countryName === "") {
                        clearNewProductModalForm()
                    }
                    
                })
                .on("change", function () {
                    //console.log("Country.modal_product_country_cars:change()")
                    // ----
                    
                    let countryName = $(this).val()
                    //console.log("|__ countryName", countryName)
                    
                    globalSelectedCountry = false
                    
                    setTimeout(function () {
                        
                        if (countryName === "") {
                            clearNewProductModalForm()
                        } else {
                            countryExists(countryName)
                        }
                        
                    }, 200)
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/countries",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion.data) {
                            return
                        }
                        
                        let country = setDetail(suggestion.data)
                        let countryId = (country && !isNaN(parseInt(country.id))) ? parseInt(country.id) : null
                        let detail = Country.all.get(countryId)
                        
                        globalSelectedCountry = true
                        populateNewCountryForm(country)
                    },
                })
        }
    }
    
    const clearNewProductValidation = function () {
        //console.log("Country.clearNewProductValidation()")
        // ----
        
        $(_country_name).hideError()
        $(_country_iso2).hideError()
        $(_country_iso3).hideError()
    }
    
    const validateNewCountryForm = function () {
        //console.log("Country.validateNewCountryForm()")
        // ----
        
        let valid = true
        let countryName = (_country_name && _country_name.value !== "") ? _country_name.value : null
        let countryISO3 = (_country_iso3 && _country_iso3.value !== "") ? _country_iso3.value : null
        let countryISO2 = (_country_iso2 && _country_iso2.value !== "") ? _country_iso2.value : null
        
        if (is_null(countryName)) {
            valid = false
            $(_country_name).showError("oops")
        } else {
            $(_country_name).hideError()
        }
        
        if (is_null(countryISO3)) {
            valid = false
            $(_country_iso3).showError("oops")
        } else {
            $(_country_iso3).hideError()
        }
        
        if (is_null(countryISO2)) {
            valid = false
            $(_country_iso2).showError("oops")
        } else {
            $(_country_iso2).hideError()
        }
        
        if (valid) {
            return {
                name: countryName,
                iso2: countryISO2,
                iso3: countryISO3,
                sort_order: null,
                enabled: 1,
                currency_id: 5,
            }
        }
    }
    
    const hideNewCountryForm = function () {
        //console.log("Country.hideNewCountryForm()")
        // ----
        
        if (_form_new_country) {
            if (_country_name) {
                _country_name.disabled = true
            }
            
            if (_country_iso2) {
                _country_iso2.disabled = true
            }
            
            if (_country_iso3) {
                _country_iso3.disabled = true
            }
            
            $(_form_new_country).hide()
            
        }
        
    }
    
    const showNewCountryForm = function () {
        //console.log("Country.showNewCountryForm()")
        // ----
        
        if (_form_new_country) {
            
            if (_country_iso2) {
                _country_iso2.disabled = false
            }
            
            if (_country_iso3) {
                _country_iso3.disabled = false
            }
            
            $(_form_new_country).show()
            
        }
        
    }
    
    const clearNewCountryForm = function () {
        //console.log("Country.clearNewCountryForm()")
        // ----
        
        if (_modal_product_country_id) {
            _modal_product_country_id.value = ""
        }
        if (_modal_product_province_id) {
            _modal_product_province_id.value = ""
        }
        if (_modal_product_city_id) {
            _modal_product_city_id.value = ""
        }
        if (_country_iso3) {
            _country_iso3.value = ""
        }
        if (_country_iso2) {
            _country_iso2.value = ""
        }
        if (_country_name) {
            _country_name.value = ""
        }
        
        globalSelectedCountry = false
        clearNewProductValidation()
    }
    
    const populateNewCountryForm = function (country) {
        //console.log("Country.populateNewCountryForm(country)", country)
        // ----
        
        let name, iso2, iso3, id = ""
        
        if (country) {
            id = (!isNaN(parseInt(country.id))) ? parseInt(country.id) : ""
            name = (country.name) ? country.name : ""
            iso2 = (country.iso2) ? country.iso2 : ""
            iso3 = (country.iso3) ? country.iso3 : ""
            
        } else {
            if (_modal_product_country_cars) {
                name = _modal_product_country_cars.value
                iso2 = ""
                iso3 = ""
                id = ""
            }
        }
        
        if (_modal_product_location_id) {
            _modal_product_location_id.value = id
        }
        
        if (_modal_product_country_id) {
            _modal_product_country_id.value = id
        }
        if (_modal_product_province_id) {
            _modal_product_province_id.value = ""
        }
        if (_modal_product_city_id) {
            _modal_product_city_id.value = ""
        }
        if (_country_iso3) {
            _country_iso3.value = iso3
        }
        if (_country_iso2) {
            _country_iso2.value = iso2
        }
        if (_country_name) {
            _country_name.value = name
        }
        if (_modal_product_country_cars) {
            _modal_product_country_cars.value = name
        }
    }
    
    const fetchByName = function (dataToSend, callback) {
        let url = "/api/v1.0/countries/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data) {
                    console.log("|__ data", data)
                    
                    if (data) {
                        return callback(data)
                    } else {
                        handleCountryError("Oops: 1")
                    }
                })
            } catch (e) {
                console.log("error", e)
                return handleCountryError("Error Validating Country")
            }
        } else {
            return handleCountryError("Error Loading Country - Missing Data")
        }
    }
    
    const clearNewProductModalForm = function () {
        //console.log("Country.clearNewProductModalForm()")
        // ----
        
        if (_country_name) {
            _country_name.value = ""
        }
        if (_country_iso2) {
            _country_iso2.value = ""
        }
        if (_country_iso3) {
            _country_iso3.value = ""
        }
        if (_modal_product_country_id) {
            _modal_product_country_id.value = ""
        }
        if (_modal_product_province_id) {
            _modal_product_province_id.value = ""
        }
        if (_modal_product_city_id) {
            _modal_product_city_id.value = ""
        }
        if (_modal_product_location_id) {
            _modal_product_location_id.value = ""
        }
        
        globalSelectedCountry = false
        clearNewProductValidation()
        
    }
    
    const countryExists = function (name) {
        //console.log("Country.countryExists(name)", name)
        // ----
        
        if (globalSelectedCountry === false) {
            if (name && name !== "") {
                let dataToSend = { name: name }
                //console.log("|__ dataToSend", dataToSend)
                
                fetchByName(dataToSend, function (data) {
                    //console.log("|__ |__ data", data)
                    let country
                    
                    if (data && data.length) {
                        country = data
                        if (data[0]) {
                            country = data[0]
                        }
                        
                    }
                    
                    if (country && country.length) {
                        
                        globalSelectedCountry = true
                        clearNewCountryForm()
                        populateNewCountryForm(country)
                    } else {
                        globalSelectedCountry = false
                        
                        confirmDialog(`The country: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                            if (ans) {
                                clearNewCountryForm()
                                populateNewCountryForm()
                                showNewCountryForm()
                            } else {
                                clearNewProductModalForm()
                                if (_modal_product_country_cars) {
                                    _modal_product_country_cars.value = ""
                                }
                            }
                        })
                    }
                })
            } else {
                handleCountryError("here")
            }
        }
    }
    
    const handleCountryError = function (msg, title, type) {
        //console.log("Country.handleCountryError(msg)", msg)
        // ----
        
        let messageTitle = (title) ? title : "Country"
        let messageType = (type) ? type : "error"
        
        toastr[messageType](msg, messageTitle)
    }
    
    const save = function ($this) {
        //console.log("Country.initAutocomplete()")
        // ----
        
        if (_country_name && _form_new_country && _country_iso2 && _country_iso3) {
            
            if (validateNewCountryForm()) {
                let country_detail = {}
                
                country_detail.name = (_country_name && _country_name.value !== "") ? _country_name.value : null
                country_detail.iso2 = (_country_iso2 && _country_iso2.value !== "") ? _country_iso2.value : null
                country_detail.iso3 = (_country_iso3 && _country_iso3.value !== "") ? _country_iso3.value : null
                country_detail.enabled = 1
                country_detail.sort_order = null
                
                confirmDialog(`Would you like to update?`, (ans) => {
                    if (ans) {
                        updateCountryRecord($this, remove_nulls(country_detail))
                    }
                })
                
            }
        } else {
            toastr.error("Error: 2")
        }
        
    }
    
    const updateCountryRecord = function ($this, dataToSend) {
        //console.log("Country.updateCountryRecord(dataToSend)", dataToSend)
        // ----
        
        if (dataToSend) {
            try {
                sendPostRequest("/api/v1.0/countries/update", dataToSend, function (data) {
                    let country, countryId, countryName
                    let country_elements = $("select[data-type='country']")
                    
                    if (data) {
                        country = setDetail((data[0]) ? data[0] : data)
                        
                        if (country) {
                            
                            countryName = (country.name) ? country.name : null
                            countryId = (country.id) ? country.id : null
                            
                            if (countryId !== null && countryName !== null) {
                                Country.all.set(countryId, country)
                                
                                country_elements.each(function (index, element) {
                                    let newOption = new Option(countryName, countryId, false, false)
                                    
                                    if (countryName !== null && countryId !== null) {
                                        $(element).append(newOption).trigger("change")
                                    }
                                })
                                
                                $($this).val(countryId).trigger("change")
                                
                                if (_modal_new_product && _form_new_country) {
                                    
                                    initAutocomplete()
                                    populateNewCountryForm(country)
                                    //hideNewCountryForm()
                                    if (_modal_product_country_cars) {
                                        _modal_product_country_cars.value = countryName
                                    }
                                } else {
                                    Country.close()
                                }
                                
                                handleCountryError(countryName + " was updated", "Country", "success")
                            }
                        }
                    } else {
                        return handleCountryError("Error: 1")
                    }
                })
            } catch (e) {
                console.log("error", e)
                return handleCountryError("Error: Validating Country")
            }
            
        } else {
            console.log("Error: Missing Data")
            return handleCountryError("Error: Missing Data")
        }
    }
    
    const setDetail = function (country) {
        //console.log("Country.setDetail(country)", country)
        // ----
        
        let detail = clearDetail()
        let id = null
        
        if (country) {
            /*
            console.log("|__ country", country)
            console.log("|__ country.id", country.id)
            console.log("|__ country.ios2", country.iso2)
            console.log("|__ country.sort_order", country.sort_order)
            //*/
            id = validInt(country.id)
            detail["id"] = validInt(country.id)
            detail["name"] = (country.name) ? country.name : null
            detail["sort_order"] = (country.sort_order) ? country.sort_order : null
            detail["iso2"] = (country.iso2) ? country.iso2 : null
            detail["iso3"] = (country.iso3) ? country.iso3 : null
            detail["currency_id"] = validInt(country.currency_id)
            detail["enabled"] = (country.enabled) ? country.enabled : 1
            detail["date_created"] = (country.date_created) ? country.date_created : formatDateMySQL()
            detail["created_by"] = (country.created_by) ? country.created_by : userId
            detail["date_modified"] = (country.date_modified) ? country.date_modified : formatDateMySQL()
            detail["modified_by"] = (country.modified_by) ? country.modified_by : userId
            detail["note"] = (country.note) ? country.note : null
            detail["display_long"] = (country.display_long) ? country.display_long : null
            detail["display_medium"] = (country.display_medium) ? country.display_medium : null
            detail["display_short"] = (country.display_short) ? country.display_short : null
        }
        
        Country.id = id
        Country.detail = detail
        return detail
    }
    
    const clearDetail = function () {
        //console.log("Country.clearDetail()")
        // ----
        
        return {
            id: null,
            name: null,
            sort_order: null,
            iso2: null,
            iso3: null,
            currency_id: null,
            enabled: 1,
            note: null,
            created_by: userId,
            modified_by: userId,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            display_long: null,
            display_medium: null,
            display_short: null,
        }
    }
    
    const onClickOutside = (e) => {
        //console.log("Country.onClickOutside(e)", e)
        // ----
        
        let tar = $(e.target).parents("div." + class_name)
        
        if (!tar[0] && !e.target.className.includes("select-add-option")) {
            Country.close()
        }
    }
    
    // ----
    
    const build_drop_downs = function (settings) {
        
        if (settings) {
            
            if (settings.dropdowns) {
                $.each(settings.dropdowns, function (i, dropdown_id) {
                    let element = document.getElementById(dropdown_id)
                    if (element) {
                        $(element)
                            .select2({
                                "language": {
                                    "searching": function () {
                                    },
                                },
                                "escapeMarkup": function (markup) {
                                    return markup
                                },
                            })
                            .on("select2:open", function (e) {
                                let x = document.querySelectorAll("[aria-controls='select2-" + dropdown_id + "-results']")
                                if (x[0]) {
                                    let _filterCountrySearch = x[0]
                                    
                                    $(_filterCountrySearch).attr("id", "" + dropdown_id + "_search")
                                    
                                    if (!document.getElementById("filter_country_add_icon")) {
                                        let i = document.createElement("i")
                                        i.classList = "select-add-option fas fa-plus filter_country_add"
                                        i.id = "filter_country_add_icon"
                                        i.addEventListener("click", event => {
                                            let val = _filterCountrySearch.value
                                            $(element).select2("close")
                                            Country.add(this, val)
                                            
                                        })
                                        _filterCountrySearch.after(i)
                                    }
                                    
                                    $(".filter_country_add").hide()
                                    
                                    if (_filterCountrySearch) {
                                        _filterCountrySearch.addEventListener("keyup", event => {
                                            
                                            if (_filterCountrySearch.value !== "") {
                                                $(".filter_country_add").show()
                                            } else {
                                                $(".filter_country_add").hide()
                                            }
                                            
                                        })
                                    }
                                }
                                
                            })
                            .on("change", function () {
                                let country_id = (!isNaN(parseInt($(this).val()))) ? parseInt($(this).val()) : null
                                let province_el_id = $(this)
                                    .attr("id")
                                    .replace("country", "province")
                                let province_element = document.getElementById(province_el_id)
                                let city_el_id = $(this)
                                    .attr("id")
                                    .replace("country", "city")
                                let city_element = document.getElementById(city_el_id)
                                // ----
                                if (!isNaN(parseInt($(this).val()))) {
                                    if (province_element) {
                                        Province.get(parseInt($(this).val()), province_element)
                                        //City.get(null, null, city_element)
                                    }
                                } else {
                                    Province.get(null, province_element)
                                }
                            })
                        // ----
                    }
                    
                })
            }
            
        }
        
    }
    
    const fetch_country_list = function (dataToSend, callback) {
        //console.log("Country.fetch_country_list(dataToSend, callback)", dataToSend)
        // ----
        
        if (dataToSend) {
            try {
                $.ajax({
                    type: "GET",
                    url: "/api/v1.0/countries",
                    data: dataToSend,
                    async: false,
                    
                }).done(function (data) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleCountryError("Oops: 1")
                    }
                })
            } catch (e) {
                console.log("error", e)
                return handleCountryError("Error Validating Country")
            }
        } else {
            return handleCountryError("Error Loading Country- Missing Data")
        }
    }
    
    const build_form = function (elem, val) {
        let id = $(elem).attr("id")
        let parent = $(elem).parents("div.row")
        let value = ""
        
        if (val) {
            value = val
        }
        
        if (!id || !parent[0]) {
            return
        }
        
        if (document.getElementById(form_id)) {
            return
        }
        
        let new_country_form = document.createElement("div")
        
        let heading1 = document.createElement("h5")
        
        let row1 = document.createElement("div")
        let row2 = document.createElement("div")
        let col1 = document.createElement("div")
        let col2 = document.createElement("div")
        let col3 = document.createElement("div")
        let col4 = document.createElement("div")
        let col5 = document.createElement("div")
        
        let form_element1 = document.createElement("div")
        let form_element2 = document.createElement("div")
        let form_element3 = document.createElement("div")
        let form_element4 = document.createElement("div")
        
        let error_element1 = document.createElement("div")
        let error_element2 = document.createElement("div")
        let error_element3 = document.createElement("div")
        
        let name_text_element = document.createElement("input")
        let name_label_element = document.createElement("label")
        let iso2_text_element = document.createElement("input")
        let iso2_label_element = document.createElement("label")
        let iso3_text_element = document.createElement("input")
        let iso3_label_element = document.createElement("label")
        
        let save_button = document.createElement("button")
        let cancel_button = document.createElement("button")
        
        heading1.classList = "card-title"
        heading1.innerText = "Country Details"
        
        new_country_form.id = form_id
        new_country_form.classList = ["card card-body m-3 " + class_name]
        
        name_text_element.id = "country_name"
        name_text_element.name = "country_name"
        name_text_element.type = "text"
        name_text_element.classList = ["form-control "]
        name_label_element.htmlFor = "country_name"
        name_label_element.innerHTML = "Name:"
        error_element1.id = "country_name-error"
        
        iso2_text_element.id = "country_iso2"
        iso2_text_element.name = "country_iso2"
        iso2_text_element.type = "text"
        iso2_text_element.maxLength = 2
        iso2_text_element.classList = ["form-control "]
        iso2_label_element.htmlFor = "country_iso2"
        iso2_label_element.innerHTML = "ISO2:"
        error_element2.id = "country_iso2-error"
        
        iso3_text_element.id = "country_iso3"
        iso3_text_element.name = "country_iso3"
        iso3_text_element.type = "text"
        iso3_text_element.maxLength = 3
        iso3_text_element.classList = ["form-control "]
        iso3_label_element.htmlFor = "country_iso3"
        iso3_label_element.innerHTML = "ISO3:"
        error_element3.id = "country_iso3-error"
        
        save_button.classList = ["btn btn-primary btn-sm waves-effect waves-light"]
        save_button.innerText = "save"
        save_button.type = "button"
        
        save_button.addEventListener("click", event => {
            Country.save(elem)
        })
        
        cancel_button.classList = ["btn btn-outline-danger btn-sm waves-effect waves-light"]
        cancel_button.innerText = "cancel"
        cancel_button.type = "button"
        
        cancel_button.addEventListener("click", event => {
            Country.close()
        })
        
        row1.classList = ["row"]
        row2.classList = ["row"]
        
        col1.classList = ["col-lg-3 mb-1"]
        col2.classList = ["col-lg-3 mb-1"]
        col3.classList = ["col-lg-3 mb-1"]
        col4.classList = ["col-lg-3 mb-1"]
        
        col5.classList = ["col-12 mb-1 text-right"]
        
        form_element1.classList = ["form-element"]
        form_element2.classList = ["form-element"]
        form_element3.classList = ["form-element"]
        form_element4.classList = ["form-element"]
        
        error_element1.classList = ["error w-100 text-center"]
        error_element2.classList = ["error w-100 text-center"]
        error_element3.classList = ["error w-100 text-center"]
        
        form_element1.appendChild(name_label_element)
        form_element1.appendChild(name_text_element)
        form_element1.appendChild(error_element1)
        
        col1.appendChild(form_element1)
        
        form_element2.appendChild(iso2_label_element)
        form_element2.appendChild(iso2_text_element)
        form_element2.appendChild(error_element2)
        
        col2.appendChild(form_element2)
        
        form_element3.appendChild(iso3_label_element)
        form_element3.appendChild(iso3_text_element)
        form_element3.appendChild(error_element3)
        
        col3.appendChild(form_element3)
        
        row1.appendChild(col1)
        row1.appendChild(col2)
        row1.appendChild(col3)
        row1.appendChild(col4)
        
        col5.append(cancel_button)
        col5.appendChild(save_button)
        
        row2.appendChild(col5)
        
        new_country_form.appendChild(heading1)
        new_country_form.appendChild(row1)
        new_country_form.appendChild(row2)
        
        parent[0].appendChild(new_country_form)
        
        name_text_element.value = value
        name_text_element.focus({ preventScroll: false })
        
        window.addEventListener("click", onClickOutside)
    }
    
    const destroy_form = function () {
        let elem = document.getElementById(form_id)
        if (elem) {
            elem.parentNode.removeChild(elem)
            window.removeEventListener("click", onClickOutside)
        }
    }
    
    const validate_form = function () {
        let _name = document.getElementById("country_name")
        let _country_iso2 = document.getElementById("country_iso2")
        let _country_iso3 = document.getElementById("country_iso3")
        let valid = true
        // ----
        if (!_name || !_country_iso2 || !_country_iso3) {
            handleCountryError("Error Processing Data")
            return false
        }
        
        if (_name.value === "") {
            $(_name).addClass("is-invalid")
            $("#country_name-error")
                .text("Required: Field is required")
                .show()
            valid = false
        } else {
            $(_name).removeClass("is-invalid")
            $("#country_name-error")
                .text("")
                .hide()
        }
        
        if (_country_iso2.value === "") {
            $(_country_iso2).addClass("is-invalid")
            $("#country_iso2-error")
                .text("Required: Field is required")
                .show()
            valid = false
        } else {
            $(_country_iso2).removeClass("is-invalid")
            $("#country_iso2-error")
                .text("")
                .hide()
        }
        
        if (_country_iso3.value === "") {
            $(_country_iso3).addClass("is-invalid")
            $("#country_iso3-error")
                .text("Required: Field is required")
                .show()
            valid = false
        } else {
            $(_country_iso3).removeClass("is-invalid")
            $("#country_iso3-error")
                .text("")
                .hide()
        }
        
        return valid
    }
    
    const get = function (settings) {
        fetch_country_list({}, function (data) {
            if (data) {
                Country.all = data
                build_drop_downs(settings)
            }
        })
    }
    
    const add = function (elem, val) {
        if (!elem) {
            return
        }
        
        build_form(elem, val)
    }
    
    const init = function (settings) {
        build_drop_downs(settings)
    }
    
    const loadAll = function (countries) {
        //console.log("Country.loadAll(countries)", countries)
        // ----
        
        Country.all = new Map()
        
        if (countries) {
            $.each(countries, function (k, country) {
                //console.log("|__ country", country)
                
                let detail = setDetail(country)
                //console.log("|__ detail", detail)
                Country.all.set(detail.id, detail)
            })
        }
    }
    
    return {
        detail: {},
        all: new Map(),
        buildCountryDropDown: function () {
        
        },
        close: function () {
            destroy_form()
        },
        add: function (elem, val) {
            add(elem, val)
        },
        save: function ($this) {
            save($this)
        },
        set: function (country_id) {
            set(country_id)
        },
        set_detail: function (country) {
            setDetail(country)
        },
        load_all: function (countries) {
            loadAll(countries)
        },
        get: function (settings) {
            get(settings)
        },
        init: function (settings) {
            init(settings)
        },
        initAutocomplete: function () {
            initAutocomplete()
        },
    }
})()

const Location = (function () {
    "use strict"
    /**
     * Page Elements
     */
    const _form_edit_location = document.getElementById("form_edit_location")
    const _form_location_details = document.getElementById("form_location_details")
    const _location_types_id = document.getElementById("location_types_id")
    const _location_name_filter = document.getElementById("location_name_filter")
    const _location_city_id = document.getElementById("location_city_id")
    const _location_country_id = document.getElementById("location_country_id")
    const _location_province_id = document.getElementById("location_province_id")
    const _location_id = document.getElementById("location_id")
    const _location_street_1 = document.getElementById("location_street_1")
    const _location_street_2 = document.getElementById("location_street_2")
    const _location_zipcode = document.getElementById("location_zipcode")
    const _location_name = document.getElementById("location_name")
    const _location_enabled = document.getElementById("location_enabled")
    const _button_clear_form_edit_location = document.getElementById("button_clear_form_edit_location")
    const _button_submit_form_edit_location = document.getElementById("button_submit_form_edit_location")
    const _button_edit_location = document.getElementById("button_edit_location")
    const _button_close_edit_location_form = document.getElementById("button_close_edit_location_form")
    const _form_edit_location_filter = document.getElementById("form_edit_location_filter")
    const _location_name_filter_id = document.getElementById("location_name_filter_id")
    const edit_location_filter_form_rules = {
        groups: {
            locationGroup: "location_name_filter location_name_filter_id",
        },
        rules: {
            location_name_filter: {
                required: true,
            },
            location_name_filter_id: {
                required: true,
                digits: true,
            },
        },
        messages: {
            location_name_filter: {
                required: "Field Required",
            },
            location_name_filter_id: {
                required: "Field Required",
                digits: "invalid",
            },
        },
    }
    const form_rules = {
        rules: {
            location_types_id: {
                required: true,
            },
            location_city_id: {
                required: true,
                digits: true,
            },
            location_country_id: {
                required: true,
                digits: true,
            },
            location_province_id: {
                required: true,
                digits: true,
            },
            location_name: { required: true },
        },
        messages: {
            location_types_id: {
                required: "Field Required",
            },
            location_city_id: {
                required: "Field Required",
                digits: "invalid",
            },
            location_country_id: {
                required: "Field Required",
                digits: "invalid",
            },
            location_province_id: {
                required: "Field Required",
                digits: "invalid",
            },
            location_id: {
                required: "Field Required",
                digits: "invalid",
            },
            location_name: { required: "Field Required" },
        },
    }
    const _form_product_edit_location = document.getElementById("form_product_edit_location")
    const _button_edit_product_location = document.getElementById("button_edit_product_location")
    const _button_clear_form_edit_product_location = document.getElementById("button_clear_form_edit_product_location")
    const _button_submit_form_edit_product_location = document.getElementById("button_submit_form_edit_product_location")
    const _button_close_edit_product_location_form = document.getElementById("button_close_edit_product_location_form")
    const _product_location_search = document.getElementById("product_location_search")
    const _card_product_edit_location = document.getElementById("card_product_edit_location")
    
    let temp_location = {}
    let new_filter = false
    let validator, validator_name_filter
    let validated = false
    let globalSelectedLocation = false
    let suggestionsTempLocation = []
    let default_display = defaultAddressView
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    $("a[data-toggle=\"tab\"]").on("hide.bs.tab", function (e) {
        //e.target // newly activated tab
        //e.relatedTarget // previous active tab
        hide_form()
    })
    
    const clear_product_location_form = function () {
        //console.log("Location.clear_product_location_form()")
        _location_id.value = ""
        _location_types_id.value = ""
        _location_name.value = ""
        _location_street_1.value = ""
        _location_street_2.value = ""
        _location_zipcode.value = ""
        $(_location_country_id).val("").trigger("change")
        /*
        switch (defaultLocationDisplayFormat) {
            case "short":
                document.getElementById("location_display_short").checked = true
                break
            case "medium":
                document.getElementById("location_display_medium").checked = true
                break
            default:
                document.getElementById("location_display_long").checked = true
        }
        //*/
        
    }
    
    const populate_product_location_form = function (location) {
        clear_product_location_form()
        let country = {}
        let province = {}
        let city = {}
        let type = {}
        if (location) {
            switch (defaultLocationDisplayFormat) {
                case "short":
                    _product_location_search.value = (location.display_short) ? location.display_short : ""
                    break
                case "medium":
                    _product_location_search.value = (location.display_medium) ? location.display_medium : ""
                    break
                default:
                    _product_location_search.value = (location.display_long) ? location.display_long : ""
            }
            
            _location_name.value = location.name
            $(_location_id).val(location.id).trigger("change")
            _location_street_1.value = location.street_1
            _location_street_2.value = location.street_2
            _location_zipcode.value = location.zipcode
            
            let location_type_id = ""
            if (location.type) {
                type = location.type
                location_type_id = type.id
            }
            $(_location_types_id).val(location_type_id)
            
            if (location.country) {
                country = location.country
                Country.id = (country.id) ? country.id.toString() : null
            }
            
            if (location.province) {
                province = location.province
                Province.id = (province.id) ? province.id.toString() : null
            }
            
            if (location.city) {
                city = location.city
                City.id = (city.id) ? city.id : null
            }
            
            $(_location_country_id).val((country.id) ? country.id : "").trigger("change")
        }
    }
    
    const unload_product_location_form = function (location) {
        clear_product_location_form()
        $(_card_product_edit_location).hide()
    }
    
    const load_product_location_form = function (location) {
        //console.log("Location.load_product_location_form(location)", location)
        clear_product_location_form()
        populate_product_location_form(location)
        $(_card_product_edit_location).show()
    }
    
    $(_button_submit_form_edit_product_location)
        .on("click", function () {
            load_product_location_form()
        })
    
    $(_button_edit_product_location)
        .on("click", function () {
            if (Location.detail) {
                load_product_location_form(Location.detail)
            }
        })
    
    $(_button_submit_form_edit_product_location)
        .on("click", function () {
        
        })
    
    $(_button_clear_form_edit_product_location)
        .on("click", function () {
            unload_product_location_form()
        })
    
    $(_button_close_edit_product_location_form)
        .on("click", function () {
            unload_product_location_form()
        })
    
    $(_product_location_search)
        .on("click", function () {
            $(this).select()
        })
        .on("change", function () {
            globalSelectedLocation = false
            setTimeout(function () {
                let location_name = _product_location_search.value
                
            }, 200)
        })
        .on("search", function () {
            globalSelectedLocation = false
            
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/locations",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            params: { "default_display": default_display },
            onSelect: function (suggestion) {
                if (suggestion && suggestion.data) {
                    globalSelectedLocation = true
                    //console.log("suggestion", suggestion)
                }
            },
            onSearchComplete: function (query, suggestions) {
            },
        })
    
    /**
     * _button_close_edit_location_form
     */
    $(_button_close_edit_location_form)
        .on("click", function () {
            reset_form()
            populate_form(temp_location)
            
            switch (defaultLocationDisplayFormat) {
                case "short":
                    _location_name_filter.value = temp_location.display_short
                    break
                case "medium":
                    _location_name_filter.value = temp_location.display_medium
                    break
                default:
                    _location_name_filter.value = temp_location.display_long
            }
            $(_location_id).val(temp_location.id).trigger("change")
            
            hide_form()
        })
    
    /**
     * _button_clear_form_edit_location
     */
    $(_button_clear_form_edit_location)
        .on("click", function () {
            reset_form()
            populate_form()
        })
    
    /**
     * _button_submit_form_edit_location
     */
    $(_button_submit_form_edit_location)
        .on("click", function () {
            save()
        })
    
    /**
     * _button_edit_location
     */
    $(_button_edit_location)
        .on("click", function () {
            if (_location_id.value === "") {
                //set_detail()
                //reset_form()
                //populate_form()
            } else {
            
            }
            
            show_form()
        })
    
    $("input[name='location_display']")
        .on("change", function () {
            
            let selected_value = $("input[name='location_display']:checked").val()
            //console.log("selected_value", selected_value)
            default_display = selected_value
            initAutoComplete()
            if (Location.detail["display_" + selected_value] !== null) {
                _location_name_filter.value = Location.detail["display_" + selected_value]
            }
        })
    
    $(_location_name)
        .on("change", function () {
            setTimeout(function () {
                let location_name = _location_name.value
                location_name_exists(location_name)
            }, 200)
        })
    
    $(_location_id)
        .on("change", function () {
            $(_location_name_filter_id)
                .val($(_location_id).val())
        })
    
    const validate_form = function () {
        return $(_form_edit_location).valid()
    }
    
    const initAutoComplete = function () {
        $(_location_name_filter)
            .on("click", function () {
                $(this).select()
            })
            .on("change", function () {
                setTimeout(function () {
                    let location_name = _location_name_filter.value
                    if (globalSelectedLocation === false) {
                        if (_location_name_filter.value === "") {
                            _location_name_filter.value = ""
                            $(_location_id).val("").trigger("change")
                            reset_form()
                        } else {
                            location_exists(location_name)
                        }
                    }
                }, 200)
            })
            .on("search", function () {
                globalSelectedLocation = false
                $(_location_id).val("").trigger("change")
                _location_name_filter.value = ""
                new_filter = true
                set_detail()
                reset_form()
                populate_form()
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/locations",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                params: { "default_display": default_display },
                onSelect: function (suggestion) {
                    if (suggestion && suggestion.data && suggestion.data.country && suggestion.data.province && suggestion.data.city) {
                        globalSelectedLocation = true
                        reset_form()
                        let location = suggestion.data
                        Location.detail = location
                        temp_location = location
                        populate_form(location)
                    }
                    
                    if (_form_edit_location) {
                        clearValidation(_form_edit_location)
                    }
                },
                onSearchComplete: function (query, suggestions) {
                },
            })
    }
    
    const _default_detail = function () {
        return {
            id: null,
            display_long: null,
            display_medium: null,
            display_short: null,
            location_types_id: null,
            name: null,
            street_1: null,
            street_2: null,
            zipcode: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            city: {
                id: null,
                name: null,
                sort_order: 999,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: user_id,
                date_modified: formatDateMySQL(),
                modified_by: user_id,
                note: null,
            },
            province: {
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                enabled: 1,
                id: null,
                iso2: null,
                iso3: null,
                modified_by: user_id,
                name: null,
                name_long: null,
                note: null,
                sort_order: 999,
            },
            country: {
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                currency_id: null,
                enabled: 1,
                id: null,
                iso2: null,
                iso3: null,
                modified_by: user_id,
                name: null,
                name_long: null,
                note: null,
                sort_order: 999,
            },
            type: {
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                enabled: 1,
                icon: null,
                id: null,
                modified_by: user_id,
                name: null,
                note: null,
                sort_order: 999,
            },
        }
    }
    
    const handle_location_error = function (msg) {
        toastr.error(msg)
    }
    
    const location_name_exists = function (name) {
        if (name && name !== "") {
            let dataToSend = {
                name: name,
                default_display: default_display,
            }
            
            fetch_location_by_name(dataToSend, function (data) {
                if (data && data[0]) {
                    if (confirm(`Location: ${name} all ready exists. Would you like to use it?`)) {
                        let location = data[0]
                        reset_form()
                        populate_form(location)
                    } else {
                        reset_form()
                        populate_form()
                    }
                }
            })
        }
    }
    
    const location_exists = function (name) {
        if (name && name !== "") {
            let dataToSend = {
                name: name,
                default_display: default_display,
            }
            
            fetch_location_by_name(dataToSend, function (data) {
                if (data && data[0]) {
                    let location = data[0]
                    globalSelectedLocation = true
                    reset_form()
                    populate_form(location)
                } else {
                    globalSelectedLocation = false
                    confirmDialog(`Location: ${name} does not exist. Would you like to create it?`, (ans) => {
                        if (ans) {
                            add_to_location_list(name)
                        } else {
                            reset_form()
                            populate_form(temp_location)
                            hide_form()
                        }
                    })
                }
            })
        }
    }
    
    const add_to_location_list = function (name) {
        if (globalSelectedLocation === false) {
            if (name) {
                reset_form()
                populate_form()
                show_form()
                _location_name.value = name
                _location_name.disabled = true
                
            }
        }
    }
    
    /**
     * fetch locations by name
     *
     * @param dataToSend
     * @param callback
     */
    const fetch_location_by_name = function (dataToSend, callback) {
        let url = "/api/v1.0/locations/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_location_error("Oops: 1")
                    }
                })
            } catch (e) {
                return handle_location_error("Error Validating Location")
            }
        } else {
            return handle_location_error("Error Loading Location- Missing Data")
        }
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const disable = function () {
        let location_displays = document.getElementsByName("location_display")
        $.each(location_displays, function (i, elem) {
            elem.disabled = true
        })
        _location_name_filter.disabled = true
        _button_edit_location.disabled = true
    }
    
    const enable = function () {
        let location_displays = document.getElementsByName("location_display")
        $.each(location_displays, function (i, elem) {
            elem.disabled = false
        })
        _location_name_filter.disabled = false
        _button_edit_location.disabled = false
    }
    
    const show_form = function () {
        disable()
        $(_form_location_details).show()
    }
    
    const hide_form = function () {
        if (!_form_location_details) {
            return
        }
        let detail = set_detail(temp_location)
        populate_form(detail)
        enable()
        $(_form_location_details).hide()
    }
    
    const validate_edit_location_filter_form = function () {
        return $(_form_edit_location_filter).valid()
    }
    
    /**
     * resets location form
     */
    const reset_form = function () {
        _location_name.disabled = false
        _location_name.value = ""
        _location_name_filter.value = ""
        $(_location_id).val("").trigger("change")
        _location_types_id.value = ""
        _location_street_1.value = ""
        _location_street_2.value = ""
        _location_zipcode.value = ""
        
        $(_location_country_id).val("").trigger("change")
        
        switch (defaultLocationDisplayFormat) {
            case "short":
                document.getElementById("location_display_short").checked = true
                break
            case "medium":
                document.getElementById("location_display_medium").checked = true
                break
            default:
                document.getElementById("location_display_long").checked = true
        }
        
    }
    
    /**
     * populate form fields
     *
     * @param location
     */
    const populate_form = function (location) {
        let country = {}
        let province = {}
        let city = {}
        let type = {}
        if (location) {
            switch (defaultLocationDisplayFormat) {
                case "short":
                    _location_name_filter.value = (location.display_short) ? location.display_short : ""
                    break
                case "medium":
                    _location_name_filter.value = (location.display_medium) ? location.display_medium : ""
                    break
                default:
                    _location_name_filter.value = (location.display_long) ? location.display_long : ""
            }
            
            _location_enabled.checked = (location.enabled === 1)
            _location_name.value = location.name
            $(_location_id).val(location.id).trigger("change")
            _location_street_1.value = location.street_1
            _location_street_2.value = location.street_2
            _location_zipcode.value = location.zipcode
            
            let location_type_id = ""
            if (location.type) {
                type = location.type
                location_type_id = type.id
            }
            $(_location_types_id).val(location_type_id)
            
            if (location.country) {
                country = location.country
                Country.id = (country.id) ? country.id.toString() : null
            }
            
            if (location.province) {
                province = location.province
                Province.id = (province.id) ? province.id.toString() : null
            }
            
            if (location.city) {
                city = location.city
                City.id = (city.id) ? city.id.toString() : null
            }
            
            $(_location_country_id).val((country.id) ? country.id : "").trigger("change")
            
        }
        
    }
    
    const set = function (location) {
        return set_detail(location)
    }
    
    /**
     * set object param values
     *
     * @param location
     * @returns {{note: null, country: {note: null, date_created: *, created_by: (number|number), enabled: number, date_modified: *, name_long: null, modified_by: (number|number), name: null, id: null, iso2: null, sort_order: number, currency_id: null, iso3: null}, city: {note: null, date_modified: *, date_created: *, name: null, modified_by: (number|number), id: null, sort_order: number, created_by: (number|number), enabled: number}, date_created: *, location_types_id: null, type: {note: null, date_modified: *, date_created: *, icon: null, modified_by: (number|number), name: null, id: null, created_by: (number|number), sort_order: number, enabled: number}, created_by: (number|number), enabled: number, display_medium: null, zipcode: null, display_short: null, street_1: null, date_modified: *, province: {note: null, date_modified: *, date_created: *, name_long: null, modified_by: (number|number), name: null, id: null, iso2: null, created_by: (number|number), sort_order: number, enabled: number, iso3: null}, street_2: null, name: null, modified_by: (number|number), display_long: null, id: null}}
     */
    const set_detail = function (location) {
        let detail = _default_detail()
        temp_location = detail
        let country = {}
        let province = {}
        let city = {}
        let type = {}
        if (location) {
            
            if (location.country) {
                country = location.country
            }
            if (location.province) {
                province = location.province
            }
            if (location.city) {
                city = location.city
            }
            if (location.type) {
                type = location.type
            }
        } else {
            location = {}
        }
        
        detail.id = (location.id) ? location.id : null
        detail.name = (location.name) ? location.name : null
        detail.street_1 = (location.street_1) ? location.street_1 : null
        detail.street_2 = (location.street_2) ? location.street_2 : null
        detail.zipcode = (location.zipcode) ? location.zipcode : null
        detail.display_long = (location.display_long) ? location.display_long : null
        detail.display_medium = (location.display_medium) ? location.display_medium : null
        detail.display_short = (location.display_short) ? location.display_short : null
        detail.enabled = (location.enabled) ? location.enabled : 1
        detail.date_created = (location.date_created) ? location.date_created : formatDateMySQL()
        detail.created_by = (location.created_by) ? location.created_by : user_id
        detail.date_modified = (location.date_modified) ? location.date_modified : formatDateMySQL()
        detail.modified_by = (location.modified_by) ? location.modified_by : user_id
        detail.note = (location.note) ? location.note : null
        
        detail.country = {
            created_by: (country.created_by) ? country.created_by : user_id,
            date_created: (country.date_created) ? country.date_created : formatDateMySQL(),
            date_modified: (country.date_modified) ? country.date_modified : formatDateMySQL(),
            currency_id: (country.currency_id) ? country.currency_id : null,
            enabled: (country.enabled) ? country.enabled : 1,
            id: (country.id) ? country.id : null,
            iso2: (country.iso2) ? country.iso2 : null,
            iso3: (country.iso3) ? country.iso3 : null,
            modified_by: (country.modified_by) ? country.modified_by : user_id,
            name: (country.name) ? country.name : null,
            name_long: (country.name_long) ? country.name_long : null,
            note: (country.note) ? country.note : null,
            sort_order: (country.sort_order) ? country.sort_order : 999,
        }
        
        detail.province = {
            created_by: (province.created_by) ? province.created_by : user_id,
            date_created: (province.date_created) ? province.date_created : formatDateMySQL(),
            date_modified: (province.date_modified) ? province.date_modified : formatDateMySQL(),
            enabled: (province.enabled) ? province.enabled : 1,
            id: (province.id) ? province.id : null,
            iso2: (province.iso2) ? province.iso2 : null,
            iso3: (province.iso3) ? province.iso3 : null,
            modified_by: (province.modified_by) ? province.modified_by : user_id,
            name: (province.name) ? province.name : null,
            name_long: (province.name_long) ? province.name_long : null,
            note: (province.note) ? province.note : null,
            sort_order: (province.sort_order) ? province.sort_order : 999,
        }
        
        detail.city = {
            created_by: (city.created_by) ? city.created_by : user_id,
            date_created: (city.date_created) ? city.date_created : formatDateMySQL(),
            date_modified: (city.date_modified) ? city.date_modified : formatDateMySQL(),
            enabled: (city.enabled) ? city.enabled : 1,
            id: (city.id) ? city.id : null,
            modified_by: (city.modified_by) ? city.modified_by : user_id,
            name: (city.name) ? city.name : null,
            note: (city.note) ? city.note : null,
            sort_order: (city.sort_order) ? city.sort_order : 999,
        }
        
        detail.type = {
            created_by: (type.created_by) ? type.created_by : user_id,
            date_created: (type.date_created) ? type.date_created : formatDateMySQL(),
            date_modified: (type.date_modified) ? type.date_modified : formatDateMySQL(),
            enabled: (type.enabled) ? type.enabled : 1,
            icon: (type.icon) ? type.icon : null,
            id: (type.id) ? type.id : null,
            modified_by: (type.modified_by) ? type.modified_by : user_id,
            name: (type.name) ? type.name : null,
            note: (type.note) ? type.note : null,
            sort_order: (type.sort_order) ? type.sort_order : 999,
        }
        
        Province.set_detail(detail.province)
        Country.set_detail(detail.country)
        City.set_detail(detail.city)
        
        Location.detail = detail
        return detail
    }
    
    /**
     * initialize location object
     *
     * @param location
     */
    const init = function (location) {
        
        let detail = {}
        if (location) {
            detail = set(location)
            temp_location = detail
        }
        
        if (_form_edit_location) {
            validator_init(form_rules)
            validator = $(_form_edit_location).validate()
            validator_init(edit_location_filter_form_rules)
            validator_name_filter = $(_form_edit_location_filter).validate()
            
            $(_location_country_id).BuildDropDown({
                data: Array.from(Country.all.values()),
                title: "Country",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            $(_location_province_id).BuildDropDown({
                data: Array.from(Province.all.values()),
                title: "Province",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            $(_location_city_id).BuildDropDown({
                data: Array.from(City.all.values()),
                title: "City",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            Country.init({
                dropdowns: [
                    "location_country_id",
                ],
            })
            
            Province.init({
                dropdowns: [
                    "location_province_id",
                ],
            })
            
            City.init({
                dropdowns: [
                    "location_city_id",
                ],
            })
            
            reset_form()
            populate_form(detail)
            hide_form()
        }
        
        if (_form_product_edit_location) {
            
            $(_location_country_id).BuildDropDown({
                data: Array.from(Country.all.values()),
                title: "Country",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            $(_location_province_id).BuildDropDown({
                data: Array.from(Province.all.values()),
                title: "Province",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            $(_location_city_id).BuildDropDown({
                data: Array.from(City.all.values()),
                title: "City",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            Country.init({
                dropdowns: [
                    "location_country_id",
                ],
            })
            
            Province.init({
                dropdowns: [
                    "location_province_id",
                ],
            })
            
            City.init({
                dropdowns: [
                    "location_city_id",
                ],
            })
            
            Location.detail = detail
            
            populate_product_location_form(detail)
        }
        
        if (_location_name_filter) {
            initAutoComplete()
        }
        
    }
    
    /**
     * update location
     *
     * @param dataToSend
     * @param callback
     */
    const update_location = function (dataToSend, callback) {
        let url = "/api/v1.0/locations/update"
        if (dataToSend) {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                } else {
                    return handle_location_error("Oops: 1")
                }
            })
        }
    }
    
    /**
     * save object
     */
    const save = function () {
        if (validate_form()) {
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    update_location(build(), function (data) {
                        let location
                        if (data) {
                            if (data[0]) {
                                let displayView = "medium"
                                location = data[0]
                                temp_location = location
                                
                                let el = document.getElementsByName("location_display")
                                for (let i = 0; i < el.length; i++) {
                                    if (el[i].checked) {
                                        displayView = el[i].value
                                    }
                                }
                                _location_id.value = location.id
                                _location_name_filter.value = location["display_" + displayView]
                                
                                hide_form()
                            }
                        }
                    })
                }
            })
        }
    }
    
    /**
     * build location object
     *
     * @returns {{}|*}
     */
    const build = function () {
        return remove_nulls({
            id: (!isNaN(parseInt(_location_id.value))) ? parseInt(_location_id.value) : null,
            city_id: (!isNaN(parseInt(_location_city_id.value))) ? parseInt(_location_city_id.value) : null,
            province_id: (!isNaN(parseInt(_location_province_id.value))) ? parseInt(_location_province_id.value) : null,
            country_id: (!isNaN(parseInt(_location_province_id.value))) ? parseInt(_location_country_id.value) : null,
            location_types_id: (!isNaN(parseInt(_location_types_id.value))) ? parseInt(_location_types_id.value) : null,
            name: (_location_name && _location_name.value !== "") ? _location_name.value : null,
            street_1: (_location_street_1 && _location_street_1.value !== "") ? _location_street_1.value : null,
            street_2: (_location_street_2 && _location_street_2.value !== "") ? _location_street_2.value : null,
            zipcode: (_location_zipcode && _location_zipcode.value !== "") ? _location_zipcode.value : null,
            enabled: 1,
            note: null,
        })
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        types: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function (location) {
            init(location)
        },
        populate_form: function (location) {
            populate_form(location)
        },
        set_detail: function (location) {
            //console.log("location", location)
            return set_detail(location)
        },
        build: function () {
            if (validate_edit_location_filter_form()) {
                return build()
            }
        },
    }
    
})()


const Variant = (function () {
    "use strict"
    
    const _button_remove_variant_from_product = document.getElementById("button_remove_variant_from_product")
    const _product_edit_variant_section = document.getElementById("product_edit_variant_section")
    const _panel_tab_variant = document.getElementById("panel_tab_variant")
    const _category_id = document.getElementById("category_id")
    const _product_id = document.getElementById("product_id")
    const _product_edit_variant_form_variant_name_filter = document.getElementById("product_edit_variant_form_variant_name_filter")
    const _table_variant_product_edit = document.getElementById("table_variant_product_edit")
    const _product_edit_variant_form = document.getElementById("product_edit_variant_form")
    const _display_product_variant_name = document.getElementById("display_product_variant_name")
    const _product_edit_variant_form_variant_id = document.getElementById("product_edit_variant_form_variant_id")
    const _product_edit_variant_form_variant_name = document.getElementById("product_edit_variant_form_variant_name")
    const _product_edit_variant_form_variant_enabled = document.getElementById("product_edit_variant_form_variant_enabled")
    const _product_edit_variant_form_variant_code = document.getElementById("product_edit_variant_form_variant_code")
    const _product_edit_variant_form_variant_min_age = document.getElementById("product_edit_variant_form_variant_min_age")
    const _product_edit_variant_form_variant_max_age = document.getElementById("product_edit_variant_form_variant_max_age")
    const _product_edit_variant_form_submit_button = document.getElementById("product_edit_variant_form_submit_button")
    const _product_edit_variant_form_clear_button = document.getElementById("product_edit_variant_form_clear_button")
    const _product_edit_variant_form_close_button = document.getElementById("product_edit_variant_form_close_button")
    const _product_edit_variant_form_variant_used_in_pricing = document.getElementById("product_edit_variant_form_variant_used_in_pricing")
    const _table_variant_product_edit_add_new_button = document.getElementById("table_variant_product_edit_add_new_button")
    const _product_edit_variant_display = document.getElementById("product_edit_variant_display")
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let $table_variant_product_edit = $(_table_variant_product_edit)
    let globalSelectedVariant = false
    let form_rules = {
        rules: {
            product_edit_variant_form_variant_name: {
                required: true,
            },
            product_edit_variant_form_variant_min_age: {
                number: true,
                min: 0,
            },
            product_edit_variant_form_variant_max_age: {
                number: true,
                min: 1,
            },
        },
        messages: {
            product_edit_variant_form_variant_name: {
                required: "Field Required",
            },
            product_edit_variant_form_variant_min_age: {
                number: "Field Invalid",
                min: "Field Invalid",
            },
            product_edit_variant_form_variant_max_age: {
                number: "Field Invalid",
                min: "Field Invalid",
            },
        },
    }
    
    $(_button_remove_variant_from_product)
        .on("click", function () {
            remove()
        })
    
    $(_product_edit_variant_section)
        .on("change", function () {
            updateProgress()
        })
    
    $(_table_variant_product_edit_add_new_button)
        .on("click", function () {
            //console.log("Variant.table_variant_product_edit_add_new_button:click()", this)
            // ----
            
            $table_variant_product_edit.clearSelectedRows()
            populateForm()
        })
    
    $(_product_edit_variant_form_clear_button)
        .on("click", function () {
            //console.log("Variant.product_edit_variant_form_clear_button:click()", this)
            // ----
            resetForm()
            $table_variant_product_edit.clearSelectedRows()
        })
    
    $(_product_edit_variant_form_close_button)
        .on("click", function () {
            resetForm()
            $table_variant_product_edit.clearSelectedRows()
        })
    
    $(_product_edit_variant_form_submit_button)
        .on("click", function () {
            //console.log("Variant.product_edit_variant_form_submit_button:click()", this)
            // ----
            save()
        })
    
    $(_panel_tab_variant)
        .on("hide.bs.tab", function () {
            resetForm()
            $table_variant_product_edit.clearSelectedRows()
            _product_edit_variant_form_variant_name_filter.value = ""
            _product_edit_variant_form_variant_name_filter.disabled = false
        })
    
    const clearProductOverview = function (variant) {
        //console.log("Variant.clearProductOverview(variant)", variant)
        let color_scheme, product_unit_detail
        
        if (!variant) {
            //console.log("No Variant", variant)
            return
        }
        
        let variantId = (!isNaN(parseInt(variant.id))) ? parseInt(variant.id) : null
        
        if (variantId) {
            $(`#product_edit_variant_display_${variantId}`).remove()
        }
        
    }
    
    const buildProductOverview = function (variant) {
        //console.log("Variant.buildProductOverview(variant)", variant)
        
        if (!variant) {
            //console.log("|__ variant", variant)
            return
        }
        
        let variantId = (!isNaN(parseInt(variant.id))) ? parseInt(variant.id) : null
        let variantMaxAge = (!isNaN(parseInt(variant.max_age))) ? parseInt(variant.max_age) : null
        let variantMinAge = (!isNaN(parseInt(variant.min_age))) ? parseInt(variant.min_age) : null
        let variantName = (variant.name) ? variant.name : null
        let variantCode = (variant.code) ? variant.code : null
        
        if (Variant.all.get(variantId)) {
            clearProductOverview(Variant.all.get(variantId))
        }
        
        $(_product_edit_variant_display).append(`
            <div id="product_edit_variant_display_${variantId}" class="col-12 col-sm-12 col-md-4 px-1">
                <div class="card">
                    <div class="card-body">
                    
                        <h5 class="card-title">${variantName}</h5>
                        <h6 class="card-subtitle my-2 text-muted">${variantCode}</h6>
                        <p class="card-text"></p>
       
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Age</td>
                                    <td>${variantMinAge}</td>
                                    <td>${variantMaxAge}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `)
    }
    
    const remove = function () {
        confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
            if (ans) {
                let dataToSend = {
                    variant_id: parseInt(_product_edit_variant_form_variant_id.value),
                    product_id: parseInt(_product_id.value),
                }
                
                removeProductVariant(dataToSend, function (data) {
                    if (data) {
                        let detail = set(Variant.all.get(dataToSend.variant_id))
                        
                        Variant.all.delete(dataToSend.variant_id)
                        
                        $table_variant_product_edit.deleteRow(detail)
                        $table_variant_product_edit.clearSelectedRows()
                        
                        _product_edit_variant_form_variant_name_filter.value = ""
                        
                        PricingWorksheet.pricingWorksheet()
                        Pricing.resetForm()
                        YearCalendar.refresh()
                        updateProgress()
                        resetForm()
                        YearCalendar.endLoading()
                        clearProductOverview(detail)
                        
                        toastr["warning"](`Variant: ${detail.name} - has been removed`, "Variant")
                    }
                })
            } else {
                resetForm()
                $table_variant_product_edit.clearSelectedRows()
                _product_edit_variant_form_variant_name_filter.value = ""
                _product_edit_variant_form_variant_name_filter.disabled = false
            }
        })
    }
    
    const removeProductVariant = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/variants/remove"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleVariantError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const updateProgress = function () {
        let variants = Array.from(Variant.all.values())
        
        if (variants.length === 0) {
            let warningNotice = $("<span/>", {
                "class": "badge badge-danger  ml-2",
                "text": "!",
                "id": "variantNeedsAttention",
            })
            
            $(_panel_tab_variant).html(`<span id="tab_span_variant">Variant</span> <span id="variantNeedsAttention" class="badge rounded-pill badge-notification bg-danger">!</span>`)
        } else {
            $(_panel_tab_variant).html(`<span id="tab_span_variant">Variant</span>`)
        }
        
        Product.updateProgress()
    }
    
    const initAutoComplete = function () {
        let category_id = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        
        $(_product_edit_variant_form_variant_name_filter)
            .on("click", function () {
                $(this).select()
            })
            .on("search", function () {
                globalSelectedVariant = false
                resetForm()
                $table_variant_product_edit.clearSelectedRows()
            })
            .on("change", function () {
                setTimeout(function () {
                    let variant_name = _product_edit_variant_form_variant_name_filter.value
                    
                    $table_variant_product_edit.clearSelectedRows()
                    
                    if (globalSelectedVariant === false) {
                        if (variant_name === "") {
                            _product_edit_variant_form_variant_name_filter.value = ""
                            globalSelectedVariant = false
                            resetForm()
                        } else {
                            nameExists(variant_name)
                        }
                    }
                }, 200)
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/variants",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                params: { "category_id": category_id },
                onSelect: function (suggestion) {
                    $table_variant_product_edit.clearSelectedRows()
                    
                    if (!suggestion || !suggestion.data) {
                        return
                    }
                    let detail
                    let variant = suggestion.data
                    let hasVariant = Variant.all.get(parseInt(variant.id))
                    
                    if (hasVariant) {
                        detail = set(hasVariant)
                        $table_variant_product_edit.loadRow(detail)
                    } else {
                        detail = set(variant)
                        detail.used_in_pricing = 1
                    }
                    
                    populateForm(detail)
                    
                },
            })
    }
    
    const handleVariantError = function (msg) {
        toastr["error"](msg, "Variant Error")
    }
    
    const fetchByName = function (dataToSend, callback) {
        let url = "/api/v1.0/variants/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleVariantError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleVariantError("Error Validating Variant")
            }
        } else {
            handleVariantError("Error Loading Variant - Missing Data")
        }
    }
    
    const nameExists = function (name) {
        if (name && name !== "") {
            
            let dataToSend = remove_nulls({
                name: name,
                category_id: (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null,
            })
            
            fetchByName(dataToSend, function (data) {
                let variant = null
                
                if (data && data[0]) {
                    variant = data
                    if (data[0]) {
                        variant = data[0]
                    }
                }
                
                if (variant) {
                    let hasVariant = Variant.all.get(parseInt(variant.id))
                    let detail
                    
                    if (hasVariant) {
                        detail = set(hasVariant)
                        $table_variant_product_edit.loadRow(detail)
                    } else {
                        detail = set(variant)
                    }
                    
                    populateForm(detail)
                    
                } else {
                    confirmDialog(`The variant: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                        if (ans) {
                            let url = "/api/v1.0/variants/new"
                            try {
                                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                                    if (data) {
                                        let variant = data
                                        if (data[0]) {
                                            variant = data[0]
                                        }
                                        let detail = set(variant)
                                        
                                        clearForm()
                                        
                                        $table_variant_product_edit.clearSelectedRows()
                                        globalSelectedVariant = false
                                        
                                        _product_edit_variant_form_variant_name.value = name
                                        _display_product_variant_name.innerText = name
                                        
                                        populateForm(detail)
                                        enableFormFields()
                                    } else {
                                        return handleVariantError("Oops: 1")
                                    }
                                })
                            } catch (e) {
                                //console.log("error", e)
                            }
                        }
                    })
                }
            })
        }
    }
    
    const buildProductEditTable = function () {
        $table_variant_product_edit = $(_table_variant_product_edit).table({
            table_type: "display_list",
            data: Variant.all,
            columnDefs: [
                {
                    title: "Name",
                    targets: 0,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Code",
                    targets: 1,
                    data: "code",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Min Age",
                    targets: 2,
                    data: "min_age",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Max Age",
                    targets: 3,
                    data: "max_age",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
            
            ],
            rowClick: Variant.edit,
        })
    }
    
    const defaultDetail = function () {
        return {
            id: null,
            category_id: null,
            name: null,
            min_age: null,
            max_age: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            used_in_pricing: 1,
            note: null,
        }
    }
    
    const resetForm = function () {
        clearForm()
        disableFormFields()
        hideForm()
    }
    
    const validVariantRecord = function () {
        let valid = $(_product_edit_variant_form).valid()
        let min_age = (!isNaN(parseInt(_product_edit_variant_form_variant_min_age.value))) ? parseInt(_product_edit_variant_form_variant_min_age.value) : null
        let max_age = (!isNaN(parseInt(_product_edit_variant_form_variant_max_age.value))) ? parseInt(_product_edit_variant_form_variant_max_age.value) : null
        
        if (min_age !== null && max_age !== null) {
            if (parseInt(max_age) < parseInt(min_age)) {
                setError(_product_edit_variant_form_variant_max_age, "Age is greater than minimum")
                valid = false
            }
        }
        
        return valid
    }
    
    const clearForm = function () {
        clearValidation(_product_edit_variant_form)
        
        _display_product_variant_name.innerText = "&nbsp;"
        _product_edit_variant_form_variant_id.value = ""
        _product_edit_variant_form_variant_name.value = ""
        _product_edit_variant_form_variant_enabled.checked = true
        _product_edit_variant_form_variant_code.value = ""
        _product_edit_variant_form_variant_min_age.value = 0
        _product_edit_variant_form_variant_max_age.value = ""
        _product_edit_variant_form_variant_used_in_pricing.checked = true
    }
    
    const populateForm = function (variant) {
        clearForm()
        
        if (variant) {
            _product_edit_variant_form_variant_used_in_pricing.checked = (variant.used_in_pricing === 1)
            _display_product_variant_name.innerText = (variant.name) ? variant.name : "&nbsp;"
            _product_edit_variant_form_variant_id.value = (!isNaN(parseInt(variant.id))) ? parseInt(variant.id) : ""
            _product_edit_variant_form_variant_name.value = (variant.name) ? variant.name : "&nbsp;"
            _product_edit_variant_form_variant_enabled.checked = (!(variant.enabled && variant.enabled === 0))
            _product_edit_variant_form_variant_code.value = (variant.name) ? variant.name : "&nbsp;"
            _product_edit_variant_form_variant_min_age.value = (!isNaN(parseInt(variant.min_age))) ? parseInt(variant.min_age) : 1
            _product_edit_variant_form_variant_max_age.value = (!isNaN(parseInt(variant.max_age))) ? parseInt(variant.max_age) : ""
        }
        
        enableFormFields()
        loadForm()
    }
    
    const hideForm = function () {
        updateProgress()
        _product_edit_variant_form_variant_name_filter.disabled = false
        _product_edit_variant_form_variant_name_filter.value = ""
        
        $(_product_edit_variant_form).hide()
    }
    
    const loadForm = function () {
        _product_edit_variant_form_variant_name_filter.disabled = true
        
        $(_product_edit_variant_form).show()
    }
    
    const enableFormFields = function () {
        _product_edit_variant_form_variant_used_in_pricing.disabled = false
        _product_edit_variant_form_variant_id.disabled = true
        _product_edit_variant_form_variant_name.disabled = true
        _product_edit_variant_form_variant_enabled.disabled = true
        _product_edit_variant_form_variant_code.disabled = true
        _product_edit_variant_form_variant_min_age.disabled = false
        _product_edit_variant_form_variant_max_age.disabled = false
        _product_edit_variant_form_submit_button.disabled = false
    }
    
    const disableFormFields = function () {
        _product_edit_variant_form_variant_used_in_pricing.disabled = true
        _product_edit_variant_form_variant_id.disabled = true
        _product_edit_variant_form_variant_name.disabled = true
        _product_edit_variant_form_variant_enabled.disabled = true
        _product_edit_variant_form_variant_code.disabled = true
        _product_edit_variant_form_variant_min_age.disabled = true
        _product_edit_variant_form_variant_max_age.disabled = true
        _product_edit_variant_form_submit_button.disabled = true
    }
    
    const buildVariantRecord = function () {
        let dataToSend = {
            id: (!isNaN(parseInt(_product_edit_variant_form_variant_id.value))) ? parseInt(_product_edit_variant_form_variant_id.value) : null,
            category_id: (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null,
            product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
            name: (_product_edit_variant_form_variant_name && _product_edit_variant_form_variant_name.value !== "") ? _product_edit_variant_form_variant_name.value : null,
            code: (_product_edit_variant_form_variant_code && _product_edit_variant_form_variant_code.value !== "") ? _product_edit_variant_form_variant_code.value : null,
            min_age: (!isNaN(parseInt(_product_edit_variant_form_variant_min_age.value))) ? parseInt(_product_edit_variant_form_variant_min_age.value) : null,
            max_age: (!isNaN(parseInt(_product_edit_variant_form_variant_max_age.value))) ? parseInt(_product_edit_variant_form_variant_max_age.value) : null,
            used_in_pricing: (_product_edit_variant_form_variant_used_in_pricing.checked === true) ? 1 : 0,
        }
        return remove_nulls(dataToSend)
    }
    
    const saveProductVariant = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/variants/update"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleVariantError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const save = function () {
        if (validVariantRecord()) {
            confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    let dataToSend = buildVariantRecord()
                    saveProductVariant(dataToSend, function (data) {
                        if (data) {
                            let detail = set((data[0]) ? data[0] : data)
                            let hasVariant = Variant.all.get(detail.id)
                            
                            if (hasVariant) {
                                $table_variant_product_edit.updateRow(detail)
                            } else {
                                $table_variant_product_edit.insertRow(detail)
                            }
                            
                            Variant.all.set(detail.id, detail)
                            
                            $table_variant_product_edit.loadRow(detail)
                            $table_variant_product_edit.jumpToRow(detail)
                            $table_variant_product_edit.clearSelectedRows()
                            
                            _product_edit_variant_form_variant_name_filter.disabled = false
                            _product_edit_variant_form_variant_name_filter.value = ""
                            
                            PricingWorksheet.pricingWorksheet()
                            Pricing.resetForm()
                            YearCalendar.refresh()
                            
                            updateProgress()
                            resetForm()
                            buildProductOverview(detail)
                            
                            YearCalendar.endLoading()
                            toastr["success"](`Variant: ${detail.name} - has been updated`, "Variant")
                        }
                    })
                } else {
                    resetForm()
                    $table_variant_product_edit.clearSelectedRows()
                    _product_edit_variant_form_variant_name_filter.value = ""
                    _product_edit_variant_form_variant_name_filter.disabled = false
                }
            })
        }
    }
    
    const loadAll = function (variants) {
        //console.log("Variant.loadAll(variants)", variants)
        Variant.all = new Map()
        
        if (variants) {
            $.each(variants, function (k, variant) {
                let detail = set(variant)
                
                Variant.all.set(detail.id, detail)
                
                $table_variant_product_edit.insertRow(detail)
                
                buildProductOverview(detail)
            })
        }
    }
    
    const init = function (settings) {
        //console.log("Variant.init(settings)", Variant)
        // ----
        let variants = []
        if (settings) {
            if (settings) {
                variants = settings
            }
        }
        
        if (_table_variant_product_edit) {
            buildProductEditTable()
        }
        
        loadAll(variants)
        
        if (_product_edit_variant_form_variant_name_filter) {
            initAutoComplete()
        }
        
        if (_product_edit_variant_form) {
            validator_init(form_rules)
            Variant.validator = $(_product_edit_variant_form).validate()
            resetForm()
            updateProgress()
        }
    }
    
    const edit = function (variant) {
        //console.log("Variant.edit(variant)", variant)
        // ----
        if (variant) {
            let detail = set(variant)
            populateForm(detail)
        }
        
    }
    
    const set = function (variant) {
        let detail = defaultDetail()
        if (variant) {
            detail.id = (variant.id) ? variant.id : null
            detail.category_id = (variant.category_id) ? variant.category_id : null
            detail.name = (variant.name) ? variant.name : null
            detail.code = (variant.code) ? variant.code : null
            detail.min_age = (variant.min_age) ? variant.min_age.toString() : null
            detail.max_age = (variant.max_age) ? variant.max_age : null
            detail.enabled = (variant.enabled) ? variant.enabled : 1
            detail.date_created = (variant.date_created) ? variant.date_created : formatDateMySQL()
            detail.created_by = (variant.created_by) ? variant.created_by : user_id
            detail.date_modified = (variant.date_modified) ? variant.date_modified : formatDateMySQL()
            detail.modified_by = (variant.modified_by) ? variant.modified_by : user_id
            detail.used_in_pricing = (variant.used_in_pricing === 1) ? 1 : 0
            detail.note = (variant.note) ? variant.note : null
        }
        
        Product.detail = detail
        return detail
    }
    
    return {
        validator: null,
        all: new Map(),
        set: function (variant) {
            return set(variant)
        },
        edit: function (variant) {
            edit(variant)
        },
        init: function (settings) {
            init(settings)
        },
    }
})()

const Unit = (function () {
    "use strict"
    const _panel_tab_unit = document.getElementById("panel_tab_unit")
    const _button_remove_unit_from_product = document.getElementById("button_remove_unit_from_product")
    const _category_id = document.getElementById("category_id")
    const _product_id = document.getElementById("product_id")
    const _product_edit_unit_form = document.getElementById("product_edit_unit_form")
    const _product_edit_unit_form_submit_button = document.getElementById("product_edit_unit_form_submit_button")
    const _edit_product_unit = document.getElementById("edit_product_unit")
    const _product_edit_unit_form_unit_name_filter = document.getElementById("product_edit_unit_form_unit_name_filter")
    const _table_unit_product_edit = document.getElementById("table_unit_product_edit")
    const _product_edit_unit_form_unit_id = document.getElementById("product_edit_unit_form_unit_id")
    const _product_edit_unit_form_unit_name = document.getElementById("product_edit_unit_form_unit_name")
    const _product_edit_unit_form_unit_room_code = document.getElementById("product_edit_unit_form_unit_room_code")
    const _product_edit_unit_form_unit_min_nights = document.getElementById("product_edit_unit_form_unit_min_nights")
    const _product_edit_unit_form_unit_max_nights = document.getElementById("product_edit_unit_form_unit_max_nights")
    const _product_edit_unit_form_unit_min_pax = document.getElementById("product_edit_unit_form_unit_min_pax")
    const _product_edit_unit_form_unit_max_pax = document.getElementById("product_edit_unit_form_unit_max_pax")
    const _product_edit_unit_form_unit_description_short = document.getElementById("product_edit_unit_form_unit_description_short")
    const _product_edit_unit_form_unit_description_long = document.getElementById("product_edit_unit_form_unit_description_long")
    const _product_edit_unit_form_unit_enabled = document.getElementById("product_edit_unit_form_unit_enabled")
    const _display_product_unit_name = document.getElementById("display_product_unit_name")
    const _product_edit_unit_form_clear_button = document.getElementById("product_edit_unit_form_clear_button")
    const _product_edit_unit_form_close_button = document.getElementById("product_edit_unit_form_close_button")
    const _table_unit_product_edit_add_new_button = document.getElementById("table_unit_product_edit_add_new_button")
    const _unit_keywords = document.getElementById("unit_keywords")
    const _unit_amenities = document.getElementById("unit_amenities")
    const _product_edit_unit_display = document.getElementById("product_edit_unit_display")
    const _product_edit_unit_images = document.getElementById("unit_images")
    
    let counter = 1
    let $unit_keywords, $unit_amenities
    let tabLabel = "Unit"
    let nightsLabel = "Nights"
    let paxLabel = "Pax"
    let maxNightDefaultValue = null
    let minNightDefaultValue = 1
    let maxPaxDefaultValue = null
    let minPaxDefaultValue = 1
    let currentUnit = null
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let $table_unit_product_edit = $(_table_unit_product_edit)
    let category_id
    let globalSelectedUnit = false
    let form_rules = {
        rules: {
            product_edit_unit_form_unit_min_nights: {
                required: true,
                number: true,
                min: 1,
            },
            product_edit_unit_form_unit_min_pax: {
                required: true,
                number: true,
                min: 1,
            },
            product_edit_unit_form_unit_max_pax: {
                required: true,
                number: true,
                min: 1,
            },
        },
        messages: {
            product_edit_unit_form_unit_min_nights: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
            product_edit_unit_form_unit_min_pax: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
            product_edit_unit_form_unit_max_pax: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
        },
    }
    
    $(_button_remove_unit_from_product)
        .on("click", function () {
            remove()
        })
    
    $(_product_edit_unit_form_submit_button)
        .on("click", function () {
            save()
        })
    
    $(_product_edit_unit_form_clear_button)
        .on("click", function () {
            console.log("Unit.product_edit_unit_form_clear_button:click()")
            // ----
            
            resetForm()
            
            $table_unit_product_edit.clearSelectedRows()
            
            _product_edit_unit_form_unit_name_filter.value = ""
            
            _product_edit_unit_form_unit_name_filter.disabled = false
            _product_edit_unit_form_unit_name.disabled = true
        })
    
    $(_product_edit_unit_form_close_button)
        .on("click", function () {
            console.log("Unit.product_edit_unit_form_close_button:click()")
            // ----
            
            resetForm()
            
            $table_unit_product_edit.clearSelectedRows()
            
            _product_edit_unit_form_unit_name_filter.value = ""
            
            _product_edit_unit_form_unit_name_filter.disabled = false
            _product_edit_unit_form_unit_name.disabled = true
        })
    
    $(_table_unit_product_edit_add_new_button)
        .on("click", function () {
            resetForm()
            $table_unit_product_edit.clearSelectedRows()
            disableFormFields()
            _product_edit_unit_form_unit_name_filter.value = ""
            _product_edit_unit_form_unit_name.value = ""
            _product_edit_unit_form_unit_name_filter.disabled = true
            _product_edit_unit_form_unit_name.disabled = false
            enableFormFields()
            loadForm()
        })
    
    $(_panel_tab_unit)
        .on("hide.bs.tab", function () {
            resetForm()
            $table_unit_product_edit.clearSelectedRows()
            _product_edit_unit_form_unit_name_filter.value = ""
            _product_edit_unit_form_unit_name_filter.disabled = false
            _product_edit_unit_form_unit_name.disabled = true
        })
    
    const removeProductUnit = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/units/remove"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleUnitError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const remove = function () {
        confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
            if (ans) {
                let dataToSend = {
                    unit_id: parseInt(_product_edit_unit_form_unit_id.value),
                    product_id: parseInt(_product_id.value),
                }
                
                removeProductUnit(dataToSend, function (data) {
                    let unitId = dataToSend.unit_id
                    if (data) {
                        
                        let unit = Unit.all.get(unitId)
                        
                        if (unit) {
                            $table_unit_product_edit.deleteRow(unit)
                        }
                        
                        Unit.all.delete(unitId)
                        
                        $table_unit_product_edit.clearSelectedRows()
                        
                        _product_edit_unit_form_unit_name_filter.value = ""
                        _product_edit_unit_form_unit_name_filter.disabled = false
                        
                        PricingWorksheet.pricingWorksheet()
                        Pricing.resetForm()
                        YearCalendar.refresh()
                        
                        updateProgress()
                        clearForm()
                        hideForm()
                        clearProductOverview(unit)
                        
                        YearCalendar.endLoading()
                        
                        toastr["warning"](`Unit: ${unit.name} - has been removed`, "Unit")
                    }
                })
            }
        })
    }
    
    const updateProgress = function () {
        let units = Array.from(Unit.all.values())
        
        if (units.length === 0) {
            $(_panel_tab_unit).html(`<span id="tab_span_unit">${tabLabel}</span> <span id="unitNeedsAttention" class="badge rounded-pill badge-notification bg-danger">!</span>`)
        } else {
            $(_panel_tab_unit).html(`<span id="tab_span_unit">${tabLabel}</span>`)
        }
        
        Product.updateProgress()
    }
    
    const initAutoComplete = function () {
        category_id = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        
        $(_product_edit_unit_form_unit_name_filter)
            .on("click", function () {
                $(this).select()
            })
            .on("search", function () {
                globalSelectedUnit = false
                clearForm()
                hideForm()
            })
            .on("change", function () {
                setTimeout(function () {
                    //*
                    let unit_name = _product_edit_unit_form_unit_name_filter.value
                    
                    if (globalSelectedUnit === false) {
                        if (unit_name === "") {
                            globalSelectedUnit = false
                            clearForm()
                            hideForm()
                        } else {
                            nameExists(unit_name)
                        }
                    }
                    //*/
                }, 200)
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/units",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                params: { "category_id": category_id },
                onSelect: function (suggestion) {
                    $table_unit_product_edit.clearSelectedRows()
                    
                    if (!suggestion || !suggestion.data) {
                        return
                    }
                    let detail
                    let unit = suggestion.data
                    let hasUnit = Unit.all.get(parseInt(unit.id))
                    
                    //console.log("_product_edit_unit_form_unit_name_filter:autocomplete() - unit", unit)
                    
                    if (hasUnit) {
                        detail = set(hasUnit)
                        $table_unit_product_edit.loadRow(detail)
                    } else {
                        detail = set(unit)
                    }
                    
                    populateForm(detail)
                },
            })
    }
    
    const nameExists = function (name) {
        //console.log("Unit.nameExists(unit_name)", name)
        if (name && name !== "") {
            /**
             * data to send to the server
             *
             * @type {{name}}
             */
            let dataToSend = {
                name: name,
            }
            
            fetchByName(dataToSend, function (data) {
                let unit = null
                
                if (data && data[0]) {
                    unit = data
                    if (data[0]) {
                        unit = data[0]
                    }
                }
                
                if (unit) {
                    let hasUnit = Unit.all.get(parseInt(unit.id))
                    let detail
                    //console.log("_product_edit_unit_form_unit_name_filter:autocomplete() - unit", unit)
                    
                    if (hasUnit) {
                        detail = set(hasUnit)
                        $table_unit_product_edit.loadRow(detail)
                    } else {
                        detail = set(unit)
                    }
                    
                    populateForm(detail)
                } else {
                    confirmDialog(`The unit: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                        if (ans) {
                            let category_id = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
                            let unitName = (name) ? name : null
                            
                            let newUnit = removeNulls({
                                category_id: category_id,
                                name: unitName,
                            })
                            
                            try {
                                sendPostRequest("/api/v1.0/units/new", newUnit, function (data, status, xhr) {
                                    
                                    if (data) {
                                        let unit = data
                                        if (data[0]) {
                                            unit = data[0]
                                        }
                                        
                                        let detail = set(unit)
                                        
                                        //console.log("detail", detail)
                                        
                                        $table_unit_product_edit.clearSelectedRows()
                                        globalSelectedUnit = false
                                        
                                        clearForm()
                                        
                                        //_product_edit_unit_form_unit_name.value = name
                                        populateForm(detail)
                                        enableFormFields()
                                    } else {
                                    
                                    }
                                })
                            } catch (e) {
                                //console.log("error", e)
                            }
                            
                        } else {
                            resetForm()
                            $table_unit_product_edit.clearSelectedRows()
                            _product_edit_unit_form_unit_name_filter.value = ""
                            _product_edit_unit_form_unit_name_filter.disabled = false
                            _product_edit_unit_form_unit_name.disabled = true
                        }
                    })
                }
            })
        }
    }
    
    const handleUnitError = function (msg) {
        toastr["error"](`${msg}`, "Unit")
    }
    
    const fetchByName = function (dataToSend, callback) {
        let url = "/api/v1.0/units/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleUnitError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleUnitError("Error Validating Unit")
            }
        } else {
            handleUnitError("Error Loading Unit - Missing Data")
        }
    }
    
    const defaultDetail = function () {
        return {
            api_id: null,
            blurb: null,
            category_id: 1,
            cover_image: "/public/img/unit_cover_placeholder.jpg",
            created_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            description_long: null,
            description_short: null,
            enabled: 1,
            end_time: null,
            id: null,
            max_nights: null,
            max_pax: null,
            meeting_point: null,
            min_nights: 1,
            min_pax: 1,
            modified_by: user_id,
            name: null,
            note: null,
            room_code: null,
            start_time: null,
            time_notes: null,
            keywords: [],
            amenities: [],
            images: [],
        }
    }
    
    const set = function (unit) {
        let detail = defaultDetail()
        
        if (unit) {
            detail.api_id = (unit.api_id) ? unit.api_id : null
            detail.blurb = (unit.blurb) ? unit.blurb : null
            detail.category_id = (unit.category_id) ? unit.category_id : null
            detail.cover_image = (unit.cover_image) ? unit.cover_image : "/public/img/unit_cover_placeholder.jpg"
            detail.created_by = (unit.created_by) ? unit.created_by : user_id
            detail.date_created = (unit.date_created) ? unit.date_created : formatDateMySQL()
            detail.date_modified = (unit.date_modified) ? unit.date_modified : formatDateMySQL()
            detail.description_long = (unit.description_long) ? unit.description_long : null
            detail.description_short = (unit.description_short) ? unit.description_short : null
            detail.enabled = (unit.enabled) ? unit.enabled : 1
            detail.end_time = (unit.end_time) ? unit.end_time : null
            detail.id = (unit.id) ? unit.id : null
            detail.max_nights = (unit.max_nights) ? unit.max_nights : null
            detail.max_pax = (unit.max_pax) ? unit.max_pax : null
            detail.meeting_point = (unit.meeting_point) ? unit.meeting_point : null
            detail.min_nights = (unit.min_nights) ? unit.min_nights : 1
            detail.min_pax = (unit.min_pax) ? unit.min_pax : 1
            detail.modified_by = (unit.modified_by) ? unit.modified_by : user_id
            detail.name = (unit.name) ? unit.name : null
            detail.note = (unit.note) ? unit.note : null
            detail.room_code = (unit.room_code) ? unit.room_code : null
            detail.start_time = (unit.start_time) ? unit.start_time : null
            detail.time_notes = (unit.time_notes) ? unit.time_notes : null
            detail.amenities = (unit.amenities) ? unit.amenities : null
            detail.keywords = (unit.keywords) ? unit.keywords : null
            detail.images = (unit.images) ? unit.images : []
        }
        
        return detail
    }
    
    const clearProductOverview = function (unit) {
        //console.log("Unit.clearProductOverview(unit)", unit)
        let color_scheme, product_unit_detail
        
        if (!unit) {
            //console.log("No Unit", unit)
            return
        }
        
        let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
        
        if (unitId) {
            $(`#product_edit_unit_display_${unitId}`).remove()
        }
        
    }
    
    const buildProductOverview = function (unit) {
        //console.log("Unit.buildProductOverview(unit)", unit)
        let color_scheme, product_unit_detail
        
        if (!unit) {
            //console.log("|__ unit", unit)
            //console.log("|__ color_scheme", season.color_scheme)
            //console.log("|__ product_season_detail", season.product_season_detail)
            return
        }
        
        let unitAmenities = (unit.ammenities) ? getListOfIds(unit.ammenities) : []
        let unitApiId = null
        let unitBlurb = null
        let unitCategoryId = (!isNaN(parseInt(unit.category_id))) ? parseInt(unit.category_id) : null
        let unitCoverImage = "/public/img/unit_cover_placeholder.jpg"
        let unitDescriptionLong = null
        let unitDescriptionShort = null
        let unitEnabled = 1
        let unitEndTime = null
        let unitId = (!isNaN(parseInt(unit.id))) ? parseInt(unit.id) : null
        let unitKeywords = (unit.keywords) ? getListOfIds(unit.keywords) : []
        let unitMaxNights = (!isNaN(parseInt(unit.max_nights))) ? parseInt(unit.max_nights) : null
        let unitMaxPax = (!isNaN(parseInt(unit.max_pax))) ? parseInt(unit.max_pax) : null
        let unitMeeting_point = null
        let unitMinNights = (!isNaN(parseInt(unit.min_nights))) ? parseInt(unit.min_nights) : null
        let unitMinPax = (!isNaN(parseInt(unit.min_pax))) ? parseInt(unit.min_pax) : null
        let unitName = (unit.name) ? unit.name : null
        let unitRoomCode = (unit.room_code) ? unit.room_code : null
        let unitStartTime = (unit.start_time) ? unit.start_time : null
        let unitTimeNotes = (unit.time_notes) ? unit.time_notes : null
        let colorSchemeId = counter
        let colorSchemeSelected = colorScheme.get(colorSchemeId)
        if (counter >= 16) {
            counter = 0
        }
        counter++
        
        let backgroundColor = (colorSchemeSelected && colorSchemeSelected.backGround) ? colorSchemeSelected.backGround : "#fff"
        let textColor = (colorSchemeSelected && colorSchemeSelected.textColor) ? colorSchemeSelected.textColor : "#0a070d"
        let borderColor = (colorSchemeSelected && colorSchemeSelected.borderColor) ? colorSchemeSelected.borderColor : "#0a070d"
        
        backgroundColor = shadeColor(backgroundColor, 30)
        borderColor = shadeColor(borderColor, -30)
        
        let _unit = Unit.all.get(unitId)
        
        if (_unit) {
            clearProductOverview(_unit)
        }
        
        $(_product_edit_unit_display).append(`
            <div id="product_edit_unit_display_${unitId}" class="col-12 col-sm-12 col-md-4 px-1">
                <div class="card card-body mb-2" style="background-color:${backgroundColor}; color:${textColor};border:solid 1px ${borderColor};">
                    <h5 class="card-title w-100 text-truncate" style="color:${textColor};border-color:${borderColor}">${unitName}</h5>
                    <h6 class="card-subtitle my-2 text-muted" style="color:${textColor}">${unitRoomCode}</h6>
                    <table class="table table-sm" style="color:${textColor};border-color:${borderColor}">
                        <thead>
                            <tr style="font-size:.85rem;font-weight:400;color:#0a070d;">
                                <th style="font-size:.85rem;font-weight:400;color:#0a070d;">&nbsp;</th>
                                <th style="font-size:.85rem;font-weight:400;color:#0a070d;">Min</th>
                                <th style="font-size:.85rem;font-weight:400;color:#0a070d;">Max</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-top-color: ${borderColor} !important;">
                                <th style="border-top-color: ${borderColor} !important;">Pax:</th>
                                <td>${unitMinPax}</td>
                                <td>${unitMaxPax}</td>
                            </tr>
                            <tr>
                                <th>Nights:</th>
                                <td>${unitMinNights}</td>
                                <td>${unitMaxNights}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        `)
    }
    
    const validUnitRecord = function () {
        let valid = $(_product_edit_unit_form).valid()
        let min_pax = (!isNaN(parseInt(_product_edit_unit_form_unit_min_pax.value))) ? parseInt(_product_edit_unit_form_unit_min_pax.value) : null
        let max_pax = (!isNaN(parseInt(_product_edit_unit_form_unit_max_pax.value))) ? parseInt(_product_edit_unit_form_unit_max_pax.value) : null
        let min_nights = (!isNaN(parseInt(_product_edit_unit_form_unit_min_nights.value))) ? parseInt(_product_edit_unit_form_unit_min_nights.value) : null
        let max_nights = (!isNaN(parseInt(_product_edit_unit_form_unit_max_nights.value))) ? parseInt(_product_edit_unit_form_unit_max_nights.value) : null
        
        if (min_pax !== null && max_pax !== null) {
            if (parseInt(max_pax) < parseInt(min_pax)) {
                setError(_product_edit_unit_form_unit_max_pax, "Pax is greater than minimum")
                valid = false
            } else {
                clearError(_product_edit_unit_form_unit_max_pax)
            }
        }
        
        if (min_nights !== null && max_nights !== null) {
            if (parseInt(max_nights) < parseInt(min_nights)) {
                setError(_product_edit_unit_form_unit_max_nights, "Pax is greater than minimum")
                valid = false
            } else {
                clearError(_product_edit_unit_form_unit_max_nights)
            }
        }
        
        return valid
    }
    
    const buildUnitRecord = function () {
        //console.log("Unit.buildUnitRecord()", Unit)
        let dataToSend = {
            id: (!isNaN(parseInt(_product_edit_unit_form_unit_id.value))) ? parseInt(_product_edit_unit_form_unit_id.value) : null,
            product_id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
            category_id: (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null,
            min_pax: parseInt(_product_edit_unit_form_unit_min_pax.value) ? parseInt(_product_edit_unit_form_unit_min_pax.value) : null,
            max_pax: parseInt(_product_edit_unit_form_unit_max_pax.value) ? parseInt(_product_edit_unit_form_unit_max_pax.value) : null,
            min_nights: parseInt(_product_edit_unit_form_unit_min_nights.value) ? parseInt(_product_edit_unit_form_unit_min_nights.value) : null,
            max_nights: parseInt(_product_edit_unit_form_unit_max_nights.value) ? parseInt(_product_edit_unit_form_unit_max_nights.value) : null,
            api_id: null,
            name: (_product_edit_unit_form_unit_name.value) ? _product_edit_unit_form_unit_name.value : null,
            room_code: (_product_edit_unit_form_unit_room_code.value) ? _product_edit_unit_form_unit_room_code.value : null,
            blurb: null,
            cover_image: "",
            meeting_point: null,
            time_notes: null,
            start_time: null,
            end_time: null,
            description_short: (_product_edit_unit_form_unit_description_short.value) ? _product_edit_unit_form_unit_description_short.value : null,
            description_long: (_product_edit_unit_form_unit_description_long.value) ? _product_edit_unit_form_unit_description_long.value : null,
            enabled: (_product_edit_unit_form_unit_enabled.checked === true) ? 1 : 0,
            keywords: $unit_keywords.build(),
            amenities: $unit_amenities.build(),
        }
        
        return remove_nulls(dataToSend)
    }
    
    const save = function () {
        if (validUnitRecord()) {
            confirmDialog(`Would you like to update? This change may affect your Pricing Worksheets.`, (ans) => {
                if (ans) {
                    let dataToSend = buildUnitRecord()
                    saveProductUnit(dataToSend, function (data) {
                        if (data) {
                            let detail = set((data[0]) ? data[0] : data)
                            let hasUnit = Unit.all.get(detail.id)
                            
                            if (hasUnit) {
                                $table_unit_product_edit.updateRow(detail)
                            } else {
                                $table_unit_product_edit.insertRow(detail)
                            }
                            
                            buildProductOverview(detail)
                            
                            Unit.all.set(detail.id, detail)
                            
                            PricingWorksheet.pricingWorksheet()
                            Pricing.resetForm()
                            YearCalendar.refresh()
                            
                            resetForm()
                            updateProgress()
                            
                            $table_unit_product_edit.clearSelectedRows()
                            _product_edit_unit_form_unit_name_filter.value = ""
                            _product_edit_unit_form_unit_name_filter.disabled = false
                            _product_edit_unit_form_unit_name.disabled = true
                            
                            toastr["success"](`Unit: ${detail.name} - has been updated`, "Unit")
                            YearCalendar.endLoading()
                        }
                    })
                }
            })
        }
    }
    
    const saveProductUnit = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/units/update"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleUnitError("Error")
            }
        }
    }
    
    const disableFormFields = function () {
        _product_edit_unit_form_unit_id.disabled = true
        _product_edit_unit_form_unit_room_code.disabled = true
        _product_edit_unit_form_unit_min_nights.disabled = true
        _product_edit_unit_form_unit_min_pax.disabled = true
        
        _product_edit_unit_form_unit_name.disabled = false
        _product_edit_unit_form_unit_max_nights.disabled = false
        _product_edit_unit_form_unit_max_pax.disabled = false
        _product_edit_unit_form_unit_description_short.disabled = false
        _product_edit_unit_form_unit_description_long.disabled = false
        _product_edit_unit_form_unit_enabled.disabled = false
    }
    
    const initForm = function () {
        let categoryId = (document.getElementById("category_id") && !isNaN(parseInt(document.getElementById("category_id").value))) ? parseInt(document.getElementById("category_id").value) : null
        
        if (categoryId) {
            //console.log("categoryId", categoryId)
            switch (categoryId) {
                case 1:
                    maxNightDefaultValue = null
                    minNightDefaultValue = 1
                    maxPaxDefaultValue = null
                    minPaxDefaultValue = 1
                    
                    paxLabel = "Pax"
                    nightsLabel = "Nights"
                    tabLabel = "Units"
                    break
                case 2:
                    maxNightDefaultValue = 1
                    minNightDefaultValue = 1
                    maxPaxDefaultValue = 1
                    minPaxDefaultValue = 1
                    
                    paxLabel = "Pax"
                    nightsLabel = "Days"
                    tabLabel = "Seat"
                    break
                case 3:
                    maxNightDefaultValue = null
                    minNightDefaultValue = 1
                    maxPaxDefaultValue = null
                    minPaxDefaultValue = 1
                    
                    paxLabel = "Pax"
                    nightsLabel = "Days"
                    tabLabel = "Units"
                    break
                case 4:
                    maxNightDefaultValue = null
                    minNightDefaultValue = 1
                    maxPaxDefaultValue = null
                    minPaxDefaultValue = 1
                    
                    paxLabel = "Pax"
                    nightsLabel = "Nights"
                    tabLabel = "Units"
                    break
                case 5:
                    maxNightDefaultValue = null
                    minNightDefaultValue = 1
                    maxPaxDefaultValue = null
                    minPaxDefaultValue = 1
                    
                    paxLabel = "Pax"
                    nightsLabel = "Nights"
                    tabLabel = "Units"
                    break
                default:
                    maxNightDefaultValue = null
                    minNightDefaultValue = 1
                    maxPaxDefaultValue = null
                    minPaxDefaultValue = 1
                    
                    paxLabel = "Pax"
                    nightsLabel = "Nights"
                    tabLabel = "Units"
            }
            
            $unit_keywords = $(_unit_keywords).BuildKeyword([])
            $unit_amenities = $(_unit_amenities).BuildKeyword([])
        }
    }
    
    const loadAll = function (units) {
        console.log("Unit.loadAll(units)", units)
        Unit.all = new Map()
        
        if (!units) {
            units = []
        }
        
        $.each(units, function (k, unit) {
            console.log("|__ unit", unit)
            let detail = set(unit)
            
            $table_unit_product_edit.insertRow(detail)
            buildProductOverview(detail)
            Unit.all.set(detail.id, detail)
        })
        
        updateProgress()
    }
    
    const buildProductEditTable = function () {
        category_id = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        
        if (category_id === 1) {
            Unit.byValue = "Night"
            Unit.paxValue = "Pax"
        } else {
            Unit.byValue = "Day"
            Unit.paxValue = "Pax"
        }
        
        $table_unit_product_edit = $(_table_unit_product_edit).table({
            table_type: "display_list",
            data: [],
            columnDefs: [
                {
                    title: "Room Code",
                    targets: 0,
                    data: "room_code",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Name",
                    targets: 1,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Min " + Unit.byValue + "(s)",
                    targets: 2,
                    data: "min_nights",
                    render: function (data, type, row, meta) {
                        let nights = 1
                        if (data === null) {
                            nights = "null"
                        } else {
                            nights = data
                        }
                        return "<span style='white-space: nowrap;'>" + nights + "</span>"
                    },
                },
                {
                    title: "Max " + Unit.byValue + "(s)",
                    targets: 3,
                    data: "max_nights",
                    render: function (data, type, row, meta) {
                        let nights = 1
                        if (data === null) {
                            nights = "&infin;"
                        } else {
                            nights = data
                        }
                        return "<span style='white-space: nowrap;'>" + nights + "</span>"
                    },
                },
                {
                    title: "Min " + Unit.paxValue + "",
                    targets: 4,
                    data: "min_pax",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Max " + Unit.paxValue + "",
                    targets: 5,
                    data: "max_pax",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
            ],
            rowClick: Unit.edit,
        })
    }
    
    const init = function (settings) {
        let units = []
        
        if (settings) {
            units = settings
            if (settings.units) {
                units = settings.units
            }
        }
        
        $(document).ready(function () {
            if (_product_edit_unit_form) {
                initAutoComplete()
                validator_init(form_rules)
                Unit.validator = $(_product_edit_unit_form).validate()
                initForm()
            }
            
            if (_product_edit_unit_images) {
                Unit.unitImages = $("#unit_images").fileManager({
                    height: 400,
                    source: "unit",
                    //sourceId: 204,
                    images: [],
                })
            }
            
            if (_product_edit_unit_form_unit_name_filter) {
                buildProductEditTable()
                loadAll(units)
            }
            
            if (_edit_product_unit) {
                resetForm()
                updateProgress()
            }
        })
    }
    
    const edit = function (unit) {
        console.log("Unit.edit(unit)", unit)
        let currentUnitId = (currentUnit && currentUnit.id && (!isNaN(parseInt(currentUnit.id)))) ? parseInt(currentUnit.id) : null
        let editUnitId = (unit && unit.id && (!isNaN(parseInt(unit.id)))) ? parseInt(unit.id) : null
        
        if (currentUnitId && editUnitId) {
            if (currentUnitId === editUnitId) {
                return
            }
        }
        
        currentUnit = unit
        
        populateForm(unit)
        Unit.unitImages.load({
            height: 400,
            source: "unit",
            sourceId: unit.id,
            images: unit.images,
        })
        enableFormFields()
    }
    
    const clearForm = function () {
        console.log("Unit:clearForm()")
        // ----
        
        _product_edit_unit_form_unit_id.value = ""
        _product_edit_unit_form_unit_name.value = ""
        _product_edit_unit_form_unit_room_code.value = ""
        _product_edit_unit_form_unit_min_nights.value = 1
        _product_edit_unit_form_unit_max_nights.value = ""
        _product_edit_unit_form_unit_min_pax.value = 1
        _product_edit_unit_form_unit_max_pax.value = ""
        _product_edit_unit_form_unit_description_short.value = ""
        _product_edit_unit_form_unit_description_long.value = ""
        _product_edit_unit_form_unit_enabled.checked = true
    }
    
    const hideForm = function () {
        console.log("Unit:hideForm()")
        // ----
        
        if (_edit_product_unit) {
            $(_edit_product_unit).hide()
            _product_edit_unit_form_unit_name_filter.disabled = false
            updateProgress()
        }
    }
    
    const resetForm = function () {
        console.log("Unit:resetForm()")
        // ----
        
        let categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        
        clearForm()
        hideForm()
        
        let labelMinPax, labelMaxPax, labelMinNights, labelMaxNights,
            disabledMinPax, disabledMaxPax, disabledMinNights, disabledMaxNights,
            valueMinPax, valueMaxPax, valueMinNights, valueMaxNights,
            labelRoomCode, disabledRoomCode
        
        switch (categoryId) {
            case 1:
                labelMinPax = "Minimum Pax:"
                labelMaxPax = "Maximum Pax:"
                labelMinNights = "Minimum Nights:"
                labelMaxNights = "Maximum Nights:"
                
                labelRoomCode = "Room Code:"
                
                disabledMinPax = false
                disabledMaxPax = false
                disabledMinNights = false
                disabledMaxNights = false
                disabledRoomCode = false
                
                valueMinPax = 1
                valueMaxPax = ""
                valueMinNights = 1
                valueMaxNights = ""
                break
            case 2:
                labelMinPax = "Minimum Pax:"
                labelMaxPax = "Maximum Pax:"
                labelMinNights = "Minimum Days:"
                labelMaxNights = "Maximum Days:"
                
                labelRoomCode = "Seat Code:"
                
                valueMinPax = 1
                valueMaxPax = 1
                valueMinNights = 1
                valueMaxNights = 1
                
                break
            case 3:
                labelMinPax = "Minimum Pax:"
                labelMaxPax = "Maximum Pax:"
                labelMinNights = "Minimum Days:"
                labelMaxNights = "Maximum Days:"
                
                labelRoomCode = "Unit Code:"
                
                valueMinPax = 1
                valueMaxPax = 1
                valueMinNights = 1
                valueMaxNights = 1
                
                break
            case 4:
                labelMinPax = "Minimum Pax:"
                labelMaxPax = "Maximum Pax:"
                labelMinNights = "Minimum Days:"
                labelMaxNights = "Maximum Days:"
                
                labelRoomCode = "Seat Code:"
                
                valueMinPax = 1
                valueMaxPax = 1
                valueMinNights = 1
                valueMaxNights = 1
                
                break
            default:
                labelMinPax = "Minimum Pax:"
                labelMaxPax = "Maximum Pax:"
                labelMinNights = "Minimum Nights:"
                labelMaxNights = "Maximum Nights:"
                
                disabledMinPax = false
                disabledMaxPax = false
                disabledMinNights = false
                disabledMaxNights = false
                
                valueMinPax = 1
                valueMaxPax = ""
                valueMinNights = 1
                valueMaxNights = ""
        }
        
        let labels = document.getElementsByTagName("LABEL")
        
        for (let i = 0; i < labels.length; i++) {
            if (labels[i].htmlFor !== '') {
                let elem = document.getElementById(labels[i].htmlFor)
                if (elem) {
                    elem.label = labels[i]
                }
            }
        }
        
        _product_edit_unit_form_unit_min_nights.value = valueMinNights
        _product_edit_unit_form_unit_max_nights.value = valueMaxNights
        _product_edit_unit_form_unit_min_pax.value = valueMinPax
        _product_edit_unit_form_unit_max_pax.value = valueMaxPax
        
        _product_edit_unit_form_unit_min_nights.label.innerHTML = labelMinNights
        _product_edit_unit_form_unit_max_nights.label.innerHTML = labelMaxNights
        _product_edit_unit_form_unit_min_pax.label.innerHTML = labelMinPax
        _product_edit_unit_form_unit_max_pax.label.innerHTML = labelMaxPax
        _product_edit_unit_form_unit_room_code.label.innerHTML = labelRoomCode
        
        _product_edit_unit_form_unit_min_nights.disabled = disabledMinNights
        _product_edit_unit_form_unit_max_nights.disabled = disabledMaxNights
        _product_edit_unit_form_unit_min_pax.disabled = disabledMinPax
        _product_edit_unit_form_unit_max_pax.disabled = disabledMaxPax
        
        $unit_amenities.clear()
        $unit_keywords.clear()
    }
    
    const loadForm = function () {
        if (_edit_product_unit) {
            $('label[for="product_edit_unit_form_unit_min_nights"]').html(`Minimum ${nightsLabel}`)
            $('label[for="product_edit_unit_form_unit_max_nights"]').html(`Maximum ${nightsLabel}`)
            $('label[for="product_edit_unit_form_unit_min_pax"]').html(`Minimum ${paxLabel}`)
            $('label[for="product_edit_unit_form_unit_max_pax"]').html(`Maximum ${paxLabel}`)
            
            $(_edit_product_unit).show()
            _product_edit_unit_form_unit_name_filter.disabled = true
        }
    }
    
    const populateForm = function (unit) {
        resetForm()
        
        if (unit) {
            let categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
            let unit_keywords = (unit.keywords) ? unit.keywords : []
            let unit_amenities = (unit.amenities) ? unit.amenities : []
            
            if (categoryId === 2 || categoryId === 4) {
                _product_edit_unit_form_unit_min_nights.value = (unit.min_nights) ? unit.min_nights : 1
                _product_edit_unit_form_unit_max_nights.value = (unit.max_nights) ? unit.max_nights : 1
                _product_edit_unit_form_unit_min_pax.value = (unit.min_pax) ? unit.min_pax : 1
                _product_edit_unit_form_unit_max_pax.value = (unit.max_pax) ? unit.max_pax : 1
                
                _product_edit_unit_form_unit_min_nights.disabled = true
                _product_edit_unit_form_unit_max_nights.disabled = true
                _product_edit_unit_form_unit_min_pax.disabled = true
                _product_edit_unit_form_unit_max_pax.disabled = true
                _product_edit_unit_form_unit_room_code.disabled = true
                
            } else {
                _product_edit_unit_form_unit_min_nights.value = (unit.min_nights) ? unit.min_nights : 1
                _product_edit_unit_form_unit_max_nights.value = (unit.max_nights) ? unit.max_nights : null
                _product_edit_unit_form_unit_min_pax.value = (unit.min_pax) ? unit.min_pax : 1
                _product_edit_unit_form_unit_max_pax.value = (unit.max_pax) ? unit.max_pax : null
                
                _product_edit_unit_form_unit_min_nights.disabled = false
                _product_edit_unit_form_unit_max_nights.disabled = false
                _product_edit_unit_form_unit_min_pax.disabled = false
                _product_edit_unit_form_unit_max_pax.disabled = false
                _product_edit_unit_form_unit_room_code.disabled = false
                
            }
            
            _product_edit_unit_form_unit_name_filter.value = (unit.name) ? unit.name : ""
            _product_edit_unit_form_unit_id.value = (unit.id) ? unit.id : ""
            _product_edit_unit_form_unit_name.value = (unit.name) ? unit.name : ""
            _product_edit_unit_form_unit_room_code.value = (unit.room_code) ? unit.room_code : ""
            _product_edit_unit_form_unit_description_short.value = (unit.description_short) ? unit.description_short : ""
            _product_edit_unit_form_unit_description_long.value = (unit.description_long) ? unit.description_long : ""
            _product_edit_unit_form_unit_enabled.checked = true
            _display_product_unit_name.innerText = (unit.name) ? unit.name : ""
            
            $unit_keywords.set(unit_keywords)
            $unit_amenities.set(unit_amenities)
            
        }
        
        loadForm()
    }
    
    const enableFormFields = function () {
        
        disableFormFields()
        
        _product_edit_unit_form_unit_id.disabled = true
        _product_edit_unit_form_unit_name.disabled = true
        _product_edit_unit_form_unit_room_code.disabled = true
        _product_edit_unit_form_unit_enabled.disabled = true
        
        _product_edit_unit_form_unit_description_short.disabled = false
        _product_edit_unit_form_unit_description_long.disabled = false
        
    }
    
    return {
        unitImages: null,
        all: new Map(),
        byValue: "Night",
        paxValue: "Pax",
        validator: null,
        edit: function (unit) {
            edit(unit)
        },
        init: function (settings) {
            init(settings)
        },
    }
})()

const Address = (function () {
    "use strict"
    const _button_add_address_table = document.getElementById("button_add_address_table")
    const _button_close_edit_address_form = document.getElementById("button_close_edit_address_form")
    const _button_clear_form_edit_address = document.getElementById("button_clear_form_edit_address")
    const _button_submit_form_edit_address = document.getElementById("button_submit_form_edit_address")
    const _form_edit_address = document.getElementById("form_edit_address")
    const _card_edit_address_form = document.getElementById("card_edit_address_form")
    const _table_address = document.getElementById("table_address")
    const _address_id = document.getElementById("address_id")
    const _company_id = document.getElementById("company_id")
    const _address_enabled = document.getElementById("address_enabled")
    const _address_street_1 = document.getElementById("address_street_1")
    const _address_street_2 = document.getElementById("address_street_2")
    const _address_street_3 = document.getElementById("address_street_3")
    const _address_country_id = document.getElementById("address_country_id")
    const _address_types_id = document.getElementById("address_types_id")
    const _address_province_id = document.getElementById("address_province_id")
    const _address_city_id = document.getElementById("address_city_id")
    const _address_postal_code = document.getElementById("address_postal_code")
    const _address_company_id = document.getElementById("address_company_id")
    const _clear_address_table = document.getElementById("clear_address_table")
    /**
     * Defaults
     */
    let default_display = defaultAddressView
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let $address_table = $(_table_address)
    let temp_address = {}
    let validator
    let form_rules = {
        groups: {
            cityGroup: "address_country_id address_province_id address_city_id",
        },
        rules: {
            
            address_types_id: {
                required: true,
            },
            address_company_id: {
                required: true,
            },
            address_country_id: {
                required: true,
            },
            address_province_id: {
                required: true,
            },
            address_city_id: {
                required: true,
            },
        },
        messages: {
            address_company_id: {
                required: "Field Required",
            },
            address_types_id: {
                required: "Field Required",
            },
            address_country_id: {
                required: "Field Required",
            },
            address_province_id: {
                required: "Field Required",
            },
            address_city_id: {
                required: "Field Required",
            },
        },
    }
    
    /**
     * add new address
     */
    $(_button_add_address_table)
        .on("click", function () {
            $address_table.clearSelectedRows()
            clear_form()
            load_form()
        })
    
    /**
     * clear address form button
     */
    $(_button_clear_form_edit_address)
        .on("click", function () {
            $address_table.clearSelectedRows()
            clear_form()
        })
    
    /**
     * submit button save address
     */
    $(_button_submit_form_edit_address)
        .on("click", function () {
            let dataToSend = build()
            if (!dataToSend) {
                return
            }
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    save(dataToSend)
                }
            })
        })
    
    /**
     * close address form
     */
    $(_button_close_edit_address_form)
        .on("click", function () {
            $address_table.clearSelectedRows()
            clear_form()
            unload_form()
        })
    
    /**
     * clear address table button
     */
    $(_clear_address_table)
        .on("click", function () {
            Address.clearTable()
        })
    
    /**
     * save address form data
     */
    const save = function (dataToSend) {
        
        if (dataToSend) {
            update_address(dataToSend, function (data) {
                if (data) {
                    if (data[0]) {
                        let address = data[0]
                        let detail = set_detail(address)
                        if (Address.all.get(detail.id)) {
                            $address_table.updateRow(detail)
                        } else {
                            $address_table.insertRow(detail)
                        }
                        
                        Address.all.set(detail.id, detail)
                        
                        $address_table.clearSelectedRows()
                        clear_form()
                        unload_form()
                        
                        toastr.success("Address Updated")
                        
                    }
                }
            })
        }
    }
    
    /**
     * build address record to update
     *
     * @returns {{}|*}
     */
    const build = function () {
        /**
         * address_types_id: [1]
         * city_id: 428
         * company_id: 1
         * country_id: 219
         * enabled: 1
         * id: 1
         * postal_code: "12345"
         * province_id: 51
         * street_1: "STREET 1"
         * street_2: "STREET 2"
         * street_3: "STREET 3"
         */
        if (validate_form()) {
            let dataToSend = {
                company_id: (!isNaN(parseInt(_address_company_id.value))) ? parseInt(_address_company_id.value) : null,
                street_1: (_address_street_1.value !== "") ? _address_street_1.value : null,
                street_2: (_address_street_2.value !== "") ? _address_street_2.value : null,
                street_3: (_address_street_3.value !== "") ? _address_street_3.value : null,
                postal_code: (_address_postal_code.value !== "") ? _address_postal_code.value : null,
                country_id: (!isNaN(_address_country_id.value)) ? parseInt(_address_country_id.value) : null,
                province_id: (!isNaN(_address_province_id.value)) ? parseInt(_address_province_id.value) : null,
                city_id: (!isNaN(_address_city_id.value)) ? parseInt(_address_city_id.value) : null,
                address_types_id: toNumbers(getListOfIds($(_address_types_id).val())),
                enabled: (_address_enabled.checked === true) ? 1 : 0,
                id: (!isNaN(parseInt(_address_id.value))) ? parseInt(_address_id.value) : null,
            }
            return remove_nulls(dataToSend)
        }
    }
    
    /**
     * update address
     *
     * @param dataToSend
     * @param callback
     */
    const update_address = function (dataToSend, callback) {
        let url = "/api/v1.0/addresses/update"
        if (dataToSend) {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                } else {
                    return handle_address_error("Oops: 1")
                }
            })
        }
    }
    
    /**
     * validate address form for submit
     *
     * @returns {*|jQuery}
     */
    const validate_form = function () {
        return $(_form_edit_address).valid()
    }
    
    /**
     * handle_address_error
     *
     * @param msg
     */
    const handle_address_error = function (msg) {
        toastr.error(msg)
    }
    
    /**
     * sets objects default values
     *
     * @returns {{note: null, country: {note: null, date_modified: *, date_created: *, name: null, modified_by: number, id: null, iso2: null, sort_order: number, created_by: number, currency_id: null, enabled: number, iso3: null}, medium_address_formatted: null, city: {note: null, date_modified: *, province_id: null, date_created: *, name: null, modified_by: number, id: null, sort_order: number, created_by: number, enabled: number}, date_created: *, created_by: number, enabled: number, short_address_formatted: null, long_address_formatted: null, street_1: null, date_modified: *, province: {note: null, date_modified: *, date_created: *, name: null, modified_by: number, id: null, iso2: null, sort_order: number, created_by: number, country_id: null, enabled: number, iso3: null}, street_3: null, street_2: null, modified_by: number, id: null, postal_code: null}}
     * @private
     */
    const _default_detail = function () {
        return {
            id: null,
            company_id: null,
            street_1: null,
            street_2: null,
            street_3: null,
            postal_code: null,
            enabled: 1,
            address_types_id: [],
            date_created: formatDateMySQL(),
            created_by: parseInt(user_id),
            date_modified: formatDateMySQL(),
            modified_by: parseInt(user_id),
            note: null,
            short_address_formatted: null,
            medium_address_formatted: null,
            long_address_formatted: null,
            country: {
                id: null,
                name: null,
                iso2: null,
                iso3: null,
                currency_id: null,
                sort_order: 999,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: parseInt(user_id),
                date_modified: formatDateMySQL(),
                modified_by: parseInt(user_id),
                note: null,
            },
            province: {
                id: null,
                country_id: null,
                name: null,
                iso2: null,
                iso3: null,
                sort_order: 999,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: parseInt(user_id),
                date_modified: formatDateMySQL(),
                modified_by: parseInt(user_id),
                note: null,
            },
            city: {
                id: null,
                province_id: null,
                name: null,
                sort_order: 999,
                enabled: 1,
                date_created: formatDateMySQL(),
                created_by: parseInt(user_id),
                date_modified: formatDateMySQL(),
                modified_by: parseInt(user_id),
                note: null,
            },
            formatted_types: "",
        }
    }
    
    /**
     * clears address form
     */
    const clear_form = function () {
        _address_id.value = ""
        _address_enabled.checked = true
        _address_street_1.value = ""
        _address_street_2.value = ""
        _address_street_3.value = ""
        _address_postal_code.value = ""
        $(_address_types_id).val([])
        $(_address_country_id).val("").trigger("change")
    }
    
    /**
     * populate address form
     *
     * @param address
     */
    const populate_form = function (address) {
        if (address) {
            _address_id.value = (address.id) ? address.id : null
            _address_company_id.value = (address.company_id) ? address.company_id : null
            $(_address_types_id).val((address.address_types_id) ? address.address_types_id : [])
            _address_enabled.checked = (address.enabled === 1)
            _address_street_1.value = (address.street_1) ? address.street_1 : null
            _address_street_2.value = (address.street_2) ? address.street_2 : null
            _address_street_3.value = (address.street_3) ? address.street_3 : null
            _address_postal_code.value = (address.postal_code) ? address.postal_code : null
            Province.id = address.province.id
            Country.id = address.country.id
            City.id = address.city.id
            
            $(_address_country_id).val((address.country.id) ? address.country.id : "").trigger("change")
        }
    }
    
    /**
     * reset address edit form
     */
    const reset_form = function () {
        _address_id.value = ""
        _address_company_id.value = _company_id.value
        $(_address_types_id).val([])
        _address_enabled.checked = true
        _address_street_1.value = ""
        _address_street_2.value = ""
        _address_street_3.value = ""
        _address_country_id.value = ""
        _address_province_id.value = ""
        _address_city_id.value = ""
        _address_postal_code.value = ""
    }
    
    /**
     * shows address edit form
     */
    const unload_form = function () {
        if (_card_edit_address_form) {
            $(_card_edit_address_form).hide()
        }
    }
    
    /**
     * hides address edit form
     */
    const load_form = function (address) {
        if (_card_edit_address_form) {
            reset_form()
            populate_form(address)
            $(_card_edit_address_form).show()
        }
    }
    
    /**
     * build address table structure
     */
    const build_table = function () {
        let table_address_render_value = default_display + "_address_formatted"
        if (!$.fn.DataTable.isDataTable(_table_address)) {
            $address_table = $(_table_address).table({
                table_type: "display_list",
                data: Array.from(Address.all.values()),
                columnDefs: [
                    {
                        title: "ID",
                        targets: 0,
                        data: "id",
                        render: function (data, type, row, meta) {
                            return data
                        },
                    },
                    {
                        title: "Address",
                        targets: 1,
                        data: table_address_render_value,
                        render: function (data, type, row, meta) {
                            return data
                        },
                    },
                    {
                        title: "Types",
                        targets: 2,
                        data: "formatted_types",
                        render: function (data, type, row, meta) {
                            return data
                        },
                    },
                ],
                rowClick: Address.navigate,
            })
        }
    }
    
    /**
     * load address into object
     *
     * @param addresses
     */
    const load_all = function (addresses) {
        Address.all = new Map()
        if (!addresses) {
            return
        }
        let loadAddress
        let count = 0
        $.each(addresses, function (i, address) {
            let detail = set_detail(address)
            if (count === 0) {
                loadAddress = detail
            }
            
            Address.all.set(detail.id, detail)
            $address_table.insertRow(detail)
            count++
        })
        
        if (_table_address) {
            if (loadAddress) {
                $address_table.loadRow(loadAddress)
            }
            
            $address_table.clearSelectedRows()
        }
        
        if (_card_edit_address_form) {
            clear_form()
            unload_form()
        }
    }
    
    /**
     * populate address table with addresses
     *
     * @param addresses
     */
    const populate_table = function (addresses) {
        if (_table_address) {
            Address.all = new Map()
            let loadAddress
            let count = 0
            $.each(addresses, function (i, address) {
                
                if (count === 0) {
                    loadAddress = address
                }
                
                address.address_types_id = getListOfIds(address.address_types_id)
                
                Address.all.set(address.id, address)
                
                $address_table.insertRow(address)
                count++
            })
            
            if (_table_address) {
                if (loadAddress) {
                    $address_table.loadRow(loadAddress)
                }
                
                $address_table.clearSelectedRows()
            }
        }
    }
    
    /**
     * initialize address form and table
     *
     * @param addresses
     */
    const init = function (addresses) {
        if (_table_address) {
            build_table()
        }
        
        if (addresses) {
            load_all(addresses)
        }
        
        if (_form_edit_address) {
            validator_init(form_rules)
            validator = $(_form_edit_address).validate()
            
            $(_address_country_id).BuildDropDown({
                data: Array.from(Country.all.values()),
                title: "Country",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            $(_address_province_id).BuildDropDown({
                data: [],
                title: "Province",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            $(_address_city_id).BuildDropDown({
                data: [],
                title: "City",
                id_field: "id",
                text_field: "name",
                first_selectable: false,
            })
            
            Country.init({
                dropdowns: [
                    "address_country_id",
                ],
            })
            Province.init({
                dropdowns: [
                    "address_province_id",
                ],
            })
            City.init({
                dropdowns: [
                    "address_city_id",
                ],
            })
            
        }
    }
    
    /**
     * set address object detail
     */
    const set_detail = function (address) {
        let detail = _default_detail()
        if (address) {
            //console.log("address", address)
            detail.country = {
                id: parseInt((address.country.id) ? address.country.id : null),
                name: (address.country.name) ? address.country.name : null,
                name_long: (address.country.name_long) ? address.country.name_long : null,
                currency_id: parseInt((address.country.currency_id) ? address.country.currency_id : null),
                iso2: (address.country.iso2) ? address.country.iso2 : null,
                iso3: (address.country.iso3) ? address.country.iso3 : null,
                sort_order: parseInt((address.country.sort_order) ? address.country.sort_order : 999),
                enabled: parseInt((address.country.enabled) ? address.country.enabled : 1),
                date_created: (address.country.date_created) ? address.country.date_created : formatDateMySQL(),
                created_by: parseInt((address.country.created_by) ? address.country.created_by : user_id),
                date_modified: (address.country.date_modified) ? address.country.date_modified : formatDateMySQL(),
                modified_by: parseInt((address.country.modified_by) ? address.country.modified_by : user_id),
                note: (address.country.note) ? address.country.note : null,
                
            }
            detail.province = {
                id: parseInt((address.province.id) ? address.province.id : null),
                country_id: parseInt((address.country.id) ? address.country.id : null),
                name: (address.province.name) ? address.province.name : null,
                iso2: (address.province.iso2) ? address.province.iso2 : null,
                iso3: (address.province.iso3) ? address.province.iso3 : null,
                sort_order: parseInt((address.province.sort_order) ? address.province.sort_order : 999),
                enabled: parseInt((address.province.enabled) ? address.province.enabled : 1),
                date_created: (address.province.date_created) ? address.province.date_created : formatDateMySQL(),
                created_by: parseInt((address.province.created_by) ? address.province.created_by : user_id),
                date_modified: (address.province.date_modified) ? address.province.date_modified : formatDateMySQL(),
                modified_by: parseInt((address.province.modified_by) ? address.province.modified_by : user_id),
                note: (address.province.note) ? address.province.note : null,
            }
            detail.city = {
                id: parseInt((address.city.id) ? address.city.id : null),
                province_id: parseInt((address.province.id) ? address.province.id : null),
                name: (address.city.name) ? address.city.name : null,
                sort_order: parseInt((address.city.sort_order) ? address.city.sort_order : 999),
                enabled: parseInt((address.city.enabled) ? address.city.enabled : 1),
                date_created: (address.city.date_created) ? address.city.date_created : formatDateMySQL(),
                created_by: parseInt((address.city.created_by) ? address.city.created_by : user_id),
                date_modified: (address.city.date_modified) ? address.city.date_modified : formatDateMySQL(),
                modified_by: parseInt((address.city.modified_by) ? address.city.modified_by : user_id),
                note: (address.city.note) ? address.city.note : null,
            }
            detail.id = parseInt((address.id) ? address.id : null)
            detail.company_id = parseInt((address.company_id) ? address.company_id : null)
            detail.address_types_id = getListOfIds(address.address_types_id)
            detail.short_address_formatted = (address.short_address_formatted) ? address.short_address_formatted : null
            detail.medium_address_formatted = (address.medium_address_formatted) ? address.medium_address_formatted : null
            detail.long_address_formatted = (address.long_address_formatted) ? address.long_address_formatted : null
            detail.street_1 = (address.street_1) ? address.street_1 : null
            detail.street_2 = (address.street_2) ? address.street_2 : null
            detail.street_3 = (address.street_3) ? address.street_3 : null
            detail.postal_code = (address.postal_code) ? address.postal_code : null
            detail.enabled = parseInt((address.enabled) ? address.enabled : 1)
            detail.date_created = (address.date_created) ? address.date_created : formatDateMySQL()
            detail.created_by = parseInt((address.created_by) ? address.created_by : user_id)
            detail.date_modified = (address.date_modified) ? address.date_modified : formatDateMySQL()
            detail.modified_by = parseInt((address.modified_by) ? address.modified_by : user_id)
            detail.note = (address.note) ? address.note : null
            detail.formatted_types = (address.formatted_types) ? address.formatted_types : ""
        }
        temp_address = detail
        Address.detail = detail
        return detail
    }
    
    /**
     * populate form with selected address
     *
     * @param address
     */
    const navigate = function (address) {
        if (address) {
            load_form(address)
        }
    }
    
    /**
     * clear and empty table
     */
    const clearTable = function () {
        let addresses = Array.from(Address.all.values())
        
        $.each(addresses, function (k, address) {
            $address_table.deleteRow(address)
        })
        
        Address.all = new Map()
    }
    
    /**
     * post request to fetch addresses by company id
     *
     * @param dataToSend
     * @param callback
     */
    const fetch_addresses_by_company_id = function (dataToSend, callback) {
        let url = "/api/v1.0/addresses"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_address_error("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handle_address_error("Error Validating Company")
            }
        } else {
            return handle_address_error("Error Loading Company- Missing Data")
        }
    }
    
    /**
     * get all addresses by company id
     *
     * @param company_id
     */
    const get_by_company_id = function (company_id) {
        if (company_id) {
            fetch_addresses_by_company_id({ company_id: company_id }, function (data) {
                if (data) {
                    let addresses = data
                    clearTable()
                    populate_table(addresses)
                }
            })
        }
    }
    
    /**
     * globals
     */
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get_by_company_id: function (company_id) {
            get_by_company_id(company_id)
        },
        get: function (address_id) {
        
        },
        navigate: function (address) {
            navigate(address)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        clearTable: function () {
            clearTable()
        },
        init: function (addresses) {
            init(addresses)
        },
    }
    
})()

const Register = (function () {
    "use strict"
    const base_url = "/register"
    
    const init = function (settings) {
    
    }
    
    return {
        init: function (settings) {
            init(settings)
        },
    }
    
})()

$.fn.DisabledDOW = function (settings) {
    "use strict"
    let id = this.attr("id")
    let label_text = "Disabled DOW"
    let name_prefix = id + "_"
    if (settings) {
        if (settings.name && settings.name !== "") {
            name_prefix = settings.name
        }
        
        if (settings && settings.label && settings.label !== "") {
            label_text = settings.label
        }
    }
    const _this = document.getElementById(id)
    const $this = $(_this)
    
    $this.on("change", function () {
        //console.log("change")
    })
    
    /**
     * buildCheckBox
     *
     * @param day
     * @returns {HTMLInputElement}
     */
    const buildCheckBox = function (day) {
        let input = document.createElement("input")
        input.type = "checkbox"
        input.classList = day.class
        input.id = day.for
        input.name = day.for
        input.value = day.value
        
        input.addEventListener("click", event => {
            
            let id = (input.id) ? input.id : ""
            set(input, id)
        })
        
        return input
    }
    
    const buildCheckBoxWrapper = function () {
        let div = document.createElement("div")
        
        div.classList.add("custom-control")
        div.classList.add("custom-checkbox")
        div.classList.add("custom-control-inline")
        
        return div
    }
    
    const buildCheckBoxLabel = function (day) {
        let label = document.createElement("label")
        
        label.classList.add("custom-control-label")
        label.htmlFor = day.for
        label.innerText = day.label
        
        return label
    }
    
    const buildCheckBoxColumn = function () {
        let days = Array.from(DisabledDOW.days_of_week.values())
        let div = document.createElement("div")
        
        div.classList.add("col-12")
        div.classList.add("col-md-10")
        div.classList.add("px-1")
        
        $.each(days, function (k, day) {
            let wrapper = buildCheckBoxWrapper()
            let label = buildCheckBoxLabel(day)
            let input = buildCheckBox(day)
            wrapper.appendChild(input)
            wrapper.appendChild(label)
            div.appendChild(wrapper)
        })
        
        return div
    }
    
    const buildCheckBoxColumnLabel = function () {
        let div = document.createElement("div")
        let label = document.createElement("label")
        
        label.innerText = label_text + ":"
        
        div.classList.add("col-12")
        div.classList.add("col-md-2")
        div.classList.add("px-1")
        
        div.appendChild(label)
        
        return div
    }
    
    const buildCheckBoxRow = function () {
        let div = document.createElement("div")
        div.classList = "row"
        return div
    }
    
    const buildForm = function () {
        $this.empty()
        DisabledDOW.days_of_week = new Map()
        
        DisabledDOW.days_of_week.set(
            "*", {
                label: "All",
                for: name_prefix + "dow_select_all",
                value: "*",
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "0", {
                label: "Sun",
                for: name_prefix + "dow_select_sun",
                value: 0,
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "1", {
                label: "Mon",
                for: name_prefix + "dow_select_mon",
                value: 1,
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "2", {
                label: "Tue",
                for: name_prefix + "dow_select_tue",
                value: 2,
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "3", {
                label: "Wed",
                for: name_prefix + "dow_select_wed",
                value: 3,
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "4", {
                label: "Thu",
                for: name_prefix + "dow_select_thu",
                value: 4,
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "5", {
                label: "Fri",
                for: name_prefix + "dow_select_fri",
                value: 5,
                class: "custom-control-input dow_select",
            })
        DisabledDOW.days_of_week.set(
            "6", {
                label: "Sat",
                for: name_prefix + "dow_select_sat",
                value: 6,
                class: "custom-control-input dow_select",
            })
        
        let row = buildCheckBoxRow()
        let leadColumn = buildCheckBoxColumnLabel()
        let column = buildCheckBoxColumn()
        row.appendChild(leadColumn)
        row.appendChild(column)
        _this.appendChild(row)
    }
    
    const clear_selected = function () {
        $.each(Array.from(DisabledDOW.days_of_week.values()), function (k, day) {
            document.getElementById(day.for).checked = false
        })
    }
    
    const updateCheckBoxes = function () {
        clear_selected()
        $.each(DisabledDOW.disabled_dows, function (k, v) {
            
            let id = (typeof v === "number") ? v.toString() : v
            let day = DisabledDOW.days_of_week.get(id)
            
            //console.log("DisabledDOW.days_of_week", DisabledDOW.days_of_week)
            if (day) {
                if (day.for) {
                    document.getElementById(day.for).checked = true
                }
            }
            
        })
        
        if (DisabledDOW.disabled_dows.length === 7) {
            document.getElementById(name_prefix + "dow_select_all").checked = true
        }
    }
    
    const set = function (el, val) {
        let indexId, index
        switch (val) {
            case name_prefix + "dow_select_all":
                
                if (el.checked === true) {
                    DisabledDOW.disabled_dows = [0, 1, 2, 3, 4, 5, 6]
                } else {
                    DisabledDOW.disabled_dows = []
                }
                DisabledDOW.disabled_dows.sort()
                break
            case name_prefix + "dow_select_sun":
                indexId = 0
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                break
            case name_prefix + "dow_select_mon":
                indexId = 1
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                
                break
            case name_prefix + "dow_select_tue":
                indexId = 2
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                //console.log("dow_select_tue", DisabledDOW.disabled_dows)
                break
            case name_prefix + "dow_select_wed":
                indexId = 3
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                //console.log("dow_select_wed", DisabledDOW.disabled_dows)
                break
            case name_prefix + "dow_select_thu":
                indexId = 4
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                //console.log("dow_select_thu", DisabledDOW.disabled_dows)
                break
            case name_prefix + "dow_select_fri":
                indexId = 5
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                break
            case name_prefix + "dow_select_sat":
                indexId = 6
                index = DisabledDOW.disabled_dows.indexOf(indexId)
                if (el.checked === true) {
                    if (!index > -1) {
                        DisabledDOW.disabled_dows.push(indexId)
                    }
                } else {
                    if (index > -1) {
                        DisabledDOW.disabled_dows.splice(index, 1)
                    }
                }
                DisabledDOW.disabled_dows.sort()
                break
            default:
                break
        }
        
        updateCheckBoxes()
    }
    
    const value = function (val) {
        if (val) {
            //console.log("val", val)
        } else {
        
        }
    }
    
    const init = function (disabled_dow) {
        let disabled_days = []
        
        if (disabled_dow) {
            if (disabled_dow === [] || disabled_dow === null || disabled_dow === "") {
                DisabledDOW.disabled_dows = []
                return []
            }
            
            if (typeof disabled_dow === "string") {
                disabled_days = getListOfIds(disabled_dow.replace(/\s/g, ''))
            } else if (typeof disabled_dow === "object") {
                disabled_days = disabled_dow
            } else {
                disabled_days = disabled_dow
            }
            
        }
        
        DisabledDOW.disabled_dows = disabled_days
        updateCheckBoxes()
    }
    
    const DisabledDOW = {
        days_of_week: [],
        disabled_dows: [],
        el: null,
        value: function (val) {
            return value(val)
        },
        els: [],
        init: function (disabled_dow) {
            init(disabled_dow)
        },
    }
    
    buildForm()
    return DisabledDOW
}

const ColorScheme = (function () {
    "use strict"
    const _product_edit_season_id = document.getElementById("product_edit_season_id")
    const _season_id = document.getElementById("season_id")
    const _edit_scheme = document.getElementById("edit_scheme")
    const _form_edit_scheme = document.getElementById("form_edit_scheme")
    const _product_edit_season_id_name_display = document.getElementById("product_edit_season_id_name_display")
    const _button_close_edit_scheme = document.getElementById("button_close_edit_scheme")
    let season_toggle_items
    
    $(_button_close_edit_scheme)
        .on("click", function () {
            $(_edit_scheme).hide()
        })
    
    $(_season_id)
        .on("click", function () {
            $(_edit_scheme).show()
        })
    
    const reset_form = function () {
    
    }
    
    const load_form = function (scheme) {
        if (scheme) {
        
        }
    }
    
    const edit = function (el) {
        $(".color_scheme_block").removeClass("active")
        $(el).addClass("active")
    }
    
    const load_all = function (swatches) {
        ColorScheme.all = new Map()
        if (swatches) {
            $.each(swatches, function (k, swatch) {
                ColorScheme.all.set(parseInt(swatch.id), swatch)
            })
        }
    }
    
    const init = function (settings) {
        if (settings) {
            if (settings.swatches) {
                load_all(settings.swatches)
            }
        }
        
        season_toggle_items = document.querySelectorAll(".season_toggle_item")
        season_toggle_items.forEach(el => el.addEventListener("click", event => {
            let color_scheme_id = parseInt(el.dataset.colorschemeid)
            let scheme = ColorScheme.all.get(color_scheme_id)
            if (scheme) {
                load(scheme)
            }
        }))
    }
    
    const load = function (scheme) {
        if (scheme) {
            let background_color = (scheme.background_color) ? scheme.background_color : null
            let border_color = (scheme.border_color) ? scheme.border_color : null
            let color_scheme_id = parseInt(scheme.id)
            let text_color = (scheme.text_color) ? scheme.text_color : null
            let scheme_name = (scheme.name) ? scheme.name : null
            let elem = document.querySelector("#product_edit_season_id")
            
            $(_product_edit_season_id_name_display).text(`
                    ${scheme_name}
                `)
            
            $("a.dropdown-item.season_toggle_item").removeClass("active")
            $(`a#${color_scheme_id}`).addClass("active")
            elem.style.setProperty("color", text_color, 'important')
            elem.style.setProperty("background-color", background_color, 'important')
            elem.style.setProperty("border-color", border_color, 'important')
        }
    }
    
    const disable = function () {
        let elem = document.querySelector("#product_edit_season_id")
        $(elem).addClass("disabled")
    }
    
    const enable = function () {
        let elem = document.querySelector("#product_edit_season_id")
        $(elem).removeClass("disabled")
    }
    
    const change = function (el) {
        //console.log("ColorScheme:change(el)", el)
    }
    
    return {
        all: new Map(),
        disable: function () {
            disable()
        },
        enable: function () {
            enable()
        },
        load: function (scheme) {
            load(scheme)
        },
        edit: function (el) {
            edit(el)
        },
        change: function (el) {
            change(el)
        },
        init: function (settings) {
            init(settings)
            disable()
        },
    }
})()

$.fn.ColorScheme = function (settings) {
    //console.log("Test", Types.color_scheme)
    
}

const Car = (function () {
    "use strict"
    
    const baseUrl = "/cars"
    const _category_id = document.getElementById("category_id")
    
    let categoryId, userId
    
    const init = function (settings) {
        console.log("Car.init(settings)", settings)
        // ----
        
        //$(document).ready(function () {
        categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
        
        //})
    }
    
    return {
        id: null,
        detail: {
            id: null,
            province_id: null,
            country_id: null,
            created_by: null,
            modified_by: null,
            sort_order: null,
            name: null,
            enabled: null,
            date_created: null,
            date_modified: null,
            note: null,
        },
        all: new Map(),
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const Airport = (function () {
    "use strict"
    
    const _category_id = document.getElementById("category_id")
    
    const _product_edit_location_section = document.getElementById("product_edit_location_section")
    const _modal_product_depart_from_airport_local_code = document.getElementById("modal_product_depart_from_airport_local_code")
    const _modal_product_depart_from_airport_home_link = document.getElementById("modal_product_depart_from_airport_home_link")
    const _modal_product_depart_from_airport_cancel_button = document.getElementById("modal_product_depart_from_airport_cancel_button")
    const _modal_product_depart_from_airport_submit_button = document.getElementById("modal_product_depart_from_airport_submit_button")
    const _modal_product_depart_from_airport_iata_code = document.getElementById("modal_product_depart_from_airport_iata_code")
    const _modal_product_depart_from_airport_country_id = document.getElementById("modal_product_depart_from_airport_country_id")
    const _modal_product_depart_from_airport_province_id = document.getElementById("modal_product_depart_from_airport_province_id")
    const _modal_product_depart_from_airport_city_id = document.getElementById("modal_product_depart_from_airport_city_id")
    const _modal_product_depart_from_airport_city = document.getElementById("modal_product_depart_from_airport_city")
    const _modal_product_depart_from_airport = document.getElementById("modal_product_depart_from_airport")
    const _modal_product_depart_from_airport_id = document.getElementById("modal_product_depart_from_airport_id")
    const _modal_product_depart_from_airport_add_block = document.getElementById("modal_product_depart_from_airport_add_block")
    const _modal_product_depart_from_airport_types_id = document.getElementById("modal_product_depart_from_airport_types_id")
    const _modal_product_depart_from_new_airport_id = document.getElementById("modal_product_depart_from_new_airport_id")
    const _modal_product_arrive_to_airport_cancel_button = document.getElementById("modal_product_arrive_to_airport_cancel_button")
    const _modal_product_arrive_to_new_airport_id = document.getElementById("modal_product_arrive_to_new_airport_id")
    const _modal_product_arrive_to_airport_submit_button = document.getElementById("modal_product_arrive_to_airport_submit_button")
    const _modal_product_arrive_to_airport_iata_code = document.getElementById("modal_product_arrive_to_airport_iata_code")
    const _modal_product_arrive_to_airport_country_id = document.getElementById("modal_product_arrive_to_airport_country_id")
    const _modal_product_arrive_to_airport_province_id = document.getElementById("modal_product_arrive_to_airport_province_id")
    const _modal_product_arrive_to_airport_city_id = document.getElementById("modal_product_arrive_to_airport_city_id")
    const _modal_product_arrive_to_airport_city = document.getElementById("modal_product_arrive_to_airport_city")
    const _modal_product_arrive_to_airport = document.getElementById("modal_product_arrive_to_airport")
    const _modal_product_arrive_to_airport_id = document.getElementById("modal_product_arrive_to_airport_id")
    const _modal_product_arrive_to_airport_add_block = document.getElementById("modal_product_arrive_to_airport_add_block")
    const _modal_product_arrive_to_airport_types_id = document.getElementById("modal_product_arrive_to_airport_types_id")
    const _modal_product_province_id = document.getElementById("modal_product_province_id")
    const _modal_product_country_id = document.getElementById("modal_product_country_id")
    const _modal_product_city_id = document.getElementById("modal_product_city_id")
    const _product_edit_location_city_id = document.getElementById("product_edit_location_city_id")
    const _product_location_departing_airport_form = document.getElementById("product_location_departing_airport_form")
    const _product_location_departing_airport_search = document.getElementById("product_location_departing_airport_search")
    const _product_location_departing_airport_id = document.getElementById("product_location_departing_airport_id")
    const _product_location_departing_airport_airport_types_id = document.getElementById("product_location_departing_airport_airport_types_id")
    const _product_location_departing_airport_city_id = document.getElementById("product_location_departing_airport_city_id")
    const _product_location_departing_airport_name = document.getElementById("product_location_departing_airport_name")
    const _product_location_departing_airport_iata_code = document.getElementById("product_location_departing_airport_iata_code")
    const _product_location_departing_airport_edit_button = document.getElementById("product_location_departing_airport_edit_button")
    const _product_location_departing_airport_home_link = document.getElementById("product_location_departing_airport_home_link")
    const _product_location_departing_airport_wikipedia_link = document.getElementById("product_location_departing_airport_wikipedia_link")
    const _product_location_departing_airport_enabled = document.getElementById("product_location_departing_airport_enabled")
    const _product_location_departing_airport_city_search = document.getElementById("product_location_departing_airport_city_search")
    const _product_location_departing_airport_remove_button = document.getElementById("product_location_departing_airport_remove_button")
    const _product_location_departing_airport_clear_button = document.getElementById("product_location_departing_airport_clear_button")
    const _product_location_departing_airport_save_button = document.getElementById("product_location_departing_airport_save_button")
    const _modal_product_depart_from_airport_add_block_close_button = document.getElementById("modal_product_depart_from_airport_add_block_close_button")
    const _product_location_arriving_airport_edit_button = document.getElementById("product_location_arriving_airport_edit_button")
    const _product_location_arriving_airport_form = document.getElementById("product_location_arriving_airport_form")
    const _product_location_arriving_airport_search = document.getElementById("product_location_arriving_airport_search")
    const _product_location_arriving_airport_id = document.getElementById("product_location_arriving_airport_id")
    const _product_location_arriving_airport_airport_types_id = document.getElementById("product_location_arriving_airport_airport_types_id")
    const _product_location_arriving_airport_city_id = document.getElementById("product_location_arriving_airport_city_id")
    const _product_location_arriving_airport_name = document.getElementById("product_location_arriving_airport_name")
    const _product_location_arriving_airport_iata_code = document.getElementById("product_location_arriving_airport_iata_code")
    const _product_location_arriving_airport_home_link = document.getElementById("product_location_arriving_airport_home_link")
    const _product_location_arriving_airport_wikipedia_link = document.getElementById("product_location_arriving_airport_wikipedia_link")
    const _product_location_arriving_airport_scheduled_service = document.getElementById("product_location_arriving_airport_scheduled_service")
    const _product_location_arriving_airport_keywords = document.getElementById("product_location_arriving_airport_keywords")
    const _product_location_arriving_airport_enabled = document.getElementById("product_location_arriving_airport_enabled")
    const _product_location_arriving_airport_date_created = document.getElementById("product_location_arriving_airport_date_created")
    const _product_location_arriving_airport_created_by = document.getElementById("product_location_arriving_airport_created_by")
    const _product_location_arriving_airport_date_modified = document.getElementById("product_location_arriving_airport_date_modified")
    const _product_location_arriving_airport_modified_by = document.getElementById("product_location_arriving_airport_modified_by")
    const _modal_product_arrive_to_airport_local_code = document.getElementById("modal_product_arrive_to_airport_local_code")
    const _product_location_arriving_airport_city_search = document.getElementById("product_location_arriving_airport_city_search")
    const _product_location_arriving_airport_remove_button = document.getElementById("product_location_arriving_airport_remove_button")
    const _product_location_arriving_airport_clear_button = document.getElementById("product_location_arriving_airport_clear_button")
    const _product_location_arriving_airport_save_button = document.getElementById("product_location_arriving_airport_save_button")
    const _modal_product_depart_from_fields = document.getElementById("modal_product_depart_from_fields")
    const _modal_product_arrive_to_airport_add_block_close_button = document.getElementById("modal_product_arrive_to_airport_add_block_close_button")
    const _modal_product_arrive_to_fields = document.getElementById("modal_product_arrive_to_fields")
    const _modal_product_arrive_to_airport_postal_code = document.getElementById("modal_product_arrive_to_airport_postal_code")
    const _modal_product_arrive_to_airport_street_1 = document.getElementById("modal_product_arrive_to_airport_street_1")
    const _modal_product_arrive_to_airport_street_2 = document.getElementById("modal_product_arrive_to_airport_street_2")
    const _modal_product_depart_from_airport_postal_code = document.getElementById("modal_product_depart_from_airport_postal_code")
    const _modal_product_depart_from_airport_street_1 = document.getElementById("modal_product_depart_from_airport_street_1")
    const _modal_product_depart_from_airport_street_2 = document.getElementById("modal_product_depart_from_airport_street_2")
    const _modal_product_depart_from_airport_edit_link = document.getElementById("modal_product_depart_from_airport_edit_link")
    const _modal_product_arrive_to_airport_edit_link = document.getElementById("modal_product_arrive_to_airport_edit_link")
    const _modal_product_depart_from_airport_gps_code = document.getElementById("modal_product_depart_from_airport_gps_code")
    const _modal_product_depart_from_airport_wikipedia_link = document.getElementById("modal_product_depart_from_airport_wikipedia_link")
    const _modal_product_arrive_to_airport_gps_code = document.getElementById("modal_product_arrive_to_airport_gps_code")
    const _modal_product_arrive_to_airport_home_link = document.getElementById("modal_product_arrive_to_airport_home_link")
    const _modal_product_arrive_to_airport_wikipedia_link = document.getElementById("modal_product_arrive_to_airport_wikipedia_link")
    
    const _modal_product_day_span_airport = document.getElementById("modal_product_day_span_airport")
    const _modal_product_day_span = document.getElementById("modal_product_day_span")
    
    let userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let airportDepartFromRules = {
        groups: {
            locationGroup: "product_location_departing_airport_city_search product_location_departing_airport_city_id",
        },
        rules: {
            product_location_departing_airport_name: {
                required: true,
            },
            product_location_departing_airport_iata_code: {
                required: true,
            },
            product_location_departing_airport_airport_types_id: {
                required: true,
            },
            product_location_departing_airport_city_search: {
                required: true,
            },
            product_location_departing_airport_city_id: {
                required: true,
            },
            product_location_departing_airport_home_link: {
                url: true,
            },
            product_location_departing_airport_wikipedia_link: {
                url: true,
            },
            
        },
        messages: {
            product_location_departing_airport_name: {
                required: "Field Required",
            },
            product_location_departing_airport_iata_code: {
                required: "Field Required",
            },
            product_location_departing_airport_airport_types_id: {
                required: "Field Required",
            },
            product_location_departing_airport_city_search: {
                required: "Field Required",
            },
            product_location_departing_airport_city_id: {
                required: "Field Required",
            },
            product_location_departing_airport_home_link: {
                url: "Field Invalid",
            },
            product_location_departing_airport_wikipedia_link: {
                url: "Field Invalid",
            },
        },
    }
    let airportArriveToRules = {
        groups: {
            locationGroup: "product_location_arriving_airport_city_search product_location_arriving_airport_city_id",
        },
        rules: {
            product_location_arriving_airport_name: {
                required: true,
            },
            product_location_arriving_airport_iata_code: {
                required: true,
            },
            product_location_arriving_airport_airport_types_id: {
                required: true,
            },
            product_location_arriving_airport_city_search: {
                required: true,
            },
            product_location_arriving_airport_city_id: {
                required: true,
            },
            product_location_arriving_airport_home_link: {
                url: true,
            },
            product_location_arriving_airport_wikipedia_link: {
                url: true,
            },
            
        },
        messages: {
            product_location_arriving_airport_name: {
                required: "Field Required",
            },
            product_location_arriving_airport_iata_code: {
                required: "Field Required",
            },
            product_location_arriving_airport_airport_types_id: {
                required: "Field Required",
            },
            product_location_arriving_airport_city_search: {
                required: "Field Required",
            },
            product_location_arriving_airport_city_id: {
                required: "Field Required",
            },
            product_location_arriving_airport_home_link: {
                url: "Field Invalid",
            },
            product_location_arriving_airport_wikipedia_link: {
                url: "Field Invalid",
            },
        },
    }
    let globalSelectedAirportDepartFrom = false
    let globalSelectedAirportArriveTo = false
    let editText = "Edit"
    let cancelText = "Cancel"
    
    $(_modal_product_day_span_airport)
        .on("change", function () {
            //console.log("Airport.modal_product_day_span_airport:change()")
            // ----
            
            let daySpan = $(this).val()
            
            if (daySpan === "" || isNaN(parseInt(daySpan))) {
                daySpan = 1
            } else if (daySpan < 1) {
                daySpan = 1
            }
            _modal_product_day_span_airport.value = daySpan
            _modal_product_day_span.value = daySpan
        })
    
    $(_product_location_departing_airport_edit_button)
        .on("click", function () {
            //console.log("Airport.product_location_departing_airport_edit_button.click()")
            
            _product_location_departing_airport_search.disabled = true
            
            showAirportForm("depart_from")
            hideAirportForm("arrive_to")
        })
    
    $(_product_location_arriving_airport_edit_button)
        .on("click", function () {
            //console.log("Airport.product_location_arriving_airport_edit_button.click()")
            
            _product_location_arriving_airport_search.disabled = true
            
            showAirportForm("arrive_to")
            hideAirportForm("depart_from")
        })
    
    $(_product_location_departing_airport_remove_button)
        .on("click", function () {
            //console.log("ProductLocation.product_location_departing_airport_remove_button.click()")
            let departing_location = Airport.departingAirport
            
            setLocationAirportForm(departing_location, "depart_from")
            hideAirportForm("depart_from")
            clearValidation(_product_location_departing_airport_form)
        })
    
    $(_product_location_arriving_airport_remove_button)
        .on("click", function () {
            //console.log("ProductLocation.product_location_arriving_airport_remove_button.click()")
            let arriving_location = Airport.arrivingAirport
            
            setLocationAirportForm(arriving_location, "arrive_to")
            hideAirportForm("arrive_to")
            clearValidation(_product_location_arriving_airport_form)
        })
    
    $(_product_location_departing_airport_clear_button)
        .on("click", function () {
            //console.log("ProductLocation.product_location_departing_airport_clear_button.click()")
            clearLocationAirportForm("depart_from")
        })
    
    $(_product_location_arriving_airport_clear_button)
        .on("click", function () {
            //console.log("ProductLocation.product_location_arriving_airport_clear_button.click()")
            clearLocationAirportForm("arrive_to")
        })
    
    $(_product_location_departing_airport_save_button)
        .on("click", function () {
            //console.log("ProductLocation.product_location_departing_airport_save_button.click()")
            update("depart_from")
        })
    
    $(_product_location_arriving_airport_save_button)
        .on("click", function () {
            //console.log("ProductLocation.product_location_arriving_airport_save_button.click()")
            update("arrive_to")
        })
    
    $(_modal_product_depart_from_airport_add_block)
        .on("change", function () {
            validDepartFromRecord()
        })
        .on("keyup", function () {
            validDepartFromRecord()
        })
    
    $(_modal_product_depart_from_airport_add_block_close_button)
        .on("click", function () {
            hideAirportForm("depart_from")
            _modal_product_depart_from_airport.disabled = false
            _modal_product_depart_from_airport_edit_link.innerText = editText
        })
    
    $(_modal_product_arrive_to_airport_add_block_close_button)
        .on("click", function () {
            hideAirportForm("arrive_to")
            _modal_product_arrive_to_airport.disabled = false
            _modal_product_arrive_to_airport_edit_link.innerText = editText
        })
    
    $(_modal_product_depart_from_airport_cancel_button)
        .on("click", function () {
            cancelAddAirportRecord("depart_from")
        })
    
    $(_modal_product_arrive_to_airport_cancel_button)
        .on("click", function () {
            cancelAddAirportRecord("arrive_to")
        })
    
    $(_modal_product_depart_from_airport_submit_button)
        .on("click", function () {
            save("depart_from")
        })
    
    $(_modal_product_arrive_to_airport_submit_button)
        .on("click", function () {
            save("arrive_to")
        })
    
    $(_modal_product_depart_from_airport_edit_link)
        .on("click", function () {
            //console.log("Station.modal_product_depart_from_station_edit_link:click()")
            // ----
            
            let toggleData = _modal_product_depart_from_airport_edit_link.innerText
            
            if (toggleData === editText) {
                _modal_product_depart_from_airport_edit_link.innerText = cancelText
                
                _modal_product_depart_from_airport.disabled = true
                _modal_product_arrive_to_airport.disabled = false
                
                _modal_product_arrive_to_airport_edit_link.innerText = editText
                
                showAirportForm("depart_from")
                hideAirportForm("arrive_to")
            } else if (toggleData === cancelText) {
                _modal_product_depart_from_airport_edit_link.innerText = editText
                
                _modal_product_depart_from_airport.disabled = false
                _modal_product_arrive_to_airport.disabled = false
                hideAirportForm("depart_from")
                hideAirportForm("arrive_to")
            } else {
                //_modal_product_arrive_to_airport_edit_link.innerText = editText
                //_modal_product_depart_from_airport_edit_link.innerText = editText
                //hideAirportForm("arrive_to")
                //hideAirportForm("depart_from")
            }
            
        })
    
    $(_modal_product_arrive_to_airport_edit_link)
        .on("click", function () {
            //console.log("Airport.modal_product_arrive_to_airport_edit_link:click()")
            // ----
            
            let toggleData = _modal_product_arrive_to_airport_edit_link.innerText
            
            if (toggleData === editText) {
                _modal_product_arrive_to_airport_edit_link.innerText = cancelText
                _modal_product_depart_from_airport_edit_link.innerText = editText
                _modal_product_arrive_to_airport.disabled = true
                _modal_product_depart_from_airport.disabled = false
                showAirportForm("arrive_to")
                hideAirportForm("depart_from")
            } else if (toggleData === cancelText) {
                _modal_product_arrive_to_airport_edit_link.innerText = editText
                _modal_product_depart_from_airport_edit_link.innerText = editText
                
                _modal_product_arrive_to_airport.disabled = false
                _modal_product_depart_from_airport.disabled = false
                //
                hideAirportForm("arrive_to")
                hideAirportForm("depart_from")
            } else {
                //_modal_product_arrive_to_airport_edit_link.innerText = editText
                //_modal_product_depart_from_airport_edit_link.innerText = editText
                //hideAirportForm("arrive_to")
                //hideAirportForm("depart_from")
            }
            
        })
    
    const toggleEditFormLink = function (type) {
        //console.log("Airport.toggleEditFormLink(type)", type)
        // ----
        let hiddenText = ""
        let editText = "Edit"
        let cancelText = "Cancel"
        
        if (type) {
            /*
            console.log("|__ _modal_product_depart_from_airport_edit_link", _modal_product_depart_from_airport_edit_link)
            console.log("|__ _modal_product_arrive_to_airport_edit_link", _modal_product_arrive_to_airport_edit_link)
            //*/
            
            if (type === "depart_from" && _modal_product_depart_from_airport_edit_link) {
                let toggleStatus = (_modal_product_depart_from_airport_edit_link.dataset.toggle) ? _modal_product_depart_from_airport_edit_link.dataset.toggle : "hidden"
                
                /*
                console.log("|__ toggleStatus", toggleStatus)
                console.log("|__ _modal_product_depart_from_new_airport_id", _modal_product_depart_from_new_airport_id)
                console.log("|__ _modal_product_depart_from_airport", _modal_product_depart_from_airport)
                console.log("|__ _modal_product_depart_from_airport_city_id", _modal_product_depart_from_airport_city_id)
                console.log("|__ _modal_product_depart_from_new_airport_id.value", _modal_product_depart_from_new_airport_id.value)
                console.log("|__ _modal_product_depart_from_new_airport_id.value", _modal_product_depart_from_new_airport_id.value)
                console.log("|__ _modal_product_depart_from_airport_city_id.value", _modal_product_depart_from_airport_city_id.value)
                //*/
                
                if (_modal_product_depart_from_new_airport_id && _modal_product_depart_from_airport && _modal_product_depart_from_airport_city_id
                    && _modal_product_depart_from_new_airport_id.value !== "" && _modal_product_depart_from_airport.value !== ""
                    && _modal_product_depart_from_airport_city_id.value !== "") {
                    // ----------------------------------------------------------------------------------------------------
                    
                    _modal_product_depart_from_airport_edit_link.dataset.toggle = "shown"
                    
                    $(_modal_product_depart_from_airport_edit_link).show()
                } else {
                    _modal_product_depart_from_airport_edit_link.dataset.toggle = "hidden"
                    
                    $(_modal_product_depart_from_airport_edit_link).hide()
                }
                
            }
            
            if (type === "arrive_to" && _modal_product_arrive_to_airport_edit_link) {
                let toggleStatus = (_modal_product_arrive_to_airport_edit_link.dataset.toggle) ? _modal_product_arrive_to_airport_edit_link.dataset.toggle : "hidden"
                
                /*
                console.log("|__ toggleStatus", toggleStatus)
                console.log("|__ _modal_product_arrive_to_new_airport_id", _modal_product_arrive_to_new_airport_id)
                console.log("|__ _modal_product_arrive_to_airport", _modal_product_arrive_to_airport)
                console.log("|__ _modal_product_arrive_to_airport_city_id", _modal_product_arrive_to_airport_city_id)
                console.log("|__ _modal_product_arrive_to_new_airport_id.value", _modal_product_arrive_to_new_airport_id.value)
                console.log("|__ _modal_product_arrive_to_airport.value", _modal_product_arrive_to_airport.value)
                console.log("|__ _modal_product_arrive_to_airport_city_id.value", _modal_product_arrive_to_airport_city_id.value)
                //*/
                
                if (_modal_product_arrive_to_new_airport_id && _modal_product_arrive_to_airport && _modal_product_arrive_to_airport_city_id
                    && _modal_product_arrive_to_new_airport_id.value !== "" && _modal_product_arrive_to_airport.value !== ""
                    && _modal_product_arrive_to_airport_city_id.value !== "") {
                    // ----------------------------------------------------------------------------------------------------
                    
                    _modal_product_arrive_to_airport_edit_link.dataset.toggle = "shown"
                    _modal_product_arrive_to_airport_edit_link.innerText = editText
                    
                    $(_modal_product_arrive_to_airport_edit_link).show()
                    
                } else {
                    _modal_product_arrive_to_airport_edit_link.dataset.toggle = "hidden"
                    
                    $(_modal_product_arrive_to_airport_edit_link).hide()
                    
                }
                
            }
            
        }
        
    }
    const cancelAddAirportRecord = function (type) {
        //console.log("Airport.cancelAddAirportRecord(type)", type)
        // ----
        
        if (_modal_product_depart_from_airport_add_block && _modal_product_arrive_to_airport_add_block) {
            
            if (type) {
                
                if (type === "depart_from") {
                    
                    if (_modal_product_depart_from_new_airport_id.value === "") {
                        _modal_product_depart_from_airport.value = ""
                        clearAirportForm(type)
                    }
                    
                    _modal_product_depart_from_airport_edit_link.innerText = editText
                    
                } else if (type === "arrive_to") {
                    
                    if (_modal_product_arrive_to_new_airport_id.value === "") {
                        _modal_product_arrive_to_airport.value = ""
                        clearAirportForm(type)
                    }
                    
                    _modal_product_arrive_to_airport_edit_link.innerText = editText
                }
                
                _modal_product_depart_from_airport.disabled = false
                _modal_product_arrive_to_airport.disabled = false
                
                hideAirportForm(type)
                toggleEditFormLink(type)
            }
            
        }
        
    }
    const validAirport = function (type) {
        //console.log("Airport.validAirport(type)", type)
        // ----
        
        if (type) {
            if (type === "depart_from") {
                return $(_product_location_departing_airport_form).valid()
            } else if (type === "arrive_to") {
                return $(_product_location_arriving_airport_form).valid()
            }
        }
    }
    const buildAirportUpdateRecord = function (type) {
        //console.log("Airport.buildAirportUpdateRecord(type)", type)
        // ----
        
        let returnObject = {}
        if (type) {
            if (type === "depart_from") {
                let street1 = (_modal_product_depart_from_airport_street_1 && _modal_product_depart_from_airport_street_1.value !== "") ? _modal_product_depart_from_airport_street_1.value : null
                let street2 = (_modal_product_depart_from_airport_street_2 && _modal_product_depart_from_airport_street_2.value !== "") ? _modal_product_depart_from_airport_street_2.value : null
                let postalCode = (_modal_product_depart_from_airport_postal_code && _modal_product_depart_from_airport_postal_code.value !== "") ? _modal_product_depart_from_airport_postal_code.value : null
                
                returnObject.id = (!isNaN(parseInt(_product_location_departing_airport_id.value))) ? parseInt(_product_location_departing_airport_id.value) : null
                returnObject.airport_types_id = (!isNaN(parseInt(_product_location_departing_airport_airport_types_id.value))) ? parseInt(_product_location_departing_airport_airport_types_id.value) : null
                returnObject.city_id = (!isNaN(parseInt(_product_location_departing_airport_city_id.value))) ? parseInt(_product_location_departing_airport_city_id.value) : null
                returnObject.name = (_product_location_departing_airport_name.value === "") ? null : _product_location_departing_airport_name.value
                returnObject.iata_code = (_product_location_departing_airport_iata_code.value === "") ? null : _product_location_departing_airport_iata_code.value
                returnObject.home_link = (_product_location_departing_airport_home_link.value === "") ? null : _product_location_departing_airport_home_link.value
                returnObject.wikipedia_link = (_product_location_departing_airport_wikipedia_link.value === "") ? null : _product_location_departing_airport_wikipedia_link.value
                returnObject.enabled = (_product_location_departing_airport_enabled.checked === true) ? 1 : 0
                returnObject.street_1 = street1
                returnObject.street_2 = street2
                returnObject.postal_code = postalCode
                
            } else if (type === "arrive_to") {
                let street1 = (_modal_product_arrive_to_airport_street_1 && _modal_product_arrive_to_airport_street_1.value !== "") ? _modal_product_arrive_to_airport_street_1.value : null
                let street2 = (_modal_product_arrive_to_airport_street_2 && _modal_product_arrive_to_airport_street_2.value !== "") ? _modal_product_arrive_to_airport_street_2.value : null
                let postalCode = (_modal_product_arrive_to_airport_postal_code && _modal_product_arrive_to_airport_postal_code.value !== "") ? _modal_product_arrive_to_airport_postal_code.value : null
                
                returnObject.id = (!isNaN(parseInt(_product_location_arriving_airport_id.value))) ? parseInt(_product_location_arriving_airport_id.value) : null
                returnObject.airport_types_id = (!isNaN(parseInt(_product_location_arriving_airport_airport_types_id.value))) ? parseInt(_product_location_arriving_airport_airport_types_id.value) : null
                returnObject.city_id = (!isNaN(parseInt(_product_location_arriving_airport_city_id.value))) ? parseInt(_product_location_arriving_airport_city_id.value) : null
                returnObject.name = (_product_location_arriving_airport_name.value === "") ? null : _product_location_arriving_airport_name.value
                returnObject.iata_code = (_product_location_arriving_airport_iata_code.value === "") ? null : _product_location_arriving_airport_iata_code.value
                returnObject.home_link = (_product_location_arriving_airport_home_link.value === "") ? null : _product_location_arriving_airport_home_link.value
                returnObject.wikipedia_link = (_product_location_arriving_airport_wikipedia_link.value === "") ? null : _product_location_arriving_airport_wikipedia_link.value
                returnObject.enabled = (_product_location_arriving_airport_enabled.checked === true) ? 1 : 0
                returnObject.street_1 = street1
                returnObject.street_2 = street2
                returnObject.postal_code = postalCode
            }
        }
        
        return returnObject
    }
    const sendUpdateRequest = function (dataToSend, callback) {
        //console.log("Airport.sendUpdateRequest(dataToSend)", dataToSend)
        // ----
        
        if (dataToSend) {
            let url = "/api/v1.0/airports/update"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    const sendSaveRequest = function (dataToSend, callback) {
        if (dataToSend) {
            let url = "/api/v1.0/airports/update"
            try {
                sendPostRequest(url, dataToSend, function (data) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleAirportError("Oops: 1")
                    }
                })
            } catch (e) {
                
                //console.log("error", e)
            }
        }
    }
    const validDepartFromRecord = function () {
        let isValid = true
        
        if (_modal_product_depart_from_airport_iata_code.value === "") {
            $(_modal_product_depart_from_airport_iata_code).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_depart_from_airport_iata_code).hideError()
        }
        
        if (_modal_product_depart_from_airport_types_id.value === "") {
            $(_modal_product_depart_from_airport_types_id).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_depart_from_airport_types_id).hideError()
        }
        
        if (isNaN(parseInt(_modal_product_depart_from_airport_city_id.value))) {
            $(_modal_product_depart_from_airport_city).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_depart_from_airport_city).hideError()
        }
        
        return isValid
    }
    const validArriveToRecord = function () {
        let isValid = true
        
        if (_modal_product_arrive_to_airport_iata_code.value === "") {
            $(_modal_product_arrive_to_airport_iata_code).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_arrive_to_airport_iata_code).hideError()
        }
        
        if (_modal_product_arrive_to_airport_types_id.value === "") {
            $(_modal_product_arrive_to_airport_types_id).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_arrive_to_airport_types_id).hideError()
        }
        
        if (isNaN(parseInt(_modal_product_arrive_to_airport_city_id.value))) {
            $(_modal_product_arrive_to_airport_city).showError("Field Required")
            isValid = false
        } else {
            $(_modal_product_arrive_to_airport_city).hideError()
        }
        
        return isValid
    }
    const buildAddAirportRecord = function (type) {
        if (_modal_product_depart_from_airport_add_block && _modal_product_arrive_to_airport_add_block) {
            if (type) {
                if (type === "depart_from") {
                    if (validDepartFromRecord()) {
                        let street1 = (_modal_product_depart_from_airport_street_1 && _modal_product_depart_from_airport_street_1.value !== "") ? _modal_product_depart_from_airport_street_1.value : null
                        let street2 = (_modal_product_depart_from_airport_street_2 && _modal_product_depart_from_airport_street_2.value !== "") ? _modal_product_depart_from_airport_street_2.value : null
                        let postalCode = (_modal_product_depart_from_airport_postal_code && _modal_product_depart_from_airport_postal_code.value !== "") ? _modal_product_depart_from_airport_postal_code.value : null
                        
                        let airportKeywords = Airport.departFromKeywords.build()
                        let airportGpsCode = (_modal_product_depart_from_airport_gps_code && _modal_product_depart_from_airport_gps_code.value !== "") ? _modal_product_depart_from_airport_gps_code.value : null
                        let airportHomeLink = (_modal_product_depart_from_airport_home_link && _modal_product_depart_from_airport_home_link.value !== "") ? _modal_product_depart_from_airport_home_link.value : null
                        let airportWikipediaLink = (_modal_product_depart_from_airport_wikipedia_link && _modal_product_depart_from_airport_wikipedia_link.value !== "") ? _modal_product_depart_from_airport_wikipedia_link.value : null
                        let airportLocalCode = (_modal_product_depart_from_airport_local_code && _modal_product_depart_from_airport_local_code.value !== "") ? _modal_product_depart_from_airport_local_code.value : null
                        
                        let dataToSend = {
                            airport_types_id: (!isNaN(parseInt(_modal_product_depart_from_airport_types_id.value))) ? parseInt(_modal_product_depart_from_airport_types_id.value) : null,
                            city_id: (!isNaN(parseInt(_modal_product_depart_from_airport_city_id.value))) ? parseInt(_modal_product_depart_from_airport_city_id.value) : null,
                            name: (_modal_product_depart_from_airport.value !== "") ? _modal_product_depart_from_airport.value : null,
                            street_1: street1,
                            street_2: street2,
                            postal_code: postalCode,
                            local_code: airportLocalCode,
                            wikipedia_link: airportWikipediaLink,
                            gps_code: airportGpsCode,
                            keywords: airportKeywords,
                            home_link: airportHomeLink,
                            iata_code: (_modal_product_depart_from_airport_iata_code.value !== "") ? _modal_product_depart_from_airport_iata_code.value : null,
                        }
                        
                        return removeNulls(dataToSend)
                    }
                } else if (type === "arrive_to") {
                    if (validArriveToRecord()) {
                        let street1 = (_modal_product_arrive_to_airport_street_1 && _modal_product_arrive_to_airport_street_1.value !== "") ? _modal_product_arrive_to_airport_street_1.value : null
                        let street2 = (_modal_product_arrive_to_airport_street_2 && _modal_product_arrive_to_airport_street_2.value !== "") ? _modal_product_arrive_to_airport_street_2.value : null
                        let postalCode = (_modal_product_arrive_to_airport_postal_code && _modal_product_arrive_to_airport_postal_code.value !== "") ? _modal_product_arrive_to_airport_postal_code.value : null
                        
                        let airportKeywords = Airport.arriveToKeywords.build()
                        let airportGpsCode = (_modal_product_arrive_to_airport_gps_code && _modal_product_arrive_to_airport_gps_code.value !== "") ? _modal_product_arrive_to_airport_gps_code.value : null
                        let airportHomeLink = (_modal_product_arrive_to_airport_home_link && _modal_product_arrive_to_airport_home_link.value !== "") ? _modal_product_arrive_to_airport_home_link.value : null
                        let airportWikipediaLink = (_modal_product_arrive_to_airport_wikipedia_link && _modal_product_arrive_to_airport_wikipedia_link.value !== "") ? _modal_product_arrive_to_airport_wikipedia_link.value : null
                        let airportLocalCode = (_modal_product_arrive_to_airport_local_code && _modal_product_arrive_to_airport_local_code.value !== "") ? _modal_product_arrive_to_airport_local_code.value : null
                        
                        let dataToSend = {
                            airport_types_id: (!isNaN(parseInt(_modal_product_arrive_to_airport_types_id.value))) ? parseInt(_modal_product_arrive_to_airport_types_id.value) : null,
                            city_id: (!isNaN(parseInt(_modal_product_arrive_to_airport_city_id.value))) ? parseInt(_modal_product_arrive_to_airport_city_id.value) : null,
                            name: (_modal_product_arrive_to_airport.value !== "") ? _modal_product_arrive_to_airport.value : null,
                            street_1: street1,
                            street_2: street2,
                            postal_code: postalCode,
                            local_code: airportLocalCode,
                            wikipedia_link: airportWikipediaLink,
                            gps_code: airportGpsCode,
                            keywords: airportKeywords,
                            home_link: airportHomeLink,
                            iata_code: (_modal_product_arrive_to_airport_iata_code.value !== "") ? _modal_product_arrive_to_airport_iata_code.value : null,
                        }
                        
                        return removeNulls(dataToSend)
                    }
                }
            }
        }
    }
    const populateAirportForm = function (airport, type) {
        //console.log("Airport.populateAirportForm(airport, type)", airport, type)
        // ----
        
        if (!type || !_modal_product_depart_from_airport_add_block || !_modal_product_arrive_to_airport_add_block) {
            return
        }
        
        clearAirportForm(type)
        
        let displayType = "display_" + defaultLocationDisplayFormat
        let airportName = (airport && airport.name) ? airport.name : null
        let airportId = (airport && !isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
        let airportTypesId = (airport && !isNaN(parseInt(airport.airport_types_id))) ? parseInt(airport.airport_types_id) : ""
        let countryId = (airport && airport.country && !isNaN(parseInt(airport.country.id))) ? parseInt(airport.country.id) : null
        let provinceId = (airport && airport.province && !isNaN(parseInt(airport.province.id))) ? parseInt(airport.province.id) : null
        let cityId = (airport && airport.city && !isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
        let cityName = (airport && airport.city && airport.city.name) ? airport.city.name : null
        let provinceName = (airport && airport.province) ? airport.province.name : null
        let countryName = (airport && airport.country) ? airport.country.name : null
        let airportIATA = (airport && airport.iata_code) ? airport.iata_code : null
        let airportGPSCode = (airport && airport.gps_code) ? airport.gps_code : null
        let airportHomeLink = (airport && airport.home_link) ? airport.home_link : null
        let airportWikiLink = (airport && airport.wikipedia_link) ? airport.wikipedia_link : null
        let airportStreet1 = (airport && airport.street_1) ? airport.street_1 : null
        let airportStreet2 = (airport && airport.street_2) ? airport.street_2 : null
        let airportPostalCode = (airport && airport.postal_code) ? airport.postal_code : null
        let airportKeywords = (airport && airport.keywords) ? airport.keywords : []
        let cityDisplay = ""
        
        if (cityName !== null && provinceName !== null && countryName !== null) {
            cityDisplay = `${cityName} (${provinceName}, ${countryName})`
        }
        
        if (type === "depart_from") {
            _modal_product_depart_from_new_airport_id.value = airportId
            _modal_product_depart_from_airport.value = airportName
            _modal_product_depart_from_airport_types_id.value = airportTypesId
            _modal_product_depart_from_airport_gps_code.value = airportGPSCode
            _modal_product_depart_from_airport_home_link.value = airportHomeLink
            _modal_product_depart_from_airport_wikipedia_link.value = airportWikiLink
            _modal_product_depart_from_airport_iata_code.value = airportIATA
            _modal_product_depart_from_airport_city.value = cityDisplay
            _modal_product_depart_from_airport_country_id.value = countryId
            _modal_product_depart_from_airport_province_id.value = provinceId
            _modal_product_depart_from_airport_city_id.value = cityId
            _modal_product_depart_from_airport_postal_code.value = airportPostalCode
            _modal_product_depart_from_airport_street_1.value = airportStreet1
            _modal_product_depart_from_airport_street_2.value = airportStreet2
            
            _modal_product_country_id.value = countryId
            _modal_product_province_id.value = provinceId
            _modal_product_city_id.value = cityId
            
            Airport.departFromKeywords.set(airportKeywords)
            
        } else if (type === "arrive_to") {
            _modal_product_arrive_to_new_airport_id.value = airportId
            _modal_product_arrive_to_airport.value = airportName
            _modal_product_arrive_to_airport_types_id.value = airportTypesId
            _modal_product_arrive_to_airport_gps_code.value = airportGPSCode
            _modal_product_arrive_to_airport_home_link.value = airportHomeLink
            _modal_product_arrive_to_airport_wikipedia_link.value = airportWikiLink
            _modal_product_arrive_to_airport_iata_code.value = airportIATA
            _modal_product_arrive_to_airport_city.value = cityDisplay
            _modal_product_arrive_to_airport_country_id.value = countryId
            _modal_product_arrive_to_airport_province_id.value = provinceId
            _modal_product_arrive_to_airport_city_id.value = cityId
            _modal_product_arrive_to_airport_postal_code.value = airportPostalCode
            _modal_product_arrive_to_airport_street_1.value = airportStreet1
            _modal_product_arrive_to_airport_street_2.value = airportStreet2
            
            Airport.arriveToKeywords.set(airportKeywords)
            
        }
        
    }
    const clearAirportForm = function (type) {
        //console.log("Airport.clearAirportForm(type)", type)
        // ----
        
        if (_modal_product_depart_from_airport_add_block && _modal_product_arrive_to_airport_add_block) {
            if (type) {
                
                if (type === "depart_from") {
                    _modal_product_depart_from_airport_iata_code.value = ""
                    _modal_product_depart_from_airport_city.value = ""
                    _modal_product_depart_from_airport_city_id.value = ""
                    _modal_product_depart_from_airport_country_id.value = ""
                    _modal_product_depart_from_airport_province_id.value = ""
                    _modal_product_depart_from_airport_city_id.value = ""
                    _modal_product_depart_from_airport_types_id.value = ""
                    _modal_product_depart_from_airport_postal_code.value = ""
                    _modal_product_depart_from_airport_street_1.value = ""
                    _modal_product_depart_from_airport_street_2.value = ""
                    _modal_product_depart_from_airport_edit_link.dataset.airportId = ""
                    
                    if (Airport.departFromKeywords) {
                        Airport.departFromKeywords.clear()
                    }
                    
                    _modal_product_depart_from_airport.disabled = false
                } else if (type === "arrive_to") {
                    _modal_product_arrive_to_airport_iata_code.value = ""
                    _modal_product_arrive_to_airport_city.value = ""
                    _modal_product_arrive_to_airport_city_id.value = ""
                    _modal_product_arrive_to_airport_country_id.value = ""
                    _modal_product_arrive_to_airport_province_id.value = ""
                    _modal_product_arrive_to_airport_city_id.value = ""
                    _modal_product_arrive_to_airport_types_id.value = ""
                    _modal_product_arrive_to_airport_postal_code.value = ""
                    _modal_product_arrive_to_airport_street_1.value = ""
                    _modal_product_arrive_to_airport_street_2.value = ""
                    _modal_product_arrive_to_airport_edit_link.dataset.airportId = ""
                    
                    if (Airport.arriveToKeywords) {
                        Airport.arriveToKeywords.clear()
                    }
                    
                    _modal_product_arrive_to_airport.disabled = false
                }
                
                clearAllValidation()
                toggleEditFormLink(type)
                
            }
        }
        
    }
    const resetAirportForm = function (type) {
        //console.log("Airport.resetAirportForm(type)", type)
        // ----
        
        if (_modal_product_depart_from_airport_add_block && _modal_product_arrive_to_airport_add_block) {
            if (type) {
                _modal_product_arrive_to_airport.disabled = false
                _modal_product_depart_from_airport.disabled = false
                
                clearAirportForm(type)
                
                hideAirportForm("depart_from")
                hideAirportForm("arrive_to")
            }
            
            toggleEditFormLink(type)
        }
    }
    const hideAirportForm = function (type) {
        //console.log("Airport.hideAirportForm(type)", type)
        // ----
        
        if (_modal_product_depart_from_airport_add_block && _modal_product_arrive_to_airport_add_block) {
            if (type) {
                if (type === "depart_from") {
                    $(_modal_product_depart_from_airport_add_block).hide()
                    //_modal_product_depart_from_airport_edit_link.innerText = editText
                } else if (type === "arrive_to") {
                    //_modal_product_arrive_to_airport_edit_link.innerText = editText
                    $(_modal_product_arrive_to_airport_add_block).hide()
                }
            }
        }
        
        if (_product_edit_location_section) {
            if (type) {
                if (type === "depart_from") {
                    if (_product_location_departing_airport_form) {
                        $(_product_location_departing_airport_form).hide()
                        _product_location_departing_airport_search.disabled = false
                    }
                }
                
                if (type === "arrive_to") {
                    if (_product_location_arriving_airport_form) {
                        $(_product_location_arriving_airport_form).hide()
                        _product_location_arriving_airport_search.disabled = false
                    }
                }
            }
        }
    }
    const showAirportForm = function (type) {
        //console.log("Airport.showAirportForm(type)", type)
        // ----
        
        if (_modal_product_depart_from_airport_add_block && _modal_product_arrive_to_airport_add_block) {
            if (type) {
                if (type === "depart_from") {
                    _modal_product_depart_from_airport.disabled = true
                    //_modal_product_depart_from_airport_edit_link.innerText = editText
                    _modal_product_arrive_to_airport.disabled = false
                    $(_modal_product_depart_from_airport_add_block).show()
                    $(_modal_product_arrive_to_airport_add_block).hide()
                } else if (type === "arrive_to") {
                    _modal_product_arrive_to_airport.disabled = true
                    //_modal_product_arrive_to_airport_edit_link.innerText = editText
                    _modal_product_depart_from_airport.disabled = false
                    $(_modal_product_arrive_to_airport_add_block).show()
                    $(_modal_product_depart_from_airport_add_block).hide()
                }
            }
        }
        
        if (_product_edit_location_section) {
            if (type) {
                if (type === "depart_from") {
                    if (_product_location_departing_airport_form) {
                        
                        $(_product_location_departing_airport_form).show()
                        
                        _product_location_departing_airport_search.disabled = true
                        
                    }
                }
                
                if (type === "arrive_to") {
                    if (_product_location_arriving_airport_form) {
                        
                        $(_product_location_arriving_airport_form).show()
                        
                        _product_location_arriving_airport_search.disabled = true
                        
                    }
                }
                
            }
        }
        
    }
    const clearLocationAirportForm = function (type) {
        //console.log("Airport.clearLocationAirportForm(type)", type)
        // ----
        
        if (type) {
            
            if (type === "depart_from") {
                _product_location_departing_airport_airport_types_id.value = ""
                _product_location_departing_airport_name.value = ""
                _product_location_departing_airport_city_id.value = ""
                _product_location_departing_airport_search.value = ""
                _product_location_departing_airport_id.value = ""
                _product_location_departing_airport_home_link.value = ""
                _product_location_departing_airport_wikipedia_link.value = ""
                _product_location_departing_airport_city_search.value = ""
                _product_location_departing_airport_enabled.checked = true
                _product_location_departing_airport_iata_code.value = ""
                _product_location_departing_airport_remove_button.disabled = true
                _product_location_departing_airport_save_button.disabled = true
                _product_location_departing_airport_clear_button.disabled = true
                _product_edit_location_city_id.value = ""
            }
            
            if (type === "arrive_to") {
                _product_location_arriving_airport_airport_types_id.value = ""
                _product_location_arriving_airport_name.value = ""
                _product_location_arriving_airport_city_id.value = ""
                _product_location_arriving_airport_search.value = ""
                _product_location_arriving_airport_id.value = ""
                _product_location_arriving_airport_home_link.value = ""
                _product_location_arriving_airport_wikipedia_link.value = ""
                _product_location_arriving_airport_city_search.value = ""
                _product_location_arriving_airport_enabled.checked = true
                _product_location_arriving_airport_iata_code.value = ""
                _product_location_arriving_airport_remove_button.disabled = true
                _product_location_arriving_airport_save_button.disabled = true
                _product_location_arriving_airport_clear_button.disabled = true
            }
            
        }
        
    }
    const setLocationAirportForm = function (airport, type) {
        //console.log("Airport.setLocationAirportForm(type)", type)
        // ----
        
        if (type) {
            clearLocationAirportForm(type)
            
            if (airport) {
                if (airport.city) {
                    let displayShort = `${airport.city.name} (${airport.province.name}, ${airport.country.name})`
                    let displayMedium = `${airport.city.name} (${airport.province.name}, ${airport.country.name})`
                    let displayLong = `${airport.city.name} (${airport.province.name}, ${airport.country.name})`
                    let searchDisplayText = ""
                    
                    if (airport.name && airport.iata_code) {
                        searchDisplayText = `${airport.iata_code} - ${airport.name}`
                    } else if (airport.name && !airport.iata_code) {
                        searchDisplayText = `${airport.name}`
                    } else if (!airport.name && airport.iata_code) {
                        searchDisplayText = `${airport.iata_code}`
                    } else {
                        searchDisplayText = `Airport Name`
                    }
                    
                    if (type === "depart_from") {
                        let cityId = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
                        _product_location_departing_airport_airport_types_id.value = (airport.airport_types_id) ? airport.airport_types_id : ""
                        _product_location_departing_airport_name.value = (airport.name) ? airport.name : null
                        _product_location_departing_airport_city_id.value = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
                        _product_location_departing_airport_search.value = searchDisplayText
                        _product_location_departing_airport_id.value = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
                        _product_location_departing_airport_home_link.value = (airport.home_link) ? airport.home_link : null
                        _product_location_departing_airport_wikipedia_link.value = (airport.wikipedia_link) ? airport.wikipedia_link : null
                        _product_location_departing_airport_enabled.checked = (airport.enabled && airport.enabled === 1)
                        _product_location_departing_airport_iata_code.value = (airport.iata_code) ? airport.iata_code : null
                        
                        _product_location_departing_airport_remove_button.disabled = false
                        _product_location_departing_airport_save_button.disabled = false
                        _product_location_departing_airport_clear_button.disabled = false
                        
                        _product_edit_location_city_id.value = cityId
                        
                        if (defaultAddressView === "medium") {
                            _product_location_departing_airport_city_search.value = displayMedium
                        }
                        
                        if (defaultAddressView === "long") {
                            _product_location_departing_airport_city_search.value = displayLong
                        }
                        
                        if (defaultAddressView === "short") {
                            _product_location_departing_airport_city_search.value = displayShort
                        }
                    }
                    
                    if (type === "arrive_to") {
                        _product_location_arriving_airport_airport_types_id.value = (airport.airport_types_id) ? airport.airport_types_id : ""
                        _product_location_arriving_airport_name.value = (airport.name) ? airport.name : null
                        _product_location_arriving_airport_city_id.value = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
                        _product_location_arriving_airport_search.value = searchDisplayText
                        _product_location_arriving_airport_id.value = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
                        _product_location_arriving_airport_home_link.value = (airport.home_link) ? airport.home_link : null
                        _product_location_arriving_airport_wikipedia_link.value = (airport.wikipedia_link) ? airport.wikipedia_link : null
                        _product_location_arriving_airport_enabled.checked = (airport.enabled && airport.enabled === 1)
                        _product_location_arriving_airport_iata_code.value = (airport.iata_code) ? airport.iata_code : null
                        
                        _product_location_arriving_airport_remove_button.disabled = false
                        _product_location_arriving_airport_save_button.disabled = false
                        _product_location_arriving_airport_clear_button.disabled = false
                        
                        if (defaultAddressView === "medium") {
                            _product_location_arriving_airport_city_search.value = displayMedium
                        }
                        
                        if (defaultAddressView === "long") {
                            _product_location_arriving_airport_city_search.value = displayLong
                        }
                        
                        if (defaultAddressView === "short") {
                            _product_location_arriving_airport_city_search.value = displayShort
                        }
                        
                    }
                }
            }
        }
        
    }
    const airportExists = function (name, type) {
        //console.log("Airport.airportExists(name, type)", name, type)
        // ----
        
        if (name && name !== "") {
            /**
             * data to send to the server
             *
             * @type {{name}}
             */
            let dataToSend = {
                name: name,
            }
            
            fetchByName(dataToSend, function (data) {
                let airport = null
                
                if (data) {
                    airport = data
                    if (data[0]) {
                        airport = data[0]
                    }
                }
                
                if (airport && airport.id) {
                    if (type === "depart_from") {
                        let airportId = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
                        let airportTypesId = (!isNaN(parseInt(airport.airport_types_id))) ? parseInt(airport.airport_types_id) : null
                        let countryId = (!isNaN(parseInt(airport.country.id))) ? parseInt(airport.country.id) : null
                        let provinceId = (!isNaN(parseInt(airport.province.id))) ? parseInt(airport.province.id) : null
                        let cityId = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
                        
                        globalSelectedAirportDepartFrom = true
                        
                        _modal_product_depart_from_airport_edit_link.dataset.airportId = airportId.toString()
                        _modal_product_country_id.value = countryId
                        _modal_product_province_id.value = provinceId
                        _modal_product_city_id.value = cityId
                        
                        populateAirportForm(airport, type)
                        
                        _modal_product_depart_from_airport_id.value = airportId
                        toggleEditFormLink(type)
                        
                    } else if (type === "arrive_to") {
                        let airportId = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
                        let airportTypesId = (!isNaN(parseInt(airport.airport_types_id))) ? parseInt(airport.airport_types_id) : null
                        
                        globalSelectedAirportArriveTo = true
                        
                        _modal_product_arrive_to_airport_edit_link.dataset.airportId = airportId.toString()
                        _modal_product_arrive_to_airport_id.value = airportId
                        
                        populateAirportForm(airport, type)
                        toggleEditFormLink(type)
                        
                    }
                    
                } else {
                    confirmDialog(`The airport: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                        if (ans) {
                            
                            if (type === "depart_from") {
                                globalSelectedAirportDepartFrom = false
                                _modal_product_depart_from_airport.disabled = true
                                _modal_product_arrive_to_airport.disabled = false
                            } else if (type === "arrive_to") {
                                globalSelectedAirportArriveTo = false
                                _modal_product_depart_from_airport.disabled = false
                                _modal_product_arrive_to_airport.disabled = true
                            }
                            
                            populateAirportForm({
                                name: name,
                            }, type)
                            showAirportForm(type)
                            toggleEditFormLink(type)
                            
                        } else {
                            if (type === "depart_from") {
                                
                                if (_modal_product_country_id) {
                                    _modal_product_country_id.value = ""
                                }
                                
                                if (_modal_product_province_id) {
                                    _modal_product_province_id.value = ""
                                }
                                
                                if (_modal_product_city_id) {
                                    _modal_product_city_id.value = ""
                                }
                                
                                if (_modal_product_depart_from_airport_id) {
                                    _modal_product_depart_from_airport_id.value = ""
                                }
                                
                                if (_modal_product_depart_from_airport) {
                                    _modal_product_depart_from_airport.value = ""
                                }
                                
                                toggleEditFormLink(type)
                            } else {
                                
                                if (_modal_product_arrive_to_airport_id) {
                                    _modal_product_arrive_to_airport_id.value = ""
                                }
                                
                                if (_modal_product_arrive_to_airport) {
                                    _modal_product_arrive_to_airport.value = ""
                                }
                                
                                toggleEditFormLink("arrive_to")
                            }
                            
                        }
                    })
                    
                }
                toggleEditFormLink(type)
            })
            
        }
        
    }
    const fetchByName = function (dataToSend, callback) {
        let url = "/api/v1.0/airports/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleAirportError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleAirportError("Error Validating Airport")
            }
        } else {
            handleAirportError("Error Loading Airport - Missing Data")
        }
    }
    const handleAirportError = function (msg, title, type) {
        //console.log("Airport.handleAirportError()")
        // ----
        
        if (!msg) {
            msg = "There was an error."
        }
        
        if (!title) {
            title = "Category"
        }
        
        if (!type) {
            type = "error"
        }
        
        toastr[type](msg, title)
        
    }
    const update = function (type) {
        //console.log("Airport.update(type)", type)
        if (validAirport(type)) {
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    sendUpdateRequest(buildAirportUpdateRecord(type), function (data) {
                        let airport
                        if (data) {
                            airport = data
                            if (data[0]) {
                                airport = data[0]
                            }
                            //console.log("airport", airport)
                            let name = (airport.name) ? airport.name : null
                            toastr["success"](`Airport ${name} has been updated`, "Airport Updated")
                        }
                    })
                }
            })
        }
    }
    const save = function (type) {
        if (type) {
            let dataToSend = buildAddAirportRecord(type)
            
            if (dataToSend) {
                confirmDialog(`Would you like to update?`, (ans) => {
                    if (ans) {
                        
                        sendSaveRequest(dataToSend, function (data) {
                            //console.log("|__ data", data)
                            let airport
                            if (data) {
                                airport = data
                                if (data[0]) {
                                    airport = data[0]
                                }
                            }
                            
                            if (airport) {
                                //console.log("|__ airport", airport)
                                
                                if (type === "depart_from") {
                                    if (_modal_product_depart_from_airport) {
                                        _modal_product_depart_from_airport.value = (airport.name) ? airport.name : ""
                                    }
                                    
                                    if (_modal_product_depart_from_new_airport_id) {
                                        _modal_product_depart_from_new_airport_id.value = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : ""
                                    }
                                    
                                    if (_modal_product_depart_from_airport_id) {
                                        _modal_product_depart_from_airport_id.value = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : ""
                                    }
                                    
                                    if (_modal_product_country_id) {
                                        _modal_product_country_id.value = (!isNaN(parseInt(airport.country.id))) ? parseInt(airport.country.id) : ""
                                    }
                                    
                                    if (_modal_product_province_id) {
                                        _modal_product_province_id.value = (!isNaN(parseInt(airport.province.id))) ? parseInt(airport.province.id) : ""
                                    }
                                    
                                    if (_modal_product_city_id) {
                                        _modal_product_city_id.value = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : ""
                                    }
                                    
                                }
                                
                                if (type === "arrive_to") {
                                    
                                    if (_modal_product_arrive_to_airport) {
                                        _modal_product_arrive_to_airport.value = (airport.name) ? airport.name : ""
                                    }
                                    
                                    if (_modal_product_arrive_to_new_airport_id) {
                                        _modal_product_arrive_to_new_airport_id.value = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : ""
                                    }
                                    
                                    if (_modal_product_arrive_to_airport_id) {
                                        _modal_product_arrive_to_airport_id.value = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : ""
                                    }
                                }
                                
                                populateAirportForm(airport, type)
                                initAutocomplete()
                                hideAirportForm(type)
                                toggleEditFormLink(type)
                                handleAirportError(`${airport.name} was created`, "Airport", "success")
                            }
                        })
                    }
                })
            }
        }
    }
    const defaultDetail = function () {
        return {
            display_short: null,
            display_medium: null,
            display_long: null,
            id: null,
            airport_types_id: null,
            city_id: null,
            name: null,
            street_1: null,
            street_2: null,
            postal_code: null,
            iata_code: null,
            gps_code: null,
            local_code: null,
            home_link: null,
            wikipedia_link: null,
            scheduled_service: 1,
            keywords: [],
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: userId,
            date_modified: formatDateMySQL(),
            modified_by: userId,
            note: null,
            city: {},
            province: {},
            country: {},
            type: {},
        }
    }
    const setDetail = function (airport) {
        //console.log("Airport.setDetail()", airport)
        // ----
        let detail = defaultDetail()
        
        if (airport) {
            
            detail["id"] = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
            detail["airport_types_id"] = (!isNaN(parseInt(airport.airport_types_id))) ? parseInt(airport.airport_types_id) : null
            detail["city_id"] = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
            detail["name"] = (airport.name) ? airport.name : null
            detail["street_1"] = (airport.street_1) ? airport.street_1 : null
            detail["street_2"] = (airport.street_2) ? airport.street_2 : null
            detail["postal_code"] = (airport.postal_code) ? airport.postal_code : null
            detail["iata_code"] = (airport.iata_code) ? airport.iata_code : null
            detail["gps_code"] = (airport.gps_code) ? airport.gps_code : null
            detail["local_code"] = (airport.local_code) ? airport.local_code : null
            detail["home_link"] = (airport.home_link) ? airport.home_link : null
            detail["wikipedia_link"] = (airport.wikipedia_link) ? airport.wikipedia_link : null
            detail["scheduled_service"] = 1
            detail["keywords"] = (airport.keywords) ? airport.keywords : []
            detail["enabled"] = (!isNaN(parseInt(airport.enabled))) ? parseInt(airport.enabled) : 1
            detail["date_created"] = (airport.date_created) ? airport.date_created : formatDateMySQL()
            detail["created_by"] = (!isNaN(parseInt(airport.created_by))) ? parseInt(airport.created_by) : userId
            detail["date_modified"] = (airport.date_modified) ? airport.date_modified : formatDateMySQL()
            detail["modified_by"] = (!isNaN(parseInt(airport.modified_by))) ? parseInt(airport.modified_by) : userId
            detail["note"] = (airport.note) ? airport.note : null
            detail["display_long"] = (airport.display_long) ? airport.display_long : null
            detail["display_medium"] = (airport.display_medium) ? airport.display_medium : null
            detail["display_short"] = (airport.display_short) ? airport.display_short : null
            detail["city"] = (airport.city) ? airport.city : {}
            detail["country"] = (airport.country) ? airport.country : {}
            detail["province"] = (airport.province) ? airport.province : {}
            detail["type"] = (airport.type) ? airport.type : {}
        }
        
        Airport.detail = detail
        return detail
    }
    const loadAll = function (airports) {
        //console.log("Airport.loadAll()")
        // ----
        
        Airport.all = new Map()
        
        if (airports) {
            $.each(airports, function (k, airport) {
                let detail = setDetail(airport)
                Airport.all.set(detail.id, detail)
            })
        }
    }
    const initAutocomplete = function () {
        //console.log("Airport.initAutocomplete()")
        // ----
        
        if (_product_location_departing_airport_search) {
            
            $(_product_location_departing_airport_search)
                .on("click", function () {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("search", function () {
                    if (_product_location_departing_airport_id) {
                        _product_location_departing_airport_id.value = ""
                    }
                    
                    if (_product_location_departing_airport_search) {
                        _product_location_departing_airport_search.value = ""
                    }
                    
                    clearLocationAirportForm("depart_from")
                    
                })
                .on("keyup", function () {
                    globalSelectedAirportDepartFrom = false
                })
                .on("change", function () {
                    setTimeout(function () {
                        let airport_name = _product_location_departing_airport_search.value
                        
                        if (globalSelectedAirportDepartFrom === false) {
                            if (airport_name === "") {
                                _product_location_departing_airport_search.value = ""
                                _product_location_departing_airport_id.value = ""
                                globalSelectedAirportDepartFrom = false
                            } else {
                                airportExists(airport_name, "depart_from")
                            }
                        }
                    }, 200)
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/airports",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        
                        globalSelectedAirportDepartFrom = true
                        
                        let airport = suggestion.data
                        
                        if (airport) {
                            setLocationAirportForm(airport, "depart_from")
                            if (_product_location_departing_airport_id) {
                                _product_location_departing_airport_id.value = airport.id
                            }
                            
                            if (_product_location_departing_airport_city_id) {
                                _product_location_departing_airport_city_id.value = airport.city.id
                                _product_edit_location_city_id.value = airport.city.id
                            }
                            
                            if (_product_location_departing_airport_search) {
                                _product_location_departing_airport_search.value = suggestion.value
                            }
                        }
                    },
                })
        }
        if (_product_location_arriving_airport_search) {
            
            $(_product_location_arriving_airport_search)
                .on("click", function () {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("search", function () {
                    if (_product_location_departing_airport_id) {
                        _product_location_departing_airport_id.value = ""
                    }
                    if (_product_location_departing_airport_search) {
                        _product_location_departing_airport_search.value = ""
                    }
                    clearLocationAirportForm("arrive_to")
                })
                .on("keyup", function () {
                    globalSelectedAirportDepartFrom = false
                })
                .on("change", function () {
                
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/airports",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        
                        globalSelectedAirportDepartFrom = true
                        
                        let airport = suggestion.data
                        
                        if (airport) {
                            setLocationAirportForm(airport, "arrive_to")
                            if (_product_location_arriving_airport_id) {
                                _product_location_arriving_airport_id.value = airport.id
                            }
                            
                            if (_product_location_arriving_airport_city_id) {
                                _product_location_arriving_airport_city_id.value = airport.city.id
                            }
                            
                            if (_product_location_arriving_airport_search) {
                                _product_location_arriving_airport_search.value = suggestion.value
                            }
                        }
                    },
                })
        }
        
        // Modal New Product
        if (_modal_product_depart_from_airport) {
            
            $(_modal_product_depart_from_airport)
                .on("click", function (e) {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("search", function () {
                    if (_modal_product_depart_from_airport_id) {
                        _modal_product_depart_from_airport_id.value = ""
                    }
                    
                    if (_modal_product_depart_from_airport) {
                        _modal_product_depart_from_airport.value = ""
                    }
                    
                    if (_modal_product_country_id) {
                        _modal_product_country_id.value = ""
                    }
                    
                    if (_modal_product_province_id) {
                        _modal_product_province_id.value = ""
                    }
                    
                    if (_modal_product_city_id) {
                        _modal_product_city_id.value = ""
                    }
                    
                    toggleEditFormLink("depart_from")
                    
                })
                .on("keyup", function () {
                    globalSelectedAirportDepartFrom = false
                })
                .on("change", function () {
                    setTimeout(function () {
                        let airport_name = _modal_product_depart_from_airport.value
                        
                        if (globalSelectedAirportDepartFrom === false) {
                            if (airport_name === "") {
                                _modal_product_depart_from_airport.value = ""
                                _modal_product_depart_from_airport_id.value = ""
                                if (_modal_product_country_id) {
                                    _modal_product_country_id.value = ""
                                }
                                
                                if (_modal_product_province_id) {
                                    _modal_product_province_id.value = ""
                                }
                                
                                if (_modal_product_city_id) {
                                    _modal_product_city_id.value = ""
                                }
                                globalSelectedAirportDepartFrom = false
                                toggleEditFormLink("depart_from")
                            } else {
                                airportExists(airport_name, "depart_from")
                            }
                        }
                        
                    }, 200)
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/airports",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        let airport = suggestion.data
                        let type = "depart_from"
                        
                        if (airport) {
                            console.log("|__ airport", airport)
                            
                            let airportId = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
                            globalSelectedAirportDepartFrom = true
                            
                            let airportTypesId = (!isNaN(parseInt(airport.airport_types_id))) ? parseInt(airport.airport_types_id) : null
                            let countryId = (!isNaN(parseInt(airport.country.id))) ? parseInt(airport.country.id) : null
                            let provinceId = (!isNaN(parseInt(airport.province.id))) ? parseInt(airport.province.id) : null
                            let cityId = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
                            
                            populateAirportForm(airport, type)
                            
                            _modal_product_depart_from_airport_id.value = airportId
                            _modal_product_depart_from_airport_edit_link.dataset.airportId = airportId.toString()
                            
                            _modal_product_country_id.value = countryId
                            _modal_product_province_id.value = provinceId
                            _modal_product_city_id.value = cityId
                        } else {
                            resetAirportForm(type)
                            showAirportForm(type)
                            
                        }
                        
                        toggleEditFormLink(type)
                    },
                })
        }
        if (_modal_product_arrive_to_airport) {
            
            $(_modal_product_arrive_to_airport)
                .on("click", function () {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .on("keyup", function () {
                    globalSelectedAirportArriveTo = false
                })
                .on("search", function () {
                    if (_modal_product_arrive_to_airport_id) {
                        _modal_product_arrive_to_airport_id.value = ""
                    }
                    if (_modal_product_arrive_to_airport) {
                        _modal_product_arrive_to_airport.value = ""
                    }
                    
                    toggleEditFormLink("arrive_to")
                })
                .on("change", function () {
                    setTimeout(function () {
                        let airport_name = _modal_product_arrive_to_airport.value
                        
                        if (globalSelectedAirportArriveTo === false) {
                            if (airport_name === "") {
                                _modal_product_arrive_to_airport.value = ""
                                _modal_product_arrive_to_airport_id.value = ""
                                globalSelectedAirportArriveTo = false
                                toggleEditFormLink("arrive_to")
                            } else {
                                airportExists(airport_name, "arrive_to")
                            }
                        }
                        
                    }, 200)
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/airports",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        
                        let airport = suggestion.data
                        let type = "arrive_to"
                        
                        if (airport) {
                            console.log("|__ airport", airport)
                            
                            let airportId = (!isNaN(parseInt(airport.id))) ? parseInt(airport.id) : null
                            globalSelectedAirportArriveTo = true
                            
                            populateAirportForm(airport, type)
                            
                            let airportTypesId = (!isNaN(parseInt(airport.airport_types_id))) ? parseInt(airport.airport_types_id) : null
                            let countryId = (!isNaN(parseInt(airport.country.id))) ? parseInt(airport.country.id) : null
                            let provinceId = (!isNaN(parseInt(airport.province.id))) ? parseInt(airport.province.id) : null
                            let cityId = (!isNaN(parseInt(airport.city.id))) ? parseInt(airport.city.id) : null
                            
                            _modal_product_arrive_to_airport_id.value = airportId
                            _modal_product_arrive_to_airport_edit_link.dataset.airportId = airportId.toString()
                            
                            toggleEditFormLink(type)
                            
                        } else {
                            resetAirportForm(type)
                            showAirportForm(type)
                        }
                        
                        toggleEditFormLink(type)
                    },
                })
        }
        
    }
    const init = function (settings) {
        //console.log("Airport.init()")
        // ----
        let airports = (settings && settings.airports) ? settings.airports : []
        
        loadAll(airports)
        
        if (_modal_product_depart_from_airport || _modal_product_arrive_to_airport) {
            initAutocomplete()
            resetAirportForm("depart_from")
            resetAirportForm("arrive_to")
        }
        
        if (settings) {
            let categoryId = (_category_id && !isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
            
            if (_product_edit_location_section) {
                if (categoryId === 2) {
                    initAutocomplete()
                    clearLocationAirportForm("depart_from")
                    clearLocationAirportForm("arrive_to")
                    
                    if (settings.product) {
                        let product = settings.product
                        if (product.arriving_location) {
                            Airport.arrivingAirport = product.arriving_location
                            let arriving_location = product.arriving_location
                            setLocationAirportForm(arriving_location, "arrive_to")
                        } else {
                            Airport.arrivingAirport = null
                        }
                        
                        if (product.departing_location) {
                            let departing_location = product.departing_location
                            Airport.departingAirport = product.departing_location
                            setLocationAirportForm(departing_location, "depart_from")
                        } else {
                            Airport.departingAirport = null
                        }
                    }
                    
                    initializeValidator(airportDepartFromRules)
                    Airport.airportDepartValidator = $(_product_location_departing_airport_form).validate()
                    
                    initializeValidator(airportArriveToRules)
                    Airport.airportArriveValidator = $(_product_location_arriving_airport_form).validate()
                }
            }
        }
        
        hideAirportForm("depart_from")
        hideAirportForm("arrive_to")
        //})
    }
    
    return {
        arriveToKeywords: null,
        departFromKeywords: null,
        airportDepartValidator: null,
        airportArriveValidator: null,
        arrivingAirport: null,
        departingAirport: null,
        resetAirportForm: function (type) {
            resetAirportForm(type)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const AirportTypes = (function () {
    "use strict"
    
    const base_url = "/airport_types"
    const _input_airport_types_id = document.getElementById("input_airport_types_id")
    const _input_airport_types_name = document.getElementById("input_airport_types_name")
    const _input_airport_types_sort_order = document.getElementById("input_airport_types_sort_order")
    const _input_airport_types_enabled = document.getElementById("input_airport_types_enabled")
    const _input_airport_types_date_created = document.getElementById("input_airport_types_date_created")
    const _input_airport_types_created_by = document.getElementById("input_airport_types_created_by")
    const _input_airport_types_date_modified = document.getElementById("input_airport_types_date_modified")
    const _input_airport_types_modified_by = document.getElementById("input_airport_types_modified_by")
    const _input_airport_types_note = document.getElementById("input_airport_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_airport_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(" -- AirportTypes -- ", {})
    }
    
    const set = function (airport_types) {
        let detail = _default_detail()
        if (airport_types) {
            detail.id = (airport_types.id) ? airport_types.id : null
            detail.name = (airport_types.name) ? airport_types.name : null
            detail.sort_order = (airport_types.sort_order) ? airport_types.sort_order : null
            detail.enabled = (airport_types.enabled) ? airport_types.enabled : 1
            detail.date_created = (airport_types.date_created) ? airport_types.date_created : formatDateMySQL()
            detail.created_by = (airport_types.created_by) ? airport_types.created_by : created_by
            detail.date_modified = (airport_types.date_modified) ? airport_types.date_modified : formatDateMySQL()
            detail.modified_by = (airport_types.modified_by) ? airport_types.modified_by : modified_by
            detail.note = (airport_types.note) ? airport_types.note : null
        }
        
        AirportTypes.detail = detail
        return detail
    }
    
    const load_all = function (airport_types) {
        AirportTypes.all = new Map()
        
        if (!airport_types) {
            return
        }
        $.each(airport_types, function (i, airport_types) {
            let detail = set(airport_types)
            AirportTypes.all.set("id", detail)
        })
        
        //console.log(" AirportTypes.all", AirportTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

//AirportTypes.init()
//end object

const Category = (function () {
    "use strict"
    
    const _modal_product_category_id = document.getElementById("modal_product_category_id")
    const _modal_product_city = document.getElementById("modal_product_city")
    const _modal_product_name = document.getElementById("modal_product_name")
    const _modal_product_sku = document.getElementById("modal_product_sku")
    const _modal_product_rating_types_id = document.getElementById("modal_product_rating_types_id")
    const _modal_product_currency_id = document.getElementById("modal_product_currency_id")
    const _modal_product_pricing_strategies_types_id = document.getElementById("modal_product_pricing_strategies_types_id")
    const _modal_product_vendor_name = document.getElementById("modal_product_vendor_name")
    const _modal_product_provider_id = document.getElementById("modal_product_provider_id")
    const _modal_product_vendor_id = document.getElementById("modal_product_vendor_id")
    const _modal_product_provider_company_id = document.getElementById("modal_product_provider_company_id")
    const _modal_product_provider_location_id = document.getElementById("modal_product_provider_location_id")
    const _modal_product_location_id = document.getElementById("modal_product_location_id")
    const _modal_product_vendor_company_id = document.getElementById("modal_product_vendor_company_id")
    const _modal_product_country_cars = document.getElementById("modal_product_country_cars")
    const _modal_product_city_id = document.getElementById("modal_product_city_id")
    const _modal_product_country_id = document.getElementById("modal_product_country_id")
    const _modal_product_province_id = document.getElementById("modal_product_province_id")
    const _modal_product_description_short = document.getElementById("modal_product_description_short")
    const _modal_product_description_long = document.getElementById("modal_product_description_long")
    const _modal_product_keywords = document.getElementById("modal_product_keywords")
    const _modal_product_day_span = document.getElementById("modal_product_day_span")
    const _modal_product_provider_name = document.getElementById("modal_product_provider_name")
    const _modal_button_submit_add_product = document.getElementById("modal_button_submit_add_product")
    const _modal_product_provider_vendor_match = document.getElementById("modal_product_provider_vendor_match")
    const _modal_product_id = document.getElementById("modal_product_id")
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    $(_modal_product_category_id)
        .on("change", function () {
            handleProductChange($(this).val())
        })
    
    const handleCategoryError = function (msg, title, type) {
        if (!msg) {
            msg = "There was an error."
        }
        
        if (!title) {
            title = "Category"
        }
        
        if (!type) {
            type = "error"
        }
        
        toastr[type](msg, title)
    }
    
    const handleProductChange = function (id) {
        //console.log("Category.handleProductChange(id)", id)
        // ----
        
        $("[data-categoryid]").hide()
        
        let categoryId = (!isNaN(parseInt(id))) ? parseInt(id) : null
        let category = Types.category.get(parseInt(categoryId))
        let attributeId = (category && category.attribute_id) ? category.attribute_id : null
        
        if (!categoryId) {
            return
        }
        
        //Product.resetNewProductDetails()
        // Product.enableNewFormDetails()
        
        Product.attr1 = (attributeId) ? attributeId : null
        Product.attr2 = null
        Product.attr3 = null
        Product.updateProductSKU()
        
        let productName, productSKU,
            providerName, vendorName = ""
        
        if (categoryId && !isNaN(categoryId)) {
            Product.clearModalForm()
            
            _modal_product_category_id.value = categoryId
            
            Product.initAutoComplete(categoryId)
            
            $(`[data-categoryid='${categoryId}']`).show()
            
            switch (categoryId) {
                case 1:
                    /**
                     * Hotels
                     */
                    _modal_product_pricing_strategies_types_id.value = ""
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = false
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = false
                    
                    break
                case 2:
                    /**
                     * Flight
                     */
                    _modal_product_pricing_strategies_types_id.value = 2
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = true
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = true
                    _modal_product_sku.disabled = true
                    
                    Airport.departFromKeywords = $("#modal_product_depart_from_keywords_airport").BuildKeyword([])
                    Airport.arriveToKeywords = $("#modal_product_arrive_to_keywords_airport").BuildKeyword([])
                    
                    break
                case 3:
                    /**
                     * Cars
                     */
                    _modal_product_pricing_strategies_types_id.value = 3
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = true
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = true
                    _modal_product_sku.disabled = true
                    
                    Country.initAutocomplete()
                    
                    break
                case 4:
                    /**
                     * Rail
                     */
                    _modal_product_pricing_strategies_types_id.value = 2
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = true
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = true
                    _modal_product_sku.disabled = true
                    
                    Station.departFromKeywords = $("#modal_product_depart_from_keywords_station").BuildKeyword([])
                    Station.arriveToKeywords = $("#modal_product_arrive_to_keywords_station").BuildKeyword([])
                    
                    break
                case 5:
                    /**
                     * Transport
                     */
                    _modal_product_pricing_strategies_types_id.value = ""
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = false
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = false
                    _modal_product_sku.disabled = true
                    
                    break
                case 6:
                    /**
                     * Tours
                     */
                    _modal_product_pricing_strategies_types_id.value = "2"
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = true
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = false
                    _modal_product_sku.disabled = true
                    
                    break
                case 7:
                    /**
                     * Cruises
                     */
                    _modal_product_pricing_strategies_types_id.value = ""
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = false
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = false
                    _modal_product_sku.disabled = true
                    _modal_product_id.disabled = true
                    break
                case 8:
                    /**
                     * Packages
                     */
                    _modal_product_pricing_strategies_types_id.value = ""
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = true
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = true
                    _modal_product_sku.disabled = true
                    
                    break
                case 9:
                    /**
                     * Other
                     */
                    _modal_product_pricing_strategies_types_id.value = ""
                    _modal_product_rating_types_id.value = ""
                    
                    _modal_product_city.disabled = false
                    _modal_product_rating_types_id.disabled = false
                    _modal_product_name.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = false
                    _modal_product_sku.disabled = true
                    
                    break
                default:
                    /**
                     * default
                     */
                    _modal_product_rating_types_id.value = ""
                    _modal_product_pricing_strategies_types_id.value = ""
                    
                    _modal_product_rating_types_id.disabled = true
                    _modal_product_name.disabled = true
                    _modal_product_currency_id.disabled = true
                    _modal_product_pricing_strategies_types_id.disabled = true
                    _modal_product_sku.disabled = true
                    _modal_product_city.disabled = true
                    break
            }
            
        } else {
            Product.disableNewFormDetails()
        }
        
    }
    
    const defaultDetail = function () {
        return {
            category_id: 1,
            name: null,
            last_update: null,
            id: null,
            pricing_strategy_types_id: null,
            color_scheme_id: null,
            icon: null,
            view_product_index: 1,
            view_product_index_filter: 1,
            view_product_index_search: 1,
            view_product_edit: 1,
            view_product_package_edit: 1,
            view_product_package_index: 1,
            all_day: 1,
            overlap: 1,
            editable: 1,
            duration_editable: 1,
            start_editable: 1,
            display: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const set = function (category) {
        //console.log("Category.set()", category)
        let detail = defaultDetail()
        if (category) {
            detail.id = (category.id) ? category.id : null
            detail.name = (category.name) ? category.name : null
            detail.last_update = (category.last_update) ? category.last_update : null
            detail.id = (category.id) ? category.id : null
            detail.pricing_strategy_types_id = (category.pricing_strategy_types_id) ? category.pricing_strategy_types_id : null
            detail.color_scheme_id = (category.color_scheme_id) ? category.color_scheme_id : null
            detail.name = (category.name) ? category.name : null
            detail.icon = (category.icon) ? category.icon : null
            detail.view_product_index = (category.view_product_index) ? category.view_product_index : 1
            detail.view_product_index_filter = (category.view_product_index_filter) ? category.view_product_index_filter : 1
            detail.view_product_index_search = (category.view_product_index_search) ? category.view_product_index_search : 1
            detail.view_product_edit = (category.view_product_edit) ? category.view_product_edit : 1
            detail.view_product_package_edit = (category.view_product_package_edit) ? category.view_product_package_edit : 1
            detail.view_product_package_index = (category.view_product_package_index) ? category.view_product_package_index : 1
            detail.all_day = (category.all_day) ? category.all_day : 1
            detail.overlap = (category.overlap) ? category.overlap : 1
            detail.editable = (category.editable) ? category.editable : 1
            detail.duration_editable = (category.duration_editable) ? category.duration_editable : 1
            detail.start_editable = (category.start_editable) ? category.start_editable : 1
            detail.display = (category.display) ? category.display : null
            detail.sort_order = (category.sort_order) ? category.sort_order : null
            detail.enabled = (category.enabled) ? category.enabled : 1
            detail.date_created = (category.date_created) ? category.date_created : formatDateMySQL()
            detail.created_by = (category.created_by) ? category.created_by : created_by
            detail.date_modified = (category.date_modified) ? category.date_modified : formatDateMySQL()
            detail.modified_by = (category.modified_by) ? category.modified_by : modified_by
            detail.note = (category.note) ? category.note : null
            detail.seasons = (category.seasons) ? category.seasons : []
        }
        
        Category.detail = detail
        return detail
    }
    
    const save = function (params) {
    
    }
    
    const get = function () {
        let data_to_send = {}
        
    }
    
    const init = function (settings) {
        console.log("Category.init()", settings)
        // ----
        
        let categories = []
        
        if (settings) {
            if (settings.categories) {
                categories = settings.categories
            }
        }
        
        loadAll(categories)
    }
    
    const initProductModal = function (settings) {
        console.log("Category.initProductModal()", settings)
        // ----
        
    }
    
    const loadAll = function (categories) {
        console.log("Category.loadAll(categories)", categories)
        // ----
        
        Category.all = new Map()
        
        if (!categories) {
            return
        }
        
        $.each(categories, function (i, category) {
            let detail = set(category)
            Category.all.set(detail.id, detail)
        })
        
        //console.log(" Category.all", Category.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            loadAll(params)
        },
        save: function (params) {
            save(params)
        },
        init: function (settings) {
            init(settings)
        },
        initProductModal: function (settings) {
            initProductModal(settings)
        },
    }
    
})()

const ContactTypes = (function () {
    "use strict"
    
    const base_url = "/contact_types"
    const _input_contact_types_id = document.getElementById("input_contact_types_id")
    const _input_contact_types_name = document.getElementById("input_contact_types_name")
    const _input_contact_types_sort_order = document.getElementById("input_contact_types_sort_order")
    const _input_contact_types_enabled = document.getElementById("input_contact_types_enabled")
    const _input_contact_types_date_created = document.getElementById("input_contact_types_date_created")
    const _input_contact_types_created_by = document.getElementById("input_contact_types_created_by")
    const _input_contact_types_date_modified = document.getElementById("input_contact_types_date_modified")
    const _input_contact_types_modified_by = document.getElementById("input_contact_types_modified_by")
    const _input_contact_types_note = document.getElementById("input_contact_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_contact_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(" -- ContactTypes -- ", {})
    }
    
    const set = function (contact_types) {
        let detail = _default_detail()
        if (contact_types) {
            detail.id = (contact_types.id) ? contact_types.id : null
            detail.name = (contact_types.name) ? contact_types.name : null
            detail.sort_order = (contact_types.sort_order) ? contact_types.sort_order : null
            detail.enabled = (contact_types.enabled) ? contact_types.enabled : 1
            detail.date_created = (contact_types.date_created) ? contact_types.date_created : formatDateMySQL()
            detail.created_by = (contact_types.created_by) ? contact_types.created_by : created_by
            detail.date_modified = (contact_types.date_modified) ? contact_types.date_modified : formatDateMySQL()
            detail.modified_by = (contact_types.modified_by) ? contact_types.modified_by : modified_by
            detail.note = (contact_types.note) ? contact_types.note : null
        }
        
        ContactTypes.detail = detail
        return detail
    }
    
    const load_all = function (contact_types) {
        ContactTypes.all = new Map()
        
        if (!contact_types) {
            return
        }
        $.each(contact_types, function (i, contact_types) {
            let detail = set(contact_types)
            ContactTypes.all.set("id", detail)
        })
        
        //console.log(" ContactTypes.all", ContactTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

//ContactTypes.init()
//end object

const Company = (function () {
    "use strict"
    
    const _product_edit_page = document.getElementById("product_edit_page")
    const _button_save_provider = document.getElementById("button_save_provider")
    const _form_edit_company = document.getElementById("form_edit_company")
    const _company_enabled = document.getElementById("company_enabled")
    const _company_name = document.getElementById("company_name")
    const _company_phone_1 = document.getElementById("company_phone_1")
    const _company_phone_2 = document.getElementById("company_phone_2")
    const _company_fax = document.getElementById("company_fax")
    const _company_email = document.getElementById("company_email")
    const _company_website = document.getElementById("company_website")
    const _button_submit_form_edit_company = document.getElementById("button_submit_form_edit_company")
    const _company_cover_image = document.getElementById("company_cover_image")
    const _address_company_id = document.getElementById("address_company_id")
    const _company_id = document.getElementById("company_id")
    const _contact_company_id = document.getElementById("contact_company_id")
    const _form_edit_company_block = document.getElementById("form_edit_company_block")
    const _button_edit_company_name = document.getElementById("button_edit_company_name")
    const _button_cancel_edit_company_name = document.getElementById("button_cancel_edit_company_name")
    const _button_close_edit_company_form = document.getElementById("button_close_edit_company_form")
    const _form_edit_vendor = document.getElementById("form_edit_vendor")
    const _form_edit_provider = document.getElementById("form_edit_provider")
    const _vendor_name = document.getElementById("vendor_name")
    const _vendor_company_id = document.getElementsByClassName("vendor_company_id")
    const _provider_name = document.getElementById("provider_name")
    const _provider_company_id = document.getElementById("provider_company_id")
    const _company_key = document.getElementById("company_keywords")
    const _company_logo = document.getElementById("company_logo")
    const _company_description_long = document.getElementById("company_description_long")
    const _company_description_short = document.getElementById("company_description_short")
    const _button_clear_form_edit_company = document.getElementById("button_clear_form_edit_company")
    const _company_images = document.getElementById("company_images")
    const _modal_product_category_id = document.getElementById("modal_product_category_id")
    const form_rules = {
        rules: {
            company_name: {
                required: true,
            },
            company_phone_1: {},
            company_phone_2: {},
            company_fax: {},
            company_email: {
                email: true,
            },
            company_website: {
                url: true,
            },
        },
        messages: {
            company_name: {
                required: "Field Required1",
            },
            company_email: {
                email: "Field Invalid",
            },
            company_website: {
                url: "Field Invalid",
            },
        },
        
    }
    
    let reset_company = {}
    let $company_key
    let temp_company = {}
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let validator
    let globalSelectedCompany = false
    let tempCompany = {}
    
    $("a[data-toggle=\"tab\"]").on("hide.bs.tab", function (e) {
        //e.target // newly activated tab
        //e.relatedTarget // previous active tab
        hide_form()
    })
    
    $(_button_cancel_edit_company_name)
        .on("click", function () {
            let detail = setDetail(tempCompany)
            populate_form(detail)
            hide_form()
        })
    
    $(_button_edit_company_name)
        .on("click", function () {
            tempCompany = build()
            show_form()
        })
    
    $(_button_clear_form_edit_company)
        .on("click", function () {
            resetForm()
        })
    
    $(_button_close_edit_company_form)
        .on("click", function () {
            hide_form()
        })
    
    $(_button_submit_form_edit_company)
        .on("click", function () {
            let company = Company.build()
            if (company) {
                confirmDialog(`Would you like to update?`, (ans) => {
                    if (ans) {
                        addCompany(company, function (data) {
                            if (data) {
                                if (data[0]) {
                                    let company = data[0]
                                    let detail = setDetail(company)
                                    reset_company = detail
                                    populate_form(detail)
                                    initAutoComplete()
                                    hide_form()
                                }
                            }
                        })
                    }
                })
            }
        })
    
    $(_company_id)
        .on("change", function () {
            _address_company_id.value = _company_id.value
        })
    
    $(_form_edit_company)
        .on("change", function () {
            set_progress()
        })
    
    const initAutoComplete = function () {
        $(_company_name)
            .on("change", function () {
                setTimeout(function () {
                    let company_name = _company_name.value
                    
                    if (globalSelectedCompany === false) {
                        if (company_name === "") {
                            _company_name.value = ""
                            _company_id.value = ""
                            globalSelectedCompany = false
                        } else {
                            company_exists(company_name)
                        }
                    }
                }, 200)
            })
            .on("search", function () {
                /*
                temp_company = Company.detail
                window.addEventListener("click", on_click_outside)
                hide_form()
                //*/
                Company.resetForm(true)
                if (_form_edit_provider) {
                    Provider.resetForm()
                }
                if (_form_edit_vendor) {
                    Vendor.resetForm()
                }
                
            })
            .on("click", function (e) {
                if ($(this).attr("readonly") === "readonly") {
                    e.preventDefault()
                } else {
                    $(this).select()
                }
                
            })
            .autocomplete({
                serviceUrl: "/api/v1.0/autocomplete/companies",
                minChars: 2,
                cache: false,
                dataType: "json",
                triggerSelectOnValidInput: false,
                paramName: "st",
                onSelect: function (suggestion) {
                    if (!suggestion.data) {
                        return
                    }
                    
                    /**
                     * created_by: 4
                     * date_created: "2021-11-08 08:48:45"
                     * date_modified: "2021-11-08 08:48:45"
                     * email: "testcompany@email.com"
                     * enabled: 1
                     * fax: "+39-055-646465465"
                     * id: 1
                     * modified_by: 4
                     * name: "Test Company 1"
                     * note: null
                     * phone_1: "1112223333"
                     * phone_2: "+39-055-646465465"
                     * status_id: 10
                     * website: "https://www.google.com"
                     */
                    let company = suggestion.data
                    globalSelectedCompany = true
                    populate_form(company)
                    if (_provider_name) {
                        $(_provider_name).val(company.name).trigger("change")
                    } else {
                        $(_vendor_name).val(company.name)
                    }
                    
                    if (_provider_company_id) {
                        $(_provider_company_id).val(company.id)
                    }
                    
                    Address.get_by_company_id(company.id)
                    Contact.getByCompanyId(company.id)
                    
                    /*
                    let provider = suggestion.data
                    let company = (provider.company) ? provider.company : {}
                    let addresses = (provider.addresses) ? provider.addresses : {}
                    let contacts = (provider.contacts) ? provider.contacts : {}
                    let location = (provider.location) ? provider.location : {}
                    let vendor = (provider.vendor) ? provider.vendor : {}
                    let provider_id = provider.id
                    let company_name = provider.company.name
                    let provider_company_id = provider.company.id
                 
                    if (_form_edit_provider) {
                        $(_provider_company_id).val(provider_company_id)
                        $(_provider_id).val(provider_id)
                        confirmDialog("This provider exists. Would you like to edit it?", (ans) => {
                            if (ans) {
                                window.location.replace("/providers/" + provider_id)
                                populate_form(provider)
                                Company.populate_form(company)
                                Location.populate_form(location)
                                $(_vendor_company_id).val(provider_company_id)
                                $(_vendor_name).val(company_name).trigger("change")
                            } else {
                                Provider.resetForm()
                                Vendor.resetForm()
                            }
                        })
                    }
      
                    //*/
                },
            })
    }
    
    const defaultDetail = function () {
        return {
            created_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            email: null,
            cover_image: "/public/img/placeholder.jpg",
            enabled: 1,
            fax: null,
            id: null,
            modified_by: user_id,
            name: null,
            note: null,
            phone_1: null,
            phone_2: null,
            status_id: 10,
            website: null,
            description_short: null,
            description_long: null,
            keywords: null,
            logo: null,
            images: [],
        }
    }
    
    const handleCompanyError = function (msg, title, level) {
        //console.log("Company.handleCompanyError(msg)")
        // ----
        
        if (!msg) {
            msg = "There was an Error"
        }
        
        if (!title) {
            title = "Company"
        }
        
        if (!level) {
            level = "error"
        }
        
        toastr[level](`${msg}`, title)
    }
    
    const populate_form = function (company) {
        //console.log("Company.populate_form(company)", company)
        // ----
        
        let company_logo_image = $("#company_logo").dropify()
        let company_keywords = (company.keywords) ? company.keywords : ""
        
        $(_company_id).val((company.id) ? company.id : "").trigger("change")
        _company_name.value = (company.name) ? company.name : ""
        _company_phone_1.value = (company.phone_1) ? company.phone_1 : ""
        _company_phone_2.value = (company.phone_2) ? company.phone_2 : ""
        _company_fax.value = (company.fax) ? company.fax : ""
        _company_email.value = (company.email) ? company.email : ""
        _company_website.value = (company.website) ? company.website : ""
        _company_description_long.value = (company.description_long) ? company.description_long : ""
        _company_description_short.value = (company.description_short) ? company.description_short : ""
        
        $company_key = $(_company_key).BuildKeyword(company_keywords)
        if (_provider_name) {
            $(_provider_name).val((company.name) ? company.name : "").trigger("change")
        }
        
        if (_vendor_name) {
            _vendor_name.value = (company.name) ? company.name : null
        }
        
        if (_provider_company_id) {
            _provider_company_id.value = (company.id) ? company.id : null
        }
        
        if (_vendor_company_id) {
            _vendor_company_id.value = (company.id) ? company.id : null
        }
        
        if (_contact_company_id) {
            _contact_company_id.value = (company.id) ? company.id : null
        }
        
        if (_address_company_id) {
            _address_company_id.value = (company.id) ? company.id : null
        }
        
    }
    
    const on_click_outside = (e) => {
        let tar = $(e.target).parents("div.form_element")
        if (!tar[0] && !e.target.className.includes("company_name")) {
            if (_company_name.value === "") {
                populate_form(temp_company)
            }
            
            temp_company = {}
            destroy_click()
        }
    }
    
    const destroy_click = function () {
        window.removeEventListener("click", on_click_outside)
    }
    
    const build = function () {
        return remove_nulls({
            email: $(_company_email).val(),
            enabled: 1,
            fax: $(_company_fax).val(),
            id: (!isNaN(_company_id.value)) ? parseInt(_company_id.value) : null,
            modified_by: user_id,
            cover_image: "/public/img/placeholder.jpg",
            description_short: _company_description_short.value,
            description_long: _company_description_long.value,
            keywords: $company_key.build(),
            name: $(_company_name).val(),
            note: null,
            phone_1: $(_company_phone_1).val(),
            phone_2: $(_company_phone_2).val(),
            status_id: 10,
            website: $(_company_website).val(),
        })
    }
    
    const company_exists = function (name) {
        if (name && name !== "") {
            /**
             * data to send to the server
             *
             * @type {{name}}
             */
            let dataToSend = {
                name: name,
            }
            fetch_company_by_name(dataToSend, function (data) {
                
                let company = null
                
                if (data && data[0]) {
                    if (data[0]) {
                        company = data[0]
                    }
                }
                
                if (company) {
                    resetForm(true)
                    populate_form(company)
                    Address.get_by_company_id(company.id)
                    Contact.getByCompanyId(company.id)
                } else {
                    confirmDialog(`The company: ${name} does not exist exists. Would you like to create it?`, (ans) => {
                        if (ans) {
                            addCompany({
                                name: _company_name.value,
                                status_id: 10,
                                enabled: 1,
                            }, function (data) {
                                if (data) {
                                    if (data[0]) {
                                        company = data[0]
                                        tempCompany = company
                                        resetForm(true)
                                        populate_form(company)
                                        show_form()
                                    }
                                }
                            })
                        }
                    })
                }
                
            })
        }
    }
    
    const fetch_company_by_name = function (dataToSend, callback) {
        let url = "/api/v1.0/companies/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleCompanyError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleCompanyError("Error Validating Company")
            }
        } else {
            handleCompanyError("Error Loading Company- Missing Data")
        }
    }
    
    const fetchCompanyByName = function (dataToSend, callback) {
        let url = "/api/v1.0/companies/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleCompanyError("Oops: 1")
                    }
                })
            } catch (e) {
                return handleCompanyError("Error Validating Company")
            }
        } else {
            return handleCompanyError("Error Loading Company- Missing Data")
        }
    }
    
    const init = function (company) {
        //console.log("Company.init(company)", company)
        // ----
        
        let images = []
        
        if (company) {
            let detail = setDetail(company)
            images = (company.images) ? company.images : []
            
            if (_company_images) {
                Company.fileManager = $("#company_images").fileManager({
                    height: 400,
                    source: "company",
                    sourceId: detail.id,
                    images: images,
                })
            }
            if (_form_edit_company) {
                populate_form(detail)
                validator_init(form_rules)
                validator = $(_form_edit_company).validate()
                initAutoComplete()
                if (_form_edit_company_block) {
                    hide_form()
                }
            }
        }
        
    }
    
    const validate_form = function () {
        return $(_form_edit_company).valid()
    }
    
    const resetForm = function (toggleFullClear) {
        _company_phone_1.value = ""
        _company_phone_2.value = ""
        _company_fax.value = ""
        _company_email.value = ""
        _company_website.value = ""
        if (toggleFullClear && toggleFullClear === true) {
            if (_provider_name) {
                $(_provider_name).val("").trigger("change")
            }
            if (_vendor_name) {
                $(_vendor_name).val("").trigger("change")
            }
            $(_company_id).val("").trigger("change")
            _company_name.value = ""
            Address.clearTable()
            Contact.clearTable()
        }
    }
    
    const setDetail = function (company) {
        let detail = defaultDetail()
        
        if (company) {
            detail.created_by = (company.created_by) ? company.created_by : user_id
            detail.date_created = (company.date_created) ? company.date_created : formatDateMySQL()
            detail.date_modified = (company.date_modified) ? company.date_modified : formatDateMySQL()
            detail.email = (company.email) ? company.email : null
            detail.cover_image = (company.cover_image) ? company.cover_image : null
            detail.enabled = (company.enabled) ? company.enabled : 1
            detail.fax = (company.fax) ? company.fax : null
            detail.id = (company.id) ? company.id : null
            detail.modified_by = (company.modified_by) ? company.modified_by : user_id
            detail.name = (company.name) ? company.name : null
            detail.note = (company.note) ? company.note : null
            detail.phone_1 = (company.phone_1) ? company.phone_1 : null
            detail.phone_2 = (company.phone_2) ? company.phone_2 : null
            detail.status_id = (company.status_id) ? company.status_id : 10
            detail.website = (company.website) ? company.website : null
            detail.logo = (company.logo) ? company.logo : ""
            detail.keywords = (company.keywords) ? company.keywords : ""
            detail.description_long = (company.description_long) ? company.description_long : ""
            detail.description_short = (company.description_short) ? company.description_short : ""
            detail.images = (company.images) ? company.images : []
        }
        
        Company.detail = detail
        return detail
    }
    
    const show_form = function () {
        reset_company = Company.build()
        
        if (_form_edit_company_block) {
            $(_form_edit_company_block).show()
            $(_button_cancel_edit_company_name).show()
            $(_button_edit_company_name).hide()
            $(_company_name).attr("readonly", true)
        }
        
        if (_button_save_provider) {
            $(_button_save_provider).attr("readonly", true)
            _button_save_provider.disabled = true
        }
    }
    
    const hide_form = function () {
        if (_form_edit_company_block) {
            let detail = setDetail(reset_company)
            //populate_form(detail)
            $(_company_name).attr("readonly", false)
            $(_form_edit_company_block).hide()
            $(_button_cancel_edit_company_name).hide()
            $(_button_edit_company_name).show()
            initAutoComplete()
        }
        
        if (_button_save_provider) {
            $(_button_save_provider).attr("readonly", false)
            _button_save_provider.disabled = false
        }
        
    }
    
    const set_progress = function () {
        if (!isNaN(parseInt(_company_id.value))) {
            $(_company_phone_1).attr("readonly", false)
            $(_company_phone_2).attr("readonly", false)
            $(_company_fax).attr("readonly", false)
            $(_company_email).attr("readonly", false)
            $(_company_cover_image).attr("readonly", false)
            _button_edit_company_name.disabled = false
        } else {
            _button_edit_company_name.disabled = true
            $(_company_cover_image).attr("readonly", true)
            $(_company_phone_1).attr("readonly", true)
            $(_company_phone_2).attr("readonly", true)
            $(_company_fax).attr("readonly", true)
            $(_company_email).attr("readonly", true)
        }
    }
    
    const addCompany = function (dataToSend, callback) {
        //console.log("addCompany()")
        // ----
        
        let url = "/api/v1.0/companies/update"
        if (dataToSend) {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                } else {
                    handleCompanyError("Oops: 1")
                }
            })
        }
    }
    
    return {
        detail: {
            created_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            email: null,
            enabled: 1,
            fax: null,
            id: null,
            modified_by: user_id,
            name: null,
            note: null,
            phone_1: null,
            phone_2: null,
            status_id: 10,
            website: null,
        },
        all: new Map(),
        validator: null,
        fileManager: null,
        
        build: function () {
            if (validate_form()) {
                return build()
            }
        },
        setDetail: function (settings) {
            return setDetail(settings)
        },
        add: function (dataToSend, callback) {
            return addCompany(dataToSend, callback)
        },
        company_exists: function (name) {
            return company_exists(name)
        },
        populate_form: function (company) {
            populate_form(company)
        },
        resetForm: function (toggleFullClear) {
            resetForm(toggleFullClear)
        },
        init: function (company) {
            init(company)
        },
        
    }
})()

const Contact = (function () {
    "use strict"
    //Path
    const base_url = "/contacts"
    //Buttons
    const _clear_contact_table = document.getElementById("clear_contact_table")
    const _button_add_contact_table = document.getElementById("button_add_contact_table")
    const _button_clear_form_edit_contact = document.getElementById("button_clear_form_edit_contact")
    const _button_close_edit_contact_form = document.getElementById("button_close_edit_contact_form")
    const _button_submit_form_edit_contact = document.getElementById("button_submit_form_edit_contact")
    //Fields
    const _company_id = document.getElementById("company_id")
    const _contact_company_id = document.getElementById("contact_company_id")
    const _contact_id = document.getElementById("contact_id")
    const _contact_name_first = document.getElementById("contact_name_first")
    const _contact_name_last = document.getElementById("contact_name_last")
    const _contact_phone = document.getElementById("contact_phone")
    const _contact_email = document.getElementById("contact_email")
    const _contact_enabled = document.getElementById("contact_enabled")
    const _contact_types_id = document.getElementById("contact_types_id")
    //Blocks
    const _card_edit_contact_form = document.getElementById("card_edit_contact_form")
    const _form_edit_contact = document.getElementById("form_edit_contact")
    //Tables
    const _table_contact = document.getElementById("table_contact")
    //Unused
    const _contact_date_created = document.getElementById("contact_date_created")
    const _contact_created_by = document.getElementById("contact_created_by")
    const _contact_date_modified = document.getElementById("contact_date_modified")
    const _contact_modified_by = document.getElementById("contact_modified_by")
    const _contact_note = document.getElementById("contact_note")
    //Defaults
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let $contact_table = $(_table_contact)
    let form_rules = {
        rules: {
            contact_name_first: {
                required: true,
            },
            contact_name_last: {
                required: true,
            },
            contact_phone: {
                required: true,
            },
            contact_email: {
                required: true,
            },
            contact_types_id: {
                required: true,
            },
        },
        messages: {
            contact_name_first: {
                required: "Field Required",
            },
            contact_name_last: {
                required: "Field Required",
            },
            contact_phone: {
                required: "Field Required",
            },
            contact_email: {
                required: "Field Required",
            },
            contact_types_id: {
                required: "Field Required",
            },
        },
    }
    let validator
    // ----
    
    /**
     * submit contact form button
     */
    $(_button_submit_form_edit_contact)
        .on("click", function () {
            if (validate_form()) {
                confirmDialog(`Would you like to update?`, (ans) => {
                    if (ans) {
                        save()
                    }
                })
            }
        })
    
    $(_button_add_contact_table)
        .on("click", function () {
            $contact_table.clearSelectedRows()
            clear_form()
            show_form()
        })
    
    $(_button_clear_form_edit_contact)
        .on("click", function () {
            $contact_table.clearSelectedRows()
            clear_form()
        })
    
    $(_button_close_edit_contact_form)
        .on("click", function () {
            $contact_table.clearSelectedRows()
            clear_form()
            hide_form()
        })
    
    $(_clear_contact_table)
        .on("click", function () {
            Contact.clearTable()
        })
    
    /**
     * validate contact form
     *
     * @returns {boolean}
     */
    const validate_form = function () {
        return $(_form_edit_contact).valid()
    }
    
    /**
     * build contact record
     *
     * @returns {{}|*}
     */
    const build = function () {
        
        let dataToSend = {
            name_first: _contact_name_first.value,
            name_last: _contact_name_last.value,
            email: _contact_email.value,
            phone: _contact_phone.value,
            contact_types_id: toNumbers(getListOfIds($(_contact_types_id).val())),
            enabled: (_contact_enabled.checked === true) ? 1 : 0,
            company_id: (!isNaN(_contact_company_id.value)) ? parseInt(_contact_company_id.value) : null,
            id: (!isNaN(_contact_id.value)) ? parseInt(_contact_id.value) : null,
        }
        return remove_nulls(dataToSend)
        
    }
    
    /**
     * build contact table structure
     */
    const build_table = function () {
        if (_table_contact) {
            if (!$.fn.DataTable.isDataTable(_table_contact)) {
                $contact_table = $(_table_contact).table({
                    table_type: "display_list",
                    data: Contact.all,
                    columnDefs: [
                        {
                            title: "ID",
                            targets: 0,
                            data: "id",
                            render: function (data, type, row, meta) {
                                return data
                            },
                        },
                        {
                            title: "Name",
                            targets: 1,
                            data: "formatted_names",
                            render: function (data, type, row, meta) {
                                return data
                            },
                        },
                        {
                            title: "Types",
                            targets: 2,
                            data: "formatted_types",
                            render: function (data, type, row, meta) {
                                return data
                            },
                        },
                    ],
                    rowClick: Contact.navigate,
                })
            }
        }
    }
    
    /**
     * save contact
     */
    const save = function () {
        let dataToSend = build()
        if (dataToSend) {
            update_contact(dataToSend, function (data) {
                //console.log(data)
                if (data) {
                    if (data[0]) {
                        let contact = data[0]
                        let detail = set_detail(contact)
                        
                        if (Contact.all.get(detail.id)) {
                            $contact_table.updateRow(detail)
                        } else {
                            $contact_table.insertRow(detail)
                        }
                        
                        Contact.all.set(detail.id, detail)
                        
                        toastr.success("Contact Updated")
                    }
                    
                }
            })
        }
        
    }
    
    /**
     * update contact
     *
     * @param dataToSend
     * @param callback
     */
    const update_contact = function (dataToSend, callback) {
        let url = "/api/v1.0/contacts/update"
        if (dataToSend) {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                } else {
                    return handleContactError("Oops: 1")
                }
            })
        }
    }
    
    /**
     * sets objects default values
     *
     * @returns {{note: null, country: {note: null, date_modified: *, date_created: *, name: null, modified_by: number, id: null, iso2: null, sort_order: number, created_by: number, currency_id: null, enabled: number, iso3: null}, medium_contact_formatted: null, city: {note: null, date_modified: *, province_id: null, date_created: *, name: null, modified_by: number, id: null, sort_order: number, created_by: number, enabled: number}, date_created: *, created_by: number, enabled: number, short_contact_formatted: null, long_contact_formatted: null, street_1: null, date_modified: *, province: {note: null, date_modified: *, date_created: *, name: null, modified_by: number, id: null, iso2: null, sort_order: number, created_by: number, country_id: null, enabled: number, iso3: null}, street_3: null, street_2: null, modified_by: number, id: null, postal_code: null}}
     * @private
     */
    const _default_detail = function () {
        return {
            id: null,
            company_id: null,
            name_first: null,
            name_last: null,
            formatted_types: "",
            formatted_names: "",
            phone: null,
            email: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    /**
     * handels contact errors
     *
     * @param msg
     */
    const handleContactError = function (msg) {
        toastr.error(msg)
    }
    
    /**
     * reset form fields
     */
    const clear_form = function () {
        if (_card_edit_contact_form) {
            _contact_id.value = ""
            _contact_name_first.value = ""
            _contact_name_last.value = ""
            _contact_phone.value = ""
            _contact_email.value = ""
            _contact_enabled.checked = true
            $(_contact_types_id).val([])
        }
    }
    
    /**
     * populate form fields
     *
     * @param contact
     */
    const populate_form = function (contact) {
        clear_form()
        _contact_company_id.value = _company_id.value
        if (contact) {
            //console.log("contact", contact)
            _contact_id.value = validInt(contact.id)
            _contact_name_first.value = (contact.name_first) ? contact.name_first : null
            _contact_name_last.value = (contact.name_last) ? contact.name_last : null
            _contact_phone.value = (contact.phone) ? contact.phone : null
            _contact_email.value = (contact.email) ? contact.email : null
            _contact_enabled.checked = (contact.enabled) ? (contact.enabled === 1) : true
            $(_contact_types_id).val((contact.contact_types_id) ? contact.contact_types_id : [])
        }
        show_form()
    }
    
    /**
     * show form
     */
    const show_form = function () {
        if (_card_edit_contact_form) {
            $(_card_edit_contact_form).show()
        }
    }
    
    /**
     * hide form
     */
    const hide_form = function () {
        if (_card_edit_contact_form) {
            $(_card_edit_contact_form).hide()
        }
    }
    
    /**
     * sets detail for contact object
     *
     * @param contact
     * @returns {{note: null, country: {note: null, date_modified: *, date_created: *, name: null, modified_by: number, id: null, iso2: null, sort_order: number, created_by: number, currency_id: null, enabled: number, iso3: null}, medium_contact_formatted: null, city: {note: null, date_modified: *, province_id: null, date_created: *, name: null, modified_by: number, id: null, sort_order: number, created_by: number, enabled: number}, date_created: *, created_by: number, enabled: number, short_contact_formatted: null, long_contact_formatted: null, street_1: null, date_modified: *, province: {note: null, date_modified: *, date_created: *, name: null, modified_by: number, id: null, iso2: null, sort_order: number, created_by: number, country_id: null, enabled: number, iso3: null}, street_3: null, street_2: null, modified_by: number, id: null, postal_code: null}}
     */
    const set_detail = function (contact) {
        let detail = _default_detail()
        if (contact) {
            detail.id = (contact.id) ? contact.id : null
            detail.company_id = (contact.company_id) ? contact.company_id : null
            detail.name_first = (contact.name_first) ? contact.name_first : null
            detail.name_last = (contact.name_last) ? contact.name_last : null
            detail.formatted_types = (contact.formatted_types) ? contact.formatted_types : ""
            detail.formatted_names = (contact.formatted_names) ? contact.formatted_names : ""
            detail.contact_types_id = getListOfIds(contact.contact_types_id)
            detail.phone = (contact.phone) ? contact.phone : null
            detail.email = (contact.email) ? contact.email : null
            detail.enabled = (contact.enabled) ? contact.enabled : 1
            detail.date_created = (contact.date_created) ? contact.date_created : formatDateMySQL()
            detail.created_by = (contact.created_by) ? contact.created_by : created_by
            detail.date_modified = (contact.date_modified) ? contact.date_modified : formatDateMySQL()
            detail.modified_by = (contact.modified_by) ? contact.modified_by : modified_by
            detail.note = (contact.note) ? contact.note : null
        }
        
        Contact.detail = detail
        return detail
    }
    
    /**
     * loads all contacts into object
     *
     * @param contacts
     */
    const load_all = function (contacts) {
        Contact.all = new Map()
        
        if (!contacts) {
            return
        }
        
        $.each(contacts, function (i, contact) {
            let detail = set_detail(contact)
            Contact.all.set(detail.id, detail)
            $contact_table.insertRow(detail)
        })
        
        if (contacts[0]) {
            $contact_table.loadRow(contacts[0])
        }
        
        //console.log(" Contact.all", Contact.all)
    }
    
    /**
     * load selected contact
     *
     * @param contact
     */
    const navigate = function (contact) {
        if (contact) {
            populate_form(contact)
        }
    }
    
    /**
     * initialize contact form and table
     *
     * @param contacts
     */
    const init = function (contacts) {
        if (_table_contact) {
            build_table()
        }
        if (contacts) {
            
            load_all(contacts)
        }
        if (_form_edit_contact) {
            validator_init(form_rules)
            validator = $(_form_edit_contact).validate()
        }
        hide_form()
    }
    
    /**
     * clear and empty table
     */
    const clearTable = function () {
        let contacts = Array.from(Contact.all.values())
        $.each(contacts, function (k, contact) {
            $contact_table.deleteRow(contact)
        })
        Contact.all = new Map()
    }
    
    const fetchContactsByCompanyId = function (dataToSend, callback) {
        let url = "/api/v1.0/contacts"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleContactError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleContactError("Error Validating Company")
            }
        } else {
            return handleContactError("Error Loading Company- Missing Data")
        }
    }
    
    const populateTable = function (contacts) {
        if (_table_contact) {
            Contact.all = new Map()
            let loadContact
            let count = 0
            $.each(contacts, function (i, contact) {
                if (count === 0) {
                    loadContact = contact
                }
                contact.contact_types_id = getListOfIds(contact.contact_types_id)
                Contact.all.set(contact.id, contact)
                $contact_table.insertRow(contact)
                count++
            })
            
            if (_table_contact) {
                if (loadContact) {
                    $contact_table.loadRow(loadContact)
                }
                
                $contact_table.clearSelectedRows()
            }
        }
    }
    
    const getByCompanyId = function (company_id) {
        if (company_id) {
            fetchContactsByCompanyId({ company_id: company_id }, function (data) {
                if (data) {
                    let contacts = data
                    clearTable()
                    populateTable(contacts)
                }
            })
        }
    }
    
    /**
     * globals
     */
    return {
        validator: null,
        detail: {},
        all: new Map(),
        getByCompanyId: function (company_id) {
            getByCompanyId(company_id)
        },
        clearTable: function () {
            clearTable()
        },
        navigate: function (contact) {
            navigate(contact)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

const Currency = (function () {
    "use strict"
    
    const base_url = "/currency"
    const _input_currency_id = document.getElementById("input_currency_id")
    const _input_currency_sort_order = document.getElementById("input_currency_sort_order")
    const _input_currency_name = document.getElementById("input_currency_name")
    const _input_currency_iso = document.getElementById("input_currency_iso")
    const _input_currency_minor_unit = document.getElementById("input_currency_minor_unit")
    const _input_currency_symbol = document.getElementById("input_currency_symbol")
    const _input_currency_enabled = document.getElementById("input_currency_enabled")
    const _input_currency_date_created = document.getElementById("input_currency_date_created")
    const _input_currency_created_by = document.getElementById("input_currency_created_by")
    const _input_currency_date_modified = document.getElementById("input_currency_date_modified")
    const _input_currency_modified_by = document.getElementById("input_currency_modified_by")
    const _input_currency_note = document.getElementById("input_currency_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_currency_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            sort_order: null,
            name: null,
            iso: null,
            minor_unit: null,
            symbol: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(' -- Currency -- ', {})
    }
    
    const set = function (currency) {
        let detail = _default_detail()
        if (currency) {
            detail.id = (currency.id) ? currency.id : null
            detail.sort_order = (currency.sort_order) ? currency.sort_order : null
            detail.name = (currency.name) ? currency.name : null
            detail.iso = (currency.iso) ? currency.iso : null
            detail.minor_unit = (currency.minor_unit) ? currency.minor_unit : null
            detail.symbol = (currency.symbol) ? currency.symbol : null
            detail.enabled = (currency.enabled) ? currency.enabled : 1
            detail.date_created = (currency.date_created) ? currency.date_created : formatDateMySQL()
            detail.created_by = (currency.created_by) ? currency.created_by : created_by
            detail.date_modified = (currency.date_modified) ? currency.date_modified : formatDateMySQL()
            detail.modified_by = (currency.modified_by) ? currency.modified_by : modified_by
            detail.note = (currency.note) ? currency.note : null
        }
        
        Currency.detail = detail
        return detail
    }
    
    const load_all = function (currencies) {
        Currency.all = new Map()
        
        if (!currencies) {
            return
        }
        $.each(currencies, function (i, currency) {
            let detail = set(currency)
            Currency.all.set("id", detail)
        })
        
        //console.log(' Currency.all',  Currency.all);
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

Currency.init()
//end object

const Vendor = (function () {
    "use strict"
    
    const base_url = "/vendors"
    /** Tabs */
    const _panel_tab_contact = document.getElementById("panel_tab_contact")
    const _button_add_vendor_page_heading = document.getElementById("button_add_vendor_page_heading")
    const _vendor_index_table_add_button = document.getElementById("vendor_index_table_add_button")
    const _vendor_company_id = document.getElementById("vendor_company_id")
    const _form_edit_vendor = document.getElementById("form_edit_vendor")
    const _vendor_name = document.getElementById("vendor_name")
    const _vendor_id = document.getElementById("vendor_id")
    const _vendor_show_online = document.getElementById("vendor_show_online")
    const _vendor_show_sales = document.getElementById("vendor_show_sales")
    const _vendor_show_ops = document.getElementById("vendor_show_ops")
    const _vendor_is_provider = document.getElementById("vendor_is_provider")
    const _vendor_sku = document.getElementById("vendor_sku")
    const _vendor_enabled = document.getElementById("vendor_enabled")
    const _provider_edit = document.getElementById("provider_edit")
    const _provider_name = document.getElementById("provider_name")
    const _provider_company_id = document.getElementById("provider_company_id")
    const _company_id = document.getElementById("company_id")
    const _button_submit_form_edit_vendor = document.getElementById("button_submit_form_edit_vendor")
    const _table_vendor_index = document.getElementById("table_vendor_index")
    const _form_vendor_add = document.getElementById("form_vendor_add")
    const _modal_button_submit_add_vendor = document.getElementById("modal_button_submit_add_vendor")
    const _modal_button_cancel_add_vendor = document.getElementById("modal_button_cancel_add_vendor")
    const _modal_new_vendor = document.getElementById("modal_new_vendor")
    const _vendor_modal_vendor_name = document.getElementById("vendor_modal_vendor_name")
    const _button_save_vendor = document.getElementById("button_save_vendor")
    const _company_name = document.getElementById("company_name")
    const _form_product_add = document.getElementById("form_product_add")
    const _modal_product_vendor_id = document.getElementById("modal_product_vendor_id")
    const _modal_product_vendor_name = document.getElementById("modal_product_vendor_name")
    const _modal_product_provider_vendor_match = document.getElementById("modal_product_provider_vendor_match")
    const _modal_product_provider_company_id = document.getElementById("modal_product_provider_company_id")
    const _modal_product_vendor_company_id = document.getElementById("modal_product_vendor_company_id")
    
    const _product_edit_details_section_vendor_form_filter = document.getElementById("product_edit_details_section_vendor_form_filter")
    const _product_edit_details_section_vendor_form_vendor_id = document.getElementById("product_edit_details_section_vendor_form_vendor_id")
    //
    let new_vendor_validator, validator
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let globalSelectedVendor = false
    let form_rules = {
        rules: {
            vendor_name: {
                required: true,
            },
        },
        messages: {
            vendor_name: {
                required: "Field Required",
            },
        },
    }
    let add_modal_form_rules = {
        rules: {
            vendor_modal_vendor_name: {
                required: true,
            },
        },
        messages: {
            vendor_modal_vendor_name: {
                required: "Field Required",
            },
        },
    }
    let $index_table = $(_table_vendor_index)
    
    // ----
    
    $(_button_save_vendor)
        .on("click", function () {
            let company = Company.build()
            //console.log("_button_save_vendor", company)
            update()
        })
    
    $(_button_add_vendor_page_heading)
        .on("click", function () {
            load_new_modal()
        })
    
    $(_vendor_index_table_add_button)
        .on("click", function () {
            load_new_modal()
        })
    
    $(_modal_button_cancel_add_vendor)
        .on("click", function () {
            hide_new_modal()
        })
    
    $(_modal_button_submit_add_vendor)
        .on("click", function () {
            if (validate_new_modal_form()) {
                let dataToSend = {
                    name: _vendor_modal_vendor_name.value,
                }
                confirmDialog(`Vendor: ${name} will be added`, (ans) => {
                    if (ans) {
                        add(dataToSend)
                    }
                })
            }
        })
    
    $(_vendor_modal_vendor_name)
        .on("change", function () {
            setTimeout(function () {
                let vendor_name = _vendor_modal_vendor_name.value
                
                if (globalSelectedVendor === false) {
                    if (vendor_name === "") {
                        _vendor_modal_vendor_name.value = ""
                        globalSelectedVendor = false
                    } else {
                        vendor_exists(vendor_name)
                    }
                }
            }, 200)
        })
        .on("search", function () {
        
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/vendors",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion.data) {
                    return
                }
                let vendor = suggestion.data
                confirmDialog(`Vendor ${vendor.name} ALREADY exists. Would you like to load this record to edit?`, (ans) => {
                    if (ans) {
                        window.location.replace(base_url + "/" + vendor.id)
                    } else {
                        reset_modal()
                    }
                })
            },
        })
    
    $(_modal_product_vendor_name)
        .on("change", function () {
            setTimeout(function () {
                let vendor_name = _modal_product_vendor_name.value
                globalSelectedVendor = false
                
                if (vendor_name === "") {
                    _modal_product_vendor_id.value = ""
                    _modal_product_vendor_name.value = ""
                    _modal_product_vendor_company_id.value = ""
                    Product.attr3 = null
                    Product.updateProductSKU()
                    globalSelectedVendor = false
                } else {
                    vendor_exists(vendor_name)
                }
                
            }, 200)
        })
        .on("search", function () {
            _modal_product_vendor_id.value = ""
            _modal_product_vendor_name.value = ""
            _modal_product_vendor_company_id.value = ""
            _modal_product_provider_vendor_match.checked = false
            Product.attr3 = null
            Product.updateProductSKU()
            globalSelectedVendor = false
        })
        .on("click", function (e) {
            if ($(this).attr("readonly") === "readonly") {
                e.preventDefault()
            } else {
                $(this).select()
            }
        })
        .autocomplete({
            serviceUrl: "/api/v1.0/autocomplete/vendors",
            minChars: 2,
            cache: false,
            dataType: "json",
            triggerSelectOnValidInput: false,
            paramName: "st",
            onSelect: function (suggestion) {
                if (!suggestion || !suggestion.data) {
                    return
                }
                //console.log("suggestion.data", suggestion.data)
                let vendor = suggestion.data
                
                if (_form_product_add) {
                    let provider_company_id = (isNaN(parseInt(_modal_product_provider_company_id.value))) ? null : parseInt(_modal_product_provider_company_id.value)
                    _modal_product_vendor_id.value = suggestion.data.id
                    _modal_product_vendor_name.value = suggestion.data.name
                    _modal_product_vendor_company_id.value = suggestion.data.company_id
                    Product.attr3 = suggestion.data.sku
                    Product.updateProductSKU()
                    _modal_product_provider_vendor_match.checked = parseInt(suggestion.data.company_id) === provider_company_id
                }
                
                globalSelectedVendor = true
                
            },
        })
    
    $(_company_id)
        .on("change", function () {
            $(_vendor_company_id).val(_company_id.value)
        })
    
    $(_button_submit_form_edit_vendor)
        .on("click", function () {
            update()
        })
    
    const initAutoComplete = function () {
        if (_vendor_name) {
            $(_vendor_name)
                .on("change", function () {
                    setTimeout(function () {
                        let vendor_name = _vendor_name.value
                        globalSelectedVendor = false
                        if (vendor_name === "") {
                            _vendor_name.value = ""
                            _vendor_company_id.value = ""
                            
                        } else {
                            vendor_exists(vendor_name)
                        }
                        
                    }, 200)
                })
                .on("click", function () {
                    $(this).select()
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/vendors",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion.data) {
                            return
                        }
                        //let vendor = (suggestion.data.vendor_detail) ? suggestion.data.vendor_detail : {}
                        //let company = (suggestion.data.company_detail) ? suggestion.data.company_detail : {}
                        //let contacts = []
                        //let addresses = []
                        //log("vendor", vendor)
                        // --
                        //log("Provider.suggestion", suggestion.data)
                        //globalSelectedProvider = true
                        //_provider_company_id.value = suggestion.data.company_id
                        //_provider_id.value = suggestion.data.provider_id
                        //_provider_name.value = suggestion.data.company_name
                    },
                })
        }
        
        if (_product_edit_details_section_vendor_form_filter) {
        
        }
    }
    
    const vendor_exists = function (name) {
        //console.log("vendor_exists()", name)
        
        if (name && name !== "") {
            let dataToSend = {
                name: name,
            }
            
            //console.log("dataToSend", dataToSend)
            
            fetch_vendor_by_name(dataToSend, function (data) {
                //console.log("fetch_vendor_by_name()", data)
                let vendor, company
                
                if (data && data.length > 0) {
                    vendor = data
                    if (data.length > 0) {
                        if (data[0]) {
                            vendor = data[0]
                        }
                    }
                    
                } else {
                    //console.log("Vendor Does Not Exist")
                    
                    _modal_product_vendor_id.value = ""
                    _modal_product_vendor_company_id.value = ""
                    
                    Product.attr3 = null
                    Product.updateProductSKU()
                    
                    let name = _modal_product_vendor_name.value
                    if (name !== "") {
                        confirmDialog(`Vendor ${name} does not exists. Would you like to create this`, (ans) => {
                            if (ans) {
                                let dataToSend = {
                                    name: _modal_product_vendor_name.value,
                                }
                                add(dataToSend)
                            } else {
                                _modal_product_vendor_name.value = ""
                            }
                        })
                    }
                }
                
                if (vendor) {
                    //console.log("Vendor Exists", vendor)
                    
                    if (_vendor_modal_vendor_name) {
                        confirmDialog(`Vendor ${vendor.name} ALREADY exists. Would you like to load this record to edit?`, (ans) => {
                            if (ans) {
                                window.location.replace(base_url + "/" + vendor.id)
                            }
                        })
                    }
                    
                    if (_form_product_add) {
                        _modal_product_vendor_id.value = (vendor.id) ? vendor.id : ""
                        _modal_product_vendor_company_id.value = (vendor.company_id) ? vendor.company_id : ""
                        Product.attr3 = (vendor.sku) ? vendor.sku : null
                        Product.updateProductSKU()
                    }
                    
                }
                
            })
            
        }
        
    }
    
    const hide_new_modal = function () {
        $(_modal_new_vendor).modal("hide")
    }
    
    const load_new_modal = function () {
        $(_vendor_modal_vendor_name).val("")
        $(_modal_new_vendor).modal("show")
    }
    
    const validate_new_modal_form = function () {
        if (_form_vendor_add) {
            return $(_form_vendor_add).valid()
        }
        return false
    }
    
    const add = function (vendor) {
        if (vendor) {
            newVendor(vendor, function (data) {
                if (data) {
                    //console.log("data 1", data)
                    if (data[0]) {
                        //console.log("data[0] 1", data[0])
                        let details = data[0]
                        
                        if (details.id) {
                            if (_form_product_add) {
                                //console.log("_form_product_add: details", details)
                                _modal_product_vendor_company_id.value = (details.company_id) ? details.company_id : ""
                                _modal_product_vendor_id.value = (details.id) ? details.id : ""
                                _modal_product_provider_vendor_match.checked = (_modal_product_vendor_company_id.value === _modal_product_provider_company_id.value)
                                Product.attr3 = (details.sku) ? details.sku : null
                                Product.updateProductSKU()
                            }
                            
                            if (_form_vendor_add) {
                                window.location.replace("/vendors/" + details.id)
                            }
                        } else {
                            //console.log("details 1", details)
                        }
                    } else {
                        //console.log("details 2", data)
                    }
                } else {
                    //console.log("details 3", vendor)
                }
            })
        }
    }
    
    /**
     * update vendor record
     *
     * @param dataToSend
     * @param callback
     */
    const newVendor = function (dataToSend, callback) {
        let url = "/api/v1.0/vendors/add"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_vendor_error("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const reset_modal = function () {
        _vendor_modal_vendor_name.value = ""
    }
    
    /**
     * build vendor index table
     */
    const build_index_table = function () {
        $index_table = $(_table_vendor_index).table({
            table_type: "display_list",
            data: Vendor.all,
            columnDefs: [
                {
                    title: "Id",
                    targets: 0,
                    data: "id",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Name",
                    targets: 1,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "SKU",
                    targets: 2,
                    data: "sku",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
            ],
            rowClick: Vendor.navigate,
        })
    }
    
    /**
     * handel errors
     *
     * @param msg
     */
    const handle_vendor_error = function (msg) {
        toastr.error(msg)
    }
    
    const build = function () {
        return remove_nulls({
            id: (!isNaN(parseInt(_vendor_id.value))) ? parseInt(_vendor_id.value) : null,
            company_id: (!isNaN(parseInt(_vendor_company_id.value))) ? parseInt(_vendor_company_id.value) : null,
            name: (_vendor_name.value !== "") ? _vendor_name.value : null,
            status_id: 10,
            enabled: (_vendor_enabled.checked) ? 1 : 0,
            show_online: (_vendor_show_online.checked === true) ? 1 : 0,
            show_sales: (_vendor_show_sales.checked === true) ? 1 : 0,
            show_ops: (_vendor_show_ops.checked === true) ? 1 : 0,
            is_provider: (_vendor_is_provider.checked === true) ? 1 : 0,
            sku: _vendor_sku.value,
        })
    }
    
    /**
     * fetch vendor by name
     *
     * @param dataToSend
     * @param callback
     */
    const fetch_vendor_by_name = function (dataToSend, callback) {
        let url = "/api/v1.0/vendors/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_vendor_error("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handle_vendor_error("Error Validating Company")
            }
        } else {
            return handle_vendor_error("Error Loading Company- Missing Data")
        }
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            company_id: null,
            status_id: 1,
            show_online: 1,
            show_sales: 1,
            show_ops: 1,
            is_provider: 1,
            sku: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            company: {},
            addresses: [],
            contacts: [],
        }
    }
    
    const set_detail = function (vendor) {
        
        let detail = _default_detail()
        let vendor_detail, company_detail = {}
        let contacts, addresses = []
        
        if (vendor) {
            
            if (vendor.vendor_detail) {
                vendor_detail = vendor.vendor_detail
                detail.id = (vendor_detail.id) ? vendor_detail.id : null
                detail.status_id = (vendor_detail.status_id) ? vendor_detail.status_id : null
                detail.show_online = vendor_detail.show_online
                detail.show_sales = vendor_detail.show_sales
                detail.show_ops = vendor_detail.show_ops
                detail.is_provider = vendor_detail.is_provider
                detail.sku = (vendor_detail.sku) ? vendor_detail.sku : null
                detail.enabled = vendor_detail.enabled
                detail.date_created = (vendor_detail.date_created) ? vendor_detail.date_created : formatDateMySQL()
                detail.created_by = (vendor_detail.created_by) ? vendor_detail.created_by : created_by
                detail.date_modified = (vendor_detail.date_modified) ? vendor_detail.date_modified : formatDateMySQL()
                detail.modified_by = (vendor_detail.modified_by) ? vendor_detail.modified_by : modified_by
                detail.note = (vendor_detail.note) ? vendor_detail.note : null
            }
            
            if (vendor.company_detail) {
                company_detail = vendor.company_detail
                detail.company_id = (company_detail.id) ? company_detail.id : null
            }
            
            if (vendor.contacts) {
                contacts = vendor.contacts
            }
            
            if (vendor.addresses) {
                addresses = vendor.addresses
            }
        }
        
        Vendor.detail = detail
        return detail
    }
    
    const set = function (vendor) {
        let detail = _default_detail()
        let company = {}
        let addresses, contacts = []
        
        if (vendor) {
            detail.id = (vendor.id) ? vendor.id : null
            detail.name = (vendor.name) ? vendor.name : null
            detail.status_id = (vendor.status_id) ? vendor.status_id : null
            detail.show_online = vendor.show_online
            detail.show_sales = vendor.show_sales
            detail.show_ops = vendor.show_ops
            detail.is_provider = vendor.is_provider
            detail.sku = (vendor.sku) ? vendor.sku : null
            detail.enabled = vendor.enabled
            detail.date_created = (vendor.date_created) ? vendor.date_created : formatDateMySQL()
            detail.created_by = (vendor.created_by) ? vendor.created_by : created_by
            detail.date_modified = (vendor.date_modified) ? vendor.date_modified : formatDateMySQL()
            detail.modified_by = (vendor.modified_by) ? vendor.modified_by : modified_by
            detail.note = (vendor.note) ? vendor.note : null
            if (vendor.company) {
                company = vendor.company
                detail.company_id = company.id
                
                if (vendor.company.addresses) {
                    addresses = vendor.addresses
                }
                if (vendor.company.contacts) {
                    contacts = vendor.contacts
                }
            }
        }
        
        detail.addresses = addresses
        detail.contacts = contacts
        detail.company = company
        
        Vendor.detail = detail
        return detail
    }
    
    /**
     * update provider record
     *
     * @param dataToSend
     * @param callback
     */
    const updateVendor = function (dataToSend, callback) {
        //console.log("updateVendor()", dataToSend)
        let url = "/api/v1.0/vendors/update"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    //console.log("data", data)
                    if (data) {
                        return callback(data)
                    } else {
                        return handle_vendor_error("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const update = function () {
        let vendor_detail = Vendor.build()
        
        vendor_detail.company_detail = Company.build()
        if (vendor_detail) {
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    //console.log("vendor_detail", vendor_detail)
                    
                    updateVendor(vendor_detail, function (data) {
                        //console.log("data", data)
                        if (data) {
                            //console.log("data 1", data)
                            if (data[0]) {
                                //console.log("data[0] 1", data[0])
                                let details = data[0]
                                if (details.id) {
                                    if (_vendor_id.value === "" || isNaN(parseInt(_vendor_id.value))) {
                                        window.location.replace(base_url + "/" + details.id)
                                    } else {
                                        let name = _company_name.value
                                        toastr.success(`Vendor ${name} has been updated.`)
                                    }
                                } else {
                                    //console.log("details 1", details)
                                }
                            } else {
                                //console.log("details 2", data)
                            }
                        } else {
                            //console.log("details 3", provider)
                        }
                    })
                }
                
            })
        }
    }
    
    /**
     * save provider object
     *
     * @param vendor
     */
    const save = function (vendor) {
        
        if (vendor) {
            updateVendor(vendor, function (data) {
                if (data) {
                    //console.log("data", data)
                    //console.log(data.length)
                    if (data[0]) {
                        //console.log("data[0]", data[0])
                        let details = data[0]
                        if (details.id) {
                            //console.log("details.id", details.id)
                            //console.log("_vendor_id.value", _vendor_id.value)
                            if (_vendor_id.value === "" || isNaN(parseInt(_vendor_id.value))) {
                                window.location.replace(base_url + "/" + details.id)
                            } else {
                                let name = _company_name.value
                                toastr.success(`Vendor ${name} has been updated.`)
                            }
                        } else {
                            //console.log("details 1", details)
                        }
                    } else {
                        //console.log("details 2", data)
                    }
                } else {
                    //console.log("details 3", provider)
                }
            })
        }
    }
    
    const validate_all = function (params) {
        let tabs = $("#vendor_edit_tabs > li.nav-item > a.nav-link")
        let panels = $("div.tab-pane")
        let company_detail = Company.build()
        let vendor_detail = Vendor.build()
        let addresses = Array.from(Address.all.values())
        let contacts = Array.from(Contact.all.values())
        /*
          //console.log("company_detail", company_detail)
          //console.log("provider_detail", provider_detail)
          //console.log("location_detail", location_detail)
          //console.log("vendor_detail", vendor_detail)
          //console.log("addresses", addresses)
          //console.log("contacts", contacts)
          //*/
        if (!company_detail || !vendor_detail || !addresses || !contacts) {
            $.each(panels, function (index, item) {
                if ($(this).find(".is-invalid").length > 0) {
                    let nav_tab = $("body").find("[aria-controls='" + $(this).attr("id") + "']")
                    tabs.removeClass("active")
                    panels.removeClass("active")
                    $(this).addClass("active")
                    nav_tab.addClass("active")
                    return false
                }
            })
            return
        }
        
        confirmDialog(`Would you like to update?`, (ans) => {
            if (ans) {
                
                save({
                    "company_detail": company_detail,
                    "vendor_detail": vendor_detail,
                    "addresses": addresses,
                    "contacts": contacts,
                })
            }
            
        })
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const reset_form = function () {
        _vendor_name.value = ""
        _vendor_id.value = ""
        _vendor_company_id.value = ""
        _vendor_show_online.checked = true
        _vendor_show_sales.checked = true
        _vendor_show_ops.checked = true
        _vendor_is_provider.checked = true
        _vendor_sku.value = ""
        _vendor_enabled.checked = true
    }
    
    const populate_form = function (vendor) {
        let detail = set_detail(vendor)
        _vendor_name.value = (detail.company.name) ? detail.company.name : ""
        _vendor_company_id.value = (detail.company.id) ? detail.company.id : ""
        
        if (_provider_edit) {
            if (_provider_name) {
                _vendor_name.value = _provider_name.value
            }
            
            if (_provider_company_id) {
                _vendor_company_id.value = _provider_company_id.value
            }
        }
        
        _vendor_id.value = (detail.id) ? detail.id : ""
        _vendor_sku.value = (detail.sku) ? detail.sku : ""
        _vendor_show_online.checked = (detail.show_online === 1)
        _vendor_show_sales.checked = (detail.show_sales === 1)
        _vendor_show_ops.checked = (detail.show_ops === 1)
        _vendor_is_provider.checked = (detail.is_provider === 1)
        _vendor_enabled.checked = (detail.enabled === 1)
    }
    
    const load_all = function (vendors) {
        Vendor.all = new Map()
        if (vendors) {
            $.each(vendors, function (i, vendor) {
                let detail = set(vendor)
                $index_table.insertRow(detail)
                Vendor.all.set(detail.id, detail)
            })
        }
        
        //console.log(" Vendor.all", Vendor.all)
    }
    
    const validate_form = function () {
        return $(_form_edit_vendor).valid()
    }
    
    const populateProductEditVendorForm = function (vendor) {
        //console.log("Provider.populateProductEditVendorForm(vendor)", vendor)
        //console.log("|__ Vendor.detail", Vendor.detail)
        _product_edit_details_section_vendor_form_filter.value = vendor.company.name
        _product_edit_details_section_vendor_form_vendor_id.value = vendor.id
        
        Product.attr3 = (vendor.sku) ? vendor.sku : null
    }
    
    const init = function (settings) {
        //console.log("Vendor.init(settings)", settings)
        let company = {}
        if (settings) {
            if (settings.company) {
                company = settings.company
            }
            
            if (settings.vendor_detail) {
                let detail = set(settings.vendor_detail)
                populateProductEditVendorForm(detail)
                //console.log("|__ detail", detail)
                
            }
        }
        
        if (_form_edit_vendor) {
            if (_vendor_name) {
                _vendor_name.value = (settings.name) ? settings.name : ""
                initAutoComplete()
            }
            if (_vendor_id) {
                _vendor_id.value = (settings.id) ? settings.id : ""
            }
            if (_vendor_company_id) {
                _vendor_company_id.value = (company.id) ? company.id : ""
            }
            if (_vendor_sku) {
                _vendor_sku.value = (settings.sku) ? settings.sku : ""
            }
            if (_vendor_enabled) {
                _vendor_enabled.checked = (settings.enabled) ? (settings.enabled === 1) : true
            }
            if (_vendor_is_provider) {
                _vendor_is_provider.checked = (settings.is_provider === 1)
            }
            if (_vendor_show_online) {
                _vendor_show_online.checked = (settings.show_online === 1)
            }
            if (_vendor_show_ops) {
                _vendor_show_ops.checked = (settings.show_ops === 1)
            }
            if (_vendor_show_sales) {
                _vendor_show_sales.checked = (settings.show_sales === 1)
            }
            validator_init(form_rules)
            validator = $(_form_edit_vendor).validate()
        }
    }
    
    const navigate = function (vendor) {
        if (vendor && vendor.id) {
            window.location.replace(base_url + "/" + vendor.id)
        }
    }
    
    const setProvider = function () {
        //console.log("Set Provider")
        if (_provider_edit) {
            _vendor_is_provider.checked = true
            $(_vendor_is_provider).attr("readonly", "true")
            _vendor_is_provider.disabled = true
            $(_vendor_name).attr("readonly", "true")
            $(_vendor_id).attr("readonly", "true")
            $(_vendor_sku).attr("readonly", "true")
            $(_vendor_is_provider).attr("readonly", "true")
        }
    }
    
    const index = function (settings) {
        if (_form_vendor_add) {
            validator_init(add_modal_form_rules)
            new_vendor_validator = $(_form_vendor_add).validate()
        }
        
        build_index_table()
        
        if (settings) {
            if (settings.vendors) {
                load_all(settings.vendors)
            }
        }
        
    }
    
    const setVendor = function () {
        if (_vendor_name) {
            $(_vendor_is_provider).attr("readonly", true)
            _vendor_is_provider.disabled = true
            $(_vendor_name).attr("readonly", true)
            $(_vendor_id).attr("readonly", true)
            $(_vendor_sku).attr("readonly", true)
            $(_vendor_is_provider).attr("readonly", true)
        }
    }
    
    const edit = function (settings) {
        let addresses = []
        let contacts = []
        let company = {}
        let vendor = {}
        if (settings) {
            if (settings.vendor_detail) {
                vendor = set(settings.vendor_detail)
                addresses = (settings.address_detail) ? settings.address_detail : []
                contacts = (settings.contact_detail) ? settings.contact_detail : []
                company = (settings.company_detail) ? settings.company_detail : {}
            }
        }
        
        $(_panel_tab_contact).removeClass("disabled")
        
        Vendor.init(vendor)
        Address.init(addresses)
        Contact.init(contacts)
        Company.init(company)
        setVendor()
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        newVendor: function (dataToSend, callback) {
            return newVendor(dataToSend, callback)
        },
        index: function (settings) {
            index(settings)
        },
        setProvider: function () {
            setProvider()
        },
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        reset_form: function () {
            reset_form()
        },
        save: function (params) {
            save(params)
        },
        init: function (settings) {
            init(settings)
        },
        build: function () {
            if (validate_form()) {
                return build()
            }
        },
        navigate: function (vendor) {
            navigate(vendor)
        },
        edit: function (settings) {
            edit(settings)
        },
        setVendor: function () {
            setVendor()
        },
    }
    
})()

const Tour = (function () {
    "use strict"
    const _tour_route = document.getElementById("tour_route")
    
    const init = function (options) {
        console.log("Tour.init(options)", options)
        // ----
        
        if (_tour_route) {
            $(_tour_route).routeManager({
                stops: [
                    {
                        id: 1,
                        location_id: 1,
                        time: "01:00",
                    },
                    {
                        id: 2,
                        location_id: 2,
                        time: "01:00",
                    },
                    {
                        id: 3,
                        location_id: 3,
                        time: "01:00",
                    },
                    {
                        id: 4,
                        location_id: 4,
                        time: "01:00",
                    },
                    {
                        id: 5,
                        location_id: 5,
                        time: "01:00",
                    },
                    {
                        id: 6,
                        location_id: 6,
                        time: "01:00",
                    },
                ],
            })
        }
        
    }
    
    return {
        all: new Map(),
        route: null,
        detail: {},
        init: function (options) {
            init(options)
        },
    }
})()

const MessageTypes = (function () {
    "use strict"
    
    const base_url = "/message_types"
    const _input_message_types_id = document.getElementById("input_message_types_id")
    const _input_message_types_name = document.getElementById("input_message_types_name")
    const _input_message_types_icon = document.getElementById("input_message_types_icon")
    const _input_message_types_sort_order = document.getElementById("input_message_types_sort_order")
    const _input_message_types_enabled = document.getElementById("input_message_types_enabled")
    const _input_message_types_date_created = document.getElementById("input_message_types_date_created")
    const _input_message_types_created_by = document.getElementById("input_message_types_created_by")
    const _input_message_types_date_modified = document.getElementById("input_message_types_date_modified")
    const _input_message_types_modified_by = document.getElementById("input_message_types_modified_by")
    const _input_message_types_note = document.getElementById("input_message_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_message_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            icon: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(" -- MessageTypes -- ", {})
    }
    
    const set = function (message_types) {
        let detail = _default_detail()
        if (message_types) {
            detail.id = (message_types.id) ? message_types.id : null
            detail.name = (message_types.name) ? message_types.name : null
            detail.icon = (message_types.icon) ? message_types.icon : null
            detail.sort_order = (message_types.sort_order) ? message_types.sort_order : null
            detail.enabled = (message_types.enabled) ? message_types.enabled : 1
            detail.date_created = (message_types.date_created) ? message_types.date_created : formatDateMySQL()
            detail.created_by = (message_types.created_by) ? message_types.created_by : created_by
            detail.date_modified = (message_types.date_modified) ? message_types.date_modified : formatDateMySQL()
            detail.modified_by = (message_types.modified_by) ? message_types.modified_by : modified_by
            detail.note = (message_types.note) ? message_types.note : null
        }
        
        MessageTypes.detail = detail
        return detail
    }
    
    const load_all = function (message_types) {
        MessageTypes.all = new Map()
        
        if (!message_types) {
            return
        }
        $.each(message_types, function (i, message_types) {
            let detail = set(message_types)
            MessageTypes.all.set("id", detail)
        })
        
        //console.log(" MessageTypes.all", MessageTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

//MessageTypes.init()
//end object

const Pricing = (function () {
    "use strict"
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    const _pricing_strategy_unit_id = document.getElementById("pricing_strategy_unit_id")
    const _pricing_strategy_season_id = document.getElementById("pricing_strategy_season_id")
    const _pricing_strategy_profile_id = document.getElementById("pricing_strategy_profile_id")
    const _pricing_strategy_types_id = document.getElementById("pricing_strategy_types_id")
    const _calendar_filter_profile_id = document.getElementById("calendar_filter_profile_id")
    
    /**
     * pricing strategy types id
     */
    $(_pricing_strategy_types_id)
        .on("change", function () {
            PricingWorksheet.pricingWorksheet()
            //console.log("Pricing.pricing_strategy_types_id:change()", _pricing_strategy_types_id.value)
        })
    
    /**
     * initialize pricing object
     *
     * @param settings
     */
    const init = function (settings) {
        resetForm()
        let pricings = []
        let pricing_detail
        if (settings) {
            pricing_detail = settings
            if (settings.pricings) {
                pricings = settings.pricings
            }
        }
        
        if (pricing_detail.pricing_strategy_types_id) {
            _pricing_strategy_types_id.value = pricing_detail.pricing_strategy_types_id
            PricingWorksheet.pricingStrategyId = parseInt(pricing_detail.pricing_strategy_types_id)
        }
        loadAll(pricings)
    }
    
    /**
     * load all pricing templates
     *
     * @param pricing_details
     */
    const loadAll = function (pricing_details) {
        //console.log("Pricing.loadAll()", pricing_details)
        Pricing.all = new Map()
        if (!pricing_details) {
            pricing_details = []
        }
        
        $.each(pricing_details, function (k, matrix) {
            //console.log("matrix", matrix)
            // ----
            let pricings = matrix.pricings
            let pricingCode = matrix.pricing_code
            let matrixCode = matrix.matrix_code
            let matrixDetails = Matrix.all.get(matrixCode)
            let detail = set(matrix)
            Pricing.all.set(pricingCode, detail)
            /*
            $.each(pricings, function (k, pricing) {
                //console.log("pricing", pricing)
                // ----
                
                let pricing_code = (pricing.code) ? pricing.code : null
                
                if (pricing_code) {
                    Pricing.all.set(pricing_code, pricing)
                    let details = set(pricing)
                    //console.log("details", details)
                    if (matrixDetails) {
                        if (!matrixDetails["pricings"]) {
                            matrixDetails["pricings"] = new Map()
                        }
                        
                        matrixDetails["pricings"].set(pricing_code, pricing)
                    }
                }
                
            })
            //*/
        })
        
        //console.log("Pricings.all", Pricing.all)
    }
    
    /**
     * load Season Dropdown
     */
    const loadSeasonDropdown = function () {
        let seasons = (Season && Season.all) ? Array.from(Season.all.values()) : []
        let options = ""
        
        $.each(seasons, function (k, season) {
            let name = season.name
            let id = season.id
            options += `<option value="${id}">${name}</option>`
        })
        
        $(_pricing_strategy_season_id).empty()
        $(_pricing_strategy_season_id).html(options)
    }
    
    /**
     * load Profile Dropdown
     */
    const loadProfileDropdown = function () {
        let profiles = (InventoryProfile && InventoryProfile.all) ? Array.from(InventoryProfile.all.values()) : []
        let options = "<option value='' disabled readonly selected>-- Profiles --</option>"
        
        $.each(profiles, function (k, profile) {
            let name = profile.name
            let id = profile.id
            options += `<option value="${id}">${name}</option>`
        })
        
        $(_calendar_filter_profile_id).empty()
        $(_calendar_filter_profile_id).html(options)
    }
    
    /**
     * load unit dropdown
     */
    const loadUnitDropdown = function () {
        let units = (Unit && Unit.all) ? Array.from(Unit.all.values()) : []
        let options = ""
        
        $.each(units, function (k, unit) {
            let name = unit.name
            let id = unit.id
            options += `<option value="${id}">${name}</option>`
        })
        
        $(_pricing_strategy_unit_id).empty()
        $(_pricing_strategy_unit_id).html(options)
    }
    
    const resetForm = function () {
        //*
        loadSeasonDropdown()
        loadUnitDropdown()
        loadProfileDropdown()
        //*/
    }
    
    const defaultDetail = function () {
        //console.log("Pricing.defaultDetail()", Pricing)
        
        return {
            pricing_code: null,
            matrix_code: null,
            code: null,
            id: null,
            product_id: null,
            season_id: null,
            unit_id: null,
            matrix_id: null,
            variant_id: 0,
            name: null,
            mon: null,
            tue: null,
            wed: null,
            thu: null,
            fri: null,
            sat: null,
            sun: null,
            monMargin: null,
            tueMargin: null,
            wedMargin: null,
            thuMargin: null,
            friMargin: null,
            satMargin: null,
            sunMargin: null,
            count: 1,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const set = function (pricing) {
        let detail = defaultDetail()
        if (pricing) {
            //console.log(pricing)
            detail.pricing_code = (pricing.pricing_code) ? pricing.pricing_code : null
            detail.matrix_code = (pricing.matrix_code) ? pricing.matrix_code : null
            detail.code = (pricing.code) ? pricing.code : null
            detail.id = (pricing.id) ? pricing.id : null
            detail.product_id = (pricing.product_id) ? pricing.id : null
            detail.season_id = (pricing.season_id) ? pricing.id : null
            detail.unit_id = (pricing.unit_id) ? pricing.id : null
            detail.matrix_id = (pricing.matrix_id) ? pricing.matrix_id : null
            detail.variant_id = (pricing.variant_id) ? pricing.variant_id : null
            detail.name = (pricing.name) ? pricing.name : null
            detail.mon = (pricing.mon) ? pricing.mon : null
            detail.tue = (pricing.tue) ? pricing.tue : null
            detail.wed = (pricing.wed) ? pricing.wed : null
            detail.thu = (pricing.thu) ? pricing.thu : null
            detail.fri = (pricing.fri) ? pricing.fri : null
            detail.sat = (pricing.sat) ? pricing.sat : null
            detail.sun = (pricing.sun) ? pricing.sun : null
            detail.monMargin = (pricing.monMargin) ? pricing.monMargin : null
            detail.tueMargin = (pricing.tueMargin) ? pricing.tueMargin : null
            detail.wedMargin = (pricing.wedMargin) ? pricing.wedMargin : null
            detail.thuMargin = (pricing.thuMargin) ? pricing.thuMargin : null
            detail.friMargin = (pricing.friMargin) ? pricing.friMargin : null
            detail.satMargin = (pricing.satMargin) ? pricing.satMargin : null
            detail.sunMargin = (pricing.sunMargin) ? pricing.sunMargin : null
            detail.count = (pricing.count) ? pricing.count : null
            detail.enabled = (pricing.enabled) ? pricing.enabled : 1
            detail.date_created = (pricing.date_created) ? pricing.date_created : formatDateMySQL()
            detail.created_by = (pricing.created_by) ? pricing.created_by : user_id
            detail.date_modified = (pricing.date_modified) ? pricing.date_modified : formatDateMySQL()
            detail.modified_by = (pricing.modified_by) ? pricing.modified_by : user_id
            detail.note = (pricing.note) ? pricing.note : null
        }
        //console.log("   detail", detail)
        Pricing.detail = detail
        return detail
    }
    
    return {
        all: new Map(),
        init: function (settings) {
            init(settings)
        },
        set: function (pricing) {
            return set(pricing)
        },
        resetForm: function () {
            resetForm()
        },
        loadProfileDropdown: function () {
            loadProfileDropdown()
        },
    }
    
})()

const Matrix = (function () {
    "use strict"
    
    let matrix_cost, matrix_margin, matrix_price
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const defaultDetail = function () {
        return {
            been_saved: 0,
            cost: 0,
            created_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            enabled: 1,
            has_pricing: 0,
            id: null,
            margin: 0,
            code: null,
            modified_by: user_id,
            note: null,
            price: 0,
            pricings: new Map(),
            product_id: null,
            season_id: null,
            unit_id: null,
        }
    }
    
    const set = function (matrix) {
        
        let matrixPricings
        let detail = defaultDetail()
        if (matrix) {
            detail.been_saved = (matrix.been_saved) ? matrix.been_saved : 0
            detail.cost = (matrix.cost) ? matrix.cost : null
            detail.created_by = (matrix.created_by) ? matrix.created_by : user_id
            detail.date_created = (matrix.date_created) ? matrix.date_created : formatDateMySQL()
            detail.date_modified = (matrix.date_modified) ? matrix.date_modified : formatDateMySQL()
            detail.enabled = (matrix.enabled) ? matrix.enabled : 1
            detail.has_pricing = (matrix.has_pricing) ? matrix.has_pricing : null
            detail.id = (matrix.id) ? matrix.id : null
            detail.margin = (matrix.margin) ? matrix.margin : null
            detail.code = (matrix.code) ? matrix.code : null
            detail.modified_by = (matrix.modified_by) ? matrix.modified_by : user_id
            detail.note = (matrix.note) ? matrix.note : null
            detail.price = (matrix.price) ? matrix.price : null
            detail.product_id = (matrix.product_id) ? matrix.product_id : null
            detail.season_id = (matrix.season_id) ? matrix.season_id : null
            detail.unit_id = (matrix.unit_id) ? matrix.unit_id : null
            /*
            //console.log("matrix.pricings", matrix.pricings)
            if (matrix.pricings && typeof matrix.pricings == "object") {
                let pricings = (matrix.pricings && typeof matrix.pricings == "object") ? matrix.pricings : []
                //console.log("pricings", pricings)
                matrixPricings = new Map()
                $.each(pricings, function (k, pricing) {
                    //console.log("pricing", pricing)
                    let formattedPricing = {
                        code: pricing.pricing_code,
                        pricing_code: pricing.pricing_code,
                        matrix_code: pricing.matrix_code,
                        product_id: pricing.product_id,
                        season_id: pricing.season_id,
                        unit_id: pricing.unit_id,
                        matrix_id: pricing.matrix_id,
                        variant_id: pricing.variant_id,
                        name: pricing.name,
                        mon: pricing.mon,
                        tue: pricing.tue,
                        wed: pricing.wed,
                        thu: pricing.thu,
                        fri: pricing.fri,
                        sat: pricing.sat,
                        sun: pricing.sun,
                        monMargin: pricing.monMargin,
                        tueMargin: pricing.tueMargin,
                        wedMargin: pricing.wedMargin,
                        thuMargin: pricing.thuMargin,
                        friMargin: pricing.friMargin,
                        satMargin: pricing.satMargin,
                        sunMargin: pricing.sunMargin,
                        count: pricing.count,
                        enabled: pricing.enabled,
                        date_created: pricing.date_created,
                        created_by: pricing.created_by,
                        date_modified: pricing.date_modified,
                        modified_by: pricing.modified_by,
                        note: pricing.note,
                    }
                    
                    let pricingDetail = Pricing.set(formattedPricing)
                    
                    matrixPricings.set(pricingDetail.pricing_code, pricingDetail)
                })
                
                detail.pricings = matrixPricings
            }
            //*/
        }
        Matrix.detail = detail
        return detail
    }
    
    const loadAll = function (matrices) {
        //console.log("Matrix.loadAll(matrices)", matrices)
        // ----
        
        Matrix.all = new Map()
        if (!matrices) {
            matrices = []
        }
        
        //Pricing.all = new Map()
        $.each(matrices, function (k, matrix) {
            //console.log("matrix", matrix)
            let detail = set(matrix)
            let id = matrix.code
            
            /*
            let pricingsMap = new Map()
            if (matrix.pricings) {
                let pricings = matrix.pricings
                $.each(pricings, function (k, pricing) {
                    let pricingDetail = Pricing.set(pricing)
                    let pricingCode = (pricing.pricing_code) ? pricing.pricing_code : null
                    pricingsMap.set(pricingCode, pricingDetail)
                    Pricing.all.set(pricingCode, pricingDetail)
                })
            }
            detail.pricings = pricingsMap
            //*/
            Matrix.all.set(id, detail)
        })
        
    }
    
    const init = function (settings) {
        let matrices = []
        if (settings) {
            if (settings.matrices) {
                matrices = settings.matrices
            }
        }
        loadAll(matrices)
        buildMatrixForm()
    }
    
    const buildMatrixForm = function () {
        
        matrix_cost = document.getElementsByName("matrix_cost")
        matrix_price = document.getElementsByName("matrix_price")
        matrix_margin = document.getElementsByName("matrix_margin")
        matrix_cost.forEach(el => el.addEventListener("keyup", event => {
            let matrix_id = el.dataset.matrixid
            //console.log("matrix_cost", el.value)
            //console.log("matrix_cost", matrix_id)
        }))
        
        matrix_price.forEach(el => el.addEventListener("keyup", event => {
            let matrix_id = el.dataset.matrixid
            //console.log("matrix_price", el.value)
            //console.log("matrix_price", matrix_id)
        }))
        
        matrix_margin.forEach(el => el.addEventListener("keyup", event => {
            let matrix_id = el.dataset.matrixid
            //console.log("matrix_margin", el.value)
            //console.log("matrix_margin", matrix_id)
        }))
        
    }
    
    const loadPerUnitForm = function () {
        //console.log("Matrix.loadPerUnitForm()", Matrix)
        // ----
        
    }
    
    const loadPerPersonForm = function () {
        //console.log("Matrix.loadPerPersonForm()", Matrix)
        // ----
        
    }
    
    const loadPerDayForm = function () {
        //console.log("Matrix.loadPerDayForm()", Matrix)
        // ----
        
    }
    
    return {
        detail: {},
        all: new Map(),
        set: function (matrix) {
            return set(matrix)
        },
        init: function (settings) {
            init(settings)
        },
        buildMatrixForm: function () {
            buildMatrixForm()
        },
        loadPerUnitForm: function () {
            loadPerUnitForm()
        },
        loadPerPersonForm: function () {
            loadPerPersonForm()
        },
        loadPerDayForm: function () {
            loadPerDayForm()
        },
    }
    
})()

const PricingStrategyTypes = (function () {
    "use strict"
    
    const base_url = "/pricing_strategy_types"
    const _input_pricing_strategy_types_id = document.getElementById("input_pricing_strategy_types_id")
    const _input_pricing_strategy_types_name = document.getElementById("input_pricing_strategy_types_name")
    const _input_pricing_strategy_types_enabled = document.getElementById("input_pricing_strategy_types_enabled")
    const _input_pricing_strategy_types_date_created = document.getElementById("input_pricing_strategy_types_date_created")
    const _input_pricing_strategy_types_created_by = document.getElementById("input_pricing_strategy_types_created_by")
    const _input_pricing_strategy_types_date_modified = document.getElementById("input_pricing_strategy_types_date_modified")
    const _input_pricing_strategy_types_modified_by = document.getElementById("input_pricing_strategy_types_modified_by")
    const _input_pricing_strategy_types_note = document.getElementById("input_pricing_strategy_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_pricing_strategy_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(' -- PricingStrategyTypes -- ', {})
    }
    
    const set = function (pricing_strategy_types) {
        let detail = _default_detail()
        if (pricing_strategy_types) {
            detail.id = (pricing_strategy_types.id) ? pricing_strategy_types.id : null
            detail.name = (pricing_strategy_types.name) ? pricing_strategy_types.name : null
            detail.enabled = (pricing_strategy_types.enabled) ? pricing_strategy_types.enabled : 1
            detail.date_created = (pricing_strategy_types.date_created) ? pricing_strategy_types.date_created : formatDateMySQL()
            detail.created_by = (pricing_strategy_types.created_by) ? pricing_strategy_types.created_by : created_by
            detail.date_modified = (pricing_strategy_types.date_modified) ? pricing_strategy_types.date_modified : formatDateMySQL()
            detail.modified_by = (pricing_strategy_types.modified_by) ? pricing_strategy_types.modified_by : modified_by
            detail.note = (pricing_strategy_types.note) ? pricing_strategy_types.note : null
        }
        
        PricingStrategyTypes.detail = detail
        return detail
    }
    
    const load_all = function (pricing_strategy_types) {
        PricingStrategyTypes.all = new Map()
        
        if (!pricing_strategy_types) {
            return
        }
        $.each(pricing_strategy_types, function (i, pricing_strategy_types) {
            let detail = set(pricing_strategy_types)
            PricingStrategyTypes.all.set("id", detail)
        })
        
        //console.log(" PricingStrategyTypes.all", PricingStrategyTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

PricingStrategyTypes.init()
//end object

const RatingTypes = (function () {
    "use strict"
    
    const base_url = "/rating_types"
    const _input_rating_types_id = document.getElementById("input_rating_types_id")
    const _input_rating_types_name = document.getElementById("input_rating_types_name")
    const _input_rating_types_enabled = document.getElementById("input_rating_types_enabled")
    const _input_rating_types_date_created = document.getElementById("input_rating_types_date_created")
    const _input_rating_types_created_by = document.getElementById("input_rating_types_created_by")
    const _input_rating_types_date_modified = document.getElementById("input_rating_types_date_modified")
    const _input_rating_types_modified_by = document.getElementById("input_rating_types_modified_by")
    const _input_rating_types_note = document.getElementById("input_rating_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_rating_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(" -- RatingTypes -- ", {})
    }
    
    const set = function (rating_types) {
        let detail = _default_detail()
        if (rating_types) {
            detail.id = (rating_types.id) ? rating_types.id : null
            detail.name = (rating_types.name) ? rating_types.name : null
            detail.enabled = (rating_types.enabled) ? rating_types.enabled : 1
            detail.date_created = (rating_types.date_created) ? rating_types.date_created : formatDateMySQL()
            detail.created_by = (rating_types.created_by) ? rating_types.created_by : created_by
            detail.date_modified = (rating_types.date_modified) ? rating_types.date_modified : formatDateMySQL()
            detail.modified_by = (rating_types.modified_by) ? rating_types.modified_by : modified_by
            detail.note = (rating_types.note) ? rating_types.note : null
        }
        
        RatingTypes.detail = detail
        return detail
    }
    
    const load_all = function (rating_types) {
        RatingTypes.all = new Map()
        
        if (!rating_types) {
            return
        }
        $.each(rating_types, function (i, rating_types) {
            let detail = set(rating_types)
            RatingTypes.all.set("id", detail)
        })
        
        //console.log(" RatingTypes.all", RatingTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

//RatingTypes.init()
//end object

const SalesTypes = (function () {
    "use strict"
    
    const base_url = "/sales_types"
    const _input_sales_types_id = document.getElementById("input_sales_types_id")
    const _input_sales_types_name = document.getElementById("input_sales_types_name")
    const _input_sales_types_class = document.getElementById("input_sales_types_class")
    const _input_sales_types_sort_order = document.getElementById("input_sales_types_sort_order")
    const _input_sales_types_enabled = document.getElementById("input_sales_types_enabled")
    const _input_sales_types_date_created = document.getElementById("input_sales_types_date_created")
    const _input_sales_types_created_by = document.getElementById("input_sales_types_created_by")
    const _input_sales_types_date_modified = document.getElementById("input_sales_types_date_modified")
    const _input_sales_types_modified_by = document.getElementById("input_sales_types_modified_by")
    const _input_sales_types_note = document.getElementById("input_sales_types_note")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handle_sales_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const _default_detail = function () {
        return {
            id: null,
            name: null,
            class: null,
            sort_order: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log(" -- SalesTypes -- ", {})
    }
    
    const set = function (sales_types) {
        let detail = _default_detail()
        if (sales_types) {
            detail.id = (sales_types.id) ? sales_types.id : null
            detail.name = (sales_types.name) ? sales_types.name : null
            detail.class = (sales_types.class) ? sales_types.class : null
            detail.sort_order = (sales_types.sort_order) ? sales_types.sort_order : null
            detail.enabled = (sales_types.enabled) ? sales_types.enabled : 1
            detail.date_created = (sales_types.date_created) ? sales_types.date_created : formatDateMySQL()
            detail.created_by = (sales_types.created_by) ? sales_types.created_by : created_by
            detail.date_modified = (sales_types.date_modified) ? sales_types.date_modified : formatDateMySQL()
            detail.modified_by = (sales_types.modified_by) ? sales_types.modified_by : modified_by
            detail.note = (sales_types.note) ? sales_types.note : null
        }
        
        SalesTypes.detail = detail
        return detail
    }
    
    const load_all = function (sales_types) {
        SalesTypes.all = new Map()
        
        if (!sales_types) {
            return
        }
        $.each(sales_types, function (i, sales_types) {
            let detail = set(sales_types)
            SalesTypes.all.set("id", detail)
        })
        
        //console.log(" SalesTypes.all", SalesTypes.all)
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            load_all(params)
        },
        save: function (params) {
            save(params)
        },
        init: function () {
            init()
        },
    }
    
})()

//SalesTypes.init()
//end object

const StatusTypes = (function () {
    "use strict"
    
    const base_url = "/status_types"
    const _input_status_types_id = document.getElementById("input_status_types_id")
    const _input_status_types_name = document.getElementById("input_status_types_name")
    const _input_status_types_enabled = document.getElementById("input_status_types_enabled")
    const _input_status_types_date_created = document.getElementById("input_status_types_date_created")
    const _input_status_types_created_by = document.getElementById("input_status_types_created_by")
    const _input_status_types_date_modified = document.getElementById("input_status_types_date_modified")
    const _input_status_types_modified_by = document.getElementById("input_status_types_modified_by")
    const _input_status_types_note = document.getElementById("input_status_types_note")
    const _input_status_types_sort_order = document.getElementById("input_status_types_sort_order")
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    const handleStatusTypesError = function (msg) {
        toastr.error(msg)
    }
    
    const defaultDetail = function () {
        return {
            id: null,
            name: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            sort_order: null,
        }
    }
    
    const save = function (params) {
    
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
        
    }
    
    const init = function (settings) {
        //console.log("StatusTypes.init(settings)", settings)
        if (settings) {
            if (settings.status_types) {
                loadAll(settings.status_types)
                buildDropdown()
            }
        }
    }
    
    const loadAll = function (statusTypes) {
        //console.log("StatusTypes.loadAll(settings)", statusTypes)
        StatusTypes.all = new Map()
        
        if (statusTypes) {
            $.each(statusTypes, function (k, statusType) {
                let detail = set(statusType)
                //console.log("detail", detail)
                if (detail.id) {
                    StatusTypes.all.set(detail.id, detail)
                }
            })
        }
    }
    
    const buildDropdown = function (statusTypeId) {
        //console.log("StatusTypes.buildDropdown(statusTypeId)", statusTypeId)
        let selected = ""
        if (statusTypeId) {
            selected = statusTypeId
        }
        
        let statusTypes = Array.from(StatusTypes.all.values())
        //console.log("|__ statusTypes", statusTypes)
    }
    
    const set = function (status_types) {
        //console.log("StatusTypes.set(status_types)", status_types)
        let detail = defaultDetail()
        if (status_types) {
            detail.id = (status_types.id) ? status_types.id : null
            detail.name = (status_types.name) ? status_types.name : null
            detail.enabled = (status_types.enabled) ? status_types.enabled : 1
            detail.date_created = (status_types.date_created) ? status_types.date_created : formatDateMySQL()
            detail.created_by = (status_types.created_by) ? status_types.created_by : created_by
            detail.date_modified = (status_types.date_modified) ? status_types.date_modified : formatDateMySQL()
            detail.modified_by = (status_types.modified_by) ? status_types.modified_by : modified_by
            detail.note = (status_types.note) ? status_types.note : null
            detail.sort_order = (status_types.sort_order) ? status_types.sort_order : null
        }
        
        StatusTypes.detail = detail
        return detail
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        get: function (params) {
            get(params)
        },
        load_all: function (params) {
            loadAll(params)
        },
        save: function (params) {
            save(params)
        },
        init: function (settings) {
            init(settings)
        },
    }
    
})()

//StatusTypes.init()
//end object

const Types = (function () {
    "use strict"
    const base_url = "/types"
    // ----
    
    const handle_types_error = function (msg) {
        toastr.error(msg)
    }
    
    const setType = function (types, types_name) {
        $.each(types, function (k, type) {
            Types[types_name].set(type.id, type)
        })
    }
    
    const init = function (settings) {
        Types.address_types = new Map()
        Types.allot_by = new Map()
        Types.airport_types = new Map()
        Types.categories_ratings_types = new Map()
        Types.category = new Map()
        Types.color_scheme = new Map()
        Types.contact_types = new Map()
        Types.currency = new Map()
        Types.location_types = new Map()
        Types.message_types = new Map()
        Types.pricing_strategy_types = new Map()
        Types.rating_types = new Map()
        Types.sales_types = new Map()
        Types.status_types = new Map()
        Country.all = new Map()
        // ----
        if (settings.address_types) {
            setType(settings.address_types, "address_types")
        }
        
        if (settings.season_types) {
            setType(settings.season_types, "season_types")
            Season.init({
                seasons: settings.season_types,
            })
        }
        
        if (settings.airport_types) {
            setType(settings.airport_types, "airport_types")
        }
        
        if (settings.category) {
            setType(settings.category, "category")
            Category.init({
                categories: settings.category,
            })
            
        }
        
        if (settings.color_scheme) {
            setType(settings.color_scheme, "color_scheme")
        }
        
        if (settings.contact_types) {
            setType(settings.contact_types, "contact_types")
        }
        
        if (settings.currency) {
            setType(settings.currency, "currency")
        }
        
        if (settings.location_types) {
            setType(settings.location_types, "location_types")
        }
        
        if (settings.message_types) {
            setType(settings.message_types, "message_types")
        }
        
        if (settings.pricing_strategy_types) {
            setType(settings.pricing_strategy_types, "pricing_strategy_types")
        }
        
        if (settings.rating_types) {
            setType(settings.rating_types, "rating_types")
        }
        
        if (settings.sales_types) {
            setType(settings.sales_types, "sales_types")
        }
        
        if (settings.status_types) {
            //console.log(settings.status_types)
            setType(settings.status_types, "status_types")
            StatusTypes.init({ status_types: settings.status_types })
        }
        
        if (settings.allot_by) {
            setType(settings.allot_by, "allot_by")
        }
        
        if (settings.countries) {
            Country.load_all(settings.countries)
        }
        
    }
    
    return {
        allot_by: new Map(),
        address_types: new Map(),
        season_types: new Map(),
        airport_types: new Map(),
        categories_ratings_types: new Map(),
        category: new Map(),
        color_scheme: new Map(),
        contact_types: new Map(),
        currency: new Map(),
        location_types: new Map(),
        message_types: new Map(),
        pricing_strategy_types: new Map(),
        rating_types: new Map(),
        sales_types: new Map(),
        status_types: new Map(),
        
        init: function (settings) {
            if (settings) {
                init(settings)
            }
        },
    }
    
})()

const Login = (function () {
    "use strict"
    const _user_email = document.getElementById("dataToSend")
    const _email = document.getElementById("email")
    const _password = document.getElementById("password")
    const _button_login_submit = document.getElementById("button_login_submit")
    const _button_login_register = document.getElementById("button_login_register")
    const _form_login = document.getElementById("form_login")
    const _register_form_submit_button = document.getElementById("register_form_submit_button")
    const _register_page_form = document.getElementById("register_page_form")
    const _register_page = document.getElementById("register_page")
    
    const validate_form = function (_form, _rules) {
        Login.validator = validator_init(_rules)
        return $(_form).valid()
    }
    
    const route = function (settings) {
        if (_form_login) {
            Login.login(settings)
        }
        
        if (_register_page) {
            Login.register(settings)
        }
    }
    
    const login = function (settings) {
        let form_rules = {
            rules: {
                email: {
                    required: true,
                    email: true,
                },
                password: {
                    required: true,
                },
            },
            messages: {
                email: {
                    required: "Field Required",
                    email: "Field invalid",
                },
                password: {
                    required: "Field Required",
                },
            },
        }
        
        Login.validator = validator_init(form_rules)
        
        $(_button_login_register)
            .on("click", function () {
            
            })
        
        $(_button_login_submit)
            .on("click", function () {
                submit_login()
            })
        
        const handle_login_error = function (msg) {
            toastr.error(msg)
        }
        
        const send_login = function (dataToSend) {
            if (dataToSend) {
                try {
                    sendPostRequest("/api/v1.0/users/login", dataToSend, function (data, status, xhr) {
                        //console.log("data", data.id)
                        if (data && data.id) {
                            if (data.id) {
                                window.location.replace("/")
                            }
                        } else {
                            return handle_login_error("Error Logging In: 1")
                        }
                    })
                } catch (e) {
                    //console.error("Error", e)
                    return handle_login_error("Error: 2")
                }
            } else {
                return handle_login_error("Error: 3")
            }
        }
        
        const submit_login = function () {
            if (validate_form(_form_login, form_rules)) {
                let dataToSend = {
                    email: _email.value,
                    password: _password.value,
                }
                send_login(remove_nulls(dataToSend))
            }
        }
    }
    
    const register = function (settings) {
        let form_rules_register = {
            rules: {
                user_name_first: {
                    required: true,
                },
                user_name_last: {
                    required: true,
                },
                user_email: {
                    required: true,
                    email: true,
                },
                user_password: {
                    required: true,
                    minlength: 5,
                },
                user_password_confirm: {
                    required: true,
                    minlength: 5,
                    equalTo: "#user_password",
                },
            },
            messages: {
                user_name_first: {
                    required: "Field Required",
                },
                user_name_last: {
                    required: "Field Required",
                },
                user_email: {
                    required: "Field Required",
                    email: "Field invalid",
                },
                user_password: {
                    required: "Field Required",
                },
            },
        }
        
        const _user_name_first = document.getElementById("user_name_first")
        const _user_name_last = document.getElementById("user_name_last")
        const _user_email = document.getElementById("user_email")
        const _user_password = document.getElementById("user_password")
        
        Login.validator = validator_init(form_rules_register)
        
        $(_register_form_submit_button)
            .on("click", function () {
                submit_register()
            })
        
        const submit_register = function () {
            if (validate_form(_register_page_form, form_rules_register)) {
                let dataToSend = {
                    name_first: _user_name_first.value,
                    name_last: _user_name_last.value,
                    email: _user_email.value,
                    password: _user_password.value,
                }
                
                send_register(remove_nulls(dataToSend))
            }
        }
        
        const send_register = function (dataToSend) {
            //console.log("Login.register->send_register", dataToSend)
            if (dataToSend) {
                try {
                    sendPostRequest("/api/v1.0/users/register", dataToSend, function (data, status, xhr) {
                        //console.log("data", data.id)
                        if (data && data.id) {
                            if (data.id) {
                                window.location.replace("/")
                            }
                        } else {
                            return handle_login_error("Error Logging In: 1")
                        }
                    })
                } catch (e) {
                    //console.error("Error", e)
                    return handle_login_error("Error: 2")
                }
            } else {
                return handle_login_error("Error: 3")
            }
        }
    }
    
    return {
        detail: {},
        all: new Map(),
        validator: null,
        init: function (settings) {
            route(settings)
        },
        login: function (settings) {
            login(settings)
        },
        register: function (settings) {
            register(settings)
        },
    }
})()
Login.init()

const Provider = (function () {
    "use strict"
    
    const base_url = "/providers"
    const _modal_product_category_id = document.getElementById("modal_product_category_id")
    const _button_add_provider_page_heading = document.getElementById("button_add_provider_page_heading")
    const _button_edit_provider_name = document.getElementById("button_edit_provider_name")
    const _button_save_provider = document.getElementById("button_save_provider")
    const _panel_tab_contact = document.getElementById("panel_tab_contact")
    const _panel_tab_vendor = document.getElementById("panel_tab_vendor")
    const _panel_tab_address = document.getElementById("panel_tab_address")
    const _panel_tab_provider = document.getElementById("panel_tab_provider")
    const _table_provider_index = document.getElementById("table_provider_index")
    const _location_id = document.getElementById("location_id")
    const _company_name = document.getElementById("company_name")
    const _provider_id = document.getElementById("provider_id")
    const _provider_name = document.getElementById("provider_name")
    const _provider_company_id = document.getElementById("provider_company_id")
    const _provider_enabled = document.getElementById("provider_enabled")
    const _provider_code_direct_id = document.getElementById("provider_code_direct_id")
    const _vendor_name = document.getElementById("vendor_name")
    const _vendor_company_id = document.getElementById("vendor_company_id")
    const _company_id = document.getElementById("company_id")
    const _location_name_filter_id = document.getElementById("location_name_filter_id")
    const _form_edit_provider = document.getElementById("form_edit_provider")
    const _form_product_add = document.getElementById("form_product_add")
    const _modal_product_provider_name = document.getElementById("modal_product_provider_name")
    const _modal_product_provider_id = document.getElementById("modal_product_provider_id")
    const _modal_product_vendor_id = document.getElementById("modal_product_vendor_id")
    const _modal_product_vendor_name = document.getElementById("modal_product_vendor_name")
    const _modal_product_vendor_company_id = document.getElementById("modal_product_vendor_company_id")
    const _modal_product_provider_company_id = document.getElementById("modal_product_provider_company_id")
    const _modal_product_provider_vendor_match = document.getElementById("modal_product_provider_vendor_match")
    const _modal_product_provider_location_id = document.getElementById("modal_product_provider_location_id")
    const _modal_product_location_id = document.getElementById("modal_product_location_id")
    const _product_edit_details_section_provider_form = document.getElementById("product_edit_details_section_provider_form")
    const _product_edit_details_section_provider_form_filter = document.getElementById("product_edit_details_section_provider_form_filter")
    const _product_edit_details_section_provider_form_provider_id = document.getElementById("product_edit_details_section_provider_form_provider_id")
    const _product_edit_details_section_provider_form_submit_button = document.getElementById("product_edit_details_section_provider_form_submit_button")
    const _product_edit_details_section_provider_form_provider_company_id = document.getElementById("product_edit_details_section_provider_form_provider_company_id")
    const _product_edit_details_section_provider_form_details = document.getElementById("product_edit_details_section_provider_form_details")
    const _product_edit_details_section_provider_form_provider_name = document.getElementById("product_edit_details_section_provider_form_provider_name")
    const _product_edit_details_section_provider_form_provider_phone_1 = document.getElementById("product_edit_details_section_provider_form_provider_phone_1")
    const _product_edit_details_section_provider_form_provider_phone_2 = document.getElementById("product_edit_details_section_provider_form_provider_phone_2")
    const _product_edit_details_section_provider_form_provider_fax = document.getElementById("product_edit_details_section_provider_form_provider_fax")
    const _product_edit_details_section_provider_form_provider_website = document.getElementById("product_edit_details_section_provider_form_provider_website")
    const _product_edit_details_section_provider_form_provider_email = document.getElementById("product_edit_details_section_provider_form_provider_email")
    const _product_edit_details_section_provider_form_provider_cover_image = document.getElementById("product_edit_details_section_provider_form_provider_cover_image")
    const _product_edit_details_section_provider_form_provider_enabled = document.getElementById("product_edit_details_section_provider_form_provider_enabled")
    const _product_edit_details_section_provider_form_provider_note = document.getElementById("product_edit_details_section_provider_form_provider_note")
    const _product_edit_details_section_provider_form_provider_keywords = document.getElementById("product_edit_details_section_provider_form_provider_keywords")
    const _product_edit_details_section_provider_form_provider_description_long = document.getElementById("product_edit_details_section_provider_form_provider_description_long")
    const _product_edit_details_section_provider_form_provider_description_short = document.getElementById("product_edit_details_section_provider_form_provider_description_short")
    const _product_edit_details_section_provider_form_provider_logo = document.getElementById("product_edit_details_section_provider_form_provider_logo")
    const _product_edit_details_section_provider_form_cancel_button = document.getElementById("product_edit_details_section_provider_form_cancel_button")
    const _provider_keywords = document.getElementById("provider_keywords")
    const _product_edit_details_section_provider_form_reset_button = document.getElementById("product_edit_details_section_provider_form_reset_button")
    const _product_edit_provider_panel_link_product = document.getElementById("product_edit_provider_panel_link_product")
    const _display_provider_name = document.getElementById("display_provider_name")
    const _display_provider_code_direct = document.getElementById("display_provider_code_direct")
    const _product_edit_details_section_provider_form_edit_button = document.getElementById("product_edit_details_section_provider_form_edit_button")
    
    let $provider_keywords, tempProvider, validator
    let globalSelectedProvider, isNew = false
    let $index_table = $(_table_provider_index)
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let formRules = {
        rules: {
            provider_name: {
                required: true,
            },
            provider_company_id: {
                required: true,
            },
        },
        messages: {
            provider_company_id: {
                required: "Field Required",
            },
            provider_name: {
                required: "Field Required",
            },
        },
    }
    
    $(_product_edit_details_section_provider_form_edit_button)
        .on("click", function () {
            //console.log("Provider.product_edit_details_section_provider_form_reset_button:click()")
            openProductEditProviderForm()
        })
    
    $(_product_edit_details_section_provider_form_reset_button)
        .on("click", function () {
            //console.log("Provider.product_edit_details_section_provider_form_reset_button:click()")
            let detail = set()
            
            resetProductEditProviderForm(detail)
        })
    
    $(_product_edit_details_section_provider_form_submit_button)
        .on("click", function () {
            //console.log("Provider.product_edit_details_section_provider_form_submit_button:click()")
            
        })
    
    $(_product_edit_provider_panel_link_product)
        .on("click", function () {
            //console.log("Provider.product_edit_provider_panel_link_product:click()")
            openProductEditProviderForm()
        })
    $(_product_edit_details_section_provider_form_cancel_button)
        .on("click", function () {
            //console.log("Provider.product_edit_details_section_provider_form_cancel_button:click()")
            populateProductEditProviderForm(tempProvider)
            closeProductEditProviderForm()
        })
    
    $(_button_save_provider)
        .on("click", function () {
            let tabs = $("#provider_edit_tabs > li.nav-item > a.nav-link")
            let panels = $("div.tab-pane")
            let company_detail = Company.build()
            let provider_detail = Provider.build()
            let location_detail = Location.build()
            let vendor_detail = Vendor.build()
            let addresses = Array.from(Address.all.values())
            let contacts = Array.from(Contact.all.values())
            
            if (!company_detail || !provider_detail || !location_detail || !vendor_detail || !addresses || !contacts) {
                $.each(panels, function (index, item) {
                    if ($(this).find(".is-invalid").length > 0) {
                        let nav_tab = $("body").find("[aria-controls='" + $(this).attr("id") + "']")
                        tabs.removeClass("active")
                        panels.removeClass("active")
                        $(this).addClass("active")
                        nav_tab.addClass("active")
                        return false
                    }
                })
                return
            }
            
            provider_detail.location_id = (location_detail.id) ? location_detail.id : null
            vendor_detail.is_provider = (_form_edit_provider) ? 1 : 0
            
            // ----
            
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    save({
                        "company_detail": company_detail,
                        "provider_detail": provider_detail,
                        "location_detail": location_detail,
                        "vendor_detail": vendor_detail,
                        "addresses": addresses,
                        "contacts": contacts,
                    })
                }
                
            })
        })
    
    $("#provider_edit")
        .on("change", function () {
            setProgress()
        })
    
    $(_provider_company_id)
        .on("change", function () {
            $(_vendor_company_id).val($(this).val())
        })
    
    $(_button_add_provider_page_heading)
        .on("click", function () {
            //console.log("test")
        })
    
    $(_button_edit_provider_name)
        .on("click", function () {
            enable_form_fields()
        })
    
    $(_company_id)
        .on("change", function () {
            $(_provider_company_id).val(_company_id.value)
        })
    
    const getImages = function (dataToSend, callback) {
        //console.log("Provider.getImages(dataToSend)", dataToSend)
        if (dataToSend) {
            if (dataToSend.type && dataToSend.id) {
                let id = (!isNaN(parseInt(dataToSend.id))) ? parseInt(dataToSend.id) : null
                let type = (dataToSend.type) ? dataToSend.type : null
                if (type && id) {
                    let url = `/api/v1.0/images/src/company/${id}`
                    try {
                        sendGetRequest(url, dataToSend, function (data, status, xhr) {
                            if (data) {
                                return callback(data)
                            } else {
                                return handleProviderError("Error", "Product", "error")
                            }
                        })
                    } catch (e) {
                        //console.log("error", e)
                        return handleProviderError("Error", "Provider", "error")
                    }
                }
            }
        }
    }
    
    const regex = /[^A-Za-z0-9]/g
    
    const renderImageDropDown = function (images) {
        //console.log("Provider.renderImageDropDown(images)", images)
        let initValue = "/public/img/placeholder.jpg".replace(regex, "")
        let options = `<option value="${initValue}" readonly selected>-- Images --</options>`
        
        if (!images) {
            images = []
        }
        
        $.each(images, function (k, image) {
            //console.log("|__ image", image)
            let value = `${image.path}/${image.name}.${image.extension}`
            let newStr = value.replace(regex, "")
            let name = image.name
            //console.log("|__ value", value)
            options += `<option value="${newStr}">${name}</options>`
        })
        
        if (_product_edit_details_section_provider_form_provider_logo) {
            $(_product_edit_details_section_provider_form_provider_logo).empty().html(options)
        }
        if (_product_edit_details_section_provider_form_provider_cover_image) {
            $(_product_edit_details_section_provider_form_provider_cover_image).empty().html(options)
        }
        
    }
    
    const buildImageDropdown = function (id) {
        //console.log("Provider.buildImageDropdown(id)", id)
        
        if (id) {
            if (_product_edit_details_section_provider_form_provider_cover_image) {
                let dataToSend = {
                    type: "company",
                    id: id,
                }
                
                getImages(dataToSend, function (data) {
                    if (data) {
                        renderImageDropDown(data)
                    }
                })
                
            }
        }
    }
    
    const populateProductEditProviderForm = function (provider) {
        //console.log("Provider.populateProductEditProviderForm(provider)", provider)
        let detail = set(provider)
        let keywords = (detail.keywords) ? detail.keywords : []
        let coverImage = (detail.company.cover_image) ? detail.company.cover_image : "/public/img/placeholder.jpg"
        let logoImage = (detail.company.logo) ? detail.company.logo : "/public/img/placeholder.jpg"
        let companyName = (detail.company.name) ? detail.company.name : null
        let codeDirectId = (provider.code_direct_id) ? provider.code_direct_id : null
        
        logoImage = logoImage.replace(regex, "")
        coverImage = coverImage.replace(regex, "")
        
        //console.log("|__ coverImage", coverImage)
        //console.log("|__ logoImage", logoImage)
        //console.log("|__ Provider.detail", Provider.detail)
        
        _product_edit_details_section_provider_form_filter.value = (provider.company.name) ? provider.company.name : null
        _product_edit_details_section_provider_form_provider_id.value = (provider.id) ? provider.id : null
        _product_edit_details_section_provider_form_provider_company_id.value = (provider.company_id) ? provider.company_id : null
        _product_edit_details_section_provider_form_provider_name.value = (provider.company.name) ? provider.company.name : null
        _product_edit_details_section_provider_form_provider_phone_1.value = (provider.company.phone_1) ? provider.company.phone_1 : null
        _product_edit_details_section_provider_form_provider_phone_2.value = (provider.company.phone_2) ? provider.company.phone_2 : null
        _product_edit_details_section_provider_form_provider_fax.value = (provider.company.fax) ? provider.company.fax : null
        _product_edit_details_section_provider_form_provider_website.value = (provider.company.website) ? provider.company.website : null
        _product_edit_details_section_provider_form_provider_email.value = (provider.company.email) ? provider.company.email : null
        _product_edit_details_section_provider_form_provider_description_long.value = (provider.description_long) ? provider.description_long : null
        _product_edit_details_section_provider_form_provider_description_short.value = (provider.description_short) ? provider.description_short : null
        _product_edit_details_section_provider_form_provider_enabled.checked = (provider.enabled && provider.enabled === 1)
        
        _product_edit_details_section_provider_form_provider_cover_image.value = coverImage.toString()
        _product_edit_details_section_provider_form_provider_logo.value = logoImage.toString()
        
        $provider_keywords = $(_provider_keywords).BuildKeyword(keywords)
        
        _display_provider_name.innerText = companyName
        _display_provider_code_direct.innerText = codeDirectId
        
        Product.attr2 = codeDirectId
        
    }
    
    const enableProductEditProviderForm = function () {
        $(_product_edit_details_section_provider_form_edit_button).addClass("d-none")
        
        $(_product_edit_details_section_provider_form_reset_button).removeClass("d-none")
        $(_product_edit_details_section_provider_form_submit_button).removeClass("d-none")
        $(_product_edit_details_section_provider_form_cancel_button).removeClass("d-none")
        
    }
    
    const disableProductEditProviderForm = function () {
        $(_product_edit_details_section_provider_form_edit_button).addClass("d-none")
        
        $(_product_edit_details_section_provider_form_reset_button).addClass("d-none")
        $(_product_edit_details_section_provider_form_submit_button).addClass("d-none")
        $(_product_edit_details_section_provider_form_cancel_button).addClass("d-none")
    }
    
    const resetProductEditProviderForm = function () {
        //console.log("Provider.resetProductEditProviderForm()")
        _product_edit_details_section_provider_form_filter.value = ""
        _product_edit_details_section_provider_form_provider_id.value = ""
        _product_edit_details_section_provider_form_provider_company_id.value = ""
        _product_edit_details_section_provider_form_provider_name.value = ""
        _product_edit_details_section_provider_form_provider_phone_1.value = ""
        _product_edit_details_section_provider_form_provider_phone_2.value = ""
        _product_edit_details_section_provider_form_provider_fax.value = ""
        _product_edit_details_section_provider_form_provider_website.value = ""
        _product_edit_details_section_provider_form_provider_email.value = ""
        _product_edit_details_section_provider_form_provider_description_long.value = ""
        _product_edit_details_section_provider_form_provider_description_short.value = ""
        _product_edit_details_section_provider_form_provider_enabled.checked = true
        _product_edit_details_section_provider_form_provider_cover_image.value = "/public/img/placeholder.jpg"
    }
    
    const openProductEditProviderForm = function () {
        //console.log("Provider.openProductEditProviderForm()")
        $(_product_edit_details_section_provider_form_details).show()
        enableProductEditProviderForm()
    }
    
    const closeProductEditProviderForm = function () {
        //console.log("Provider.closeProductEditProviderForm()")
        $(_product_edit_details_section_provider_form_details).hide()
        disableProductEditProviderForm()
    }
    
    const index = function (settings) {
        build_index_table()
        
        if (settings) {
            if (settings.providers) {
                loadAll(settings.providers)
            }
        }
        
    }
    
    const build_index_table = function () {
        $index_table = $(_table_provider_index).table({
            table_type: "display_list",
            data: Provider.all,
            columnDefs: [
                {
                    title: "Name",
                    targets: 0,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Code Direct ID",
                    targets: 1,
                    data: "code_direct_id",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "SKU",
                    targets: 2,
                    data: "vendor",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data.sku + "</span>"
                    },
                },
                {
                    title: "Location",
                    targets: 3,
                    data: "location",
                    render: function (data, type, row, meta) {
                        let displayLocation = ""
                        if (defaultLocationDisplayFormat === "short") {
                            displayLocation = data.display_short
                        } else if (defaultLocationDisplayFormat === "long") {
                            displayLocation = data.display_long
                        } else {
                            displayLocation = data.display_medium
                        }
                        
                        return "<span style='white-space: nowrap;'>" + displayLocation + "</span>"
                    },
                },
            ],
            rowClick: Provider.navigate,
        })
    }
    
    const navigate = function (provider) {
        if (provider && provider.id) {
            window.location.replace(base_url + "/" + provider.id)
        }
    }
    
    const updateProvider = function (dataToSend, callback) {
        let url = "/api/v1.0/providers/update"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleProviderError("Oops: 1", "Provider", "error")
                    }
                })
            } catch (e) {
                //console.log("error", e)
            }
        }
    }
    
    const _default_detail = function () {
        return {
            addresses: [],
            contacts: [],
            location: {},
            company: {},
            vendor: {},
            id: null,
            description_long: null,
            description_short: null,
            keywords: null,
            company_id: null,
            name: null,
            code_direct_id: null,
            provider_vendor: 1,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
        }
    }
    
    const loadAll = function (providers) {
        Provider.all = new Map()
        if (providers) {
            $.each(providers, function (i, provider) {
                let detail = set(provider)
                $index_table.insertRow(detail)
                Provider.all.set(detail.id, detail)
            })
        }
    }
    
    const save = function (provider) {
        if (provider) {
            updateProvider(provider, function (data) {
                if (data) {
                    if (data[0]) {
                        let details = data[0]
                        if (details.id) {
                            if (_provider_id.value === "" || isNaN(parseInt(_provider_id.value))) {
                                window.location.replace(base_url + "/" + details.id)
                            } else {
                                let name = _company_name.value
                                toastr.success(`Provider ${name} has been updated.`)
                            }
                        } else {
                            //console.log("details 1", details)
                        }
                    } else {
                        //console.log("details 2", data)
                    }
                } else {
                    //console.log("details 3", provider)
                }
            })
        }
    }
    
    const add = function (provider) {
        //console.log("Provider.add(provider)", provider)
        // ----
        
        if (provider) {
            //console.log("|__ provider", provider)
            
            let dataToSend = {
                name: _modal_product_provider_name.value,
                status_id: 1,
                show_online: 1,
                show_sales: 1,
                show_ops: 1,
                is_provider: 1,
                enabled: 1,
            }
            
            Vendor.newVendor(dataToSend, function (data) {
                //console.log("|__ |__ newVendor", data)
                // ----
                
                let vendor_detail, provider_detail = {}
                let categoryId = (_modal_product_category_id && !isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                
                if (data) {
                    vendor_detail = data
                    if (data[0]) {
                        vendor_detail = data[0]
                    }
                    provider.location_id = (provider.location_id) ? provider.location_id : 1
                    provider.vendor_id = vendor_detail.id
                    
                    provider_detail = {
                        provider_detail: provider,
                    }
                    
                    //console.log("|__ provider_detail", provider_detail)
                    
                    updateProvider(provider_detail, function (data) {
                        //console.log("|__ |__ updateProvider", data)
                        // ----
                        
                        if (data) {
                            
                            let provider = (data.length > 0) ? data[0] : data
                            
                            if (provider) {
                                let detail = set(provider)
                                let vendor = (detail.vendor) ? detail.vendor : {}
                                let company = (detail.company) ? detail.company : {}
                                let category = Types.category.get(categoryId)
                                
                                let attributeId = (category && category.attribute_id) ? category.attribute_id : null
                                
                                //*
                                //console.log("|__ |__ provider", provider)
                                //console.log("|__ |__ category", category)
                                //console.log("|__ |__ vendor", vendor)
                                //console.log("|__ |__ company", company)
                                //console.log("|__ |__ detail", detail)
                                
                                //console.log("|__ |__ attributeId", attributeId)
                                //*/
                                
                                let companyName = (company && company.name) ? company.name : null
                                let codeDirectId = (detail && detail.code_direct_id) ? detail.code_direct_id : null
                                let sku = (vendor && vendor.sku) ? vendor.sku : null
                                let companyId = (company && company.id && !isNaN(parseInt(company.id))) ? parseInt(company.id) : null
                                let providerId = (provider && provider.id && !isNaN(parseInt(provider.id))) ? parseInt(provider.id) : null
                                let vendorId = (vendor && vendor.id && !isNaN(parseInt(vendor.id))) ? parseInt(vendor.id) : null
                                
                                _modal_product_provider_name.value = companyName
                                _modal_product_provider_id.value = providerId
                                _modal_product_provider_company_id.value = companyId
                                _modal_product_vendor_name.value = companyName
                                _modal_product_vendor_id.value = vendorId
                                _modal_product_vendor_company_id.value = companyId
                                
                                initAutoComplete()
                                
                                Product.attr1 = attributeId
                                Product.attr2 = codeDirectId
                                Product.attr3 = sku
                                
                                Product.updateProductSKU()
                                Product.enableNewFormDetails()
                            }
                            
                        }
                    })
                    
                }
                
            })
            
        }
    }
    
    const set = function (provider) {
        let detail = _default_detail()
        
        if (provider) {
            detail.id = (provider.id) ? provider.id : null
            detail.name = (provider.name) ? provider.name : null
            detail.location_id = (provider.location_id) ? provider.location_id : null
            detail.code_direct_id = (provider.code_direct_id) ? provider.code_direct_id : null
            detail.description_long = (provider.description_long) ? provider.description_long : null
            detail.description_short = (provider.description_short) ? provider.description_short : null
            detail.keywords = (provider.keywords) ? provider.keywords : null
            detail.provider_vendor = (provider.provider_vendor) ? provider.provider_vendor : 1
            detail.enabled = (provider.enabled) ? provider.enabled : 1
            detail.date_created = (provider.date_created) ? provider.date_created : formatDateMySQL()
            detail.company_id = (provider.company_id) ? provider.company_id : null
            detail.created_by = (provider.created_by) ? provider.created_by : user_id
            detail.date_modified = (provider.date_modified) ? provider.date_modified : formatDateMySQL()
            detail.modified_by = (provider.modified_by) ? provider.modified_by : user_id
            detail.note = (provider.note) ? provider.note : null
            detail.vendor = (provider.vendor) ? provider.vendor : {}
            detail.addresses = (provider.addresses) ? provider.addresses : []
            detail.contacts = (provider.contacts) ? provider.contacts : []
            detail.location = (provider.location) ? provider.location : {}
            detail.company = (provider.company) ? provider.company : {}
        }
        
        Provider.detail = detail
        return detail
    }
    
    const build = function () {
        return remove_nulls({
            location_id: (!isNaN(parseInt(_location_id.value))) ? parseInt(_location_id.value) : null,
            company_id: (!isNaN(parseInt(_provider_company_id.value))) ? parseInt(_provider_company_id.value) : null,
            code_direct_id: (_provider_code_direct_id.value === "") ? null : _provider_code_direct_id.value,
            id: (!isNaN(parseInt(_provider_id.value))) ? parseInt(_provider_id.value) : null,
            provider_vendor: (_form_edit_provider) ? 1 : 0,
            enabled: 1,
        })
    }
    
    const edit = function (settings) {
        let provider = {}
        let addresses = []
        let contacts = []
        let location = {}
        let company = {}
        let vendor = {}
        //
        if (_form_edit_provider) {
            initAutoComplete()
            validator_init(formRules)
            validator = $(_form_edit_provider).validate()
        }
        
        if (settings) {
            
            if (settings.is_new) {
                isNew = settings.is_new
                _button_save_provider.disabled = true
                $(_panel_tab_provider).addClass("disabled")
                $(_panel_tab_vendor).addClass("disabled")
                $(_panel_tab_address).addClass("disabled")
            }
            
            if (settings.provider_detail) {
                provider = set(settings.provider_detail)
                addresses = (provider.addresses) ? provider.addresses : []
                contacts = (provider.contacts) ? provider.contacts : []
                location = (provider.location) ? provider.location : {}
                company = (provider.company) ? provider.company : {}
                vendor = (provider.vendor) ? provider.vendor : {}
            }
            
        }
        
        populate_form(provider)
        // ----
        Vendor.init(vendor)
        Location.init(location)
        Address.init(addresses)
        Contact.init(contacts)
        Company.init(company)
        // ----
        Vendor.setProvider()
        disable_form_fields()
        setProgress()
    }
    
    const validate_form = function () {
        return $(_form_edit_provider).valid()
    }
    
    const enable_form_fields = function () {
        if (_provider_id.value !== "" && _provider_company_id.value !== "") {
        
        }
    }
    
    const disable_form_fields = function () {
        $(_provider_name).attr("readonly", true)
        
        if (_form_edit_provider) {
            if (isNew) {
                //$(_provider_name).attr("readonly", false)
                //_company_cover_image.disabled = true
                //_button_edit_provider_name.disabled = true
                //$(_panel_tab_contact).addClass("disabled")
                //$(_panel_tab_address).addClass("disabled")
            } else {
                $(_company_name).attr("readonly", true)
            }
        }
        
    }
    
    const populate_form = function (provider) {
        if (provider) {
            _provider_id.value = (provider.id) ? provider.id : null
            $(_provider_name).val((provider.name) ? provider.name : null)
            $(_company_name).val($(_provider_name).val())
            _provider_company_id.value = (provider.company_id) ? provider.company_id : null
            _provider_code_direct_id.value = (provider.code_direct_id) ? provider.code_direct_id : null
            _provider_enabled.checked = (provider.enabled) ? (provider.enabled === 1) : true
        }
        
    }
    
    const resetForm = function () {
        _provider_id.value = ""
        $(_provider_name).val("").trigger("change")
        _provider_company_id.value = ""
        _provider_code_direct_id.value = ""
        _provider_enabled.checked = true
    }
    
    const setProgress = function () {
        //console.log("Provider.setProgress()")
        // ----
        
        let providerId = (!isNaN(_provider_id.value)) ? _provider_id.value : null
        let companyId = (!isNaN(_provider_company_id.value)) ? _provider_company_id.value : null
        
        if (companyId === null || companyId === "") {
            $(_panel_tab_contact).addClass("disabled")
            $(_panel_tab_address).addClass("disabled")
            $(_panel_tab_provider).addClass("disabled")
            $(_panel_tab_vendor).addClass("disabled")
        } else {
            $(_panel_tab_contact).removeClass("disabled")
            $(_panel_tab_address).removeClass("disabled")
            $(_panel_tab_provider).removeClass("disabled")
            $(_panel_tab_vendor).removeClass("disabled")
        }
        
        _button_save_provider.disabled = !(_company_id.value !== "" && _location_name_filter_id.value !== "")
        
    }
    
    //
    
    const handleProviderError = function (msg, title, level) {
        //console.log("Provider.handleProviderError(msg)", msg)
        // ----
        
        if (!title) {
            title = "Product"
        }
        
        if (!level) {
            level = "error"
        }
        
        toastr[level](`${msg}`, title)
    }
    
    const fetchProviderByName = function (dataToSend, callback) {
        //console.log("Provider.fetchProviderByName(dataToSend)", dataToSend)
        // ----
        
        let url = "/api/v1.0/providers/validate"
        
        if (dataToSend) {
            try {
                sendGetRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleProviderError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleProviderError("Error Validating Company")
            }
        } else {
            handleProviderError("Error Loading Company- Missing Data")
        }
    }
    
    const providerExists = function (name) {
        //console.log("Provider.providerExists(name)", name)
        // ----
        
        if (name && name !== "") {
            let dataToSend = {
                name: name,
            }
            
            fetchProviderByName(dataToSend, function (data) {
                let provider
                
                if (!data || data.length === 0) {
                    
                    confirmDialog("This provider does not exist. Would you like to create it?", (ans) => {
                        if (ans) {
                            let companyName = (dataToSend && dataToSend.name) ? dataToSend.name : null
                            
                            if (companyName) {
                                //console.log("|__ companyName", companyName)
                                
                                let companyParams = {
                                    name: companyName,
                                    status_id: 10,
                                    enabled: 1,
                                }
                                
                                //console.log("|__ companyParams", companyParams)
                                
                                Company.add(companyParams, function (data) {
                                    //console.log("|__ |__ data", data)
                                    let company
                                    
                                    if (data) {
                                        company = (data[0]) ? data[0] : data
                                        
                                        let companyId = (company && !isNaN(parseInt(company.id))) ? parseInt(company.id) : null
                                        let companyName = (company && company.name) ? company.name : null
                                        
                                        if (companyId !== null && companyName !== null) {
                                            _modal_product_provider_company_id.value = companyId
                                            _modal_product_vendor_company_id.value = companyId
                                            _modal_product_provider_name.value = companyName
                                            _modal_product_vendor_name.value = companyName
                                            _modal_product_provider_vendor_match.checked = true
                                            
                                            add(remove_nulls({
                                                location_id: null,
                                                company_id: companyId,
                                                code_direct_id: null,
                                                id: null,
                                                provider_vendor: 1,
                                                enabled: 1,
                                            }))
                                            
                                        } else {
                                            return handleProviderError("No Data", "Error", "error")
                                        }
                                        
                                    } else {
                                        return handleProviderError("No Data", "Error", "error")
                                    }
                                    
                                })
                            }
                            
                            /*
                            Company.addProvider({
                                name: _modal_product_provider_name.value,
                                status_id: 10,
                                enabled: 1,
                            }, function (data) {
                                if (data) {
                                    if (data[0]) {
                                        let company = data[0]
                                        _modal_product_provider_company_id.value = company.id
                                        _modal_product_vendor_company_id.value = company.id
                                        _modal_product_provider_name.value = company.name
                                        _modal_product_vendor_name.value = company.name
                                        _modal_product_provider_vendor_match.checked = true
                                        
                                        add(remove_nulls({
                                            location_id: null,
                                            company_id: company.id,
                                            code_direct_id: null,
                                            id: null,
                                            provider_vendor: 1,
                                            enabled: 1,
                                        }))
                                    }
                                }
                            })
                            //*/
                        } else {
                            _modal_product_vendor_id.value = ""
                            _modal_product_provider_id.value = ""
                            _modal_product_vendor_name.value = ""
                            _modal_product_provider_name.value = ""
                            globalSelectedProvider = false
                        }
                    })
                    
                } else {
                    provider = (data[0]) ? data[0] : data
                    //console.log("|__ provider", provider)
                    
                    if (_form_product_add) {
                        setNewProductModalFields(provider)
                    }
                    
                    /*
            if (_form_product_add) {
                
                if (!data || data.length === 0) {
                    
                    confirmDialog("This provider does not exist. Would you like to create it?", (ans) => {
                        if (ans) {
                        
                            Company.addProvider({
                                name: _modal_product_provider_name.value,
                                status_id: 10,
                                enabled: 1,
                            }, function (data) {
                                if (data) {
                                    if (data[0]) {
                                        let company = data[0]
                                        _modal_product_provider_company_id.value = company.id
                                        _modal_product_vendor_company_id.value = company.id
                                        _modal_product_provider_name.value = company.name
                                        _modal_product_vendor_name.value = company.name
                                        _modal_product_provider_vendor_match.checked = true
                                        
                                        add(remove_nulls({
                                            location_id: null,
                                            company_id: company.id,
                                            code_direct_id: null,
                                            id: null,
                                            provider_vendor: 1,
                                            enabled: 1,
                                        }))
                                    }
                                }
                            })
                        
                        } else {
                            _modal_product_vendor_id.value = ""
                            _modal_product_provider_id.value = ""
                            _modal_product_vendor_name.value = ""
                            _modal_product_provider_name.value = ""
                            globalSelectedProvider = false
                        }
                    })
                } else {
                    if (data) {
                        provider = data
                        if (data.length > 0) {
                            provider = data[0]
                        }
                    }
                    
                    let vendor = provider.vendor
                    let code_direct = (provider.code_direct_id) ? provider.code_direct_id : null
                    let sku = (vendor.sku) ? vendor.sku : null
                    
                    _modal_product_vendor_id.value = parseInt(vendor.id)
                    _modal_product_provider_id.value = provider.id
                    _modal_product_vendor_name.value = provider.name
                    _modal_product_vendor_company_id.value = (!isNaN(parseInt(provider.company_id))) ? parseInt(provider.company_id) : null
                    _modal_product_provider_company_id.value = (!isNaN(parseInt(provider.company_id))) ? parseInt(provider.company_id) : null
                    _modal_product_provider_vendor_match.checked = true
                    _modal_product_vendor_name.disabled = false
                    _modal_product_provider_location_id.value = (!isNaN(parseInt(provider.location.id))) ? parseInt(provider.location.id) : null
                    _modal_product_location_id.value = (!isNaN(parseInt(provider.location.id))) ? parseInt(provider.location.id) : null
                    
                    Product.attr2 = code_direct
                    Product.attr3 = sku
                    Product.updateProductSKU()
                }
            }
            //*/
                
                }
                
                if (_form_edit_provider) {
                    if (data) {
                        if (data.length > 0) {
                            
                            provider = data[0]
                            
                            if (_form_product_add) {
                            
                            }
                            
                            confirmDialog("This provider exists. Would you like to edit it?", (ans) => {
                                if (ans) {
                                    window.location.href = "/providers/" + provider.id
                                } else {
                                    Company.reset_form()
                                    Provider.resetForm()
                                    Vendor.reset_form()
                                }
                            })
                            
                        }
                    }
                    //console.log("provider", provider)
                    $(_vendor_name).val($(_provider_name).val()).trigger("change")
                }
                
            })
            
        }
        
    }
    
    const initAutoComplete = function () {
        //console.log("Provider.initAutocomplete()")
        // ----
        
        if (_provider_name) {
            $(_provider_name)
                .on("change", function () {
                    /*
                    setTimeout(function () {
                        let provider_name = _provider_name.value
                        
                        if (globalSelectedProvider === false) {
                            if (provider_name === "") {
                                _provider_name.value = ""
                                _provider_company_id.value = ""
                                globalSelectedProvider = false
                                $(_vendor_name).val("").trigger("change")
                                $(_provider_company_id).val("").trigger("change")
                            } else {
                                providerExists(provider_name)
                            }
                        }
                    }, 200)
                    //*/
                })
                .on("search", function () {
                    //_provider_id.value = ""
                    //_provider_company_id.value = ""
                    
                    //$(_vendor_name).val("").trigger("change")
                    //$(_provider_company_id).val("").trigger("change")
                    Provider.resetForm()
                    Vendor.reset_form()
                })
                .on("click", function () {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/providers",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion.data) {
                            return
                        }
                        let provider = suggestion.data
                        let company = (provider.company) ? provider.company : {}
                        let addresses = (provider.addresses) ? provider.addresses : {}
                        let contacts = (provider.contacts) ? provider.contacts : {}
                        let location = (provider.location) ? provider.location : {}
                        let vendor = (provider.vendor) ? provider.vendor : {}
                        let provider_id = provider.id
                        let company_name = provider.company.name
                        let provider_company_id = provider.company.id
                        
                        if (_form_edit_provider) {
                            $(_provider_company_id).val(provider_company_id)
                            $(_provider_id).val(provider_id)
                            confirmDialog("This provider exists. Would you like to edit it?", (ans) => {
                                if (ans) {
                                    window.location.replace("/providers/" + provider_id)
                                    populate_form(provider)
                                    Company.populate_form(company)
                                    Location.populate_form(location)
                                    $(_vendor_company_id).val(provider_company_id)
                                    $(_vendor_name).val(company_name).trigger("change")
                                } else {
                                    Provider.resetForm()
                                    Vendor.reset_form()
                                }
                            })
                        }
                    },
                })
        }
        if (_product_edit_details_section_provider_form_filter) {
            $(_product_edit_details_section_provider_form_filter)
                .on("change", function () {
                    //*
                    setTimeout(function () {
                        let provider_name = _product_edit_details_section_provider_form_filter.value
                        
                        if (globalSelectedProvider === false) {
                            if (provider_name === "") {
                                _product_edit_details_section_provider_form_filter.value = ""
                                _product_edit_details_section_provider_form_provider_company_id.value = ""
                                _product_edit_details_section_provider_form_provider_id.value = ""
                                globalSelectedProvider = false
                                //$(_vendor_name).val("").trigger("change")
                                $(_product_edit_details_section_provider_form_provider_company_id).val("").trigger("change")
                                $(_product_edit_details_section_provider_form_provider_id).val("").trigger("change")
                            } else {
                                providerExists(provider_name)
                            }
                        }
                    }, 200)
                    //*/
                })
                .on("search", function () {
                    //_provider_id.value = ""
                    //_provider_company_id.value = ""
                    
                    //$(_vendor_name).val("").trigger("change")
                    //$(_provider_company_id).val("").trigger("change")
                    //Provider.resetForm()
                    //Vendor.reset_form()
                })
                .on("click", function () {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/providers",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion.data) {
                            return
                        }
                        let provider = suggestion.data
                        tempProvider = provider
                        //console.log("provider", provider)
                        
                        let company = (provider.company) ? provider.company : {}
                        let addresses = (provider.addresses) ? provider.addresses : {}
                        let contacts = (provider.contacts) ? provider.contacts : {}
                        let location = (provider.location) ? provider.location : {}
                        let vendor = (provider.vendor) ? provider.vendor : {}
                        let provider_id = provider.id
                        let company_name = provider.company.name
                        let provider_company_id = provider.company.id
                        
                        populateProductEditProviderForm(provider)
                        /*
                        if (_form_edit_provider) {
                            $(_provider_company_id).val(provider_company_id)
                            $(_provider_id).val(provider_id)
                            confirmDialog("This provider exists. Would you like to edit it?", (ans) => {
                                if (ans) {
                                    window.location.replace("/providers/" + provider_id)
                                    populate_form(provider)
                                    Company.populate_form(company)
                                    Location.populate_form(location)
                                    $(_vendor_company_id).val(provider_company_id)
                                    $(_vendor_name).val(company_name).trigger("change")
                                } else {
                                    Provider.resetForm()
                                    Vendor.reset_form()
                                }
                            })
                        }
                        //*/
                    },
                })
        }
        
        if (_modal_product_provider_name) {
            
            $(_modal_product_provider_name)
                .on("change", function () {
                    //*
                    setTimeout(function () {
                        let provider_name = _modal_product_provider_name.value
                        
                        if (globalSelectedProvider === false) {
                            
                            if (provider_name === "") {
                                clearNewProductModalFields()
                            } else {
                                providerExists(provider_name)
                            }
                        }
                        
                    }, 200)
                    //*/
                })
                .on("search", function () {
                    globalSelectedProvider = false
                    clearNewProductModalFields()
                })
                .on("keyup", function () {
                    globalSelectedProvider = false
                })
                .on("click", function (e) {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/providers",
                    minChars: 2,
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion.data) {
                            return
                        }
                        
                        globalSelectedProvider = true
                        setNewProductModalFields(suggestion.data)
                        
                    },
                })
            
        }
        
    }
    
    const clearNewProductModalFields = function () {
        //console.log("Provider.clearNewProductModalFields()")
        // ----
        
        _modal_product_provider_location_id.value = ""
        _modal_product_provider_id.value = ""
        _modal_product_provider_company_id.value = ""
        _modal_product_vendor_id.value = ""
        _modal_product_vendor_company_id.value = ""
        _modal_product_vendor_name.value = ""
        _modal_product_provider_vendor_match.checked = false
        
        $(_form_product_add).trigger("change")
        
    }
    
    const setNewProductModalFields = function (provider) {
        //console.log("Provider.setNewModalFields(provider)", provider)
        // ----
        
        let categoryId = (_modal_product_category_id && !isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
        let category = Types.category.get(categoryId)
        let company = (provider && provider.company) ? provider.company : {}
        let addresses = (provider && provider.addresses) ? provider.addresses : {}
        let contacts = (provider && provider.contacts) ? provider.contacts : {}
        let location = (provider && provider.location) ? provider.location : {}
        let vendor = (provider && provider.vendor) ? provider.vendor : {}
        let companyId = (company && company.id && !isNaN(parseInt(company.id))) ? parseInt(company.id) : null
        let companyName = (company && company.name) ? company.name : null
        let vendorId = (vendor && vendor.id && !isNaN(parseInt(vendor.id))) ? parseInt(vendor.id) : null
        let providerId = (provider && provider.id && !isNaN(parseInt(provider.id))) ? parseInt(provider.id) : null
        let codeDirect = (provider && provider.code_direct_id) ? provider.code_direct_id : null
        let sku = (vendor && vendor.sku) ? vendor.sku : null
        let providerVendorMatch = true
        let locationId = (provider && provider.location_id && !isNaN(parseInt(provider.location_id))) ? parseInt(provider.location_id) : null
        let attributeId = (category && category.attribute_id) ? category.attribute_id : null
        
        clearNewProductModalFields()
        
        _modal_product_provider_location_id.value = locationId
        _modal_product_provider_name.value = companyName
        _modal_product_provider_id.value = providerId
        _modal_product_provider_company_id.value = companyId
        _modal_product_vendor_id.value = vendorId
        _modal_product_vendor_company_id.value = companyId
        _modal_product_vendor_name.value = companyName
        _modal_product_provider_vendor_match.checked = providerVendorMatch
        
        //$(_modal_product_provider_name).trigger("change")
        //$(_modal_product_vendor_name).trigger("change")
        //console.log("|__ Types.category", Array.from(Types.category.values))
        
        Product.attr1 = attributeId
        Product.attr2 = codeDirect
        Product.attr3 = sku
        
        $(_form_product_add).trigger("change")
        
        Product.updateProductSKU()
        
    }
    
    const init = function (settings) {
        //console.log("Provider.init(settings)", settings)
        // ----
        
        let detail
        
        if (settings) {
            
            if (settings.provider_detail) {
                detail = set(settings.provider_detail)
                
                if (detail) {
                    tempProvider = detail
                    
                    if (detail.company) {
                        //console.log("|__ detail.company", detail.company)
                        
                        Company.init(detail.company)
                    }
                    
                }
                
                //populateProductEditProviderForm(detail)
            }
            
        }
        
        if (_product_edit_details_section_provider_form_filter) {
            closeProductEditProviderForm()
        }
        
        initAutoComplete()
        
    }
    
    return {
        validator: null,
        detail: {},
        all: new Map(),
        navigate: function (provider) {
            navigate(provider)
        },
        get: function (params) {
            get(params)
        },
        build: function () {
            if (validate_form()) {
                return build()
            }
        },
        load_all: function (params) {
            loadAll(params)
        },
        save: function (params) {
            save(params)
        },
        init: function (settings) {
            init(settings)
        },
        resetForm: function () {
            resetForm()
        },
        providerExists: function (name) {
            providerExists(name)
        },
        enable_form_fields: function () {
            enable_form_fields()
        },
        disable_form_fields: function () {
            disable_form_fields()
        },
        index: function (providers) {
            index(providers)
        },
        edit: function (settings) {
            edit(settings)
        },
    }
    
})()

const Profile = (function () {
    "use strict"
    const _table_profile_product_edit = document.getElementById("table_profile_product_edit")
    const _product_edit_profile_form_profile_name_filter = document.getElementById("product_edit_profile_form_profile_name_filter")
    const _product_edit_profile_form = document.getElementById("product_edit_profile_form")
    
    // ----
    
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let $table_profile_product_edit = $(_table_profile_product_edit)
    let form_rules = {
        rules: {
            product_edit_unit_form_unit_min_nights: {
                required: true,
                number: true,
                min: 1,
            },
            product_edit_unit_form_unit_max_nights: {
                required: true,
                number: true,
                min: 1,
            },
            product_edit_unit_form_unit_min_pax: {
                required: true,
                number: true,
                min: 1,
            },
            product_edit_unit_form_unit_max_pax: {
                required: true,
                number: true,
                min: 1,
            },
        },
        messages: {
            product_edit_unit_form_unit_min_nights: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
            product_edit_unit_form_unit_max_nights: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
            product_edit_unit_form_unit_min_pax: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
            product_edit_unit_form_unit_max_pax: {
                required: "Field Required",
                number: "Field Invalid",
                min: "Field Invalid",
            },
        },
    }
    
    /**
     * build product edit profile table
     */
    const buildEditTable = function () {
        /*
        //console.log("Profile.buildEditTable()", Profile)
        $table_profile_product_edit = $(_table_profile_product_edit).table({
            table_type: "display_list",
            data: [],
            columnDefs: [
                {
                    title: "Name",
                    targets: 0,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "sales_types_details",
                    targets: 1,
                    data: "sales_types_details",
                    render: function (data, type, row, meta) {
                        //console.log("sales_types_details", data)
                        let nights = 1
                        if (data === null) {
                            nights = "null"
                        } else {
                            nights = data
                        }
                        
                        return "<span style='white-space: nowrap;'>" + nights + "</span>"
                    },
                },
                {
                    title: "allot_by_id",
                    targets: 2,
                    data: "allot_by_id",
                    render: function (data, type, row, meta) {
                        let nights = 1
                        if (data === null) {
                            nights = "null"
                        } else {
                            nights = data
                        }
                        return "<span style='white-space: nowrap;'>" + nights + "</span>"
                    },
                },
                {
                    title: "expires",
                    targets: 3,
                    data: "expires",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "release_amt",
                    targets: 4,
                    data: "release_amt",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
            ],
            rowClick: Profile.edit,
        })
                 */
    }
    
    const initAutoComplete = function () {
        /*
        //console.log("Profile.initAutoComplete()", Profile)
        $(_product_edit_profile_form_profile_name_filter)
          .on("click", function () {
          
          })
          .on("search", function () {
              $table_season_product_edit.clearSelectedRows()
              resetForm()
          })
          .on("change", function () {
              if (_product_edit_season_form_season_name_filter.value === "") {
                  $table_season_product_edit.clearSelectedRows()
                  resetForm()
              }
          })
          .autocomplete({
              serviceUrl: "/api/v1.0/autocomplete/profiles",
              minChars: 2,
              cache: false,
              dataType: "json",
              triggerSelectOnValidInput: false,
              paramName: "st",
              onSelect: function (suggestion) {
                  if (!suggestion.data) {
                      return
                  }
                  $table_profile_product_edit.clearSelectedRows()
                  let profile = suggestion.data
                  //console.log("profile", profile)
              },
          })
          
         */
    }
    
    /**
     * set default profile record detail
     *
     * @returns {{allot_by_details: {note: null, date_modified: *, date_created: *, modified_by: (number|number), name: null, id: null, created_by: (number|number), sort_order: number, enabled: number}, note: null, expires: null, weekday_dow: string, return_dow: string, advanced_booking_min: null, checkin_dow: string, min_duration: number, days_out: null, transfer_sales_types_details: {note: null, date_modified: *, date_created: *, modified_by: (number|number), name: null, id: null, class: null, created_by: (number|number), sort_order: number, enabled: number}, enabled: number, advanced_booking_date: null, id: null, checkout_dow: string, sales_types_details: {note: null, date_modified: *, date_created: *, modified_by: (number|number), name: null, id: null, class: null, created_by: (number|number), sort_order: number, enabled: number}, sales_types_id: null, transfer_sales_types_id: null, quantity: null, min_length_days: number, product_profile_details: {note: null, date_modified: *, date_created: *, profile_id: null, product_id: null, modified_by: (number|number), created_by: (number|number), enabled: number}, date_created: *, departure_dow: string, advanced_booking_max: null, equal_duration: null, release_amt: null, created_by: (number|number), max_duration: null, date_modified: *, modified_by: (number|number), name: null, allot_by_id: null, inc_days_dow: string}}
     */
    const defaultDetail = function () {
        return {
            advanced_booking_date: null,
            advanced_booking_max: null,
            advanced_booking_min: null,
            allot_by_details: {
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                enabled: 1,
                id: null,
                modified_by: user_id,
                name: null,
                note: null,
                sort_order: 999,
            },
            allot_by_id: null,
            checkin_dow: "",
            checkout_dow: "",
            created_by: user_id,
            date_created: formatDateMySQL(),
            date_modified: formatDateMySQL(),
            days_out: null,
            departure_dow: "",
            enabled: 1,
            equal_duration: null,
            expires: null,
            id: null,
            inc_days_dow: "",
            max_duration: null,
            min_duration: 1,
            min_length_days: 1,
            modified_by: user_id,
            name: null,
            note: null,
            product_profile_details: {
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                enabled: 1,
                modified_by: user_id,
                note: null,
                product_id: null,
                profile_id: null,
            },
            quantity: null,
            release_amt: null,
            return_dow: "",
            sales_types_details: {
                class: null,
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                enabled: 1,
                id: null,
                modified_by: user_id,
                name: null,
                note: null,
                sort_order: 999,
            },
            sales_types_id: null,
            transfer_sales_types_details: {
                class: null,
                created_by: user_id,
                date_created: formatDateMySQL(),
                date_modified: formatDateMySQL(),
                enabled: 1,
                id: null,
                modified_by: user_id,
                name: null,
                note: null,
                sort_order: 999,
            },
            transfer_sales_types_id: null,
            weekday_dow: "",
        }
    }
    
    /**
     * load all product profiles
     *
     * @param profiles
     */
    const loadAll = function (profiles) {
        Profile.all = new Map()
        if (!profiles) {
            profiles = []
        }
        
        $.each(profiles, function (k, profile) {
            let detail = set(profile)
            //console.log("detail", detail)
        })
        
        //console.log("Profile.all", Profile.all)
    }
    
    const set = function (profile) {
        let detail = defaultDetail()
        //console.log("Profile.set(profile)", profile)
        if (profile) {
            detail.advanced_booking_date = (profile.advanced_booking_date) ? profile.advanced_booking_date : null
            detail.advanced_booking_max = (profile.advanced_booking_max) ? profile.advanced_booking_max : null
            detail.advanced_booking_min = (profile.advanced_booking_min) ? profile.advanced_booking_min : null
            detail.allot_by_details.created_by = (profile.created_by) ? profile.created_by : null
            detail.allot_by_details.date_created = (profile.date_created) ? profile.date_created : formatDateMySQL()
            detail.allot_by_details.date_modified = (profile.date_modified) ? profile.date_modified : formatDateMySQL()
            detail.allot_by_details.enabled = (profile.enabled) ? profile.enabled : 1
            detail.allot_by_details.id = (profile.id) ? profile.id : null
            detail.allot_by_details.modified_by = (profile.modified_by) ? profile.modified_by : user_id
            detail.allot_by_details.name = (profile.name) ? profile.name : null
            detail.allot_by_details.note = (profile.note) ? profile.note : null
            detail.allot_by_details.sort_order = (profile.sort_order) ? profile.sort_order : 999
        }
        return detail
    }
    
    const init = function (settings) {
        //console.log("Profile.init(settings)", settings)
        let profiles = []
        if (settings) {
            if (settings.profiles) {
                profiles = settings.profiles
            }
        }
        loadAll(profiles)
        /*
        if (settings) {
            if (settings.profiles) {
                profiles = settings.profiles
            }
        }
        //*/
        /*
        if (_table_profile_product_edit) {
            buildEditTable()
        }
         */
        
        /*
        if (_product_edit_profile_form_profile_name_filter) {
            initAutoComplete()
        }
        
        if (_product_edit_profile_form) {
            initAutoComplete()
            validator_init(form_rules)
            Unit.validator = $(_product_edit_profile_form).validate()
        }
        
        
        
        
        //*/
    }
    
    const edit = function (profile) {
        //console.log("Profile.edit(profile)", profile)
    }
    
    return {
        all: new Map(),
        init: function (settings) {
            init(settings)
        },
        edit: function (profile) {
            edit(profile)
        },
    }
    
})()

function FileManager (element, options) {
    if (!(options && options.source && element)) {
        console.log("Missing options.")
        console.log("|__ options", options)
        console.log("|__ options.source", options.source)
        console.log("|__ options.sourceId", options.sourceId)
        return
    }
    let userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    let source = options.source
    let sourceId = options.sourceId
    let baseId = "file_manager" + "_" + source
    let defaults = {
        defaultFile: "", // - /public/img/placeholder.jpg
        maxFileSize: 0,
        minWidth: 0,
        maxWidth: 0,
        minHeight: 0,
        maxHeight: 0,
        showRemove: true,
        showLoader: true,
        showErrors: true,
        errorTimeout: 3000,
        errorsPosition: "overlay",
        imgFileExtensions: ["png", "jpg", "jpeg", "gif", "bmp", "webp"],
        maxFileSizePreview: "5M",
        allowedFormats: ["portrait", "square", "landscape"],
        allowedFileExtensions: ["*"],
        urls: {
            "remove": `/`,
            "update": `/`,
            "get": `get`,
            "upload": `/`,
        },
        messages: {
            "default": "Drag and drop a file here or click",
            "replace": "Drag and drop or click to replace",
            "remove": "Remove",
            "error": "Ooops, something wrong happended.",
        },
        error: {
            "fileSize": "The file size is too big ({{ value }} max).",
            "minWidth": "The image width is too small ({{ value }}}px min).",
            "maxWidth": "The image width is too big ({{ value }}}px max).",
            "minHeight": "The image height is too small ({{ value }}}px min).",
            "maxHeight": "The image height is too big ({{ value }}px max).",
            "imageFormat": "The image format is not allowed ({{ value }} only).",
            "fileExtension": "The file is not allowed ({{ value }} only).",
        },
        tpl: {
            gallery: {
                wrap: ``,
            },
            preview: {
                wrapper: `<section id="${baseId}_preview" class="mb-4 p-0 filemanager-preview-wrapper d-flex align-items-center justify-content-center" />`,
                error: `<img id="${baseId}_image" src="/public/img/placeholder.jpg" alt="Preview Placeholder" class="img-fluid" />`,
                container: `<div class="filemanager-preview "/>`,
                loader: "<div class='filemanager-loader'></div>",
                message: `<div class="filemanager-message w-100 text-center d-flex flex-column"><i class="fas fa-upload w-100 fa-4x mb-2"></i><p class="w-100 mt-4">Drag and drop a file here or click</p></div>`,//"<div class=\"fileManager-message\"><i class=\"fas fa-upload mr-2\"></i> <p>Drop File Here</p></div>",
                errorsContainer: "<div class=\"filemanager-errors-container\"><ul></ul></div>",
                errorLine: "<p class=\"filemanager-error\"></p>",
                clearButton: `<button type="button" class="filemanager-clear">remove</button>`,
            },
            filename: "<p class=\"fileManager-filename\"><span class=\"fileManager-filename-inner\"></span></p>",
        },
    }
    
    this.userId = userId
    this.element = element
    this.source = source
    this.sourceId = sourceId
    this.baseId = baseId
    this.isInit = false
    this.errorsEvent = $.Event("filemanager.errors")
    this.errorsEvent.errors = []
    this.isDisabled = false
    this.all = new Map()
    this.images = (options.images) ? options.images : []
    this.inputs = {
        labels: {},
        buttons: {},
        fields: {},
        displays: {},
        errors: {},
    }
    this.detail = {
        alt: null,
        caption: null,
        created_by: userId,
        date_created: formatDateMySQL(),
        date_modified: formatDateMySQL(),
        dimensions: null,
        enabled: 1,
        extension: null,
        height: null,
        id: null,
        is_cover: 0,
        is_shown: 1,
        modified_by: userId,
        name: null,
        note: null,
        path: null,
        size: null,
        thumbs_path: null,
        title: null,
        width: null,
    }
    this.file = {
        object: null,
        name: null,
        size: null,
        width: null,
        height: null,
        type: null,
    }
    this.settings = $.extend(true, defaults, options)
    
    if (!Array.isArray(this.settings.allowedFormats)) {
        this.settings.allowedFormats = this.settings.allowedFormats.split(" ")
    }
    
    if (!Array.isArray(this.settings.allowedFileExtensions)) {
        this.settings.allowedFileExtensions = this.settings.allowedFileExtensions.split(" ")
    }
    
    this.uploadProgress = this.uploadProgress.bind(this)
    this.uploadComplete = this.uploadComplete.bind(this)
    this.uploadFailed = this.uploadFailed.bind(this)
    this.uploadCanceled = this.uploadCanceled.bind(this)
    this.validate = this.validate.bind(this)
    this.isShown = this.isShown.bind(this)
    this.isCover = this.isCover.bind(this)
    this.clearElement = this.clearElement.bind(this)
    this.formHide = this.formHide.bind(this)
    this.formShow = this.formShow.bind(this)
    this.formRemove = this.formRemove.bind(this)
    this.formCancel = this.formCancel.bind(this)
    this.onChange = this.onChange.bind(this)
    this.formClear = this.formClear.bind(this)
    this.fileSelected = this.fileSelected.bind(this)
    this.formReset = this.formReset.bind(this)
    this.open = this.open.bind(this)
    this.load = this.load.bind(this)
    this.onFileReady = this.onFileReady.bind(this)
    this.displaySet = this.displaySet.bind(this)
    this.buildImageThumbnails = this.buildImageThumbnails.bind(this)
    this.formUpload = this.formUpload.bind(this)
    this.sendUpdateRequest = this.sendUpdateRequest.bind(this)
    
    this.init(options)
    //this.translateMessages()
    this.createElements()
    this.assignEvents()
    this.loadAll()
    
    this.formReset()
}

FileManager.prototype.createPreviewElements = function () {
    console.log("FileManager.createPreviewElements()")
    // ----
    
    let messageWrapper
    
    this.previewWrapper = $(this.settings.tpl.preview.wrapper)
    this.previewLoader = $(this.settings.tpl.preview.loader)
    this.previewContainer = $(this.settings.tpl.preview.container)
    this.previewMessage = $(this.settings.tpl.preview.message)
    
    this.previewWrapper.append(this.previewContainer)
    
    messageWrapper = $(this.settings.tpl.preview.message).insertBefore(this.previewContainer)
    $(this.settings.tpl.preview.errorLine).appendTo(messageWrapper)
    
    if (this.settings.showLoader === true) {
        this.loader = $(this.settings.tpl.preview.loader)
        this.previewWrapper.append(this.loader)
        this.hideLoader()
    }
    
    if (this.settings.showErrors === true) {
        this.previewErrorsContainer = $(this.settings.tpl.preview.errorsContainer)
        
        if (this.settings.errorsPosition === "outside") {
            this.previewErrorsContainer.insertAfter(this.previewWrapper)
        } else {
            this.previewWrapper.append(this.previewErrorsContainer)
        }
    }
    
    if (this.isDisabled === false && this.settings.showRemove === true) {
        this.clearButton = $(this.settings.tpl.preview.clearButton)
        this.previewWrapper.append(this.clearButton)
        this.clearButton.on("click", this.clearElement)
    }
    
    let defaultFile = this.settings.defaultFile || ""
    if (defaultFile.trim() !== "") {
        this.file.name = this.cleanFilename(defaultFile)
        this.setPreview(this.isImage(), defaultFile)
    }
    
    this.preview = this.previewWrapper
}
FileManager.prototype.setPreview = function (previewable, src) {
    console.log("FileManager.setPreview(previewable, src)", this)
    // ----
    
    let render = this.previewContainer
    
    this.hideLoader()
    this.preview.removeClass("has-error").addClass("has-preview")
    
    if (previewable === true) {
        let imgTag = $("<img alt='File Preview' class='img-fluid' src='" + src + "'/>")
        
        if (this.settings.height) {
            imgTag.css("max-height", this.settings.height)
        }
        
        this.previewContainer.empty()
        imgTag.appendTo(render)
    } else {
        $("<i />").attr("class", "filemanager-font-file").appendTo(render)
        $("<span class=\"filemanager-extension\" />").html(this.getFileType()).appendTo(render)
    }
    
    this.formShow()
}
FileManager.prototype.resetPreview = function () {
    console.log("FileManager.resetPreview()")
    // ----
    
    let render = this.previewContainer
    this.preview.removeClass("has-error")
    this.preview.removeClass("has-preview")
    render.find(".filemanager-extension").remove()
    render.find("i").remove()
    render.find("img").remove()
    
    this.hideLoader()
}
FileManager.prototype.clearElement = function () {
    console.log("FileManager.clearElement()")
    // ----
    
    if (this.errorsEvent.errors.length === 0) {
        let eventBefore = $.Event("filemanager.beforeClear")
        this.inputs.fields.imageFile.trigger(eventBefore, [this])
        
        if (eventBefore.result !== false) {
            this.resetFile()
            this.inputs.fields.imageFile.val("")
            this.resetPreview()
            
            this.inputs.fields.imageFile.trigger($.Event("filemanager.afterClear"), [this])
            
        }
        
        this.formClear()
        this.displayClear()
        this.formHide()
    }
}
FileManager.prototype.hideLoader = function (input) {
    $(this.loader).hide()
}
FileManager.prototype.showLoader = function (input) {
    $(this.loader).show()
}
FileManager.prototype.clearErrors = function () {
    console.log("FileManager.clearErrors()")
    // ----
    
    this.preview.removeClass("has-errors")
    if (typeof this.previewErrorsContainer !== "undefined") {
        this.previewErrorsContainer.children("ul").html("")
    }
}
FileManager.prototype.pushError = function (errorKey) {
    console.log("FileManager.pushError(errorKey)", errorKey)
    // ----
    
    let e = $.Event("filemanager.error." + errorKey)
    this.errorsEvent.errors.push(e)
    this.inputs.fields.imageFile.trigger(e, [this])
    console.log("|__ this.errorsEvent.errors", this.errorsEvent.errors)
}
FileManager.prototype.showError = function (errorKey) {
    console.log("FileManager.showError(errorKey)", errorKey)
    // ----
    
    if (typeof this.previewErrorsContainer !== "undefined") {
        this.previewErrorsContainer.children("ul").append("<li>" + this.getError(errorKey) + "</li>")
    }
}
FileManager.prototype.getError = function (errorKey) {
    console.log("FileManager.getError(errorKey)", errorKey)
    // ----
    
    let error = this.settings.error[errorKey],
        value = ""
    
    if (errorKey === "fileSize") {
        value = this.settings.maxFileSize
    } else if (errorKey === "minWidth") {
        value = this.settings.minWidth
    } else if (errorKey === "maxWidth") {
        value = this.settings.maxWidth
    } else if (errorKey === "minHeight") {
        value = this.settings.minHeight
    } else if (errorKey === "maxHeight") {
        value = this.settings.maxHeight
    } else if (errorKey === "imageFormat") {
        value = this.settings.allowedFormats.join(", ")
    } else if (errorKey === "fileExtension") {
        value = this.settings.allowedFileExtensions.join(", ")
    }
    
    if (value !== "") {
        return error.replace("{{ value }}", value)
    }
    
    return error
}
FileManager.prototype.createElements = function () {
    this.isInit = true
    
    // Wrapper Elements
    
    // Button Elements
    this.inputs.buttons.close = $(`<a href="javascript:void(0);" id="${this.baseId + "_form_button_close"}" class="panel-button-close fas fa-times"/>`)
    this.inputs.buttons.upload = $(`<button type="button" id="${this.baseId + "_form_button_upload"}" name="submit" class="btn btn-primary btn-sm waves-effect waves-light" >upload</button>`)
    this.inputs.buttons.clear = $(`<button type="button" id="${this.baseId + "_form_button_clear"}" name="clear" class="btn btn-flat primary-text text-center p-1 mx-0 mb-0 waves-effect waves-light" >clear</button>`)
    this.inputs.buttons.cancel = $(`<button type="button" id="${this.baseId + "_form_button_cancel"}" name="cancel" class="btn btn-danger btn-sm waves-effect waves-light" >cancel</button>`)
    this.inputs.buttons.remove = $(`<button type="button" id="${this.baseId + "_form_button_remove"}" name="remove" class="btn btn-outline-danger btn-sm waves-effect waves-ligh" >remove</button>`)
    
    // Field Elements
    this.inputs.fields.imageFile = $(`<input type="file" id="${this.baseId + "_form_file_upload"}" name="${this.baseId + "_form_file_upload"}" />`)
    this.inputs.fields.imageId = $(`<input type="text" id="${this.baseId + "_form_id"}" name="${this.baseId + "_form_id"}" value="" placeholder="" class="form-control" readonly="readonly"/>`)
    this.inputs.fields.imageName = $(`<input type="text" id="${this.baseId + "_form_name"}" name="${this.baseId + "_form_name"}" value="" placeholder="" class="form-control" readonly="readonly"/>`)
    this.inputs.fields.imageEnabled = $(`<input type="checkbox" id="${this.baseId + "_form_enabled"}" name="${this.baseId + "_form_enabled"}" value="1" class="custom-control-input" />`)
    this.inputs.fields.imageIsShown = $(`<input type="checkbox" id="${this.baseId + "_form_is_shown"}" name="${this.baseId + "_form_is_shown"}" value="1" class="custom-control-input" />`)
    this.inputs.fields.imageIsCover = $(`<input type="checkbox" id="${this.baseId + "_form_is_cover"}" name="${this.baseId + "_form_is_cover"}" value="1" class="custom-control-input" />`)
    this.inputs.fields.imageCaption = $(`<textarea id="${this.baseId + "_form_caption"}" name="${this.baseId + "_form_caption"}" class="md-textarea short-description form-control" rows="4" maxlength="200"/>`)
    this.inputs.fields.imageAlt = $(`<input type="text" id="${this.baseId + "_form_alt"}" name="${this.baseId + "_form_alt"}" class="form-control"/>`)
    this.inputs.fields.imageTitle = $(`<input type="text" id="${this.baseId + "_form_title"}" name="${this.baseId + "_form_title"}" class="form-control"/>`)
    this.input = this.inputs.fields.imageFile
    
    // Error Elements
    this.inputs.errors.imageFile = $(`<div id="${this.baseId + '_form_enabled'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageId = $(`<div id="${this.baseId + '_form_id'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageName = $(`<div id="${this.baseId + '_form_name'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageEnabled = $(`<div id="${this.baseId + '_form_enabled'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageIsShown = $(`<div id="${this.baseId + '_form_is_shown'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageIsCover = $(`<div id="${this.baseId + '_form_is_cover'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageCaption = $(`<div id="${this.baseId + '_form_caption'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageAlt = $(`<div id="${this.baseId + '_form_alt'}-error" class="error w-100 text-center"/>`)
    this.inputs.errors.imageTitle = $(`<div id="${this.baseId + '_form_title'}-error" class="error w-100 text-center"/>`)
    
    // Label Elements
    this.inputs.labels.imageEnabled = $(`<label for="${this.baseId + "_form_enabled"}" class="custom-control-label p-0">Enabled</label>`)
    this.inputs.labels.imageIsShown = $(`<label for="${this.baseId + "_form_is_shown"}" class="custom-control-label p-0">Shown</label>`)
    this.inputs.labels.imageIsCover = $(`<label for="${this.baseId + "_form_is_cover"}" class="custom-control-label p-0">Cover</label>`)
    this.inputs.labels.imageId = $(`<label for="${this.baseId + '_form_enabled'}" >Id:</label>`)
    this.inputs.labels.imageTitle = $(`<label for="${this.baseId + '_form_title'}" >Title:</label>`)
    this.inputs.labels.imageAlt = $(`<label for="${this.baseId + '_form_alt'}" >Alt:</label>`)
    this.inputs.labels.imageCaption = $(`<label for="${this.baseId + '_form_caption'}" >Caption:</label>`)
    this.inputs.labels.imageNameField = $(`<label for="${this.baseId + '_form_name'}" >Name:</label>`)
    this.inputs.labels.imageNameDetail = $(`<span class="font-weight-bolder" >Name:</span>`)
    this.inputs.labels.imageRatio = $(`<span class="font-weight-bolder" >Ratio:</span>`)
    this.inputs.labels.imageSize = $(`<span class="font-weight-bolder" >Size:</span>`)
    this.inputs.labels.imageExtension = $(`<span class="font-weight-bolder" >Extension:</span>`)
    this.inputs.labels.imageDimensions = $(`<span class="font-weight-bolder" >Dimensions:</span>`)
    this.inputs.labels.imageType = $(`<span class="font-weight-bolder" >Type:</span>`)
    this.inputs.labels.imageHeight = $(`<span class="font-weight-bolder" >Height:</span>`)
    this.inputs.labels.imageWidth = $(`<span class="font-weight-bolder" >Width:</span>`)
    
    // Display Elements
    this.inputs.displays.imageRatio = $(`<span id="${this.baseId + "_form_ratio"}" />`)
    this.inputs.displays.imageHeight = $(`<span id="${this.baseId + "_form_height"}" />`)
    this.inputs.displays.imageWidth = $(`<span id="${this.baseId + "_form_width"}" />`)
    this.inputs.displays.imageSize = $(`<span id="${this.baseId + "_form_size"}" />`)
    this.inputs.displays.imageExtension = $(`<span id="${this.baseId + "_form_extension"}"/>`)
    this.inputs.displays.imageName = $(`<span id="${this.baseId + "_form_name"}" />`)
    this.inputs.displays.imageDimensions = $(`<span id="${this.baseId + "_form_dimensions"}" />`)
    this.inputs.displays.imageType = $(`<span id="${this.baseId + "_form_type"}" />`)
    
    // Preview Elements
    this.createPreviewElements()
    
    // Detail Elements
    this.detailSection = $(`<section id="${this.baseId + "_detail"}" class="card card-body grey lighten-3 p-3 mb-2"/>`)
    
    this.render()
}
FileManager.prototype.fileGallery = function () {
    let sectionName = "gallery"
    let sectionTitle = (this.source) ? this.source.ucwords() + " Images:" : "Files"
    let $WRAPPER_SUBHEADING, $WRAPPER_HEADING_SPAN, $WRAPPER_HEADING, $WRAPPER, $HR,
        $FIELD_FILE_UPLOAD, $WRAPPER_FILE_UPLOAD, $BUTTON_FILE_UPLOAD, $SPAN_FILE_UPLOAD,
        $WRAPPER_HEADING_ICON, $COL_2_1, $ROW_1, $ROW_2
    
    $WRAPPER_HEADING_ICON = $(`<i/>`, {
        class: "fas fa-sliders-h",
    })
    
    $WRAPPER_HEADING_SPAN = $(`<span/>`, {
        text: sectionTitle,
    })
    
    this.inputs.buttons.toggle = $(`<a/>`, {
        id: this.baseId + "_" + sectionName + "_" + "toggle",
    })
        .append($WRAPPER_HEADING_ICON)
    
    $HR = $(`<hr class="ml-3 mr-3 mt-1 mb-3 color-dark"/>`)
    
    $WRAPPER_HEADING = $(`<h5/>`, {
        class: "card-title label",
        id: this.baseId + "_" + sectionName + "_" + "heading",
    })
    
    $WRAPPER_HEADING.append($WRAPPER_HEADING_SPAN)
    
    $WRAPPER_SUBHEADING = $(`<div/>`, {
        class: "d-flex justify-content-between",
    })
        .append($WRAPPER_HEADING, this.inputs.buttons.toggle)
    
    this.galleryContainer = $("<div/>", {
        id: this.baseId + "_" + sectionName + "_" + "container",
        class: "row",
    })
    
    $SPAN_FILE_UPLOAD = $("<span/>", {
        text: "Choose File",
        id: this.baseId + "_" + sectionName + "_" + "file_upload_label",
    })
    
    this.inputs.fields.imageFileButton = $("<div/>", {
        class: "btn btn-secondary btn-sm waves-effect waves-light",
    })
        .append($SPAN_FILE_UPLOAD, this.inputs.fields.imageFile)
    
    $WRAPPER_FILE_UPLOAD = $("<div/>", {
        class: "d-flex justify-content-end mb-2",
    })
        .append(this.inputs.fields.imageFileButton)
    
    $FIELD_FILE_UPLOAD = $("<div/>", {
        class: "file-field",
    })
        .append($WRAPPER_FILE_UPLOAD)
    
    $COL_2_1 = $("<div/>", {
        class: "col-12",
    })
        .append($FIELD_FILE_UPLOAD)
    
    $ROW_2 = $("<div/>", {
        class: "row",
    })
        .append($COL_2_1)
    
    $WRAPPER = $(`<section/>`, {
        class: "card card-body z-depth-0 mb-2",
        id: this.baseId + "_" + sectionName,
    })
        .append($WRAPPER_SUBHEADING, $HR, this.galleryContainer, $ROW_2)
    
    return $WRAPPER
}
FileManager.prototype.fileFormFields = function () {
    let $WRAPPER, $ROW_1, $ROW_2, $ROW_3, $ROW_4, $ROW_5, $ROW_6, $CHECK_WRAPPER_ENABLED, $CHECK_WRAPPER_IS_SHOWN,
        $CHECK_WRAPPER_IS_COVER, $COL_1_1, $COL_1_2, $COL_2_1, $COL_2_2, $COL_2_3, $COL_3_1, $COL_4_1, $COL_5_1,
        $COL_6_1, $WRAPPER_ID, $WRAPPER_NAME, $WRAPPER_ENABLED, $WRAPPER_IS_SHOWN, $WRAPPER_IS_COVER,
        $WRAPPER_TITLE, $WRAPPER_ALT, $WRAPPER_CAPTION, $ROW_7, $COL_7_1, $COL_7_2, $PROGRESS_WRAPPER
    
    $WRAPPER_ID = $("<div class='form-element'/>")
    $WRAPPER_NAME = $("<div class='form-element'/>")
    $WRAPPER_ENABLED = $("<div class='form-element'/>")
    $WRAPPER_IS_SHOWN = $("<div class='form-element'/>")
    $WRAPPER_IS_COVER = $("<div class='form-element'/>")
    $WRAPPER_CAPTION = $("<div class='form-element mb-4'/>")
    $WRAPPER_ALT = $("<div class='form-element'/>")
    $WRAPPER_TITLE = $("<div class='form-element'/>")
    
    $CHECK_WRAPPER_ENABLED = $("<div/>", { class: "custom-control custom-switch" })
        .append(this.inputs.fields.imageEnabled, this.inputs.labels.imageEnabled)
    $CHECK_WRAPPER_IS_SHOWN = $("<div/>", { class: "custom-control custom-switch" })
        .append(this.inputs.fields.imageIsShown, this.inputs.labels.imageIsShown)
    $CHECK_WRAPPER_IS_COVER = $("<div/>", { class: "custom-control custom-switch" })
        .append(this.inputs.fields.imageIsCover, this.inputs.labels.imageIsCover)
    
    $WRAPPER_ID.append(this.inputs.labels.imageId, this.inputs.fields.imageId, this.inputs.errors.imageId)
    $WRAPPER_NAME.append(this.inputs.labels.imageNameField, this.inputs.fields.imageName, this.inputs.errors.imageName)
    $WRAPPER_ENABLED.append($CHECK_WRAPPER_ENABLED, this.inputs.errors.imageEnabled)
    $WRAPPER_IS_COVER.append($CHECK_WRAPPER_IS_COVER, this.inputs.errors.imageIsCover)
    $WRAPPER_IS_SHOWN.append($CHECK_WRAPPER_IS_SHOWN, this.inputs.errors.imageIsShown)
    $WRAPPER_TITLE.append(this.inputs.labels.imageTitle, this.inputs.fields.imageTitle, this.inputs.errors.imageTitle)
    $WRAPPER_ALT.append(this.inputs.labels.imageAlt, this.inputs.fields.imageAlt, this.inputs.errors.imageAlt)
    $WRAPPER_CAPTION.append(this.inputs.labels.imageCaption, this.inputs.fields.imageCaption, this.inputs.errors.imageCaption)
    
    this.inputs.fields.progress = $(`<div id="${this.baseId + "_progress"}" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"/>`)
    $PROGRESS_WRAPPER = $("<div class='progress'/>")
        .append(this.inputs.fields.progress)
    
    $COL_1_1 = $("<div/>", { class: "col-12 col-md-6" })
        .append($WRAPPER_ID)
    $COL_1_2 = $("<div/>", { class: "col-12 col-md-6" })
        .append($WRAPPER_NAME)
    $COL_2_1 = $("<div/>", { class: "col-12 col-md-4 d-flex align-self-end justify-content-center pb-2 mb-2 mt-4" })
        .append($WRAPPER_ENABLED)
    $COL_2_2 = $("<div/>", { class: "col-12 col-md-4 d-flex align-self-end justify-content-center pb-2 mb-2 mt-4" })
        .append($WRAPPER_IS_SHOWN)
    $COL_2_3 = $("<div/>", { class: "col-12 col-md-4 d-flex align-self-end justify-content-center pb-2 mb-2 mt-4" })
        .append($WRAPPER_IS_COVER)
    $COL_3_1 = $("<div/>", { class: "col-12" })
        .append($WRAPPER_TITLE)
    $COL_4_1 = $("<div/>", { class: "col-12" })
        .append($WRAPPER_ALT)
    $COL_5_1 = $("<div/>", { class: "col-12" })
        .append($WRAPPER_CAPTION)
    $COL_6_1 = $("<div/>", { class: "col-12" })
        .append($PROGRESS_WRAPPER)
    $COL_7_1 = $("<div/>", { class: "col-12 col-md-6 text-left" })
        .append(this.inputs.buttons.cancel, this.inputs.buttons.remove)
    $COL_7_2 = $("<div/>", { class: "col-12 col-md-6 text-right" })
        .append(this.inputs.buttons.clear, this.inputs.buttons.upload)
    
    //Rows
    $ROW_1 = $("<div/>", { class: "row" })
        .append($COL_1_1, $COL_1_2)
    $ROW_2 = $("<div/>", { class: "row" })
        .append($COL_2_1, $COL_2_2, $COL_2_3)
    $ROW_3 = $("<div/>", { class: "row" })
        .append($COL_3_1)
    $ROW_4 = $("<div/>", { class: "row" })
        .append($COL_4_1)
    $ROW_5 = $("<div/>", { class: "row" })
        .append($COL_5_1)
    $ROW_6 = $("<div/>", { class: "row mt-2" })
        .append($COL_6_1)
    $ROW_7 = $("<div/>", { class: "row mt-2" })
        .append($COL_7_1, $COL_7_2)
    
    $WRAPPER = $("<section/>", {
        id: this.baseId + "_" + "form_data",
    })
        .append($ROW_1, $ROW_2, $ROW_3, $ROW_4, $ROW_5, $ROW_6, $ROW_7)
    
    return $WRAPPER
}
FileManager.prototype.fileForm = function () {
    let $WRAPPER_SUBHEADING, $WRAPPER_HEADING_SPAN, $WRAPPER_HEADING, $WRAPPER, $HR
    let sectionName = "form"
    
    this.form = $(`<form id="${this.baseId}_${sectionName}" class="card card-body z-depth-0 mb-2" novalidate="novalidate"/>`)
    
    $WRAPPER_HEADING_SPAN = $(`<span/>`, {
        text: "Image",
    })
    
    $WRAPPER_HEADING = $(`<h5/>`, {
        class: "card-title",
        id: this.baseId + "_" + sectionName + "_" + "heading",
    })
    
    $WRAPPER_SUBHEADING = $(`<h6/>`, {
        id: this.baseId + "_" + sectionName + "_" + "subheading",
    })
    
    $HR = $(`<hr class="ml-3 mr-3 mt-1 mb-3 color-dark"/>`)
    
    $WRAPPER_HEADING.append($WRAPPER_HEADING_SPAN, this.inputs.buttons.close)
    
    this.form.append($WRAPPER_HEADING, $WRAPPER_SUBHEADING, $HR, this.preview, this.fileDetail(this), this.fileFormFields(this))
    
    return this.form
}
FileManager.prototype.fileDetail = function () {
    let $ROW_1, $ROW_2, $ROW_3, $ROW_4, $COL_1_1, $COL_1_2, $COL_1_3, $COL_1_4,
        $COL_2_1, $COL_2_2, $COL_2_3, $COL_2_4, $COL_3_1, $COL_3_2, $COL_3_3, $COL_3_4,
        $COL_4_1, $COL_4_2, $COL_4_3, $COL_4_4
    
    $COL_1_1 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageNameDetail)
    $COL_1_2 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageName)
    $COL_1_3 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageSize)
    $COL_1_4 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageSize)
    $COL_2_1 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageDimensions)
    $COL_2_2 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageDimensions)
    $COL_2_3 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageRatio)
    $COL_2_4 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageRatio)
    $COL_3_1 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageHeight)
    $COL_3_2 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageHeight)
    $COL_3_3 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageWidth)
    $COL_3_4 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageWidth)
    $COL_4_1 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageType)
    $COL_4_2 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageType)
    $COL_4_3 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.labels.imageExtension)
    $COL_4_4 = $(`<div class="col-12 col-md-3 p-1 text-truncate"/>`).append(this.inputs.displays.imageExtension)
    
    $ROW_1 = $(`<div/>`, { class: "row" }).append($COL_1_1, $COL_1_2, $COL_1_3, $COL_1_4)
    $ROW_2 = $(`<div/>`, { class: "row" }).append($COL_2_1, $COL_2_2, $COL_2_3, $COL_2_4)
    $ROW_3 = $(`<div/>`, { class: "row" }).append($COL_3_1, $COL_3_2, $COL_3_3, $COL_3_4)
    $ROW_4 = $(`<div/>`, { class: "row" }).append($COL_4_1, $COL_4_2, $COL_4_3, $COL_4_4)
    
    this.detailSection.append($ROW_1, $ROW_2, $ROW_3, $ROW_4)
    
    return this.detailSection
}
FileManager.prototype.formShow = function () {
    console.log("this.formShow()")
    // ----
    let _input_file = document.getElementById(this.inputs.fields.imageFile.attr("id"))
    let _input_toggle = document.getElementById(this.inputs.buttons.toggle.attr("id"))
    
    this.form.show()
    
    _input_toggle.disabled = true
    _input_file.disabled = true
}
FileManager.prototype.formHide = function () {
    console.log("this.formHide()")
    // ----
    
    let _input_file = document.getElementById(this.inputs.fields.imageFile.attr("id"))
    let _input_toggle = document.getElementById(this.inputs.buttons.toggle.attr("id"))
    
    this.form.hide()
    
    this.inputs.buttons.upload.html("upload")
    
    _input_toggle.disabled = false
    _input_file.disabled = false
}
FileManager.prototype.formClear = function () {
    console.log("FileManager.formClear()", this.inputs)
    // ----
    
    let _progress_bar = document.getElementById(this.inputs.fields.progress.attr("id"))
    
    $(this.inputs.fields.imageId).val("")
    $(this.inputs.fields.imageName).val("")
    $(this.inputs.fields.imageAlt).val("")
    $(this.inputs.fields.imageTitle).val("")
    $(this.inputs.fields.imageCaption).val("")
    
    $(this.inputs.fields.imageIsCover).attr("checked", false)
    $(this.inputs.fields.imageEnabled).attr("checked", true)
    $(this.inputs.fields.imageIsShown).attr("checked", true)
    
    $("img.selected").removeClass("selected")
    
    $(_progress_bar).css({
        "width": "0%",
        "background-color": "#007bff",
        "color": "#fff",
    })
    
    clearValidation(this.form)
}
FileManager.prototype.formReset = function () {
    console.log("this.formReset()")
    // ----
    
    this.formClear()
    this.displayClear()
    this.resetPreview()
    this.clearSelected()
}
FileManager.prototype.formCancel = function () {
    console.log("FileManager.formCancel()")
    // ----
    
    this.formReset()
    this.formHide()
}
FileManager.prototype.formRemove = function () {
    console.log("FileManager.formRemove()")
    // ----
    const _image_id = this.inputs.fields.imageId[0]
    
    let _this = this
    
    if (_image_id) {
        let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
        
        if (imageId !== null) {
            console.log("|__ imageId", imageId)
            let image = _this.all.get(imageId)
            if (image) {
                console.log("|__ image", image)
                let el = document.getElementById("image_" + imageId)
                if (el) {
                    confirmDialog(`Would you like to delete this image?`, (ans) => {
                        if (ans) {
                            this.sendRemoveRequest({
                                image_id: imageId,
                                source: _this.source,
                                source_id: _this.sourceId,
                            }, function (data) {
                                if (data && data.deleted) {
                                    
                                    if (data.deleted === true || data.deleted === "true") {
                                        _this.all.delete(imageId)
                                        $(el).parent("div").remove()
                                        _this.formReset()
                                        _this.formHide()
                                        toastr["success"]("File Removed", "File Manager")
                                    }
                                }
                            })
                        }
                    })
                }
            }
        }
    }
}
FileManager.prototype.formLoad = function (image) {
    console.log("FileManager.formLoad(image)", image)
    // ----
    
    if (image) {
        let imageId = (!isNaN(parseInt(image.id))) ? parseInt(image.id) : null
        let imageName = (image.name) ? image.name : null
        let imageTitle = (image.title) ? image.title : null
        let imageAlt = (image.alt) ? image.alt : null
        let imageCaption = (image.caption) ? image.caption : null
        let imageEnabled = (image.enabled && image.enabled === 1)
        let imageIsShown = !!(image.is_shown && image.is_shown === 1)
        let imageIsCover = !!(image.is_cover && image.is_cover === 1)
        let filePath = (image.path) ? image.path : null
        let fileName = (image.name) ? image.name : null
        let fileExtension = (image.extension) ? image.extension : null
        
        //*
        console.log("|__ imageId", imageId)
        console.log("|__ imageName", imageName)
        console.log("|__ imageTitle", imageTitle)
        console.log("|__ imageAlt", imageAlt)
        console.log("|__ imageCaption", imageCaption)
        console.log("|__ imageEnabled", imageEnabled)
        console.log("|__ imageIsShown", imageIsShown)
        console.log("|__ imageIsCover", imageIsCover)
        //*/
        
        $(this.inputs.fields.imageId).val(imageId)
        $(this.inputs.fields.imageName).val(imageName)
        $(this.inputs.fields.imageAlt).val(imageAlt)
        $(this.inputs.fields.imageTitle).val(imageTitle)
        $(this.inputs.fields.imageCaption).val(imageCaption)
        
        $(this.inputs.fields.imageIsCover).attr("checked", imageIsCover)
        $(this.inputs.fields.imageEnabled).attr("checked", imageEnabled)
        $(this.inputs.fields.imageIsShown).attr("checked", imageIsShown)
        
        let path = (!is_null(filePath) && !is_null(fileName) && !is_null(fileExtension)) ? `${filePath}/${fileName}.${fileExtension}` : (this.settings.defaultFile) ? this.settings.defaultFile : null
        console.log("|__ path", path)
        
        this.setPreview(this.isImage(), path)
        
        this.displaySet()
        
        this.form.show()
    }
}
FileManager.prototype.displayReset = function () {
    console.log("FileManager.displayReset()", this)
    // ----
    
    this.displayClear()
}
FileManager.prototype.displayClear = function () {
    console.log("FileManager.displayClear()", this)
    // ----
    
    $(this.inputs.displays.imageName).html("&nbsp;")
    $(this.inputs.displays.imageType).html("&nbsp;")
    $(this.inputs.displays.imageRatio).html("&nbsp;")
    $(this.inputs.displays.imageExtension).html("&nbsp;")
    $(this.inputs.displays.imageDimensions).html("&nbsp;")
    $(this.inputs.displays.imageSize).html("&nbsp;")
    $(this.inputs.displays.imageHeight).html("&nbsp;")
    $(this.inputs.displays.imageWidth).html("&nbsp;")
}
FileManager.prototype.displaySet = function () {
    console.log("FileManager.displaySet()", this.detail)
    // ----
    
    this.displayReset()
    
    let imageName, imageType, imageRatio, imageExtension, imageDimensions, imageSize, imageHeight, imageWidth
    
    imageName = (this.detail.name) ? this.detail.name : '&nbsp;'
    imageType = (this.detail.type) ? this.detail.type : '&nbsp;'
    imageRatio = (this.detail.ratio) ? this.detail.ratio : '&nbsp;'
    imageExtension = (this.detail.extension) ? this.detail.extension : '&nbsp;'
    imageDimensions = (this.detail.dimensions) ? this.detail.dimensions : '&nbsp;'
    imageSize = (this.detail.size) ? this.detail.size : '&nbsp;'
    imageHeight = (!isNaN(parseInt(this.detail.height))) ? this.detail.height + "px" : '&nbsp;'
    imageWidth = (!isNaN(parseInt(this.detail.width))) ? this.detail.width + "px" : '&nbsp;'
    
    //*
    $(this.inputs.displays.imageName).html(imageName)
    $(this.inputs.displays.imageType).html(imageType)
    $(this.inputs.displays.imageRatio).html(imageRatio)
    $(this.inputs.displays.imageExtension).html(imageExtension)
    $(this.inputs.displays.imageDimensions).html(imageDimensions)
    $(this.inputs.displays.imageSize).html(imageSize)
    $(this.inputs.displays.imageHeight).html(imageHeight)
    $(this.inputs.displays.imageWidth).html(imageWidth)
    //*/
}
FileManager.prototype.handleError = function (msg, title, level) {
    if (!level) {
        level = "error"
    }
    if (!title) {
        title = "File Manager"
    }
    
    toastr[level](msg, title)
}
FileManager.prototype.defaultDetail = function () {
    this.detail = {
        alt: null,
        caption: null,
        created_by: this.userId,
        date_created: formatDateMySQL(),
        date_modified: formatDateMySQL(),
        dimensions: null,
        enabled: 1,
        extension: null,
        height: null,
        id: null,
        is_cover: 0,
        is_shown: 1,
        modified_by: this.userId,
        name: null,
        note: null,
        path: null,
        size: null,
        thumbs_path: null,
        title: null,
        width: null,
    }
}
FileManager.prototype.setDetail = function (image) {
    console.log("FileManager.setDetail(image)", image)
    // ----
    
    this.defaultDetail()
    
    if (image) {
        this.detail.alt = (image.alt) ? image.alt : null
        this.detail.caption = (image.caption) ? image.caption : null
        this.detail.created_by = (!isNaN(parseInt(this.created_by))) ? parseInt(this.created_by) : this.userId
        this.detail.date_created = (image.date_created) ? image.date_created : formatDateMySQL()
        this.detail.date_modified = (image.date_modified) ? image.date_modified : formatDateMySQL()
        this.detail.dimensions = (image.dimensions) ? image.dimensions : null
        this.detail.enabled = (image.enabled && image.enabled === 1) ? 1 : 0
        this.detail.extension = (image.extension) ? image.extension : null
        this.detail.height = (!isNaN(parseInt(image.height))) ? parseInt(image.height) : null
        this.detail.id = (!isNaN(parseInt(image.id))) ? parseInt(image.id) : null
        this.detail.is_cover = (image.is_cover && image.is_cover === 1) ? 1 : 0
        this.detail.is_shown = (image.is_shown && image.is_shown === 1) ? 1 : 0
        this.detail.modified_by = (!isNaN(parseInt(this.modified_by))) ? parseInt(this.modified_by) : this.userId
        this.detail.name = (image.name) ? image.name : null
        this.detail.note = (image.note) ? image.note : null
        this.detail.path = (image.path) ? image.path : null
        this.detail.size = (image.size) ? image.size : null
        this.detail.thumbs_path = (image.thumbs_path) ? image.thumbs_path : null
        this.detail.title = (image.title) ? image.title : null
        this.detail.width = (!isNaN(parseInt(image.width))) ? parseInt(image.width) : null
        
        this.setFile(image)
        
        console.log("|__ this.detail", this.detail)
        console.log("|__ this.file", this.file)
        
        return this.detail
    }
}
FileManager.prototype.loadAll = function () {
    console.log("this.loadAll()")
    // ----
    
    if (!this.images) {
        this.images = []
    }
    
    let all = new Map()
    let _this = this
    
    $.each(this.images, function (k, image) {
        _this.setDetail(image)
        all.set(image.id, image)
        _this.galleryContainer.append(_this.buildImageThumbnails(image))
    })
    
    this.all = all
    
}
FileManager.prototype.buildImageThumbnails = function (image) {
    console.log("this.buildImageThumbnails(image)", image)
    // ----
    
    let isCoverClass = ""
    let isShownClass = ""
    
    if (image) {
        let _this = this
        let src = (image.path) ? image.path : null
        let alt = (image.alt) ? image.alt : null
        let imageId = (image.id && !isNaN(parseInt(image.id))) ? parseInt(image.id) : null
        let isCover = !!(image.is_cover && image.is_cover === 1)
        let isShown = !!(image.is_shown && image.is_shown === 1)
        let thumbsPath = (image.thumbs_path) ? image.thumbs_path : null
        let path = (image.path) ? image.path : null
        let name = (image.name) ? image.name : null
        let extension = (image.extension) ? image.extension : null
        
        if (isCover) {
            isCoverClass = "is-cover-image"
        }
        
        if (isShown) {
            isShownClass = "is-shown"
        }
        
        if (thumbsPath !== null && path !== null && name !== null && extension !== null) {
            let $IMG = $(`<img id="image_${imageId}" data-id="${imageId}" class="img-thumbnail ${isCoverClass} ${isShownClass}" alt="${alt}" src="${thumbsPath}/${name}.${extension}" />`)
            $IMG.on("click", function () {
                _this.edit(image.id)
            })
            
            return $("<div/>", {
                class: "col-12 col-md-4 mb-2",
            })
                .append($IMG)
        }
    }
}
FileManager.prototype.clearSelected = function () {
    console.log("this.clearSelected()")
    // ----
    
    $("img.selected").removeClass("selected")
}
FileManager.prototype.translateMessages = function () {
    console.log("FileManager.translateMessages()")
    // ----
    
    for (let name in this.settings.tpl) {
        console.log("|__ name", name)
        for (let key in this.settings.messages) {
            console.log("|__ |__ key", key)
            if (this.settings.tpl[name]) {
                this.settings.tpl[name] = this.settings.tpl[name].replace("{{ " + key + " }}", this.settings.messages[key])
            } else if (this.settings.tpl.preview[name]) {
                this.settings.tpl.preview[name] = this.settings.tpl.preview[name].replace("{{ " + key + " }}", this.settings.messages[key])
            }
            
        }
    }
}
FileManager.prototype.cleanFilename = function (src) {
    var filename = src.split("\\").pop()
    if (filename === src) {
        filename = src.split("/").pop()
    }
    
    return src !== "" ? filename : ""
}
FileManager.prototype.validateImage = function () {
    if (this.settings.minWidth !== 0 && this.settings.minWidth >= this.file.width) {
        this.pushError("minWidth")
    }
    
    if (this.settings.maxWidth !== 0 && this.settings.maxWidth <= this.file.width) {
        this.pushError("maxWidth")
    }
    
    if (this.settings.minHeight !== 0 && this.settings.minHeight >= this.file.height) {
        this.pushError("minHeight")
    }
    
    if (this.settings.maxHeight !== 0 && this.settings.maxHeight <= this.file.height) {
        this.pushError("maxHeight")
    }
    
    if (this.settings.allowedFormats.indexOf(this.getImageFormat()) === "-1") {
        this.pushError("imageFormat")
    }
}
FileManager.prototype.checkFileSize = function () {
    if (this.sizeToByte(this.settings.maxFileSize) !== 0 && this.file.size > this.sizeToByte(this.settings.maxFileSize)) {
        this.pushError("fileSize")
    }
}
FileManager.prototype.isFileExtensionAllowed = function () {
    console.log("FileManager.isFileExtensionAllowed")
    // ----
    
    if (this.settings.allowedFileExtensions.indexOf("*") !== "-1" ||
        this.settings.allowedFileExtensions.indexOf(this.getFileType()) !== "-1") {
        return true
    }
    
    this.pushError("fileExtension")
    
    return false
}
FileManager.prototype.isImage = function (image) {
    console.log("FileManager.isImage")
    // ----
    
    let allowedExtensions = this.settings.imgFileExtensions
    let fileType = this.getFileType()
    let index = allowedExtensions.indexOf(fileType)
    
    /*
    console.log("|__ allowedExtensions", allowedExtensions)
    console.log("|__ fileType", fileType)
    console.log("|__ index", index)
    //*/
    
    return index >= 0
}
FileManager.prototype.getFileType = function () {
    console.log("FileManager.getFileType()")
    // ----
    
    return this.file.name.split(".").pop().toLowerCase()
}
FileManager.prototype.getImageFormat = function () {
    if (this.file.width === this.file.height) {
        return "square"
    }
    
    if (this.file.width < this.file.height) {
        return "portrait"
    }
    
    if (this.file.width > this.file.height) {
        return "landscape"
    }
}
FileManager.prototype.setFileName = function (file) {
    console.log("FileManager.setFileName(file)", file)
    // ----
    
    let fileName, fileExtension = null
    let fileNameTemp = []
    
    if (file) {
        if (file.name) {
            let fileNameParts = file.name.split(".")
            
            if (fileNameParts.length) {
                fileExtension = fileNameParts[fileNameParts.length - 1]
                for (let n = 0; n < fileNameParts.length - 1; n++) {
                    fileNameTemp.push(fileNameParts[n])
                }
                fileName = fileNameTemp.join(".")
            }
            
        }
    }
    
    this.detail.name = fileName
    this.detail.extension = fileExtension
}
FileManager.prototype.setFileDetail = function (file) {
    console.log("FileManager.setFileDetail(file)", file)
    // ----
    
    this.detail.path = `/public/img/${this.source}/${this.sourceId}`
    this.detail.thumbs_path = `/public/img/${this.source}/${this.sourceId}`
    this.detail.id = null
    this.detail.title = null
    this.detail.alt = null
    this.detail.title = null
    this.detail.caption = null
    this.detail.enabled = 1
    this.detail.is_shown = 1
    this.detail.is_cover = 0
    this.detail.date_created = formatDateMySQL()
    this.detail.date_modified = formatDateMySQL()
    this.detail.created_by = this.userId
    this.detail.modified_by = this.userId
    this.detail.note = null
}
FileManager.prototype.setFileDimensions = function (width, height) {
    console.log("FileManager.setFileDimensions(width, height)", width, height)
    // ----
    
    this.file.width = null
    this.file.height = null
    this.detail.dimensions = null
    this.detail.width = null
    this.detail.height = null
    
    if (width && height) {
        this.file.width = width
        this.file.height = height
        this.detail.dimensions = `${width} x ${height}`
        this.detail.width = width
        this.detail.height = height
    }
}
FileManager.prototype.setFileSize = function (file) {
    console.log("FileManager.setFileSize(file)", file)
    // ----
    
    let fileSize = null
    
    if (file.size > 1024 * 1024) {
        fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + "MB"
    } else {
        fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + "KB"
    }
    
    this.detail.size = fileSize
}
FileManager.prototype.setFileInformation = function (file) {
    console.log("FileManager.setFileInformation(file)", file)
    // ----
    
    this.file.object = file
    this.file.name = file.name
    this.file.size = file.size
    this.file.type = file.type
    this.file.width = null
    this.file.height = null
    
    this.detail.type = file.type
}
FileManager.prototype.sizeToByte = function (size) {
    let value = 0
    
    if (size !== 0) {
        let unit = size.slice(-1).toUpperCase(),
            kb = 1024,
            mb = kb * 1024,
            gb = mb * 1024
        
        if (unit === "K") {
            value = parseFloat(size) * kb
        } else if (unit === "M") {
            value = parseFloat(size) * mb
        } else if (unit === "G") {
            value = parseFloat(size) * gb
        }
    }
    
    return value
}
FileManager.prototype.findClosest = function (arrSorted, value) {
    console.log("FileManager.findClosest(arrSorted, value)", arrSorted, value)
    // ----
    
    let closest = arrSorted[0]
    let closestDiff = Math.abs(arrSorted[0] - value)
    
    for (let i = 1; i < arrSorted.length; i++) {
        let diff = Math.abs(arrSorted[i] - value)
        if (diff < closestDiff) {
            closestDiff = diff
            closest = arrSorted[i]
        } else {
            return closest
        }
    }
    return arrSorted[arrSorted.length - 1]
}
FileManager.prototype.estimateAspectRatio = function (width, height) {
    console.log("FileManager.estimateAspectRatio(width, height)", width, height)
    // ----
    
    let ratio = Math.max(width, height) / Math.min(width, height)
    if (ratio in LOOKUP) {
        this.detail.ratio = LOOKUP[ratio]
        return
    }
    
    let closest = this.findClosest(RATIOS, ratio)
    if (Math.abs(closest - ratio) <= ERROR_ALLOWED) {
        this.detail.ratio = LOOKUP[closest]
        return
    }
    
    this.detail.ratio = Math.round(ratio * 100) / 100 + ":1"
}
FileManager.prototype.resetFile = function () {
    console.log("FileManager.resetFile()")
    // ----
    
    this.file.object = null
    
    this.file.name = null
    this.file.size = null
    this.file.type = null
    this.file.width = null
    this.file.height = null
}
FileManager.prototype.setFile = function (file) {
    console.log("FileManager.setFile(file)", file)
    // ----
    
    this.resetFile()
    
    if (file) {
        let fileName = (file.name && file.extension) ? file.name + "." + file.extension : null
        let fileType = (file.extension) ? FILE_TYPES[file.extension] : null
        let fileSize = (file.size && (!isNaN(parseInt(formatSize(file.size))))) ? parseInt(formatSize(file.size)) : null
        let fileSizeFormatted = (file.size) ? file.size : null
        let fileWidth = (file.width && (!isNaN(parseInt(file.width)))) ? parseInt(file.width) : null
        let fileHeight = (file.height && (!isNaN(parseInt(file.height)))) ? parseInt(file.height) : null
        
        /*
        console.log("|__ fileName", fileName)
        console.log("|__ fileType", fileType)
        console.log("|__ fileSize", fileSize)
        console.log("|__ fileSizeFormatted", fileSizeFormatted)
        console.log("|__ fileWidth", fileWidth)
        console.log("|__ fileHeight", fileHeight)
        //*/
        
        this.file.object = (file.object) ? file.object : null
        this.file.size = fileSize
        this.file.name = fileName
        this.file.sizeFormatted = fileSizeFormatted
        this.file.type = fileType
        this.file.width = fileWidth
        this.file.height = fileHeight
        this.detail.type = fileType
        this.detail.width = fileWidth
        this.detail.height = fileHeight
        
        this.setFileDimensions(this.file.width, this.file.height)
        this.estimateAspectRatio(this.file.width, this.file.height)
    }
}
FileManager.prototype.fileSelected = function (event) {
    console.log("FileManager.fileSelected(event)", event)
    // ----
    
    this.readFile(this.inputs.fields.imageFile[0])
}
FileManager.prototype.readFile = function (input) {
    console.log("FileManager.readFile(input)", input)
    // ----
    
    if (!input || !input.files[0]) {
        this.handleError("Missing fields", "File Manager", "error")
    }
    
    const reader = new FileReader()
    const image = new Image()
    
    let file = input.files[0]
    let srcBase64 = null
    let _this = this
    let eventFileReady = $.Event("filemanager.fileReady")
    let _remove_button = document.getElementById($(this.inputs.buttons.remove).attr("id"))
    
    this.errorsEvent.errors = []
    
    this.showLoader()
    this.setFileInformation(file)
    this.setFileDetail(file)
    this.checkFileSize()
    this.isFileExtensionAllowed()
    
    if (this.isImage() && this.file.size < this.sizeToByte(this.settings.maxFileSizePreview)) {
        this.inputs.fields.imageFile.on("filemanager.fileReady", this.onFileReady)
        reader.readAsDataURL(file)
        reader.onload = function (_file) {
            srcBase64 = _file.target.result
            image.src = _file.target.result
            image.onload = function () {
                _this.setFileDimensions(this.width, this.height)
                _this.estimateAspectRatio(this.width, this.height)
                _this.setFileSize(file)
                _this.setFileName(file)
                _this.validateImage()
                $(_this.input).trigger(eventFileReady, [true, srcBase64])
                //*
                console.log("|__ file", _this.file)
                console.log("|__ detail", _this.detail)
                //*/
                _this.displaySet()
                _remove_button.disabled = true
            }
        }.bind(this)
    } else {
        this.onFileReady(false)
    }
    
}
FileManager.prototype.onFileReady = function (event, previewable, src) {
    console.log("FileManager.onFileReady(event, previewable, src)", event)
    // ----
    
    $(this.inputs.fields.imageFile).off("fileManager.fileReady", this.onFileReady)
    //*
    console.log("|__ this.errorsEvent.errors", this.errorsEvent.errors)
    //*/
    if (this.errorsEvent.errors.length === 0) {
        this.setPreview(previewable, src)
    } else {
        this.inputs.fields.imageFile.trigger(this.errorsEvent, [this])
        for (let i = this.errorsEvent.errors.length - 1; i >= 0; i--) {
            let errorNamespace = this.errorsEvent.errors[i].namespace
            let errorKey = errorNamespace.split(".").pop()
            this.showError(errorKey)
        }
        
        if (typeof this.previewErrorsContainer !== "undefined") {
            this.previewErrorsContainer.addClass("visible")
            
            let errorsContainer = this.previewErrorsContainer
            let previewContainer = this.preview
            setTimeout(function () {
                errorsContainer.removeClass("visible")
                previewContainer.removeClass("has-error")
            }, this.settings.errorTimeout)
        }
        
        this.resetPreview()
    }
}
FileManager.prototype.onChange = function (event) {
    if ($(this.inputs.fields.imageFile).val() !== "") {
        this.formReset()
        this.fileSelected(event)
    } else {
        this.formReset(event)
    }
}
FileManager.prototype.isShown = function () {
    console.log("FileManager.isShown()")
    // ----
    const _is_shown = document.getElementById($(this.inputs.fields.imageIsShown).attr("id"))
    const _image_id = document.getElementById($(this.inputs.fields.imageId).attr("id"))
    //*
    console.log("|__ _is_shown", _is_shown)
    console.log("|__ _image_id", _image_id)
    //*/
    if (_is_shown && _image_id) {
        let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
        if (imageId) {
            let _element = document.getElementById("image_" + imageId)
            if (_element) {
                if (_is_shown.checked === true) {
                    $(_element).addClass("is-shown")
                } else {
                    $(_element).removeClass("is-shown")
                }
            }
        }
    }
}
FileManager.prototype.isCover = function () {
    console.log("FileManager.isCover()")
    // ----
    const _is_cover = document.getElementById($(this.inputs.fields.imageIsCover).attr("id"))
    const _image_id = document.getElementById($(this.inputs.fields.imageId).attr("id"))
    //*
    console.log("|__ _is_cover", _is_cover)
    console.log("|__ _image_id", _image_id)
    //*/
    if (_is_cover && _image_id) {
        let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
        if (imageId) {
            let _element = document.getElementById("image_" + imageId)
            if (_element) {
                if (_is_cover.checked === true) {
                    $("img.is-cover-image").removeClass("is-cover-image")
                    $(_element).addClass("is-cover-image")
                } else {
                    $(_element).removeClass("is-cover-image")
                }
            }
        }
    }
}
FileManager.prototype.formUpload = function () {
    console.log("FileManager.formUpload()")
    // ----
    const _image_id = document.getElementById($(this.inputs.fields.imageId).attr("id"))
    const _image_alt = document.getElementById($(this.inputs.fields.imageAlt).attr("id"))
    const _image_title = document.getElementById($(this.inputs.fields.imageTitle).attr("id"))
    const _image_caption = document.getElementById($(this.inputs.fields.imageCaption).attr("id"))
    const _image_is_shown = document.getElementById($(this.inputs.fields.imageIsShown).attr("id"))
    const _image_enabled = document.getElementById($(this.inputs.fields.imageEnabled).attr("id"))
    const _image_is_cover = document.getElementById($(this.inputs.fields.imageIsCover).attr("id"))
    const _image_height = document.getElementById($(this.inputs.displays.imageHeight).attr("id"))
    const _image_width = document.getElementById($(this.inputs.displays.imageWidth).attr("id"))
    const _image_extension = document.getElementById($(this.inputs.displays.imageExtension).attr("id"))
    const _image_dimensions = document.getElementById($(this.inputs.displays.imageDimensions).attr("id"))
    const _image_size = document.getElementById($(this.inputs.displays.imageSize).attr("id"))
    const _image_ratio = document.getElementById($(this.inputs.displays.imageRatio).attr("id"))
    const _image_file = document.getElementById($(this.inputs.fields.imageFile).attr("id"))
    const _image_file_type = document.getElementById($(this.inputs.displays.imageType).attr("id"))
    
    let filePath, fileHeight, fileWidth, fileSize, fileExtension, fileName,
        fileType, fileRatio, fileDimensions, source, sourceId,
        fileTitle, fileAlt, fileCaption, fileIsShown, fileIsCover, fileEnabled, fileId,
        fileThumbsPath, tempHeight, tempWidth = null
    let formData = new FormData()
    let xhr = new XMLHttpRequest()
    let _this = this
    
    tempHeight = (_image_height) ? _image_height.innerHTML : null
    tempHeight = tempHeight.replace("px", "")
    tempHeight = parseInt(tempHeight)
    
    tempWidth = (_image_width) ? _image_width.innerHTML : null
    tempWidth = tempWidth.replace("px", "")
    tempWidth = parseInt(tempWidth)
    
    fileId = (_image_id && !isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
    fileCaption = (_image_caption && _image_caption.value !== "") ? _image_caption.value : null
    fileTitle = (_image_title && _image_title.value !== "") ? _image_title.value : null
    fileType = (_image_file_type && _image_file_type.innerHTML !== "") ? _image_file_type.innerHTML : null
    fileAlt = (_image_alt && _image_alt.value !== "") ? _image_alt.value : null
    fileIsShown = (_image_is_shown && _image_is_shown.checked === true) ? 1 : 0
    fileEnabled = (_image_enabled && _image_enabled.checked === true) ? 1 : 0
    fileIsCover = (_image_is_cover && _image_is_cover.checked === true) ? 1 : 0
    fileName = (document.getElementById($(this.inputs.displays.imageName).attr("id"))) ? document.getElementById($(this.inputs.displays.imageName).attr("id")).innerText : null
    fileExtension = (_image_extension) ? _image_extension.innerText : null
    fileSize = (_image_size) ? _image_size.innerText : null
    fileDimensions = (_image_dimensions) ? _image_dimensions.innerText : null
    fileWidth = (tempWidth) ? (!isNaN(parseInt(tempWidth))) ? parseInt(tempWidth) : null : null
    fileHeight = (tempHeight) ? (!isNaN(parseInt(tempHeight))) ? parseInt(tempHeight) : null : null
    fileRatio = (_image_ratio) ? _image_ratio.innerText : null
    source = _this.source
    sourceId = _this.sourceId
    filePath = `/public/img/${source}/${sourceId}`
    fileThumbsPath = `/public/thumbs/${source}/${sourceId}`
    
    let dataToSend = {
        alt: fileAlt,
        caption: fileCaption,
        dimensions: fileDimensions,
        directory: source,
        directory_id: sourceId,
        enabled: fileEnabled,
        extension: fileExtension,
        height: fileHeight,
        id: fileId,
        is_cover: fileIsCover,
        is_shown: fileIsShown,
        name: fileName,
        path: filePath,
        ratio: fileRatio,
        size: fileSize,
        thumbs_path: fileThumbsPath,
        type: fileType,
        title: fileTitle,
        width: fileWidth,
    }
    
    if (this.validate()) {
        let imageId = (!isNaN(parseInt(_image_id.value))) ? parseInt(_image_id.value) : null
        
        if (imageId !== null) {
            confirmDialog(`Would you like to update this image?`, (ans) => {
                if (ans) {
                    this.sendUpdateRequest(removeNulls(dataToSend), function (data) {
                        if (data) {
                            console.log("|__ data", data)
                            let detail = _this.setDetail((data[0]) ? data[0] : data)
                            if (detail.id && detail.name) {
                                console.log("|__ detail", detail)
                                let image = _this.all.get(detail.id)
                                console.log("|__ image", image)
                                
                                _this.all.set(detail.id, detail)
                                
                                _this.formReset()
                                _this.formHide()
                                
                                toastr["success"](`${detail.name} - has been updated`, "File Manager")
                            } else {
                                console.log("|__ data", data)
                                toastr["error"](`${detail.name} - has not been updated`, "File Manager")
                            }
                        }
                    })
                }
            })
        } else {
            confirmDialog(`Would you like to add this image?`, (ans) => {
                if (ans) {
                    let file = _image_file.files[0]
                    if (file) {
                        dataToSend.file = file
                        
                        formData.append("dimensions", fileDimensions)
                        formData.append("extension", fileExtension)
                        formData.append("file", _image_file.files[0], `${fileName}.${fileExtension}`)
                        formData.append("height", fileHeight)
                        formData.append("name", fileName)
                        formData.append("path", filePath)
                        formData.append("thumbs_path", fileThumbsPath)
                        formData.append("ratio", fileRatio)
                        formData.append("size", fileSize)
                        formData.append("type", fileType)
                        formData.append("width", fileWidth)
                        formData.append("directory", source)
                        formData.append("directory_id", sourceId)
                        formData.append("title", fileTitle)
                        formData.append("enabled", fileEnabled)
                        formData.append("is_shown", fileIsShown)
                        formData.append("is_cover", fileIsCover)
                        formData.append("alt", fileAlt)
                        formData.append("caption", fileCaption)
                        
                        xhr.upload.addEventListener("progress", this.uploadProgress, false)
                        xhr.addEventListener("load", this.uploadComplete, false)
                        xhr.addEventListener("error", this.uploadFailed, false)
                        xhr.addEventListener("abort", this.uploadCanceled, false)
                        
                        switch (source.toLowerCase()) {
                            case "product":
                                xhr.open("POST", "/api/v1.0/upload/product")
                                xhr.send(formData)
                                break
                            case "unit":
                                xhr.open("POST", "/api/v1.0/upload/unit")
                                xhr.send(formData)
                                break
                            case "company":
                                xhr.open("POST", "/api/v1.0/upload/company")
                                xhr.send(formData)
                                break
                            case "user":
                                xhr.open("POST", "/api/v1.0/upload/user")
                                xhr.send(formData)
                                break
                            default:
                                return
                        }
                    }
                }
            })
        }
    }
}
FileManager.prototype.uploadComplete = function (event) {
    console.log("FileManager.uploadComplete(event)", event)
    // ----
    
    let results = null
    
    if (event) {
        if (event.target) {
            if (event.target.responseText) {
                const image = JSON.parse(event.target.responseText)
                console.log("image", image)
                if (image) {
                    if (image.status && image.status === "success" && image.result !== undefined) {
                        
                        results = (image.result[0]) ? image.result[0] : image.result
                        
                        this.formReset()
                        this.formHide()
                        this.all.set(results.id, results)
                        this.galleryContainer.append(this.buildImageThumbnails(results))
                        
                        toastr["success"](`Image ${results.name} was added.`, "File Manager")
                        
                    } else if (image.status && image.status === "error" && image.error !== undefined) {
                        results = image.error
                        let counter = 1
                        let count = results.length
                        
                        $.each(results, function (i, err) {
                            console.log(`Error(${counter} of ${count}): `, err)
                            
                            counter++
                        })
                        
                        this.formReset()
                        this.formHide()
                        
                        toastr["warning"](`Image was added with issues.`, "File Manager")
                    }
                }
            }
        }
    }
}
FileManager.prototype.uploadProgress = function (event) {
    console.log("FileManager.uploadProgress(event)", event)
    // ----
    
    let _progress_bar = document.getElementById(this.inputs.fields.progress.attr("id"))
    
    if (event.lengthComputable) {
        let percentComplete = Math.round(event.loaded * 100 / event.total)
        
        _progress_bar.innerHTML = percentComplete.toString() + "%"
        $(_progress_bar).css({
            "width": `${percentComplete}%`,
            "background-color": "#007bff",
            "color": "#fff",
        })
    } else {
        _progress_bar.innerHTML = "unable to compute"
        $(_progress_bar).css({
            "width": "100%",
            "background-color": "#c58e34",
            "color": "#06030a",
        })
    }
}
FileManager.prototype.uploadFailed = function (event) {
    console.log("FileManager.uploadFailed(event)", event)
    // ----
    
}
FileManager.prototype.uploadCanceled = function (event) {
    console.log("FileManager.uploadFailed(event)", event)
    // ----
    
}
FileManager.prototype.sendRemoveRequest = function (dataToSend, callback) {
    console.log("FileManager.sendRemoveRequest(dataToSend, callback)", dataToSend, callback)
    // ----
    
    if (dataToSend) {
        let url = "/api/v1.0/images/remove"
        try {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                }
            })
        } catch (e) {
            console.log("error", e)
            return this.handleError("Error Removing Image.", "Image Manager", "error")
        }
    }
}
FileManager.prototype.sendUpdateRequest = function (dataToSend, callback) {
    console.log("FileManager.sendUpdateRequest(dataToSend, callback)", dataToSend, callback)
    // ----
    
    let _this = this
    let source = (this.source) ? this.source : null
    let sourceId = (!isNaN(parseInt(this.sourceId))) ? parseInt(this.sourceId) : null
    
    if (dataToSend && source !== null && sourceId !== null) {
        let url = `/api/v1.0/images/update`
        try {
            sendPostRequest(url, dataToSend, function (data, status, xhr) {
                if (data) {
                    return callback(data)
                }
            })
        } catch (e) {
            console.log("error", e)
            return _this.handleError("Error Retrieving Images.", "Image Manager", "error")
        }
    }
}
FileManager.prototype.validate = function () {
    console.log("FileManager.validate()")
    // ----
    let _form = this.form[0]
    return $(_form).valid()
}
FileManager.prototype.formRules = function () {
    console.log("FileManager.formRules()")
    // ----
    let rules = {}
    let messages = {}
    
    rules[`file_manager_${this.source}_form_title`] = {
        required: true,
    }
    rules[`file_manager_${this.source}_form_alt`] = {
        required: true,
    }
    rules[`file_manager_${this.source}_form_caption`] = {
        required: true,
    }
    
    messages[`file_manager_${this.source}_form_title`] = {
        required: "Field is required.",
    }
    messages[`file_manager_${this.source}_form_alt`] = {
        required: "Field is required.",
    }
    messages[`file_manager_${this.source}_form_caption`] = {
        required: "Field is required.",
    }
    
    return {
        rules: rules,
        messages: messages,
    }
}
FileManager.prototype.assignEvents = function () {
    console.log("FileManager.assignEvents()")
    // ----
    
    let _form = this.form[0]
    let formRules = this.formRules()
    
    initializeValidator(formRules)
    
    this.inputs.buttons.toggle.on("click", this.open)
    this.inputs.buttons.close.on("click", this.formHide)
    this.inputs.buttons.cancel.on("click", this.formCancel)
    this.inputs.buttons.remove.on("click", this.formRemove)
    this.inputs.buttons.clear.on("click", this.formClear)
    this.inputs.buttons.upload.on("click", this.formUpload)
    this.inputs.fields.imageFile.on("change", this.onChange)
    this.inputs.fields.imageIsShown.on("change", this.isShown)
    this.inputs.fields.imageIsCover.on("change", this.isCover)
    this.validator = $(_form).validate()
    
}
FileManager.prototype.edit = function (imageId) {
    console.log("FileManager.edit(imageId)", imageId)
    // ----
    
    let _remove_button = document.getElementById($(this.inputs.buttons.remove).attr("id"))
    
    this.formReset()
    this.inputs.buttons.upload.html("Update")
    
    if (imageId) {
        let image = this.all.get(imageId)
        let elementId = (imageId) ? "image_" + imageId.toString() : null
        let imageElement = document.getElementById(elementId)
        
        if (image && imageElement) {
            
            $(imageElement).addClass("selected")
            
            this.setDetail(image)
            this.formLoad(image)
            _remove_button.disabled = false
        }
    }
}
FileManager.prototype.open = function () {
    console.log("FileManager.open()")
    // ----
    
    $(this.inputs.fields.imageFile).trigger("click")
}
FileManager.prototype.render = function () {
    this.form = this.fileForm()
    this.gallery = this.fileGallery()
    
    $(this.element).append(this.form, this.gallery)
    this.input = $(this.inputs.fields.imageFile)[0]
    
    /**
     * Initialize Validation
     */
    let _form = document.getElementById($(this.form).attr("id"))
    //*
    initializeValidator()
    //*/
    //console.log("_form", _form)
    //return $(_form).valid()
    this.formHide()
}
FileManager.prototype.load = function (options) {
    console.log("FileManager.load(options)", options)
    // ----
    
    if (options && options.source && options.sourceId) {
        this.all = new Map()
        this.source = (options.source) ? options.source : null
        this.images = (options.images) ? options.images : []
        this.sourceId = (!isNaN(parseInt(options.sourceId))) ? parseInt(options.sourceId) : null
        this.formReset()
        this.formHide()
        this.galleryContainer.empty()
        this.loadAll()
    }
}
FileManager.prototype.init = function (options) {
    console.log("FileManager.init(options)", options)
    // ----
    
    /**
     * Display Elements
     */
    this.inputs.displays.imageId = null
    this.inputs.displays.imageName = null
    this.inputs.displays.imageAlt = null
    this.inputs.displays.imageTitle = null
    this.inputs.displays.imageIsCover = null
    this.inputs.displays.imagePath = null
    this.inputs.displays.imageExtension = null
    this.inputs.displays.imageDimensions = null
    this.inputs.displays.imageSize = null
    this.inputs.displays.imageHeight = null
    this.inputs.displays.imageWidth = null
    this.inputs.displays.imageEnabled = null
    this.inputs.displays.imageDateCreated = null
    this.inputs.displays.imageCreatedBy = null
    this.inputs.displays.imageDateModified = null
    this.inputs.displays.imageModifiedBy = null
    this.inputs.displays.imageNote = null
    this.inputs.displays.imageFile = null
    this.inputs.displays.imageType = null
    this.inputs.displays.imageRatio = null
    
    /**
     * Error Elements
     */
    this.inputs.errors.imageId = null
    this.inputs.errors.imageName = null
    this.inputs.errors.imageAlt = null
    this.inputs.errors.imageTitle = null
    this.inputs.errors.imageIsCover = null
    this.inputs.errors.imageEnabled = null
    this.inputs.errors.imageIsShown = null
    this.inputs.errors.imageFile = null
    
    /**
     * Label Elements
     */
    this.inputs.labels.imageId = null
    this.inputs.labels.imageNameField = null
    this.inputs.labels.imageNameDetail = null
    this.inputs.labels.imageAlt = null
    this.inputs.labels.imageTitle = null
    this.inputs.labels.imageIsCover = null
    this.inputs.labels.imageEnabled = null
    this.inputs.labels.imageIsShown = null
    
    /**
     * Input Elements
     */
    this.inputs.fields.imageId = null
    this.inputs.fields.imageName = null
    this.inputs.fields.imageAlt = null
    this.inputs.fields.imageTitle = null
    this.inputs.fields.imageIsCover = null
    this.inputs.fields.imageEnabled = null
    this.inputs.fields.imageIsShown = null
    this.inputs.fields.progress = null
    
    /**
     * Button Elements
     */
    this.inputs.buttons.toggle = null
    this.inputs.buttons.close = null
    this.inputs.buttons.cancel = null
    this.inputs.buttons.remove = null
    this.inputs.buttons.clear = null
    this.inputs.buttons.upload = null
    this.inputs.fields.imageFileButton = null
    
    /**
     * Loader Elements
     */
    this.loader = null
    this.input = null
    this.file.sizeFormatted = null
    
    /**
     * Sections
     */
    this.form = null
    this.gallery = null
    this.preview = null
    this.detailSection = null
    this.galleryContainer = null
    
    /**
     * URL's
     */
    this.settings.urls = {
        "get": `/api/v1.0/images/${this.source}/${this.sourceId}`,
        "update": `/api/v1.0/images/update`,
        "remove": `/api/v1.0/images/remove`,
    }
    
}

$.fn.fileManager = function (options) {
    "use strict"
    
    return new FileManager(document.getElementById($(this).attr("id")), options)
}

const Product = (function () {
    "use strict"
    
    const base_url = "/products"
    const regex = /[^A-Za-z0-9]/g
    const _product_edit_meta_description_long_update_button = document.getElementById("product_edit_meta_description_long_update_button")
    const _product_edit_meta_description_short_update_button = document.getElementById("product_edit_meta_description_short_update_button")
    const _product_edit_meta_product_amenities_update_button = document.getElementById("product_edit_meta_product_amenities_update_button")
    const _product_edit_meta_product_keywords_update_button = document.getElementById("product_edit_meta_product_keywords_update_button")
    const _product_edit_details_section_publish = document.getElementById("product_edit_details_section_publish")
    const _product_edit_details_section_save_draft = document.getElementById("product_edit_details_section_save_draft")
    const _form_product_add = document.getElementById("form_product_add")
    const _modal_product_depart_from_time = document.getElementById("modal_product_depart_from_time")
    const _modal_product_depart_from_date = document.getElementById("modal_product_depart_from_date")
    const _modal_product_arrive_to_time = document.getElementById("modal_product_arrive_to_time")
    const _modal_product_arrive_to_date = document.getElementById("modal_product_arrive_to_date")
    const _modal_product_depart_from_station = document.getElementById("modal_product_depart_from_station")
    const _modal_product_arrive_to_station = document.getElementById("modal_product_arrive_to_station")
    const _modal_product_depart_from_airport = document.getElementById("modal_product_depart_from_airport")
    const _modal_product_arrive_to_airport = document.getElementById("modal_product_arrive_to_airport")
    const _modal_product_depart_from_station_id = document.getElementById("modal_product_depart_from_station_id")
    const _modal_product_arrive_to_station_id = document.getElementById("modal_product_arrive_to_station_id")
    const _modal_product_depart_from_airport_id = document.getElementById("modal_product_depart_from_airport_id")
    const _modal_product_arrive_to_airport_id = document.getElementById("modal_product_arrive_to_airport_id")
    const _modal_button_cancel_add_product = document.getElementById("modal_button_cancel_add_product")
    const _modal_button_submit_add_product = document.getElementById("modal_button_submit_add_product")
    const _modal_product_provider_name = document.getElementById("modal_product_provider_name")
    const _modal_product_vendor_name = document.getElementById("modal_product_vendor_name")
    const _modal_product_provider_id = document.getElementById("modal_product_provider_id")
    const _modal_product_vendor_id = document.getElementById("modal_product_vendor_id")
    const _modal_new_product = document.getElementById("modal_new_product")
    const _modal_product_name = document.getElementById("modal_product_name")
    const _modal_product_category_id = document.getElementById("modal_product_category_id")
    const _modal_product_sku = document.getElementById("modal_product_sku")
    const _modal_product_rating_types_id = document.getElementById("modal_product_rating_types_id")
    const _modal_product_currency_id = document.getElementById("modal_product_currency_id")
    const _modal_product_pricing_strategies_types_id = document.getElementById("modal_product_pricing_strategies_types_id")
    const _modal_product_provider_company_id = document.getElementById("modal_product_provider_company_id")
    const _modal_product_vendor_company_id = document.getElementById("modal_product_vendor_company_id")
    const _modal_product_provider_vendor_match = document.getElementById("modal_product_provider_vendor_match")
    const _modal_product_provider_location_id = document.getElementById("modal_product_provider_location_id")
    const _modal_product_location_id = document.getElementById("modal_product_location_id")
    const _modal_product_street_1 = document.getElementById("modal_product_street_1")
    const _modal_product_street_2 = document.getElementById("modal_product_street_2")
    const _modal_product_postal_code = document.getElementById("modal_product_postal_code")
    const _modal_product_city_id = document.getElementById("modal_product_city_id")
    const _modal_product_province_id = document.getElementById("modal_product_province_id")
    const _modal_product_country_id = document.getElementById("modal_product_country_id")
    const _modal_product_city = document.getElementById("modal_product_city")
    const _modal_product_day_span = document.getElementById("modal_product_day_span")
    const _modal_button_clear_add_product = document.getElementById("modal_button_clear_add_product")
    const _modal_product_depart_from_station_date = document.getElementById("modal_product_depart_from_station_date")
    const _modal_product_arrive_to_station_date = document.getElementById("modal_product_arrive_to_station_date")
    const _modal_product_depart_from_station_time = document.getElementById("modal_product_depart_from_station_time")
    const _modal_product_arrive_to_station_time = document.getElementById("modal_product_arrive_to_station_time")
    
    const _product_edit_page = document.getElementById("product_edit_page")
    const _product_panel_link_overview = document.getElementById("product_panel_link_overview")
    const _panel_tab_product_o = document.getElementById("panel_tab_product_o")
    const _product_panel_link_product = document.getElementById("product_panel_link_product")
    const _panel_tab_product = document.getElementById("panel_tab_product")
    const _product_panel_link_season = document.getElementById("product_panel_link_season")
    const _panel_tab_season = document.getElementById("panel_tab_season")
    const _product_panel_link_unit = document.getElementById("product_panel_link_unit")
    const _panel_tab_unit = document.getElementById("panel_tab_unit")
    const _product_panel_link_variant = document.getElementById("product_panel_link_variant")
    const _panel_tab_variant = document.getElementById("panel_tab_variant")
    const _product_panel_link_inventory = document.getElementById("product_panel_link_inventory")
    const _panel_tab_inventory = document.getElementById("panel_tab_inventory")
    const _product_panel_link_pricing = document.getElementById("product_panel_link_pricing")
    const _panel_tab_pricing = document.getElementById("panel_tab_pricing")
    const _panel_tab_location = document.getElementById("panel_tab_location")
    const _panel_tab_product_location = document.getElementById("panel_tab_product_location")
    const _panel_tab_product_meta = document.getElementById("panel_tab_product_meta")
    const _panel_tab_meta = document.getElementById("panel_tab_meta")
    const _product_panel_link_meta = document.getElementById("product_panel_link_meta")
    const _product_panel_link_location = document.getElementById("product_panel_link_location")
    const _product_edit_details_currency_id = document.getElementById("product_edit_details_currency_id")
    const _product_edit_details_rating_types_id = document.getElementById("product_edit_details_rating_types_id")
    const _product_keywords = document.getElementById("product_keywords")
    const _product_edit_meta_description_long = document.getElementById("product_edit_meta_description_long")
    const _product_edit_meta_description_short = document.getElementById("product_edit_meta_description_short")
    const _product_index_page = document.getElementById("product_index_page")
    const _product_index_table = document.getElementById("product_index_table")
    const _product_amenities = document.getElementById("product_amenities")
    const _product_id = document.getElementById("product_id")
    const _product_edit_details_name = document.getElementById("product_edit_details_name")
    const _product_edit_details_enabled = document.getElementById("product_edit_details_enabled")
    const _product_edit_details_sku = document.getElementById("product_edit_details_sku")
    const _pricing_strategy_types_id = document.getElementById("pricing_strategy_types_id")
    const _product_edit_location_city_id = document.getElementById("product_edit_location_city_id")
    const _product_edit_location_id = document.getElementById("product_edit_location_id")
    const _provider_id = document.getElementById("provider_id")
    const _vendor_id = document.getElementById("vendor_id")
    const _display_product_name = document.getElementById("display_product_name")
    const _button_save_product = document.getElementById("button_save_product")
    const _button_add_product_page_heading = document.getElementById("button_add_product_page_heading")
    const _category_id = document.getElementById("category_id")
    const _product_location_departing_station_city_id = document.getElementById("product_location_departing_station_city_id")
    const _product_location_arriving_station_city_id = document.getElementById("product_location_arriving_station_city_id")
    const _product_location_departing_station_id = document.getElementById("product_location_departing_station_id")
    const _product_location_arriving_station_id = document.getElementById("product_location_arriving_station_id")
    const _product_location = document.getElementById("product_location")
    const _product_edit_details_submit_button = document.getElementById("product_edit_details_submit_button")
    const _product_description_long = document.getElementById("product_description_long")
    const _product_edit_details_section_seasons = document.getElementById("product_edit_details_section_seasons")
    const _product_edit_details_section_units = document.getElementById("product_edit_details_section_units")
    const _product_edit_details_section_variants = document.getElementById("product_edit_details_section_variants")
    const _product_edit_details_section_status = document.getElementById("product_edit_details_section_status")
    const _product_description_short = document.getElementById("product_description_short")
    const _product_edit_details_section_profiles = document.getElementById("product_edit_details_section_profiles")
    const _user_id = document.getElementById("user_id")
    const _modal_product_id = document.getElementById("modal_product_id")
    const _modal_product_description_short = document.getElementById("modal_product_description_short")
    const _modal_product_description_long = document.getElementById("modal_product_description_long")
    const _modal_product_keywords = document.getElementById("modal_product_keywords")
    const _modal_product_meta_fields = document.getElementById("modal_product_meta_fields")
    const _modal_product_detail_fields = document.getElementById("modal_product_detail_fields")
    const _modal_product_depart_from_fields = document.getElementById("modal_product_depart_from_fields")
    const _modal_product_arrive_to_fields = document.getElementById("modal_product_arrive_to_fields")
    const _modal_product_hotel_fields = document.getElementById("modal_product_hotel_fields")
    const _modal_product_flight_fields = document.getElementById("modal_product_flight_fields")
    const _modal_product_cars_fields = document.getElementById("modal_product_cars_fields")
    const _modal_product_rail_fields = document.getElementById("modal_product_rail_fields")
    const _modal_product_transport_fields = document.getElementById("modal_product_transport_fields")
    const _modal_product_tours_fields = document.getElementById("modal_product_tours_fields")
    const _modal_product_cruises_fields = document.getElementById("modal_product_cruises_fields")
    
    let radios = document.querySelectorAll('input[type=radio][name="location_to_use"]')
    let userId, categoryId, productId, $product_keywords, $product_amenities, $index_table
    let user_id = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
    
    let addProductRules = {
        groups: {
            /*
            modal_product_provider_name: "modal_product_provider_name, modal_product_provider_company_id, modal_product_provider_id",
            modal_product_vendor_name: "modal_product_vendor_name, modal_product_vendor_id, modal_product_vendor_company_id",
            modal_product_depart_from_station: "modal_product_depart_from_station, modal_product_depart_from_station_id, modal_product_country_id, modal_product_province_id, modal_product_city_id",
            modal_product_arrive_to_station: "modal_product_arrive_to_station, modal_product_arrive_to_station_id",
            modal_product_city: "modal_product_city, modal_product_country_id, modal_product_province_id, modal_product_city_id",
            modal_product_country_cars: "modal_product_country_id",
            modal_product_city_tours: "modal_product_country_id, modal_product_province_id, modal_product_city_id",
            modal_product_city_transports: "modal_product_country_id, modal_product_province_id, modal_product_city_id",
            //*/
        },
        rules: {
            modal_product_sku: {
                required: true,
            },
            modal_day_span: {
                required: true,
                
            },
            modal_product_rating_types_id: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && (categoryId === 1 || categoryId === 3 || categoryId === 5 || categoryId === 6 || categoryId === 7)) {
                        return true
                    }
                },
            },
            modal_product_currency_id: {
                required: true,
            },
            modal_product_pricing_strategies_types_id: {
                required: true,
            },
            modal_product_name: {
                required: true,
            },
            modal_product_category_id: {
                required: true,
            },
            //LOCATION COUNTRY PROV CITY
            modal_product_country_id: {
                required: true,
            },
            modal_product_province_id: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && (categoryId === 1 || categoryId === 2)) {
                        return true
                    }
                },
            },
            modal_product_city_id: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && (categoryId === 1 || categoryId === 2)) {
                        return true
                    }
                },
            },
            //HOTEL
            modal_product_city: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && (categoryId === 1)) {
                        return true
                    }
                },
            },
            //CAR
            modal_product_country_cars: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && categoryId === 3) {
                        return true
                    }
                },
            },
            //TRANSPORT
            modal_product_city_transports: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && categoryId === 5) {
                        return true
                    }
                },
            },
            //TOURS
            modal_product_city_tours: {
                required: function (el) {
                    let categoryId = (_modal_product_category_id && (!isNaN(parseInt(_modal_product_category_id.value)))) ? parseInt(_modal_product_category_id.value) : null
                    
                    if (categoryId && categoryId === 6) {
                        return true
                    }
                },
            },
            //PROVIDER
            modal_product_provider_name: {
                required: true,
            },
            modal_product_provider_id: {
                required: true,
            },
            modal_product_provider_company_id: {
                required: true,
            },
            //VENDOR
            modal_product_vendor_name: {
                required: true,
            },
            modal_product_vendor_id: {
                required: true,
            },
            modal_product_vendor_company_id: {
                required: true,
            },
            //FLIGHTS
            modal_product_depart_from_airport: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 2) {
                            return true
                        }
                    }
                },
            },
            modal_product_depart_from_airport_id: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 2) {
                            return true
                        }
                    }
                },
            },
            modal_product_arrive_to_airport: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 2) {
                            return true
                        }
                    }
                },
            },
            modal_product_arrive_to_airport_id: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 2) {
                            return true
                        }
                    }
                },
            },
            //RAILS
            modal_product_depart_from_station: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 4) {
                            return true
                        }
                    }
                },
            },
            modal_product_depart_from_station_id: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 4) {
                            return true
                        }
                    }
                },
            },
            modal_product_arrive_to_station: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 4) {
                            return true
                        }
                    }
                },
            },
            modal_product_arrive_to_station_id: {
                required: function (el) {
                    if (_modal_product_category_id) {
                        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
                        
                        if (categoryId === 4) {
                            return true
                        }
                    }
                },
            },
        },
        messages: {
            modal_product_sku: {
                required: "Field Required",
            },
            modal_day_span: {
                required: "Field Required",
                
            },
            modal_product_rating_types_id: {
                required: "Field Required",
            },
            modal_product_currency_id: {
                required: "Field Required",
            },
            modal_product_pricing_strategies_types_id: {
                required: "Field Required",
            },
            modal_product_name: {
                required: "Field Required",
            },
            modal_product_category_id: {
                required: "Field Required",
            },
            
            modal_product_city: {
                required: "Field Required",
            },
            
            modal_product_country_id: {
                required: "Field Required",
            },
            modal_product_province_id: {
                required: "Field Required",
            },
            modal_product_city_id: {
                required: "Field Required",
            },
            
            modal_product_country_cars: {
                required: "Field Required",
            },
            modal_product_city_transports: {
                required: "Field Required",
            },
            modal_product_city_tours: {
                required: "Field Required",
            },
            
            modal_product_provider_name: {
                required: "Field Required",
            },
            modal_product_provider_id: {
                required: "Field Required",
            },
            modal_product_provider_company_id: {
                required: "Field Required",
            },
            
            modal_product_vendor_name: {
                required: "Field Required",
            },
            modal_product_vendor_id: {
                required: "Field Required",
            },
            modal_product_vendor_company_id: {
                required: "Field Required",
            },
            // Flights
            modal_product_depart_from_airport: {
                required: "Field Required",
            },
            modal_product_depart_from_airport_id: {
                required: "Field Required",
            },
            modal_product_arrive_to_airport: {
                required: "Field Required",
            },
            modal_product_arrive_to_airport_id: {
                required: "Field Required",
            },
            
            //Rails
            modal_product_depart_from_station: {
                required: "Field Required",
            },
            modal_product_depart_from_station_id: {
                required: "Field Required",
            },
            modal_product_arrive_to_station: {
                required: "Field Required",
            },
            modal_product_arrive_to_station_id: {
                required: "Field Required",
            },
            
        },
    }
    
    $("#modal_product_day_span_station")
        .on("change", function () {
            let daySpan = (!isNaN(parseInt($(this).val()))) ? parseInt($(this).val()) : 1
            
            if (daySpan <= 0) {
                daySpan = 1
            }
            
            $(this).val(daySpan)
            _modal_product_day_span.value = daySpan
        })
    
    $("#modal_product_day_span_airport")
        .on("change", function () {
            let daySpan = (!isNaN(parseInt($(this).val()))) ? parseInt($(this).val()) : 1
            
            if (daySpan <= 0) {
                daySpan = 1
            }
            
            $(this).val(daySpan)
            _modal_product_day_span.value = daySpan
        })
    
    $("#page")
        .on("change", function () {
            updateProgress()
        })
    
    $("#button_view_calendar")
        .on("click", function () {
            $("#seasonCalendarModal").modal("show")
        })
    
    $(_product_edit_meta_description_long_update_button)
        .on("click", function () {
            //console.log("Product.product_edit_meta_description_long_update_button.click()")
            updateMeta()
        })
    
    $(_product_edit_meta_description_short_update_button)
        .on("click", function () {
            //console.log("Product.product_edit_meta_description_short_update_button.click()")
            updateMeta()
        })
    
    $(_product_edit_meta_product_amenities_update_button)
        .on("click", function () {
            //console.log("Product.product_edit_meta_product_amenities_update_button.click()")
            updateMeta()
        })
    
    $(_product_edit_meta_product_keywords_update_button)
        .on("click", function () {
            //console.log("Product.product_edit_meta_product_keywords_update_button.click()")
            updateMeta()
        })
    
    $(_product_edit_details_section_publish)
        .on("click", function () {
            //console.log("Product.product_edit_details_section_publish.click()")
        })
    
    $(_product_edit_details_section_save_draft)
        .on("click", function () {
            //console.log("Product.product_edit_details_section_save_draft.click()")
        })
    
    $(_product_edit_details_name)
        .on("change", function () {
            _display_product_name.innerText = _product_edit_details_name.value
        })
    
    $(_product_edit_details_submit_button)
        .on("click", function () {
            updateProductDetails()
        })
    
    $(_product_edit_details_rating_types_id)
        .on("change", function () {
            Product.detail.rating_types_id = (!isNaN(parseInt(_product_edit_details_rating_types_id.value))) ? parseInt(_product_edit_details_rating_types_id.value) : 1
            updateDisplay()
        })
    
    $(_button_save_product)
        .on("click", function () {
            save()
        })
    
    $(_button_add_product_page_heading)
        .on("click", function () {
            setNewProductModal()
        })
    
    $(_modal_button_cancel_add_product)
        .on("click", function () {
            clearModalForm()
            Station.resetStationForm("depart_from")
            Station.resetStationForm("arrive_to")
            Station.resetStationForm("depart_from")
            Station.resetStationForm("arrive_to")
            clearValidation(_form_product_add)
            $(_modal_new_product).modal("hide")
        })
    
    $(_modal_button_submit_add_product)
        .on("click", function () {
            console.log("Product.modal_button_submit_add_product:click()")
            // ----
            
            if (validateNewProduct()) {
                confirmDialog(`Would you like to update?`, (ans) => {
                    if (ans) {
                        saveNewProduct()
                    }
                })
            }
        })
    
    $(_modal_product_provider_vendor_match)
        .on("change", function () {
            let provider_company_id = (isNaN(parseInt(_modal_product_provider_company_id.value))) ? null : parseInt(_modal_product_provider_company_id.value)
            
            if (provider_company_id !== null) {
                
                if (_modal_product_provider_vendor_match.checked) {
                    _modal_product_vendor_company_id.value = _modal_product_provider_company_id.value
                    
                    if (Provider.detail !== null) {
                        _modal_product_vendor_company_id.value = Provider.detail.vendor.company_id
                        _modal_product_vendor_id.value = Provider.detail.vendor.id
                        _modal_product_vendor_name.value = Provider.detail.vendor.name
                    } else {
                        _modal_product_vendor_company_id.value = ""
                        _modal_product_vendor_id.value = ""
                        _modal_product_vendor_name.value = ""
                    }
                    
                } else {
                    _modal_product_vendor_company_id.value = ""
                    _modal_product_vendor_id.value = ""
                    _modal_product_vendor_name.value = ""
                }
            }
        })
    
    $(_modal_button_clear_add_product)
        .on("click", function () {
            clearModalForm()
        })
    
    $(_product_edit_meta_description_short)
        .on("change", function () {
            Product.detail.description_short = $(this).val()
            updateDisplay()
        })
    
    $(_product_edit_meta_description_long)
        .on("change", function () {
            Product.detail.description_long = $(this).val()
            updateDisplay()
        })
    
    $(_form_product_add)
        .on("change", function () {
            Product.enableNewFormDetails()
        })
    
    const setNewProductModal = function () {
        //console.log("Product.setNewProductModal()")
        // ----
        
        clearModalForm()
        
        $(_modal_new_product).modal("show")
    }
    const clearModalForm = function () {
        //console.log("Product.clearModalForm()")
        // ----
        
        if (_modal_new_product) {
            
            clearModalFormValidation()
            
            _modal_product_arrive_to_station.value = ""
            _modal_product_arrive_to_station_id.value = ""
            
            _modal_product_city.value = ""
            _modal_product_city_id.value = ""
            
            _modal_product_day_span.value = 1
            _modal_product_depart_from_station.value = ""
            _modal_product_depart_from_station.value = ""
            
            _modal_product_id.value = ""
            
            _modal_product_name.value = ""
            _modal_product_postal_code.value = ""
            _modal_product_street_1.value = ""
            _modal_product_street_2.value = ""
            
            _modal_product_arrive_to_station.value = ""
            _modal_product_depart_from_station_id.value = ""
            _modal_product_arrive_to_station_id.value = ""
            _modal_product_depart_from_station_id.value = ""
            
            _modal_product_category_id.value = ""
            _modal_product_sku.value = ""
            
            _modal_product_country_id.value = ""
            _modal_product_province_id.value = ""
            _modal_product_country_id.value = ""
            _modal_product_rating_types_id.value = ""
            _modal_product_currency_id.value = ""
            _modal_product_provider_company_id.value = ""
            _modal_product_vendor_company_id.value = ""
            _modal_product_vendor_id.value = ""
            _modal_product_pricing_strategies_types_id.value = ""
            _modal_product_provider_location_id.value = ""
            _modal_product_location_id.value = ""
            
            _modal_product_description_short.value = ""
            _modal_product_description_long.value = ""
            
            if (Product.product_keywords) {
                Product.product_keywords.clear()
            }
            
            $(_modal_product_provider_name).val("").trigger("change")
            $(_modal_product_vendor_id).val("").trigger("change")
            
            Product.depart_from_date.value("")
            Product.arrive_to_date.value("")
            
            Product.attr1 = null
            Product.attr2 = null
            Product.attr3 = null
            
            Product.updateProductSKU()
            Product.disableNewFormDetails()
            $("[data-categoryid]").hide()
        }
        
    }
    const clearModalFormValidation = function () {
        //console.log("Product.clearNewProductValidation()")
        // ----
        
        if (Product.validator) {
            let val = $(_form_product_add).validate()
            val.resetForm()
        }
        
        clearAllValidation()
        
    }
    const validateNewProduct = function () {
        console.log("Product.validateNewProduct()")
        // ----
        
        if (!_form_product_add) {
            console.log("|__ Missing _form_product_add")
            return false
        }
        let isValid = false
        let categoryId = (_modal_product_category_id && !isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
        
        if ($(_form_product_add).valid()) {
            isValid = true
        } else {
            let validator = $(_form_product_add).validate()
            console.log("|__ validator", validator)
            console.log("|__ isValid", isValid)
        }
        
        return isValid
    }
    const saveNewProduct = function () {
        console.log("Product.saveNewProduct()")
        // ----
        
        let dataToSend = buildInsertData()
        let product
        
        //console.log("|__ dataToSend", dataToSend)
        newProduct(dataToSend, function (data) {
            //console.log("data", data)
            if (data) {
                product = data
                if (data.length === 1) {
                    product = data[0]
                }
                
                if (product.id) {
                    let detail = set(product)
                    //console.log("|__ detail", detail)
                    _modal_product_id.value = (!isNaN(parseInt(product.id))) ? parseInt(product.id) : ""
                    
                    $index_table.insertRow(detail)
                    $index_table.loadRow(detail)
                    $index_table.jumpToRow(detail)
                    $index_table.clearSelectedRows()
                    
                    toastr["success"](`Product - ${product.id} was created, would you like to edit?`, "Product Created")
                    //window.location.replace("/products/" + product.id)
                }
            }
        })
    }
    const newProduct = function (dataToSend, callback) {
        //console.log("Product.newProduct(dataToSend)", dataToSend)
        // ----
        
        let url = "/api/v1.0/products/add"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        return handleProductError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleProductError("Oops: 1")
            }
        }
    }
    const setNewFormDetails = function (categoryId) {
        //console.log("Product.setNewFormDetails(categoryId)", categoryId)
        // ----
        
    }
    const disableNewFormDetails = function () {
        //console.log("Product.disableNewFormDetails()")
        // ----
        
        /*
        if (Product.product_keywords) {
            Product.product_keywords.readOnly(true)
        }
        _modal_product_name.disabled = true
        _modal_product_provider_name.readOnly = true
        _modal_product_vendor_name.readOnly = true
        _modal_product_provider_vendor_match.disabled = true
        _modal_product_rating_types_id.disabled = true
        _modal_product_currency_id.disabled = true
        _modal_product_pricing_strategies_types_id.disabled = true
        _modal_product_description_long.disabled = true
        _modal_product_description_short.disabled = true
        _modal_button_submit_add_product.disabled = true
        //*/
        
        /*
        _modal_product_hotel_fields.disabled = true
        _modal_product_flight_fields.disabled = true
        _modal_product_depart_from_fields.disabled = true
        _modal_product_arrive_to_fields.disabled = true
        //_modal_product_cars_fields.disabled = true
        //_modal_product_rail_fields.disabled = true
        //_modal_product_transport_fields.disabled = true
        //_modal_product_tours_fields.disabled = true
        //_modal_product_cruises_fields.disabled = true
        //*/
        
        _modal_product_sku.disabled = true
        _modal_product_id.disabled = true
        
    }
    const enableNewFormDetails = function () {
        //console.log("Product.disableNewFormDetails()")
        // ----
        disableNewFormDetails()
        
        let categoryId = (_modal_product_category_id && !isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
        let productName = (_modal_product_name && _modal_product_name.value !== "") ? _modal_product_name.value : null
        let providerName = (_modal_product_provider_name && _modal_product_provider_name.value !== "") ? _modal_product_provider_name.value : null
        let vendorName = (_modal_product_vendor_name && _modal_product_vendor_name.value !== "") ? _modal_product_vendor_name.value : null
        
        if (categoryId) {
            _modal_product_name.disabled = false
            
            if (productName) {
                _modal_product_provider_name.readOnly = false
                _modal_product_vendor_name.readOnly = false
                _modal_product_provider_vendor_match.disabled = false
                
                if (providerName && vendorName) {
                    
                    _modal_product_rating_types_id.disabled = false
                    _modal_product_currency_id.disabled = false
                    _modal_product_pricing_strategies_types_id.disabled = false
                    _modal_product_description_long.disabled = false
                    _modal_product_description_short.disabled = false
                    _modal_button_submit_add_product.disabled = false
                    Product.product_keywords.readOnly(false)
                    
                    if (categoryId === 1) {
                        // Hotels
                        //_modal_product_pricing_strategies_types_id.value = ""
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_hotel_fields.disabled = false
                        _modal_product_pricing_strategies_types_id.disabled = false
                    }
                    
                    if (categoryId === 2) {
                        // Flights
                        _modal_product_pricing_strategies_types_id.value = 2
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_pricing_strategies_types_id.disabled = true
                        _modal_product_rating_types_id.disabled = true
                        
                        _modal_product_flight_fields.disabled = false
                        _modal_product_depart_from_fields.disabled = false
                        _modal_product_arrive_to_fields.disabled = false
                    }
                    
                    if (categoryId === 3) {
                        // Cars
                        _modal_product_pricing_strategies_types_id.value = 3
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_pricing_strategies_types_id.disabled = true
                        
                        _modal_product_cars_fields.disabled = false
                    }
                    
                    if (categoryId === 4) {
                        // Rail
                        _modal_product_pricing_strategies_types_id.value = 2
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_rail_fields.disabled = false
                        //_modal_product_pricing_strategies_types_id.disabled = true
                    }
                    
                    if (categoryId === 5) {
                        // Transport
                        _modal_product_pricing_strategies_types_id.value = 2
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_transport_fields.disabled = false
                        
                    }
                    
                    if (categoryId === 6) {
                        // Tours
                        _modal_product_pricing_strategies_types_id.value = 2
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_tours_fields.disabled = false
                        _modal_product_pricing_strategies_types_id.disabled = false
                        
                    }
                    
                    if (categoryId === 7) {
                        // Cruises
                        _modal_product_pricing_strategies_types_id.value = 2
                        //_modal_product_rating_types_id.value = ""
                        
                        _modal_product_cruises_fields.disabled = false
                        
                    }
                    
                }
            }
        }
        
    }
    const buildInsertData = function () {
        //console.log("Category.buildInsertData()")
        // ----
        let productId = (_modal_product_id && !isNaN(parseInt(_modal_product_id.value))) ? parseInt(_modal_product_id.value) : null
        let categoryId = (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
        let productName, productSKU, currencyId, pricingStrategyTypesId, ratingTypesId, providerId, vendorId, daySpan, productDescriptionShort, productDescriptionLong
        let depart_from, arrive_to, street1, street2, postalCode, provinceId, countryId, cityId, depart_date, depart_time, arrive_date, arrive_time
        let defaultDepartureTime, defaultArrivalTime = "12:00"
        let startDate = moment(new Date()).format("YYYY-MM-DD")
        let defaultDepartureDate = moment(startDate, "YYYY-MM-DD").add(3, "months").format("YYYY-MM-DD")
        let defaultArrivalDate = moment(defaultDepartureDate, "YYYY-MM-DD").add(1, "days").format("YYYY-MM-DD")
        let dataToSend
        let location = {
            name: null,
            street_1: null,
            street_2: null,
            zipcode: null,
            country_id: null,
            province_id: null,
            city_id: null,
        }
        let keywords = Product.product_keywords.build()
        
        productDescriptionShort = (_modal_product_description_short && _modal_product_description_short.value !== "") ? _modal_product_description_short.value : null
        productDescriptionLong = (_modal_product_description_long && _modal_product_description_long.value !== "") ? _modal_product_description_long.value : null
        daySpan = (_modal_product_day_span && !isNaN(parseInt(_modal_product_day_span.value))) ? parseInt(_modal_product_day_span.value) : 1
        countryId = (_modal_product_country_id && !isNaN(parseInt(_modal_product_country_id.value))) ? parseInt(_modal_product_country_id.value) : null
        provinceId = (_modal_product_province_id && !isNaN(parseInt(_modal_product_province_id.value))) ? parseInt(_modal_product_province_id.value) : null
        cityId = (_modal_product_city_id && !isNaN(parseInt(_modal_product_city_id.value))) ? parseInt(_modal_product_city_id.value) : null
        street1 = (_modal_product_street_1 && _modal_product_street_1.value !== "") ? _modal_product_street_1.value : null
        street2 = (_modal_product_street_2 && _modal_product_street_2.value !== "") ? _modal_product_street_2.value : null
        postalCode = (_modal_product_postal_code && _modal_product_postal_code.value !== "") ? _modal_product_postal_code.value : null
        productName = (_modal_product_name && _modal_product_name.value !== "") ? _modal_product_name.value : null
        productSKU = (_modal_product_sku && _modal_product_sku.value !== "") ? _modal_product_sku.value : null
        currencyId = (_modal_product_currency_id && !isNaN(parseInt(_modal_product_currency_id.value))) ? parseInt(_modal_product_currency_id.value) : null
        providerId = (_modal_product_provider_id && !isNaN(parseInt(_modal_product_provider_id.value))) ? parseInt(_modal_product_provider_id.value) : null
        vendorId = (_modal_product_vendor_id && !isNaN(parseInt(_modal_product_vendor_id.value))) ? parseInt(_modal_product_vendor_id.value) : null
        ratingTypesId = (_modal_product_rating_types_id && !isNaN(parseInt(_modal_product_rating_types_id.value))) ? parseInt(_modal_product_rating_types_id.value) : null
        pricingStrategyTypesId = (_modal_product_pricing_strategies_types_id && !isNaN(parseInt(_modal_product_pricing_strategies_types_id.value))) ? parseInt(_modal_product_pricing_strategies_types_id.value) : null
        defaultDepartureTime = "12:00"
        defaultArrivalTime = "12:00"
        
        if (categoryId === 1) {
            depart_from = null
            arrive_to = null
            depart_date = null
            depart_time = null
            arrive_date = null
            arrive_time = null
            
            location = {
                name: productName,
                location_types_id: 2,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
            
        } else if (categoryId === 2) {
            // Flights
            depart_from = (!isNaN(parseInt(_modal_product_depart_from_airport_id.value))) ? parseInt(_modal_product_depart_from_airport_id.value) : null
            arrive_to = (!isNaN(parseInt(_modal_product_arrive_to_airport_id.value))) ? parseInt(_modal_product_arrive_to_airport_id.value) : null
            depart_date = (Product.depart_from_date && Product.depart_from_date.value() !== "" && Product.depart_from_date.value() !== null) ? Product.depart_from_date.value() : defaultDepartureDate
            depart_time = (Product.depart_from_time && Product.depart_from_time.value() !== "" && Product.depart_from_time.value() !== null) ? Product.depart_from_time.value() : defaultDepartureTime
            arrive_date = (Product.arrive_to_date && Product.arrive_to_date.value() !== "" && Product.arrive_to_date.value() !== null) ? Product.arrive_to_date.value() : defaultArrivalDate
            arrive_time = (Product.arrive_to_time && Product.arrive_to_time.value() !== "" && Product.arrive_to_time.value() !== null) ? Product.arrive_to_time.value() : defaultArrivalTime
            
            location = {
                name: productName,
                location_types_id: 3,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
        } else if (categoryId === 3) {
            // Cars
            depart_from = null
            arrive_to = null
            depart_date = null
            depart_time = null
            arrive_date = null
            arrive_time = null
            
            location = {
                name: productName,
                location_types_id: 18,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
        } else if (categoryId === 4) {
            // Rail
            depart_from = (!isNaN(parseInt(_modal_product_depart_from_station_id.value))) ? parseInt(_modal_product_depart_from_station_id.value) : null
            arrive_to = (!isNaN(parseInt(_modal_product_arrive_to_station_id.value))) ? parseInt(_modal_product_arrive_to_station_id.value) : null
            depart_date = (Product.depart_from_date && Product.depart_from_date.value() !== "" && Product.depart_from_date.value() !== null) ? Product.depart_from_date.value() : defaultDepartureDate
            depart_time = (Product.depart_from_time && Product.depart_from_time.value() !== "" && Product.depart_from_time.value() !== null) ? Product.depart_from_time.value() : defaultDepartureTime
            arrive_date = (Product.arrive_to_date && Product.arrive_to_date.value() !== "" && Product.arrive_to_date.value() !== null) ? Product.arrive_to_date.value() : defaultArrivalDate
            arrive_time = (Product.arrive_to_time && Product.arrive_to_time.value() !== "" && Product.arrive_to_time.value() !== null) ? Product.arrive_to_time.value() : defaultArrivalTime
            
            location = {
                name: productName,
                location_types_id: 4,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
            
        } else if (categoryId === 5) {
            // Transport
            depart_from = null
            arrive_to = null
            depart_date = null
            depart_time = null
            arrive_date = null
            arrive_time = null
            
            location = {
                name: productName,
                location_types_id: 7,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
            
        } else if (categoryId === 6) {
            // Tours
            depart_from = null
            arrive_to = null
            depart_date = null
            depart_time = null
            arrive_date = null
            arrive_time = null
            
            location = {
                name: productName,
                location_types_id: 17,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
        } else if (categoryId === 7) {
            // Cruises
            depart_from = null
            arrive_to = null
            depart_date = null
            depart_time = null
            arrive_date = null
            arrive_time = null
            
            location = {
                name: productName,
                location_types_id: 19,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
        } else if (categoryId === 8) {
            // Packages
            depart_from = null
            arrive_to = null
            depart_date = null
            depart_time = null
            arrive_date = null
            arrive_time = null
            
            location = {
                name: productName,
                location_types_id: 19,
                street_1: street1,
                street_2: street2,
                zipcode: postalCode,
                country_id: countryId,
                province_id: provinceId,
                city_id: cityId,
            }
        } else {
            // Other
            depart_from = null
            arrive_to = null
        }
        
        dataToSend = {
            id: productId,
            category_id: categoryId,
            
            depart_from: depart_from,
            depart_date: depart_date,
            depart_time: depart_time,
            arrive_to: arrive_to,
            arrive_date: arrive_date,
            arrive_time: arrive_time,
            
            street_1: street1,
            street_2: street2,
            country_id: countryId,
            province_id: provinceId,
            city_id: cityId,
            postal_code: postalCode,
            
            pricing_strategy_types_id: pricingStrategyTypesId,
            status_types_id: 1,
            currency_id: currencyId,
            day_span: daySpan,
            description_short: productDescriptionShort,
            description_long: productDescriptionLong,
            keywords: keywords,
            
            rating_types_id: ratingTypesId,
            provider_id: providerId,
            vendor_id: vendorId,
            provider_vendor_match: (((!isNaN(parseInt(_modal_product_provider_company_id.value))) ? parseInt(_modal_product_provider_company_id.value) : null) === ((!isNaN(parseInt(_modal_product_vendor_company_id.value))) ? parseInt(_modal_product_vendor_company_id.value) : null)) ? 1 : 0,
            
            name: productName,
            sku: productSKU,
            use_provider_location_id: 0,
            location: location,
        }
        
        return remove_nulls(dataToSend)
    }
    const resetNewProductDetails = function () {
        //console.log("Product.resetNewProductDetails()")
        // ----
        
        clearModalFormValidation()
        
        Product.depart_from_date.value("")
        Product.arrive_to_date.value("")
        
        Station.resetStationForm("depart_from")
        Station.resetStationForm("arrive_to")
        
        Station.resetStationForm("depart_from")
        Station.resetStationForm("arrive_to")
        
        _modal_product_depart_from_time.value = ""
        _modal_product_arrive_to_time.value = ""
        _modal_product_depart_from_station.value = ""
        _modal_product_arrive_to_station.value = ""
        _modal_product_provider_id.value = ""
        _modal_product_vendor_id.value = ""
        _modal_product_provider_name.value = ""
        _modal_product_vendor_name.value = ""
        _modal_product_city.value = ""
        _modal_product_name.value = ""
        _modal_product_sku.value = ""
        _modal_product_city_id.value = ""
        _modal_product_rating_types_id.value = ""
        _modal_product_currency_id.value = ""
        _modal_product_pricing_strategies_types_id.value = ""
        
        _modal_product_name.disabled = true
        _modal_product_sku.disabled = true
        _modal_product_id.disabled = true
        _modal_product_rating_types_id.disabled = true
        _modal_product_currency_id.disabled = true
        
        //_modal_product_depart_from_fields.disabled = true
        //_modal_product_arrive_to_fields.disabled = true
        //_modal_product_hotel_fields.disabled = true
        
        clearAllValidation(_form_product_add)
    }
    
    //
    
    const buildMetaObject = function () {
        //console.log("Product.buildMetaObject()")
        // ----
        
        let id = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        let keywords = $product_keywords.build()
        let amenities = $product_amenities.build()
        let description_short = (_product_edit_meta_description_short.value !== "") ? _product_edit_meta_description_short.value : null
        let description_long = (_product_edit_meta_description_long.value !== "") ? _product_edit_meta_description_long.value : null
        
        return removeNulls({
            amenities: amenities,
            keywords: keywords,
            id: id,
            description_long: description_long,
            description_short: description_short,
        })
    }
    const updateMeta = function () {
        //console.log("Product.updateMeta()")
        let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        //console.log("|__ productId", productId)
        let categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        //console.log("|__ categoryId", categoryId)
        let userId = (!isNaN(parseInt(_user_id.value))) ? parseInt(_user_id.value) : null
        //console.log("|__ userId", userId)
        let dataToSend = buildMetaObject()
        //console.log("|__ dataToSend", dataToSend)
        
        confirmDialog(`Would you like to update?`, (ans) => {
            if (ans) {
                sendRequestUpdateProductMeta(dataToSend, function (data) {
                    let product
                    if (data) {
                        product = data
                        if (data[0]) {
                            product = data[0]
                        }
                        
                        let detail = set(product)
                        
                        if (_product_edit_page) {
                            updateProgress()
                        }
                        
                        handleProductError(`Product ${product.name} was updated.`, "Product", "success")
                    }
                })
            }
        })
    }
    const sendRequestUpdateProductMeta = function (dataToSend, callback) {
        //console.log("Product.sendRequestUpdateProductMeta(dataToSend, callback)", dataToSend)
        if (dataToSend) {
            let url = "/api/v1.0/products/update_meta"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleProductError("Error")
            }
        }
    }
    
    //
    
    const buildProductDetailRecord = function () {
        //console.log("Product.buildProductDetailRecord()")
        let sku = updateProductSKU()
        let enabled = (_product_edit_details_enabled && _product_edit_details_enabled.checked === true) ? 1 : 0
        let rating_types_id = (!isNaN(parseInt(_product_edit_details_rating_types_id.value))) ? parseInt(_product_edit_details_rating_types_id.value) : null
        let currency_id = (!isNaN(parseInt(_product_edit_details_currency_id.value))) ? parseInt(_product_edit_details_currency_id.value) : null
        let name = (_product_edit_details_name && _product_edit_details_name.value !== "") ? _product_edit_details_name.value : null
        let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        let categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        let userId = (!isNaN(parseInt(_user_id.value))) ? parseInt(_user_id.value) : null
        
        return removeNulls({
            id: (productId) ? productId : null,
            rating_types_id: (rating_types_id) ? rating_types_id : null,
            currency_id: (currency_id) ? currency_id : null,
            name: (name) ? name : null,
            sku: (sku) ? sku : null,
            enabled: enabled,
        })
    }
    
    const sendRequestUpdateProductDetail = function (dataToSend, callback) {
        //console.log("Product.sendRequestUpdateProductDetail(dataToSend)", dataToSend)
        if (dataToSend) {
            let url = "/api/v1.0/products/update_detail"
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    //console.log("|__ |__ data", data)
                    if (data) {
                        return callback(data)
                    }
                })
            } catch (e) {
                //console.log("error", e)
                return handleProductError("Error")
            }
        }
    }
    
    const validateProductRecord = function () {
        //let isValid = true
        
        return true
    }
    
    const sendUpdateRequest = function (dataToSend, callback) {
        let url = "/api/v1.0/products/update"
        
        if (dataToSend) {
            try {
                sendPostRequest(url, dataToSend, function (data, status, xhr) {
                    if (data) {
                        return callback(data)
                    } else {
                        handleProductError("Oops: 1")
                    }
                })
            } catch (e) {
                //console.log("error", e)
                handleProductError("Oops: 1")
            }
        }
    }
    
    const buildProductRecord = function () {
        if (validateProductRecord()) {
            let categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
            let arrive_to, depart_from
            
            if (categoryId === 2) {
                arrive_to = (!isNaN(parseInt(_product_location_arriving_station_id.value))) ? parseInt(_product_location_arriving_station_id.value) : null
                depart_from = (!isNaN(parseInt(_product_location_departing_station_id.value))) ? parseInt(_product_location_departing_station_id.value) : null
            } else if (categoryId === 4) {
                arrive_to = (!isNaN(parseInt(_product_location_arriving_station_city_id.value))) ? parseInt(_product_location_arriving_station_city_id.value) : null
                depart_from = (!isNaN(parseInt(_product_location_departing_station_city_id.value))) ? parseInt(_product_location_departing_station_city_id.value) : null
            } else {
                arrive_to = null
                depart_from = null
            }
            
            let detail = {
                id: (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null,
                category_id: (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null,
                description_short: (_product_edit_meta_description_short && _product_edit_meta_description_short.value !== "") ? _product_edit_meta_description_short.value : null,
                description_long: (_product_edit_meta_description_long && _product_edit_meta_description_long.value !== "") ? _product_edit_meta_description_long.value : null,
                amenities: $product_amenities.build(),
                keywords: $product_keywords.build(),
                rating_types_id: (!isNaN(parseInt(_product_edit_details_rating_types_id.value))) ? parseInt(_product_edit_details_rating_types_id.value) : null,
                currency_id: (!isNaN(parseInt(_product_edit_details_currency_id.value))) ? parseInt(_product_edit_details_currency_id.value) : null,
                name: (_product_edit_details_name.value !== "") ? _product_edit_details_name.value : null,
                pricing_strategy_types_id: (!isNaN(parseInt(_pricing_strategy_types_id.value))) ? parseInt(_pricing_strategy_types_id.value) : null,
                city_id: (!isNaN(parseInt(_product_edit_location_city_id.value))) ? parseInt(_product_edit_location_city_id.value) : null,
                location_id: (_product_edit_location_id && !isNaN(parseInt(_product_edit_location_id.value))) ? parseInt(_product_edit_location_id.value) : null,
                provider_id: (!isNaN(parseInt(_provider_id.value))) ? parseInt(_provider_id.value) : null,
                vendor_id: (!isNaN(parseInt(_vendor_id.value))) ? parseInt(_vendor_id.value) : null,
                use_provider_location_id: 0,
                provider_vendor_match: 1,
                status_types_id: 2,
                enabled: (_product_edit_details_enabled.checked) ? 1 : 0,
                sku: (_product_edit_details_sku.value !== "") ? _product_edit_details_sku.value : null,
                arrive_to: arrive_to,
                depart_from: depart_from,
                
            }
            
            return removeNulls(detail)
        }
    }
    
    const save = function () {
        
        let dataToSend = buildProductRecord()
        
        if (dataToSend) {
            confirmDialog(`Would you like to update?`, (ans) => {
                if (ans) {
                    sendUpdateRequest(dataToSend, function (data) {
                        let product
                        if (data) {
                            product = data
                            if (data[0]) {
                                product = data[0]
                            }
                        }
                        
                        if (product.id) {
                            let detail = set(product)
                            let name = (detail.name) ? detail.name : null
                            toastr["success"](`Product ${name} has been updated`, "Product Updated")
                        }
                    })
                }
            })
        }
        
    }
    
    const navigate = function (product) {
        if (product && product.id) {
            window.location.replace(base_url + "/" + product.id)
        }
    }
    
    const get = function (id) {
        let data_to_send = {}
        if (id) {
            data_to_send.id = id
        }
    }
    
    const defaultDetail = function () {
        return {
            id: null,
            category_id: null,
            pricing_strategy_types_id: null,
            status_types_id: null,
            product_status_types_id: null,
            currency_id: null,
            location_id: null,
            city_id: null,
            vendor_id: null,
            provider_id: null,
            name: null,
            provider_vendor_match: 1,
            description_short: null,
            description_long: null,
            rating: null,
            sku: null,
            phone: null,
            infant: null,
            child: null,
            teen: null,
            depart_from: null,
            arrive_to: null,
            depart_time: null,
            arrive_time: null,
            day_span: null,
            cover_image: null,
            api_id: null,
            from_api: 1,
            hotel_code: null,
            enabled: 1,
            date_created: formatDateMySQL(),
            created_by: user_id,
            date_modified: formatDateMySQL(),
            modified_by: user_id,
            note: null,
            amenities: "",
            keywords: "",
            seasons: [],
            units: [],
            use_provider_location: 0,
            variants: [],
            category: {},
            location: {},
            vendor: {},
            profiles: [],
            provider: {},
        }
    }
    
    const set = function (product) {
        //console.log("Product.set(product)", product)
        let detail = defaultDetail()
        
        if (product) {
            detail.id = (product.id) ? product.id : null
            detail.category_id = (product.category_id) ? product.category_id : null
            detail.pricing_strategy_types_id = (product.pricing_strategy_types_id) ? product.pricing_strategy_types_id : null
            detail.status_types_id = (product.status_types_id) ? product.status_types_id : null
            detail.product_status_types_id = (product.product_status_types_id) ? product.product_status_types_id : null
            detail.currency_id = (product.currency_id) ? product.currency_id : null
            detail.location_id = (product.location_id) ? product.location_id : null
            detail.city_id = (product.city_id) ? product.city_id : null
            detail.vendor_id = (product.vendor_id) ? product.vendor_id : null
            detail.provider_id = (product.provider_id) ? product.provider_id : null
            detail.name = (product.name) ? product.name : null
            detail.provider_vendor_match = (product.provider_vendor_match) ? product.provider_vendor_match : 1
            detail.description_short = (product.description_short) ? product.description_short : null
            detail.description_long = (product.description_long) ? product.description_long : null
            detail.rating = (product.rating) ? product.rating : null
            detail.sku = (product.sku) ? product.sku : null
            detail.phone = (product.phone) ? product.phone : null
            detail.infant = (product.infant) ? product.infant : null
            detail.child = (product.child) ? product.child : null
            detail.teen = (product.teen) ? product.teen : null
            detail.depart_from = (product.depart_from) ? product.depart_from : null
            detail.arrive_to = (product.arrive_to) ? product.arrive_to : null
            detail.depart_time = (product.depart_time) ? product.depart_time : null
            detail.arrive_time = (product.arrive_time) ? product.arrive_time : null
            detail.day_span = (product.day_span) ? product.day_span : null
            detail.cover_image = (product.cover_image) ? product.cover_image : null
            detail.api_id = (product.api_id) ? product.api_id : null
            detail.from_api = (product.from_api) ? product.from_api : 1
            detail.hotel_code = (product.hotel_code) ? product.hotel_code : null
            detail.enabled = (product.enabled) ? product.enabled : 1
            detail.date_created = (product.date_created) ? product.date_created : formatDateMySQL()
            detail.created_by = (product.created_by) ? product.created_by : user_id
            detail.date_modified = (product.date_modified) ? product.date_modified : formatDateMySQL()
            detail.modified_by = (product.modified_by) ? product.modified_by : user_id
            detail.note = (product.note) ? product.note : null
            detail.category = (product.category) ? product.category : {}
            detail.keywords = (product.keywords) ? product.keywords : ""
            detail.amenities = (product.amenities) ? product.amenities : ""
            detail.seasons = (product.seasons) ? product.seasons : []
            detail.units = (product.units) ? product.units : []
            detail.use_provider_location = (product.use_provider_location) ? product.use_provider_location : 0
            detail.variants = (product.variants) ? product.variants : []
            detail.location = (product.location) ? product.location : {}
            detail.vendor = (product.vendor) ? product.vendor : {}
            detail.provider = (product.provider) ? product.provider : {}
        }
        
        Product.detail = detail
        return detail
    }
    
    const loadAll = function (products) {
        Product.all = new Map()
        
        if (!products) {
            return
        }
        
        $.each(products, function (i, product) {
            let detail = set(product)
            $index_table.insertRow(detail)
            Product.all.set("id", detail)
        })
        
    }
    
    const buildIndexTable = function () {
        
        $index_table = $(_product_index_table).table({
            table_type: "display_list",
            data: [],
            columnDefs: [
                {
                    title: "Name",
                    targets: 0,
                    data: "name",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "SKU",
                    targets: 1,
                    data: "sku",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data + "</span>"
                    },
                },
                {
                    title: "Provider",
                    targets: 2,
                    data: "provider",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data.name + "</span>"
                    },
                },
                {
                    title: "Vendor",
                    targets: 3,
                    data: "vendor",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data.name + "</span>"
                    },
                },
                {
                    title: "Location",
                    targets: 4,
                    data: "location",
                    render: function (data, type, row, meta) {
                        let displayLocation = ""
                        if (defaultLocationDisplayFormat === "short") {
                            displayLocation = data.display_short
                        } else if (defaultLocationDisplayFormat === "long") {
                            displayLocation = data.display_long
                        } else {
                            displayLocation = data.display_medium
                        }
                        
                        return "<span style='white-space: nowrap;'>" + displayLocation + "</span>"
                    },
                },
                {
                    title: "Category",
                    targets: 5,
                    data: "category",
                    render: function (data, type, row, meta) {
                        return "<span style='white-space: nowrap;'>" + data.name + "</span>"
                    },
                },
            ],
            rowClick: Product.navigate,
        })
    }
    
    const setDefaultProductDetails = function () {
        return {
            location: {},
            provider: {},
            vendor: {},
            seasons: [],
            units: [],
            variants: [],
            profiles: [],
            matrix: [],
        }
    }
    
    const handleProductError = function (msg, title, level) {
        //console.log("Product.handleProductError(msg)", msg)
        if (!title) {
            title = "Product"
        }
        
        if (!level) {
            level = "error"
        }
        
        toastr[level](`${msg}`, title)
    }
    
    const updateProgress = function () {
        //console.log("Product.updateProgress()")
        if (_product_edit_page) {
            let variants = Array.from(Variant.all.values())
            let profiles = Array.from(InventoryProfile.all.values())
            let units = Array.from(Unit.all.values())
            let seasons = Array.from(Season.all.values())
            let calendarButtons = document.querySelectorAll("button[data-target='#seasonCalendarModal']")
            
            if (variants.length === 0 || units.length === 0 || seasons.length === 0 || profiles.length === 0) {
                $(_product_edit_details_section_publish).addClass("disabled")
                if (variants.length === 0 || units.length === 0 || seasons.length === 0) {
                    calendarButtons.forEach(el => {
                        el.disabled = true
                    })
                    $("#button_view_calendar").addClass("disabled")
                    $(_panel_tab_pricing).addClass(`disabled`)
                    $(_panel_tab_inventory).addClass(`disabled`)
                } else {
                    $(_panel_tab_inventory).removeClass(`disabled`)
                }
                
                if (profiles.length === 0) {
                    $("#button_view_calendar").addClass("disabled")
                    $(_panel_tab_pricing).addClass(`disabled`)
                } else {
                
                }
                
                $(_button_save_product).addClass("disabled")
                
                $("#panel_tab_pricing")
                    .html(`
							<span id="tab_span_pricing">Pricing</span>
							<span class="badge rounded-pill badge-notification bg-danger tab-badge" style="color:#fff!important">!</span>
						`)
            
            } else {
                $("#button_view_calendar").removeClass("disabled")
                $(_panel_tab_pricing).removeClass(`disabled`)
                $(_panel_tab_inventory).removeClass(`disabled`)
                
                let pricingWorksheet = PricingWorksheet.status()
                if (pricingWorksheet === "incomplete") {
                    $(_product_edit_details_section_publish).addClass("disabled")
                    $(_button_save_product).addClass("disabled")
                    $("#panel_tab_pricing")
                        .html("<span id='tab_span_pricing'>Pricing</span> <span class='badge rounded-pill badge-notification bg-danger tab-badge' style='color:#fff!important'>!</span>")
                } else {
                    $(_product_edit_details_section_publish).removeClass("disabled")
                    $(_button_save_product).removeClass("disabled")
                    $("#panel_tab_pricing")
                        .html("<span id='tab_span_pricing'>Pricing</span>")
                }
            }
            
            updateDisplay()
        }
    }
    
    const updateDisplay = function () {
        //console.log("Product.updateDisplay()", Product.detail)
        if (_product_edit_page) {
            //LOCATION DISPLAY UPDATE
            let provider, vendor, seasons, units, variants, profiles, product_location,
                productLocationType
            let productLocationDisplay = "Product Location"
            let productLocationIcon = "fas fa-archway"
            
            if (Product.detail.location) {
                product_location = Product.detail.location
            }
            
            if (product_location) {
                productLocationType = (product_location.type) ? product_location.type : null
                productLocationDisplay = (product_location.display_medium) ? product_location.display_medium : "Product Location"
            }
            
            if (productLocationType) {
                productLocationIcon = (productLocationType.icon) ? productLocationType.icon : "fas fa-archway"
            }
            
            if (_product_location) {
                $(_product_location)
                    .empty()
                    .html(`
						<i class="${productLocationIcon} mr-2"></i> <span class="">${productLocationDisplay}</span>
					`)
            }
            
            //RATING DISPLAY UPDATE
            let rating = (!isNaN(parseInt(_product_edit_details_rating_types_id.value))) ? parseInt(_product_edit_details_rating_types_id.value) : 1
            let ratingDisplay = ""
            for (let n = 0; n < 5; n++) {
                if (n < rating) {
                    ratingDisplay += `
						<li class="list-inline-item mr-0">
                            <i class="fas fa-star"></i>
                        </li>
					`
                } else {
                    ratingDisplay += `
						<li class="list-inline-item mr-0">
                            <i class="far fa-star"></i>
                        </li>
					`
                }
            }
            
            $("ul.rating")
                .empty()
                .html(ratingDisplay)
            
            //STATUS DISPLAY UPDATE
            let statusDisplay = ""
            if (_product_edit_details_section_status) {
                let status_types_id = (!isNaN(parseInt(Product.detail.status_types_id))) ? parseInt(Product.detail.status_types_id) : null
                if (status_types_id) {
                    let status = StatusTypes.all.get(status_types_id)
                    if (status) {
                        let statusName = (status.name) ? status.name : ""
                        let statusClass = statusName.replace(/\s+/g, '-').toLowerCase()
                        
                        statusDisplay = `
							<span class="">Status</span>
							<span id="product_edit_details_section_status_text" class="badge badge-${statusClass} badge-pill badge-status">${statusName}</span>
						`
                    }
                }
            }
            
            if (_product_edit_details_section_status) {
                $(_product_edit_details_section_status)
                    .empty()
                    .html(statusDisplay)
            }
            
            //SEASON, VARIANT, UNIT COUNTS
            let seasonCount = Array.from(Season.all.values()).length
            let seasonClass = "badge badge-success badge-pill"
            if (seasonCount === 0) {
                seasonClass = "badge badge-danger badge-pill"
            }
            
            let unitCount = Array.from(Unit.all.values()).length
            let unitClass = "badge badge-success badge-pill"
            if (unitCount === 0) {
                unitClass = "badge badge-danger badge-pill"
            }
            
            let variantCount = Array.from(Variant.all.values()).length
            let variantClass = "badge badge-success badge-pill"
            if (variantCount === 0) {
                variantClass = "badge badge-danger badge-pill"
            }
            
            let inventoryProfileCount = Array.from(InventoryProfile.all.values()).length
            let inventoryProfileClass = "badge badge-success badge-pill"
            if (inventoryProfileCount === 0) {
                inventoryProfileClass = "badge badge-danger badge-pill"
            }
            
            _product_edit_details_section_seasons.classList = seasonClass
            _product_edit_details_section_seasons.innerText = seasonCount
            
            _product_edit_details_section_units.classList = unitClass
            _product_edit_details_section_units.innerText = unitCount
            
            _product_edit_details_section_variants.classList = variantClass
            _product_edit_details_section_variants.innerText = variantCount
            
            _product_edit_details_section_profiles.classList = inventoryProfileClass
            _product_edit_details_section_profiles.innerText = inventoryProfileCount
            
            $(_product_description_short).empty().html(Product.detail.description_short)
            $(_product_description_long).empty().html(Product.detail.description_long)
            
            updateProductSKU()
        }
    }
    
    const updateProductSKU = function () {
        //console.log("Product.updateProductSKU()")
        // ----
        
        let att1 = Product.attr1
        let att2 = Product.attr2
        let att3 = Product.attr3
        let sku = ""
        
        if (!is_null(att1) && !is_null(att2) && !is_null(att3)) {
            sku = att1.replace(/-/g, "") + "-" + att2.replace(/-/g, "") + "-" + att3.replace(/-/g, "")
            
            if (_modal_product_sku) {
                _modal_product_sku.value = sku
            }
            
            if (_product_edit_details_sku) {
                _product_edit_details_sku.value = sku
            }
            
        } else {
            if (_modal_product_sku) {
                _modal_product_sku.value = ""
            }
            
            if (is_null(att1)) {
                //console.log("att1 is null", att1)
                return
            }
            
            if (is_null(att2)) {
                //console.log("att2 is null", att2)
                return
            }
            
            if (is_null(att3)) {
                //console.log("att3 is null", att3)
                return
            }
        }
        
        return sku
    }
    
    const updateProductDetails = function () {
        //console.log("Product.updateProductDetails()")
        let productId = (!isNaN(parseInt(_product_id.value))) ? parseInt(_product_id.value) : null
        let categoryId = (!isNaN(parseInt(_category_id.value))) ? parseInt(_category_id.value) : null
        let userId = (!isNaN(parseInt(_user_id.value))) ? parseInt(_user_id.value) : null
        let dataToSend = buildProductDetailRecord()
        //console.log("dataToSend", dataToSend)
        
        confirmDialog(`Would you like to update?`, (ans) => {
            if (ans) {
                sendRequestUpdateProductDetail(dataToSend, function (data) {
                    let product
                    if (data) {
                        product = data
                        if (data[0]) {
                            product = data[0]
                        }
                        //console.log("|__ |__ product", product)
                        let detail = set(product)
                        if (_product_edit_page) {
                            updateProgress()
                        }
                        handleProductError(`Product ${product.name} was updated.`, "Product", "success")
                    }
                })
            }
        })
    }
    
    const setEditFormValues = function (product) {
        //console.log("Product.setEditFormValues(product)", product)
        // ----
        
        let detail = set(product)
        let category
        let id = (!isNaN(parseInt(product.id))) ? parseInt(product.id) : null
        let sku = (product.sku) ? product.sku : ""
        let name = (product.name) ? product.name : ""
        let day_span = (product.day_span) ? product.day_span : 1
        let ratings_type_id = (product.rating_types_id) ? product.rating_types_id : ""
        let enabled = (product.enabled && product.enabled === 1)
        let currency_types_id = (product.currency_id) ? product.currency_id : ""
        let description_long = (product.description_long) ? product.description_long : ""
        let description_short = (product.description_short) ? product.description_short : ""
        let product_keywords = (product.keywords) ? product.keywords : []
        let product_amenities = (product.amenities) ? product.amenities : []
        let images = (product.images) ? product.images : []
        
        if (detail.category) {
            category = detail.category
        }
        
        Product.fileManager = $("#product_images").fileManager({
            height: 400,
            source: "product",
            sourceId: id,
            images: images,
        })
        
        $product_keywords = $(_product_keywords).BuildKeyword(product_keywords)
        $product_amenities = $(_product_amenities).BuildKeyword(product_amenities)
        
        _product_edit_details_name.value = name
        _product_edit_details_sku.value = sku
        _product_edit_details_enabled.checked = enabled
        _product_edit_meta_description_short.value = description_short
        _product_edit_meta_description_long.value = description_long
        _product_edit_details_currency_id.value = currency_types_id
        _product_edit_details_rating_types_id.value = ratings_type_id
        
        Product.attr1 = (category.attribute_id) ? category.attribute_id : null
    }
    
    const initEditForm = function (settings) {
        let product = setDefaultProductDetails()
        
        if (settings) {
            product = settings
        }
        
        Array.prototype.forEach.call(radios, function (radio) {
            //radio.addEventListener("change", changeHandler)
        })
        
        setEditFormValues(product)
    }
    
    const index = function (settings) {
        //console.log("Product.index(settings)", settings)
        // ----
        
        let categories, products, stations, airports
        
        if (_product_index_table) {
            buildIndexTable()
        }
        
        if (settings) {
            products = (settings.products) ? settings.products : []
            stations = (settings.stations) ? settings.stations : []
            airports = (settings.airports) ? settings.airports : []
            categories = (settings.category) ? settings.category : []
            /*
            console.log("|__ settings", settings)
            console.log("|__ products", products)
            console.log("|__ stations", stations)
            console.log("|__ airports", airports)
            console.log("|__ products", categories)
            //*/
        }
        
        loadAll(products)
        
        if (_modal_new_product) {
            validator_init(addProductRules)
            Product.validator = $(_form_product_add).validate()
            
            Product.attr1 = null
            Product.attr2 = null
            Product.attr3 = null
            
            $(document).ready(function () {
                Category.initProductModal(categories)
                Provider.init()
                Airport.init({ airports: airports })
                Station.init({ stations: stations })
                
                if (_modal_product_keywords) {
                    Product.product_keywords = $(_modal_product_keywords).BuildKeyword([])
                }
                
                if (_modal_product_depart_from_date) {
                    Product.depart_from_date = $(_modal_product_depart_from_date).dateSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_depart_from_time) {
                    Product.depart_from_time = $(_modal_product_depart_from_time).timeSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_arrive_to_date) {
                    Product.arrive_to_date = $(_modal_product_arrive_to_date).dateSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_arrive_to_time) {
                    Product.arrive_to_time = $(_modal_product_arrive_to_time).timeSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_arrive_to_station_date) {
                    Product.depart_from_station_date = $(_modal_product_arrive_to_station_date).dateSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_depart_from_station_date) {
                    Product.depart_from_station_date = $(_modal_product_depart_from_station_date).dateSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_arrive_to_station_time) {
                    Product.arrive_to_station_time = $(_modal_product_arrive_to_station_time).timeSelect({
                        onStart: function () {},
                    })
                }
                
                if (_modal_product_depart_from_station_time) {
                    Product.depart_from_station_time = $(_modal_product_depart_from_station_time).timeSelect({
                        onStart: function () {},
                    })
                }
                
                disableNewFormDetails()
            })
        }
        
    }
    
    const init = function (settings) {
        //console.log("Product.init(settings)", settings)
        // ----
        
        let product_details, variants, seasons, units, profiles, provider, vendor,
            matrices, pricings, product_location, arriving_location, departing_location,
            images
        
        if (_product_edit_page) {
            $(document).ready(function () {
                userId = (document.getElementById("user_id")) ? (!isNaN(parseInt(document.getElementById("user_id").value))) ? parseInt(document.getElementById("user_id").value) : 4 : 4
                categoryId = (document.getElementById("category_id")) ? (!isNaN(parseInt(document.getElementById("category_id").value))) ? parseInt(document.getElementById("category_id").value) : null : null
                productId = (document.getElementById("product_id")) ? (!isNaN(parseInt(document.getElementById("product_id").value))) ? parseInt(document.getElementById("product_id").value) : null : null
                
                if (settings) {
                    if (settings.product_details) {
                        product_details = settings.product_details
                        
                        if (product_details.images) {
                            images = product_details.images
                        }
                        
                        if (product_details.provider) {
                            provider = product_details.provider
                        }
                        
                        if (product_details.vendor) {
                            vendor = product_details.vendor
                        }
                        
                        if (product_details.variants) {
                            variants = product_details.variants
                        }
                        
                        if (product_details.seasons) {
                            seasons = product_details.seasons
                        }
                        
                        if (product_details.matrices) {
                            matrices = product_details.matrices
                        }
                        
                        if (product_details.profiles) {
                            profiles = product_details.profiles
                        }
                        
                        if (product_details.units) {
                            units = product_details.units
                        }
                        
                        if (product_details.pricings) {
                            pricings = product_details.pricings
                        }
                        
                        if (product_details.location) {
                            product_location = product_details.location
                        }
                        
                        if (product_details.arriving_location) {
                            arriving_location = product_details.arriving_location
                        }
                        
                        if (product_details.departing_location) {
                            departing_location = product_details.departing_location
                        }
                        
                        let pricing_strategy = {
                            pricing_strategy_types_id: (!isNaN(parseInt(product_details.pricing_strategy_types_id))) ? parseInt(product_details.pricing_strategy_types_id) : null,
                        }
                        
                        Provider.init({
                            provider_detail: provider,
                        })
                        
                        Vendor.init({
                            vendor_detail: vendor,
                        })
                        
                        Variant.init(variants)
                        
                        Season.init(seasons)
                        
                        Season.loadAll(seasons)
                        
                        Unit.init({ units: units })
                        
                        Matrix.init({ matrices: matrices })
                        
                        Pricing.init({ pricings: pricings })
                        
                        InventoryProfile.init({
                            profiles: profiles,
                        })
                        
                        PricingWorksheet.init({
                            pricing_strategy: pricing_strategy,
                            pricings: pricings,
                        })
                        
                        Product.calendar = $("#calendar").YearCalendar({
                            displayEventTime: false,
                            calendarType: "season",
                            events: [],
                        })
                        
                        switch (categoryId) {
                            case 1:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                break
                            case 2:
                                ProductLocation.init({
                                    product_location: product_location,
                                    departing_location: departing_location,
                                    arriving_location: arriving_location,
                                    product: product_details,
                                })
                                break
                            case 3:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                break
                            case 4:
                                ProductLocation.init({
                                    product_location: product_location,
                                    departing_location: departing_location,
                                    arriving_location: arriving_location,
                                    product: product_details,
                                })
                                break
                            case 5:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                break
                            case 6:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                
                                Tour.init({
                                    route: [],
                                    
                                })
                                
                                break
                            case 7:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                break
                            case 8:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                break
                            case 9:
                                ProductLocation.init({
                                    product_location: product_location,
                                    product: product_details,
                                })
                                break
                        }
                        
                        $(_product_panel_link_overview)
                            .on("click", function () {
                                $(_panel_tab_product_o).tab("show")
                            })
                        $(_product_panel_link_location)
                            .on("click", function () {
                                $(_panel_tab_location).tab("show")
                            })
                        $(_product_panel_link_product)
                            .on("click", function () {
                                $(_panel_tab_product).tab("show")
                            })
                        $(_product_panel_link_season)
                            .on("click", function () {
                                $(_panel_tab_season).tab("show")
                            })
                        $(_product_panel_link_unit)
                            .on("click", function () {
                                $(_panel_tab_unit).tab("show")
                            })
                        $(_product_panel_link_variant)
                            .on("click", function () {
                                $(_panel_tab_variant).tab("show")
                            })
                        $(_product_panel_link_inventory)
                            .on("click", function () {
                                $(_panel_tab_inventory).tab("show")
                            })
                        $(_product_panel_link_pricing)
                            .on("click", function () {
                                $(_panel_tab_pricing).tab("show")
                            })
                        $(_product_panel_link_meta)
                            .on("click", function () {
                                $(_panel_tab_meta).tab("show")
                            })
                        
                        initAutoComplete()
                        initEditForm(product_details)
                        updateProgress()
                    }
                }
            })
        }
        
        if (_product_index_page) {
            Product.index(settings)
        }
    }
    
    const initAutoComplete = function (categoryId) {
        //console.log("Product.initAutoComplete()")
        // ----
        
        let category_id = (categoryId && (!isNaN(parseInt(categoryId)))) ? parseInt(categoryId) : (!isNaN(parseInt(_modal_product_category_id.value))) ? parseInt(_modal_product_category_id.value) : null
        
        if (category_id !== null) {
            $(_modal_product_name)
                .on("change", function () {
                    /*
                    setTimeout(function () {
                        let product_name = _modal_product_name.value
                        
                        if (globalSelectedProvider === false) {
                            if (provider_name === "") {
                                _provider_name.value = ""
                                _provider_company_id.value = ""
                                globalSelectedProvider = false
                                $(_vendor_name).val("").trigger("change")
                                $(_provider_company_id).val("").trigger("change")
                            } else {
                                provider_exists(provider_name)
                            }
                        }
                    }, 200)
                    //*/
                })
                .on("search", function () {
                
                })
                .on("click", function (e) {
                    if ($(this).attr("readonly") === "readonly") {
                        e.preventDefault()
                    } else {
                        $(this).select()
                    }
                })
                .autocomplete({
                    serviceUrl: "/api/v1.0/autocomplete/products",
                    minChars: 2,
                    params: { "category_id": category_id },
                    cache: false,
                    dataType: "json",
                    triggerSelectOnValidInput: false,
                    paramName: "st",
                    onSelect: function (suggestion) {
                        if (!suggestion || !suggestion.data) {
                            return
                        }
                        let product = suggestion.data
                        
                    },
                })
        }
        
    }
    
    return {
        validator: null,
        depart_from_date: null,
        depart_from_time: null,
        calendars: null,
        product_keywords: null,
        product_initial_location: null,
        provider_initial_location: null,
        arrive_to_station_time: null,
        depart_from_station_time: null,
        arrive_to_station_date: null,
        depart_from_station_date: null,
        detail: {},
        all: new Map(),
        attr1: null,
        attr2: null,
        attr3: null,
        newProduct_validator: null,
        enableNewFormDetails: function () {
            enableNewFormDetails()
        },
        disableNewFormDetails: function () {
            disableNewFormDetails()
        },
        updateDisplay: function () {
            updateDisplay()
        },
        updateProgress: function () {
            updateProgress()
            $("html").css({ overflow: "auto" })
        },
        updateProductSKU: function () {
            updateProductSKU()
        },
        setNewFormDetails: function (category_id) {
            setNewFormDetails(category_id)
        },
        get: function (params) {
            get(params)
        },
        loadAll: function (params) {
            loadAll(params)
        },
        save: function (params) {
            save(params)
        },
        init: function (settings) {
            init(settings)
        },
        index: function (settings) {
            index(settings)
        },
        navigate: function (product) {
            navigate(product)
        },
        clearModalForm: function () {
            clearModalForm()
        },
        resetNewProductDetails: function () {
            resetNewProductDetails()
        },
        initAutoComplete: function () {
            initAutoComplete()
        },
    }
    
})()

$(function () {
    const _profile_card = document.getElementById("profile_card")
    const _cover_image = document.getElementById("profile_card_cover_image")
    const _profile_edit_name = document.getElementById("profile_edit_name")
    
    $(_profile_edit_name)
        .on("click", function () {
            //console.log("_profile_edit_name:click")
        })
    
    let tempName = {
        first: "",
        last: "",
    }
    const enableNameEdit = function () {
    
    }
    
    const disableNameEdit = function () {}
    
    const build = function () {
        let ht = parseInt($(_profile_card).outerHeight())
        let wd = parseInt($(_profile_card).outerWidth())
        let imageHeight, imageWidth = 0
        
        let r = ht / wd
        imageHeight = (wd / 2) + "px"
        imageWidth = wd + "px"
        
        $(_cover_image)
            .css({
                "width": "100%",
                "height": "100%",
                "max-height": imageHeight + "px",
            })
    }
    
    window.addEventListener("resize", debounce(function (e) {
        if (_profile_card) {
            build()
        }
    }))
    
    build()
})

$(document).ready(function () {
    
    window.addEventListener("load", function () {
        const inputs = document.getElementsByTagName("input")
        
        if (mdbPreloader) {
            $(mdbPreloader).delay(1000).fadeOut(300)
        }
        
        for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].type === "text") {
                
                if (inputs[i].classList.contains("date-format")) {
                    //inputs[i].setAttribute("maxlength", "10")
                    //inputs[i].onkeydown = function (event) {
                    //return IsNumeric(this, event.keyCode)
                    //}
                    //inputs[i].onkeyup = function (event) {
                    //validateDateFormat(this, event.keyCode)
                    //}
                    
                }
                
                if (inputs[i].classList.contains("time-format")) {
                    
                    //inputs[i].setAttribute("maxlength", "5")
                    //inputs[i].onkeydown = function (event) {
                    //return IsNumeric(this, event.keyCode)
                    //}
                    //inputs[i].onkeyup = function (event) {
                    //validateTimeFormat(this, event.keyCode)
                    //}
                    
                }
            }
        }
    }, false)
    
    window.addEventListener("resize", debounce(function (e) {
        resize_elements("end of resizing")
    }))
    
    new WOW().init()
    
    $(this).scrollTop(0)
    
    $("body").scrollTop()
    
    $.fn.dataTableExt.afnFiltering.push(
        function (oSettings, aData, iDataIndex) {
            if (oSettings.nTable.id === "dates_table") {
                var iFini = document.getElementById("min").value
                var iFfin = document.getElementById("max").value
                var iStartDateCol = 1
                var iEndDateCol = 1
                
                iFini = iFini.substring(6, 10) + iFini.substring(3, 5) + iFini.substring(0, 2)
                iFfin = iFfin.substring(6, 10) + iFfin.substring(3, 5) + iFfin.substring(0, 2)
                
                var datofini = aData[iStartDateCol].substring(6, 10) + aData[iStartDateCol].substring(3, 5) + aData[iStartDateCol].substring(0, 2)
                var datoffin = aData[iEndDateCol].substring(6, 10) + aData[iEndDateCol].substring(3, 5) + aData[iEndDateCol].substring(0, 2)
                
                if (iFini === "" && iFfin === "") {
                    return true
                } else if (iFini <= datofini && iFfin === "") {
                    return true
                } else if (iFfin >= datoffin && iFini === "") {
                    return true
                } else if (iFini <= datofini && iFfin >= datoffin) {
                    return true
                }
                return false
            } else {
                return true
            }
        },
    )
    
    if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual"
    }
    
    $(".button-collapse").sideNav(sideNavOptions)
    
    window.scrollTo(0, 0)
    
    resize_elements()
    
    $(function () {
        $("[data-toggle=\"tooltip\"]").tooltip()
    })
    
    //toastr.info('I do not think that word means what you think it means.', 'Info!')
    //toastr.success('I do not think that word means what you think it means.', 'Success!')
    //toastr.warning('I do not think that word means what you think it means.', 'Warning!')
    //toastr.error('I do not think that word means what you think it means.', 'Error!')
    
    let codeData = document.querySelectorAll(".panel-code")
    codeData.forEach(el => {
        let html = $(el).html()
        let formattedCode = ""
        let classValue = ""
        $(el).empty()
        
        if (el.dataset.datatype === "json") {
            formattedCode = jsonPrettify(html)
            classValue = "json"
        } else if (el.dataset.datatype === "jsonp") {
            formattedCode = jsonPrettify(html)
            classValue = "jsonp"
        } else if (el.dataset.datatype === "json5") {
            formattedCode = jsonPrettify(html)
            classValue = "json5"
        }
        
        let pre = document.createElement("pre")
        let code = document.createElement("code")
        
        code.classList = [`language-${classValue}`]
        code.innerHTML = formattedCode
        
        pre.appendChild(code)
        el.appendChild(pre)
        Prism.highlightElement(code)
    })
    
    $("button.pre_display_button").show()
    $("div.pre_display_el").hide()
    
    $(function () {
        $("textarea.short-description").maxlength({
            alwaysShow: true,
            threshold: 10,
            warningClass: "badge badge-warning",
            limitReachedClass: "badge badge-danger",
            //placement: 'top',
            //preText: 'used ',
            //separator: ' of ',
            //postText: ' chars.',
        })
    })
    
    $(function () {
        toastr.options = {
            "closeButton": true,
            "debug": true,
            "newestOnTop": true,
            "progressBar": false,
            "positionClass": "md-toast-bottom-right",
            "preventDuplicates": true,
            "showDuration": 300,
            "hideDuration": 1000,
            "timeOut": 5000,
            "extendedTimeOut": 1000,
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut",
        }
        
        //toastr["warning"]("asd", "asd")
    })
})

