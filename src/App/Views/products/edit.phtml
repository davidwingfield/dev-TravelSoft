<?php
    
    use Framework\Logger\Log;
    
    if (!isset($page_data)) {
        $page_data = [];
    }
    $days = array(
        "sun",
        "mon",
        "tue",
        "wed",
        "thu",
        "fri",
        "sat",
    );
    
    $settings = json_encode($page_data, 1);
    $init = "Product.init($settings)";
    $units = [];
    $matrices = [];
    $variants = [];
    $provider = [];
    $vendor = [];
    $status_type_detail = [];
    $rating_line = "";
    $currencies = [];
    $pricing_strategies = [];
    $product = [];
    $location = [];
    $provider_location = [];
    $location_type = [];
    $categories = [];
    $profiles = [];
    $seasons = [];
    //
    
    //
    if (isset($page_data["types"]["pricing_strategies"])) {
        $pricing_strategies = $page_data["types"]["pricing_strategies"];
    }
    
    if (isset($page_data["types"]["currency"])) {
        $currencies = $page_data["types"]["currency"];
    }
    
    if (isset($page_data["product_details"])) {
        $product = $page_data["product_details"];
        
        if (isset($product["profiles"])) {
            $profiles = $product["profiles"];
        }
        
        if (isset($product["provider"])) {
            $provider = $product["provider"];
        }
        
        if (isset($product["vendor"])) {
            $vendor = $product["vendor"];
        }
        
        if (isset($product["matrices"])) {
            $matrices = $product["matrices"];
        }
        
        if (isset($product["variants"])) {
            $variants = $product["variants"];
        }
        
        if (isset($product["status_type_detail"])) {
            $status_type_detail = $product["status_type_detail"];
        }
        
        if (isset($product["seasons"])) {
            $seasons = $product["seasons"];
        }
        
        if (isset($product["category"])) {
            $categories = $product["category"];
        }
        
        if (isset($product["location"])) {
            $location = $product["location"];
        }
        
        if (isset($product["units"])) {
            $units = $product["units"];
        }
        
        if (isset($product["location"]["type"])) {
            $location_type = $product["location"]["type"];
        }
    }
    
    /**
     * STATUS DETAIL
     */
    $status_name = (isset($status_type_detail["name"])) ? $status_type_detail["name"] : "fyf";
    $status_id = $status_type_detail["id"];
    
    /**
     * LOCATION VARIABLES
     */
    $location_city = ($location["city"]) ? $location["city"] : [];
    $location_country = ($location["country"]) ? $location["country"] : [];
    $location_province = ($location["province"]) ? $location["province"] : [];
    
    /**
     * PRODUCT VARIABLES
     */
    $product_id = ($product["id"]) ? $product["id"] : null;
    $product_use_provider_location = $product["use_provider_location"];
    $product_category_id = $product["category_id"];
    $product_pricing_strategy_types_id = $product["pricing_strategy_types_id"];
    $product_status_types_id = $product["status_types_id"];
    $product_currency_id = $product["currency_id"];
    $product_location_id = $product["location_id"];
    $product_provider_id = $product["provider_id"];
    $product_vendor_id = $product["vendor_id"];
    $product_rating_types_id = ($product["rating_types_id"]) ? (int)$product["rating_types_id"] : 0;
    $product_name = $product["name"];
    $product_description_short = $product["description_short"];
    $product_description_long = $product["description_long"];
    $product_sku = $product["sku"];
    $product_depart_from = $product["depart_from"];
    $product_arrive_to = $product["arrive_to"];
    $product_depart_time = $product["depart_time"];
    $product_arrive_time = $product["arrive_time"];
    $use_provider_location = $product["use_provider_location"];
    
    /**
     * CATEGORY VARIABLES
     */
    $category_name = $product["category"]["name"];
    $category_icon = $product["category"]["icon"];
    
    $location_display = array(
        "display_short" => ($location["display_short"]) ? $location["display_short"] : "",
        "display_medium" => ($location["display_medium"]) ? $location["display_medium"] : "",
        "display_long" => ($location["display_long"]) ? $location["display_long"] : "",
    );
    
    //
    for ($n = 0; $n < $product_rating_types_id; $n++) {
        $rating_line .= "
        <li class='list-inline-item mr-0'>
            <i class='fas fa-star'></i>
        </li>
        ";
    }
    
    /**
     * Loication Variables
     */
    $l = $location_display["display_medium"];
    $location_type_icon = ($location_type["icon"]) ? "<i class='" . $location_type["icon"] . " mr-2'></i>" : "";
    $location_type_name = ($location_type["name"]) ? $location_type["name"] : "";
    $street = array();
    $location_street_1 = ((isset($location["street_1"])) && ($location["street_1"] !== "")) ? $street[] = "<span class='mb-1'>" . $location["street_1"] . "</span>" : "";
    $location_street_2 = ((isset($location["street_2"])) && ($location["street_2"] !== "")) ? $street[] = "<span class='mb-1'>" . $location["street_2"] . "</span>" : "";
    $location_zipcode = ((isset($location["zipcode"])) && ($location["zipcode"] !== "")) ? "<span class='mb-1'>" . $location["zipcode"] . "</span>" : "";
    $country_name = ($location_country["name"]) ? $location_country["name"] : "";
    $country_name_short = ($location_country["iso2"]) ? $location_country["iso2"] : "";
    $province_name = ($location_province["name"]) ? $location_province["name"] : "";
    $province_name_short = ($location_province["iso2"]) ? $location_province["iso2"] : "";
    $city_name = ($location_city["name"]) ? $location_city["name"] : "";
    $location_name = ($location["name"]) ? $location["name"] : "";
    $address_line = "<address><i class='fas fa-map-marker-alt living-coral-text mr-3'></i>" . implode(", ", $street) . " $city_name, $province_name_short $location_zipcode, $country_name_short</address>";
    $location_card = "$location_type_icon $l";
    $use_provider_location = (isset($product["use_provider_location"])) ? ($product["use_provider_location"] === true) ? true : false : false;
    $provider_city_name = (isset($provider_location["city"]["name"])) ? $provider_location["city"]["name"] : null;
    $provider_province_name = (isset($provider_location["province"]["name"])) ? $provider_location["province"]["name"] : null;
    $provider_country_name = (isset($provider_location["country"]["name"])) ? $provider_location["country"]["name"] : null;
    $product_city_name = (isset($location["city"]["name"])) ? $location["city"]["name"] : null;
    $product_province_name = (isset($location["province"]["name"])) ? $location["province"]["name"] : null;
    $product_country_name = (isset($location["country"]["name"])) ? $location["country"]["name"] : null;
    $city_name = ($use_provider_location === true) ? $provider_city_name : $product_city_name;
    $province_name = ($use_provider_location === true) ? $provider_province_name : $product_province_name;
    
    /**
     * Inventory Variables
     */
    $inventory_section = "";
    foreach ($profiles AS $profile) {
        $allot_by_details = (isset($profile["allot_by_details"])) ? $profile["allot_by_details"] : [];
        $sales_types_details = (isset($profile["sales_types_details"])) ? $profile["sales_types_details"] : [];
        $transfer_sales_types_details = (isset($profile["transfer_sales_types_details"])) ? $profile["transfer_sales_types_details"] : [];
        
        $expires = (isset($profile["expires"])) ? $profile["expires"] : null;
        $expire_date = (!is_null($expires)) ? "<tr><td class='bolder p-1'>Expire Date:</td><td class='p-1'>" . date("Y-m-d", strtotime($expires)) . "</td></tr>" : "";
        $days_out = (isset($profile["days_out"])) ? $profile["days_out"] : null;
        $days_out_row = (!is_null($days_out)) ? "<tr><td class='bolder p-1'>Days Out:</td><td class='p-1'>$days_out</td></tr>" : "";
        $allot_by_name = (isset($allot_by_details["name"])) ? $allot_by_details["name"] : null;
        $profile_name = (isset($profile["name"])) ? $profile["name"] : null;
        $sales_type_name = (isset($sales_types_details["name"])) ? $sales_types_details["name"] : null;
        $quantity = (isset($profile["quantity"])) ? $profile["quantity"] : null;
        $quantity_row = (!is_null($quantity)) ? "<tr><td class='bolder p-1'>Quantity:</td><td class='p-1'>$quantity</td></tr>" : "";
        
        $class_name = (isset($sales_types_details["class"])) ? $sales_types_details["class"] : null;
        if (is_null($quantity)) {
            if ((int)$profile["sales_types_id"] === 2) {
                $quantity_row = "<tr><td class='bolder p-1'>Quantity:</td><td class='p-1'>Unlimited</td></tr>";
            } else if ((int)$profile["sales_types_id"] === 3) {
                $quantity_row = "<tr><td class='bolder p-1'>Quantity:</td><td class='p-1'>On Request</td></tr>";
            } else if ((int)$profile["sales_types_id"] === 4) {
                $quantity_row = "<tr><td class='bolder p-1'>Quantity:</td><td class='p-1'>Not Available</td></tr>";
            } else {
                $quantity_row = "<tr><td class='bolder p-1'>Quantity:</td><td class='p-1'>Blackout</td></tr>";
            }
        }
        
        $inventory_profile = "
            <div class='col-12 col-sm-12 col-md-4 px-1'>
            <div class='card profile-card $class_name'>
                <div class='card-body'>
                
                    <h5 class='card-title'>$profile_name</h5>
                    
                    <p class='card-text'>$sales_type_name: $allot_by_name</p>
   
                    <table class='table table-sm'>
                        $days_out_row
                        $expire_date
                        $quantity_row
                    </table>
                </div>
            </div>
        </div>
        ";
        $inventory_section .= $inventory_profile;
    }
    
    /**
     * Units Variables
     */
    $unit_section = "";
    foreach ($units AS $unit) {
        $name = $unit["name"];
        $id = (int)$unit["id"];
        $min_pax = $unit["min_pax"];
        $max_pax = $unit["max_pax"];
        $min_nights = $unit["min_nights"];
        $max_nights = $unit["max_nights"];
        $description_short = $unit["description_short"];
        $cover_image = $unit["cover_image"];
        $room_code = (isset($unit["room_code"])) ? $unit["room_code"] : buildCode($id, $name, "unit");
        
        $unit_profile = "
            <div class='col-12 col-sm-12 col-md-4 px-1'>
            <div class='card'>
                <div class='card-body'>
                
                    <h5 class='card-title'>$name</h5>
                    <h6 class='card-subtitle my-2 text-muted'>$room_code</h6>
                    <p class='card-text'>$description_short</p>
   
                    <table class='table table-sm'>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>
                                <th>Min</th>
                                <th>Max</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>Pax:</th>
                                <td>$min_pax</td>
                                <td>$max_pax</td>
                            </tr>
                            <tr>
                                <th>Nights:</th>
                                <td>$min_nights</td>
                                <td>$max_nights</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        ";
        $unit_section .= $unit_profile;
    }
    
    /**
     * Variant Variables
     */
    $variant_section = "";
    
    foreach ($variants AS $variant) {
        $id = (int)$variant["id"];
        $name = $variant["name"];
        $min_age = (isset($variant["min_age"]) && !is_null($variant["min_age"])) ? $variant["min_age"] : "0";
        $max_age = (isset($variant["max_age"]) && !is_null($variant["max_age"])) ? $variant["max_age"] : "And Up";
        $str = buildCode($id, $name, "variant");
        $variant_profile = "
            <div class='col-12 col-sm-12 col-md-4 px-1'>
            <div class='card'>
                <div class='card-body'>
                
                    <h5 class='card-title'>$name</h5>
                    <h6 class='card-subtitle my-2 text-muted'>$str</h6>
                    <p class='card-text'></p>
   
                    <table class='table table-sm'>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>
                                <th>Min</th>
                                <th>Max</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Age</td>
                                <td>$min_age</td>
                                <td>$max_age</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        ";
        $variant_section .= $variant_profile;
    }
    
    /**
     * Season Variables
     */
    $season_section = "";
    foreach ($seasons AS $season) {
        $color_scheme = (isset($season["color_scheme"])) ? $season["color_scheme"] : [];
        $product_season_detail = (isset($season["product_season_detail"])) ? $season["product_season_detail"] : [];
        
        $disabled_dow = (isset($product_season_detail["disabled_dow"])) ? $product_season_detail["disabled_dow"] : "";
        $disabled_dow = preg_replace('/\s+/', '', trim($disabled_dow));
        $disabled_dow_list = explode(",", $disabled_dow);
        $day_temp = [];
        foreach ($disabled_dow_list AS $disabled_day) {
            $day_temp[] = $days[(int)$disabled_day];
        }
        $disabled_day_line = implode(". ", $day_temp);
        $color_scheme_background_color = $color_scheme["background_color"];
        $color_scheme_border_color = $color_scheme["border_color"];
        $color_scheme_text_color = $color_scheme["text_color"];
        
        $season_name = (isset($season["name"])) ? $season["name"] : "";
        
        $season_id = (isset($season["id"])) ? $season["id"] : "";
        
        $season_profile = "
        <div class='col-12 col-sm-12 col-md-4 px-1'>
        
            <div class='card' style='background:$color_scheme_background_color;color:$color_scheme_text_color;border-color:$color_scheme_border_color;'>
                <div class='card-body'>
                    <h5 class='card-title'  style='color:$color_scheme_text_color;'>$season_name</h5>
                    <h6 class='card-subtitle' style='font-size:.75rem;color:" . adjustBrightness($color_scheme_text_color, 100) . ";'>
                        <p class='m-0 mb-1' style='font-size:.75rem;color:$color_scheme_text_color;'>Disabled Days:</p>
                        <p class='m-0 mb-1' style='font-size:.75rem;color:" . adjustBrightness($color_scheme_text_color, 100) . ";'>$disabled_day_line</p>
                    </h6>
                </div>
            </div>
        </div>
        ";
        $season_section .= $season_profile;
    }
    
    /**
     * Provider Variables
     */
    $provider_images = [];
    $provider_description_short = (isset($provider["description_short"])) ? $provider["description_short"] : "";
    $provider_name = (isset($provider["name"])) ? $provider["name"] : "";
    $provider_code_direct_id = (isset($provider["code_direct_id"])) ? $provider["code_direct_id"] : "";
    $provider_description_long = (isset($provider["description_long"])) ? $provider["description_long"] : "";
    /**
     * Vendor Variables
     */
    $vendor_images = [];
    $vendor_description_short = (isset($vendor["description_short"])) ? $provider["description_short"] : "";
    $vendor_name = (isset($provider["name"])) ? $provider["name"] : "";
    $vendor_sku = (isset($provider["sku"])) ? $provider["sku"] : "";
    $vendor_description_long = (isset($provider["description_long"])) ? $provider["description_long"] : "";
?>
<!-- Product Edit Page -->
<section id="product_edit_page" class="section">
    
    <!-- Hidden Elements -->
    <div class="row gx-1 my-0">
        <div class="col-3 px-1 my-0">
            <label for="category_id" class="dev-element d-none">Category Id:</label>
            <input type="hidden" id="category_id" name="category_id" class="form-control dev-element" value="<?php echo $product_category_id; ?>" readonly="readonly"/>
        </div>
    </div>
    <!-- /Hidden Elements -->
    
    <div class="row gx-1">
        
        <div class="col-12 col-xl-9 p-1">
            <div class="tab-content p-1">
                
                <div class="tab-pane active" id="panel_tab_product_overview" role="tabpanel">
                    <div class="row">
                        <div class="col-12">
                            
                            <div class="card booking-card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title font-weight-bold"><span id="product_name" class=""><?php echo $product_name; ?></span>
                                        <a href="javascript:void(0);" id="product_panel_link_product" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <h6 class="card-subtitle my-2 text-muted">
                                        <span>
                                            <i class="<?php echo $category_icon; ?>"></i>
                                            <?php echo $category_name; ?>
                                        </span>
                                    </h6>
                                    
                                    <ul class="list-unstyled list-inline rating">
                                        <?php echo $rating_line; ?>
                                    </ul>
                                    
                                    <p id="product_description_short" class="card-text">
                                        <?php echo $product_description_short; ?>
                                    </p>
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                    <div class="row">
                                        <div class="col-lg-4 col-md-12 mb-4">
                                            <h5 class="mb-3 h5">Provider</h5>
                                            <p class="text-muted"><?php echo $provider_name; ?></p>
                                            <p class="">
                                                <?php echo $provider_description_short; ?>
                                            </p>
                                        </div>
                                        
                                        <div class="col-lg-4 col-md-6 mb-4">
                                            <h5 class="mb-3 h5">Vendor</h5>
                                            <p class="text-muted"><?php echo $vendor_name; ?></p>
                                            <p class="card-text">
                                                <?php echo $vendor_description_short; ?>
                                            </p>
                                        </div>
                                        
                                        <div class="col-lg-4 col-md-6 mb-4">
                                            
                                            <h5 class="mb-3 h5">Location</h5>
                                            <p class="text-muted">
                                                <?php echo $location_card; ?>
                                            </p>
                                            
                                            <p class="card-text">
                                                <?php echo $address_line; ?>
                                                Lorem, ipsum dolor sit amet consectetur adipisicing elit. A
                                                nemo commodi odio veniam nisi? Cupiditate nobis doloremque
                                                unde in ut, consequatur reprehenderit saepe iure
                                                perspiciatis, veniam facilis asperiores deleniti at?
                                            </p>
                                        
                                        </div>
                                    </div>
                                    <div>
                                        <?php echo $product_description_long; ?>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seasons -->
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title"><span>Seasons</span>
                                        <a href="javascript:void(0);" id="product_panel_link_season" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <!--<h6 class="card-subtitle mb-2 text-muted"><span>Category</span></h6>-->
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                    
                                    <div class="row">
                                        <?php echo $season_section; ?>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Units -->
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title"><span>Units</span>
                                        <a href="javascript:void(0);" id="product_panel_link_unit" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <!--<h6 class="card-subtitle mb-2 text-muted"><span>Category</span></h6>-->
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                    <div class="row">
                                        <?php echo $unit_section; ?>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Variants -->
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title"><span>Variants</span>
                                        <a href="javascript:void(0);" id="product_panel_link_variant" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <!--<h6 class="card-subtitle mb-2 text-muted"><span>Category</span></h6>-->
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                    <div class="row">
                                        <?php echo $variant_section; ?>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Inventory Profiles -->
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title"><span>Inventory Profiles</span>
                                        <a href="javascript:void(0);" id="product_panel_link_inventory" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <!--<h6 class='card-subtitle mb-2 text-muted'><span>Category</span></h6>-->
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                    
                                    <div class="row">
                                        <?php echo $inventory_section; ?>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title"><span>Pricing</span>
                                        <a href="javascript:void(0);" id="product_panel_link_pricing" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <!--<h6 class="card-subtitle mb-2 text-muted"><span>Category</span></h6>-->
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                </div>
                            
                            </div>
                            
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title"><span>Meta</span>
                                        <a href="javascript:void(0);" id="product_panel_link_meta" class="panel_link" aria-hidden="true">Edit</a>
                                    </h5>
                                    <!--<h6 class="card-subtitle mb-2 text-muted"><span>Category</span></h6>-->
                                    <hr class="ml-3 mr-3 mt-1 mb-3 color-dark">
                                </div>
                            
                            </div>
                        
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane" id="panel_tab_product_detail" role="tabpanel">
                    <?php include_once(VIEWS_PATH . "/products/forms/product_edit_details_form.phtml"); ?>
                </div>
                
                <div class="tab-pane" id="panel_tab_product_location" role="tabpanel">
                    <?php include_once(VIEWS_PATH . "/locations/forms/product_edit_location_form.phtml"); ?>
                </div>
                
                <div class="tab-pane" id="panel_tab_product_season" role="tabpanel">
                    <?php include_once(VIEWS_PATH . "/seasons/forms/product_edit_season_form.phtml"); ?>
                </div>
                
                <div class="tab-pane" id="panel_tab_product_unit" role="tabpanel">
                
                </div>
                
                <div class="tab-pane" id="panel_tab_product_variant" role="tabpanel">
                    panel_tab_product_variant
                </div>
                
                <div class="tab-pane" id="panel_tab_product_inventory" role="tabpanel">
                    panel_tab_product_inventory
                </div>
                
                <div class="tab-pane" id="panel_tab_product_pricing" role="tabpanel">
                    panel_tab_product_pricing
                </div>
                
                <div class="tab-pane" id="panel_tab_product_meta" role="tabpanel">
                    META
                </div>
            
            </div>
        </div>
        
        <div class="col-12 col-xl-3 p-1">
            <div class="card card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item list-group-item d-flex justify-content-between">Status:</li>
                    <li class="list-group-item list-group-item">
                        <div class="row gx-1">
                            <div class="col-12 p-1 d-flex justify-content-between">
                                <span>Created By:</span>
                                <span id="product_edit_detail_created_by">David Wingfield</span>
                            </div>
                        </div>
                        <div class="row gx-1">
                            <div class="col-12 p-1 d-flex justify-content-between">
                                <span>Status:</span>
                                <span id="product_edit_detail_status"><?php echo $status_name; ?></span>
                                <input type="hidden" id="product_status_id" class="form-control dev-element" value="<?php echo $status_name; ?>"/>
                            </div>
                        </div>
                    </li>
                    <li class="list-group-item list-group-item">
                        <div class="row gx-1">
                            <div class="col-12 p-1 d-flex justify-content-between">
                                <span>Country:</span>
                                <span id="product_edit_detail_location_city"><?php echo $country_name; ?></span>
                            </div>
                        </div>
                        <div class="row gx-1">
                            <div class="col-12 p-1 d-flex justify-content-between">
                                <span>Province:</span>
                                <span id="product_edit_detail_location_province"><?php echo $province_name; ?></span>
                            </div>
                        </div>
                        <div class="row gx-1">
                            <div class="col-12 p-1 d-flex justify-content-between">
                                <span>City:</span>
                                <span id="product_edit_detail_location_country"><?php echo $city_name; ?></span>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    
    </div>
    
    <div class="row gx-1">
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($seasons, "Seasons"); ?>
        </div>
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($units, "Units"); ?>
        </div>
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($variants, "Variants"); ?>
        </div>
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($matrices, "Matrices"); ?>
        </div>
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($profiles, "Profiles"); ?>
        </div>
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($provider, "Provider"); ?>
        </div>
        <div class="col-12 col-md-4 p-1">
            <?php displayJsonOnPage($vendor, "Vendor"); ?>
        </div>
    </div>

</section>
<!-- /Product Edit Page -->

<!-- Calendar Modal -->
<?php include_once(VIEWS_PATH . "/products/modals/product_edit_calendar.phtml"); ?>

<script type="text/javascript">
    const _product_panel_link_overview = document.getElementById("product_panel_link_overview")
    const _panel_tab_product_o = document.getElementById("panel_tab_product_o")
    const _product_panel_link_product = document.getElementById("product_panel_link_product")
    const _panel_tab_product = document.getElementById("panel_tab_product")
    const _product_panel_link_season = document.getElementById("product_panel_link_season")
    const _panel_tab_season = document.getElementById("panel_tab_season")
    const _product_panel_link_unit = document.getElementById("product_panel_link_unit")
    const _panel_tab_unit = document.getElementById("panel_tab_unit")
    const _product_panel_link_variant = document.getElementById("product_panel_link_variant")
    const _panel_tab_variant = document.getElementById("panel_tab_variant")
    const _product_panel_link_inventory = document.getElementById("product_panel_link_inventory")
    const _panel_tab_inventory = document.getElementById("panel_tab_inventory")
    const _product_panel_link_pricing = document.getElementById("product_panel_link_pricing")
    const _panel_tab_pricing = document.getElementById("panel_tab_pricing")
    const _panel_tab_location = document.getElementById("panel_tab_location")
    const _panel_tab_product_location = document.getElementById("panel_tab_product_location")
    const _panel_tab_product_meta = document.getElementById("panel_tab_product_meta")
    const _panel_tab_meta = document.getElementById("panel_tab_meta")
    const _product_panel_link_meta = document.getElementById("product_panel_link_meta")
    const _product_panel_link_location = document.getElementById("product_panel_link_location")
    
    $(function () {
        Types.init(<?php echo TYPES;?>)
        <?php echo $init;?>
        
        $(_product_panel_link_overview)
          .on("click", function () {
              $(_panel_tab_product_o).tab("show")
          })
        $(_product_panel_link_location)
          .on("click", function () {
              $(_panel_tab_location).tab("show")
          })
        $(_product_panel_link_product)
          .on("click", function () {
              $(_panel_tab_product).tab("show")
          })
        $(_product_panel_link_season)
          .on("click", function () {
              $(_panel_tab_season).tab("show")
          })
        $(_product_panel_link_unit)
          .on("click", function () {
              $(_panel_tab_unit).tab("show")
          })
        $(_product_panel_link_variant)
          .on("click", function () {
              $(_panel_tab_variant).tab("show")
          })
        $(_product_panel_link_inventory)
          .on("click", function () {
              $(_panel_tab_inventory).tab("show")
          })
        $(_product_panel_link_pricing)
          .on("click", function () {
              $(_panel_tab_pricing).tab("show")
          })
        $(_product_panel_link_meta)
          .on("click", function () {
              $(_panel_tab_meta).tab("show")
          })
    })
    //
    
    document.addEventListener("DOMContentLoaded", function () {
        const jsonPrettify = (json) => {
            if (typeof json === "object" && json !== null) {
                return JSON.stringify(json, undefined, '\t')
            }
            
            try {
                const obj = JSON.parse(json)
                return jsonPrettify(obj)
            } catch (e) {
                return json
            }
        }
        
        let codeData = document.querySelectorAll(".panel-code")
        codeData.forEach(el => {
            let html = $(el).html()
            let formattedCode = ""
            let classValue = ""
            $(el).empty()
            
            if (el.dataset.datatype === "json") {
                formattedCode = jsonPrettify(html)
                classValue = "json"
            } else if (el.dataset.datatype === "jsonp") {
                formattedCode = jsonPrettify(html)
                classValue = "jsonp"
            } else if (el.dataset.datatype === "json5") {
                formattedCode = jsonPrettify(html)
                classValue = "json5"
            }
            
            let pre = document.createElement("pre")
            let code = document.createElement("code")
            
            code.classList = [`language-${classValue}`]
            code.innerHTML = formattedCode
            
            pre.appendChild(code)
            el.appendChild(pre)
        })
        
    })

</script>

<script type="text/javascript">
    const myEvents = [
        {
            date: "2021-01-01",
            product_id: 1,
            season: {
                id: 1,
                category_id: 1,
                name: "Year-Round",
                color_scheme_id: 1,
                created_by: 4,
                date_created: "2021-12-06 08:58:59",
                date_modified: "2021-12-06 08:58:59",
                enabled: 1,
                modified_by: 4,
                color_scheme: {
                    id: 11,
                    background_color: "#3e8ef7",
                    border_color: "#295da2",
                    created_by: 4,
                    date_created: "2021-12-06 08:58:59",
                    date_modified: "2021-12-06 08:58:59",
                    enabled: 1,
                    modified_by: 4,
                    name: "color-11",
                    note: null,
                    sort_order: 11,
                    text_color: "#000",
                },
            },
            units: [
                {
                    id: 196,
                    name: "Test Name 5",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                }, {
                    id: 197,
                    name: "Test Name 1",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 199,
                    name: "Test Name 2",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 204,
                    name: "Test Name 3",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
            ],
            profiles: [],
        },
        {
            date: "2021-01-02",
            product_id: 1,
            season: {
                id: 1,
                category_id: 1,
                name: "Year-Round",
                color_scheme_id: 1,
                created_by: 4,
                date_created: "2021-12-06 08:58:59",
                date_modified: "2021-12-06 08:58:59",
                enabled: 1,
                modified_by: 4,
                color_scheme: {
                    id: 11,
                    background_color: "#3e8ef7",
                    border_color: "#295da2",
                    created_by: 4,
                    date_created: "2021-12-06 08:58:59",
                    date_modified: "2021-12-06 08:58:59",
                    enabled: 1,
                    modified_by: 4,
                    name: "color-11",
                    note: null,
                    sort_order: 11,
                    text_color: "#000",
                },
            },
            units: [
                {
                    id: 197,
                    name: "Test Name 1",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 199,
                    name: "Test Name 2",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 204,
                    name: "Test Name 3",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
            ],
            profiles: [],
        },
        {
            date: "2021-01-03",
            product_id: 1,
            season: {
                id: 1,
                category_id: 1,
                name: "Year-Round",
                color_scheme_id: 1,
                created_by: 4,
                date_created: "2021-12-06 08:58:59",
                date_modified: "2021-12-06 08:58:59",
                enabled: 1,
                modified_by: 4,
                color_scheme: {
                    id: 11,
                    background_color: "#3e8ef7",
                    border_color: "#295da2",
                    created_by: 4,
                    date_created: "2021-12-06 08:58:59",
                    date_modified: "2021-12-06 08:58:59",
                    enabled: 1,
                    modified_by: 4,
                    name: "color-11",
                    note: null,
                    sort_order: 11,
                    text_color: "#000",
                },
            },
            units: [
                {
                    id: 197,
                    name: "Test Name 1",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 199,
                    name: "Test Name 2",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 204,
                    name: "Test Name 3",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
            ],
            profiles: [],
        },
        {
            date: "2021-01-04",
            product_id: 1,
            units: [
                {
                    id: 197,
                    name: "Test Name 1",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 199,
                    name: "Test Name 2",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
                {
                    id: 204,
                    name: "Test Name 3",
                    cover_image: "/public/img/placeholder.jpg",
                    min_pax: 1,
                    max_pax: 1,
                    min_nights: 1,
                    max_nights: 1,
                },
            ],
            profiles: [],
        },
    ]
    const initialCalenderViewCount = 12
    const calendarSettings = {
        initialView: "dayGridMonth",
        header: {
            left: "title",
            center: "",
            right: "",
        },
        views: {
            month: {
                titleFormat: "MMMM-YYYY",
            },
        },
    }
    
    $.fn.myCalendar = function (settings) {
        "use strict"
        let calendarType = "season"
        let selectedStart, selectedEnd = null
        let selectedDates = new Map()
        let calendar_id = $(this).attr("id")
        let calContainer = document.getElementById(calendar_id)
        let calendars = []
        let seasonEvents = new Map()
        let activeCalendars = []
        
        const pad = function (d) {
            return (d < 10) ? '0' + d.toString() : d.toString()
        }
        
        const hexToRgb = hex =>
          hex.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i
            , (m, r, g, b) => "#" + r + r + g + g + b + b)
            .substring(1).match(/.{2}/g)
            .map(x => parseInt(x, 16))
        
        const rgb2hex = function (rgb) {
            if (rgb.search("rgb") === -1) {
                return rgb
            } else {
                rgb = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/)
                
                
                function hex (x) {
                    return ("0" + parseInt(x).toString(16)).slice(-2)
                }
                
                
                return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3])
            }
        }
        
        const buildCalendarRow = function (calendar_id) {
            let calendarRow = document.createElement("div")
            calendarRow.classList = "row gx-1"
            return calendarRow
        }
        
        const buildCalendarColumn = function (calendar_id) {
            let calendarRow = document.createElement("div")
            calendarRow.classList = "flex-fill col-4 p-1"
            return calendarRow
        }
        
        const buildCalendarElementPanel = function (calendar_id) {
            let calendarBlock = document.createElement("div")
            calendarBlock.classList = "card card-block p-1"
            
            return calendarBlock
        }
        
        const buildCalendarElement = function (calendar_id) {
            let calendarPanel = buildCalendarElementPanel(calendar_id)
            let calendarColumn = buildCalendarColumn(calendar_id)
            let calendarBlock = document.createElement("div")
            let calendarBlockId = "calendar_block_" + calendar_id
            //
            calendarBlock.classList = "my_calendar"
            calendarBlock.id = calendarBlockId
            //
            calendarColumn.appendChild(calendarPanel)
            calendarPanel.appendChild(calendarBlock)
            //
            calendars.push(calendarBlock)
            return calendarColumn
        }
        
        const getDate = function (monthsOut) {
            let dateToday = new Date()
            let startYear = dateToday.getFullYear()
            let startMonth = (0 + monthsOut) + 1
            let startDay = 1
            return moment(startYear + "-" + pad(startMonth) + "-" + pad(startDay)).format("YYYY-MM-DD")
        }
        
        const buildCalendarContainer = function () {
            let calendarBlockContainer = document.createElement("div")
            let calendarBlockContainerId = "calendar_block_container"
            let row = buildCalendarRow()
            
            //console.log("Types.season_types", Types.season_types)
            
            calendarBlockContainer.classList = "calendarContainer"
            calendarBlockContainer.id = calendarBlockContainerId
            
            for (var n = 0; n < initialCalenderViewCount; n++) {
                let id = (n + 1)
                if (n % 3 === 0 && n > 0) {
                    calendarBlockContainer.appendChild(row)
                    row = buildCalendarRow(id)
                }
                
                row.appendChild(buildCalendarElement(id))
            }
            
            calendarBlockContainer.appendChild(row)
            
            return calendarBlockContainer
        }
        
        const buildCalendar = function (settings) {
            calContainer.appendChild(buildCalendarContainer())
            let events = (settings && settings.events) ? settings.events : []
            
            let activeCal = $.each(calendars, function (index, cal) {
                let displayMonth = getDate(index)
                let start = moment(moment().year() + "-01-01").format("YYYY-MM-DD")
                
                $(cal).fullCalendar({
                    selectable: false,
                    showNonCurrentDates: false,
                    defaultDate: displayMonth,
                    initialView: "dayGridMonth",
                    displayEventTime: false,
                    eventLimit: 3,
                    
                    header: {
                        left: "title",
                        center: "",
                        right: "",
                    },
                    views: {
                        month: {
                            titleFormat: "MMMM-YYYY",
                        },
                    },
                    dayRender: function (date, el) {
                        let day = moment(date).format("YYYYMMDD")
                        let selectedDay = moment(date).format("YYYY-MM-DD")
                        let id = "s" + day
                        let month = moment(date).month()
                        let year = moment(date).year()
                        let top = $(`td.fc-day-top[data-date='${selectedDay}']`)
                        let topSpan = $(`td.fc-day-top[data-date='${selectedDay}']>span.fc-day-number`)
                        if (topSpan.length) {
                            $(top).empty()
                            let day = topSpan.text()
                            if (!isNaN(day)) {
                                let e = "<div class='w-100 d-flex align-items-center justify-content-between' style=''>"
                                  + "<span>&nbsp;</span>"
                                  + "<span class='fc-day-number'>" + day + "</span>"
                                  + "</div>"
                                
                                let titleContainer = document.createElement("div")
                                top.append(e)
                            }
                            
                        }
                        if (!$(el).hasClass("fc-disabled-day")) {
                            $(top).attr("season", "true")
                            $(el).attr("season", "true")
                            $(el).attr("data-date", selectedDay)
                            $(el).attr("id", id)
                            $(el).attr("day", day)
                            $(el).attr("month", month)
                            $(el).attr("year", year)
                            $(el).attr("selected", "false")
                        }
                    },
                    
                    dayClick: function (event, jsEvent, view) {
                        let day = moment(event.start).format("YYYY-MM-DD")
                        let dateClicked = moment(event).format("YYYY-MM-DD")
                        
                        if (jsEvent.originalEvent.shiftKey) {
                            if (selectedStart !== null) {
                                selectedEnd = dateClicked
                                console.log("start", selectedStart)
                                console.log("end", selectedEnd)
                                if (moment(selectedEnd) < moment(selectedStart)) {
                                    let tempEnd = moment(selectedStart).format("YYYY-MM-DD")
                                    let tempStart = moment(selectedEnd).format("YYYY-MM-DD")
                                    let startElement = $("td.fc-day[data-date='" + tempStart + "'][season='true']")
                                    let endElement = $("td.fc-day[data-date='" + tempEnd + "'][season='true']")
                                    $(startElement).removeClass("is-selected")
                                    endElement.removeClass("is-selected")
                                    console.log("tempStart", moment(tempStart).format("YYYY-MM-DD"))
                                    console.log("tempEnd", moment(tempEnd).format("YYYY-MM-DD"))
                                    
                                    selectDates(this, tempStart, tempEnd)
                                    selectedStart = tempEnd
                                    selectedEnd = tempStart
                                } else {
                                    selectDates(this, selectedStart, selectedEnd)
                                }
                                
                                console.log("start2 ", selectedStart)
                                console.log("end 2 ", selectedEnd)
                                
                                selectedStart = null
                                selectedEnd = null
                            }
                        } else if (jsEvent.originalEvent.ctrlKey) {
                            
                            if (this.hasClass("selected-day")) {
                                this.removeClass("selected-day")
                                selectedDates.delete(dateClicked)
                                selectedStart = null
                                selectedEnd = null
                            } else {
                                selectedDates.set(dateClicked, "selected")
                                selectedStart = dateClicked
                                selectedEnd = null
                                this.addClass("selected-day")
                            }
                        } else {
                            clearSelectedDates()
                            selectDay(this, dateClicked)
                            selectedStart = dateClicked
                            selectedEnd = dateClicked
                            this.addClass("selected-day")
                        }
                    },
                    
                    eventRender: function (event, element, view) {
                        $(element).attr("season", "true")
                        let day = moment(event.start).format("YYYY-MM-DD")
                        let el = $("td.fc-day[data-date='" + day + "'][season='true']")
                        let myEvent = seasonEvents.get(day)
                        let textColor = event.textColor
                        let backgroundColor = event.backgroundColor
                        let borderColor = event.borderColor
                        // --
                        //console.log("render event", event)
                        // --
                        if (event.rendering === "background") {
                            if ($(element).hasClass("fc-disabled-day")) {
                                return
                            }
                            //
                            var e = ""
                            let dayCell = document.querySelectorAll(`td.fc-day[season='true'][data-date='${day}']`)
                            
                            if (myEvent) {
                                $(el).addClass("has-event")
                                $(el).attr("seasons_types_id", event.seasons_types_id)
                                $(el).data("season", "true")
                            }
                            
                            $(dayCell).css({
                                "background": backgroundColor,
                                "color": textColor,
                                "border-color": borderColor,
                            })
                            
                            $(element).css({
                                "background": "transparent",
                                "color": textColor,
                            })
                            
                            //console.log("background", event)
                        }
                    },
                    
                    eventClick: function (calEvent, jsEvent, view) {
                        //alert('Event: ' + calEvent.title)
                        //alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY)
                        //alert('View: ' + view.name)
                        
                        // change the border color just for fun
                        //$(this).css('border-color', 'red')
                    },
                    events: Array.from(events.values()),
                })
            })
            
            activeCalendars.push(activeCal)
        }
        
        const selectDates = function (_this, startDate, endDate) {
            let start = new Date(moment(startDate).format("MM/DD/YYYY"))
            let end = new Date(moment(endDate).format("MM/DD/YYYY"))
            let loop = new Date(start)
            
            $("td.fc-day[data-date='" + moment(endDate).format("YYYY-MM-DD") + "']").removeClass("selected-day")
            $("td.fc-day[data-date='" + moment(startDate).format("YYYY-MM-DD") + "']").removeClass("selected-day")
            
            while (loop <= end) {
                selectDay($("td.fc-day[data-date='" + moment(loop).format("YYYY-MM-DD") + "']"), moment(loop).format("YYYY-MM-DD"))
                let newDate = loop.setDate(loop.getDate() + 1)
                loop = new Date(newDate)
            }
        }
        
        const clearSelectedDates = function () {
            let days = $("td[season='true']")
            days.each(function (index, element) {
                $(this).removeClass("selected-day")
                $(this).attr("selected", false)
            })
            selectedDates = new Map()
        }
        
        const selectDay = function (_this, dateClicked) {
            if ($(_this).hasClass("selected-day")) {
                $(_this).removeClass("selected-day")
                selectedDates.delete(dateClicked)
            } else {
                $(_this).addClass("selected-day")
                selectedDates.set(dateClicked, "selected")
                selectedStart = dateClicked
                selectedEnd = null
            }
        }
        
        const buildSeasonEvent = function (event) {
            if (!event || (!event.season)) {
                return
            }
            
            let e = {}
            let event_id = "s-"
            
            if (event.date) {
                e.allDay = true
                e.start = event.date
                e.end = event.date
                event_id += moment(event.date).format("YYYYMMDD")
            }
            
            if (event.product_id) {
                event_id += "-" + event.product_id
            }
            
            if (event.season) {
                e.title = event.season.name
                event_id += "-" + event.season.id
                if (event.season.color_scheme) {
                    e.backgroundColor = event.season.color_scheme.background_color
                    e.borderColor = event.season.color_scheme.border_color
                    e.textColor = event.season.color_scheme.text_color
                }
            }
            
            /**
             * @name id
             * @type {string|number|null}
             * @description Optional Uniquely identifies the given event. Different instances of repeating events should all have the same <pre><code>id</code></pre>.
             */
            e.id = event_id
            e.editable = true			//true or false. Optional. Overrides the master editable option for this single event.
            e.startEditable = false		//true or false. Optional. Overrides the master eventStartEditable option for this single event.
            e.durationEditable = false	//true or false. Optional. Overrides the master eventDurationEditable option for this single event.
            e.rendering = "background"			//Allows alternate rendering of the event, like background events. Can be empty, "background", or "inverse-background"
            e.overlap = true			//true or false. Optional. Overrides the master eventOverlap option for this single event. If false, prevents this event from being dragged/resized over other events. Also prevents other events from being dragged/resized over this event.
            
            return e
        }
        
        const buildUnitEvent = function (event, unit) {
            let e = {}
            let event_id = "u-"
            if (!event || (!unit)) {
                return
            }
            
            if (event.date) {
                e.allDay = true
                e.start = event.date
                e.end = event.date
                event_id += moment(event.date).format("YYYYMMDD")
            }
            
            if (event.product_id) {
                event_id += "-" + event.product_id
            }
            
            if (event.season) {
                event_id += "-" + event.season.id
            }
            
            if (unit) {
                e.title = unit.name
                event_id += "-" + unit.id
            }
            
            /**
             * @name id
             * @type {string|number|null}
             * @description Optional Uniquely identifies the given event. Different instances of repeating events should all have the same <pre><code>id</code></pre>.
             */
            e.id = event_id
            e.editable = true
            e.startEditable = false
            e.durationEditable = false
            e.overlap = true
            e.backgroundColor = "#11c26d"
            e.borderColor = "#11c26d"
            e.textColor = "#0a070d"
            return e
        }
        
        const formatEvent = function (event) {
            if (!event) {
                return
            }
            
            if (event.season) {
                let seasonEvent = buildSeasonEvent(event)
                seasonEvents.set(seasonEvent.id, seasonEvent)
            }
            
            if (event.units) {
                for (let n = 0; n < event.units.length; n++) {
                    let unitEvent = buildUnitEvent(event, event.units[n])
                    seasonEvents.set(unitEvent.id, unitEvent)
                }
            }
        }
        
        const addEventToCalendars = function (event) {
            if (!event) {
                return
            }
            
            $.each(activeCalendars, function (k, el) {
                $(el).fullCalendar("renderEvent", event)
            })
        }
        
        const loadEvents = function (events) {
            seasonEvents = new Map()
            if (!events) {
                events = []
            }
            
            $.each(events, function (i, event) {
                formatEvent(event)
            })
            
            $.each(Array.from(seasonEvents.values()), function (i, event) {
                addEventToCalendars(event)
            })
        }
        
        const init = function (settings) {
            let events = []
            calendars = []
            
            if (settings) {
                if (settings.events) {
                    events = settings.events
                }
                
                if (settings.calendarType) {
                    calendarType = settings.calendarType
                }
            }
            
            loadEvents(events)
            
            buildCalendar({
                events: Array.from(seasonEvents.values()),
            })
        }
        
        init(settings)
        
        return {
            calendars: new Map(),
        }
    }
    
    /*
    $(function () {
        let cals = $("#calendar").myCalendar({
            displayEventTime: false,
            calendarType: "season",
            events: myEvents,
        })
    })
    //*/

</script>
